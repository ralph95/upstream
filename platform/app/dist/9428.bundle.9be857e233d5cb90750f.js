"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[9428,8402],{17603:(e,t,a)=>{a.r(t),a.d(t,{default:()=>pe});const n=JSON.parse('{"UU":"@ohif/extension-tmtv"}').UU,o=e=>({type:"cameraPosition",id:e,source:!0,target:!0}),r={type:"hydrateseg",id:"sameFORId",source:!0,target:!0,options:{matchingRules:["sameFOR"]}},i={viewportOptions:{viewportId:"ctAXIAL",viewportType:"volume",orientation:"axial",toolGroupId:"ctToolGroup",initialImageOptions:{preset:"first"},syncGroups:[o("axialSync"),{type:"voi",id:"ctWLSync",source:!0,target:!0,options:{syncColormap:!0}},r]},displaySets:[{id:"ctDisplaySet"}]},s={viewportOptions:{viewportId:"ctSAGITTAL",viewportType:"volume",orientation:"sagittal",toolGroupId:"ctToolGroup",syncGroups:[o("sagittalSync"),{type:"voi",id:"ctWLSync",source:!0,target:!0,options:{syncColormap:!0}},r]},displaySets:[{id:"ctDisplaySet"}]},l={viewportOptions:{viewportId:"ctCORONAL",viewportType:"volume",orientation:"coronal",toolGroupId:"ctToolGroup",syncGroups:[o("coronalSync"),{type:"voi",id:"ctWLSync",source:!0,target:!0,options:{syncColormap:!0}},r]},displaySets:[{id:"ctDisplaySet"}]},c={viewportOptions:{viewportId:"ptAXIAL",viewportType:"volume",background:[1,1,1],orientation:"axial",toolGroupId:"ptToolGroup",initialImageOptions:{preset:"first"},syncGroups:[o("axialSync"),{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncColormap:!1,syncInvertState:!1}},r]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},p={viewportOptions:{viewportId:"ptSAGITTAL",viewportType:"volume",orientation:"sagittal",background:[1,1,1],toolGroupId:"ptToolGroup",syncGroups:[o("sagittalSync"),{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncColormap:!1,syncInvertState:!1}},r]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},m={viewportOptions:{viewportId:"ptCORONAL",viewportType:"volume",orientation:"coronal",background:[1,1,1],toolGroupId:"ptToolGroup",syncGroups:[o("coronalSync"),{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncColormap:!1,syncInvertState:!1}},r]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},u={viewportOptions:{viewportId:"fusionAXIAL",viewportType:"volume",orientation:"axial",toolGroupId:"fusionToolGroup",initialImageOptions:{preset:"first"},syncGroups:[o("axialSync"),{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0,options:{syncColormap:!1,syncInvertState:!1}},r]},displaySets:[{id:"ctDisplaySet"},{id:"ptDisplaySet",options:{colormap:{name:"hsv",opacity:[{value:0,opacity:0},{value:.1,opacity:.8},{value:1,opacity:.9}]},voi:{custom:"getPTVOIRange"}}}]},d={viewportOptions:{viewportId:"fusionSAGITTAL",viewportType:"volume",orientation:"sagittal",toolGroupId:"fusionToolGroup",syncGroups:[o("sagittalSync"),{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0,options:{syncColormap:!1,syncInvertState:!1}},r]},displaySets:[{id:"ctDisplaySet"},{id:"ptDisplaySet",options:{colormap:{name:"hsv",opacity:[{value:0,opacity:0},{value:.1,opacity:.8},{value:1,opacity:.9}]},voi:{custom:"getPTVOIRange"}}}]},g={viewportOptions:{viewportId:"fusionCoronal",viewportType:"volume",orientation:"coronal",toolGroupId:"fusionToolGroup",syncGroups:[o("coronalSync"),{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0,options:{syncColormap:!1,syncInvertState:!1}},r]},displaySets:[{id:"ctDisplaySet"},{id:"ptDisplaySet",options:{colormap:{name:"hsv",opacity:[{value:0,opacity:0},{value:.1,opacity:.8},{value:1,opacity:.9}]},voi:{custom:"getPTVOIRange"}}}]},y={viewportOptions:{viewportId:"mipSagittal",viewportType:"volume",orientation:"sagittal",background:[1,1,1],toolGroupId:"mipToolGroup",syncGroups:[{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncColormap:!1,syncInvertState:!1}},r],customViewportProps:{hideOverlays:!0}},displaySets:[{options:{blendMode:"MIP",slabThickness:"fullVolume",voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},h={id:"@ohif/extension-tmtv.hangingProtocolModule.ptCT",locked:!0,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2022-10-04T19:22:08.894Z",availableTo:{},editableBy:{},imageLoadStrategy:"interleaveTopToBottom",protocolMatchingRules:[{attribute:"ModalitiesInStudy",constraint:{contains:["CT","PT"]}},{attribute:"StudyDescription",constraint:{contains:"PETCT"}},{attribute:"StudyDescription",constraint:{contains:"PET/CT"}}],displaySetSelectors:{ctDisplaySet:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:{value:"CT"}},required:!0},{attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"SeriesDescription",constraint:{contains:"CT"}},{attribute:"SeriesDescription",constraint:{contains:"CT WB"}}]},ptDisplaySet:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"PT"},required:!0},{attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"SeriesDescription",constraint:{contains:"Corrected"}},{weight:2,attribute:"SeriesDescription",constraint:{doesNotContain:{value:"Uncorrected"}}}]}},stages:[{name:"default",id:"default",viewportStructure:{layoutType:"grid",properties:{rows:3,columns:4,layoutOptions:[{x:0,y:0,width:1/4,height:1/3},{x:1/4,y:0,width:1/4,height:1/3},{x:.5,y:0,width:1/4,height:1/3},{x:0,y:1/3,width:1/4,height:1/3},{x:1/4,y:1/3,width:1/4,height:1/3},{x:.5,y:1/3,width:1/4,height:1/3},{x:0,y:2/3,width:1/4,height:1/3},{x:1/4,y:2/3,width:1/4,height:1/3},{x:.5,y:2/3,width:1/4,height:1/3},{x:3/4,y:0,width:1/4,height:1}]}},viewports:[i,s,l,c,p,m,u,d,g,y],createdDate:"2021-02-23T18:32:42.850Z"},{name:"Fusion 2x2",id:"Fusion-2x2",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[i,u,c,y]},{name:"2x3-layout",id:"2x3-layout",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:3}},viewports:[i,s,l,c,p,m]},{name:"2x4-layout",id:"2x4-layout",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:4,layoutOptions:[{x:0,y:0,width:1/4,height:.5},{x:1/4,y:0,width:1/4,height:.5},{x:.5,y:0,width:1/4,height:.5},{x:3/4,y:0,width:1/4,height:1},{x:0,y:.5,width:1/4,height:.5},{x:1/4,y:.5,width:1/4,height:.5},{x:.5,y:.5,width:1/4,height:.5}]}},viewports:[m,p,c,y,g,d,u]}],numberOfPriorsReferenced:-1};const v=function(){return[{name:h.id,protocol:h}]};var S=a(86326),f=a(97598),I=a.n(f),T=a(42356),E=a(99993),w=a(96283);function R(){return R=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},R.apply(null,arguments)}const x={PatientWeight:null,PatientSex:null,SeriesTime:null,RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:null,RadionuclideHalfLife:null,RadiopharmaceuticalStartTime:null}},b=({children:e,className:t,...a})=>S.createElement("div",R({className:`flex flex-row items-center space-x-4 ${t||""}`},a),e);function D(){const{commandsManager:e,servicesManager:t}=(0,T.Jg)(),{t:a}=(0,E.Bd)("PanelSUV"),{displaySetService:n,hangingProtocolService:o}=t.services,[r,i]=(0,S.useState)(x),[s,l]=(0,S.useState)(null),c=e=>{i(t=>{const a={...t};return Object.keys(e).forEach(n=>{"object"==typeof e[n]?a[n]={...t[n],...e[n]}:a[n]=e[n]}),a})},p=t=>{const a=e.runCommand("getMatchingPTDisplaySet",{viewportMatchDetails:t});if(!a)return;return{ptDisplaySet:a,metadata:e.runCommand("getPTMetadata",{ptDisplaySet:a})}};return(0,S.useEffect)(()=>{const e=n.getActiveDisplaySets(),{viewportMatchDetails:t}=o.getMatchDetails();if(!e.length)return;const a=p(t);if(!a)return;const{ptDisplaySet:r,metadata:s}=a;l(r),i(s)},[]),(0,S.useEffect)(()=>{const{unsubscribe:e}=o.subscribe(o.EVENTS.PROTOCOL_CHANGED,({viewportMatchDetails:e})=>{const t=p(e);if(!t)return;const{ptDisplaySet:a,metadata:n}=t;l(a),i(n)});return()=>{e()}},[]),S.createElement(S.Fragment,null,S.createElement("div",{className:"ohif-scrollbar flex min-h-0 flex-auto select-none flex-col justify-between overflow-auto"},S.createElement("div",{className:"flex min-h-0 flex-1 flex-col bg-[rgb(var(--background))] text-base"},S.createElement(w.aUM,{defaultOpen:!0},S.createElement(w.aUM.Header,null,a("Patient Information")),S.createElement(w.aUM.Content,null,S.createElement("div",{className:"flex flex-col gap-3 bg-[rgb(var(--primary-dark))] p-2"},S.createElement(b,null,S.createElement(b.Label,null,a("Patient Sex")),S.createElement(b.Input,{value:r.PatientSex||"",onChange:e=>{c({PatientSex:e.target.value})}})),S.createElement(b,null,S.createElement(b.Label,{unit:"kg"},a("Weight")),S.createElement(b.Input,{value:r.PatientWeight||"",onChange:e=>{c({PatientWeight:e.target.value})},id:"weight-input"})),S.createElement(b,null,S.createElement(b.Label,{unit:"bq"},a("Total Dose")),S.createElement(b.Input,{value:r.RadiopharmaceuticalInformationSequence.RadionuclideTotalDose||"",onChange:e=>{c({RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:e.target.value}})}})),S.createElement(b,null,S.createElement(b.Label,{unit:"s"},a("Half Life")),S.createElement(b.Input,{value:r.RadiopharmaceuticalInformationSequence.RadionuclideHalfLife||"",onChange:e=>{c({RadiopharmaceuticalInformationSequence:{RadionuclideHalfLife:e.target.value}})}})),S.createElement(b,null,S.createElement(b.Label,{unit:"s"},a("Injection Time")),S.createElement(b.Input,{value:r.RadiopharmaceuticalInformationSequence.RadiopharmaceuticalStartTime||"",onChange:e=>{c({RadiopharmaceuticalInformationSequence:{RadiopharmaceuticalStartTime:e.target.value}})}})),S.createElement(b,null,S.createElement(b.Label,{unit:"s"},a("Acquisition Time")),S.createElement(b.Input,{value:r.SeriesTime||"",onChange:()=>{}})),S.createElement(w.$nd,{variant:"default",size:"sm",className:"w-28 self-end",onClick:function(){if(!s)throw new Error("No ptDisplaySet found");T.H8.updateMetadataForSeries(s.StudyInstanceUID,s.SeriesInstanceUID,r),n.setDisplaySetMetadataInvalidated(s.displaySetInstanceUID),setTimeout(()=>{e.runCommand("resetCrosshairs")},0)}},"Reload Data")))))))}b.Label=({children:e,unit:t,className:a,...n})=>S.createElement(w.JU7,R({className:`min-w-32 flex-shrink-0 ${a||""}`},n),e,t&&S.createElement("span",{className:"text-muted-foreground"}," ",t)),b.Input=({className:e,...t})=>S.createElement(w.pde,R({className:`h-7 flex-1 ${e||""}`},t)),b.Label.displayName="InputRow.Label",b.Input.displayName="InputRow.Input",D.propTypes={servicesManager:I().shape({services:I().shape({measurementService:I().shape({getMeasurements:I().func.isRequired,subscribe:I().func.isRequired,EVENTS:I().object.isRequired,VALUE_TYPES:I().object.isRequired}).isRequired}).isRequired}).isRequired};const N="roi_stat",C=[{value:N,label:"Max",placeHolder:"Max"},{value:"range",label:"Range",placeHolder:"Range"}];const O=function({config:e,dispatch:t,runCommand:a}){const{t:n}=(0,E.Bd)("ROIThresholdConfiguration");return S.createElement("div",{className:"flex flex-col space-y-4 bg-[rgb(var(--primary-dark))] p-px"},S.createElement("div",{className:"flex items-end space-x-3"},S.createElement("div",{className:"flex min-w-0 flex-1 flex-col"},S.createElement(w.l6P,{value:e.strategy,onValueChange:e=>{t({type:"setStrategy",payload:{strategy:e}})}},S.createElement(w.bqE,{className:"w-full"},S.createElement(w.yvm,{placeholder:C.find(t=>t.value===e.strategy)?.placeHolder})),S.createElement(w.gCo,{className:""},C.map(e=>S.createElement(w.ebT,{key:e.value,value:e.value},e.label))))),S.createElement("div",{className:"flex-shrink-0"},S.createElement("div",{className:"flex justify-end space-x-2"},S.createElement(w.$nd,{variant:"secondary",onClick:()=>a("setStartSliceForROIThresholdTool")},n("Start")),S.createElement(w.$nd,{variant:"secondary",onClick:()=>a("setEndSliceForROIThresholdTool")},n("End"))))),e.strategy===N&&S.createElement("div",{className:"mr-0"},S.createElement("div",{className:"mb-2"},S.createElement(w.JU7,null,n("Percentage of Max SUV"))),S.createElement(w.pde,{"data-cy":"percentage-of-max-suv-input",className:"w-full",type:"text",value:e.weight,onChange:e=>{let a=e.target.value;"."===a&&(a="0."),isNaN(Number(a))||Number(a)<0||Number(a)>1||t({type:"setWeight",payload:{weight:a}})}})),e.strategy!==N&&S.createElement("div",{className:"mr-2 text-sm"},S.createElement("div",{className:"flex flex-col space-y-2"},S.createElement(w.JU7,null,"Lower & Upper Ranges"),S.createElement("div",{className:"flex items-center"},S.createElement("div",{className:"w-10 text-left"},S.createElement(w.JU7,null,"CT")),S.createElement("div",{className:"flex flex-1 space-x-2"},S.createElement("div",{className:"flex-1"},S.createElement(w.pde,{className:"w-full",type:"text",value:e.ctLower,onChange:e=>{t({type:"setThreshold",payload:{ctLower:e.target.value}})}})),S.createElement("div",{className:"flex-1"},S.createElement(w.pde,{className:"w-full",type:"text",value:e.ctUpper,onChange:e=>{t({type:"setThreshold",payload:{ctUpper:e.target.value}})}})))),S.createElement("div",{className:"flex items-center"},S.createElement("div",{className:"w-10 text-left"},S.createElement(w.JU7,null,"PT")),S.createElement("div",{className:"flex flex-1 space-x-2"},S.createElement("div",{className:"flex-1"},S.createElement(w.pde,{className:"w-full",type:"text",value:e.ptLower,onChange:e=>{t({type:"setThreshold",payload:{ptLower:e.target.value}})}})),S.createElement("div",{className:"flex-1"},S.createElement(w.pde,{className:"w-full",type:"text",value:e.ptUpper,onChange:e=>{t({type:"setThreshold",payload:{ptUpper:e.target.value}})}})))))))},M=O;var U=a(39548),L=a(37948);function P({configuration:e}){return S.createElement(S.Fragment,null,S.createElement(L.PanelSegmentation,{configuration:e},S.createElement(O,null)))}const F=function({commandsManager:e,extensionManager:t,servicesManager:a}){const{toolbarService:n}=a.services;return[{name:"petSUV",iconName:"tab-patient-info",iconLabel:"Patient Info",label:"Patient Info",component:()=>S.createElement(D,null)},{name:"tmtv",iconName:"tab-segmentation",iconLabel:"Segmentation",component:()=>S.createElement(S.Fragment,null,S.createElement(U.Toolbox,{buttonSectionId:n.sections.roiThresholdToolbox,title:"Threshold Tools"}),S.createElement(P,{commandsManager:e,servicesManager:a}))},{name:"tmtvBox",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation Toolbox",component:()=>S.createElement(U.Toolbox,{buttonSectionId:n.sections.roiThresholdToolbox,title:"Threshold Tools"})},{name:"tmtvExport",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation Export",component:()=>S.createElement(M,null)}]};var A=a(4667);const V=["RectangleROIStartEndThreshold","CircleROIStartEndThreshold"],G={toAnnotation:(e,t)=>{},toMeasurement:(e,t,a)=>{const{annotation:n,viewportId:o}=e,{metadata:r,data:i,annotationUID:s}=n;if(!r||!i)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:l,referencedImageId:c,FrameOfReferenceUID:p}=r;if(!V.includes(l))throw new Error("Tool not supported");const{SOPInstanceUID:m,SeriesInstanceUID:u,StudyInstanceUID:d}=(0,L.getSOPInstanceAttributes)(c,a,o);let g;return g=m?t.getDisplaySetForSOPInstanceUID(m,u):t.getDisplaySetsForSeries(u),{uid:s,SOPInstanceUID:m,FrameOfReferenceUID:p,metadata:r,referenceSeriesUID:u,referenceStudyUID:d,toolName:r.toolName,displaySetInstanceUID:g.displaySetInstanceUID,label:r.label,data:i.cachedStats,type:"RectangleROIStartEndThreshold"}}},k={toAnnotation:(e,t)=>{},toMeasurement:(e,t,a)=>{const{annotation:n,viewportId:o}=e,{metadata:r,data:i,annotationUID:s}=n;if(!r||!i)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:l,referencedImageId:c,FrameOfReferenceUID:p}=r;if(!V.includes(l))throw new Error("Tool not supported");const{SOPInstanceUID:m,SeriesInstanceUID:u,StudyInstanceUID:d}=(0,L.getSOPInstanceAttributes)(c,a,o);let g;g=m?t.getDisplaySetForSOPInstanceUID(m,u):t.getDisplaySetsForSeries(u);const{cachedStats:y}=i;return{uid:s,SOPInstanceUID:m,FrameOfReferenceUID:p,metadata:r,referenceSeriesUID:u,referenceStudyUID:d,toolName:r.toolName,displaySetInstanceUID:g.displaySetInstanceUID,label:r.label,data:i.cachedStats,type:"CircleROIStartEndThreshold"}}},W=(e,t,a)=>({RectangleROIStartEndThreshold:{toAnnotation:G.toAnnotation,toMeasurement:e=>G.toMeasurement(e,t,a),matchingCriteria:[{valueType:e.VALUE_TYPES.ROI_THRESHOLD_MANUAL}]},CircleROIStartEndThreshold:{toAnnotation:k.toAnnotation,toMeasurement:e=>k.toMeasurement(e,t,a),matchingCriteria:[{valueType:e.VALUE_TYPES.ROI_THRESHOLD_MANUAL}]}}),{CORNERSTONE_3D_TOOLS_SOURCE_NAME:q,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:j}=L.Enums;var _=a(15327),H=a(68523);function B(e,t){const{imageIds:a}=e,n=_.cache.getVolumeContainingImageId(a[0]);if(!n)throw new Error("No volume found for display set");const{volume:o}=n,{voxelManager:r}=o,{fn:i,baseValue:s}=function(){const e=-1/0,t=(e,t)=>(e>t&&(t=e),t);return{fn:t,baseValue:e}}();let l=s;const c=A.utilities.rectangleROITool.getBoundsIJKFromRectangleAnnotations(t,o);return r.forEach(({value:e})=>{l=i(e,l)},{boundsIJK:c}),l}const $=function(e,t,a){if("range"===a.strategy)return{ptLower:Number(a.ptLower),ptUpper:Number(a.ptUpper),ctLower:Number(a.ctLower),ctUpper:Number(a.ctUpper)};const{weight:n}=a;return{ctLower:-1/0,ctUpper:1/0,ptLower:n*B(t,e.map(e=>A.annotation.state.getAnnotation(e))),ptUpper:1/0}};var J=a(5842),X=a(53434);const{datasetToBlob:Y}=J.Ay.data,Z=T.Ly.MetadataProvider;const K=function(e){const t=X.f_.Cornerstone3D.RTSS.generateRTSSFromAnnotations(e,Z,T.H8),a=Y(t);var n=URL.createObjectURL(a);window.location.assign(n)},{SegmentationRepresentations:z}=A.Enums,{formatPN:Q}=T.Wp,ee=T.Ly.MetadataProvider,te=["RectangleROIStartEndThreshold","RectangleROIThreshold","CircleROIStartEndThreshold"],ae=({servicesManager:e,commandsManager:t,extensionManager:a})=>{const{viewportGridService:n,uiNotificationService:o,displaySetService:r,hangingProtocolService:i,toolGroupService:s,cornerstoneViewportService:l,segmentationService:c}=e.services,p=a.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{getEnabledElement:m}=p.exports;function u(){const{activeViewportId:e}=n.getState(),{element:t}=m(e)||{};return _.getEnabledElement(t)}function d(e){return e.reduce((e,t)=>{const a=A.annotation.selection.getAnnotationsSelectedByToolName(t);return e.concat(a)},[])}const g={getMatchingPTDisplaySet:({viewportMatchDetails:e})=>{let t=null;for(const[,a]of e){const{displaySetsInfo:e}=a,n=e.map(({displaySetInstanceUID:e})=>r.getDisplaySetByUID(e));if(n&&0!==n.length&&(t=n.find(e=>"PT"===e.Modality),t))break}return t},getPTMetadata:({ptDisplaySet:e})=>{const t=a.getDataSources()[0].getImageIdsForDisplaySet(e)[0],n=ee.get("instance",t);if("PT"!==n.Modality)return;return{SeriesTime:n.SeriesTime,Modality:n.Modality,PatientSex:n.PatientSex,PatientWeight:n.PatientWeight,RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:n.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadionuclideHalfLife:n.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadiopharmaceuticalStartTime:n.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,RadiopharmaceuticalStartDateTime:n.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime}}},createNewLabelmapFromPT:async({label:e})=>{const{viewportMatchDetails:t}=i.getMatchDetails(),a=g.getMatchingPTDisplaySet({viewportMatchDetails:t});let n=null;for(const[e,{displaySetsInfo:o}]of t.entries()){if(o.some(({displaySetInstanceUID:e})=>e===a.displaySetInstanceUID)){n=e;break}}if(!a)return void o.error("No matching PT display set found");const s=c.getSegmentationRepresentations(n),l=r.getDisplaySetByUID(a.displaySetInstanceUID),p=await c.createLabelmapForDisplaySet(l,{label:`Segmentation ${s.length+1}`,segments:{1:{label:`${H.A.t("Segment")} 1`,active:!0}}});return c.addSegmentationRepresentation(n,{segmentationId:p}),p},thresholdSegmentationByRectangleROITool:({segmentationId:e,config:t,segmentIndex:a})=>{const n=A.segmentation.state.getSegmentation(e),{representationData:s}=n,{displaySetMatchDetails:l}=i.getMatchDetails(),c=l.get("ctDisplaySet"),p=l.get("ptDisplaySet"),m=r.getDisplaySetByUID(c.displaySetInstanceUID),u=r.getDisplaySetByUID(p.displaySetInstanceUID),{volumeId:g}=s[z.Labelmap],y=_.cache.getVolume(g),h=d(te);if(0===h.length)return void o.show({title:"Commands Module",message:"No ROIThreshold Tool is Selected",type:"error"});const{ptLower:v,ptUpper:S,ctLower:f,ctUpper:I}=$(h,u,t),{imageIds:T}=u,E=_.cache.getVolumeContainingImageId(T[0]);if(!E)return void o.error("No PT volume found");const{imageIds:w}=m,R=_.cache.getVolumeContainingImageId(w[0]);if(!R)return void o.error("No CT volume found");const x=E.volume,b=R.volume;return A.utilities.segmentation.rectangleROIThresholdVolumeByRange(h,y,[{volume:x,lower:v,upper:S},{volume:b,lower:f,upper:I}],{overwrite:!0,segmentIndex:a,segmentationId:e})},calculateTMTV:async({segmentations:e})=>{const t=e.map(e=>e.segmentationId),a=await A.utilities.segmentation.computeMetabolicStats({segmentationIds:t,segmentIndex:1});return c.setSegmentationGroupStats(t,a),a},exportTMTVReportCSV:async({segmentations:e,tmtv:a,config:n,options:o})=>{const r=t.runCommand("getSegmentationCSVReport",{segmentations:e});let i=0;for(const e in r){i+=r[e].namedStats_lesionGlycolysis.value}const s=[{key:"Total Lesion Glycolysis",value:{tlg:i.toFixed(4)}},{key:"Threshold Configuration",value:{...n}}];void 0!==a&&s.unshift({key:"Total Metabolic Tumor Volume",value:{tmtv:a}}),function(e,t,a={}){const n=e[Object.keys(e)[0]],o=Object.keys(n),r=[o.map(e=>e.toLowerCase().startsWith("namedstats_")?e.substring(11):e).join(",")];Object.values(e).forEach(e=>{const t=[];o.forEach(a=>{t.push(e[a]&&"object"==typeof e[a]?Array.isArray(e[a])?e[a].join(" "):e[a].value&&Array.isArray(e[a].value)?e[a].value.join(" "):e[a].value??e[a]:e[a])}),r.push(t.join(","))}),r.push(""),r.push(""),r.push(""),r.push(`Patient ID,${n.PatientID}`),r.push(`Study Date,${n.StudyDate}`),r.push(""),t.forEach(({key:e,value:t})=>{const a=[];a.push(`${e}`),Object.keys(t).forEach(e=>{a.push(`${e}`),a.push(`${t[e]}`)}),r.push(a.join(","))});const i=new Blob([r.join("\n")],{type:"text/csv;charset=utf-8"}),s=URL.createObjectURL(i),l=document.createElement("a");l.href=s,l.download=a.filename??`${n.PatientID}_tmtv.csv`,l.click()}(r,s,o)},setStartSliceForROIThresholdTool:()=>{const{viewport:e}=u(),{focalPoint:t}=e.getCamera(),a=d(te)[0],n=A.annotation.state.getAnnotation(a);n.data.startCoordinate=t,n.invalidated=!0,e.render()},setEndSliceForROIThresholdTool:()=>{const{viewport:e}=u(),t=d(te)[0],a=A.annotation.state.getAnnotation(t),n=e.getCamera().focalPoint;a.data.endCoordinate=n,a.invalidated=!0,e.render()},createTMTVRTReport:()=>{const e=A.annotation.state.getAnnotationManager(),a=[];Object.keys(e.annotations).forEach(t=>{const n=e.annotations[t],o=te.reduce((e,t)=>[...e,...n[t]??[]],[]);a.push(...o)}),t.runCommand("exportRTReportForAnnotations",{annotations:a})},getSegmentationCSVReport:({segmentations:e})=>{e&&e.length||(e=c.getSegmentations());const t={};for(const a of e){const{label:e,segmentationId:n,representationData:o}=a,r=n,i={id:r,label:e};if(!o){t[r]=i;continue}const{cachedStats:s}=a.segments[1]||{};s&&Object.entries(s).forEach(([e,t])=>{"object"!=typeof t?i[e]=t:Object.entries(t).forEach(([t,a])=>{i[`${e}_${t}`]=a})});const l=a.representationData[z.Labelmap];if(!l){t[r]=i;continue}const c=A.utilities.segmentation.getReferenceVolumeForSegmentationVolume(l.volumeId);if(!c){t[r]=i;continue}if(!c.imageIds||!c.imageIds.length){t[r]=i;continue}const p=c.imageIds[0],m=T.Ay.classes.MetadataProvider.get("instance",p);m?t[r]={...i,PatientID:m.PatientID??"000000",PatientName:Q(m.PatientName),StudyInstanceUID:m.StudyInstanceUID,SeriesInstanceUID:m.SeriesInstanceUID,StudyDate:m.StudyDate}:t[r]=i}return t},exportRTReportForAnnotations:({annotations:e})=>{K(e)},setFusionPTColormap:({toolGroupId:e,colormap:a})=>{const n=s.getToolGroup(e);if(!n)return;const{viewportMatchDetails:o}=i.getMatchDetails(),r=g.getMatchingPTDisplaySet({viewportMatchDetails:o});if(!r)return;const c=n.getViewportIds(),p=[];c.forEach(e=>{t.runCommand("setViewportColormap",{viewportId:e,displaySetInstanceUID:r.displaySetInstanceUID,colormap:{name:a}}),p.push(l.getCornerstoneViewport(e))}),p.forEach(e=>{e.render()})}},y={setEndSliceForROIThresholdTool:{commandFn:g.setEndSliceForROIThresholdTool},setStartSliceForROIThresholdTool:{commandFn:g.setStartSliceForROIThresholdTool},getMatchingPTDisplaySet:{commandFn:g.getMatchingPTDisplaySet},getPTMetadata:{commandFn:g.getPTMetadata},createNewLabelmapFromPT:{commandFn:g.createNewLabelmapFromPT},thresholdSegmentationByRectangleROITool:{commandFn:g.thresholdSegmentationByRectangleROITool},calculateTMTV:{commandFn:g.calculateTMTV},exportTMTVReportCSV:{commandFn:g.exportTMTVReportCSV},createTMTVRTReport:{commandFn:g.createTMTVRTReport},getSegmentationCSVReport:{commandFn:g.getSegmentationCSVReport},exportRTReportForAnnotations:{commandFn:g.exportRTReportForAnnotations},setFusionPTColormap:{commandFn:g.setFusionPTColormap}};return{actions:g,definitions:y,defaultContext:"TMTV:CORNERSTONE"}},ne="roi_stat",oe=[{value:ne,label:"Max",placeHolder:"Max"},{value:"range",label:"Range",placeHolder:"Range"}];const re=function({config:e,dispatch:t,runCommand:a}){const{t:n}=(0,E.Bd)("ROIThresholdConfiguration");return S.createElement("div",{className:"flex flex-col space-y-4 bg-[rgb(var(--primary-dark))] p-px"},S.createElement("div",{className:"flex items-end space-x-3"},S.createElement("div",{className:"flex min-w-0 flex-1 flex-col"},S.createElement(w.l6P,{value:e.strategy,onValueChange:e=>{t({type:"setStrategy",payload:{strategy:e}})}},S.createElement(w.bqE,{className:"w-full"},S.createElement(w.yvm,{placeholder:oe.find(t=>t.value===e.strategy)?.placeHolder})),S.createElement(w.gCo,{className:""},oe.map(e=>S.createElement(w.ebT,{key:e.value,value:e.value},e.label))))),S.createElement("div",{className:"flex-shrink-0"},S.createElement("div",{className:"flex justify-end space-x-2"},S.createElement(w.$nd,{variant:"secondary",onClick:()=>a("setStartSliceForROIThresholdTool")},n("Start")),S.createElement(w.$nd,{variant:"secondary",onClick:()=>a("setEndSliceForROIThresholdTool")},n("End"))))),e.strategy===ne&&S.createElement("div",{className:"mr-0"},S.createElement("div",{className:"mb-2"},S.createElement(w.JU7,null,n("Percentage of Max SUV"))),S.createElement(w.pde,{"data-cy":"percentage-of-max-suv-input",className:"w-full",type:"text",value:e.weight,onChange:e=>{let a=e.target.value;"."===a&&(a="0."),isNaN(Number(a))||Number(a)<0||Number(a)>1||t({type:"setWeight",payload:{weight:a}})}})),e.strategy!==ne&&S.createElement("div",{className:"mr-2 text-sm"},S.createElement("div",{className:"flex flex-col space-y-2"},S.createElement(w.JU7,null,"Lower & Upper Ranges"),S.createElement("div",{className:"flex items-center"},S.createElement("div",{className:"w-10 text-left"},S.createElement(w.JU7,null,"CT")),S.createElement("div",{className:"flex flex-1 space-x-2"},S.createElement("div",{className:"flex-1"},S.createElement(w.pde,{className:"w-full",type:"text",value:e.ctLower,onChange:e=>{t({type:"setThreshold",payload:{ctLower:e.target.value}})}})),S.createElement("div",{className:"flex-1"},S.createElement(w.pde,{className:"w-full",type:"text",value:e.ctUpper,onChange:e=>{t({type:"setThreshold",payload:{ctUpper:e.target.value}})}})))),S.createElement("div",{className:"flex items-center"},S.createElement("div",{className:"w-10 text-left"},S.createElement(w.JU7,null,"PT")),S.createElement("div",{className:"flex flex-1 space-x-2"},S.createElement("div",{className:"flex-1"},S.createElement(w.pde,{className:"w-full",type:"text",value:e.ptLower,onChange:e=>{t({type:"setThreshold",payload:{ptLower:e.target.value}})}})),S.createElement("div",{className:"flex-1"},S.createElement(w.pde,{className:"w-full",type:"text",value:e.ptUpper,onChange:e=>{t({type:"setThreshold",payload:{ptUpper:e.target.value}})}})))))))},ie=ne;function se(e,t){const{payload:a}=t,{strategy:n,ctLower:o,ctUpper:r,ptLower:i,ptUpper:s,weight:l}=a;switch(t.type){case"setStrategy":return{...e,strategy:n};case"setThreshold":return{...e,ctLower:o||e.ctLower,ctUpper:r||e.ctUpper,ptLower:i||e.ptLower,ptUpper:s||e.ptUpper};case"setWeight":return{...e,weight:l};default:return e}}const le=function(){const{commandsManager:e}=(0,T.Jg)(),t=(0,L.useSegmentations)()[0],a=(0,S.useCallback)((t,a={})=>e.runCommand(t,a),[e]),[n,o]=(0,S.useReducer)(se,{strategy:ie,ctLower:-1024,ctUpper:1024,ptLower:2.5,ptUpper:100,weight:.41}),r=(0,S.useCallback)(()=>{if(!t)return;const e=t.segmentationId,o=A.segmentation.segmentIndex.getActiveSegmentIndex(e);a("thresholdSegmentationByRectangleROITool",{segmentationId:e,config:n,segmentIndex:o})},[t,n]);return S.createElement("div",{className:"invisible-scrollbar mb-1 flex flex-col overflow-y-auto overflow-x-hidden"},S.createElement(re,{config:n,dispatch:o,runCommand:a}),t&&S.createElement(w.$nd,{variant:"default",className:"my-3 mr-auto w-20",onClick:r},"Run"))};const ce={id:n,preRegistration({servicesManager:e,commandsManager:t,extensionManager:a,configuration:n={}}){!function({servicesManager:e}){const{measurementService:t,displaySetService:a,cornerstoneViewportService:n}=e.services;(0,A.addTool)(A.RectangleROIStartEndThresholdTool),(0,A.addTool)(A.CircleROIStartEndThresholdTool);const{RectangleROIStartEndThreshold:o,CircleROIStartEndThreshold:r}=W(t,a,n),i=t.getSource(q,j);t.addMapping(i,"RectangleROIStartEndThreshold",o.matchingCriteria,o.toAnnotation,o.toMeasurement),t.addMapping(i,"CircleROIStartEndThreshold",r.matchingCriteria,r.toAnnotation,r.toMeasurement)}({servicesManager:e,commandsManager:t,extensionManager:a,configuration:n})},getToolbarModule:function(){return[{name:"tmtv.RectangleROIThresholdOptions",defaultComponent:le}]},getPanelModule:F,getHangingProtocolModule:v,getCommandsModule:({servicesManager:e,commandsManager:t,extensionManager:a})=>ae({servicesManager:e,commandsManager:t,extensionManager:a})},pe=ce}}]);
//# sourceMappingURL=9428.bundle.9be857e233d5cb90750f.js.map