/*! For license information please see 2518.bundle.f750fd7ad4c2c674c4bd.js.LICENSE.txt */
(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[2518],{53434:(e,t,n)=>{"use strict";n.d(t,{fX:()=>s,W6:()=>gt,X6:()=>fa,f_:()=>Ia,ql:()=>pa,QX:()=>ga,_$:()=>c});var a={};n.r(a),n.d(a,{fillSegmentation:()=>Je,generateSegmentation:()=>Xe,generateToolState:()=>Qe});var r={};n.r(r),n.d(r,{createFromDICOMSegBuffer:()=>$n,generateLabelMaps2DFrom3D:()=>yn,generateSegmentation:()=>Cn,generateToolState:()=>kn});var i={};n.r(i),n.d(i,{generateToolState:()=>zn});var o={};n.r(o),n.d(o,{generateContourSetsFromLabelmap:()=>na,generateRTSSFromAnnotations:()=>ea,generateRTSSFromSegmentations:()=>Zn});var s={};n.r(s),n.d(s,{s:()=>ye});var c={};n.r(c),n.d(c,{vk:()=>Sa});var u=n(5842);const d=e=>Array.isArray(e)?e:void 0!==e?[e]:[],l=e=>t=>t.ConceptNameCodeSequence.CodeMeaning===e;var m=n(81429),g=n(15327);const{TID1500:p,addAccessors:f}=u.BF,{StructuredReport:I}=u.h4,{Normalizer:h}=u.z8,{TID1500MeasurementReport:S,TID1501MeasurementGroup:O}=p,{DicomMetaDictionary:T}=u.p,D={CodingSchemeDesignator:"DCM",CodeValue:"121071"},C={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},y={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},R=(e,t,n)=>{const{ConceptNameCodeSequence:a}=e;if(!a)return;const{CodingSchemeDesignator:r,CodeValue:i}=a;return r==t.CodingSchemeDesignator&&i==t.CodeValue||n&&r==n.CodingSchemeDesignator&&i==n.CodeValue};class E{static getSetupMeasurementData(e){const{ContentSequence:t}=e,n=d(t),a=n.find(e=>R(e,D)),r=n.filter(e=>R(e,C,y))||[],i=n.find(e=>"NUM"===e.ValueType),o=d(i.ContentSequence).find(e=>"SCOORD"===e.ValueType),{ReferencedSOPSequence:s}=o.ContentSequence,{ReferencedSOPInstanceUID:c,ReferencedFrameNumber:u}=s,l={sopInstanceUid:c,frameIndex:u||1,complete:!0,finding:a?f(a.ConceptCodeSequence):void 0,findingSites:r.map(e=>f(e.ConceptCodeSequence))};l.finding&&(l.description=l.finding.CodeMeaning);const m=l.findingSites&&l.findingSites[0];return m&&(l.location=m[0]&&m[0].CodeMeaning||m.CodeMeaning),{defaultState:l,findingGroup:a,findingSiteGroups:r,NUMGroup:i,SCOORDGroup:o,ReferencedSOPSequence:s,ReferencedSOPInstanceUID:c,ReferencedFrameNumber:u}}static generateReport(e,t,n){let a=[];const r=Object.keys(e)[0];if(!r)throw new Error("No measurements provided.");const i=t.get("generalSeriesModule",r),{studyInstanceUID:o,seriesInstanceUID:s}=i;Object.keys(e).forEach(n=>{const r=t.get("sopCommonModule",n),i=t.get("frameNumber",n),o=e[n],s=Object.keys(o),c={ReferencedSOPClassUID:r.sopClassUID,ReferencedSOPInstanceUID:r.sopInstanceUID};h.isMultiframeSOPClassUID(r.sopClassUID)&&(c.ReferencedFrameNumber=i);const u=[];s.forEach(e=>{const t=function(e,t,n){const a=t[e],r=E.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(!(a&&a.data&&a.data.length&&r))return;const i=a.data.map(e=>function(e,t,n){const a=n.getTID300RepresentationArguments(e);return a.ReferencedSOPSequence=t,a.ReferencedFrameOfReferenceUID=a.use3DSpatialCoordinates?e.metadata.FrameOfReferenceUID:null,new n.TID300Representation(a)}(e,n,r));return new O(i)}(e,o,c);t&&u.push(t)}),a=a.concat(u)});const c=new S({TID1501MeasurementGroups:a},n),u=new Uint8Array(2);u[1]=1;const d={StudyInstanceUID:o,SeriesInstanceUID:s},l={FileMetaInformationVersion:{Value:[u.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[T.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};d._meta=l,d._vrMap={PixelData:"OW"};const m=new I([d]),g=c.contentItem(d);return m.dataset=Object.assign(m.dataset,g),m.dataset._meta=l,m.dataset.SpecificCharacterSet="ISO_IR 192",m}static generateToolState(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("1500"!==e.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");const n=d(e.ContentSequence).find(l("Imaging Measurements")),a=d(n.ContentSequence).filter(l("Measurement Group")),r={},i=E.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,o=[];return Object.keys(i).forEach(e=>{o.push(i[e]),r[e]=[]}),a.forEach(n=>{const a=d(n.ContentSequence).find(e=>"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning).TextValue,i=t.getToolClass?t.getToolClass(n,e,o):o.find(e=>e.isValidCornerstoneTrackingIdentifier(a));if(i){const e=i.getMeasurementData(n);console.log(`=== ${i.toolType} ===`),console.log(e),r[i.toolType].push(e)}}),r}static registerTool(e){E.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[e.utilityToolType]=e,E.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e.toolType]=e,E.MEASUREMENT_BY_TOOLTYPE[e.toolType]=e.utilityToolType}}E.MEASUREMENT_BY_TOOLTYPE={},E.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},E.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={};var N="cornerstoneTools@^4.0.0";const{Length:M}=u.BF.TID300,A="Length";class P{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),r={...t,length:n.MeasuredValueSequence.NumericValue,toolType:P.toolType,handles:{start:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};return[r.handles.start.x,r.handles.start.y,r.handles.end.x,r.handles.end.y]=a.GraphicData,r}static getTID300RepresentationArguments(e){const{handles:t,finding:n,findingSites:a}=e;return{point1:t.start,point2:t.end,distance:e.length,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Length",finding:n,findingSites:a||[]}}}P.toolType=A,P.utilityToolType=A,P.TID300Representation=M,P.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===N&&n===A},E.registerTool(P);const{Polyline:_}=u.BF.TID300;class v{static getMeasurementData(e){const{defaultState:t,SCOORDGroup:n,NUMGroup:a}=E.getSetupMeasurementData(e),r={...t,toolType:v.toolType,handles:{points:[],textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0},{GraphicData:i}=n;for(let e=0;e<i.length;e+=2)r.handles.points.push({x:i[e],y:i[e+1]});return r}static getTID300RepresentationArguments(e){const{handles:t,finding:n,findingSites:a,cachedStats:r={}}=e,{points:i}=t,{area:o=0,perimeter:s=0}=r;return{points:i,area:o,perimeter:s,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:FreehandRoi",finding:n,findingSites:a||[]}}}v.toolType="FreehandRoi",v.utilityToolType="FreehandRoi",v.TID300Representation=_,v.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===N&&n===v.toolType},E.registerTool(v);const{Bidirectional:x}=u.BF.TID300,w="Bidirectional";class b{static getMeasurementData(e){const{ContentSequence:t}=e,n=d(t).find(e=>"121071"===e.ConceptNameCodeSequence.CodeValue),a=d(t).filter(e=>"G-C0E3"===e.ConceptNameCodeSequence.CodeValue),r=d(t).find(e=>"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning),i=d(r.ContentSequence).find(e=>"SCOORD"===e.ValueType),o=d(t).find(e=>"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning),s=d(o.ContentSequence).find(e=>"SCOORD"===e.ValueType),{ReferencedSOPSequence:c}=i.ContentSequence,{ReferencedSOPInstanceUID:u,ReferencedFrameNumber:l}=c,m=String(r.MeasuredValueSequence.NumericValue),g=String(o.MeasuredValueSequence.NumericValue),p=Math.max(i.GraphicData[0],i.GraphicData[2],s.GraphicData[0],s.GraphicData[2]),f=Math.max(i.GraphicData[1],i.GraphicData[3],s.GraphicData[1],s.GraphicData[3]);return{sopInstanceUid:u,frameIndex:l||1,toolType:b.toolType,active:!1,handles:{start:{x:i.GraphicData[0],y:i.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:0},end:{x:i.GraphicData[2],y:i.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:1},perpendicularStart:{x:s.GraphicData[0],y:s.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:2},perpendicularEnd:{x:s.GraphicData[2],y:s.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:3},textBox:{highlight:!1,hasMoved:!0,active:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0,x:p+10,y:f+10}},invalidated:!1,isCreating:!1,longestDiameter:m,shortestDiameter:g,toolName:"Bidirectional",visible:!0,finding:n?n.ConceptCodeSequence:void 0,findingSites:a.map(e=>e.ConceptCodeSequence)}}static getTID300RepresentationArguments(e){const{start:t,end:n,perpendicularStart:a,perpendicularEnd:r}=e.handles,{shortestDiameter:i,longestDiameter:o,finding:s,findingSites:c}=e;return{longAxis:{point1:t,point2:n},shortAxis:{point1:a,point2:r},longAxisLength:o,shortAxisLength:i,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Bidirectional",finding:s,findingSites:c||[]}}}b.toolType=w,b.utilityToolType=w,b.TID300Representation=x,b.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===N&&n===w},E.registerTool(b);const{Ellipse:U}=u.BF.TID300,F="EllipticalRoi";class q{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),{GraphicData:r}=a,i=[{x:r[0],y:r[1]},{x:r[2],y:r[3]}],o=[{x:r[4],y:r[5]},{x:r[6],y:r[7]}],s=Math.sqrt(Math.pow(o[0].x-o[1].x,2)+Math.pow(o[0].y-o[1].y,2)),c=(o[1].x-o[0].x)/s,u=(o[1].y-o[0].y)/s,d=s/2,l={x:i[0].x+c*d,y:i[0].y+u*d},m={x:i[1].x-c*d,y:i[1].y-u*d};return{...t,toolType:q.toolType,active:!1,cachedStats:{area:n?n.MeasuredValueSequence.NumericValue:0},handles:{end:{x:l.x,y:l.y,highlight:!1,active:!1},initialRotation:0,start:{x:m.x,y:m.y,highlight:!1,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0}}static getTID300RepresentationArguments(e){const{cachedStats:t={},handles:n,finding:a,findingSites:r}=e,{start:i,end:o}=n,{area:s}=t,c=Math.abs(i.x-o.x)/2,u=Math.abs(i.y-o.y)/2,d=[],l={x:(i.x+o.x)/2,y:(i.y+o.y)/2};c>u?(d.push({x:l.x-c,y:l.y}),d.push({x:l.x+c,y:l.y}),d.push({x:l.x,y:l.y-u}),d.push({x:l.x,y:l.y+u})):(d.push({x:l.x,y:l.y-u}),d.push({x:l.x,y:l.y+u}),d.push({x:l.x-c,y:l.y}),d.push({x:l.x+c,y:l.y}));return{area:s,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:EllipticalRoi",finding:a,findingSites:r||[]}}}q.toolType=F,q.utilityToolType=F,q.TID300Representation=U,q.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===N&&n===F},E.registerTool(q);const{Circle:G}=u.BF.TID300,V="CircleRoi";class L{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),{GraphicData:r}=a,i={x:r[0],y:r[1]},o={x:r[2],y:r[3]};return{...t,toolType:L.toolType,active:!1,cachedStats:{area:n?n.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0},handles:{end:{...o,highlight:!1,active:!1},initialRotation:0,start:{...i,highlight:!1,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0}}static getTID300RepresentationArguments(e){const{cachedStats:t={},handles:n,finding:a,findingSites:r}=e,{start:i,end:o}=n,{area:s,radius:c}=t,u=2*Math.PI*c,d=[];d.push(i),d.push(o);return{area:s,perimeter:u,radius:c,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CircleRoi",finding:a,findingSites:r||[]}}}L.toolType=V,L.utilityToolType=V,L.TID300Representation=G,L.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===N&&n===V},E.registerTool(L);const{Point:B}=u.BF.TID300,k="ArrowAnnotate",$="CORNERSTONEFREETEXT";class j{static getMeasurementData(e){const{defaultState:t,SCOORDGroup:n,findingGroup:a}=E.getSetupMeasurementData(e),{GraphicData:r}=n;return{...t,toolType:j.toolType,active:!1,handles:{start:{x:r[0],y:r[1],highlight:!0,active:!1},end:{x:4==r.length?r[2]:r[0]+20,y:4==r.length?r[3]:r[1]+20,highlight:!0,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0}}static getTID300RepresentationArguments(e){const t=[e.handles.start,e.handles.end],{findingSites:n}=e;let{finding:a}=e;const r={points:t,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:ArrowAnnotate",findingSites:n||[]};return a&&a.CodeValue===$||(a={CodeValue:$,CodingSchemeDesignator:"CST4",CodeMeaning:e.label}),r.finding=a,r}}j.toolType=k,j.utilityToolType=k,j.TID300Representation=B,j.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===N&&n===k},E.registerTool(j);const{CobbAngle:H}=u.BF.TID300,z="CobbAngle";class Y{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),r={...t,rAngle:n.MeasuredValueSequence.NumericValue,toolType:Y.toolType,handles:{start:{},end:{},start2:{highlight:!0,drawnIndependently:!0},end2:{highlight:!0,drawnIndependently:!0},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};return[r.handles.start.x,r.handles.start.y,r.handles.end.x,r.handles.end.y,r.handles.start2.x,r.handles.start2.y,r.handles.end2.x,r.handles.end2.y]=a.GraphicData,r}static getTID300RepresentationArguments(e){const{handles:t,finding:n,findingSites:a}=e;return{point1:t.start,point2:t.end,point3:t.start2,point4:t.end2,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CobbAngle",finding:n,findingSites:a||[]}}}Y.toolType=z,Y.utilityToolType=z,Y.TID300Representation=H,Y.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===N&&n===z},E.registerTool(Y);const{Angle:W}=u.BF.TID300,K="Angle";class X{static getMeasurementData(e){const{defaultState:t,NUMGroup:n,SCOORDGroup:a}=E.getSetupMeasurementData(e),r={...t,rAngle:n.MeasuredValueSequence.NumericValue,toolType:X.toolType,handles:{start:{},middle:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};return[r.handles.start.x,r.handles.start.y,r.handles.middle.x,r.handles.middle.y,r.handles.middle.x,r.handles.middle.y,r.handles.end.x,r.handles.end.y]=a.GraphicData,r}static getTID300RepresentationArguments(e){const{handles:t,finding:n,findingSites:a}=e;return{point1:t.start,point2:t.middle,point3:t.middle,point4:t.end,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Angle",finding:n,findingSites:a||[]}}}X.toolType=K,X.utilityToolType=K,X.TID300Representation=W,X.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===N&&n===K},E.registerTool(X);const{Polyline:Q}=u.BF.TID300;class J{static getMeasurementData(e){const{defaultState:t,SCOORDGroup:n,NUMGroup:a}=E.getSetupMeasurementData(e),r={...t,toolType:J.toolType,handles:{start:{},end:{},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0},initialRotation:0},cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0},i={};return[r.handles.start.x,r.handles.start.y,i.x,i.y,r.handles.end.x,r.handles.end.y]=n.GraphicData,r}static getTID300RepresentationArguments(e){const{finding:t,findingSites:n,cachedStats:a={},handles:r}=e,{start:i,end:o}=r,s=[i,{x:i.x,y:o.y},o,{x:o.x,y:i.y}],{area:c,perimeter:u}=a;return{points:s,area:c,perimeter:u,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:RectangleRoi",finding:t,findingSites:n||[]}}}J.toolType="RectangleRoi",J.utilityToolType="RectangleRoi",J.TID300Representation=Q,J.isValidCornerstoneTrackingIdentifier=e=>{if(!e.includes(":"))return!1;const[t,n]=e.split(":");return t===N&&n===J.toolType},E.registerTool(J);var Z=n(3293),ee=n.n(Z);const{DicomMessage:te,DicomMetaDictionary:ne}=u.p,{Normalizer:ae}=u.z8;function re(e,t,n){const a=[];if(t){const t=e[0].data.byteArray.buffer,n=te.readFile(t),r=ne.naturalizeDataset(n.dict);r._meta=ne.namifyDataset(n.meta),a.push(r)}else for(let t=0;t<e.length;t++){const n=e[t].data.byteArray.buffer,r=te.readFile(n),i=ne.naturalizeDataset(r.dict);i._meta=ne.namifyDataset(r.meta),a.push(i)}return n?.SpecificCharacterSet&&a.forEach(e=>e.SpecificCharacterSet=n.SpecificCharacterSet),ae.normalizeToDataset(a)}const{rotateDirectionCosinesInPlane:ie,flipImageOrientationPatient:oe,flipMatrix2D:se,rotateMatrix902D:ce}=u.BF.orientation,{datasetToBlob:ue,BitArray:de,DicomMessage:le,DicomMetaDictionary:me}=u.BF,{Normalizer:ge}=u.z8,{Segmentation:pe}=u.h4,fe={generateSegmentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0};const{toolState:a,segments:r}=t,i=e[0],o={x:i.columns,y:i.rows,z:e.length};o.xy=o.x*o.y;if(!function(e,t){let n=0;for(let e=0;e<t.length;e++)t[e]&&n++;return n}(0,r))throw new Error("No segments to export!");const s=i.imageId.includes("?frame"),c=function(e,t,n){const a=re(e,t);return new pe([a],n)}(e,s,n),{referencedFramesPerSegment:u,segmentIndicies:d}=function(e,t,n){const a=[],r=[];for(let e=0;e<n.length;e++)n[e]&&(a.push(e),r.push([]));for(let n=0;n<t.length;n++){const i=e[t[n].imageId];for(let e=0;e<a.length;e++){const t=a[e];i&&i.brush&&i.brush.data&&i.brush.data[t]&&i.brush.data[t].pixelData&&r[e].push(n)}}return{referencedFramesPerSegment:r,segmentIndicies:a}}(a,e,r);let l=0;for(let e=0;e<u.length;e++)l+=u[e].length;c.setNumberOfFrames(l);for(let t=0;t<d.length;t++){const n=d[t],i=u[t],s=i.map(e=>e+1),l=r[n];c.addSegment(l,Ie(n,i,a,e,o),s)}c.bitPackPixelData();return ue(c.dataset)},generateToolState:function(e,t,n){const a=le.readFile(t),r=me.naturalizeDataset(a.dict);r._meta=me.namifyDataset(a.meta);const i=ge.normalizeToDataset([r]),o=n.get("imagePlaneModule",e[0]);o||console.warn("Insufficient metadata, imagePlaneModule missing.");const s=function(e){const t=[];t[0]=e,t[1]=oe.h(e),t[2]=oe.v(e);const n=ie(e,Math.PI/2);return t[3]=n,t[4]=oe.h(n),t[5]=oe.v(n),t[6]=ie(e,Math.PI),t[7]=ie(e,1.5*Math.PI),t}(Array.isArray(o.rowCosines)?[...o.rowCosines,...o.columnCosines]:[o.rowCosines.x,o.rowCosines.y,o.rowCosines.z,o.columnCosines.x,o.columnCosines.y,o.columnCosines.z]),c=i.SharedFunctionalGroupsSequence,d=c.PlaneOrientationSequence?c.PlaneOrientationSequence.ImageOrientationPatient:void 0,l=i.Columns*i.Rows,m=function(e){const t=[],n=e.SegmentSequence;if(Array.isArray(n))for(let e=0;e<n.length;e++)t.push(n[e]);else t.push(n);return{seriesInstanceUid:e.ReferencedSeriesSequence.SeriesInstanceUID,data:t}}(i),g=function(e){const t=e.SegmentationType;if("BINARY"===t)return de.unpack(e.PixelData);const n=new Uint8Array(e.PixelData),a=e.MaximumFractionalValue,r=void 0===n.find(e=>0!==e&&e!==a);if(!r)return void u.Rm.warn("This is a fractional segmentation, which is not currently supported.");return u.Rm.warn("This segmentation object is actually binary... processing as such."),n}(i),p=i.PerFrameFunctionalGroupsSequence,f={};let I=!0;for(let t=0;t<p.length;t++){const a=p[t],r=d||a.PlaneOrientationSequence.ImageOrientationPatient,o=Oe(ee()(new Uint8Array(g.buffer,t*l,l),[i.Rows,i.Columns]),r,s);if(!o){console.warn("This segmentation object is not in-plane with the source data. Bailing out of IO. It'd be better to render this with vtkjs. "),I=!1;break}const u=a.SegmentIdentificationSequence.ReferencedSegmentNumber-1;let m;m=c.DerivationImageSequence&&c.DerivationImageSequence.SourceImageSequence?c.DerivationImageSequence.SourceImageSequence[t]:a.DerivationImageSequence.SourceImageSequence;he(f,Se(m,e,n),u,o)}if(!I)return;return{toolState:f,segMetadata:m}}};function Ie(e,t,n,a,r){const i=new Uint8Array(r.xy*t.length);let o=0;for(let r=0;r<t.length;r++){const s=n[a[t[r]].imageId].brush.data[e].pixelData;for(let e=0;e<s.length;e++)i[o]=s[e],o++}return i}function he(e,t,n,a){e[t]?e[t].brush?e[t].brush.data||(e[t].brush.data=[]):(e[t].brush={},e[t].brush.data=[]):(e[t]={},e[t].brush={},e[t].brush.data=[]),e[t].brush.data[n]={};const r=e[t].brush.data[n];r.pixelData=new Uint8Array(a.data.length);const i=r.pixelData;for(let e=0;e<i.length;e++)a.data[e]?i[e]=1:i[e]=0}function Se(e,t,n){const{ReferencedSOPInstanceUID:a,ReferencedFrameNumber:r}=e;return r?function(e,t,n,a){const r=n.find(n=>{const r=a.get("sopCommonModule",n);if(!r)return;const i=Number(n.split("frame=")[1]);return r.sopInstanceUID===e&&i===t-1});return r}(a,r,t,n):function(e,t,n){return t.find(t=>{const a=n.get("sopCommonModule",t);if(a)return a.sopInstanceUID===e})}(a,t,n)}function Oe(e,t,n){return De(t,n[0])?e:De(t,n[1])?se.v(e):De(t,n[2])?se.h(e):De(t,n[3])?ce(e):De(t,n[4])?se.h(ce(e)):De(t,n[5])?se.v(ce(e)):De(t,n[6])?ce(ce(e)):De(t,n[7])?ce(ce(ce(e))):void 0}const Te=1e-5;function De(e,t){return Math.abs(e[0]-t[0])<Te&&Math.abs(e[1]-t[1])<Te&&Math.abs(e[2]-t[2])<Te&&Math.abs(e[3]-t[3])<Te&&Math.abs(e[4]-t[4])<Te&&Math.abs(e[5]-t[5])<Te}function Ce(e,t,n,a){const{SharedFunctionalGroupsSequence:r,PerFrameFunctionalGroupsSequence:i}=e,o=r.PlaneOrientationSequence?r.PlaneOrientationSequence.ImageOrientationPatient:void 0,s=i[0],c=o||s.PlaneOrientationSequence.ImageOrientationPatient;return t.some(e=>g.utilities.isEqual(c,e,a))?"Planar":function(e,t,n){const a=Math.abs(e[0]*t[0]+e[1]*t[1]+e[2]*t[2]),r=Math.abs(e[3]*t[3]+e[4]*t[4]+e[5]*t[5]);return(a<n||Math.abs(a-1)<n)&&(r<n||Math.abs(r-1)<n)}(c,t[0],a)&&n.includes(e.Rows)&&n.includes(e.Columns)?"Perpendicular":"Oblique"}var ye;!function(e){e.SEGMENTATION_LOAD_PROGRESS="CORNERSTONE_ADAPTER_SEGMENTATION_LOAD_PROGRESS"}(ye||(ye={}));const{rotateDirectionCosinesInPlane:Re,flipImageOrientationPatient:Ee,flipMatrix2D:Ne,rotateMatrix902D:Me}=u.BF.orientation,{BitArray:Ae,DicomMessage:Pe,DicomMetaDictionary:_e}=u.p,{Normalizer:ve}=u.z8,{Segmentation:xe}=u.h4,{encode:we,decode:be}=u.BF.compression,Ue={includeSliceSpacing:!0,rleEncode:!1};function Fe(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const a=Object.assign({},Ue,n),r=Array.isArray(t)?t:[t];let i=0;const o=[];for(let e=0;e<r.length;e++){const t=r[e],{labelmaps2D:n,metadata:a}=t,s=[];for(let e=1;e<a.length;e++)a[e]&&(s[e]=[]);for(let e=0;e<n.length;e++){const t=n[e];if(n[e]){const{segmentsOnLabelmap:n}=t;n.forEach(t=>{0!==t&&(s[t].push(e),i++)})}}o[e]=s}e.setNumberOfFrames(i);for(let t=0;t<r.length;t++){const n=o[t],a=r[t],{metadata:i}=a;for(let t=1;t<n.length;t++){const r=n[t];if(r){const n=r.map(e=>e+1),o=i[t],s=qe(a,r);e.addSegmentFromLabelmap(o,s,t,n)}}}if(a.rleEncode){const t=we(e.dataset.PixelData,i,e.dataset.Rows,e.dataset.Columns);e.assignToDataset({BitsAllocated:"8",BitsStored:"8",HighBit:"7",SegmentationType:"FRACTIONAL",SegmentationFractionalType:"PROBABILITY",MaximumFractionalValue:"255"}),e.dataset._meta.TransferSyntaxUID={Value:["1.2.840.10008.1.2.5"],vr:"UI"},e.dataset.SpecificCharacterSet="ISO_IR 192",e.dataset._vrMap.PixelData="OB",e.dataset.PixelData=t}else e.bitPackPixelData();return e}function qe(e,t){const{labelmaps2D:n}=e,a=[];for(let e=0;e<t.length;e++){const r=t[e];a.push(n[r].pixelData)}return a}function Ge(e,t,n,a,r,i){let o;if(!e)return o;const{FrameOfReferenceUID:s,PerFrameFunctionalGroupsSequence:c,SourceImageSequence:u,ReferencedSeriesSequence:d}=e;if(!c||0===c.length)return o;const l=c[t];if(!l)return o;let m;if(l.DerivationImageSequence){let e=l.DerivationImageSequence;Array.isArray(e)&&(e=0!==e.length?e[0]:void 0),e&&(m=e.SourceImageSequence,Array.isArray(m)&&(m=0!==m.length?m[0]:void 0))}else u&&0!==u.length&&(console.warn("DerivationImageSequence not present, using SourceImageSequence assuming SEG has the same geometry as the source image."),m=u[t]);if(m&&(o=function(e,t){const{ReferencedSOPInstanceUID:n,ReferencedFrameNumber:a}=e,r=t[n];if(!r)return void console.warn(`No imageId found for SOPInstanceUID: ${n}`);if(void 0!==a)return r.includes("frames/")?r.replace(/frames\/\d+/,`frames/${a}`):r.includes("dicomfile:")?r.replace(/frame=\d+/,`frame=${a}`):r.includes("frame=")?r.replace(/frame=\d+/,"frame="+(a-1)):r.includes("wadors:")?`${r}/frames/${a}`:`${r}?frame=${a-1}`;return r}(m,i)),void 0===o&&d){o=function(e,t,n,a,r,i){if(!e||!n.PlanePositionSequence?.[0]?.ImagePositionPatient)return;const o=n.PlanePositionSequence[0].ImagePositionPatient;for(let n of a){const a=r.get("instance",n);if(!a)continue;const s=$e(a);if(a.ImagePositionPatient&&a.FrameOfReferenceUID===t&&a.SeriesInstanceUID===e)if(s){const e=r.get("imagePlaneModule",n)?.imagePositionPatient;if(e&&g.utilities.isEqual(o,e,i))return n}else if(g.utilities.isEqual(o,a.ImagePositionPatient,i))return n}return}((Array.isArray(d)?d[0]:d).SeriesInstanceUID,s,l,n,a,r)}return o}function Ve(e,t,n,a,r,i,o,s,c,u,d,l){const{SharedFunctionalGroupsSequence:m,PerFrameFunctionalGroupsSequence:g,Rows:p,Columns:f}=r,I=m.PlaneOrientationSequence?m.PlaneOrientationSequence.ImageOrientationPatient:void 0,h=f*p,S=h*i.length*u.BYTES_PER_ELEMENT;let O=1,T=0,D=n[T].slice(0),C=structuredClone(t[T]),y=r.SegmentSequence.length;for(let d=1;d<=y;++d){for(let m=0,y=g.length;m<y;++m){const y=g[m],R=Le(r,m);if(void 0===R)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");if(R!==d)continue;const E=I||y.PlaneOrientationSequence.ImageOrientationPatient,N=Ye(a,m*h,h),M=He(ee()(N,[p,f]),E,o,c);if(!M)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");const A=Ge(r,m,i,s,c,l);if(!A){console.warn("Image not present in stack, can't import frame : "+m+".");continue}const P=s.get("instance",A);if(p!==P.Rows||f!==P.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");const _=i.findIndex(e=>e===A),v=new u(D,h*_*u.BYTES_PER_ELEMENT,h),x=M.data;let w=!1;for(let e=0,a=M.data.length;e<a;++e)if(x[e]){if(0!==v[e]){T++,T>=O&&(n[T]=new ArrayBuffer(S),t[T]=[],O++),D=n[T].slice(0),C=structuredClone(t[T]),m=0;break}v[e]=R,w=!0}w&&(C[_]||(C[_]=[]),C[_].push(R),e[_]||(e[_]=[]),e[_].push(R))}n[T]=D.slice(0),t[T]=structuredClone(C),T=0,D=n[T].slice(0),C=structuredClone(t[T])}}const Le=(e,t)=>{const{PerFrameFunctionalGroupsSequence:n,SharedFunctionalGroupsSequence:a}=e,r=n[t];return r&&r.SegmentIdentificationSequence?r.SegmentIdentificationSequence.ReferencedSegmentNumber:a.SegmentIdentificationSequence?a.SegmentIdentificationSequence.ReferencedSegmentNumber:void 0};function Be(e,t,n,a,r,i,o,s,c,u,d,l,m,g,p){const{SharedFunctionalGroupsSequence:f,PerFrameFunctionalGroupsSequence:I,Rows:h,Columns:S}=r,O=f.PlaneOrientationSequence?f.PlaneOrientationSequence.ImageOrientationPatient:void 0,T=S*h;let D=0;const C=I.length,y=Math.ceil(C/10),R=p&&g;let E=!1;return new Promise(t=>{!function f(){for(let t=Math.min(D+y,C);D<t;++D){const t=I[D],g=O||t.PlaneOrientationSequence.ImageOrientationPatient,p=Ye(a,D*T,T),f=He(ee()(p,[h,S]),g,o,c);if(!f)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");const C=Le(r,D);if(void 0===C)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");d.has(C)||d.set(C,{});const y=Ge(r,D,i,s,c,l);if(!y){console.warn("Image not present in stack, can't import frame : "+D+".");continue}const R=m.metadata[y];if(h!==R.Rows||S!==R.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");const N=m.indices[y],M=T*N*u.BYTES_PER_ELEMENT,A=new u(n[0],M,T),P=f.data,_=[];for(let t=0,n=f.data.length;t<n;++t)if(P[t]){for(let e=t;e<n;++e)P[e]&&(E||0===A[e]||(E=!0),A[e]=C,_.push(e));e[N]||(e[N]=[]),e[N].push(C);break}const v=d.get(C);v[N]=_,d.set(C,v)}if(R){const e=Math.round(D/C*100);p(g,ye.SEGMENTATION_LOAD_PROGRESS,{percentComplete:e})}D<C?setTimeout(f,0):t(E)}()})}function ke(e,t){const n=e.SegmentationType;let a;if(a=Array.isArray(e.PixelData)?e.PixelData[0]:e.PixelData,void 0===a&&u.Rm.error("This segmentation pixelData is undefined."),"BINARY"===n)return function(e,t){for(var n=new Uint8Array(e),a=[],r=8*t,i=Math.ceil(8*n.length/r),o=0;o<i;o++){var s=o*r,c=Math.min(s+r,8*n.length),u=Math.floor(s/8),d=Math.ceil(c/8),l=n.slice(u,d),m=Ae.unpack(l);a.push(m)}return a}(a,t.maxBytesPerChunk);if("LABELMAP"===n)return 8===e.BitsStored?new Uint8Array(a):16===e.BitsStored?new Uint16Array(a):new Uint8Array(a);const r=new Uint8Array(a),i=e.MaximumFractionalValue;return void 0===r.find(e=>0!==e&&e!==i)?(u.Rm.warn("This segmentation object is actually binary... processing as such."),r):void 0}function $e(e){return e&&e.NumberOfFrames>1}function je(e){const t=[];t[0]=e,t[1]=Ee.h(e),t[2]=Ee.v(e);const n=Re(e,Math.PI/2);return t[3]=n,t[4]=Ee.h(n),t[5]=Ee.v(n),t[6]=Re(e,Math.PI),t[7]=Re(e,1.5*Math.PI),t}function He(e,t,n,a){return g.utilities.isEqual(t,n[0],a)?e:g.utilities.isEqual(t,n[1],a)?Ne.v(e):g.utilities.isEqual(t,n[2],a)?Ne.h(e):g.utilities.isEqual(t,n[3],a)?Me(e):g.utilities.isEqual(t,n[4],a)?Me(Ne.h(e)):g.utilities.isEqual(t,n[5],a)?Me(Ne.v(e)):g.utilities.isEqual(t,n[6],a)?Me(Me(e)):g.utilities.isEqual(t,n[7],a)?Me(Me(Me(e))):void 0}function ze(e,t){const n=e.SegmentSequence;let a=[];return a=Array.isArray(n)?[void 0,...n]:[void 0,n],{seriesInstanceUid:t,data:a}}function Ye(e,t,n){const a=function(e,t,n){var a=e.reduce((e,t)=>e+t.length,0);if(t<0||t+n>a)throw new Error("Offset and length out of bounds");var r=0,i=t;for(;i>=e[r].length;)i-=e[r].length,r++;var o=r,s=i+n;for(;s>e[o].length;)s-=e[o].length,o++;return{start:{chunkIndex:r,offset:i},end:{chunkIndex:o,offset:s}}}(e,t,n);if(a.start.chunkIndex===a.end.chunkIndex)return new Uint8Array(e[a.start.chunkIndex].buffer,a.start.offset,n);{let t=new Uint8Array(n),r=0;for(let n=a.start.chunkIndex;n<=a.end.chunkIndex;n++){let i=n===a.start.chunkIndex?a.start.offset:0,o=n===a.end.chunkIndex?a.end.offset:e[n].length;t.set(new Uint8Array(e[n].buffer,i,o-i),r),r+=o-i}return t}}function We(e,t,n,a){let r=0,i=0,o=0,s=0,c=0,u=0,d=0;for(const[l,m]of Object.entries(e)){const e=Number(l);if(!m||0===m.length)continue;const g=a[e],p=n.get("imagePlaneModule",g);if(!p){console.debug("Missing imagePlaneModule metadata for centroid calculation");continue}const{imagePositionPatient:f,rowCosines:I,columnCosines:h,rowPixelSpacing:S,columnPixelSpacing:O}=p;for(const n of m){const a=Math.floor(n/t.Rows),l=n%t.Rows;r+=l,i+=a,o+=e;s+=f[0]+l*I[0]*O+a*h[0]*S,c+=f[1]+l*I[1]*O+a*h[1]*S,u+=f[2]+l*I[2]*O+a*h[2]*S,d++}}return{image:{x:Math.floor(r/d),y:Math.floor(i/d),z:Math.floor(o/d)},world:{x:s/d,y:c/d,z:u/d},count:d}}const Ke={generateSegmentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return Fe(function(e,t,n){const a=re(e,t);return new xe([a],n)}(e,$e(e[0]),n),t,n)},generateToolState:async function(e,t,n,a){const{skipOverlapping:r=!1,tolerance:i=.001,TypedArrayConstructor:o=Uint8Array,maxBytesPerChunk:s=199e6,eventTarget:c=null,triggerEvent:u=null}=a,d=Pe.readFile(t),l=_e.naturalizeDataset(d.dict);l._meta=_e.namifyDataset(d.meta);const m=ve.normalizeToDataset([l]),g=n.get("imagePlaneModule",e[0]),p=n.get("generalSeriesModule",e[0]).seriesInstanceUID;g||console.warn("Insufficient metadata, imagePlaneModule missing.");const f=je(Array.isArray(g.rowCosines)?[...g.rowCosines,...g.columnCosines]:[g.rowCosines.x,g.rowCosines.y,g.rowCosines.z,g.columnCosines.x,g.columnCosines.y,g.columnCosines.z]),I=m.Columns*m.Rows,h=ze(m,p);let S,O;if("1.2.840.10008.1.2.5"===m._meta.TransferSyntaxUID.Value[0]){const e=Array.isArray(m.PixelData)?m.PixelData:[m.PixelData];if(S=be(e,m.Rows,m.Columns),1===m.BitsStored)return void console.warn("No implementation for rle + bitbacking.");O=[S]}else if(O=ke(m,{maxBytesPerChunk:s}),!O)throw new Error("Fractional segmentations are not yet supported");const T=Ce(m,f,[g.rows,g.columns,e.length],i),D=e.reduce((e,t)=>{const{sopInstanceUID:a}=n.get("generalImageModule",t);return e[a]=t,e},{});let C,y=!1;switch(r||(y=function(e,t,n,a,r,i,o,s){const{SharedFunctionalGroupsSequence:c,PerFrameFunctionalGroupsSequence:u,SegmentSequence:d,Rows:l,Columns:m}=t;if(d.length<2)return!1;const g=c.PlaneOrientationSequence?c.PlaneOrientationSequence.ImageOrientationPatient:void 0,p=m*l,f=u.length;let I=new Map;for(let e=0;e<f;++e){if(void 0===Le(t,e)){console.warn("Could not retrieve the segment index for frame segment "+e+", skipping this frame.");continue}const a=Ge(t,e,n,r,i,s);if(!a){console.warn("Image not present in stack, can't import frame : "+e+".");continue}const o=n.findIndex(e=>e===a);if(I.has(o)){let t=I.get(o);t.includes(e)||(t.push(e),I.set(o,t))}else I.set(o,[e])}for(let[,t]of I.entries()){let n=new o(p).fill(0);for(let r=0;r<t.length;++r){const o=t[r],s=u[o],c=g||s.PlaneOrientationSequence.ImageOrientationPatient,d=Ye(e,o*p,p),f=He(ee()(d,[l,m]),c,a,i);if(!f){console.warn("Individual SEG frames are out of plane with respect to the first SEG frame, this is not yet supported, skipping this frame.");continue}const I=f.data;for(let e=0,t=I.length;e<t;++e)if(0!==I[e]&&(n[e]++,n[e]>1))return!0}}return!1}(O,m,e,f,n,i,o,D)),T){case"Planar":C=y?Ve:Be;break;case"Perpendicular":throw new Error("Segmentations orthogonal to the acquisition plane of the source data are not yet supported.");case"Oblique":throw new Error("Segmentations oblique to the acquisition plane of the source data are not yet supported.")}const R=[];R[0]=[];const E=[],N=I*e.length*o.BYTES_PER_ELEMENT,M=[];M[0]=new ArrayBuffer(N);const A=e.reduce((e,t,a)=>(e.indices[t]=a,e.metadata[t]=n.get("instance",t),e),{indices:{},metadata:{}}),P=new Map,_=await C(E,R,M,O,m,e,f,n,i,o,P,D,A,c,u),v=new Map;return P.forEach((t,a)=>{const r=We(t,m,n,e);v.set(a,r)}),{labelmapBufferArray:M,segMetadata:h,segmentsOnFrame:E,segmentsOnFrameArray:R,centroids:v,overlappingSegments:_}},fillSegmentation:Fe};function Xe(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;return 4===a?Ke.generateSegmentation(e,t,n):3===a?fe.generateSegmentation(e,t,n):void console.warn(`No generateSegmentation adapter for cornerstone version ${a}, exiting.`)}function Qe(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4;return 4===i?Ke.generateToolState(e,t,n,a,r):3===i?fe.generateToolState(e,t,n):void console.warn(`No generateToolState adapter for cornerstone version ${i}, exiting.`)}function Je(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;if(4===a)return Ke.fillSegmentation(e,t,n);console.warn(`No generateSegmentation adapter for cornerstone version ${a}, exiting.`)}const{DicomMessage:Ze,DicomMetaDictionary:et}=u.p,{Normalizer:tt}=u.z8;function nt(e,t,n,a,r,i){let o;if(!e)return o;const{FrameOfReferenceUID:s,PerFrameFunctionalGroupsSequence:c,SourceImageSequence:u,ReferencedSeriesSequence:d}=e;if(!c||0===c.length)return o;const l=c[t];if(!l)return o;let m;if(l.DerivationImageSequence){let e=l.DerivationImageSequence;Array.isArray(e)&&(e=0!==e.length?e[0]:void 0),e&&(m=e.SourceImageSequence,Array.isArray(m)&&(m=0!==m.length?m[0]:void 0))}else u&&0!==u.length&&(console.warn("DerivationImageSequence not present, using SourceImageSequence assuming SEG has the same geometry as the source image."),m=u[t]);if(m&&(o=function(e,t){const{ReferencedSOPInstanceUID:n,ReferencedFrameNumber:a}=e;return a?function(e,t,n){const a=n[e];if(!a)return;const r=Number(a.split("frame=")[1]);return r===t-1?a:void 0}(n,a,t):t[n]}(m,i)),void 0===o&&d){o=function(e,t,n,a,r,i){if(void 0===e||void 0===n.PlanePositionSequence||void 0===n.PlanePositionSequence[0]||void 0===n.PlanePositionSequence[0].ImagePositionPatient)return;for(let o=0;o<a.length;++o){const s=r.get("instance",a[o]);if(void 0!==s&&void 0!==s.ImagePositionPatient&&s.FrameOfReferenceUID===t&&s.SeriesInstanceUID===e&&g.utilities.isEqual(n.PlanePositionSequence[0].ImagePositionPatient,s.ImagePositionPatient,i))return a[o]}}((Array.isArray(d)?d[0]:d).SeriesInstanceUID,s,l,n,a,r)}return o}const at={Length:P,FreehandRoi:v,Bidirectional:b,EllipticalRoi:q,CircleRoi:L,ArrowAnnotate:j,MeasurementReport:E,CobbAngle:Y,Angle:X,RectangleRoi:J},rt={Segmentation:a},it={ParametricMap:{generateToolState:async function(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.001;const r=Ze.readFile(t),i=et.naturalizeDataset(r.dict);i._meta=et.namifyDataset(r.meta);const o=tt.normalizeToDataset([i]),s=n.get("imagePlaneModule",e[0]);s||console.warn("Insufficient metadata, imagePlaneModule missing.");const c=[Array.isArray(s.rowCosines)?[...s.rowCosines,...s.columnCosines]:[s.rowCosines.x,s.rowCosines.y,s.rowCosines.z,s.columnCosines.x,s.columnCosines.y,s.columnCosines.z]],d=function(e){let t,n;if(e.PixelData){t=(16===e.BitsAllocated?[Uint16Array,Int16Array]:[Uint32Array,Int32Array])[e.PixelRepresentation??0],n=e.PixelData}else e.FloatPixelData?(t=Float32Array,n=e.FloatPixelData):e.DoubleFloatPixelData&&(t=Float64Array,n=e.DoubleFloatPixelData);void 0===n&&u.Rm.error("This parametric map pixel data is undefined.");Array.isArray(n)&&(n=n[0]);return new t(n)}(o),l=Ce(o,c,[s.rows,s.columns,e.length],a),m=e.reduce((e,t)=>{const{sopInstanceUID:a}=n.get("generalImageModule",t);return e[a]=t,e},{});if("Planar"!==l){throw new Error(`Parametric maps ${{Perpendicular:"orthogonal",Oblique:"oblique"}[l]} to the acquisition plane of the source data are not yet supported.`)}const g=e.reduce((e,t,a)=>(e.indices[t]=a,e.metadata[t]=n.get("instance",t),e),{indices:{},metadata:{}});return await function(e,t,n,a,r,i,o){const s=new e.constructor(e.length),{PerFrameFunctionalGroupsSequence:c,Rows:u,Columns:d}=t,l=d*u,m=c.length;for(let c=0;c<m;c++){const m=new e.constructor(e.buffer,c*l,l),g=nt(t,c,n,a,r,i);if(!g){console.warn("Image not present in stack, can't import frame : "+c+".");continue}const p=o.metadata[g];if(u!==p.Rows||d!==p.Columns)throw new Error("Parametric map have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported.");const f=l*o.indices[g]*s.BYTES_PER_ELEMENT;new s.constructor(s.buffer,f,l).set(m)}return s}(d,o,e,n,a,m,g),{pixelData:d}}}};var ot="Cornerstone3DTools@^0.1.0";const st=["PatientName","PatientID","PatientBirthDate","PatientBirthTime","PatientID","IssuerOfPatientID","OtherPatientIDs","OtherPatientIDsSequence","PatientSex","PatientIdentityRemoved","DeidentificationMethodCodeSequence","StudyDate","StudyTime","StudyStatusID","StudyPriorityID","StudyInstanceUID","StudyDescription","AccessionNumber","StudyID","ReferringPhysicianName","BodyPartExamined","TimezoneOffsetFromUTC"];const ct=["SeriesInstanceUID","SeriesNumber","SeriesDescription","Modality","SeriesDate","SeriesTime"];function ut(e){const t={_meta:e._meta,_vrMap:e._vrMap};for(const n of ct){const a=e[n];void 0!==a&&(t[n]=a)}return t}const{imageToWorldCoords:dt}=g.utilities;function lt(e,t){let{is3DMeasurement:n,referencedImageId:a}=e;const r=[];if(n){const{GraphicData:e}=t;for(let t=0;t<e.length;t+=3){const n=[e[t],e[t+1],e[t+2]];r.push(n)}}else{const{GraphicData:e}=t;for(let t=0;t<e.length;t+=2){const n=dt(a,[e[t],e[t+1]]);r.push(n)}}return r}const mt={CodingSchemeDesignator:"CORNERSTONEJS",codeValues:{CORNERSTONEFREETEXT:"CORNERSTONEFREETEXT"}},gt="none",pt={schemeDesignator:"99CS3D",meaning:"Text Annotation Position",value:"TextPosition"},ft={schemeDesignator:"DCM",meaning:"Comment",value:"121106"},{worldToImageCoords:It}=g.utilities;let ht=It;function St(e,t){let{is3DMeasurement:n,referencedImageId:a}=e;if(n)return{x:t[0],y:t[1],z:t[2]};const r=ht(a,t);return{x:r[0],y:r[1]}}function Ot(e,t){return t.map(t=>St(e,t))}const{sr:{valueTypes:Tt,coding:Dt}}=u.Ay;class Ct{constructor(e,t){this.tid300Item=e,this.annotation=t,this.ReferencedSOPSequence=e.ReferencedSOPSequence}contentItem(){const e=this.tid300Item.contentItem(),{label:t,handles:n}=this.annotation.data;return t&&(e.push(this.createQualitativeLabel(t)),this.filterCornerstoneFreeText(e)),n?.textBox?.hasMoved&&e.push(this.createQualitativeLabelPosition(this.annotation)),e}filterCornerstoneFreeText(e){for(let t=0;t<e.length;t++){const n=e[t];if(!n.ConceptCodeSequence)continue;const a=n.ConceptCodeSequence.find(e=>"CORNERSTONEFREETEXT"===e.CodeValue);if(-1!==a)return n.ConceptCodeSequence.splice(a,1),void(0===n.ConceptCodeSequence.length&&e.splice(t,1))}}createQualitativeLabel(e){const t=Tt.RelationshipTypes.CONTAINS;return new Tt.TextContentItem({name:new Dt.CodedConcept(ft),relationshipType:t,value:e})}createQualitativeLabelPosition(e){const{textBox:t}=e.data.handles,{referencedImageId:n,FrameOfReferenceUID:a}=e.metadata,r=!n,{worldPosition:i}=t,{x:o,y:s,z:c}=St({is3DMeasurement:r,referencedImageId:n},i),u=Tt.GraphicTypes.POINT,d=Tt.RelationshipTypes.CONTAINS,l=new Dt.CodedConcept(pt);if(r){const e=[o,s,c];return new Tt.Scoord3DContentItem({name:l,relationshipType:d,graphicType:u,frameOfReferenceUID:a,graphicData:e})}const m=[o,s];return new Tt.ScoordContentItem({name:l,relationshipType:d,graphicType:u,graphicData:m})}}var yt;const{TID1500:Rt,addAccessors:Et}=u.BF,{StructuredReport:Nt}=u.h4,{Normalizer:Mt}=u.z8,{TID1500MeasurementReport:At,TID1501MeasurementGroup:Pt}=Rt,{DicomMetaDictionary:_t}=u.p,vt={CodingSchemeDesignator:"DCM",CodeValue:"121071"},xt={CodingSchemeDesignator:ft.schemeDesignator,CodeValue:ft.value},wt={CodingSchemeDesignator:pt.schemeDesignator,CodeValue:pt.value},bt={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},Ut={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"};class Ft{static getTID300ContentItem(e,t,n,a){const r=n.getTID300RepresentationArguments(e,a);r.ReferencedSOPSequence=t,r.use3DSpatialCoordinates&&(r.ReferencedFrameOfReferenceUID=e.metadata.FrameOfReferenceUID);const i=new n.TID300Representation(r);return new Ct(i,e)}static getMeasurementGroup(e,t,n,a){const r=t[e],i=this.measurementAdapterByToolType.get(e);if(!(r&&r.data&&r.data.length&&i))return;const o=r.data.map(e=>this.getTID300ContentItem(e,n,i,a));return new Pt(o)}static getCornerstoneLabelFromDefaultState(e){const{findingSites:t=[],finding:n,commentGroup:a}=e;if(a?.TextValue)return a.TextValue;const r=mt.codeValues.CORNERSTONEFREETEXT,i=t.find(e=>e.CodeValue===r);return i?i.CodeMeaning:n&&n.CodeValue===r?n.CodeMeaning:void 0}static generateDatasetMeta(){const e=new Uint8Array(2);e[1]=1;return{FileMetaInformationVersion:{Value:[e.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[_t.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}}}static processSCOORDGroup(e){let{SCOORDGroup:t,toolType:n,sopInstanceUIDToImageIdMap:a,metadata:r}=e;const{ReferencedSOPSequence:i}=t.ContentSequence,{ReferencedSOPInstanceUID:o,ReferencedFrameNumber:s=1}=i,c=a[`${o}:${s}`],u=r.get("imagePlaneModule",c),d=_t.uid();return{SCOORDGroup:t,ReferencedSOPSequence:i,ReferencedSOPInstanceUID:o,ReferencedFrameNumber:s,referencedImageId:c,state:{description:void 0,sopInstanceUid:o,annotation:{data:{annotationUID:d,cachedStats:{},handles:{activeHandleIndex:0,textBox:{hasMoved:!1}}},annotationUID:d,metadata:{toolName:n,referencedImageId:c,FrameOfReferenceUID:u.frameOfReferenceUID}}}}}static processSCOORD3DGroup(e){let{SCOORD3DGroup:t,toolType:n}=e;const a=_t.uid(),r={SCOORD3DGroup:t,FrameOfReferenceUID:t.ReferencedFrameOfReferenceUID,state:{description:void 0,annotation:{annotationUID:a,data:{annotationUID:a,cachedStats:{},handles:{activeHandleIndex:0,textBox:{hasMoved:!1}}},metadata:{toolName:n,FrameOfReferenceUID:t.ReferencedFrameOfReferenceUID}}}};return g.utilities.updatePlaneRestriction(function(e){const t=[];if(!e?.length)return t;const{length:n}=e;if(n%3!=0)throw new Error(`Points array should be divisible by 3 for SCOORD3D, but contents are: ${JSON.stringify(e)} of length ${n}`);for(let a=0;a<n;a+=3)t.push([e[a],e[a+1],e[a+2]]);return t}(t.GraphicData),r.state.annotation.metadata),r}static getSpatialCoordinatesState(e){let{NUMGroup:t,sopInstanceUIDToImageIdMap:n,metadata:a,toolType:r}=e;const i=d(t.ContentSequence),o=i.find(e=>"SCOORD"===e.ValueType),s=i.find(e=>"SCOORD3D"===e.ValueType),c=s&&this.processSCOORD3DGroup({SCOORD3DGroup:s,toolType:r})||o&&this.processSCOORDGroup({SCOORDGroup:o,toolType:r,metadata:a,sopInstanceUIDToImageIdMap:n});if(!c)throw new Error("No spatial coordinates group found.");return c}static processSpatialCoordinatesGroup(e){let{NUMGroup:t,sopInstanceUIDToImageIdMap:n,metadata:a,findingGroup:r,findingSiteGroups:i,commentGroup:o,commentPositionGroup:s,toolType:c}=e;const{state:u,SCOORDGroup:d,ReferencedSOPSequence:l,ReferencedSOPInstanceUID:m,ReferencedFrameNumber:g,SCOORD3DGroup:p,FrameOfReferenceUID:f,referencedImageId:I,textBoxPosition:h}=this.getSpatialCoordinatesState({NUMGroup:t,sopInstanceUIDToImageIdMap:n,metadata:a,toolType:c}),S=r?Et(r.ConceptCodeSequence):void 0,O=i.map(e=>Et(e.ConceptCodeSequence));if(s){u.commentPositionGroup=s;const e=lt({is3DMeasurement:!I,referencedImageId:I},s);u.annotation.data.handles.textBox={hasMoved:!0,worldPosition:e[0]}}return u.finding=S,u.findingSites=O,u.commentGroup=o,u.commentPositionGroup=s,S&&(u.description=S.CodeMeaning),u.annotation.data.label=this.getCornerstoneLabelFromDefaultState(u),{defaultState:u,state:u,NUMGroup:t,scoord:p||d,SCOORDGroup:d,ReferencedSOPSequence:l,ReferencedSOPInstanceUID:m,referencedImageId:I,textBoxPosition:h,ReferencedFrameNumber:g,SCOORD3DGroup:p,FrameOfReferenceUID:f}}static getSetupMeasurementData(e,t,n,a){const{ContentSequence:r}=e,i=d(r),o=i.find(e=>this.codeValueMatch(e,vt)),s=i.find(e=>this.codeValueMatch(e,xt)),c=i.find(e=>this.codeValueMatch(e,wt)),u=i.filter(e=>this.codeValueMatch(e,bt,Ut))||[],l=i.find(e=>"NUM"===e.ValueType)||{ContentSequence:i.filter(e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType)},m=this.processSpatialCoordinatesGroup({NUMGroup:l,sopInstanceUIDToImageIdMap:t,metadata:n,findingGroup:o,findingSiteGroups:u,commentGroup:s,commentPositionGroup:c,toolType:a}),{referencedImageId:g}=m.state.annotation.metadata,p=!!m.SCOORD3DGroup,f={referencedImageId:g,is3DMeasurement:p},I=m.SCOORD3DGroup||m.SCOORDGroup,h=lt(f,I);return{...m,is3DMeasurement:p,scoordArgs:f,scoord:I,worldCoords:h}}static generateReferencedSOPSequence(e){let{toolData:t,toolTypes:n,metadataProvider:a,imageId:r,sopInstanceUIDsToSeriesInstanceUIDMap:i,derivationSourceDatasets:o}=e;const s=r===gt?this.getImageIdFromVolume({toolData:t,toolTypes:n}):r,c=a.get("sopCommonModule",s),u=a.get("instance",s),{sopInstanceUID:d,sopClassUID:l}=c,{SeriesInstanceUID:m}=u;if(i[d]=m,!o.find(e=>e.SeriesInstanceUID===m)){const e=Ft.generateDerivationSourceDataset(u);o.push(e)}const g=a.get("frameNumber",s),p={ReferencedSOPClassUID:l,ReferencedSOPInstanceUID:d,ReferencedFrameNumber:void 0};return(u&&u.NumberOfFrames&&u.NumberOfFrames>1||Mt.isMultiframeSOPClassUID(l))&&(p.ReferencedFrameNumber=g),p}static getImageIdFromVolume(e){let{toolData:t,toolTypes:n}=e;const a=t?.[n?.[0]]?.data?.[0],r=a?.metadata?.volumeId,i=g.cache.getVolume(r);if(!i)throw new Error(`No volume found for ${r}`);return i.imageIds[0]}static generateReport(e,t,n){let a=[];const r={},i=[],o=Ft.generateDatasetMeta();let s=!1;Object.keys(e).forEach(n=>{const o=e[n],c=Object.keys(o),u=n===gt,d=this.generateReferencedSOPSequence({toolData:o,toolTypes:c,metadataProvider:t,imageId:n,sopInstanceUIDsToSeriesInstanceUIDMap:r,derivationSourceDatasets:i});u&&(s=!0);const l=[];c.forEach(e=>{const t=this.getMeasurementGroup(e,o,d,u);t&&l.push(t)}),a=a.concat(l)});const c=new At({TID1501MeasurementGroups:a},n),u=new Nt(i,n),d=c.contentItem(i,{...n,sopInstanceUIDsToSeriesInstanceUIDMap:r});if(u.dataset=Object.assign(u.dataset,d),u.dataset._meta=o,u.SpecificCharacterSet="ISO_IR 192",s&&(u.dataset.SOPClassUID=_t.sopClassUIDsByName.Comprehensive3DSR,!u.dataset.SOPClassUID))throw new Error(`NO sop class defined for Comprehensive3DSR in ${JSON.stringify(_t.sopClassUIDsByName)}`);return u}static generateToolState(e,t,n,a){if("1500"!==e.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");const r=d(e.ContentSequence).find(l("Imaging Measurements")),i=d(r.ContentSequence).filter(l("Measurement Group")),o={};return i.forEach(r=>{try{const i=d(r.ContentSequence),s=i.find(e=>"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning),{TextValue:c}=s,u=i.find(e=>"Tracking Unique Identifier"===e.ConceptNameCodeSequence.CodeMeaning),l=u?.UID,m=a?.getToolClass?.(r,e,this.measurementAdapterByToolType)||this.getAdapterForTrackingIdentifier(c)||this.getAdapterForCodeType(r);if(m){const e=m.getMeasurementData(r,t,n,c);e.TrackingUniqueIdentifier=l,console.log(`=== ${m.toolType} ===`),console.log(e),o[m.toolType]||=[],o[m.toolType].push(e)}}catch(e){console.warn("Unable to generate tool state for",r,e)}}),o}static registerTool(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=e.toolType;if(this.measurementAdapterByToolType.has(n)){if(!t)throw new Error(`The registered tool name ${n} already exists in adapters, use a different toolType or use replace`);"function"==typeof t&&t(this.measurementAdapterByToolType.get(n))}this.measurementAdapterByToolType.set(e.toolType,e),this.measurementAdapterByTrackingIdentifier.set(e.trackingIdentifierTextValue,e)}static registerTrackingIdentifier(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];for(const t of n)this.measurementAdapterByTrackingIdentifier.set(t,e)}static getAdapterForTrackingIdentifier(e){const t=this.measurementAdapterByTrackingIdentifier.get(e);if(t)return t;for(const t of[...this.measurementAdapterByToolType.values()])if(t.isValidCornerstoneTrackingIdentifier(e))return this.measurementAdapterByTrackingIdentifier.set(e,t),t}static getAdapterForCodeType(e){for(const t of this.measurementAdapterByTrackingIdentifier.values())if(t.isValidMeasurement(e))return t}static registerAdapterTypes(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];for(const t of n){this.measurementAdaptersByType.has(t)||this.measurementAdaptersByType.set(t,[]);const n=this.measurementAdaptersByType.get(t);-1===n.indexOf(e)&&n.push(e)}}static getAdaptersForTypes(e,t,n){const a=[];return qt(a,this.measurementAdaptersByType.get(`${e}-${t}-${n}`)),qt(a,this.measurementAdaptersByType.get(`${e}-${t}`)),qt(a,this.measurementAdaptersByType.get(e)),qt(a,this.measurementAdaptersByType.get(t)),a}}function qt(e,t){t?.length&&e.push(...t)}(yt=Ft).CORNERSTONE_3D_TAG=ot,yt.measurementAdapterByToolType=new Map,yt.measurementAdaptersByType=new Map,yt.measurementAdapterByTrackingIdentifier=new Map,yt.codeValueMatch=(e,t,n)=>{const{ConceptNameCodeSequence:a}=e;if(!a)return;const{CodingSchemeDesignator:r,CodeValue:i}=a;return r==t.CodingSchemeDesignator&&i==t.CodeValue||n&&r==n.CodingSchemeDesignator&&i==n.CodeValue},yt.generateDerivationSourceDataset=e=>({...function(e){const t={_meta:e._meta,_vrMap:e._vrMap};for(const n of st){const a=e[n];void 0!==a&&(t[n]=a)}return t}(e),...ut(e)});class Gt{static registerType(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";e&&(n=`${n}${n.length?"-":""}${e}`),t&&(n=`${n}${n.length?"-":""}${t}`),Ft.registerAdapterTypes(this,n)}static getPointsCount(e){const t="SCOORD3D"===e.ValueType?3:2;return e.GraphicData.length/t}static getGraphicItems(e,t){const n=e.ContentSequence.filter(e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType);return t?n.filter(t):n}static getGraphicItem(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.getGraphicItems(e,n&&(e=>e.ValueType===n))[t]}static getGraphicCode(e){const{ConceptNameCodeSequence:t}=e,{CodeValue:n,CodingSchemeDesignator:a}=t;return`${a}:${n}`}static getGraphicType(e){return e.GraphicType}static isValidMeasurement(e){return!1}static init(e,t,n){if(this.toolType=e,Gt.toolType)throw new Error(`Base adapter tool type set to ${this.toolType} while setting ${e}`);if(this.parentType=n?.parentType,this.trackingIdentifiers=new Set,this.TID300Representation=t,this.parentType){this.trackingIdentifierTextValue=`${ot}:${this.parentType}:${this.toolType}`;const e=`${ot}:${this.toolType}`;this.trackingIdentifiers.add(e)}else this.trackingIdentifierTextValue=`${ot}:${e}`;this.trackingIdentifiers.add(this.trackingIdentifierTextValue),Ft.registerTool(this)}static registerLegacy(){this.trackingIdentifiers.add(`cornerstoneTools@^4.0.0:${this.toolType}`)}static registerSubType(e,t,n){const a=Object.create(e);return a.init(t,e.TID300Representation,{parentType:e.parentType||e.toolType,replace:n}),a}static isValidCornerstoneTrackingIdentifier(e){return!!this.trackingIdentifiers.has(e)||!!e.includes(":")&&e.startsWith(this.trackingIdentifierTextValue)}static getMeasurementData(e,t,n,a){const{defaultState:r,ReferencedFrameNumber:i}=Ft.getSetupMeasurementData(e,t,n,this.toolType);return r.annotation.data={cachedStats:{},frameNumber:i,seriesLevel:a?.indexOf(":Series")>0},r}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{metadata:n}=e,{finding:a,findingSites:r}=e,{referencedImageId:i}=n;return{points:Ot({is3DMeasurement:t,referencedImageId:i},e.data.handles.points),trackingIdentifierTextValue:this.trackingIdentifierTextValue,findingSites:r||[],finding:a,ReferencedFrameOfReferenceUID:t?n.FrameOfReferenceUID:null}}}var Vt;const{Point:Lt}=u.BF.TID300,{imageToWorldCoords:Bt}=g.utilities;class kt extends Gt{static getMeasurementData(e,t,n,a){const{state:r,SCOORDGroup:i,worldCoords:o,referencedImageId:s,ReferencedFrameNumber:c}=Ft.getSetupMeasurementData(e,t,n,this.toolType),u=r.annotation.data.label;if(1===o.length&&i){const e=n.get("imagePixelModule",s);let t=10,a=10;if(e){const{columns:n,rows:r}=e;t=n/10,a=r/10}const{GraphicData:r}=i,c=Bt(s,[r[0]+t,r[1]+a]);o.push(c)}return r.annotation.data={...r.annotation.data,text:u,handles:{...r.annotation.data.handles,arrowFirst:!0,points:o},frameNumber:c},r}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,metadata:a,findingSites:r}=e,{finding:i}=e,{referencedImageId:o}=a,s={is3DMeasurement:t,referencedImageId:o},{points:c,arrowFirst:u}=n.handles,d=u?c[0]:c[1],l=u?c[1]:c[0];return{points:[St(s,d),St(s,l)],trackingIdentifierTextValue:this.trackingIdentifierTextValue,findingSites:r||[],finding:i,ReferencedFrameOfReferenceUID:t?a.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var $t;(Vt=kt).init("ArrowAnnotate",Lt),Vt.registerLegacy();const{Bidirectional:jt}=u.BF.TID300;class Ht extends Gt{static getMeasurementData(e,t,n){const{state:a,scoordArgs:r,referencedImageId:i,ReferencedFrameNumber:o}=Ft.getSetupMeasurementData(e,t,n,this.toolType),{ContentSequence:s}=e,c=d(s).find(e=>"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning),u=d(s).find(e=>"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning),l=d(c.ContentSequence).find(e=>"SCOORD3D"===e.ValueType||"SCOORD"===e.ValueType),m=d(u.ContentSequence).find(e=>"SCOORD3D"===e.ValueType||"SCOORD"===e.ValueType),g=[];return g.push(...lt(r,l)),g.push(...lt(r,m)),a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[g[0],g[1],g[2],g[3]]},frameNumber:o},i&&(a.annotation.data.cachedStats={[`imageId:${i}`]:{length:c.MeasuredValueSequence.NumericValue,width:u.MeasuredValueSequence.NumericValue}}),a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u={is3DMeasurement:t,referencedImageId:c},{points:d}=s,l=[d[0],d[1]],m=[d[2],d[3]];let g,p;Math.sqrt(Math.pow(l[0][0]-l[1][0],2)+Math.pow(l[0][1]-l[1][1],2)+Math.pow(l[0][2]-l[1][2],2))>Math.sqrt(Math.pow(m[0][0]-m[1][0],2)+Math.pow(m[0][1]-m[1][1],2)+Math.pow(m[0][2]-m[1][2],2))?(g=l,p=m):(g=m,p=l);const f=St(u,g[0]),I=St(u,g[1]),h=St(u,p[0]),S=St(u,p[1]),{length:O,width:T}=o[`imageId:${c}`]||{};return{longAxis:{point1:f,point2:I},shortAxis:{point1:h,point2:S},longAxisLength:O,shortAxisLength:T,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var zt;($t=Ht).init("Bidirectional",jt),$t.registerLegacy();const{CobbAngle:Yt}=u.BF.TID300;class Wt extends Gt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Ft.getSetupMeasurementData(e,t,n,this.toolType),c=o?{[`imageId:${o}`]:{angle:r?r.MeasuredValueSequence.NumericValue:null}}:{};return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[i[0],i[1],i[3]]},cachedStats:c,frameNumber:s},a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u={is3DMeasurement:t,referencedImageId:c},d=St(u,s.points[0]),l=St(u,s.points[1]),m=St(u,s.points[1]),g=St(u,s.points[2]),p=o[`imageId:${c}`]?.angle;return{point1:d,point2:l,point3:m,point4:g,rAngle:p,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var Kt;(zt=Wt).init("Angle",Yt),zt.registerLegacy();const{CobbAngle:Xt}=u.BF.TID300;class Qt extends Gt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,referencedImageId:i,worldCoords:o,ReferencedFrameNumber:s}=Ft.getSetupMeasurementData(e,t,n,Qt.toolType);return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[o[0],o[1],o[2],o[3]]},frameNumber:s},i&&(a.annotation.data.cachedStats={[`imageId:${i}`]:{angle:r?r.MeasuredValueSequence.NumericValue:null}}),a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u=Ot({is3DMeasurement:t,referencedImageId:c},s.points),[d,l,m,g]=u,{angle:p}=o[`imageId:${c}`]||{};return{point1:d,point2:l,point3:m,point4:g,rAngle:p,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var Jt;(Kt=Qt).init("CobbAngle",Xt),Kt.registerLegacy();const{Circle:Zt}=u.BF.TID300;class en extends Gt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Ft.getSetupMeasurementData(e,t,n,this.toolType);return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:i},frameNumber:s},o&&(a.annotation.data.cachedStats={[`imageId:${o}`]:{area:r?r.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0}}),a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u={is3DMeasurement:t,referencedImageId:c},d=St(u,s.points[0]),l=St(u,s.points[1]),{area:m,radius:g}=o[`imageId:${c}`]||{};return{area:m,perimeter:2*Math.PI*g,radius:g,points:[d,l],trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}(Jt=en).init("CircleROI",Zt),Jt.registerLegacy();const{Ellipse:tn}=u.BF.TID300;class nn extends Gt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Ft.getSetupMeasurementData(e,t,n,nn.toolType);return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:i},frameNumber:s},a.annotation.data.cachedStats=o?{[`imageId:${o}`]:{area:r?r.MeasuredValueSequence.NumericValue:0}}:{},a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,c=n.initialRotation||0,{referencedImageId:u}=i,d={is3DMeasurement:t,referencedImageId:u};let l,m,g,p;90==c||270==c?(m=s.points[2],l=s.points[3],g=s.points[0],p=s.points[1]):(l=s.points[0],m=s.points[1],g=s.points[2],p=s.points[3]);const f=[];Math.sqrt((l[0]-m[0])**2+(l[1]-m[1])**2+(l[2]-m[2])**2)>Math.sqrt((g[0]-p[0])**2+(g[1]-p[1])**2+(g[2]-p[2])**2)?f.push(l,m,g,p):f.push(g,p,l,m);const{area:I}=o[`imageId:${u}`]||{};return{area:I,points:f.map(e=>St(d,e)),trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var an;nn.init("EllipticalROI",tn);const{Polyline:rn}=u.BF.TID300;class on extends Gt{static getMeasurementData(e,t,n){const{state:a,worldCoords:r,referencedImageId:i,ReferencedFrameNumber:o}=Ft.getSetupMeasurementData(e,t,n,this.toolType),s=e.ContentSequence.find(e=>"NUM"===e.ValueType&&"Area"===e.ConceptNameCodeSequence[0].CodeMeaning),c=i?{[`imageId:${i}`]:{area:s?.MeasuredValueSequence?.[0]?.NumericValue||0,areaUnit:s?.MeasuredValueSequence?.[0]?.MeasurementUnitsCodeSequence?.CodeValue}}:{};return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[r[0],r[1],r[3],r[2]]},cachedStats:c,frameNumber:o},a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{referencedImageId:o}=i,s=Ot({is3DMeasurement:t,referencedImageId:o},n.handles.points),{area:c,perimeter:u}=n.cachedStats[`imageId:${o}`]||{};return{points:[s[0],s[1],s[3],s[2],s[0]],area:c,perimeter:u,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],use3DSpatialCoordinates:t}}}var sn;(an=on).init("RectangleROI",rn),an.registerLegacy();const{Length:cn}=u.BF.TID300;class un extends Gt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Ft.getSetupMeasurementData(e,t,n,this.toolType),c=o?{[`imageId:${o}`]:{length:r?r.MeasuredValueSequence.NumericValue:0}}:{};return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:[i[0],i[1]],activeHandleIndex:0},cachedStats:c,frameNumber:s},a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{cachedStats:o={},handles:s}=n,{referencedImageId:c}=i,u={is3DMeasurement:t,referencedImageId:c},d=St(u,s.points[0]),l=St(u,s.points[1]),{length:m}=o[`imageId:${c}`]||{};return{point1:d,point2:l,distance:m,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],use3DSpatialCoordinates:t}}}(sn=un).init("Length",cn),sn.registerLegacy();var dn,ln=n(3823);const{Polyline:mn}=u.BF.TID300;class gn extends Gt{static getMeasurementData(e,t,n){const{state:a,NUMGroup:r,worldCoords:i,referencedImageId:o,ReferencedFrameNumber:s}=Ft.getSetupMeasurementData(e,t,n,this.toolType);let c=!0;ln.eR.distance(i[i.length-1],i[0])<this.closedContourThreshold&&(i.pop(),c=!1);const u=[];return c&&u.push(i[0],i[i.length-1]),a.annotation.data={...a.annotation.data,contour:{polyline:i,closed:!c},handles:{...a.annotation.data.handles,points:u},frameNumber:s},o&&(a.annotation.data.cachedStats={[`imageId:${o}`]:{area:r?r.MeasuredValueSequence.NumericValue:null}}),a}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,finding:a,findingSites:r,metadata:i}=e,{polyline:o,closed:s}=n.contour,c=!0!==s,{referencedImageId:u}=i,d=Ot({is3DMeasurement:t,referencedImageId:u},o);if(!c){const e=d[0];d.push(e)}const{area:l,areaUnit:m,modalityUnit:g,perimeter:p,mean:f,max:I,stdDev:h}=n.cachedStats[`imageId:${u}`]||{};return{points:d,area:l,areaUnit:m,perimeter:p,modalityUnit:g,mean:f,max:I,stdDev:h,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[],ReferencedFrameOfReferenceUID:t?i.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}var pn;(dn=gn).closedContourThreshold=1e-5,dn.init("PlanarFreehandROI",mn);const{Point:fn}=u.BF.TID300;class In extends Gt{static isValidMeasurement(e){const t=this.getGraphicItem(e);return"POINT"===this.getGraphicType(t)&&this.getPointsCount(t)<=2}static getMeasurementData(e,t,n,a){const{state:r,NUMGroup:i,worldCoords:o,referencedImageId:s,ReferencedFrameNumber:c}=Ft.getSetupMeasurementData(e,t,n,this.toolType),u=s?{[`imageId:${s}`]:{value:i?.MeasuredValueSequence?.NumericValue??null}}:{};return r.annotation.data={...r.annotation.data,handles:{...r.annotation.data.handles,points:o},cachedStats:u,frameNumber:c,invalidated:!0},r}static getTID300RepresentationArguments(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{data:n,metadata:a}=e,{finding:r,findingSites:i}=e,{referencedImageId:o}=a,s={is3DMeasurement:t,referencedImageId:o},{handles:{points:c=[]}}=n;return{points:Ot(s,c),trackingIdentifierTextValue:this.trackingIdentifierTextValue,findingSites:i||[],finding:r,ReferencedFrameOfReferenceUID:t?a.FrameOfReferenceUID:null,use3DSpatialCoordinates:t}}}(pn=In).init("Probe",fn),pn.registerLegacy(),pn.registerType("DCM:111030","POINT",1),pn.registerType("DCM:111030","POINT",2);const{Length:hn}=u.BF.TID300,{worldToImageCoords:Sn}=g.utilities;class On extends Gt{static getMeasurementData(e,t,n){const{state:a,worldCoords:r,ReferencedFrameNumber:i}=Ft.getSetupMeasurementData(e,t,n,this.toolType);return a.annotation.data={...a.annotation.data,handles:{...a.annotation.data.handles,points:r},frameNumber:i},a}static getTID300RepresentationArguments(e,t){const{data:n,finding:a,findingSites:r,metadata:i}=e,{handles:o}=n,{referencedImageId:s}=i;if(!s)throw new Error("UltrasoundDirectionalTool.getTID300RepresentationArguments: referencedImageId is not defined");const c=Sn(s,o.points[0]),u=Sn(s,o.points[1]);return{point1:{x:c[0],y:c[1]},point2:{x:u[0],y:u[1]},trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:a,findingSites:r||[]}}}On.init("UltrasoundDirectionalTool",hn);const{Normalizer:Tn}=u.z8,{Segmentation:Dn}=u.h4;function Cn(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=function(e,t,n){const a=e.map(e=>{const n=t.get("instance",e.imageId);return{...e,...n,SOPClassUID:n.SopClassUID||n.SOPClassUID,SOPInstanceUID:n.SopInstanceUID||n.SOPInstanceUID,PixelData:e.voxelManager.getScalarData(),_vrMap:{PixelData:"OW"},_meta:{}}}),r=Tn.normalizeToDataset(a);if(!r)throw new Error("Failed to normalize the multiframe dataset, the data is not multi-frame.");return new Dn([r],n)}(e,n,a);return Fe(r,t,a)}function yn(e){const{scalarData:t,dimensions:n}=e,a=[],r=new Set;for(let e=0;e<n[2];e++){const i=t.slice(e*n[0]*n[1],(e+1)*n[0]*n[1]),o=[];for(let e=0;e<i.length;e++){const t=i[e];o.includes(t)||0===t||o.push(t)}const s={segmentsOnLabelmap:o,pixelData:i,rows:n[1],columns:n[0]};0!==o.length&&(o.forEach(e=>{r.add(e)}),a[n[2]-1-e]=s)}return e.segmentsOnLabelmap=Array.from(r),e.labelmaps2D=a,e}var Rn=n(4667);const En=e=>{let{largerArray:t,currentTestedArray:n,newArray:a}=e;return t.some((e,t)=>{const r=n[t],i=a[t];return!(!r||!i)&&r.some((e,t)=>{const n=i[t];return e&&n})})},Nn=e=>{let{arrayOfSegmentData:t,newSegmentData:n}=e;if(0!==t.length){for(let e=0;e<t.length;e++){const a=t[e],r=a.length>n.length?a:n;if(!En({currentTestedArray:a,largerArray:r,newArray:n}))return void r.forEach((e,t)=>{const r=a[t],i=n[t];if(!r&&!i||!i)return;if(!r)return void(a[t]=i);const o=r.map((e,t)=>{const n=i[t];return e||n});a[t]=o})}t.push(n)}else t.push(n)},{DicomMessage:Mn,DicomMetaDictionary:An}=u.p,{Normalizer:Pn}=u.z8,{decode:_n}=u.BF.compression,vn=e=>{let{segmentsOnFrame:t,imageIdIndex:n,segmentIndex:a}=e;t[n]||(t[n]=[]),t[n].push(a)},xn=e=>{let{segmentsPixelIndices:t,segmentIndex:n,imageIdIndex:a,indexCache:r}=e;t.has(n)||t.set(n,{});const i=t.get(n);i[a]=r,t.set(n,i)},wn=e=>{let{PerFrameFunctionalGroups:t,sequenceIndex:n,sopUIDImageIdIndexMap:a,multiframe:r}=e;const i=t.DerivationImageSequence[0].SourceImageSequence[0].ReferencedSOPInstanceUID;return{referencedSOPInstanceUid:i,referencedImageId:a[i],segmentIndex:Le(r,n)}};const bn=Rn.utilities.throttle(e=>{(0,g.triggerEvent)(g.eventTarget,ye.SEGMENTATION_LOAD_PROGRESS,{percentComplete:e})},200);function Un(e){let{segmentsOnFrame:t,labelMapImages:n,pixelDataChunks:a,multiframe:r,referencedImageIds:i,validOrientations:o,metadataProvider:s,tolerance:c,segmentsPixelIndices:u,sopUIDImageIdIndexMap:d,imageIdMaps:l}=e;const{SharedFunctionalGroupsSequence:m,PerFrameFunctionalGroupsSequence:g,Rows:p,Columns:f}=r,I=m.PlaneOrientationSequence?m.PlaneOrientationSequence.ImageOrientationPatient:void 0,h=f*p,S=g.length;let O=!1;return new Promise(e=>{const m=Math.ceil(.1*S),T=D=>{for(let T=D;T<D+m&&T<S;T++){const m=g[T],S=I||m.PlaneOrientationSequence.ImageOrientationPatient,D=Ye(a,T*h,h),C=He(ee()(D,[p,f]),S,o,c);if(!C)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");const y=Le(r,T);if(void 0===y)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");u.has(y)||u.set(y,{});const R=Ge(r,T,i,s,c,d);if(!R)return void console.warn("Image not present in stack, can't import frame : "+T+".");const E=l.metadata[R];if(p!==E.Rows||f!==E.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");const N=l.indices[R],M=n[N],A=M.getPixelData(),P=M.voxelManager,_=C.data,v=[];for(let m=0,g=C.data.length;m<g;++m)if(_[m]){for(let p=m;p<g;++p)if(_[p]){if(!O&&0!==A[p])return O=!0,e(Vn({segmentsOnFrame:t,labelMapImages:n,pixelDataChunks:a,multiframe:r,referencedImageIds:i,validOrientations:o,metadataProvider:s,tolerance:c,segmentsPixelIndices:u,sopUIDImageIdIndexMap:d,imageIdMaps:l}));P?P.setAtIndex(p,y):A[p]=y,v.push(p)}t[N]||(t[N]=[]),t[N].push(y);break}const x=u.get(y);x[N]=v,u.set(y,x)}const C=Math.round(D/S*100);bn(C),D<S?setTimeout(()=>T(D+m),0):e({hasOverlappingSegments:!1,arrayOfLabelMapImages:[n]})},D=g=>{const I=r.PerFrameFunctionalGroupsSequence,O=r.SharedFunctionalGroupsSequence.PlaneOrientationSequence?.ImageOrientationPatient;for(let e=g;e<g+m&&e<S;e++){const m=I[e],g=O||m.PlaneOrientationSequence.ImageOrientationPatient,S=a.subarray(e*h,(e+1)*h),T=He(ee()(S,[p,f]),g,o,c);if(!T)throw new Error("Individual Labelmap SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");const D=Ge(r,e,i,s,c,d);if(!D){console.warn(`Image not present in stack, can't import frame : ${e}.`);continue}const C=l.metadata[D];if(p!==C.Rows||f!==C.Columns)throw new Error("Individual Labelmap SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");const y=l.indices[D],R=n[y].getPixelData(),E=T.data;let N=t[y];N||(N=[],t[y]=N);const M=new Set(N);for(let e=0,t=E.length;e<t;++e){const t=E[e];if(0!==t){R[e]=t,M.has(t)||(N.push(t),M.add(t)),u.has(t)||u.set(t,{});const n=u.get(t);n[y]||(n[y]=[]),n[y].push(e)}}}const T=Math.round(g/S*100);bn(T),g<S?setTimeout(()=>D(g+m),0):e({hasOverlappingSegments:!1,arrayOfLabelMapImages:[n]})};"LABELMAP"===r.SegmentationType?D(0):T(0)})}const Fn=e=>{let{sharedImageOrientationPatient:t,PerFrameFunctionalGroups:n,pixelDataChunks:a,sequenceIndex:r,sliceLength:i,Rows:o,Columns:s,validOrientations:c,tolerance:u}=e;const d=t||n.PlaneOrientationSequence.ImageOrientationPatient,l=Ye(a,r*i,i),m=He(ee()(l,[o,s]),d,c,u);if(!m)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");return m},qn=e=>{let{metadataProvider:t,imageId:n,Rows:a,Columns:r}=e;const i=t.get("instance",n);if(a!==i.Rows||r!==i.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ")},Gn=e=>{let{arrayOfSegmentData:t,referencedImageIds:n}=e,a=[];for(let e=0;e<t.length;e++){const n=t[e];n.length>a.length&&(a=n)}return t.map(e=>n.map((t,n)=>{const a=!e[n],r=g.imageLoader.createAndCacheDerivedLabelmapImage(t),i=r.getPixelData();if(!a)for(let t=0;t<i.length;t++)i[t]=e[n][t];return r}).filter(Boolean))};function Vn(e){let{segmentsOnFrame:t,labelMapImages:n,pixelDataChunks:a,multiframe:r,referencedImageIds:i,validOrientations:o,metadataProvider:s,tolerance:c,segmentsPixelIndices:u,sopUIDImageIdIndexMap:d,imageIdMaps:l}=e;const{SharedFunctionalGroupsSequence:m,PerFrameFunctionalGroupsSequence:g,Rows:p,Columns:f}=r,I=m.PlaneOrientationSequence?m.PlaneOrientationSequence.ImageOrientationPatient:void 0,h=Ln({sliceLength:f*p,Rows:p,Columns:f,validOrientations:o,metadataProvider:s,imageIdMaps:l,segmentsOnFrame:t,tolerance:c,pixelDataChunks:a,PerFrameFunctionalGroupsSequence:g,labelMapImages:n,sopUIDImageIdIndexMap:d,multiframe:r,sharedImageOrientationPatient:I,segmentsPixelIndices:u});return{arrayOfLabelMapImages:Gn({arrayOfSegmentData:h,referencedImageIds:i}),hasOverlappingSegments:!0}}const Ln=e=>{let{sliceLength:t,Rows:n,Columns:a,validOrientations:r,metadataProvider:i,imageIdMaps:o,segmentsOnFrame:s,tolerance:c,pixelDataChunks:u,PerFrameFunctionalGroupsSequence:d,labelMapImages:l,sopUIDImageIdIndexMap:m,multiframe:g,sharedImageOrientationPatient:p,segmentsPixelIndices:f}=e;const I=[],h=g.SegmentSequence.length;for(let e=1;e<=h;++e){const h=Bn({PerFrameFunctionalGroupsSequence:d,labelMapImages:l,sopUIDImageIdIndexMap:m,multiframe:g,segmentIndex:e,sliceLength:t,Rows:n,Columns:a,validOrientations:r,tolerance:c,pixelDataChunks:u,sharedImageOrientationPatient:p,metadataProvider:i,imageIdMaps:o,segmentsOnFrame:s,segmentsPixelIndices:f});Nn({arrayOfSegmentData:I,newSegmentData:h})}return I},Bn=e=>{let{PerFrameFunctionalGroupsSequence:t,labelMapImages:n,sopUIDImageIdIndexMap:a,multiframe:r,segmentIndex:i,sliceLength:o,Rows:s,Columns:c,validOrientations:u,tolerance:d,pixelDataChunks:l,sharedImageOrientationPatient:m,metadataProvider:g,imageIdMaps:p,segmentsOnFrame:f,segmentsPixelIndices:I}=e;const h=[];for(let e=0;e<n.length;e++){const S=n[e],O=S.referencedImageId,T=t.findIndex((e,t)=>{const{segmentIndex:n,referencedImageId:o}=wn({PerFrameFunctionalGroups:e,sequenceIndex:t,sopUIDImageIdIndexMap:a,multiframe:r});return n===i&&o===S.referencedImageId});if(-1===T)continue;const D=t[T],C=Fn({sharedImageOrientationPatient:m,PerFrameFunctionalGroups:D,pixelDataChunks:l,sequenceIndex:T,sliceLength:o,Rows:s,Columns:c,validOrientations:u,tolerance:d});qn({metadataProvider:g,Rows:s,Columns:c,imageId:O});const y=[],R=C.data.map((e,t)=>((e?i:0)&&y.push(t),e?i:0));y.length>0&&(h[e]=R);const E=p.indices[O];vn({imageIdIndex:E,segmentIndex:i,segmentsOnFrame:f}),xn({imageIdIndex:E,segmentIndex:i,segmentsPixelIndices:I,indexCache:y})}return h};function kn(e,t,n){return Qe(e,t,n,arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001,arguments.length>5&&void 0!==arguments[5]?arguments[5]:4)}function $n(e,t,n){let{metadataProvider:a,tolerance:r=.001}=n;return async function(e,t,n,a){const{tolerance:r=.001,TypedArrayConstructor:i=Uint8Array,maxBytesPerChunk:o=199e6}=a,s=Mn.readFile(t),c=An.naturalizeDataset(s.dict);c._meta=An.namifyDataset(s.meta);const u=Pn.normalizeToDataset([c]),d=n.get("imagePlaneModule",e[0]),l=n.get("generalSeriesModule",e[0]).seriesInstanceUID;d||console.warn("Insufficient metadata, imagePlaneModule missing.");const m=je(Array.isArray(d.rowCosines)?[...d.rowCosines,...d.columnCosines]:[d.rowCosines.x,d.rowCosines.y,d.rowCosines.z,d.columnCosines.x,d.columnCosines.y,d.columnCosines.z]),p=ze(u,l);let f,I;if("1.2.840.10008.1.2.5"===u._meta.TransferSyntaxUID.Value[0]){const e=Array.isArray(u.PixelData)?u.PixelData:[u.PixelData];if(f=_n(e,u.Rows,u.Columns),1===u.BitsStored)return void console.warn("No implementation for rle + bit packing.");I=[f]}else if(I=ke(u,{maxBytesPerChunk:o}),!I)throw new Error("Fractional segmentations are not yet supported");const h=Ce(u,m,[d.rows,d.columns,e.length],r),S=e.reduce((e,t)=>{const{sopInstanceUID:a}=n.get("generalImageModule",t);return e[a]=t,e},{});let O;switch(h){case"Planar":O=Un;break;case"Perpendicular":throw new Error("Segmentations orthogonal to the acquisition plane of the source data are not yet supported.");case"Oblique":throw new Error("Segmentations oblique to the acquisition plane of the source data are not yet supported.")}const T=[],D={indices:{},metadata:{}},C=[];for(let t=0;t<e.length;t++){const a=e[t];D.indices[a]=t,D.metadata[a]=n.get("instance",a);const r=g.imageLoader.createAndCacheDerivedLabelmapImage(a);C.push(r)}const y=new Map,{hasOverlappingSegments:R,arrayOfLabelMapImages:E}=await O({segmentsOnFrame:T,labelMapImages:C,pixelDataChunks:I,multiframe:u,referencedImageIds:e,validOrientations:m,metadataProvider:n,tolerance:r,segmentsPixelIndices:y,sopUIDImageIdIndexMap:S,imageIdMaps:D,TypedArrayConstructor:i}),N=new Map;return y.forEach((t,a)=>{const r=We(t,u,n,e);N.set(a,r)}),{labelMapImages:E,segMetadata:p,segmentsOnFrame:T,centroids:N,overlappingSegments:R}}(e,t,a,{tolerance:r})}const{ParametricMap:jn}=it,{generateToolState:Hn}=jn;function zn(e,t,n){return Hn(e,t,n,arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001)}function Yn(e,t,n){const{referencedImageId:a,FrameOfReferenceUID:r}=e,i=t.get("instance",a),{SeriesInstanceUID:o}=i,{ReferencedSeriesSequence:s}=n;return[{FrameOfReferenceUID:r,RTReferencedStudySequence:[{ReferencedSOPClassUID:n.SOPClassUID,ReferencedSOPInstanceUID:n.SOPInstanceUID,RTReferencedSeriesSequence:[{SeriesInstanceUID:o,ContourImageSequence:[...s[0].ReferencedInstanceSequence]}]}]}]}function Wn(e,t,n,a){const{referencedImageId:r}=e,i=n.get("instance",r),{SeriesInstanceUID:o,StudyInstanceUID:s}=i,c=[];if(o){const e=a.getSeries(s,o),t={SeriesInstanceUID:o,ReferencedInstanceSequence:[]};e.instances.forEach(e=>{const{SOPInstanceUID:n,SOPClassUID:a}=e;t.ReferencedInstanceSequence.push({ReferencedSOPClassUID:a,ReferencedSOPInstanceUID:n})}),c.push(t)}return c}function Kn(e,t){const{FrameOfReferenceUID:n}=e.metadata;return{ROINumber:t+1,ROIName:e.name||`Todo: name ${t+1}`,ROIDescription:`Todo: description ${t+1}`,ROIGenerationAlgorithm:"Todo: algorithm",ReferencedFrameOfReferenceUID:n}}const{generateContourSetsFromLabelmap:Xn,AnnotationToPointData:Qn}=Rn.utilities.contours,{DicomMetaDictionary:Jn}=u.Ay.data;async function Zn(e,t,n){const a=[];(await Xn({segmentations:e})).forEach((e,n)=>{if(e){const r=[];e.sliceContours.forEach(e=>{const n=t.get("sopCommonModule",e.referencedImageId),a=[{ReferencedSOPClassUID:n.sopClassUID,ReferencedSOPInstanceUID:n.sopInstanceUID}],i=e.polyData;e.contours.forEach((e,t)=>{const n=e.type,o=e.contourPoints.length,s=[];e.contourPoints.forEach(e=>{const t=i.points[e];t[0]=+t[0].toFixed(2),t[1]=+t[1].toFixed(2),t[2]=+t[2].toFixed(2),s.push(t[0]),s.push(t[1]),s.push(t[2])}),r.push({ContourImageSequence:a,ContourGeometricType:n,NumberOfContourPoints:o,ContourNumber:t+1,ContourData:s})})});const i=e.label||`Segment ${n+1}`,o={name:i,description:i,contourSequence:r,color:e.color,metadata:e.metadata};a.push(o)}});const r=ta({name:e.label,label:e.label},a[0].metadata,t);a.forEach((e,a)=>{const i={ROIDisplayColor:e.color||[255,0,0],ContourSequence:e.contourSequence,ReferencedROINumber:a+1};r.StructureSetROISequence.push(Kn(e,a)),r.ROIContourSequence.push(i),r.ReferencedSeriesSequence=Wn(e.metadata,0,t,n),r.ReferencedFrameOfReferenceSequence=Yn(e.metadata,t,r)});const i=new Uint8Array(2);i[1]=1;const o={FileMetaInformationVersion:{Value:[i.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[Jn.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};return r._meta=o,r.SpecificCharacterSet="ISO_IR 192",r}function ea(e,t,n){const a=ta({name:"RTSS from Annotations",label:"RTSS from Annotations"},e[0].metadata,t);e.forEach((e,r)=>{const i=Qn.convert(e,r,t);a.StructureSetROISequence.push(Kn(e,r)),a.ROIContourSequence.push(i),a.RTROIObservationsSequence.push(function(e,t){return{ObservationNumber:t+1,ReferencedROINumber:t+1,RTROIInterpretedType:"Todo: type",ROIInterpreter:"Todo: interpreter"}}(0,r)),a.ReferencedSeriesSequence=Wn(e.metadata,0,t,n),a.ReferencedFrameOfReferenceSequence=Yn(e.metadata,t,a)});const r=new Uint8Array(2);r[1]=1;const i={FileMetaInformationVersion:{Value:[r.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[Jn.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};return a._meta=i,a.SpecificCharacterSet="ISO_IR 192",a}function ta(e,t,n){const a=Jn.uid(),{referencedImageId:r,FrameOfReferenceUID:i}=t,{studyInstanceUID:o}=n.get("generalSeriesModule",r),s=function(e,t){const n=t.get("generalSeriesModule",e),a=t.get("generalStudyModule",e),r=t.get("patientStudyModule",e),i=t.get("patientModule",e),o=t.get("patientDemographicModule",e);return{Modality:n.modality,PatientID:i.patientId,PatientName:i.patientName,PatientBirthDate:"",PatientAge:r.patientAge,PatientSex:o.patientSex,PatientWeight:r.patientWeight,StudyDate:a.studyDate,StudyTime:a.studyTime,StudyID:"ToDo",AccessionNumber:a.accessionNumber}}(r,n),c=function(e){return{SeriesInstanceUID:e.uid(),SeriesNumber:"99"}}(Jn);return{StructureSetROISequence:[],ROIContourSequence:[],RTROIObservationsSequence:[],ReferencedSeriesSequence:[],ReferencedFrameOfReferenceSequence:[],...s,...c,StudyInstanceUID:o,SOPClassUID:"1.2.840.10008.5.1.4.1.1.481.3",SOPInstanceUID:a,Manufacturer:"dcmjs",Modality:"RTSTRUCT",FrameOfReferenceUID:i,PositionReferenceIndicator:"",StructureSetLabel:e.label||"",StructureSetName:e.name||"",ReferringPhysicianName:"",OperatorsName:"",StructureSetDate:Jn.date(),StructureSetTime:Jn.time(),_meta:null}}const{generateContourSetsFromLabelmap:na}=Rn.utilities.contours;var aa;const{Point:ra}=u.BF.TID300;class ia extends In{static getMeasurementData(e,t,n,a){const r=super.getMeasurementData(e,t,n,a),{data:i}=r.annotation;return i.isPoint=-1!==a.indexOf("Point"),r}static getTID300RepresentationArguments(e){const t=super.getTID300RepresentationArguments(e),{data:n}=e;return n.isPoint&&(n.seriesLevel?t.trackingIdentifierTextValue=this.trackingSeriesPointIdentifier:t.trackingIdentifierTextValue=this.trackingPointIdentifier),n.seriesLevel&&(t.trackingIdentifierTextValue=this.trackingSeriesIdentifier),t.points.length||t.points.push({x:0,y:0}),t}}(aa=ia).init("KeyImage",ra,{parentType:In.toolType}),aa.trackingSeriesIdentifier=`${aa.trackingIdentifierTextValue}:Series`,aa.trackingPointIdentifier=`${aa.trackingIdentifierTextValue}:Point`,aa.trackingSeriesPointIdentifier=`${aa.trackingIdentifierTextValue}:SeriesPoint`;const oa={BaseAdapter3D:Gt,Bidirectional:Ht,CobbAngle:Qt,Angle:Wt,Length:un,CircleROI:en,EllipticalROI:nn,RectangleROI:on,ArrowAnnotate:kt,Probe:In,PlanarFreehandROI:gn,UltrasoundDirectional:On,KeyImage:ia,MeasurementReport:Ft,CodeScheme:mt,CORNERSTONE_3D_TAG:ot,COMMENT_CODE:ft,NO_IMAGE_ID:gt,TEXT_ANNOTATION_POSITION:pt},sa={Segmentation:r},ca={ParametricMap:i},ua={RTSS:o},{Colors:da,BitArray:la}=u.p;function ma(e){const t=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;switch(t){case 1:return Math.abs(e);case 2:return Math.sqrt(e[0]*e[0]+e[1]*e[1]);case 3:return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);default:{let n=0;for(let a=0;a<t;a++)n+=e[a]*e[a];return Math.sqrt(n)}}}(e);return 0!==t&&(e[0]/=t,e[1]/=t,e[2]/=t),t}const ga={Cornerstone:at,Cornerstone3D:oa},pa={Cornerstone:rt,Cornerstone3D:sa,VTKjs:{Segmentation:class{constructor(){}static generateSegments(e){"Array"!==e.SegmentSequence.constructor.name&&(e.SegmentSequence=[e.SegmentSequence]),e.SegmentSequence.forEach(e=>{const t=function(e){const t=da.dicomlab2RGB(e).map(e=>Math.round(255*e));return t.push(255),t}(e.RecommendedDisplayCIELabValue);segments[e.SegmentNumber]={color:t,functionalGroups:[],offset:null,size:null,pixelData:null}}),e.PerFrameFunctionalGroupsSequence.forEach(e=>{const t=e.SegmentIdentificationSequence.ReferencedSegmentNumber;segments[t].functionalGroups.push(e)});const t=Math.ceil(e.Rows*e.Columns/8);let n=0;return Object.keys(segments).forEach(a=>{const r=segments[a];r.numberOfFrames=r.functionalGroups.length,r.size=r.numberOfFrames*t,r.offset=n,n=r.offset+r.size;const i=e.PixelData.slice(r.offset,n);r.pixelData=la.unpack(i);const o=function(e,t){const n={},a=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,r=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,i=t[0],o=t[t.length-1],s=i.PlanePositionSequence.ImagePositionPatient.map(Number),c=o.PlanePositionSequence.ImagePositionPatient.map(Number);n.origin=s,n.spacing=[a.PixelSpacing[1],a.PixelSpacing[0],a.SpacingBetweenSlices].map(Number),n.dimensions=[e.Columns,e.Rows,t.length].map(Number);const u=r.ImageOrientationPatient.map(Number),d=u.slice(0,3),l=u.slice(3,6);var m,g,p;return n.planeNormal=[],function(e,t,n){const a=e[1]*t[2]-e[2]*t[1],r=e[2]*t[0]-e[0]*t[2],i=e[0]*t[1]-e[1]*t[0];n[0]=a,n[1]=r,n[2]=i}(d,l,n.planeNormal),n.sliceStep=[],m=c,g=s,(p=n.sliceStep)[0]=m[0]-g[0],p[1]=m[1]-g[1],p[2]=m[2]-g[2],ma(n.sliceStep),n.direction=d.concat(l).concat(n.sliceStep),n}(e,r.functionalGroups);r.geometry=o}),segments}}}},fa={Cornerstone:it,Cornerstone3D:ca},Ia={Cornerstone3D:ua},{datasetToDict:ha}=u.p;function Sa(e,t){let n;if(e instanceof ArrayBuffer)n=new Blob([e],{type:"application/dicom"});else{if(!e._meta)throw new Error("Dataset must have a _meta property");const t=m.hp.from(ha(e).write());n=new Blob([t],{type:"application/dicom"})}const a=document.createElement("a");a.href=window.URL.createObjectURL(n),a.download=t,a.click()}},75183:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.Interaction="Interaction",e.HandlesUpdated="HandlesUpdated",e.StatsUpdated="StatsUpdated",e.InitialSetup="InitialSetup",e.Completed="Completed",e.InterpolationUpdated="InterpolationUpdated",e.History="History",e.MetadataReferenceModified="MetadataReferenceModified",e.LabelChange="LabelChange"}(a||(a={}));const r=a},94021:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOLGROUP_VIEWPORT_ADDED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_ADDED",e.TOOLGROUP_VIEWPORT_REMOVED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_REMOVED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.CROSSHAIR_TOOL_CENTER_CHANGED="CORNERSTONE_TOOLS_CROSSHAIR_TOOL_CENTER_CHANGED",e.VOLUMECROPPINGCONTROL_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPINGCONTROL_TOOL_CHANGED",e.VOLUMECROPPING_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPING_TOOL_CHANGED",e.STACK_PREFETCH_COMPLETE="CORNERSTONE_TOOLS_STACK_PREFETCH_COMPLETE",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_CUT_MERGE_PROCESS_COMPLETED",e.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_INTERPOLATION_PROCESS_COMPLETED",e.INTERPOLATED_ANNOTATIONS_REMOVED="CORNERSTONE_TOOLS_INTERPOLATED_ANNOTATIONS_REMOVED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_ADDED",e.SEGMENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_ADDED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.HISTORY_UNDO="CORNERSTONE_TOOLS_HISTORY_UNDO",e.HISTORY_REDO="CORNERSTONE_TOOLS_HISTORY_REDO",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(a||(a={}));const r=a},18682:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.Labelmap="Labelmap",e.Contour="Contour",e.Surface="Surface"}(a||(a={}));const r=a},84093:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.OnInteractionStart="onInteractionStart",e.OnInteractionEnd="onInteractionEnd",e.Preview="preview",e.RejectPreview="rejectPreview",e.AcceptPreview="acceptPreview",e.Fill="fill",e.Interpolate="interpolate",e.StrategyFunction="strategyFunction",e.CreateIsInThreshold="createIsInThreshold",e.Initialize="initialize",e.INTERNAL_setValue="setValue",e.AddPreview="addPreview",e.ComputeInnerCircleRadius="computeInnerCircleRadius",e.GetStatistics="getStatistics",e.EnsureImageVolumeFor3DManipulation="ensureImageVolumeFor3DManipulation",e.EnsureSegmentationVolumeFor3DManipulation="ensureSegmentationVolumeFor3DManipulation"}(a||(a={}));const r=a},66452:(e,t,n)=>{"use strict";var a,r;n.d(t,{i:()=>a,q:()=>r}),function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button",e[e.Wheel=524288]="Wheel",e[e.Wheel_Primary=524289]="Wheel_Primary"}(a||(a={})),function(e){e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta"}(r||(r={}))},49892:(e,t,n)=>{"use strict";var a;n.d(t,{A:()=>r}),function(e){e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled"}(a||(a={}));const r=a},10401:(e,t,n)=>{"use strict";var a;n.d(t,{H:()=>a}),function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(a||(a={}))},99737:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AnnotationStyleStates:()=>o,ChangeTypes:()=>m.A,Events:()=>c.A,KeyboardBindings:()=>r.q,MouseBindings:()=>r.i,SegmentationRepresentations:()=>u.A,StrategyCallbacks:()=>l.A,Swipe:()=>d.H,ToolModes:()=>i.A,WorkerTypes:()=>g});var a,r=n(66452),i=n(49892);!function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e.AutoGenerated="AutoGenerated"}(a||(a={}));const o=a;var s,c=n(94021),u=n(18682),d=n(10401),l=n(84093),m=n(75183);!function(e){e.POLYSEG_CONTOUR_TO_LABELMAP="Converting Contour to Labelmap",e.POLYSEG_SURFACE_TO_LABELMAP="Converting Surfaces to Labelmap",e.POLYSEG_CONTOUR_TO_SURFACE="Converting Contour to Surface",e.POLYSEG_LABELMAP_TO_SURFACE="Converting Labelmap to Surface",e.SURFACE_CLIPPING="Clipping Surfaces",e.COMPUTE_STATISTICS="Computing Statistics",e.INTERPOLATE_LABELMAP="Interpolating Labelmap",e.COMPUTE_LARGEST_BIDIRECTIONAL="Computing Largest Bidirectional",e.GENERATE_CONTOUR_SETS="Generating Contour Sets"}(s||(s={}));const g=s},26337:e=>{"use strict";e.exports=function(e){for(var t=new Array(e),n=0;n<e;++n)t[n]=n;return t}},11604:e=>{e.exports=function(e){return null!=e&&null!=e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}},3293:(e,t,n)=>{var a=n(26337),r=n(11604),i="undefined"!=typeof Float64Array;function o(e,t){return e[0]-t[0]}function s(){var e,t=this.stride,n=new Array(t.length);for(e=0;e<n.length;++e)n[e]=[Math.abs(t[e]),e];n.sort(o);var a=new Array(n.length);for(e=0;e<a.length;++e)a[e]=n[e][1];return a}function c(e,t){var n=["View",t,"d",e].join("");t<0&&(n="View_Nil"+e);var r="generic"===e;if(-1===t){var i="function "+n+"(a){this.data=a;};var proto="+n+".prototype;proto.dtype='"+e+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+n+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+n+"(a){return new "+n+"(a);}";return new Function(i)()}if(0===t){i="function "+n+"(a,d) {this.data = a;this.offset = d};var proto="+n+".prototype;proto.dtype='"+e+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+n+"_copy() {return new "+n+"(this.data,this.offset)};proto.pick=function "+n+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+n+"_get(){return "+(r?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+n+"_set(v){return "+(r?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+n+"(a,b,c,d){return new "+n+"(a,d)}";return new Function("TrivialArray",i)(u[e][0])}i=["'use strict'"];var o=a(t),c=o.map(function(e){return"i"+e}),d="this.offset+"+o.map(function(e){return"this.stride["+e+"]*i"+e}).join("+"),l=o.map(function(e){return"b"+e}).join(","),m=o.map(function(e){return"c"+e}).join(",");i.push("function "+n+"(a,"+l+","+m+",d){this.data=a","this.shape=["+l+"]","this.stride=["+m+"]","this.offset=d|0}","var proto="+n+".prototype","proto.dtype='"+e+"'","proto.dimension="+t),i.push("Object.defineProperty(proto,'size',{get:function "+n+"_size(){return "+o.map(function(e){return"this.shape["+e+"]"}).join("*"),"}})"),1===t?i.push("proto.order=[0]"):(i.push("Object.defineProperty(proto,'order',{get:"),t<4?(i.push("function "+n+"_order(){"),2===t?i.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===t&&i.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):i.push("ORDER})")),i.push("proto.set=function "+n+"_set("+c.join(",")+",v){"),r?i.push("return this.data.set("+d+",v)}"):i.push("return this.data["+d+"]=v}"),i.push("proto.get=function "+n+"_get("+c.join(",")+"){"),r?i.push("return this.data.get("+d+")}"):i.push("return this.data["+d+"]}"),i.push("proto.index=function "+n+"_index(",c.join(),"){return "+d+"}"),i.push("proto.hi=function "+n+"_hi("+c.join(",")+"){return new "+n+"(this.data,"+o.map(function(e){return["(typeof i",e,"!=='number'||i",e,"<0)?this.shape[",e,"]:i",e,"|0"].join("")}).join(",")+","+o.map(function(e){return"this.stride["+e+"]"}).join(",")+",this.offset)}");var g=o.map(function(e){return"a"+e+"=this.shape["+e+"]"}),p=o.map(function(e){return"c"+e+"=this.stride["+e+"]"});i.push("proto.lo=function "+n+"_lo("+c.join(",")+"){var b=this.offset,d=0,"+g.join(",")+","+p.join(","));for(var f=0;f<t;++f)i.push("if(typeof i"+f+"==='number'&&i"+f+">=0){d=i"+f+"|0;b+=c"+f+"*d;a"+f+"-=d}");i.push("return new "+n+"(this.data,"+o.map(function(e){return"a"+e}).join(",")+","+o.map(function(e){return"c"+e}).join(",")+",b)}"),i.push("proto.step=function "+n+"_step("+c.join(",")+"){var "+o.map(function(e){return"a"+e+"=this.shape["+e+"]"}).join(",")+","+o.map(function(e){return"b"+e+"=this.stride["+e+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(f=0;f<t;++f)i.push("if(typeof i"+f+"==='number'){d=i"+f+"|0;if(d<0){c+=b"+f+"*(a"+f+"-1);a"+f+"=ceil(-a"+f+"/d)}else{a"+f+"=ceil(a"+f+"/d)}b"+f+"*=d}");i.push("return new "+n+"(this.data,"+o.map(function(e){return"a"+e}).join(",")+","+o.map(function(e){return"b"+e}).join(",")+",c)}");var I=new Array(t),h=new Array(t);for(f=0;f<t;++f)I[f]="a[i"+f+"]",h[f]="b[i"+f+"]";i.push("proto.transpose=function "+n+"_transpose("+c+"){"+c.map(function(e,t){return e+"=("+e+"===undefined?"+t+":"+e+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+n+"(this.data,"+I.join(",")+","+h.join(",")+",this.offset)}"),i.push("proto.pick=function "+n+"_pick("+c+"){var a=[],b=[],c=this.offset");for(f=0;f<t;++f)i.push("if(typeof i"+f+"==='number'&&i"+f+">=0){c=(c+this.stride["+f+"]*i"+f+")|0}else{a.push(this.shape["+f+"]);b.push(this.stride["+f+"])}");return i.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),i.push("return function construct_"+n+"(data,shape,stride,offset){return new "+n+"(data,"+o.map(function(e){return"shape["+e+"]"}).join(",")+","+o.map(function(e){return"stride["+e+"]"}).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",i.join("\n"))(u[e],s)}var u={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};e.exports=function(e,t,n,a){if(void 0===e)return(0,u.array[0])([]);"number"==typeof e&&(e=[e]),void 0===t&&(t=[e.length]);var o=t.length;if(void 0===n){n=new Array(o);for(var s=o-1,d=1;s>=0;--s)n[s]=d,d*=t[s]}if(void 0===a){a=0;for(s=0;s<o;++s)n[s]<0&&(a-=(t[s]-1)*n[s])}for(var l=function(e){if(r(e))return"buffer";if(i)switch(Object.prototype.toString.call(e)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(e)?"array":"generic"}(e),m=u[l];m.length<=o+1;)m.push(c(l,m.length-1));return(0,m[o+1])(e,t,n,a)}}}]);
//# sourceMappingURL=2518.bundle.f750fd7ad4c2c674c4bd.js.map