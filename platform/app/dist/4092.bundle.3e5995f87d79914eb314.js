"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[4092,8402],{9099:(e,t,n)=>{n.r(t),n.d(t,{default:()=>G});const a=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-seg"}').UU,o=`${a}.sopClassHandlerModule.dicom-seg`;var s=n(86326),r=n(42356),i=n(68523),l=n(15327),c=n(4667),m=n(53434),d=n(5842);const g=["1.2.840.10008.5.1.4.1.1.66.4","1.2.840.10008.5.1.4.1.1.66.7"],u={};function p(e,t,n){const a=e[0],{StudyInstanceUID:s,SeriesInstanceUID:p,SOPInstanceUID:S,SeriesDescription:v,SeriesNumber:f,SeriesDate:b,SOPClassUID:I,wadoRoot:y,wadoUri:w,wadoUriRoot:h}=a,E={Modality:"SEG",loading:!1,isReconstructable:!1,displaySetInstanceUID:r.Wp.guid(),SeriesDescription:v,SeriesNumber:f,SeriesDate:b,SOPInstanceUID:S,SeriesInstanceUID:p,StudyInstanceUID:s,SOPClassHandlerId:o,SOPClassUID:I,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:g,instance:a,instances:[a],wadoRoot:y,wadoUriRoot:h,wadoUri:w,isOverlayDisplaySet:!0,label:v||`${i.A.t("Series")} ${f} - ${i.A.t("SEG")}`},x=a.ReferencedSeriesSequence;if(!x)return void console.error("ReferencedSeriesSequence is missing for the SEG");const D=x[0]||x;E.referencedImages=a.ReferencedSeriesSequence.ReferencedInstanceSequence,E.referencedSeriesInstanceUID=D.SeriesInstanceUID;const{displaySetService:C}=t.services,N=C.getDisplaySetsForSeries(E.referencedSeriesInstanceUID)[0];if(N)E.referencedDisplaySetInstanceUID=N.displaySetInstanceUID,E.isReconstructable=N.isReconstructable;else{const{unsubscribe:e}=C.subscribe(C.EVENTS.DISPLAY_SETS_ADDED,({displaySetsAdded:t})=>{const n=t[0];n.SeriesInstanceUID===E.referencedSeriesInstanceUID&&(E.referencedDisplaySetInstanceUID=n.displaySetInstanceUID,E.isReconstructable=n.isReconstructable,e())})}return E.load=async({headers:e})=>await function(e,t,n,a){const{SOPInstanceUID:o}=e,{segmentationService:s}=t.services;if((e.loading||e.isLoaded)&&u[o]&&function(e){return c.segmentation.state.getSegmentation(e.displaySetInstanceUID)}(e))return u[o];return e.loading=!0,u[o]=new Promise(async(o,r)=>{if(!e.segments||0===Object.keys(e.segments).length)try{await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:a}){const o=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:s,uiNotificationService:r}=t.services,{dicomLoaderService:i}=o.exports,g=await i.findDicomDataPromise(n,null,a),u=t.services.displaySetService.getDisplaySetByUID(n.referencedDisplaySetInstanceUID);if(!u)throw new Error("referencedDisplaySet is missing for SEG");let{imageIds:p}=u;if(!p){const{images:e}=u;p=e.map(e=>e.imageId)}const S=.001;l.eventTarget.addEventListener(m.fX.s.SEGMENTATION_LOAD_PROGRESS,e=>{const{percentComplete:t}=e.detail;s._broadcastEvent(s.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})});const v=await m.ql.Cornerstone3D.Segmentation.createFromDICOMSegBuffer(p,g,{metadataProvider:l.metaData,tolerance:S});let f=!0;v.segMetadata.data.forEach((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,d.Ay.data.Colors.dicomlab2RGB(n).map(e=>Math.round(255*e))):(f=!1,e.rgba=c.CONSTANTS.COLOR_LUT[t%c.CONSTANTS.COLOR_LUT.length]))}),f||r.show({title:"DICOM SEG import",message:"RecommendedDisplayCIELabValue not found for one or more segments. The default color was used instead.",type:"warning",duration:5e3});Object.assign(n,v)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:a})}catch(t){return e.loading=!1,r(t)}s.createSegmentationForSEGDisplaySet(e).then(()=>{e.loading=!1,o()}).catch(t=>{e.loading=!1,r(t)})}),u[o]}(E,t,n,e),[E]}const S=function(e){const{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",sopClassUids:g,getDisplaySetsFromSeries:e=>p(e,t,n)}]},v={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0,syncGroups:[{type:"hydrateseg",id:"sameFORId",source:!0,target:!0}]},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0,syncGroups:[{type:"hydrateseg",id:"sameFORId",source:!0,target:!0}]},displaySets:[{id:"segDisplaySetId"}]}]}]};const f=function(){return[{name:v.id,protocol:v}]};var b=n(39548),I=n(96357);const{datasetToBlob:y}=d.Ay.data,{Cornerstone3D:{Segmentation:{generateSegmentation:w}}}=m.ql,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:h}}}=m.f_,{vk:E}=m._$,x=({servicesManager:e,extensionManager:t})=>{const{segmentationService:n,displaySetService:a,viewportGridService:o}=e.services,s={loadSegmentationsForViewport:async({segmentations:e,viewportId:t})=>{const s=(({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:a}=t.getState(),o=e||a;return n.get(o)})({viewportId:t,viewportGridService:o}),r=s.displaySetInstanceUIDs[0],i=e[0],l=i.segmentationId,c=i.config.label,m=i.config.segments,d=a.getDisplaySetByUID(r);return await n.createLabelmapForDisplaySet(d,{segmentationId:l,segments:m,label:c}),n.addOrUpdateSegmentation(i),await n.addSegmentationRepresentation(s.viewportId,{segmentationId:l}),l},generateSegmentation:({segmentationId:e,options:t={}})=>{const a=c.segmentation.state.getSegmentation(e),{imageIds:o}=a.representationData.Labelmap,s=o.map(e=>l.cache.getImage(e)),r=s.map(e=>l.cache.getImage(e.referencedImageId)),i=[];let m=0;for(const e of s){const t=new Set,n=e.getPixelData(),{rows:a,columns:o}=e;for(let e=0;e<n.length;e++){const a=n[e];0!==a&&t.add(a)}i[m++]={segmentsOnLabelmap:Array.from(t),pixelData:n,rows:a,columns:o}}const g=i.map(e=>e.segmentsOnLabelmap),u={segmentsOnLabelmap:Array.from(new Set(g.flat())),metadata:[],labelmaps2D:i},p=n.getSegmentation(e),S=n.getRepresentationsForSegmentation(e);Object.entries(p.segments).forEach(([t,a])=>{if(!a)return;const{label:o}=a,s=S[0],r=n.getSegmentColor(s.viewportId,e,a.segmentIndex),i=d.Ay.data.Colors.rgb2DICOMLAB(r.slice(0,3).map(e=>e/255)).map(e=>Math.round(e)),l={SegmentNumber:t.toString(),SegmentLabel:o,SegmentAlgorithmType:a?.algorithmType||"MANUAL",SegmentAlgorithmName:a?.algorithmName||"OHIF Brush",RecommendedDisplayCIELabValue:i,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};u.metadata[t]=l});return w(r,u,l.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=n.getSegmentation(e),a=s.generateSegmentation({segmentationId:e});E(a.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:a,dataSource:o})=>{const i=n.getSegmentation(a);if(!i)throw new Error("No segmentation found");const{label:l}=i,c=o??t.getActiveDataSource()[0],{value:m,dataSourceName:d,action:g}=await(0,b.createReportDialogPrompt)({servicesManager:e,extensionManager:t,title:"Store Segmentation"});if(g===I.A.CREATE_REPORT)try{const e=d?t.getDataSources(d)[0]:c,n=s.generateSegmentation({segmentationId:a,options:{SeriesDescription:m||l||"Research Derived Series"}});if(!n||!n.dataset)throw new Error("Error during segmentation generation");const{dataset:o}=n;return"No Study ID"===o.StudyID&&(o.StudyID=""),await e.store.dicom(o),o.wadoRoot=e.getConfig().wadoRoot,r.H8.addInstances([o],!0),o}catch(e){throw console.debug("Error storing segmentation:",e),e}},downloadRTSS:async({segmentationId:e})=>{const t=n.getSegmentation(e),a=n.getRepresentationsForSegmentation(e)[0];Object.entries(t.segments).forEach(([t,o])=>{o.color=n.getSegmentColor(a.viewportId,e,t)});const o=await h(t,r.Ly.MetadataProvider,r.H8);try{const e=y(o),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}},toggleActiveSegmentationUtility:({itemId:e})=>{const{uiState:t,setUIState:n}=b.useUIStateStore.getState(),a=t.activeSegmentationUtility===e;console.log("toggleActiveSegmentationUtility",a,e),n("activeSegmentationUtility",a?null:e)}},i={loadSegmentationsForViewport:{commandFn:s.loadSegmentationsForViewport},generateSegmentation:{commandFn:s.generateSegmentation},downloadSegmentation:{commandFn:s.downloadSegmentation},storeSegmentation:{commandFn:s.storeSegmentation},downloadRTSS:{commandFn:s.downloadRTSS},toggleActiveSegmentationUtility:{commandFn:s.toggleActiveSegmentationUtility}};return{actions:s,definitions:i,defaultContext:"SEGMENTATION"}};var D=n(37948),C=n(96283),N=n(53860);const{LogicalOperation:U}=N.contourSegmentation,O=[{value:"merge",logicalOperation:U.Union,label:"Merge",icon:"actions-combine-merge",helperIcon:"helper-combine-merge"},{value:"intersect",logicalOperation:U.Intersect,label:"Intersect",icon:"actions-combine-intersect",helperIcon:"helper-combine-intersect"},{value:"subtract",logicalOperation:U.Subtract,label:"Subtract",icon:"actions-combine-subtract",helperIcon:"helper-combine-subtract"}];function T({label:e,value:t,onValueChange:n,segments:a,placeholder:o="Select a segment"}){return s.createElement("div",{className:"flex justify-between gap-6"},s.createElement("div",null,e),s.createElement(C.l6P,{key:`select-segment-${e}`,onValueChange:n,value:t},s.createElement(C.bqE,{className:"overflow-hidden"},s.createElement(C.yvm,{placeholder:o})),s.createElement(C.gCo,null,a.map(e=>s.createElement(C.ebT,{key:e.segmentIndex,value:e.segmentIndex.toString()},e.label)))))}const R=function(){const{servicesManager:e}=(0,r.Jg)(),{segmentationService:t}=e.services,{segmentationsWithRepresentations:n}=(0,D.useActiveViewportSegmentationRepresentations)(),a=n?.find(({representation:e})=>e?.active),o=a?Object.values(a.segmentation.segments):[],i=a?t.getNextAvailableSegmentIndex(a.segmentation.segmentationId):1,l=o.find(e=>e.active),c=l?.segmentIndex||0,[m,d]=(0,s.useState)(O[0]),[g,u]=(0,s.useState)(c?.toString()||""),[p,S]=(0,s.useState)(""),[v,f]=(0,s.useState)(!1),[b,I]=(0,s.useState)("");(0,s.useEffect)(()=>{u(c?.toString()||null)},[c]),(0,s.useEffect)(()=>{I(`Segment ${i}`)},[i]);const y=(0,r.qN)(),w=(0,s.useCallback)(()=>{let e=g;v&&(e=i.toString(),y("addSegment",{segmentationId:a.segmentation.segmentationId,config:{label:b,segmentIndex:i}})),y("applyLogicalContourOperation",{segmentAInfo:{segmentationId:a.segmentation.segmentationId,segmentIndex:parseInt(g)},segmentBInfo:{segmentationId:a.segmentation.segmentationId,segmentIndex:parseInt(p)},resultSegmentInfo:{segmentationId:a.segmentation.segmentationId,segmentIndex:parseInt(e)},logicalOperation:m.logicalOperation})},[a?.segmentation?.segmentationId,v,b,i,m.logicalOperation,y,g,p]);return s.createElement("div",{className:"flex w-[245px] flex-col gap-4"},s.createElement("div",{className:"flex items-start justify-between"},s.createElement("div",{className:"flex w-auto flex-col items-center gap-2 text-base font-normal leading-none"},s.createElement(C.tUM,{value:m.value},s.createElement(C.j7C,{className:"inline-flex space-x-1"},O.map(e=>{const{value:t,icon:n}=e;return s.createElement(C.Xib,{value:t,key:`logical-contour-operation-${t}`,onClick:()=>d(e)},s.createElement(C.FI1.ByName,{name:n}))}))),s.createElement("div",null,m.label)),s.createElement("div",{className:"flex h-[62px] w-[88px] items-center justify-center rounded-lg bg-[rgb(var(--primary-dark))]"},s.createElement(C.FI1.ByName,{name:m.helperIcon}))),s.createElement(T,{label:"A",value:g,onValueChange:u,segments:o}),s.createElement(T,{label:"B",value:p,onValueChange:S,segments:o}),s.createElement("div",{className:"flex justify-end pl-[34px]"},s.createElement(C.$nd,{className:"border-primary/60 grow border",variant:"ghost",onClick:()=>{w()}},m.label)),s.createElement(C.wvv,{className:"bg-input mt-2 h-[1px]"}),s.createElement("div",{className:"flex flex-col gap-2"},s.createElement("div",{className:"flex items-center justify-start gap-2"},s.createElement(C.dOG,{id:"logical-contour-operations-create-new-segment-switch",onCheckedChange:f}),s.createElement(C.JU7,{htmlFor:"logical-contour-operations-create-new-segment-switch"},"Create a new segment")),s.createElement("div",{className:"pl-9"},s.createElement(C.pde,{className:(0,C.cn)(v?"visible":"hidden"),disabled:!v,id:"logical-contour-operations-create-new-segment-input",type:"text",placeholder:"New segment name",value:b,onChange:e=>I(e.target.value)}))))};const M=function(){const[e,t]=(0,s.useState)(10),n=(0,r.qN)();return s.createElement("div",{className:"flex w-auto w-[252px] flex-col gap-[8px] text-base font-normal leading-none"},s.createElement("div",{className:"flex w-auto flex-col gap-[10px] text-base font-normal leading-none"},s.createElement("div",null,"Fill contour holes"),s.createElement(C.$nd,{className:"border-primary/60 border",variant:"ghost",onClick:()=>{n("removeContourHoles")}},"Fill Holes"),s.createElement(C.wvv,{className:"bg-input mt-[20px] h-[1px]"})),s.createElement("div",{className:"flex w-auto flex-col gap-[10px] text-base font-normal leading-none"},s.createElement("div",null,"Remove Small Contours"),s.createElement("div",{className:"flex items-center gap-2 self-end"},s.createElement(C.JU7,{htmlFor:"simplify-contour-options",className:"text-muted-foreground"},"Area Threshold"),s.createElement(C.pde,{id:"simplify-contour-options",className:"w-20",type:"number",value:e,onChange:e=>t(Number(e.target.value))})),s.createElement(C.$nd,{className:"border-primary/60 border",variant:"ghost",onClick:()=>{n("removeSmallContours",{areaThreshold:e})}},"Remove Small Contours"),s.createElement(C.wvv,{className:"bg-input mt-[20px] h-[1px]"})),s.createElement("div",{className:"flex w-auto flex-col gap-[10px] text-base font-normal leading-none"},s.createElement("div",null,"Create New Segment from Holes"),s.createElement(C.$nd,{className:"border-primary/60 border",variant:"ghost",onClick:()=>{n("convertContourHoles")}},"Create New Segment")))};const A=function(){const e=(0,r.qN)();return s.createElement("div",{className:"flex w-auto w-[245px] flex-col gap-[8px] text-base font-normal leading-none"},s.createElement("div",{className:"flex w-auto flex-col gap-[10px] text-base font-normal leading-none"},s.createElement("div",null,"Smooth all edges"),s.createElement(C.$nd,{className:"border-primary/60 border",variant:"ghost",onClick:()=>{e("smoothContours")}},"Smooth Edges"),s.createElement(C.wvv,{className:"bg-input mt-[20px] h-[1px]"})),s.createElement("div",{className:"flex w-auto flex-col gap-[10px] text-base font-normal leading-none"},s.createElement("div",null,"Remove extra points"),s.createElement(C.$nd,{className:"border-primary/60 border",variant:"ghost",onClick:()=>{e("decimateContours")}},"Remove Points")))};function L(){return L=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)({}).hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},L.apply(null,arguments)}const F=s.lazy(()=>n.e(9845).then(n.bind(n,69845))),P=e=>s.createElement(s.Suspense,{fallback:s.createElement("div",null,"Loading...")},s.createElement(F,e)),G={id:a,getCommandsModule:x,getToolbarModule:function({servicesManager:e}){const{segmentationService:t,toolbarService:n,toolGroupService:a}=e.services;return[{name:"cornerstone.SimplifyContourOptions",defaultComponent:M},{name:"cornerstone.LogicalContourOperationsOptions",defaultComponent:R},{name:"cornerstone.SmoothContoursOptions",defaultComponent:A},{name:"cornerstone.isActiveSegmentationUtility",evaluate:({button:e})=>{const{uiState:t}=b.useUIStateStore.getState();return{isActive:t.activeSegmentationUtility===e.id}}},{name:"evaluate.cornerstone.hasSegmentation",evaluate:({viewportId:e})=>{const n=t.getSegmentationRepresentations(e);return{disabled:!n?.length}}},{name:"evaluate.cornerstone.hasSegmentationOfType",evaluate:({viewportId:e,segmentationRepresentationType:n})=>{const a=t.getSegmentationRepresentations(e);return a?.length?a.some(e=>Boolean(e.type===n))?void 0:{disabled:!0,disabledText:`No ${n} segmentations available`}:{disabled:!0,disabledText:"No segmentations available"}}},{name:"evaluate.cornerstone.segmentation",evaluate:({viewportId:e,button:o,toolNames:s,disabledText:r})=>{const i=t.getSegmentationRepresentations(e);if(!i?.length)return{disabled:!0,disabledText:r??"No segmentations available"};const l=t.getActiveSegmentation(e);if(!Object.keys(l.segments).length)return{disabled:!0,disabledText:"Add segment to enable this tool"};const c=a.getToolGroupForViewport(e);if(!c)return{disabled:!0,disabledText:r??"Not available on the current viewport"};if(!s)return{disabled:!1};const m=n.getToolNameForButton(o);if(!c.hasTool(m)&&!s)return{disabled:!0,disabledText:r??"Not available on the current viewport"};return{disabled:!1,isActive:s?s.includes(c.getActivePrimaryMouseButtonTool()):c.getActivePrimaryMouseButtonTool()===m}}}]},getViewportModule:({servicesManager:e,extensionManager:t,commandsManager:n})=>[{name:"dicom-seg",component:a=>s.createElement(P,L({servicesManager:e,extensionManager:t,commandsManager:n},a))}],getSopClassHandlerModule:S,getHangingProtocolModule:f}}}]);
//# sourceMappingURL=4092.bundle.3e5995f87d79914eb314.js.map