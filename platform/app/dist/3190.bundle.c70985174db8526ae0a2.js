(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[3190,5400],{5057:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var i=n(53586),a=n(48080),o=n(92885),s=n(71209);function r(e,t){const n=e.image;if(!e.canvas||!e.image)return;const r=(0,i.A)();if(n.stats={lastGetPixelDataTime:-1,lastStoredPixelDataToCanvasImageDataTime:-1,lastPutImageDataTime:-1,lastRenderTime:-1,lastLutGenerateTime:-1},n){let i=n.render;i||(i=e.viewport.colormap?s.l:n.color?a.f:o.j),i(e,t)}const l=(0,i.A)()-r;n.stats.lastRenderTime=l,e.invalid=!1,e.needsRedraw=!1}},7808:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(45354);function a(e,t){const n=new i.d;if(!e.viewport.displayedArea)return n;n.translate(e.canvas.width/2,e.canvas.height/2);const a=e.viewport.rotation;0!==a&&n.rotate(a*Math.PI/180);let o=e.viewport.scale,s=e.viewport.scale;const r=e.viewport.displayedArea.brhc.x-(e.viewport.displayedArea.tlhc.x-1),l=e.viewport.displayedArea.brhc.y-(e.viewport.displayedArea.tlhc.y-1);if("NONE"===e.viewport.displayedArea.presentationSizeMode)e.image.rowPixelSpacing<e.image.columnPixelSpacing?o*=e.image.columnPixelSpacing/e.image.rowPixelSpacing:e.image.columnPixelSpacing<e.image.rowPixelSpacing&&(s*=e.image.rowPixelSpacing/e.image.columnPixelSpacing);else if(o=e.viewport.displayedArea.columnPixelSpacing,s=e.viewport.displayedArea.rowPixelSpacing,"SCALE TO FIT"===e.viewport.displayedArea.presentationSizeMode){const t=e.canvas.height/(l*s),n=e.canvas.width/(r*o);o=s=Math.min(n,t),e.viewport.displayedArea.rowPixelSpacing<e.viewport.displayedArea.columnPixelSpacing?o*=e.viewport.displayedArea.columnPixelSpacing/e.viewport.displayedArea.rowPixelSpacing:e.viewport.displayedArea.columnPixelSpacing<e.viewport.displayedArea.rowPixelSpacing&&(s*=e.viewport.displayedArea.rowPixelSpacing/e.viewport.displayedArea.columnPixelSpacing)}return n.scale(o,s),0!==a&&n.rotate(-a*Math.PI/180),n.translate(e.viewport.translation.x,e.viewport.translation.y),0!==a&&n.rotate(a*Math.PI/180),void 0!==t&&n.scale(t,t),e.viewport.hflip&&n.scale(-1,1),e.viewport.vflip&&n.scale(1,-1),n.translate(-r/2,-l/2),n}},36931:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(12132),a=n(57162);function o(e,t,n,o){if(void 0===e)throw new Error("getDefaultViewport: parameter canvas must not be undefined");if(void 0===t)return(0,i.A)();const s=(0,a.A)(e,t,0).scaleFactor;let r;return"PT"===n&&t.isPreScaled?r={windowWidth:5,windowCenter:2.5}:void 0!==t.windowWidth&&void 0!==t.windowCenter&&(r={windowWidth:Array.isArray(t.windowWidth)?t.windowWidth[0]:t.windowWidth,windowCenter:Array.isArray(t.windowCenter)?t.windowCenter[0]:t.windowCenter}),{scale:s,translation:{x:0,y:0},voi:r,invert:t.invert,pixelReplication:!1,rotation:0,hflip:!1,vflip:!1,modalityLUT:t.modalityLUT,modality:n,voiLUT:t.voiLUT,colormap:void 0!==o?o:t.colormap,displayedArea:{tlhc:{x:1,y:1},brhc:{x:t.columns,y:t.rows},rowPixelSpacing:void 0===t.rowPixelSpacing?1:t.rowPixelSpacing,columnPixelSpacing:void 0===t.columnPixelSpacing?1:t.columnPixelSpacing,presentationSizeMode:"NONE"}}}},50584:(e,t,n)=>{"use strict";n.d(t,{QV:()=>i.A});n(49038);var i=n(86252);n(90808),n(29625),n(50180),n(1271)},71851:(e,t,n)=>{"use strict";n.d(t,{BlendModes:()=>l.A,CalibrationTypes:()=>u.A,Events:()=>a.A,GenerateImageType:()=>i,GeometryType:()=>c.A,ImageQualityStatus:()=>p.A,InterpolationType:()=>r.A,MeshType:()=>h.A,MetadataModules:()=>f.A,OrientationAxis:()=>d.A,RenderingEngineModeEnum:()=>w.A,RequestType:()=>o.A,VOILUTFunctionType:()=>g.A,VideoEnums:()=>v,ViewportStatus:()=>m.A,ViewportType:()=>s.A});var i,a=n(32643),o=n(43213),s=n(41864),r=n(29310),l=n(63591),d=n(18735),c=n(91346),h=(n(86066),n(32731)),g=n(82501),u=(n(91369),n(38059)),m=n(1814),p=n(77474),v=n(13545),f=n(69850);!function(e){e.SUM="SUM",e.SUBTRACT="SUBTRACT",e.AVERAGE="AVERAGE"}(i||(i={}));n(6796);var w=n(8128)},15327:(e,t,n)=>{"use strict";n.d(t,{BaseVolumeViewport:()=>d.A,CONSTANTS:()=>a,EPSILON:()=>r.p8,Enums:()=>i,ImageVolume:()=>u.QV,Settings:()=>_,StackViewport:()=>c.A,VolumeViewport:()=>l.A,addImageSlicesToViewports:()=>R.ge,addVolumesToViewports:()=>R.x,cache:()=>m.Ay,convertMapperToNotSharedMapper:()=>s.h,createVolumeActor:()=>o.A,eventTarget:()=>h.A,getConfiguration:()=>w.D0,getEnabledElement:()=>v.Ay,getEnabledElementByIds:()=>v.b1,getEnabledElementByViewportId:()=>v.yj,getEnabledElements:()=>v.zb,getRenderingEngine:()=>g.lD,getRenderingEngines:()=>g.qO,getWebWorkerManager:()=>w.G_,imageLoadPoolManager:()=>p.A,imageLoader:()=>y,metaData:()=>f,triggerEvent:()=>x.A,utilities:()=>P,volumeLoader:()=>D});var i=n(71851),a=n(76491),o=(n(90340),n(61640)),s=n(92099),r=n(30135),l=n(94155),d=(n(40893),n(95205)),c=n(79720),h=(n(32501),n(81466),n(10056),n(10364)),g=(n(78337),n(39536)),u=n(50584),m=n(49038),p=(n(91073),n(51159)),v=n(86846),f=n(74876),w=n(26896);const E=Symbol("DefaultSettings"),I=Symbol("RuntimeSettings"),C=Symbol("ObjectSettingsMap"),b=Symbol("Dictionary");class _{constructor(e){const t=Object.create(e instanceof _&&b in e?e[b]:null);Object.seal(Object.defineProperty(this,b,{value:t}))}set(e,t){return A(this[b],e,t,null)}get(e){return function(e,t){return e[t]}(this[b],e)}unset(e){return function(e,t){if(t.endsWith(".")){let n=0;const i=t,a=i.slice(0,-1),o=0===a.length;for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(o||t.startsWith(i)||t===a)&&(delete e[t],++n);return n>0}return delete e[t]}(this[b],e+"")}forEach(e){T(this[b],e)}extend(){return new _(this)}import(e){S(e)&&Object.keys(e).forEach(t=>{A(this[b],t,e[t],null)})}dump(){const e={};return T(this[b],(t,n)=>{void 0!==n&&M(e,t,n)}),e}static assert(e){return e instanceof _?e:_.getRuntimeSettings()}static getDefaultSettings(e=null){let t=_[E];if(t instanceof _||(t=new _,_[E]=t),e){const n={};return t.forEach(i=>{if(i.startsWith(e)){const a=i.split(`${e}.`)[1];n[a]=t.get(i)}}),n}return t}static getRuntimeSettings(){let e=_[I];return e instanceof _||(e=new _(_.getDefaultSettings()),_[I]=e),e}static getObjectSettings(e,t){let n=null;if(e instanceof _)n=e;else if("object"==typeof e&&null!==e){let i=_[C];i instanceof WeakMap||(i=new WeakMap,_[C]=i),n=i.get(e),n instanceof _||(n=new _(_.assert(_.getObjectSettings(t))),i.set(e,n))}return n}static extendRuntimeSettings(){return _.getRuntimeSettings().extend()}}function T(e,t){for(const n in e)t(n,e[n])}function A(e,t,n,i){return!!function(e){let t,n,i;if("string"!=typeof e||(t=e.length-1)<0)return!1;i=-1;for(;(n=e.indexOf(".",i+1))>=0;){if(n-i<2||n===t)return!1;i=n}return!0}(t)&&(S(n)?function(e,t,n,i){let a;if(i.has(n))return A(e,t,null,i);i.add(n),a=0;for(const o in n)Object.prototype.hasOwnProperty.call(n,o)&&(A(e,0===o.length?t:`${t}.${o}`,n[o],i)||++a);return i.delete(n),0===a}(e,t,n,i instanceof WeakSet?i:new WeakSet):(e[t]=n,!0))}function S(e){if("object"==typeof e&&null!==e){const t=Object.getPrototypeOf(e);if(t===Object.prototype||null===t)return!0}return!1}function M(e,t,n){const i=t.indexOf(".");if(i>=0){const a=t.slice(0,i);let o=e[a];if("object"!=typeof o||null===o){const t=o;o={},void 0!==t&&(o[""]=t),e[a]=o}M(o,t.slice(i+1,t.length),n)}else e[t]=n}_.getDefaultSettings().set("useCursors",!0);var D=n(87142),y=n(80068),P=(n(89926),n(36822),n(33592)),x=n(69372),R=(n(55500),n(55509),n(56074),n(40661))},80068:(e,t,n)=>{"use strict";n.r(t),n.d(t,{cancelLoadAll:()=>S,cancelLoadImage:()=>T,cancelLoadImages:()=>A,createAndCacheDerivedImage:()=>C,createAndCacheDerivedImages:()=>b,createAndCacheDerivedLabelmapImage:()=>x,createAndCacheDerivedLabelmapImages:()=>P,createAndCacheLocalImage:()=>_,loadAndCacheImage:()=>E,loadAndCacheImages:()=>I,loadImage:()=>w,registerImageLoader:()=>M,registerUnknownImageLoader:()=>D,unregisterAllImageLoaders:()=>y});var i=n(49038),a=n(32643),o=n(10364),s=n(27119),r=n(99576),l=n(69372),d=n(80221),c=n(24623),h=n(51159),g=n(74876),u=n(6796);const m={};let p;function v(e,t){const n=i.Ay.getImageLoadObject(e);if(n)return f(n.promise,e),n;const a=e.split(":")[0],o=m[a]||p;if(!o)throw new Error(`loadImageFromImageLoader: No image loader found for scheme '${a}'`);const s=o(e,t);return f(s.promise,e),s}function f(e,t){Promise.resolve(e).then(e=>{!function(e){if(!e.voxelManager){const{width:t,height:n,numberOfComponents:i}=e,a=c.A.createImageVoxelManager({scalarData:e.getPixelData(),width:t,height:n,numberOfComponents:i});e.voxelManager=a,e.getPixelData=()=>a.getScalarData(),delete e.imageFrame.pixelData}}(e),(0,l.A)(o.A,a.A.IMAGE_LOADED,{image:e})}).catch(e=>{const n={imageId:t,error:e};(0,l.A)(o.A,a.A.IMAGE_LOAD_FAILED,n)})}function w(e,t={priority:0,requestType:"prefetch"}){if(void 0===e)throw new Error("loadImage: parameter imageId must not be undefined");return v(e,t).promise}function E(e,t={priority:0,requestType:"prefetch"}){if(void 0===e)throw new Error("loadAndCacheImage: parameter imageId must not be undefined");const n=v(e,t);return i.Ay.getImageLoadObject(e)||i.Ay.putImageLoadObject(e,n),n.promise}function I(e,t={priority:0,requestType:"prefetch"}){if(!e||0===e.length)throw new Error("loadAndCacheImages: parameter imageIds must be list of image Ids");return e.map(e=>E(e,t))}function C(e,t={}){if(void 0===e)throw new Error("createAndCacheDerivedImage: parameter imageId must not be undefined");void 0===t.imageId&&(t.imageId=`derived:${(0,d.A)()}`);const{imageId:n,skipCreateBuffer:a,onCacheAdd:o,voxelRepresentation:l}=t,c=g.get("imagePlaneModule",e),h=c.rows*c.columns,{TypedArrayConstructor:u}=(0,r.h)(t.targetBuffer?.type,h),m=new u(a?1:h),p=n,v=g.get("imagePlaneModule",e);s.A.add(p,{type:"imagePlaneModule",metadata:v});const f=g.get("generalSeriesModule",e);s.A.add(p,{type:"generalSeriesModule",metadata:f}),s.A.add(p,{type:"generalImageModule",metadata:{instanceNumber:t.instanceNumber}});const w=g.get("imagePixelModule",e);s.A.add(p,{type:"imagePixelModule",metadata:{...w,bitsAllocated:8,bitsStored:8,highBit:7,samplesPerPixel:1,pixelRepresentation:0}});const E=_(n,{scalarData:m,onCacheAdd:o,skipCreateBuffer:a,targetBuffer:{type:m.constructor.name},voxelRepresentation:l,dimensions:[c.columns,c.rows],spacing:[c.columnPixelSpacing,c.rowPixelSpacing],origin:c.imagePositionPatient,direction:c.imageOrientationPatient,frameOfReferenceUID:c.frameOfReferenceUID,referencedImageId:e});return E.referencedImageId=e,i.Ay.getImageLoadObject(n)||i.Ay.putImageSync(n,E),E}function b(e,t={}){if(0===e.length)throw new Error("createAndCacheDerivedImages: parameter imageIds must be list of image Ids");const n=[];return e.map((e,i)=>{const a={imageId:t?.getDerivedImageId?.(e)||`derived:${(0,d.A)()}`,...t};return n.push(a.imageId),C(e,{...a,instanceNumber:i+1})})}function _(e,t){const{scalarData:n,origin:a,direction:o,targetBuffer:l,skipCreateBuffer:d,onCacheAdd:h,frameOfReferenceUID:g,voxelRepresentation:m,referencedImageId:p}=t,v=t.dimensions,f=t.spacing;if(!v||!f)throw new Error("createAndCacheLocalImage: dimensions and spacing are required");const w=v[0],E=v[1],I=f[0],C=f[1],b={frameOfReferenceUID:g,rows:E,columns:w,imageOrientationPatient:o??[1,0,0,0,1,0],rowCosines:o?o.slice(0,3):[1,0,0],columnCosines:o?o.slice(3,6):[0,1,0],imagePositionPatient:a??[0,0,0],pixelSpacing:[C,I],rowPixelSpacing:C,columnPixelSpacing:I},_=w*E,T=n.length/_;let A,S,M,D;if(n){if(!(n instanceof Uint8Array||n instanceof Float32Array||n instanceof Uint16Array||n instanceof Int16Array))throw new Error("createAndCacheLocalImage: scalarData must be of type Uint8Array, Uint16Array, Int16Array or Float32Array");A=n}else if(!d){const{TypedArrayConstructor:e}=(0,r.h)(l?.type,_);A=new e(_)}if(A instanceof Uint8Array)S=8,M=8,D=7;else if(A instanceof Uint16Array)S=16,M=16,D=15;else if(A instanceof Int16Array)S=16,M=16,D=15;else{if(!(A instanceof Float32Array))throw new Error("Unsupported scalarData type");S=32,M=32,D=31}const y={samplesPerPixel:1,photometricInterpretation:A.length>v[0]*v[1]?"RGB":"MONOCHROME2",rows:E,columns:w,bitsAllocated:S,bitsStored:M,highBit:D},P={imagePlaneModule:b,imagePixelModule:y};["imagePlaneModule","imagePixelModule"].forEach(t=>{s.A.add(e,{type:t,metadata:P[t]||{}})});const x=e,R=m===u.A.RLE&&c.A.createRLEImageVoxelManager({dimensions:v,id:x})||c.A.createImageVoxelManager({height:E,width:w,numberOfComponents:T,scalarData:A,id:x});let L=A[0],O=A[0];for(let e=1;e<A.length;e++)A[e]<L&&(L=A[e]),A[e]>O&&(O=A[e]);const U={imageId:e,intercept:0,windowCenter:0,windowWidth:0,color:"RGB"===y.photometricInterpretation,numberOfComponents:y.samplesPerPixel,dataType:l?.type,slope:1,minPixelValue:L,maxPixelValue:O,rows:y.rows,columns:y.columns,getCanvas:void 0,height:y.rows,width:y.columns,rgba:void 0,columnPixelSpacing:b.columnPixelSpacing,rowPixelSpacing:b.rowPixelSpacing,FrameOfReferenceUID:b.frameOfReferenceUID,invert:!1,getPixelData:()=>R.getScalarData(),voxelManager:R,sizeInBytes:n.byteLength,referencedImageId:p};return h?.(U),i.Ay.putImageSync(U.imageId,U),U}function T(e){h.A.filterRequests(({additionalDetails:t})=>!t.imageId||t.imageId!==e);const t=i.Ay.getImageLoadObject(e);t&&t.cancelFn()}function A(e){e.forEach(e=>{T(e)})}function S(){const e=h.A.getRequestPool();Object.keys(e).forEach(t=>{const n=e[t];Object.keys(n).forEach(e=>{const t=n[e].pop();if(!t)return;const a=t.additionalDetails,{imageId:o,volumeId:s}=a;let r;o?r=i.Ay.getImageLoadObject(o):s&&(r=i.Ay.getVolumeLoadObject(s)),r&&r.cancel()}),h.A.clearRequestStack(t)})}function M(e,t){m[e]=t}function D(e){const t=p;return p=e,t}function y(){Object.keys(m).forEach(e=>delete m[e]),p=void 0}function P(e,t={}){return b(e,{...t,targetBuffer:{type:"Uint8Array"}})}function x(e,t={}){return C(e,{...t,targetBuffer:{type:"Uint8Array"}})}},56750:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});class i{static{this.frameRangeExtractor=/(\/frames\/|[&?]frameNumber=)([^/&?]*)/i}static imageIdToFrames(e){const t=e.match(this.frameRangeExtractor);if(!t||!t[2])return null;const n=t[2].split("-").map(e=>Number(e));return 1===n.length?n[0]:n}static imageIdToFrameEnd(e){const t=this.imageIdToFrames(e);return Array.isArray(t)?t[1]:t}static imageIdToFrameStart(e){const t=this.imageIdToFrames(e);return Array.isArray(t)?t[0]:t}static framesToString(e){return Array.isArray(e)?`${e[0]}-${e[1]}`:String(e)}static framesToImageId(e,t){const n=e.match(this.frameRangeExtractor);if(!n||!n[2])return null;const i=this.framesToString(t);return e.replace(this.frameRangeExtractor,`${n[1]}${i}`)}}},13876:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});class i{constructor(e={}){this._dimensions=3,this._length=0,this._byteSize=4,this.growSize=128;const{initialSize:t=1024,dimensions:n=3,growSize:i=128}=e,a=t*n;this.growSize=i,this.array=new ArrayBuffer(a*this._byteSize),this.data=new Float32Array(this.array),this._dimensions=n}forEach(e){for(let t=0;t<this._length;t++)e(this.getPoint(t),t)}get length(){return this._length}get dimensions(){return this._dimensions}get dimensionLength(){return this._length*this._dimensions}getPoint(e){if(e<0&&(e+=this._length),e<0||e>=this._length)return;const t=this._dimensions*e;return this.data.subarray(t,t+this._dimensions)}getPointArray(e){const t=[];if(e<0&&(e+=this._length),e<0||e>=this._length)return;const n=this._dimensions*e;for(let e=0;e<this._dimensions;e++)t.push(this.data[e+n]);return t}grow(e=1,t=this.growSize){if(this.dimensionLength+e*this._dimensions<=this.data.length)return;const n=this.data.length+t,i=new ArrayBuffer(n*this._dimensions*this._byteSize),a=new Float32Array(i);a.set(this.data),this.data=a,this.array=i}reverse(){const e=Math.floor(this._length/2);for(let t=0;t<e;t++){const e=t*this._dimensions,n=(this._length-1-t)*this._dimensions;for(let t=0;t<this._dimensions;t++){const i=this.data[e+t];this.data[e+t]=this.data[n+t],this.data[n+t]=i}}}getTypedArray(){return this.data}push(e){this.grow(1);const t=this.length*this._dimensions;for(let n=0;n<this._dimensions;n++)this.data[n+t]=e[n];this._length++}map(e){const t=[];for(let n=0;n<this._length;n++)t.push(e(this.getPoint(n),n));return t}get points(){return this.map(e=>e)}toXYZ(){const e={x:[],y:[]};this._dimensions>=3&&(e.z=[]);const{x:t,y:n,z:i}=e;return this.forEach(e=>{t.push(e[0]),n.push(e[1]),i&&i.push(e[2])}),e}static fromXYZ({x:e,y:t,z:n}){const a=i.create3(e.length);let o=0;for(let i=0;i<e.length;i++)a.data[o++]=e[i],a.data[o++]=t[i],a.data[o++]=n?n[i]:0;return a._length=e.length,a}subselect(e=10,t=0){const n=new i({initialSize:e,dimensions:this._dimensions});for(let i=0;i<e;i++){const a=(t+Math.floor(this.length*i/e))%this.length;n.push(this.getPoint(a))}return n}static create3(e=128,t){e=Math.max(e,t?.length||0);const n=new i({initialSize:e,dimensions:3});return t&&t.forEach(e=>n.push(e)),n}static create2(e=128){return new i({initialSize:e,dimensions:2})}}},22191:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});class i{constructor(e){this.name=e||"unknown"}static as(e){if(e.iterator)return e.iterator;const t=new i("as iterator");return e.then(e=>{try{t.add(e,!0)}catch(e){t.reject(e)}},e=>{t.reject(e)}),t}add(e,t=!1){this.nextValue=e,this.done||=t,this.waiting&&(this.waiting.resolve(e),this.waiting=void 0)}resolve(){this.done=!0,this.waiting&&(this.waiting.resolve(this.nextValue),this.waiting=void 0)}reject(e){this.rejectReason=e,this.waiting?.reject(e)}getRecent(){if(this.rejectReason)throw this.rejectReason;return this.nextValue}async*[Symbol.asyncIterator](){for(;!this.done;){if(this.rejectReason)throw this.rejectReason;if(void 0!==this.nextValue&&(yield this.nextValue,this.done))break;this.waiting||(this.waiting={},this.waiting.promise=new Promise((e,t)=>{this.waiting.resolve=e,this.waiting.reject=t})),await this.waiting.promise}yield this.nextValue}async forEach(e,t){let n=0;try{for await(const i of this){const{done:a}=this;try{await e(i,a,n),n++}catch(e){if(!a){console.warn("Caught exception in intermediate value",e);continue}if(!t)throw e;t(e,a)}}}catch(e){if(!t)throw e;t(e,!0)}}generate(e,t){return e(this,this.reject.bind(this)).then(()=>{this.done||this.resolve()},e=>{this.reject(e),t?t(e):console.warn("Couldn't process because",e)})}async nextPromise(){for await(const e of this)if(e)return e;return this.nextValue}async donePromise(){for await(const e of this);return this.nextValue}getNextPromise(){const e=this.nextPromise();return e.iterator=this,e}getDonePromise(){const e=this.donePromise();return e.iterator=this,e}}},67645:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});const i=[[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],a=[[0,-1,0],[0,1,0]],o=[[0,-1,0],[0,1,0],[0,0,-1]],s=[[0,-1,0],[0,1,0],[0,0,1]];class r{static copyMap(e,t){for(const[n,i]of t.rows)e.rows.set(n,structuredClone(i))}constructor(e,t,n=1){this.rows=new Map,this.height=1,this.width=1,this.depth=1,this.jMultiple=1,this.kMultiple=1,this.numComps=1,this.pixelDataConstructor=Uint8Array,this.updateScalarData=function(e){e.fill(0);this.forEach((t,n,i)=>{const{start:a,end:o,value:s}=n;for(let n=a;n<o;n++)e[t+n]=s})},this.get=e=>{const t=e%this.jMultiple,n=(e-t)/this.jMultiple,i=this.getRLE(t,n);return i?.value??this.defaultValue},this.getRun=(e,t)=>{const n=e+t*this.height;return this.rows.get(n)},this.set=(e,t)=>{if(void 0===t)return;const n=e%this.width,i=(e-n)/this.width,a=this.rows.get(i);if(!a)return void this.rows.set(i,[{start:n,end:n+1,value:t}]);const o=this.findIndex(a,n),s=a[o],r=a[o-1];if(!s)return r&&r.value===t&&r.end===n?void r.end++:void(a[o]={start:n,end:n+1,value:t});const{start:l,end:d,value:c}=s;if(t===c&&n>=l)return;const h={start:n,end:n+1,value:t},g=n>l,u=g?o+1:o,m=g?s:r;let p=g?a[o+1]:s;if(m?.value===t&&m?.end===n)return m.end++,void(p?.value===t&&p.start===n+1?(m.end=p.end,a.splice(o,1)):p?.start===n&&(p.start++,p.start===p.end&&(a.splice(o,1),p=a[o],p?.start===n+1&&p.value===t&&(m.end=p.end,a.splice(o,1)))));if(p?.value===t&&p.start===n+1)return p.start--,void(m?.end>n&&(m.end=n,m.end===m.start&&a.splice(o,1)));if(p?.start===n&&p.end===n+1){p.value=t;const e=a[o+1];return void(e?.start==n+1&&e.value===t&&(a.splice(o+1,1),p.end=e.end))}n===p?.start&&p.start++,g&&d>n+1?a.splice(u,0,h,{start:n+1,end:m.end,value:m.value}):a.splice(u,0,h),m?.end>n&&(m.end=n)},this.width=e,this.height=t,this.depth=n,this.jMultiple=e,this.kMultiple=this.jMultiple*t}static{this.getScalarData=function(e=Uint8ClampedArray){const t=new e(this.frameSize);return this.map.updateScalarData(t),t}}toIJK(e){const t=e%this.jMultiple;return[t,(e-t)/this.jMultiple%this.height,Math.floor(e/this.kMultiple)]}toIndex([e,t,n]){return e+n*this.kMultiple+t*this.jMultiple}getRLE(e,t,n=0){const i=this.rows.get(t+n*this.height);if(!i)return;const a=i[this.findIndex(i,e)];return e>=a?.start?a:void 0}has(e){const t=e%this.jMultiple,n=(e-t)/this.jMultiple,i=this.getRLE(t,n);return void 0!==i?.value}delete(e){const t=e%this.width,n=(e-t)/this.width,i=this.rows.get(n);if(!i)return;const a=this.findIndex(i,t),o=i[a];if(!o||o.start>t)return;if(o.end===t+1)return o.end--,void(o.start>=o.end&&(i.splice(a,1),i.length||this.rows.delete(n)));if(o.start===t)return void o.start++;const s={value:o.value,start:t+1,end:o.end};o.end=t,i.splice(a+1,0,s)}findIndex(e,t){for(let n=0;n<e.length;n++){const{end:i}=e[n];if(t<i)return n}return e.length}forEach(e,t){const n=t?.rowModified;for(const[t,i]of this.rows){const a=n?[...i]:i;for(const n of a)e(t*this.width,n,i)}}forEachRow(e){for(const[t,n]of this.rows)e(t*this.width,n)}clear(){this.rows.clear()}keys(){return[...this.rows.keys()]}getPixelData(e=0,t){t?t.fill(0):t=new this.pixelDataConstructor(this.width*this.height*this.numComps);const{width:n,height:i,numComps:a}=this;for(let o=0;o<i;o++){const i=this.getRun(o,e);if(i)if(1===a)for(const e of i){const i=o*n,{start:a,end:s,value:r}=e;for(let e=a;e<s;e++)t[i+e]=r}else for(const e of i){const i=o*n*a,{start:s,end:r,value:l}=e;for(let e=s;e<r;e+=a)for(let n=0;n<a;n++)t[i+e+n]=l[n]}}return t}floodFill(e,t,n,i,a){const o=this.getRLE(e,t,n);if(!o)throw new Error(`Initial point ${e},${t},${n} isn't in the RLE`);const s=[[o,t,n]],r=o.value;if(r===i)throw new Error(`source (${r}) and destination (${i}) are identical`);return this.flood(s,r,i,a)}flood(e,t,n,i){let a=0;const{planar:o=!0,diagonals:s=!0,singlePlane:r=!1}=i||{},l={planar:o,diagonals:s,singlePlane:r};for(;e.length;){const i=e.pop(),[o]=i;if(o.value!==t)continue;o.value=n,a+=o.end-o.start;const s=this.findAdjacents(i,l).filter(e=>e&&e[0].value===t);e.push(...s)}return a}fillFrom(e,t){for(let n=t[2][0];n<=t[2][1];n++)for(let i=t[1][0];i<=t[1][1];i++){let a,o;for(let s=t[0][0];s<=t[0][1];s++){const t=e(s,i,n);void 0!==t?(o||(o=[],this.rows.set(i+n*this.height,o)),a&&a.value!==t&&(a=void 0),a||(a={start:s,end:s,value:t},o.push(a)),a.end++):a=void 0}}}findAdjacents(e,{diagonals:t=!0,planar:n=!0,singlePlane:r=!1}){const[l,d,c,h]=e,{start:g,end:u}=l,m=g>0&&this.getRLE(g-1,d,c),p=u<this.width&&this.getRLE(u,d,c),v=t?[g>0?g-1:g,u<this.width?u+1:u]:[g,u],f=[];m&&f.push([m,d,c]),p&&f.push([p,d,c]);for(const e of h||(r?a:i)){const[,t,l]=e,g=t+d,u=l+c;if(g<0||g>=this.height)continue;if(u<0||u>=this.depth)continue;const m=this.getRun(g,u);if(m)for(const e of m){const t=h||r&&a||n&&l>0&&s||n&&l<0&&o||i;e.end<=v[0]||e.start>=v[1]||f.push([e,g,u,t])}}return f}}},98039:(e,t,n)=>{"use strict";function i(e){return a(e,"vtkVolume")||a(e,"vtkImageSlice")}function a(e,t){const n="isA"in e?e:e.actor;return!!n&&!!n.isA(t)}n.d(t,{N:()=>a,e:()=>i})},96833:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(642),a=n(99341);function o(e,t){const n=t.colorTransfer.split(" ").splice(1).map(parseFloat),{shiftRange:o}=function(e){let t=1/0,n=-1/0;for(let i=0;i<e.length;i+=4)t=Math.min(t,e[i]),n=Math.max(n,e[i]);const i=(n-t)/2;return{shiftRange:[-i,i],min:t,max:n}}(n),s=o[0],r=o[1]-o[0],l=i.Ay.newInstance(),d=[];for(let e=0;e<n.length;e+=4){let t=n[e];const i=n[e+1],a=n[e+2],o=n[e+3];t=(t-s)/r,d.push([t,i,a,o])}!function(e,t,n){const i=t[1]-t[0],a=e.map(([e,n,a,o])=>[e*i+t[0],n,a,o]);n.removeAllPoints(),a.forEach(([e,t,i,a])=>n.addRGBPoint(e,t,i,a))}(d,o,l),e.getProperty().setRGBTransferFunction(0,l);const c=t.scalarOpacity.split(" ").splice(1).map(parseFloat),h=a.Ay.newInstance(),g=[];for(let e=0;e<c.length;e+=2){let t=c[e];const n=c[e+1];t=(t-s)/r,g.push([t,n])}!function(e,t,n){const i=t[1]-t[0],a=e.map(([e,n])=>[e*i+t[0],n]);n.removeAllPoints(),a.forEach(([e,t])=>n.addPoint(e,t))}(g,o,h);const u=e.getProperty();u.setScalarOpacity(0,h);const[m,p,v,f]=t.gradientOpacity.split(" ").splice(1).map(parseFloat);u.setUseGradientOpacity(0,!0),u.setGradientOpacityMinimumValue(0,m),u.setGradientOpacityMinimumOpacity(0,p),u.setGradientOpacityMaximumValue(0,v),u.setGradientOpacityMaximumOpacity(0,f),"1"===t.interpolation&&u.setInterpolationTypeToFastLinear(),u.setShade("1"===t.shade);const w=parseFloat(t.ambient),E=parseFloat(t.diffuse),I=parseFloat(t.specular),C=parseFloat(t.specularPower);u.setAmbient(w),u.setDiffuse(E),u.setSpecular(I),u.setSpecularPower(C)}},91979:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(39536),a=n(24724);const o=e=>{const t=function(e){const t=(0,i.qO)(),n=[];return t.forEach(t=>{const i=(0,a.A)(e);i.length&&n.push({renderingEngine:t,viewportIds:i.map(e=>e.id)})}),n}(e);t?.length&&t.forEach(({renderingEngine:e,viewportIds:t})=>{e.hasBeenDestroyed||e.renderViewports(t)})}},89131:(e,t,n)=>{"use strict";n.d(t,{KP:()=>s,SJ:()=>o});var i=n(74876),a=n(71851);function o(e){const t={...i.get(a.MetadataModules.IMAGE_PLANE,e)};return t.columnPixelSpacing||(t.columnPixelSpacing=1),t.rowPixelSpacing||(t.rowPixelSpacing=1),t.columnCosines||(t.columnCosines=[0,1,0]),t.rowCosines||(t.rowCosines=[1,0,0]),t.imagePositionPatient||(t.imagePositionPatient=[0,0,0]),t.imageOrientationPatient||(t.imageOrientationPatient=new Float32Array([1,0,0,0,1,0])),t}function s(e){const t=e.imageId,{pixelRepresentation:n,bitsAllocated:s,bitsStored:r,highBit:l,photometricInterpretation:d,samplesPerPixel:c}=i.get("imagePixelModule",t),{windowWidth:h,windowCenter:g,voiLUTFunction:u}=e,{modality:m}=i.get("generalSeriesModule",t),p=i.get("scalingModule",t),v=i.get(a.MetadataModules.CALIBRATION,t),f=function(e){return Object.values(a.VOILUTFunctionType).includes(e)?e:a.VOILUTFunctionType.LINEAR}(u);return{calibration:v,scalingFactor:p,voiLUTFunction:f,modality:m,imagePlaneModule:o(t),imagePixelModule:{bitsAllocated:s,bitsStored:r,samplesPerPixel:c,highBit:l,photometricInterpretation:d,pixelRepresentation:n,windowWidth:h,windowCenter:g,modality:m,voiLUTFunction:f}}}},42384:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n(3823),a=n(74876),o=n(26896);function s(e){const{imagePositionPatient:t,imageOrientationPatient:n}=a.get("imagePlaneModule",e[0]),s=i.eR.fromValues(n[0],n[1],n[2]),r=i.eR.fromValues(n[3],n[4],n[5]),l=i.eR.create();i.eR.cross(l,s,r);const d=i.eR.fromValues(t[0],t[1],t[2]);let c;function h(e){const{imagePositionPatient:t}=a.get("imagePlaneModule",e),n=i.eR.create(),o=i.eR.fromValues(t[0],t[1],t[2]);return i.eR.sub(n,d,o),i.eR.dot(n,l)}if("wadouri"===e[0].split(":")[0]){const t=[e[0],e[Math.floor(e.length/2)]],n=(h(t[0]),h(t[1]),a.get("imagePlaneModule",t[1]));if(!n)throw new Error("Incomplete metadata required for volume construction.");const o=i.eR.create(),s=i.eR.fromValues(n.imagePositionPatient[0],n.imagePositionPatient[1],n.imagePositionPatient[2]);i.eR.sub(o,d,s);const r=i.eR.dot(o,l);c=Math.abs(r)/Math.floor(e.length/2)}else{const t=e.map(e=>({distance:h(e),imageId:e}));t.sort((e,t)=>t.distance-e.distance);const n=t.length;c=Math.abs(t[n-1].distance-t[0].distance)/(n-1)}const{sliceThickness:g,spacingBetweenSlices:u}=a.get("imagePlaneModule",e[0]),{strictZSpacingForVolumeViewport:m}=(0,o.D0)().rendering;return 0!==c&&!isNaN(c)||m||(u?(console.debug("Could not calculate spacing. Using spacingBetweenSlices"),c=u):g?(console.debug("Could not calculate spacing and no spacingBetweenSlices. Using sliceThickness"),c=g):(console.debug("Could not calculate spacing. The VolumeViewport visualization is compromised. Setting spacing to 1 to render"),c=1)),c}},84061:(e,t,n)=>{"use strict";function i(e,t,n){return Math.max(t,Math.min(n,e))}n.d(t,{A:()=>i,q:()=>i})},13859:(e,t,n)=>{"use strict";n.r(t),n.d(t,{findMatchingColormap:()=>g,getColormap:()=>c,getColormapNames:()=>h,getMaxOpacity:()=>w,getThresholdValue:()=>f,registerColormap:()=>d,setColorMapTransferFunctionForVolumeActor:()=>u,updateOpacity:()=>m,updateThreshold:()=>p});var i=n(660),a=n(642),o=n(99341),s=n(74638),r=n(98039);const l=new Map;function d(e){e.name=e.name||e.Name,l.set(e.name,e)}function c(e){return l.get(e)}function h(){return Array.from(l.keys())}function g(e,t){const n=i.A.rgbPresetNames.map(e=>i.A.getPresetByName(e)),a=h().map(e=>c(e)),o=n.concat(a).find(t=>{const{RGBPoints:n}=t;if(n.length!==e.length)return!1;for(let t=0;t<n.length;t+=4)if(!(0,s.Ay)(n.slice(t+1,t+4),e.slice(t+1,t+4)))return!1;return!0});if(!o)return null;const l=[];if((0,r.N)(t,"vtkVolume")){const e=t.getProperty().getScalarOpacity(0).getDataPointer();if(!e)return{name:o.Name};for(let t=0;t<e.length;t+=2)l.push({value:e[t],opacity:e[t+1]})}return{name:o.Name,...Array.isArray(l)&&l.length>0&&{opacity:l},..."number"==typeof l&&{opacity:l}}}function u(e){const{volumeActor:t,preset:n,opacity:o=.9,threshold:s=null,colorRange:r=[0,5]}=e;t.getMapper().setSampleDistance(1);const l=a.Ay.newInstance(),d=n||i.A.getPresetByName("hsv");l.applyColorMap(d),l.setMappingRange(r[0],r[1]),t.getProperty().setRGBTransferFunction(0,l),v(t,o,s)}function m(e,t){v(e,t,f(e))}function p(e,t){v(e,w(e),t)}function v(e,t,n){const i=e.getMapper().getInputData().get("voxelManager");if(!i?.voxelManager)throw new Error("No voxel manager was found for the volume actor, or you cannot yet update opacity with a threshold using stacked images");const a=i.voxelManager.getRange(),s=o.Ay.newInstance();if(null!==n){const e=.001*Math.abs(a[1]-a[0]),i=Math.max(a[0],Math.min(a[1],n));s.addPoint(a[0],0),s.addPoint(i-e,0),s.addPoint(i,t),s.addPoint(a[1],t)}else s.addPoint(a[0],t),s.addPoint(a[1],t);e.getProperty().setScalarOpacity(0,s)}function f(e){const t=e.getProperty().getScalarOpacity(0);if(!t)return null;const n=t.getDataPointer();if(!n||n.length<=4)return null;for(let e=0;e<n.length-2;e+=2){n[e];const t=n[e+1],i=n[e+2],a=n[e+3];if(0===t&&a>0)return i}return null}function w(e){const t=e.getProperty().getScalarOpacity(0);if(!t)return 1;const n=t.getDataPointer();if(!n||0===n.length)return 1;let i=0;for(let e=1;e<n.length;e+=2)n[e]>i&&(i=n[e]);return i}},74657:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(642);function a(e){const t=i.Ay.newInstance();let n=0,a=1024;return void 0!==e.lower&&void 0!==e.upper&&(n=e.lower,a=e.upper),t.addRGBPoint(n,0,0,0),t.addRGBPoint(a,1,1,1),t}},40256:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var i=n(642),a=n(42008),o=n(68136),s=n(58977);function r(e,t=1024){const{windowWidth:n,windowCenter:r}=o.toWindowLevel(e.lower,e.upper),l=Array.from({length:t},(e,n)=>(n+1)/(t+2)).flatMap(e=>[(0,s.i)(e,r,n),e,e,e,.5,0]),d=i.Ay.newInstance();return d.buildFunctionFromArray(a.Ay.newInstance({values:l,numberOfComponents:6})),d}},63470:(e,t,n)=>{"use strict";function i(e,t,n=0){const i=[];for(let a=n;a<e.length;a+=t)i.push(a);return i}n.d(t,{A:()=>i})},99949:(e,t,n)=>{"use strict";function i(e){if(null===e||"object"!=typeof e)return e;if("function"==typeof e)return e;if("function"==typeof structuredClone)return e;if(Array.isArray(e))return e.map(i);{const t={};for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=i(e[n]));return t}}n.d(t,{G:()=>i})},20286:(e,t,n)=>{"use strict";function i(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return(t>>>0).toString(36)}n.d(t,{A:()=>i})},88619:(e,t,n)=>{"use strict";n.d(t,{A:()=>d});var i=n(3823),a=n(74876),o=n(7608),s=n(85008),r=n(76491);const l=o.coreLog.getLogger("utilities","getClosestImageId");function d(e,t,n,o){const{direction:d,spacing:c,imageIds:h}=e,{ignoreSpacing:g=!1}=o||{};if(!h?.length)return;const u=d.slice(6,9),m=i.eR.dot(u,n);if(Math.abs(m)<1-r.EPSILON)return;let p,v;if(!g){p=(0,s.A)({direction:d,spacing:c},n)/2}let f=1/0;for(let e=0;e<h.length;e++){const o=h[e],s=a.get("imagePlaneModule",o);if(!s?.imagePositionPatient){l.warn(`Missing imagePositionPatient for imageId: ${o}`);continue}const{imagePositionPatient:r}=s,d=i.eR.create();i.eR.sub(d,t,r);const c=Math.abs(i.eR.dot(d,n));g?c<f&&(f=c,v=o):c<p&&c<f&&(f=c,v=o)}return void 0===v&&l.warn("No imageId found within the specified criteria (half spacing or absolute closest)."),v}},53932:(e,t,n)=>{"use strict";n.d(t,{T:()=>s});var i=n(3823),a=n(76491),o=n(89131);function s(e){const{imagePlaneModule:t,imagePixelModule:n,voiLUTFunction:s,modality:r,scalingFactor:l,calibration:d}=(0,o.KP)(e);let{rowCosines:c,columnCosines:h}=t;null!=c&&null!=h||(c=[1,0,0],h=[0,1,0]);const g=i.eR.fromValues(c[0],c[1],c[2]),u=i.eR.fromValues(h[0],h[1],h[2]),m=i.eR.create();i.eR.cross(m,g,u);let p=t.imagePositionPatient;null==p&&(p=[0,0,0]);const v=t.columnPixelSpacing||e.columnPixelSpacing,f=t.rowPixelSpacing||e.rowPixelSpacing,w=e.columns,E=e.rows,I=a.EPSILON;n.photometricInterpretation||e.sizeInBytes!==3*e.width*e.height||(e.numberOfComponents=3);return{numberOfComponents:e.numberOfComponents||function(e){let t=1;("RGB"===e||e?.includes("YBR")||"PALETTE COLOR"===e)&&(t=3);return t}(n.photometricInterpretation),origin:p,direction:[...g,...u,...m],dimensions:[w,E,1],spacing:[v,f,I],numVoxels:w*E*1,imagePlaneModule:t,imagePixelModule:n,bitsAllocated:n.bitsAllocated,voiLUTFunction:s,modality:r,scalingFactor:l,calibration:d,scanAxisNormal:m}}},47476:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(20537),a=n(65292);const o=function(e){const t=e.getCamera(),{spacingInNormalDirection:n,imageVolume:o}=(0,a.A)(e,t);if(!o)return;const{viewPlaneNormal:s,focalPoint:r}=t,l=e.getActors().find(e=>e.referencedId===o.volumeId||e.uid===o.volumeId);l||console.warn("No actor found for with actorUID of",o.volumeId);const d=l.actor,c=(0,i.A)(d,s,r),{min:h,max:g,current:u}=c,m=Math.round((g-h)/n)+1;let p=(u-h)/(g-h)*m;return p=Math.floor(p),p>m-1?p=m-1:p<0&&(p=0),{numberOfSlices:m,imageIndex:p}}},32173:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(74876);function a(e){const t=i.get("modalityLutModule",e)||{},n=i.get("generalSeriesModule",e)||{},{modality:a}=n,o={rescaleSlope:t.rescaleSlope||1,rescaleIntercept:t.rescaleIntercept??0,modality:a},s=i.get("scalingModule",e)||{};return{...o,..."PT"===a&&{suvbw:s.suvbw,suvbsa:s.suvbsa,suvlbm:s.suvlbm},..."RTDOSE"===a&&{doseGridScaling:s.DoseGridScaling,doseSummation:s.DoseSummation,doseType:s.DoseType,doseUnit:s.DoseUnit}}}},20537:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n(89265),a=n(15105),o=n(76491);const s=o.EPSILON*o.EPSILON,r=e=>Math.abs(Math.abs(e)-1)<s,l=(e,t)=>r(e[t])||r(e[t+1])||r(e[t+2]),d=e=>l(e,0)&&l(e,3)&&l(e,6);function c(e,t,n){const o=e.getMapper().getInputData();let s;const r=o.getDirection();if(d(r))s=(0,a.A)(e);else{const[e,t,n]=o.getDimensions();s=[[0,0,0],[e-1,0,0],[0,t-1,0],[e-1,t-1,0],[0,0,n-1],[e-1,0,n-1],[0,t-1,n-1],[e-1,t-1,n-1]].map(e=>o.indexToWorld(e))}const l=i.A.buildFromDegree().identity().rotateFromDirections(t,[1,0,0]);s.forEach(e=>l.apply(e));const c=[...n];l.apply(c);const h=c[0];let g=1/0,u=-1/0;for(let e=0;e<8;e++){const t=s[e][0];t>u&&(u=t),t<g&&(g=t)}return{min:g,max:u,current:h,actor:e,viewPlaneNormal:t,focalPoint:n}}},85008:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(3823);function a(e,t){const{direction:n,spacing:a}=e,o=n.slice(0,3),s=n.slice(3,6),r=n.slice(6,9),l=[i.eR.dot(o,t),i.eR.dot(s,t),i.eR.dot(r,t)],d=i.eR.create();i.eR.set(d,l[0]*a[0],l[1]*a[1],l[2]*a[2]);return i.eR.length(d)}},65292:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n(49038),a=n(76491),o=n(85008),s=n(87142),r=n(12437);const l=1+a.EPSILON,d=e=>!!(0,s.getVolumeLoaderSchemes)().find(t=>{return n=e.volumeId,(i=t)===n.substring(0,Math.min(n.length,i.length));var n,i});function c(e,t,n,a=!1){const{viewPlaneNormal:o}=t,s=e.getActors();if(!s.length)return{spacingInNormalDirection:null,imageVolume:null,actorUID:null};const c=s.map(e=>{const t=e.referencedId??e.uid;return i.Ay.getVolume(t)}).filter(e=>!!e);if(n){const t=(0,r.A)(n),i=c.findIndex(e=>t.includes(e.volumeId)),l=c[i],{uid:d}=s[i];return{imageVolume:l,spacingInNormalDirection:h(l,o,e,a),actorUID:d}}if(!c.length)return{spacingInNormalDirection:null,imageVolume:null,actorUID:null};const g={spacingInNormalDirection:1/0,imageVolume:null,actorUID:null},u=c.find(d);for(let t=0;t<c.length;t++){const n=c[t];if(u&&!d(n))continue;const i=h(n,o,e);i*l<g.spacingInNormalDirection&&(g.spacingInNormalDirection=i,g.imageVolume=n,g.actorUID=s[t].uid)}return g}function h(e,t,n,i=!1){const{slabThickness:a}=n.getProperties();let s=a;return a&&i||(s=(0,o.A)(e,t)),s}},24724:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(39536);const a=function(e){const t=(0,i.qO)(),n=[];return t.forEach(t=>{const i=t.getVolumeViewports().filter(t=>t.hasVolumeId(e));n.push(...i)}),n}},70210:(e,t,n)=>{"use strict";function i(e){let t=[];const[n,i]=e.getRange();e.getTable(n,i,1024,t),t=t.filter((e,t)=>t%3==0);const a=[...Array(1024).keys()].map((e,t)=>n+(i-n)/1023*t),o=t[256],s=Math.log((1-o)/o),r=a[256],l=t[768],d=Math.log((1-l)/l),c=a[768],h=Math.round(4*(c-r)/(s-d)),g=Math.round(r+h*s/4);return[Math.round(g-h/2),Math.round(g+h/2)]}n.d(t,{A:()=>i})},15105:(e,t,n)=>{"use strict";function i(e){const t=e.getMapper().getInputData(),n=t.extentToBounds(t.getExtent());return[[n[0],n[2],n[4]],[n[0],n[2],n[5]],[n[0],n[3],n[4]],[n[0],n[3],n[5]],[n[1],n[2],n[4]],[n[1],n[2],n[5]],[n[1],n[3],n[4]],[n[1],n[3],n[5]]]}n.d(t,{A:()=>i})},12437:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i=e=>{const t="volumeId:",n=e.includes(t)?e.substring(9):e,i=n.indexOf("sliceIndex=");return-1===i?n:n.substring(0,i-1)}},4031:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(20537),a=n(65292);const o=function(e,t,n=!1){const o=e.getCamera(),{focalPoint:s,viewPlaneNormal:r}=o,{spacingInNormalDirection:l,actorUID:d}=(0,a.A)(e,o,t,n);if(!d)throw new Error(`Could not find image volume with id ${t} in the viewport`);const c=e.getActor(d);if(!c)return console.warn("No actor found for with actorUID of",d),null;const h=c.actor;return{sliceRange:(0,i.A)(h,r,s),spacingInNormalDirection:l,camera:o}}},61375:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(4031);const a=function(e,t,n=!1){const{sliceRange:a,spacingInNormalDirection:o,camera:s}=(0,i.A)(e,t,n),{min:r,max:l,current:d}=a,c=Math.round((l-r)/o),h=(d-r)/(l-r)*c;return{numScrollSteps:c,currentStepIndex:Math.round(h),sliceRangeInfo:{sliceRange:a,spacingInNormalDirection:o,camera:s}}}},30169:(e,t,n)=>{"use strict";n.d(t,{a:()=>i});const i=e=>Object.values(e).some(e=>"number"==typeof e&&!Number.isInteger(e))},38883:(e,t,n)=>{"use strict";function i(e){return Array.isArray(e)?e.some(e=>Number.isNaN(e)):Number.isNaN(e)}n.d(t,{A:()=>i})},39537:(e,t,n)=>{"use strict";function i(e){const t=e.indexOf(":");return e.substring(t+1)}n.d(t,{A:()=>i})},17791:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var i=n(74876);const a=new Map,o="imageRetrieveConfiguration",s={IMAGE_RETRIEVE_CONFIGURATION:o,clear:()=>{a.clear()},add:(e,t)=>{a.set(e,t)},clone:()=>new Map(a),restore:e=>{a.clear(),e.forEach((e,t)=>{a.set(t,e)})},get:(e,...t)=>{if(e===o)return t.map(e=>a.get(e)).find(e=>void 0!==e)}};(0,i.addProvider)(s.get.bind(s));const r=s},33592:(e,t,n)=>{"use strict";n.r(t),n.d(t,{FrameRange:()=>pt.A,HistoryMemo:()=>a,PointsManager:()=>Ae.A,ProgressiveIterator:()=>Ne.A,RLEVoxelMap:()=>qe.A,VoxelManager:()=>je.A,actorIsA:()=>he.N,applyPreset:()=>Te.A,asArray:()=>Q,autoLoad:()=>Dt.A,buildMetadata:()=>wt.KP,calculateNeighborhoodStats:()=>Wt,calculateSpacingBetweenImageIds:()=>Nt.A,calculateViewportsSpatialRegistration:()=>Ie,calibratedPixelSpacingMetadataProvider:()=>T,clamp:()=>A.A,clip:()=>Rt,color:()=>s,colormap:()=>dt,convertStackToVolumeViewport:()=>$e,convertToGrayscale:()=>et,convertVolumeToStackViewport:()=>Ye,createLinearRGBTransferFunction:()=>g.A,createSigmoidRGBTransferFunction:()=>c.A,createSubVolume:()=>Ut,decimate:()=>Ve.A,deepClone:()=>Pt.G,deepEqual:()=>mt,deepMerge:()=>Se.A,eventListener:()=>i,fnv1aHash:()=>vt.A,generateVolumePropsFromImageIds:()=>Fe.D,genericMetadataProvider:()=>Le.A,getBufferConfiguration:()=>Ge.h,getClosestImageId:()=>M.A,getClosestStackImageIndexForPoint:()=>me,getCurrentVolumeViewportSlice:()=>ve,getDynamicVolumeInfo:()=>Mt,getImageDataMetadata:()=>ft.T,getImageLegacy:()=>Pe,getImageSliceDataForVolumeViewport:()=>ce.A,getMinMax:()=>v,getPixelSpacingInformation:()=>Ht,getRandomSampleFromArray:()=>it,getRuntimeId:()=>C,getScalingParameters:()=>Me.A,getSliceRange:()=>le.A,getSpacingInNormalDirection:()=>D.A,getTargetVolumeAndSpacingInNormalDir:()=>y.A,getViewportImageCornersInWorld:()=>Ce,getViewportImageIds:()=>nt,getViewportModality:()=>Ft,getViewportsWithImageURI:()=>ge,getViewportsWithVolumeId:()=>O.A,getVoiFromSigmoidRGBTransferFunction:()=>h.A,getVolumeActorCorners:()=>P.A,getVolumeDirectionVectors:()=>kt,getVolumeId:()=>ot.A,getVolumeSliceRangeInfo:()=>se.A,getVolumeViewportScrollInfo:()=>re.A,getVolumeViewportsContainingSameVolumes:()=>L,hasFloatScalingParameters:()=>st.a,hasNaNValues:()=>_e.A,imageIdToURI:()=>b.A,imageRetrieveMetadataProvider:()=>We.A,imageToWorldCoords:()=>oe,indexWithinDimensions:()=>x,invertRgbTransferFunction:()=>d.A,isEqual:()=>Oe.n4,isEqualAbs:()=>Oe.Ph,isEqualNegative:()=>Oe.WC,isImageActor:()=>he.e,isNumber:()=>Oe.Et,isOpposite:()=>S,isPTPrescaledWithSUV:()=>z,isValidVolume:()=>Ue,isVideoTransferSyntax:()=>He,jumpToSlice:()=>Ot,loadImageToCanvas:()=>K,logger:()=>Vt,makeVolumeMetadata:()=>Re.A,planar:()=>ue,pointInShapeCallback:()=>rt.ii,renderToCanvasCPU:()=>j,renderToCanvasGPU:()=>X,roundNumber:()=>Qe,roundToPrecision:()=>Je,scaleArray:()=>yt,scaleRgbTransferFunction:()=>u,scroll:()=>Lt,snapFocalPointToSlice:()=>de.A,sortImageIdsAndGetSpacing:()=>xe.A,spatialRegistrationMetadataProvider:()=>Ee,splitImageIdsBy4DTags:()=>St,transferFunctionUtils:()=>ct,transformIndexToWorld:()=>k.A,transformWorldToIndex:()=>U.A,transformWorldToIndexContinuous:()=>U.p,triggerEvent:()=>m.A,updatePlaneRestriction:()=>Gt.O,updateVTKImageDataWithCornerstoneImage:()=>ke.J,uuidv4:()=>p.A,windowLevel:()=>lt,worldToImageCoords:()=>ae});var i={};n.r(i),n.d(i,{MultiTargetEventListenerManager:()=>l,TargetEventListeners:()=>r});var a={};n.r(a),n.d(a,{DefaultHistoryMemo:()=>ie,HistoryMemo:()=>ne});var o,s={};n.r(s),n.d(s,{hexToRgb:()=>ut,rgbToHex:()=>gt}),function(e){e[e.None=0]="None",e[e.Capture=1]="Capture",e[e.Bubble=2]="Bubble"}(o||(o={}));class r{constructor(e){this._eventListeners=new Map,this._children=new Map,this._target=e}get isEmpty(){return 0===this._eventListeners.size&&0===this._children.size}addEventListener(e,t,n){const i=e.indexOf(".");if(-1!==i){const a=e.substring(0,i);let o=this._children.get(a);o||(o=new r(this._target),this._children.set(a,o)),e=e.substring(i+1),o.addEventListener(e,t,n)}else this._addEventListener(e,t,n)}removeEventListener(e,t,n){const i=e.indexOf(".");if(-1!==i){const a=e.substring(0,i),o=this._children.get(a);if(!o)return;e=e.substring(i+1),o.removeEventListener(e,t,n),o.isEmpty&&this._children.delete(a)}else this._removeEventListener(e,t,n)}reset(){Array.from(this._children.entries()).forEach(([e,t])=>{if(t.reset(),!t.isEmpty)throw new Error("Child is not empty and cannot be removed");this._children.delete(e)}),this._unregisterAllEvents()}_addEventListener(e,t,n){let i=this._eventListeners.get(e);i||(i=new Map,this._eventListeners.set(e,i));const a=n?.capture??!1?o.Capture:o.Bubble,s=i.get(t)??o.None;s&a?console.warn("A listener is already registered for this phase"):(i.set(t,s|a),this._target.addEventListener(e,t,n))}_removeEventListener(e,t,n){const i=n?.capture??!1?o.Capture:o.Bubble,a=this._eventListeners.get(e);if(!a)return;(t?[t]:Array.from(a.keys())).forEach(t=>{const s=a.get(t)??o.None;if(!!!(s&i))return;this._target.removeEventListener(e,t,n);const r=s^i;r===o.None?a.delete(t):a.set(t,r)}),a.size||this._eventListeners.delete(e)}_unregisterAllListeners(e,t){Array.from(t.entries()).forEach(([t,n])=>{for(let i=o.Capture;n;i<<=1){if(!(n&i))continue;const a=i===o.Capture;this.removeEventListener(e,t,{capture:a}),n^=i}})}_unregisterAllEvents(){Array.from(this._eventListeners.entries()).forEach(([e,t])=>{this._unregisterAllListeners(e,t)})}}class l{constructor(){this._targetsEventListeners=new Map}addEventListener(e,t,n,i){let a=this._targetsEventListeners.get(e);a||(a=new r(e),this._targetsEventListeners.set(e,a)),a.addEventListener(t,n,i)}removeEventListener(e,t,n,i){const a=this._targetsEventListeners.get(e);a&&(a.removeEventListener(t,n,i),a.isEmpty&&this._targetsEventListeners.delete(e))}reset(){Array.from(this._targetsEventListeners.entries()).forEach(([e,t])=>{t.reset(),this._targetsEventListeners.delete(e)})}}var d=n(50134),c=n(40256),h=n(70210),g=n(74657);function u(e,t){const n=e.getSize();for(let i=0;i<n;i++){const n=[];e.getNodeValue(i,n),n[1]=n[1]*t,n[2]=n[2]*t,n[3]=n[3]*t,e.setNodeValue(i,n)}}var m=n(69372),p=n(80221);function v(e){let t,n=e[0],i=e[0];const a=e.length;for(let o=1;o<a;o++)t=e[o],n=Math.min(n,t),i=Math.max(i,t);return{min:n,max:i}}const f=Symbol("LastRuntimeId"),w={},E=4294967295,I="-";function C(e,t,n){return function(e,t,n){let i=e[t];i instanceof Array||(i=[0],Object.defineProperty(e,t,{value:i}));for(let e=!0,t=0;e&&t<i.length;++t){let a=0|i[t];a<n?(e=!1,a+=1):(a=0,t+1===i.length&&i.push(0)),i[t]=a}return i}(null!==e&&"object"==typeof e?e:w,f,("number"==typeof n&&n>0?n:E)>>>0).join("string"==typeof t?t:I)}var b=n(39537);const _={},T={add:(e,t)=>{const n=(0,b.A)(e);_[n]=t},get:(e,t)=>{if("calibratedPixelSpacing"===e){const e=(0,b.A)(t);return _[e]}}};var A=n(84061);function S(e,t,n=1e-5){return Math.abs(e[0]+t[0])<n&&Math.abs(e[1]+t[1])<n&&Math.abs(e[2]+t[2])<n}var M=n(88619),D=n(85008),y=n(65292),P=n(15105);function x(e,t){return!(e[0]<0||e[0]>=t[0]||e[1]<0||e[1]>=t[1]||e[2]<0||e[2]>=t[2])}var R=n(39536);const L=function(e,t){let n;n=t?[(0,R.lD)(t)]:(0,R.qO)();const i=[];return n.forEach(t=>{const n=e.getActors(),a=t.getVolumeViewports();for(const e of a){const t=e.getActors();if(t.length!==n.length)continue;n.every(({uid:e})=>t.find(t=>e===t.uid))&&i.push(e)}}),i};var O=n(24724),U=n(38669),k=n(94741),N=n(80068),V=n(74876),W=n(71851),B=n(51159),H=n(3823),G=n(30135),F=n(54072);const z=e=>e.preScale.scaled&&e.preScale.scalingParameters.suvbw;function X(e,t,n=void 0,i="_thumbnails",a={displayArea:{imageArea:[1,1]}}){if(!(e&&e instanceof HTMLCanvasElement))throw new Error("canvas element is required");const o=!t.imageId,s=!o&&t,r=o&&t,l=`renderGPUViewport-${s.imageId||r.volumeId}`,d=document.createElement("div"),c=window.devicePixelRatio||1;a.displayArea||(a.displayArea={imageArea:[1,1]});const h=e.width,g=e.height;d.style.width=`${h/c+G.p8}px`,d.style.height=`${g/c+G.p8}px`,d.style.visibility="hidden",d.style.position="absolute",document.body.appendChild(d);const u=l.split(":").join("-");d.setAttribute("viewport-id-for-remove",u);const m=(0,G.Ay)(d),p=(0,R.lD)(i)||new F.A(i);let v=p.getViewport(l);if(!v){const e={viewportId:l,type:o?W.ViewportType.ORTHOGRAPHIC:W.ViewportType.STACK,element:d,defaultOptions:{...a,suppressEvents:!0}};p.enableElement(e),v=p.getViewport(l)}return new Promise(i=>{let h=!1,{viewReference:g}=a;const f=t=>{if(h)return;if(g){const e=g;return g=null,v.setViewReference(e),void v.render()}e.getContext("2d").drawImage(m,0,0,m.width,m.height,0,0,e.width,e.height);const n=v.canvasToWorld([0,0]),a=v.canvasToWorld([m.width/c,0]),o=v.canvasToWorld([0,m.height/c]),s=H.eR.sub([0,0,0],v.canvasToWorld([1/c,0]),n),r=H.eR.sub([0,0,0],v.canvasToWorld([0,1/c]),n);h=!0,d.removeEventListener(W.Events.IMAGE_RENDERED,f),setTimeout(()=>{p.disableElement(l);document.querySelectorAll(`[viewport-id-for-remove="${u}"]`).forEach(e=>{e.remove()})},0),i({origin:n,bottomLeft:o,topRight:a,thicknessMm:1,rightVector:s,downVector:r})};d.addEventListener(W.Events.IMAGE_RENDERED,f),o?v.setVolumes([r],!1,!0):v.renderImageObject(t),v.resetCamera(),"PT"!==n||z(s)||v.setProperties({voiRange:{lower:s.minPixelValue,upper:s.maxPixelValue}}),v.render()})}var $=n(36931),Z=n(7808),Y=n(5057);function j(e,t,n,i,a){if(t.volumeId)throw new Error("Unsupported volume rendering for CPU");const o=t,s={canvas:e,viewport:(0,$.A)(e,o,n),image:o,renderingTools:{}};s.transform=(0,Z.A)(s);return new Promise((e,t)=>{(0,Y.A)(s,true),e(null)})}var q=n(49038);function K(e){const{canvas:t,imageId:n,viewReference:i,requestType:a=W.RequestType.Thumbnail,priority:o=-5,renderingEngineId:s="_thumbnails",useCPURendering:r=!1,thumbnail:l=!1,imageAspect:d=!1,viewportOptions:c}=e,h=i?.volumeId,g=h&&!n,u=i&&c?{...c,viewReference:i}:c,m=r?j:X;return new Promise((e,i)=>{function c(n,a){const{modality:o}=V.get("generalSeriesModule",a)||{},c=!g&&n,h=g&&n;c&&(c.isPreScaled=c.isPreScaled||c.preScale?.scaled),l&&(t.height=256,t.width=256),d&&c&&(t.width=c&&t.height*c.width/c.height),t.style.width=t.width/devicePixelRatio+"px",t.style.height=t.height/devicePixelRatio+"px",h&&r&&i(new Error("CPU rendering of volume not supported")),m(t,n,o,s,u).then(e)}function p(e,t){console.error(e,t),i(e)}const v={useRGBA:!!r,requestType:a};if(h){const e=q.Ay.getVolume(h);e||i(new Error(`Volume id ${h} not found in cache`));c(e,e.imageIds[0])}else B.A.addRequest(function(e,t,n){return(0,N.loadAndCacheImage)(e,n).then(t=>{c.call(this,t,e)},t=>{p.call(this,t,e)})}.bind(null,n,null,v),a,{imageId:n},o)})}var J=n(10364);function Q(e){return Array.isArray(e)?e:[e]}const ee="CORNERSTONE_TOOLS_HISTORY_UNDO",te="CORNERSTONE_TOOLS_HISTORY_REDO";class ne{constructor(e="Tools",t=50){this.position=-1,this.redoAvailable=0,this.undoAvailable=0,this.ring=new Array,this.isRecordingGrouped=!1,this.label=e,this._size=t}get size(){return this._size}set size(e){this.ring=new Array(e),this._size=e,this.position=-1,this.redoAvailable=0,this.undoAvailable=0}get canUndo(){return this.undoAvailable>0}get canRedo(){return this.redoAvailable>0}undo(e=1){for(;e>0&&this.undoAvailable>0;){const t=this.ring[this.position];for(const e of Q(t).reverse())e.restoreMemo(!0),this.dispatchHistoryEvent({item:e,isUndo:!0});e--,this.redoAvailable++,this.undoAvailable--,this.position=(this.position-1+this.size)%this.size}}undoIf(e){return!!(this.undoAvailable>0&&e(this.ring[this.position]))&&(this.undo(),!0)}dispatchHistoryEvent({item:e,isUndo:t}){e.id&&J.A.dispatchEvent(new CustomEvent(t?ee:te,{detail:{isUndo:t,id:e.id,operationType:e.operationType||"annotation",memo:e}}))}redo(e=1){for(;e>0&&this.redoAvailable>0;){const t=(this.position+1)%this.size,n=this.ring[t];for(const e of Q(n).reverse())e.restoreMemo(!1),this.dispatchHistoryEvent({item:e,isUndo:!1});e--,this.position=t,this.undoAvailable++,this.redoAvailable--}}initializeGroupItem(){this.redoAvailable=0,this.undoAvailable<this._size&&this.undoAvailable++,this.position=(this.position+1)%this._size,this.ring[this.position]=[]}startGroupRecording(){this.isRecordingGrouped=!0,this.initializeGroupItem()}rollbackUnusedGroupItem(){this.ring[this.position]=void 0,this.position=(this.position-1)%this._size,this.undoAvailable--}endGroupRecording(){this.isRecordingGrouped=!1;const e=this.ring[this.position];Array.isArray(e)&&0===e.length&&this.rollbackUnusedGroupItem()}pushGrouped(e){const t=this.ring[this.position];if(Array.isArray(t))return t.push(e),e;throw new Error("Last item should be an array for grouped memos.")}push(e){if(!e)return;const t=e.restoreMemo?e:e.createMemo?.();return t?this.isRecordingGrouped?this.pushGrouped(t):(this.redoAvailable=0,this.undoAvailable<this._size&&this.undoAvailable++,this.position=(this.position+1)%this._size,this.ring[this.position]=t,t):void 0}}const ie=new ne;const ae=function(e,t){const n=(0,V.get)("imagePlaneModule",e);if(!n)throw new Error(`No imagePlaneModule found for imageId: ${e}`);const{columnCosines:i,rowCosines:a,imagePositionPatient:o}=n;let{columnPixelSpacing:s,rowPixelSpacing:r}=n;s||=1,r||=1;const l=H.eR.create();H.eR.scaleAndAdd(l,o,i,-s/2),H.eR.scaleAndAdd(l,l,a,-r/2);const d=H.eR.create();return H.eR.sub(d,t,l),[H.eR.dot(d,a)/r,H.eR.dot(d,i)/s]};function oe(e,t){const n=(0,V.get)("imagePlaneModule",e);if(!n)throw new Error(`No imagePlaneModule found for imageId: ${e}`);const{columnCosines:i,rowCosines:a,imagePositionPatient:o}=n;let{columnPixelSpacing:s,rowPixelSpacing:r}=n;s||=1,r||=1;const l=H.eR.create();return H.eR.scaleAndAdd(l,o,a,r*(t[0]-.5)),H.eR.scaleAndAdd(l,l,i,s*(t[1]-.5)),Array.from(l)}var se=n(4031),re=n(61375),le=n(20537),de=n(80500),ce=n(47476),he=n(98039);function ge(e){const t=(0,R.qO)(),n=[];return t.forEach(t=>{t.getViewports().forEach(t=>{t.hasImageURI(e)&&n.push(t)})}),n}var ue=n(52268);function me(e,t){const n=function(e,t){const n=t.getImageIds(),i=t.getCurrentImageIdIndex();if(0===n.length)return null;const a=t=>{const n=function(e){const t=V.get("imagePlaneModule",e);if(!(t&&t.rowCosines instanceof Array&&3===t.rowCosines.length&&t.columnCosines instanceof Array&&3===t.columnCosines.length&&t.imagePositionPatient instanceof Array&&3===t.imagePositionPatient.length))return null;const{rowCosines:n,columnCosines:i,imagePositionPatient:a}=t,o=H.eR.set(H.eR.create(),...n),s=H.eR.set(H.eR.create(),...i),r=H.eR.cross(H.eR.create(),o,s);return{rowCosines:n,columnCosines:i,imagePositionPatient:a,planeNormal:r}}(t);if(!n)return null;const i=ue.planeEquation(n.planeNormal,n.imagePositionPatient);return ue.planeDistanceToPoint(i,e)},o={distance:a(n[i])??1/0,index:i},s=n.slice(i+1);for(let e=0;e<s.length;e++){const t=a(s[e]);if(null!==t){if(!(t<=o.distance))break;o.distance=t,o.index=e+i+1}}const r=n.slice(0,i);for(let e=r.length-1;e>=0;e--){const t=a(r[e]);if(null!==t&&t!==o.distance){if(!(t<o.distance))break;o.distance=t,o.index=e}}return o.distance===1/0?null:o}(e,t);return n?n.index:null}var pe=n(51919);function ve(e){const{width:t,height:n}=e.getCanvas(),{sliceToIndexMatrix:i,indexToSliceMatrix:a}=e.getSliceViewInfo(),o=(0,pe.e)(e,[0,0]),s=(0,pe.e)(e,[t-1,0]),r=(0,pe.e)(e,[0,n-1]),l=H.eR.sub(H.eR.create(),s,o),d=H.eR.sub(H.eR.create(),r,o),c=H.eR.cross(H.eR.create(),l,d);H.eR.normalize(l,l),H.eR.normalize(d,d),H.eR.normalize(c,c);const h=Math.max(Math.abs(l[0]),Math.abs(l[1]),Math.abs(l[2])),g=Math.max(Math.abs(d[0]),Math.abs(d[1]),Math.abs(d[2]));if(!H.Fd.equals(1,h)||!H.Fd.equals(1,g))throw new Error("Livewire is not available for rotate/oblique viewports");const{voxelManager:u}=e.getImageData(),m=e.getSliceViewInfo(),p=u.getSliceData(m);return{width:m.width,height:m.height,scalarData:p,sliceToIndexMatrix:i,indexToSliceMatrix:a}}const fe={},we={add:(e,t)=>{const[n,i]=e,a=`${n}_${i}`;fe[a]||(fe[a]={}),fe[a]=t},get:(e,t,n)=>{if("spatialRegistrationModule"!==e)return;const i=`${t}_${n}`;if(fe[i])return fe[i];const a=`${n}_${t}`;return fe[a]?H.pB.invert(H.pB.create(),fe[a]):void 0}};(0,V.addProvider)(we.get.bind(we));const Ee=we;const Ie=function(e,t){const n=e.getSliceIndex(),i=t.getSliceIndex(),a=(0,V.get)("imagePlaneModule",n.toString()),o=(0,V.get)("imagePlaneModule",i.toString());if(!a||!o)return void console.log("Viewport spatial registration requires image plane module");const{imageOrientationPatient:s}=o;if(!a.imageOrientationPatient.every((e,t)=>Math.abs(e-s[t])<.05))return void console.log("Viewport spatial registration only supported for same orientation (hence translation only) for now",a?.imageOrientationPatient,o?.imageOrientationPatient);const r=a.imagePositionPatient,l=o.imagePositionPatient,d=H.eR.subtract(H.eR.create(),r,l),c=H.pB.fromTranslation(H.pB.create(),d);Ee.add([e.id,t.id],c)};function Ce(e){const{imageData:t,dimensions:n}=e.getImageData()||{};if(!t||!n)return[];const{canvas:i}=e,a=window.devicePixelRatio,o=[i.width/a,0],s=[i.width/a,i.height/a],r=[0,i.height/a],l=e.canvasToWorld([0,0]),d=e.canvasToWorld(o),c=e.canvasToWorld(s),h=e.canvasToWorld(r),g=t.worldToIndex(l),u=t.worldToIndex(d),m=t.worldToIndex(c),p=t.worldToIndex(h);return function({dimensions:e,imageData:t,topLeftImage:n,topRightImage:i,bottomRightImage:a,bottomLeftImage:o,topLeftWorld:s,topRightWorld:r,bottomRightWorld:l,bottomLeftWorld:d}){const c=be(n,e)?s:t.indexToWorld([0,0,0]),h=be(i,e)?r:t.indexToWorld([e[0]-1,0,0]),g=be(a,e)?l:t.indexToWorld([e[0]-1,e[1]-1,0]),u=be(o,e)?d:t.indexToWorld([0,e[1]-1,0]);return[c,h,u,g]}({dimensions:n,imageData:t,topLeftImage:g,topRightImage:u,bottomRightImage:m,bottomLeftImage:p,topLeftWorld:l,topRightWorld:d,bottomRightWorld:c,bottomLeftWorld:h})}function be(e,t){return e[0]>0||e[0]<t[0]-1||e[1]>0||e[1]<t[1]-1||e[2]>0||e[2]<t[2]-1}var _e=n(38883),Te=n(96833),Ae=n(13876),Se=n(74268),Me=n(32173),De=n(79720),ye=n(86846);const Pe=function(e){const t=(0,ye.Ay)(e);if(!t)return;const{viewport:n}=t;if(!(n instanceof De.A))throw new Error(`An image can only be fetched for a stack viewport and not for a viewport of type: ${n.type}`);return n.getCornerstoneImage()};var xe=n(90537),Re=n(1865),Le=n(27119),Oe=n(74638);function Ue(e){if(e.length<=1)return!1;const t=e[0],{modality:n,seriesInstanceUID:i}=V.get("generalSeriesModule",t),{imageOrientationPatient:a,pixelSpacing:o,frameOfReferenceUID:s,columns:r,rows:l,usingDefaultValues:d}=V.get("imagePlaneModule",t);if(d)return!1;const c={modality:n,imageOrientationPatient:a,pixelSpacing:o,frameOfReferenceUID:s,columns:r,rows:l,seriesInstanceUID:i};let h=!0;for(let t=0;t<e.length;t++){const n=e[t],{modality:i,seriesInstanceUID:a}=V.get("generalSeriesModule",n),{imageOrientationPatient:o,pixelSpacing:s,columns:r,rows:l}=V.get("imagePlaneModule",n);if(a!==c.seriesInstanceUID){h=!1;break}if(i!==c.modality){h=!1;break}if(r!==c.columns){h=!1;break}if(l!==c.rows){h=!1;break}if(!(0,Oe.Ay)(o,c.imageOrientationPatient)){h=!1;break}if(!(0,Oe.Ay)(s,c.pixelSpacing)){h=!1;break}}return h}var ke=n(45278),Ne=n(22191),Ve=n(63470),We=n(17791);const Be=new Set(["1.2.840.10008.1.2.4.100","1.2.840.10008.1.2.4.100.1","1.2.840.10008.1.2.4.101","1.2.840.10008.1.2.4.101.1","1.2.840.10008.1.2.4.102","1.2.840.10008.1.2.4.102.1","1.2.840.10008.1.2.4.103","1.2.840.10008.1.2.4.103.1","1.2.840.10008.1.2.4.104","1.2.840.10008.1.2.4.104.1","1.2.840.10008.1.2.4.105","1.2.840.10008.1.2.4.105.1","1.2.840.10008.1.2.4.106","1.2.840.10008.1.2.4.106.1","1.2.840.10008.1.2.4.107","1.2.840.10008.1.2.4.108"]);function He(e){if(!e)return!1;return(Array.isArray(e)?e:[e]).find(e=>Be.has(e))}var Ge=n(99576),Fe=n(9734),ze=n(40661),Xe=n(87142);async function $e({viewport:e,options:t={}}){const n=e.getRenderingEngine();let i=t.volumeId||`${(0,p.A)()}`;if(0===i.split(":").length){i=`${(0,Xe.getUnknownVolumeLoaderSchema)()}:${i}`}const{id:a,element:o}=e,s=t.viewportId||a,r=e.getImageIds(),l=e.getViewPresentation(),d=e.getViewReference();n.enableElement({viewportId:s,type:W.ViewportType.ORTHOGRAPHIC,element:o,defaultOptions:{background:t.background,orientation:t.orientation}});(await(0,Xe.createAndCacheVolume)(i,{imageIds:r})).load();const c=n.getViewport(s);await(0,ze.A7)(n,[{volumeId:i}],[s]);const h=()=>{c.render(),o.removeEventListener(W.Events.VOLUME_VIEWPORT_NEW_VOLUME,h)};return o.addEventListener(W.Events.VOLUME_VIEWPORT_NEW_VOLUME,h),c.setViewPresentation(l),c.setViewReference(d),c.render(),c}var Ze=n(86252);async function Ye({viewport:e,options:t}){const n=e,{id:i,element:a}=n,o=e.getRenderingEngine(),{background:s}=t,r=t.viewportId||i,l=q.Ay.getVolume(n.getVolumeId());if(!(l instanceof Ze.Q))throw new Error("Currently, you cannot decache a volume that is not an ImageVolume. So, unfortunately, volumes such as nifti  (which are basic Volume, without imageIds) cannot be decached.");const d={viewportId:r,type:W.ViewportType.STACK,element:a,defaultOptions:{background:s}},c=n.getViewReference();o.enableElement(d);const h=o.getViewport(r);return await h.setStack(l.imageIds),h.setViewReference(c),h.render(),h}var je=n(24623),qe=n(67645),Ke=n(76491);function Je(e){return Math.round(e/Ke.EPSILON)*Ke.EPSILON}const Qe=function e(t,n=2){if(Array.isArray(t))return t.map(t=>e(t,n)).join(", ");if(null==t||""===t)return"NaN";t=Number(t);const i=Math.abs(t);if(i<1e-4)return`${t}`;const a=i>=100?n-2:i>=10?n-1:i>=1?n:i>=.1?n+1:i>=.01?n+2:i>=.001?n+3:n+4;return t.toFixed(a)};function et(e,t,n){const i=e.length===t*n*4,a=e.length===t*n*3;if(i||a){const a=new Float32Array(t*n);let o=0,s=0;const r=i?4:3;for(let i=0;i<t;i++)for(let t=0;t<n;t++){const t=e[o],n=e[o+1],i=e[o+2];a[s]=(t+n+i)/3,o+=r,s++}return a}return e}var tt=n(90340);const nt=function(e){if(e instanceof tt.PX){return q.Ay.getVolume(e.getVolumeId()).imageIds}if(e.getImageIds)return e.getImageIds()};function it(e,t){const n=[...e];return t>=n.length?(at(n),n):(at(n),n.slice(0,t))}function at(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}var ot=n(12437),st=n(30169),rt=n(56577),lt=n(68136),dt=n(13859),ct=n(8126);function ht(e){const t=e.toString(16);return 1==t.length?"0"+t:t}function gt(e,t,n){return"#"+ht(e)+ht(t)+ht(n)}function ut(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function mt(e,t){if(e===t)return!0;if(null==e||null==t)return!1;try{return JSON.stringify(e)===JSON.stringify(t)}catch(n){return console.debug("Error in JSON.stringify during deep comparison:",n),e===t}}var pt=n(56750),vt=n(20286),ft=n(53932),wt=n(89131);function Et(e,t){const n={};let i=[];const a=Object.keys(e);for(let o=0;o<a.length;o++){const s=new Set,r=e[a[o]];for(let e=0;e<r.length;e++){const i=t(r[e].imageId)||0;if(n[i]=n[i]||[],n[i].push({imageId:r[e].imageId}),s.add(i),s.size-1<e)return}if(0==o)i=Array.from(s);else if(!Tt(i,s))return}return n}function It(e,t){const n=V.get(t,e);try{return parseFloat(n)}catch{return}}function Ct(e){const t=V.get("20011003",e);try{const{InlineBinary:e}=t;if(e){const t=atob(e),n=new ArrayBuffer(t.length),i=new DataView(n);for(let e=0;e<t.length;e++)i.setUint8(e,t.charCodeAt(e));return new Float32Array(n)[0]}return parseFloat(t)}catch{return}}function bt(e){let t=V.get("0019100c",e)||V.get("0019100C",e);try{const{InlineBinary:e}=t;return e&&(t=atob(e)),parseFloat(t)}catch{return}}function _t(e){let t=V.get("00431039",e);try{const{InlineBinary:e}=t;return e&&(t=atob(e).split("//")),parseFloat(t[0])%1e5}catch{return}}function Tt(e,t){if(e.length!=t.size)return!1;for(let n=0;n<e.length;n++)if(!t.has(e[n]))return!1;return!0}function At(e){const t=V.get("petImageModule",e);return t?t.frameReferenceTime:0}const St=function(e){const t=function(e){const t=e.map(e=>{const{imagePositionPatient:t}=V.get("imagePlaneModule",e)||{};return{imageId:e,imagePositionPatient:t}});if(!t.every(e=>e.imagePositionPatient))return null;const n=(i="imagePositionPatient",t.reduce((e,t)=>((e[t[i]]=e[t[i]]||[]).push(t),e),{}));var i;const a=Object.keys(n),o=n[a[0]].length;return 1===o?null:a.every(e=>n[e].length===o)?n:null}(e);if(!t)return{imageIdGroups:[e],splittingTag:null};const n=["TemporalPositionIdentifier","DiffusionBValue","TriggerTime","EchoTime","EchoNumber","PhilipsPrivateBValue","SiemensPrivateBValue","GEPrivateBValue","PetFrameReferenceTime"],i=[e=>It(e,n[0]),e=>It(e,n[1]),e=>It(e,n[2]),e=>It(e,n[3]),e=>It(e,n[4]),Ct,bt,_t,At];for(let e=0;e<i.length;e++){const a=Et(t,i[e]);if(a){return{imageIdGroups:Object.keys(a).map(Number.parseFloat).sort((e,t)=>e-t).map(e=>a[e].map(e=>e.imageId)),splittingTag:n[e]}}}return{imageIdGroups:[e],splittingTag:null}};const Mt=function(e){const{imageIdGroups:t,splittingTag:n}=St(e);return{isDynamicVolume:t.length>1,timePoints:t,splittingTag:n}};var Dt=n(91979);function yt(e,t){const n=e.length,{rescaleSlope:i,rescaleIntercept:a,suvbw:o}=t;if("PT"===t.modality&&"number"==typeof o)for(let t=0;t<n;t++)e[t]=o*(e[t]*i+a);else for(let t=0;t<n;t++)e[t]=e[t]*i+a;return e}var Pt=n(99949);function xt(e,t,n){return Math.min(Math.max(t,e),n)}const Rt=xt;function Lt(e,t){if(!(0,ye.Ay)(e.element))throw new Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof tt.hS&&0===e.getImageIds().length)throw new Error("Scroll::Stack Viewport has no images");const{volumeId:n,delta:i,scrollSlabs:a}=t;if(e instanceof tt.PX)!function(e,t,n,i=!1){const a=i,{numScrollSteps:o,currentStepIndex:s,sliceRangeInfo:r}=(0,re.A)(e,t,a);if(!r)return;const{sliceRange:l,spacingInNormalDirection:d,camera:c}=r,{focalPoint:h,viewPlaneNormal:g,position:u}=c,{newFocalPoint:p,newPosition:v}=(0,de.A)(h,u,l,g,d,n);e.setCamera({focalPoint:p,position:v}),e.render();const f=s+n,w={volumeId:t,viewport:e,delta:n,desiredStepIndex:f,currentStepIndex:s,numScrollSteps:o,currentImageId:e.getCurrentImageId()};(f>o||f<0)&&e.getCurrentImageId()?(0,m.A)(J.A,W.Events.VOLUME_VIEWPORT_SCROLL_OUT_OF_BOUNDS,w):(0,m.A)(J.A,W.Events.VOLUME_VIEWPORT_SCROLL,w)}(e,n,i,a);else{const n=e.getCurrentImageIdIndex();if(n+i>e.getImageIds().length-1||n+i<0){const e={imageIdIndex:n,direction:i};(0,m.A)(J.A,W.Events.STACK_SCROLL_OUT_OF_BOUNDS,e)}e.scroll(i,t.debounceLoading,t.loop)}}async function Ot(e,t={}){const{imageIndex:n,debounceLoading:i,volumeId:a}=t,o=(0,ye.Ay)(e);if(!o)throw new Error("Element has been disabled");const{viewport:s}=o,{imageIndex:r,numberOfSlices:l}=function(e,t){if(e instanceof De.A)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};return{numberOfSlices:e.getNumberOfSlices(),imageIndex:e.getSliceIndex()}}(s,i),d=function(e,t){const n=e-1;return Rt(t,0,n)}(l,n);Lt(s,{delta:d-r,debounceLoading:i,volumeId:a})}function Ut(e,t,n={}){const i=q.Ay.getVolume(e);if(!i)throw new Error(`Referenced volume with id ${e} does not exist.`);const{metadata:a,spacing:o,direction:s,dimensions:r}=i,{minX:l,maxX:d,minY:c,maxY:h,minZ:g,maxZ:u}=t,m=[Math.min(l,d),Math.min(c,h),Math.min(g,u)],v=(0,k.A)(i.imageData,m),f=[Math.abs(d-l)+1,Math.abs(h-c)+1,Math.abs(u-g)+1],{targetBuffer:w}=n,E={metadata:a,dimensions:f,spacing:o,origin:v,direction:s,targetBuffer:w,scalarData:"Float32Array"===w?.type?new Float32Array(f[0]*f[1]*f[2]):void 0},I=(0,Xe.createLocalVolume)((0,p.A)(),E),C=I.voxelManager.getCompleteScalarDataArray(),b=f[0]*f[1],_=r[0]*r[1],T=i.voxelManager.getCompleteScalarDataArray();for(let e=0;e<f[2];e++)for(let t=0;t<f[1];t++){const n=(0,k.A)(I.imageData,[0,t,e]),a=(0,U.A)(i.imageData,n),o=a[2]*_+a[1]*r[0]+a[0],s=T.slice(o,o+f[0]),l=e*b+t*f[0];C.set(s,l)}return I.voxelManager.setCompleteScalarDataArray(C),I}function kt(e,t){const{viewUp:n,viewPlaneNormal:i}=t,a=(0,U.p)(e,[0,0,0]),o=H.eR.negate(H.eR.create(),n),s=H.eR.negate(H.eR.create(),i),r=H.eR.cross(H.eR.create(),o,s),l=H.eR.sub(H.eR.create(),(0,U.p)(e,o),a),d=H.eR.sub(H.eR.create(),(0,U.p)(e,s),a);H.eR.normalize(l,l),H.eR.normalize(d,d);return{worldVecRowDir:r,worldVecColDir:o,worldVecSliceDir:s,ijkVecRowDir:H.eR.cross(H.eR.create(),l,d),ijkVecColDir:l,ijkVecSliceDir:d}}var Nt=n(42384),Vt=n(7608);function Wt(e,t,n,i){const[a,o,s]=t,r=a*o;let l=0,d=0,c=0;const[h,g,u]=n.map(Math.round);for(let t=u-i;t<=u+i;t++)if(!(t<0||t>=s))for(let n=g-i;n<=g+i;n++)if(!(n<0||n>=o))for(let o=h-i;o<=h+i;o++){if(o<0||o>=a)continue;const i=e[t*r+n*a+o];l+=i,d+=i*i,c++}if(0===c){const t=u*r+g*a+h;if(t>=0&&t<e.length){return{mean:e[t],stdDev:0,count:1}}return{mean:0,stdDev:0,count:0}}const m=l/c,p=d/c-m*m;return{mean:m,stdDev:Math.sqrt(Math.max(0,p)),count:c}}const Bt=new Set(["1.2.840.10008.5.1.4.1.1.1","1.2.840.10008.5.1.4.1.1.1.1","1.2.840.10008.5.1.4.1.1.1.1.1","1.2.840.10008.5.1.4.1.1.1.2","1.2.840.10008.5.1.4.1.1.1.2.1","1.2.840.10008.5.1.4.1.1.1.3","1.2.840.10008.5.1.4.1.1.1.3.1","1.2.840.10008.5.1.4.1.1.12.1","1.2.840.10008.5.1.4.1.1.12.1.1","1.2.840.10008.5.1.4.1.1.12.2","1.2.840.10008.5.1.4.1.1.12.2.1","1.2.840.10008.5.1.4.1.1.12.3"]);function Ht(e){const{PixelSpacing:t,SOPClassUID:n,SequenceOfUltrasoundRegions:i}=e;if(i)return function(e){const{SequenceOfUltrasoundRegions:t}=e,n=Array.isArray(t);if(n&&t.length>1)return void console.warn("Sequence of Ultrasound Regions > one entry. This is not yet implemented, all measurements will be shown in pixels.");const{PhysicalDeltaX:i,PhysicalDeltaY:a}=n?t[0]:t;return{PixelSpacing:[10*Math.abs(i),10*Math.abs(a)]}}(e);return Bt.has(n)?function(e){const{PixelSpacing:t,ImagerPixelSpacing:n,EstimatedRadiographicMagnificationFactor:i,PixelSpacingCalibrationType:a,PixelSpacingCalibrationDescription:o}=e,s=!0;if(!n)return{PixelSpacing:t,type:W.CalibrationTypes.UNKNOWN,isProjection:s};if(!t)return i?{PixelSpacing:n.map(e=>e/i),type:W.CalibrationTypes.ERMF,isProjection:s}:(console.warn("EstimatedRadiographicMagnificationFactor was not present. Unable to correct ImagerPixelSpacing."),{PixelSpacing:n,type:W.CalibrationTypes.PROJECTION,isProjection:s});return(0,Oe.n4)(t,n)?{PixelSpacing:t,type:W.CalibrationTypes.PROJECTION,isProjection:s}:a||o?{PixelSpacing:t,type:W.CalibrationTypes.CALIBRATED,isProjection:s,PixelSpacingCalibrationType:a,PixelSpacingCalibrationDescription:o}:{PixelSpacing:t,type:W.CalibrationTypes.UNKNOWN,isProjection:s}}(e):{PixelSpacing:t,type:W.CalibrationTypes.NOT_APPLICABLE,isProjection:!1}}var Gt=n(41365);const Ft=(e,t)=>function(e,t,n){if(!n)throw new Error("getVolume is required, use the utilities export instead ");if(e.modality)return e.modality;if(e.setVolumes){if(!(t=t??e.getVolumeId())||!n)return;return n(t).metadata.Modality}throw new Error("Invalid viewport type")}(e,t,q.Ay.getVolume)},50134:(e,t,n)=>{"use strict";function i(e){if(!e)return;const t=e.getSize();for(let n=0;n<t;n++){const t=[];e.getNodeValue(n,t),t[1]=1-t[1],t[2]=1-t[2],t[3]=1-t[3],e.setNodeValue(n,t)}}n.d(t,{A:()=>i})},74638:(e,t,n)=>{"use strict";function i(e,t,n){return Math.abs(e-t)<=n}function a(e){return"number"==typeof e}function o(e){return e&&"object"==typeof e&&"length"in e&&"number"==typeof e.length&&e.length>0&&"number"==typeof e[0]}function s(e,t,n=1e-5){return typeof e==typeof t&&null!==e&&null!==t&&(a(e)&&a(t)?i(e,t,n):!(!o(e)||!o(t))&&function(e,t,n=1e-5){if(e.length!==t.length)return!1;for(let a=0;a<e.length;a++)if(!i(e[a],t[a],n))return!1;return!0}(e,t,n))}n.d(t,{Ay:()=>g,Et:()=>h,Ph:()=>c,WC:()=>d,n4:()=>s});const r=e=>"number"==typeof e?-e:e?.map?e.map(r):!e,l=e=>"number"==typeof e?Math.abs(e):e?.map?e.map(l):e,d=(e,t,n=void 0)=>s(e,r(t),n),c=(e,t,n=void 0)=>s(l(e),l(t),n);function h(e){return Array.isArray(e)?h(e[0]):isFinite(e)&&!isNaN(e)}const g=s},7608:(e,t,n)=>{"use strict";n.r(t),n.d(t,{aiLog:()=>h,coreLog:()=>l,cs3dLog:()=>r,dicomConsistencyLog:()=>u,examplesLog:()=>g,getLogger:()=>s,getRootLogger:()=>o,imageConsistencyLog:()=>m,loaderLog:()=>c,toolsLog:()=>d});var i=n(4367);const a=n.n(i)().noConflict();function o(e){const t=a.getLogger(e[0]);return t.getLogger=(...t)=>o(`${e}.${t.join(".")}`),t}function s(...e){return o(e.join("."))}"undefined"!=typeof window&&(window.log=a);const r=o("cs3d"),l=r.getLogger("core"),d=r.getLogger("tools"),c=r.getLogger("dicomImageLoader"),h=r.getLogger("ai"),g=r.getLogger("examples"),u=s("consistency","dicom"),m=s("consistency","image")},1865:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(74876);function a(e){const t=e[0],{pixelRepresentation:n,bitsAllocated:a,bitsStored:o,highBit:s,photometricInterpretation:r,samplesPerPixel:l}=(0,i.get)("imagePixelModule",t),d=[],c=(0,i.get)("voiLutModule",t);let h;if(c){const{windowWidth:e,windowCenter:t}=c;if(h=c?.voiLUTFunction,Array.isArray(e))for(let n=0;n<e.length;n++)d.push({windowWidth:e[n],windowCenter:t[n]});else d.push({windowWidth:e,windowCenter:t})}else d.push({windowWidth:void 0,windowCenter:void 0});const{modality:g,seriesInstanceUID:u}=(0,i.get)("generalSeriesModule",t),{imageOrientationPatient:m,pixelSpacing:p,frameOfReferenceUID:v,columns:f,rows:w}=(0,i.get)("imagePlaneModule",t);return{BitsAllocated:a,BitsStored:o,SamplesPerPixel:l,HighBit:s,PhotometricInterpretation:r,PixelRepresentation:n,Modality:g,ImageOrientationPatient:m,PixelSpacing:p,FrameOfReferenceUID:v,Columns:f,Rows:w,voiLut:d,VOILUTFunction:h,SeriesInstanceUID:u}}},52268:(e,t,n)=>{"use strict";n.r(t),n.d(t,{isPointOnPlane:()=>d,linePlaneIntersection:()=>o,planeDistanceToPoint:()=>l,planeEquation:()=>s,threePlaneIntersection:()=>r});var i=n(3823),a=n(76491);function o(e,t,n){const[i,a,o]=e,[s,r,l]=t,[d,c,h,g]=n,u=s-i,m=r-a,p=l-o,v=-1*(d*i+c*a+h*o-g)/(d*u+c*m+h*p);return[u*v+i,m*v+a,p*v+o]}function s(e,t,n=!1){const[i,a,o]=e,s=i*t[0]+a*t[1]+o*t[2];if(n){const e=Math.sqrt(i*i+a*a+o*o);return[i/e,a/e,o/e,s/e]}return[i,a,o,s]}function r(e,t,n){const[a,o,s,r]=e,[l,d,c,h]=t,[g,u,m,p]=n,v=i.w0.fromValues(a,l,g,o,d,u,s,c,m),f=i.w0.fromValues(r,h,p,o,d,u,s,c,m),w=i.w0.fromValues(a,l,g,r,h,p,s,c,m),E=i.w0.fromValues(a,l,g,o,d,u,r,h,p);return[i.w0.determinant(f)/i.w0.determinant(v),i.w0.determinant(w)/i.w0.determinant(v),i.w0.determinant(E)/i.w0.determinant(v)]}function l(e,t,n=!1){const[i,a,o,s]=e,[r,l,d]=t,c=i*r+a*l+o*d-s,h=Math.abs(c)/Math.sqrt(i*i+a*a+o*o);return(n?Math.sign(c):1)*h}function d(e,t,n=a.EPSILON){return l(t,e)<n}},56577:(e,t,n)=>{"use strict";n.d(t,{X6:()=>o,ii:()=>a});var i=n(87784);function a(e,t){const{pointInShapeFn:n,callback:a,boundsIJK:o,returnPoints:s=!1}=t;let r;if(e.getScalarData)r=e.getScalarData();else{const t=e.getPointData().getScalars();if(t)r=t.getData();else{const{voxelManager:t}=e.get("voxelManager")||{};t&&(r=t.getCompleteScalarDataArray())}}const l=e.getDimensions(),d=[[0,l[0]],[0,l[1]],[0,l[2]]],c=function({imageData:e,bounds:t,scalarData:n,pointInShapeFn:a,callback:o}){const[[s,r],[l,d],[c,h]]=t,{numComps:g}=e,u=e.getDimensions(),m=(0,i.P)(e),p=[0,0,0],v=g||n.length/u[2]/u[1]/u[0],f=u[0]*v,w=u[1]*f,E=[];for(let e=c;e<=h;e++){p[2]=e;const t=e*w;for(let e=l;e<=d;e++){p[1]=e;const i=t+e*f;for(let e=s;e<=r;e++){p[0]=e;const t=m(p);if(a(t,p)){const a=i+e*v;let s;s=v>2?[n[a],n[a+1],n[a+2]]:n[a],E.push({value:s,index:a,pointIJK:p,pointLPS:t.slice()}),o({value:s,index:a,pointIJK:p,pointLPS:t})}}}}return E}({imageData:e,bounds:o||d,scalarData:r,pointInShapeFn:n,callback:a});return s?c:void 0}function o({voxelManager:e,bounds:t,imageData:n,pointInShapeFn:a,callback:o,returnPoints:s}){const[[r,l],[d,c],[h,g]]=t,u=(0,i.P)(n),m=[0,0,0],p=[];for(let t=h;t<=g;t++){m[2]=t;for(let t=d;t<=c;t++){m[1]=t;for(let t=r;t<=l;t++){m[0]=t;const n=u(m);if(a(n,m)){const t=e.toIndex(m),i=e.getAtIndex(t);s&&p.push({value:i,index:t,pointIJK:[...m],pointLPS:n.slice()}),o?.({value:i,index:t,pointIJK:m,pointLPS:n})}}}}return p}},80500:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(3823);function a(e,t,n,a,o,s){const{min:r,max:l,current:d}=n,c=i.eR.create();i.eR.sub(c,t,e);const h=Math.round((l-r)/o),g=(d-r)/(l-r)*h;let u=Math.round(g),m=[e[0]-a[0]*g*o,e[1]-a[1]*g*o,e[2]-a[2]*g*o];u+=s,u>h?u=h:u<0&&(u=0);const p=u*o;m=[m[0]+a[0]*p,m[1]+a[1]*p,m[2]+a[2]*p];return{newFocalPoint:m,newPosition:[m[0]+c[0],m[1]+c[1],m[2]+c[2]]}}},90537:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n(3823),a=n(74876),o=n(42384);function s(e,t){const{imagePositionPatient:n,imageOrientationPatient:s}=a.get("imagePlaneModule",e[0]);if(!t){const e=i.eR.fromValues(s[0],s[1],s[2]),n=i.eR.fromValues(s[3],s[4],s[5]);t=i.eR.create(),i.eR.cross(t,e,n)}const r="wadouri"===e[0].split(":")[0],l=(0,o.A)(e);let d;function c(e){const{imagePositionPatient:o}=a.get("imagePlaneModule",e),s=i.eR.create();return i.eR.sub(s,n,o),i.eR.dot(s,t)}if(r){const t=[e[0],e[Math.floor(e.length/2)]];d=e;c(t[0])-c(t[1])<0&&d.reverse()}else{const t=e.map(e=>({distance:c(e),imageId:e}));t.sort((e,t)=>t.distance-e.distance),d=t.map(e=>e.imageId)}const{imagePositionPatient:h}=a.get("imagePlaneModule",d[0]);return{zSpacing:l,origin:h,sortedImageIds:d}}},8126:(e,t,n)=>{"use strict";function i(e){const t=e.getSize(),n=[];for(let i=0;i<t;i++){const t=[];e.getNodeValue(i,t),n.push(t)}return n}function a(e,t){t?.length&&(e.removeAllPoints(),t.forEach(t=>{e.addRGBPoint(...t)}))}n.r(t),n.d(t,{getTransferFunctionNodes:()=>i,setTransferFunctionNodes:()=>a})},51919:(e,t,n)=>{"use strict";n.d(t,{e:()=>a});var i=n(38669);function a(e,t){const{imageData:n}=e.getImageData(),a=e.canvasToWorld(t);return(0,i.A)(n,a)}},94741:(e,t,n)=>{"use strict";function i(e,t){return e.indexToWorld(t)}n.d(t,{A:()=>i})},38669:(e,t,n)=>{"use strict";function i(e,t){return e.worldToIndex(t).map(Math.round)}function a(e,t){return e.worldToIndex(t)}n.d(t,{A:()=>i,p:()=>a})},41365:(e,t,n)=>{"use strict";n.d(t,{O:()=>s});var i=n(74638),a=n(3823);const o=.95;function s(e,t){if(!e?.length||!t.FrameOfReferenceUID)return;t.planeRestriction||={FrameOfReferenceUID:t.FrameOfReferenceUID,point:e[0],inPlaneVector1:null,inPlaneVector2:null};const{planeRestriction:n}=t;if(1===e.length)return n.inPlaneVector1=null,n.inPlaneVector2=null,n;const s=a.eR.sub(a.eR.create(),e[0],e[Math.floor(e.length/2)]);a.eR.normalize(s,s),n.inPlaneVector1=s,n.inPlaneVector2=null;const r=e.length;if(r>2)for(let t=Math.floor(r/3);t<r;t++){const s=a.eR.sub(a.eR.create(),e[t],e[0]),r=a.eR.length(s);if(!(0,i.n4)(r,0)&&a.eR.dot(s,n.inPlaneVector1)<r*o)return a.eR.normalize(s,s),n.inPlaneVector2=s,n}return n}},45278:(e,t,n)=>{"use strict";function i(e,t){const n=t.voxelManager.getScalarData();if(!e.getPointData)return;const i=e.getPointData().getScalars().getData();if(t.color&&t.rgba){const e=new Uint8Array(t.columns*t.rows*3);for(let i=0;i<t.columns*t.rows;i++)e[3*i]=n[4*i],e[3*i+1]=n[4*i+1],e[3*i+2]=n[4*i+2];t.rgba=!1,t.getPixelData=()=>e,i.set(e)}else i.set(n);e.modified()}n.d(t,{J:()=>i})},68136:(e,t,n)=>{"use strict";n.r(t),n.d(t,{toLowHighRange:()=>o,toWindowLevel:()=>a});var i=n(82501);n(58977);function a(e,t){return{windowWidth:Math.abs(t-e)+1,windowCenter:(e+t+1)/2}}function o(e,t,n=i.A.LINEAR){if(n===i.A.LINEAR||n===i.A.SAMPLED_SIGMOID)return{lower:t-.5-(e-1)/2,upper:t-.5+(e-1)/2};if(n===i.A.LINEAR_EXACT)return{lower:t-e/2,upper:t+e/2};throw new Error("Invalid VOI LUT function")}},94350:(e,t,n)=>{"use strict";var i={};n.r(i),n.d(i,{getPoint:()=>Z,getPolyDataPointIndexes:()=>Y,getPolyDataPoints:()=>j});var a={};n.r(a),n.d(a,{boundingBox:()=>G,geometricSurfaceUtils:()=>ie,getCalibratedLengthUnitsAndScale:()=>R.Op,math:()=>N,planar:()=>V,polyDataUtils:()=>i,setAnnotationLabel:()=>oe,throttle:()=>P.A,triggerAnnotationRenderForViewportIds:()=>L.A});var o=n(99178),s=n(15327),r=n(82056),l=n(99737);n(68040),n(21418),n(56069);n(94021),n(40100);n(74690);n(70333);const{Active:d,Passive:c,Enabled:h}=l.ToolModes,{Active:g,Passive:u,Enabled:m}=l.ToolModes;n(84971);n(27740);const{Active:p,Passive:v,Enabled:f}=l.ToolModes;var w=n(85204);n(39011);n(57725),n(39848);var E=n(6802);n(65136);n(48145);var I=n(77609);n(59475),n(24917);n(36625);n(93952);const{CAMERA_MODIFIED:C}=s.Enums.Events;const{CAMERA_MODIFIED:b}=s.Enums.Events;const{CAMERA_MODIFIED:_}=s.Enums.Events;var T=n(3823);const{STACK_NEW_IMAGE:A,VOLUME_NEW_IMAGE:S}=s.Enums.Events;const{CAMERA_MODIFIED:M}=s.Enums.Events;var D=n(74347);var y=n(52905),P=n(27730);n(45217);const{calibratedPixelSpacingMetadataProvider:x}=s.utilities;var R=n(4096),L=n(58640);n(94779),n(4296);n(40133),n(64485),n(6936);var O,U=n(93759),k=n(473),N=n(95527),V=n(13165),W=n(60810);!function(e){e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED"}(O||(O={}));const{ViewportStatus:B}=s.Enums,{triggerEvent:H}=s.utilities;new Map;var G=n(72282);n(61587).A;n(37162);const{isEqual:F}=s.utilities;T.eR.fromValues(1,0,0),T.eR.fromValues(0,1,0),T.eR.fromValues(0,0,1);n(30045),n(94762);const{imageRetrieveMetadataProvider:z}=s.utilities;const{imageRetrieveMetadataProvider:X}=s.utilities;n(19027),n(76260),n(64063);function $(e,t){const n=e.getScalarDataLength(),i=new Float32Array(n);for(const a of t){const t=e.getDimensionGroupScalarData(a);for(let e=0;e<n;e++)i[e]+=t[e]}return i}s.Enums.GenerateImageType.SUM,s.Enums.GenerateImageType.AVERAGE,s.Enums.GenerateImageType.SUBTRACT;function Z(e,t){const n=3*t;if(n<e.length)return T.eR.fromValues(e[n],e[n+1],e[n+2])}function Y(e){const t=e.getLines().getData();let n=0;const i=new Map;for(;n<t.length;){const e=t[n++],a=[];for(let i=0;i<e;i++)a.push(t[n+i]);i.set(a[0],a),n+=e}const a=[],o=e=>{for(const[t,n]of e.entries())if(void 0!==n)return t;return-1};let s=o(i);for(;-1!==s;){const e=[s];for(;i.has(s);){const t=i.get(s)[1];i.has(t)&&e.push(t),i.delete(s),s=t}a.push(e),s=o(i)}return a.length?a:void 0}function j(e){const t=Y(e);if(!t)return;const n=e.getPoints().getData();return t.map(e=>e.map(e=>Z(n,e)))}n(51807),n(57227);var q=n(20646),K=(n(33517),n(62184),n(79457),n(44845));q.U.Right;K.A;n(22658);const{Events:J}=s.Enums;function Q(e){if(e instanceof s.VolumeViewport)return function(e){const{scalarData:t,width:n,height:i}=s.utilities.getCurrentVolumeViewportSlice(e),{min:a,max:o}=s.utilities.getMinMax(t);return{scalarData:t,minPixelValue:a,maxPixelValue:o,width:n,height:i,rows:n,columns:i}}(e);if(e instanceof s.StackViewport)return function(e){const t=e.getImageData(),{scalarData:n}=t,{min:i,max:a}=s.utilities.getMinMax(n),o=t.dimensions[0],r=t.dimensions[1],{rows:l,columns:d,color:c}=e.getCornerstoneImage();return{scalarData:n,width:o,height:r,minPixelValue:i,maxPixelValue:a,rows:l,columns:d,color:c}}(e);throw new Error("Viewport not supported")}var ee=n(56534);n(62783);const{transformWorldToIndex:te}=s.utilities;n(27963),n(67912);var ne=n(40634),ie=n(5565),ae=n(44049);function oe(e,t,n){e.data.label=n,(0,ae.triggerAnnotationModified)(e,t,l.ChangeTypes.LabelChange)}n(9175);n(83075);function se(e,t,n,i,a){const o=function(e,t=7){if(!e.length)throw new Error("Convex hull is empty");const n=e.length,i=e=>(e+1)%n,a=(e,t)=>{const n=[];for(let a=e;n.push(a),a!==t;a=i(a));return n};let o=0,s=0;for(let t=1;t<n;t++)e[t][0]<e[o][0]&&(o=t),e[t][0]>e[s][0]&&(s=t);const r=e[o],l=e[s],d=a(o,s),c=a(s,o),h=Math.min(...e.map(e=>e[1])),g=d.some(t=>e[t][1]===h)?d:c,u=Math.min(...g.map(t=>e[t][1]));let m=g.map(t=>e[t]).filter(e=>Math.abs(e[1]-u)<=t);return m.length<2&&(m=g.map(t=>e[t]).sort((e,t)=>e[1]-t[1]).slice(0,2)),{P1:m.reduce((e,t)=>t[0]<e[0]?t:e,m[0]),P2:r,P3:l,P4:m.reduce((e,t)=>t[0]>e[0]?t:e,m[0])}}(i),s=function(e,t,n,i,a,o={}){const{maxDist:s=15,slack:r=2}=o,l={dx:-1,dy:-1},d={dx:-1,dy:1},c={dx:1,dy:1},h={dx:1,dy:-1};function g(i,{dx:o,dy:l},d=5){const c=o<0?i[0]-s:i[0]-r,h=o<0?i[0]+r:i[0]+s,g=l<0?i[1]-s:i[1]-r,u=l<0?i[1]+r:i[1]+s;let m=i;for(const[i,s]of a){if(i<c||i>h||s<g||s>u)continue;const a=Math.round(i),r=Math.round(s);if(a<0||a>=t||r<0||r>=n)continue;const p=(a-m[0])*o,v=(r-m[0])*l;e[r*t+a]>d&&(p>0||v>0)&&(m=[i,s])}return m}return{P1:g(i.P1,l),P2:g(i.P2,d),P3:g(i.P3,c),P4:g(i.P4,h)}}(e,t,n,o,a,{maxDist:20,step:.5});return s}var re=n(93258);function le(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function de(e){const t=s.cache.getImage(e);if(!t)return;const n=t.width,i=t.height;return{pixelData:t.getPixelData(),width:n,height:i}}function ce(e){const{pixelData:t,width:n,height:i}=de(e)||{};if(!t)return;const a=function(e,t,n){const i=t*n,a=e.length/i;if(![1,3,4].includes(a))throw new Error("Buffer must be 1, 3, or 4 channels per pixel");const o=Array.from({length:n},()=>new Array(t).fill(!1));for(let i=0;i<n;i++)for(let n=0;n<t;n++){const s=(i*t+n)*a;let r=!1;for(let t=0;t<Math.min(3,a);t++)if(e[s+t]>0){r=!0;break}o[i][n]=r}const s=Array.from({length:n},()=>new Array(t).fill(0));let r=0;const l={};for(let e=0;e<n;e++)for(let i=0;i<t;i++)if(o[e][i]&&0===s[e][i]){r++;const a=(e,i)=>!(e<0||e>=t||i<0||i>=n)&&o[i][e]&&0===s[i][e];let d=0;const c={onFlood:(e,t)=>{s[t][e]=r,d++},diagonals:!1};(0,U.floodFill)(a,[i,e],c),l[r]=d}if(0===r)return[];const d=Object.keys(l).reduce((e,t)=>l[e]>l[t]?e:t);function c(e,i){if(s[i][e]!==+d)return!1;for(const[a,o]of[[1,0],[-1,0],[0,1],[0,-1]]){const r=e+a,l=i+o;if(r<0||r>=t||l<0||l>=n||s[l][r]!==+d)return!0}return!1}let h=null;e:for(let e=0;e<n;e++)for(let n=0;n<t;n++)if(c(n,e)){h=[n,e];break e}if(!h)return[];const g=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]],u=[];let m=h,p=[h[0]-1,h[1]];do{u.push([m[0],m[1]]);const e=p[0]-m[0],i=p[1]-m[1];let a=g.findIndex(t=>t[0]===e&&t[1]===i);a<0&&(a=0);let o=null;for(let e=1;e<=8;e++){const[i,s]=g[(a+e)%8],r=m[0]+i,l=m[1]+s;if(r>=0&&r<t&&l>=0&&l<n&&c(r,l)){o=[r,l];const[t,n]=g[(a+e-1+8)%8];p=[m[0]+t,m[1]+n];break}}if(!o)break;m=o}while(m[0]!==h[0]||m[1]!==h[1]);return u}(t,n,i),{simplified:o,hull:s}=function(e){const t=N.polyline.decimate(e,2);return{simplified:t,hull:N.polyline.convexHull(t)}}(a),r=se(t,n,i,s,o);return{contour:a,simplified:o,hull:s,refined:r,fanGeometry:function(e){const{P1:t,P2:n,P3:i,P4:a}=e,o=(0,re.intersectLine)(t,n,a,i,!0);if(!o)throw new Error("Fan edges appear parallel  no apex found");const s=o;let r=le(s,t)*(180/Math.PI),l=le(s,a)*(180/Math.PI);if(l<=r){const e=r;r=l,l=e}const d=Math.hypot(t[0]-s[0],t[1]-s[1]),c=Math.hypot(a[0]-s[0],a[1]-s[1]),h=Math.hypot(n[0]-s[0],n[1]-s[1]),g=Math.hypot(i[0]-s[0],i[1]-s[1]);return{center:s,startAngle:r,endAngle:l,innerRadius:Math.min(d,c),outerRadius:Math.max(h,g)}}({P1:r.P1,P2:r.P2,P3:r.P3,P4:r.P4})}}s.utilities.roundNumber;n(79475),n(13369),n(47807);var he=n(55126);class ge{constructor(e){this._controlPoints=[],this._invalidated=!1,this._length=0,this._controlPoints=[],this._resolution=e?.resolution??20,this._fixedResolution=e?.fixedResolution??!1,this._closed=e?.closed??!1,this._invalidated=!0}get controlPoints(){return this._controlPoints}get numControlPoints(){return this._controlPoints.length}get resolution(){return this._resolution}set resolution(e){this._fixedResolution||this._resolution===e||(this._resolution=e,this.invalidated=!0)}get fixedResolution(){return this._fixedResolution}get closed(){return this._closed}set closed(e){this._closed!==e&&(this._closed=e,this.invalidated=!0)}get aabb(){return this._update(),this._aabb}get length(){return this._update(),this._length}get invalidated(){return this._invalidated}set invalidated(e){this._invalidated=e}hasTangentPoints(){return!1}addControlPoint(e){this._controlPoints.push([e[0],e[1]]),this.invalidated=!0}addControlPoints(e){e.forEach(e=>this.addControlPoint(e))}addControlPointAtU(e){const t=this._getLineSegmentAt(e),{start:n,end:i}=t.points,a=Math.floor(e),o=this._curveSegments[a],s=e-Math.floor(a),r=[n[0]+s*(i[0]-n[0]),n[1]+s*(i[1]-n[1])],l=this._controlPoints.indexOf(o.controlPoints.p1)+1;return this._controlPoints.splice(l,0,r),this.invalidated=!0,{index:l,point:r}}deleteControlPointByIndex(e){const t=this._closed?3:1;return e>=0&&e<this._controlPoints.length&&this._controlPoints.length>t&&(this._controlPoints.splice(e,1),this.invalidated=!0,!0)}clearControlPoints(){this._controlPoints=[],this.invalidated=!0}setControlPoints(e){this.clearControlPoints(),this.addControlPoints(e)}updateControlPoint(e,t){if(e<0||e>=this._controlPoints.length)throw new Error("Index out of bounds");this._controlPoints[e]=[...t],this.invalidated=!0}getControlPoints(){return this._controlPoints.map(e=>[e[0],e[1]])}getClosestControlPoint(e){const t=this._controlPoints;let n=1/0,i=-1;for(let a=0,o=t.length;a<o;a++){const o=t[a],s=e[0]-o[0],r=e[1]-o[1],l=s*s+r*r;l<n&&(n=l,i=a)}return{index:i,point:-1===i?void 0:[...t[i]],distance:Math.sqrt(n)}}getClosestControlPointWithinDistance(e,t){const n=this.getClosestControlPoint(e);return n.distance<=t?n:void 0}getClosestPoint(e){this._update();const t=this._getCurveSegmmentsDistanceSquaredInfo(e);if(!t.length)return;let n;t.sort((e,t)=>e.distanceSquared-t.distanceSquared);let i,a,o=-1,s=1/0;for(let r=0;r<t.length;r++){const l=t[r];if(l.distanceSquared>s)continue;const{curveSegmentIndex:d,curveSegment:c}=l,{lineSegments:h}=c;for(let t=0;t<h.length;t++){const r=h[t],{point:c,distanceSquared:g}=N.lineSegment.distanceToPointSquaredInfo(r.points.start,r.points.end,e);g<s&&(a=r,o=d,i=l.curveSegment,n=c,s=g)}}return{point:n,uValue:o+(a.previousLineSegmentsLength+N.point.distanceToPoint(a.points.start,n))/i.length,distance:Math.sqrt(s)}}getClosestPointOnControlPointLines(e){const t=[...this._controlPoints];if(this._closed&&t.push(this._controlPoints[0]),!t.length)return;let n,i=1/0,a=t[0];for(let o=1,s=t.length;o<s;o++){const s=t[o],{point:r,distanceSquared:l}=N.lineSegment.distanceToPointSquaredInfo(a,s,e);l<i&&(n=r,i=l),a=s}return{point:n,distance:Math.sqrt(i)}}getPolylinePoints(){return this._update(),this._convertCurveSegmentsToPolyline(this._curveSegments)}getPreviewPolylinePoints(e,t){if(this._closed)return[];this._update();const n=this.getClosestControlPointWithinDistance(e,t),i=0===n?.index,a=this.getPreviewCurveSegments(e,i);return a?.length?this._convertCurveSegmentsToPolyline(a):[]}isPointNearCurve(e,t){this._update();const n=this._getCurveSegmmentsWithinDistance(e,t),i=t*t;for(let t=0;t<n.length;t++){const{lineSegments:a}=n[t];for(let t=0;t<a.length;t++){const n=a[t];if(N.lineSegment.distanceToPointSquared(n.points.start,n.points.end,e)<=i)return!0}}return!1}containsPoint(e){this._update();if(this._controlPoints.length<3)return!1;const t=[...this._curveSegments],n=this._getClosingCurveSegmentWithStraightLineSegment();n&&t.push(n);let i=0;for(let n=0;n<t.length;n++){const a=t[n],{aabb:o}=a;if(!(e[0]<=o.maxX&&e[1]>=o.minY&&e[1]<o.maxY))continue;const{lineSegments:s}=a;for(let t=0;t<s.length;t++){const n=s[t],{aabb:a}=n;if(e[0]<=a.maxX&&e[1]>=a.minY&&e[1]<a.maxY){const{start:t,end:a}=n.points,o=t[0]===a[0],s=(e[1]-t[1])*(a[0]-t[0])/(a[1]-t[1])+t[0];i+=o||e[0]<=s?1:0}}}return i%2==1}_update(){if(!this._invalidated)return;const e=this.getSplineCurves();let t=0,n=1/0,i=1/0,a=-1/0,o=-1/0;for(let s=0,r=e.length;s<r;s++){const{aabb:r,length:l}=e[s];n=n<=r.minX?n:r.minX,i=i<=r.minY?i:r.minY,a=a>=r.maxX?a:r.maxX,o=o>=r.maxY?o:r.maxY,t+=l}this._curveSegments=e,this._aabb={minX:n,minY:i,maxX:a,maxY:o},this._length=t,this._invalidated=!1}_convertCurveSegmentsToPolyline(e){this._update();const t=[];return e.forEach(({lineSegments:e},n)=>{e.forEach((e,i)=>{0===n&&0===i&&t.push([...e.points.start]),t.push([...e.points.end])})}),t}_getCurveSegmmentsDistanceSquaredInfo(e){this._update();const t=[],{_curveSegments:n}=this;for(let i=0;i<n.length;i++){const a=n[i],o=N.aabb.distanceToPointSquared(a.aabb,e);t.push({curveSegmentIndex:i,curveSegment:a,distanceSquared:o})}return t}_getCurveSegmmentsWithinDistance(e,t){this._update();const n=t*t;if(N.aabb.distanceToPointSquared(this.aabb,e)>n)return[];const i=this._getCurveSegmmentsDistanceSquaredInfo(e),a=[];for(let e=0,t=i.length;e<t;e++){const{curveSegment:t,distanceSquared:o}=i[e];o<=n&&a.push(t)}return a}_getLineSegmentAt(e){this._update();const t=Math.floor(e),n=e-t,i=this._curveSegments[t],{lineSegments:a}=i,o=i.length*n;for(let e=0;e<a.length;e++){const t=a[e],n=t.previousLineSegmentsLength+t.length;if(o>=t.previousLineSegmentsLength&&o<=n)return t}}_getClosingCurveSegmentWithStraightLineSegment(){if(this.closed)return;const e=this._controlPoints,t=e[0],n=e[e.length-1],i={points:{start:[...t],end:[...n]},aabb:{minX:Math.min(t[0],n[0]),minY:Math.min(t[1],n[1]),maxX:Math.max(t[0],n[0]),maxY:Math.max(t[1],n[1])}};return{aabb:{minX:i.aabb.minX,minY:i.aabb.minY,maxX:i.aabb.maxX,maxY:i.aabb.maxY},lineSegments:[i]}}}class ue extends ge{getPreviewCurveSegments(e,t){const n=this._getNumCurveSegments()+1,i=Math.max(0,n-2),a=t?n:n-1,o=this.getTransformMatrix(),s=[...this.controlPoints],r=[];t||s.push(e);for(let e=i;e<=a;e++){const n=this._getCurveSegment(e,o,s,t);r.push(n)}return r}getSplineCurves(){const e=this._getNumCurveSegments(),t=new Array(e);if(e<=0)return[];const n=this.getTransformMatrix();let i=0;for(let a=0;a<e;a++){const e=this._getCurveSegment(a,n);e.previousCurveSegmentsLength=i,t[a]=e,i+=e.length}return t}_getNumCurveSegments(e=this.controlPoints,t=this.closed){return t?e.length:Math.max(0,e.length-1)}_getPoint(e,t,n=this.controlPoints,i=this.closed){const a=this._getNumCurveSegments(n,i),o=Math.floor(e);let s=o%a;const r=e-o;if(s<0||s>=a){if(!this.closed)return;s=(a+s)%a}const{p0:l,p1:d,p2:c,p3:h}=this._getCurveSegmentPoints(s,n,i),g=r*r,u=g*r,m=T.ln.fromValues(1,r,g,u),p=T.ln.transformMat4(T.ln.create(),m,t);return[T.ln.dot(p,T.ln.fromValues(l[0],d[0],c[0],h[0])),T.ln.dot(p,T.ln.fromValues(l[1],d[1],c[1],h[1]))]}_getCurveSegmentPoints(e,t=this.controlPoints,n=this.closed){const i=this._getNumCurveSegments(t,n),a=e-1,o=n?(e+1)%i:e+1,s=o+1,r=t[e],l=t[o];let d,c;return d=a>=0?t[a]:n?t[t.length-1]:N.point.mirror(l,r),c=s<t.length?t[s]:n?t[0]:N.point.mirror(r,l),{p0:d,p1:r,p2:l,p3:c}}_getLineSegments(e,t,n=this.controlPoints,i=this.closed){const a=this._getNumCurveSegments(n,i),o=this.resolution+1,s=1/o;let r=e+1;i||e!==a-1||(r-=1e-8);const l=[];let d,c,h=0;for(let a=0,g=e;a<=o;a++,g+=s){g=g>r?r:g;const e=this._getPoint(g,t,n,i);if(!a){d=e;continue}c=e;const o=c[0]-d[0],s=c[1]-d[1],u=Math.sqrt(o**2+s**2),m={minX:d[0]<=c[0]?d[0]:c[0],maxX:d[0]>=c[0]?d[0]:c[0],minY:d[1]<=c[1]?d[1]:c[1],maxY:d[1]>=c[1]?d[1]:c[1]};l.push({points:{start:d,end:c},aabb:m,length:u,previousLineSegmentsLength:h}),d=c,h+=u}return l}_getCurveSegment(e,t=this.getTransformMatrix(),n=this.controlPoints,i=this.closed){const{p0:a,p1:o,p2:s,p3:r}=this._getCurveSegmentPoints(e,n,i),l=this._getLineSegments(e,t,n,i);let d=0,c=1/0,h=1/0,g=-1/0,u=-1/0;return l.forEach(({aabb:e,length:t})=>{c=Math.min(c,e.minX),h=Math.min(h,e.minY),g=Math.max(g,e.maxX),u=Math.max(u,e.maxY),d+=t}),{controlPoints:{p0:a,p1:o,p2:s,p3:r},aabb:{minX:c,minY:h,maxX:g,maxY:u},length:d,previousCurveSegmentsLength:0,lineSegments:l}}}const me=T.pB.multiplyScalar(T.pB.create(),T.pB.fromValues(1,4,1,0,-3,0,3,0,3,-6,3,0,-1,3,-3,1),1/6);class pe extends ue{getTransformMatrix(){return me}}class ve extends ue{constructor(e){super(e),this._scale=e?.scale??.5,this._fixedScale=e?.fixedScale??!1}get scale(){return this._scale}set scale(e){this._fixedScale||this._scale===e||(this._scale=e,this.invalidated=!0)}get fixedScale(){return this._fixedScale}getTransformMatrix(){const{scale:e}=this,t=2*e;return[0,1,0,0,-e,0,e,0,t,e-3,3-t,-e,-e,2-e,e-2,e]}}class fe extends ve{constructor(){super({scale:.5,fixedScale:!0})}}class we extends ve{constructor(){super({resolution:0,fixedResolution:!0,scale:0,fixedScale:!0})}}var Ee=n(85817);class Ie extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{limitToViewport:!1}}){super(e,t)}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_checkImageInViewport(e,t){const{canvas:n}=e,i=window.devicePixelRatio,a=n.width/i,o=n.height/i,r=e.getDefaultActor(),l=e.getRenderer();let d;if(r&&s.utilities.isImageActor(r)){d=r.actor.getMapper().getInputData().getBounds()}else d=l.computeVisiblePropBounds();const[c,h]=e.worldToCanvas([d[0],d[2],d[4]]),[g,u]=e.worldToCanvas([d[1],d[3],d[5]]);if(e.getZoom()<=1){if(c+t[0]<0&&t[0]<0||g+t[0]>a&&t[0]>0||h+t[1]<0&&t[1]<0||u+t[1]>o&&t[1]>0)return!1}else if(c+t[0]>0&&t[0]>0||g+t[0]<a&&t[0]<0||h+t[1]>0&&t[1]>0||u+t[1]<o&&t[1]<0)return!1;return!0}_dragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,s.getEnabledElement)(t),a=n.world,o=n.canvas;if(0===a[0]&&0===a[1]&&0===a[2])return;const r=i.viewport,l=r.getCamera(),{focalPoint:d,position:c}=l;if(this.configuration.limitToViewport&&!this._checkImageInViewport(r,o))return;const h=[c[0]-a[0],c[1]-a[1],c[2]-a[2]],g=[d[0]-a[0],d[1]-a[1],d[2]-a[2]];r.setCamera({focalPoint:g,position:h}),r.render()}}Ie.toolName="Pan";var Ce=n(84607);class be extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2,rotateSampleDistanceFactor:2}}){super(e,t),this._resizeObservers=new Map,this._hasResolutionChanged=!1,this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,i=(0,s.getEnabledElement)(n),{viewport:a}=i,o=a.getDefaultActor().actor.getMapper();if(!("getSampleDistance"in o||"getCurrentSampleDistance"in o))return!0;const r=o.getSampleDistance();if(!this._hasResolutionChanged){const{rotateSampleDistanceFactor:e}=this.configuration;o.setSampleDistance(r*e),this._hasResolutionChanged=!0,null!==this.cleanUp&&document.removeEventListener("mouseup",this.cleanUp),this.cleanUp=()=>{o.setSampleDistance(r),a.render(),this._hasResolutionChanged=!1},document.addEventListener("mouseup",this.cleanUp,{once:!0})}return!0},this._getViewportsInfo=()=>(0,I.getToolGroup)(this.toolGroupId).viewportsInfo,this.onSetToolActive=()=>{const e=()=>{this._getViewportsInfo().forEach(({viewportId:e,renderingEngineId:t})=>{if(!this._resizeObservers.has(e)){const{viewport:n}=(0,s.getEnabledElementByIds)(e,t)||{viewport:null};if(!n)return;const{element:i}=n,a=new ResizeObserver(()=>{const n=(0,s.getEnabledElementByIds)(e,t);if(!n)return;const{viewport:i}=n,a=i.getViewPresentation();i.resetCamera(),i.setViewPresentation(a),i.render()});a.observe(i),this._resizeObservers.set(e,a)}})};e(),this._viewportAddedListener=t=>{t.detail.toolGroupId===this.toolGroupId&&e()},s.eventTarget.addEventListener(l.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener)},this.onSetToolDisabled=()=>{this._resizeObservers.forEach((e,t)=>{e.disconnect(),this._resizeObservers.delete(t)}),this._viewportAddedListener&&(s.eventTarget.removeEventListener(l.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener),this._viewportAddedListener=null)},this.rotateCamera=(e,t,n,i)=>{const a=e.getVtkActiveCamera(),o=a.getViewUp(),s=a.getFocalPoint(),r=a.getPosition(),l=[0,0,0],d=[0,0,0],c=[0,0,0],h=T.pB.identity(new Float32Array(16));T.pB.translate(h,h,t),T.pB.rotate(h,h,i,n),T.pB.translate(h,h,[-t[0],-t[1],-t[2]]),T.eR.transformMat4(l,r,h),T.eR.transformMat4(d,s,h),T.pB.identity(h),T.pB.rotate(h,h,i,n),T.eR.transformMat4(c,o,h),e.setCamera({position:l,viewUp:c,focalPoint:d})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:i}=e.detail,a=n.canvas,o=i.canvas,{rotateIncrementDegrees:r}=this.configuration,l=(0,s.getEnabledElement)(t),{viewport:d}=l,c=d.getCamera(),h=t.clientWidth,g=t.clientHeight,u=[a[0]/h,a[1]/g],m=[o[0]/h,o[1]/g],p=[.5*h,.5*g],v=d.canvasToWorld(p),f=(1+Math.abs(.5))**2,w=[m[0],0,0],E=[u[0],0,0],I=w[0]**2,C=E[0]**2,b=I>f?0:Math.sqrt(f-I),_=C>f?0:Math.sqrt(f-C),T=[w[0],0,b];Ce.Ay.normalize(T);const A=[E[0],0,_];Ce.Ay.normalize(A);const S=Ce.Ay.dot(T,A);if(Math.abs(S)>1e-4){const e=-2*Math.acos(Ce.Ay.clampValue(S,-1,1))*Math.sign(u[0]-m[0])*r,t=c.viewUp,n=c.viewPlaneNormal,i=[0,0,0],a=[0,0,0];Ce.Ay.cross(t,n,i),Ce.Ay.normalize(i),Ce.Ay.cross(n,i,a),Ce.Ay.normalize(a),Ce.Ay.normalize(t),this.rotateCamera(d,v,a,e);const o=(m[1]-u[1])*r;this.rotateCamera(d,v,i,o),d.render()}}}be.toolName="TrackballRotate";var _e=n(87275),Te=n(74966),Ae=n(35056),Se=n(7019),Me=n(1060),De=n(82409),ye=n(75127);const Pe=0,xe=1,Re=2,Le=3,Oe=4,Ue=5,ke={XMIN:0,XMAX:1,YMIN:2,YMAX:3,ZMIN:4,ZMAX:5,XMIN_YMIN_ZMIN:6,XMIN_YMIN_ZMAX:7,XMIN_YMAX_ZMIN:8,XMIN_YMAX_ZMAX:9,XMAX_YMIN_ZMIN:10,XMAX_YMIN_ZMAX:11,XMAX_YMAX_ZMIN:12,XMAX_YMAX_ZMAX:13};class Ne extends Ee.oS{constructor(e={},t={configuration:{showCornerSpheres:!0,showHandles:!0,showClippingPlanes:!0,mobile:{enabled:!1,opacity:.8},initialCropFactor:.08,sphereColors:{SAGITTAL:[1,1,0],CORONAL:[0,1,0],AXIAL:[1,0,0],CORNERS:[0,0,1]},sphereRadius:8,grabSpherePixelDistance:20,rotateIncrementDegrees:2,rotateSampleDistanceFactor:2}}){super(e,t),this._resizeObservers=new Map,this._hasResolutionChanged=!1,this.originalClippingPlanes=[],this.draggingSphereIndex=null,this.toolCenter=[0,0,0],this.cornerDragOffset=null,this.faceDragOffset=null,this.sphereStates=[],this.edgeLines={},this.onSetToolConfiguration=()=>{console.debug("Setting tool settoolconfiguration : volumeCropping")},this.onSetToolEnabled=()=>{console.debug("Setting tool enabled: volumeCropping")},this.onCameraModified=e=>{const{element:t}=e.currentTarget?{element:e.currentTarget}:e.detail,n=(0,s.getEnabledElement)(t);this._updateClippingPlanes(n.viewport),n.viewport.render()},this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,i=(0,s.getEnabledElement)(n),{viewport:a}=i,o=a.getDefaultActor().actor.getMapper(),r=[e.detail.currentPoints.canvas[0],e.detail.currentPoints.canvas[1]];this.draggingSphereIndex=null,this.cornerDragOffset=null,this.faceDragOffset=null;for(let e=0;e<this.sphereStates.length;++e){const t=a.worldToCanvas(this.sphereStates[e].point);if(Math.sqrt(Math.pow(r[0]-t[0],2)+Math.pow(r[1]-t[1],2))<this.configuration.grabSpherePixelDistance){this.draggingSphereIndex=e,n.style.cursor="grabbing";const t=this.sphereStates[e],i=a.canvasToWorld(r);if(t.isCorner)this.cornerDragOffset=[t.point[0]-i[0],t.point[1]-i[1],t.point[2]-i[2]],this.faceDragOffset=null;else{const e={x:0,y:1,z:2}[t.axis];this.faceDragOffset=t.point[e]-i[e],this.cornerDragOffset=null}return!0}}if(!("getSampleDistance"in o||"getCurrentSampleDistance"in o))return!0;const l=o.getSampleDistance();if(!this._hasResolutionChanged){const{rotateSampleDistanceFactor:t}=this.configuration;o.setSampleDistance(l*t),this._hasResolutionChanged=!0,null!==this.cleanUp&&document.removeEventListener("mouseup",this.cleanUp),this.cleanUp=()=>{if(o.setSampleDistance(l),e.target.style.cursor="",null!==this.draggingSphereIndex){const e=this.sphereStates[this.draggingSphereIndex],[t]=this._getViewportsInfo(),n=(0,s.getRenderingEngine)(t.renderingEngineId).getViewport(t.viewportId);e.isCorner&&(this._updateCornerSpheres(),this._updateFaceSpheresFromCorners(),this._updateClippingPlanesFromFaceSpheres(n))}this.draggingSphereIndex=null,this.cornerDragOffset=null,this.faceDragOffset=null,a.render(),this._hasResolutionChanged=!1},document.addEventListener("mouseup",this.cleanUp,{once:!0})}return!0},this._onMouseMoveSphere=e=>{if(null===this.draggingSphereIndex)return!1;const t=this.sphereStates[this.draggingSphereIndex];if(!t)return!1;const{viewport:n,world:i}=this._getViewportAndWorldCoords(e);if(!n||!i)return!1;if(t.isCorner){const e=this._calculateNewCornerPosition(i);this._updateSpherePosition(t,e);const n=this._parseCornerKey(t.uid);this._updateRelatedCorners(t,e,n),this._updateFaceSpheresFromCorners(),this._updateCornerSpheres()}else{const e={x:0,y:1,z:2}[t.axis];let n=i[e];null!==this.faceDragOffset&&(n+=this.faceDragOffset),t.point[e]=n,t.sphereSource.setCenter(...t.point),t.sphereSource.modified(),this._updateCornerSpheresFromFaces(),this._updateFaceSpheresFromCorners(),this._updateCornerSpheres()}return this._updateClippingPlanesFromFaceSpheres(n),n.render(),this._triggerToolChangedEvent(t),!0},this._onControlToolChange=e=>{const t=this._getViewport();if(e.detail.toolCenter){if(e.detail.seriesInstanceUID!==this.seriesInstanceUID)return;const n="min"===e.detail.handleType,i=n?e.detail.toolCenterMin:e.detail.toolCenterMax,a=n?[[1,0,0],[0,1,0],[0,0,1]]:[[-1,0,0],[0,-1,0],[0,0,-1]],o=n?[Pe,Re,Oe]:[xe,Le,Ue],r=n?[ke.XMIN,ke.YMIN,ke.ZMIN]:[ke.XMAX,ke.YMAX,ke.ZMAX],l=["x","y","z"],d=[s.Enums.OrientationAxis.SAGITTAL,s.Enums.OrientationAxis.CORONAL,s.Enums.OrientationAxis.AXIAL];for(let n=0;n<3;++n){const s=[0,0,0];s[n]=i[n];const c=ye.Ay.newInstance({origin:s,normal:a[n]});this.originalClippingPlanes[o[n]].origin=c.getOrigin(),this.sphereStates[r[n]].point[n]=c.getOrigin()[n],this.sphereStates[r[n]].sphereSource.setCenter(...this.sphereStates[r[n]].point),this.sphereStates[r[n]].sphereSource.modified();const h=(this.sphereStates.find((e,t)=>e.axis===l[n]&&t!==r[n]).point[n]+c.getOrigin()[n])/2;this.sphereStates.forEach(t=>{t.isCorner||t.axis===l[n]||e.detail.viewportOrientation.includes(d[n])||(t.point[n]=h,t.sphereSource.setCenter(t.point),t.sphereActor.getProperty().setColor(t.color),t.sphereSource.modified())});const g=t.getDefaultActor()?.actor;if(g){const e=g.getMapper().getClippingPlanes();e&&e[o[n]].setOrigin(c.getOrigin())}}this._updateCornerSpheres(),t.render()}else(0,s.triggerEvent)(s.eventTarget,l.Events.VOLUMECROPPING_TOOL_CHANGED,{originalClippingPlanes:this.originalClippingPlanes,viewportId:t.id,renderingEngineId:t.renderingEngineId,seriesInstanceUID:this.seriesInstanceUID})},this._getViewportsInfo=()=>(0,I.getToolGroup)(this.toolGroupId).viewportsInfo,this._initialize3DViewports=e=>{if(!e||!e.length||!e[0])return void console.warn("VolumeCroppingTool: No viewportsInfo available for initialization of volumecroppingtool.");const t=this._getViewport(),n=t.getActors();if(!n||0===n.length)return void console.warn("VolumeCroppingTool: No volume actors found in the viewport.");const i=n[0].actor.getMapper().getInputData();if(!i)return void console.warn("VolumeCroppingTool: No image data found for volume actor.");this.seriesInstanceUID=i.seriesInstanceUID||"unknown";const a=i.getBounds(),o=this.configuration.initialCropFactor||.1,r=a[1]-a[0],d=a[3]-a[2],c=a[5]-a[4],h=a[0]+o*r,g=a[1]-o*r,u=a[2]+o*d,m=a[3]-o*d,p=a[4]+o*c,v=a[5]-o*c,f=[],w=ye.Ay.newInstance({origin:[h,0,0],normal:[1,0,0]}),E=ye.Ay.newInstance({origin:[g,0,0],normal:[-1,0,0]}),I=ye.Ay.newInstance({origin:[0,u,0],normal:[0,1,0]}),C=ye.Ay.newInstance({origin:[0,m,0],normal:[0,-1,0]}),b=ye.Ay.newInstance({origin:[0,0,p],normal:[0,0,1]}),_=ye.Ay.newInstance({origin:[0,0,v],normal:[0,0,-1]}),T=t.getDefaultActor().actor.getMapper();f.push(w),f.push(E),f.push(I),f.push(C),f.push(b),f.push(_);const A=f.map(e=>({origin:[...e.getOrigin()],normal:[...e.getNormal()]}));this.originalClippingPlanes=A;const S=[h,(m+u)/2,(v+p)/2],M=[g,(m+u)/2,(v+p)/2],D=[(g+h)/2,u,(v+p)/2],y=[(g+h)/2,m,(v+p)/2],P=[(g+h)/2,(m+u)/2,p],x=[(g+h)/2,(m+u)/2,v],R=this._calculateAdaptiveSphereRadius(Math.sqrt(r*r+d*d+c*c));this._addSphere(t,S,"x","min",null,R),this._addSphere(t,M,"x","max",null,R),this._addSphere(t,D,"y","min",null,R),this._addSphere(t,y,"y","max",null,R),this._addSphere(t,P,"z","min",null,R),this._addSphere(t,x,"z","max",null,R);const L=[[h,u,p],[h,u,v],[h,m,p],[h,m,v],[g,u,p],[g,u,v],[g,m,p],[g,m,v]],O=["XMIN_YMIN_ZMIN","XMIN_YMIN_ZMAX","XMIN_YMAX_ZMIN","XMIN_YMAX_ZMAX","XMAX_YMIN_ZMIN","XMAX_YMIN_ZMAX","XMAX_YMAX_ZMIN","XMAX_YMAX_ZMAX"];for(let e=0;e<L.length;e++)this._addSphere(t,L[e],"corner",null,O[e],R);[["XMIN_YMIN_ZMIN","XMAX_YMIN_ZMIN"],["XMIN_YMIN_ZMAX","XMAX_YMIN_ZMAX"],["XMIN_YMAX_ZMIN","XMAX_YMAX_ZMIN"],["XMIN_YMAX_ZMAX","XMAX_YMAX_ZMAX"],["XMIN_YMIN_ZMIN","XMIN_YMAX_ZMIN"],["XMIN_YMIN_ZMAX","XMIN_YMAX_ZMAX"],["XMAX_YMIN_ZMIN","XMAX_YMAX_ZMIN"],["XMAX_YMIN_ZMAX","XMAX_YMAX_ZMAX"],["XMIN_YMIN_ZMIN","XMIN_YMIN_ZMAX"],["XMIN_YMAX_ZMIN","XMIN_YMAX_ZMAX"],["XMAX_YMIN_ZMIN","XMAX_YMIN_ZMAX"],["XMAX_YMAX_ZMIN","XMAX_YMAX_ZMAX"]].forEach(([e,n],i)=>{const a=this.sphereStates.find(t=>t.uid===`corner_${e}`),o=this.sphereStates.find(e=>e.uid===`corner_${n}`);if(a&&o){const i=`edge_${e}_${n}`,{actor:s,source:r}=this._addLine3DBetweenPoints(t,a.point,o.point,[.7,.7,.7],i);this.edgeLines[i]={actor:s,source:r,key1:e,key2:n}}}),T.addClippingPlane(w),T.addClippingPlane(E),T.addClippingPlane(I),T.addClippingPlane(C),T.addClippingPlane(b),T.addClippingPlane(_),s.eventTarget.addEventListener(l.Events.VOLUMECROPPINGCONTROL_TOOL_CHANGED,e=>{this._onControlToolChange(e)}),t.render()},this._getViewportAndWorldCoords=e=>{const t=this._getViewport(),n=e.detail.currentPoints.canvas[0],i=e.detail.currentPoints.canvas[1],a=t.canvasToWorld([n,i]);return{viewport:t,world:a}},this._getViewport=()=>{const[e]=this._getViewportsInfo();return(0,s.getRenderingEngine)(e.renderingEngineId).getViewport(e.viewportId)},this._handleCornerSphereMovement=(e,t,n)=>{const i=this._calculateNewCornerPosition(t);this._updateSpherePosition(e,i);const a=this._parseCornerKey(e.uid);this._updateRelatedCorners(e,i,a),this._updateAfterCornerMovement(n)},this._handleFaceSphereMovement=(e,t,n)=>{const i={x:0,y:1,z:2}[e.axis];let a=t[i];null!==this.faceDragOffset&&(a+=this.faceDragOffset),e.point[i]=a,e.sphereSource.setCenter(...e.point),e.sphereSource.modified(),this._updateAfterFaceMovement(n)},this._calculateNewCornerPosition=e=>{let t=[e[0],e[1],e[2]];return this.cornerDragOffset&&(t=[e[0]+this.cornerDragOffset[0],e[1]+this.cornerDragOffset[1],e[2]+this.cornerDragOffset[2]]),t},this._parseCornerKey=e=>{const t=e.replace("corner_","");return{isXMin:t.includes("XMIN"),isXMax:t.includes("XMAX"),isYMin:t.includes("YMIN"),isYMax:t.includes("YMAX"),isZMin:t.includes("ZMIN"),isZMax:t.includes("ZMAX")}},this._updateSpherePosition=(e,t)=>{e.point=t,e.sphereSource.setCenter(...t),e.sphereSource.modified()},this._updateRelatedCorners=(e,t,n)=>{this.sphereStates.forEach(i=>{if(!i.isCorner||i===e)return;const a=i.uid.replace("corner_","");this._shouldUpdateCorner(a,n)&&this._updateCornerCoordinates(i,t,a,n)})},this._shouldUpdateCorner=(e,t)=>t.isXMin&&e.includes("XMIN")||t.isXMax&&e.includes("XMAX")||t.isYMin&&e.includes("YMIN")||t.isYMax&&e.includes("YMAX")||t.isZMin&&e.includes("ZMIN")||t.isZMax&&e.includes("ZMAX"),this._updateCornerCoordinates=(e,t,n,i)=>{(i.isXMin&&n.includes("XMIN")||i.isXMax&&n.includes("XMAX"))&&(e.point[0]=t[0]),(i.isYMin&&n.includes("YMIN")||i.isYMax&&n.includes("YMAX"))&&(e.point[1]=t[1]),(i.isZMin&&n.includes("ZMIN")||i.isZMax&&n.includes("ZMAX"))&&(e.point[2]=t[2]),e.sphereSource.setCenter(...e.point),e.sphereSource.modified()},this._updateAfterCornerMovement=e=>{this._updateFaceSpheresFromCorners(),this._updateCornerSpheres(),this._updateClippingPlanesFromFaceSpheres(e)},this._updateAfterFaceMovement=e=>{this._updateCornerSpheresFromFaces(),this._updateClippingPlanesFromFaceSpheres(e)},this._triggerToolChangedEvent=e=>{(0,s.triggerEvent)(s.eventTarget,l.Events.VOLUMECROPPING_TOOL_CHANGED,{toolCenter:e.point,axis:e.isCorner?"corner":e.axis,draggingSphereIndex:this.draggingSphereIndex,seriesInstanceUID:this.seriesInstanceUID})},this._onNewVolume=()=>{const e=this._getViewportsInfo();this.originalClippingPlanes=[],this.sphereStates=[],this.edgeLines={},this._initialize3DViewports(e)},this._rotateCamera=(e,t,n,i)=>{const a=e.getVtkActiveCamera(),o=a.getViewUp(),s=a.getFocalPoint(),r=a.getPosition(),l=[0,0,0],d=[0,0,0],c=[0,0,0],h=T.pB.identity(new Float32Array(16));T.pB.translate(h,h,t),T.pB.rotate(h,h,i,n),T.pB.translate(h,h,[-t[0],-t[1],-t[2]]),T.eR.transformMat4(l,r,h),T.eR.transformMat4(d,s,h),T.pB.identity(h),T.pB.rotate(h,h,i,n),T.eR.transformMat4(c,o,h),e.setCamera({position:l,viewUp:c,focalPoint:d})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}onSetToolActive(){if(this.sphereStates&&this.sphereStates.length>0)this.configuration.showHandles?(this.setHandlesVisible(!1),this.setClippingPlanesVisible(!1)):(this.setHandlesVisible(!0),this.setClippingPlanesVisible(!0));else{const e=this._getViewportsInfo(),t=()=>{e.forEach(({viewportId:e,renderingEngineId:t})=>{if(!this._resizeObservers.has(e)){const{viewport:n}=(0,s.getEnabledElementByIds)(e,t)||{viewport:null};if(!n)return;const{element:i}=n,a=new ResizeObserver(()=>{const n=(0,s.getEnabledElementByIds)(e,t);if(!n)return;const{viewport:i}=n,a=i.getViewPresentation();i.resetCamera(),i.setViewPresentation(a),i.render()});a.observe(i),this._resizeObservers.set(e,a)}})};t(),this._viewportAddedListener=e=>{e.detail.toolGroupId===this.toolGroupId&&t()},s.eventTarget.addEventListener(l.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener),this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this._initialize3DViewports(e),this.sphereStates&&this.sphereStates.length>0?this.setHandlesVisible(!0):(this.originalClippingPlanes=[],this._initialize3DViewports(e))}}onSetToolDisabled(){this._resizeObservers.forEach((e,t)=>{e.disconnect(),this._resizeObservers.delete(t)}),this._viewportAddedListener&&(s.eventTarget.removeEventListener(l.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener),this._viewportAddedListener=null);const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e)}setHandlesVisible(e){this.configuration.showHandles=e,e&&(this.sphereStates[ke.XMIN].point[0]=this.originalClippingPlanes[Pe].origin[0],this.sphereStates[ke.XMAX].point[0]=this.originalClippingPlanes[xe].origin[0],this.sphereStates[ke.YMIN].point[1]=this.originalClippingPlanes[Re].origin[1],this.sphereStates[ke.YMAX].point[1]=this.originalClippingPlanes[Le].origin[1],this.sphereStates[ke.ZMIN].point[2]=this.originalClippingPlanes[Oe].origin[2],this.sphereStates[ke.ZMAX].point[2]=this.originalClippingPlanes[Ue].origin[2],[ke.XMIN,ke.XMAX,ke.YMIN,ke.YMAX,ke.ZMIN,ke.ZMAX].forEach(e=>{const t=this.sphereStates[e];t.sphereSource.setCenter(...t.point),t.sphereSource.modified()}),this._updateCornerSpheres()),this._updateHandlesVisibility();const t=this._getViewportsInfo(),[n]=t;(0,s.getRenderingEngine)(n.renderingEngineId).getViewport(n.viewportId).render()}getHandlesVisible(){return this.configuration.showHandles}getClippingPlanesVisible(){return this.configuration.showClippingPlanes}setClippingPlanesVisible(e){this.configuration.showClippingPlanes=e;const t=this._getViewport();this._updateClippingPlanes(t),t.render()}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:i}=e.detail;if(null!==this.draggingSphereIndex)this._onMouseMoveSphere(e);else{const e=n.canvas,a=i.canvas,{rotateIncrementDegrees:o}=this.configuration,r=(0,s.getEnabledElement)(t),{viewport:l}=r,d=l.getCamera(),c=t.clientWidth,h=t.clientHeight,g=[e[0]/c,e[1]/h],u=[a[0]/c,a[1]/h],m=[.5*c,.5*h],p=l.canvasToWorld(m),v=[.5,.5],f=(1+Math.abs(v[0]))**2,w=[u[0],0,0],E=[g[0],0,0],I=w[0]**2,C=E[0]**2,b=I>f?0:Math.sqrt(f-I),_=C>f?0:Math.sqrt(f-C),T=[w[0],0,b];Ce.Ay.normalize(T);const A=[E[0],0,_];Ce.Ay.normalize(A);const S=Ce.Ay.dot(T,A);if(Math.abs(S)>1e-4){const e=-2*Math.acos(Ce.Ay.clampValue(S,-1,1))*Math.sign(g[0]-u[0])*o,t=d.viewUp,n=d.viewPlaneNormal,i=[0,0,0],a=[0,0,0];Ce.Ay.cross(t,n,i),Ce.Ay.normalize(i),Ce.Ay.cross(n,i,a),Ce.Ay.normalize(a),Ce.Ay.normalize(t),this._rotateCamera(l,p,a,e);const s=(u[1]-g[1])*o;this._rotateCamera(l,p,i,s)}l.render()}}_updateClippingPlanes(e){const t=e.getDefaultActor();if(!t||!t.actor)return void(e._missingActorWarned||(console.warn("VolumeCroppingTool._updateClippingPlanes: No default actor found in viewport."),e._missingActorWarned=!0));const n=t.actor,i=n.getMapper(),a=n.getMatrix();if(!this.configuration.showClippingPlanes)return void i.removeAllClippingPlanes();const o=T.w0.create();T.w0.fromMat4(o,a);const s=T.w0.create();T.w0.invert(s,o),T.w0.transpose(s,s);const r=this.originalClippingPlanes;if(!r||!r.length)return;i.removeAllClippingPlanes();const l=[],d=[];for(let e=0;e<r.length;++e){const t=r[e],n=T.eR.create();T.eR.transformMat4(n,new Float32Array(t.origin),a);const i=[n[0],n[1],n[2]],o=T.eR.create();T.eR.transformMat3(o,new Float32Array(t.normal),s),T.eR.normalize(o,o);const c=[o[0],o[1],o[2]];l.push(i),d.push(c)}for(let e=0;e<l.length;++e){const t=ye.Ay.newInstance({origin:l[e],normal:d[e]});i.addClippingPlane(t)}}_updateHandlesVisibility(){this.sphereStates.forEach(e=>{e.sphereActor&&e.sphereActor.setVisibility(this.configuration.showHandles)}),Object.values(this.edgeLines).forEach(({actor:e})=>{e&&e.setVisibility(this.configuration.showHandles)})}_addLine3DBetweenPoints(e,t,n,i=[.7,.7,.7],a=""){if(t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2])return{actor:null,source:null};const o=Te.Ay.newInstance();o.setNumberOfPoints(2),o.setPoint(0,t[0],t[1],t[2]),o.setPoint(1,n[0],n[1],n[2]);const s=Ae.Ay.newInstance({values:[2,0,1]}),r=_e.Ay.newInstance();r.setPoints(o),r.setLines(s);const l=De.Ay.newInstance();l.setInputData(r);const d=Se.Ay.newInstance();return d.setMapper(l),d.getProperty().setColor(...i),d.getProperty().setLineWidth(.5),d.getProperty().setOpacity(1),d.getProperty().setInterpolationToFlat(),d.getProperty().setAmbient(1),d.getProperty().setDiffuse(0),d.getProperty().setSpecular(0),d.setVisibility(this.configuration.showHandles),e.addActor({actor:d,uid:a}),{actor:d,source:r}}_addSphere(e,t,n,i,a=null,o){const s=a?`corner_${a}`:`${n}_${i}`;if(this.sphereStates.find(e=>e.uid===s))return;const r=Me.Ay.newInstance();r.setCenter(t),r.setRadius(o);const l=De.Ay.newInstance();l.setInputConnection(r.getOutputPort());const d=Se.Ay.newInstance();d.setMapper(l);let c=[0,1,0];const h=this.configuration.sphereColors||{};a?c=h.CORNERS||[0,0,1]:"z"===n?c=h.AXIAL||[1,0,0]:"x"===n?c=h.SAGITTAL||[1,1,0]:"y"===n&&(c=h.CORONAL||[0,1,0]);const g=this.sphereStates.findIndex(e=>e.uid===s);-1===g?this.sphereStates.push({point:t.slice(),axis:n,uid:s,sphereSource:r,sphereActor:d,isCorner:!!a,color:c}):(this.sphereStates[g].point=t.slice(),this.sphereStates[g].sphereSource=r);e.getActors().find(e=>e.uid===s)||(d.getProperty().setColor(c),d.setVisibility(this.configuration.showHandles),e.addActor({actor:d,uid:s}))}_calculateAdaptiveSphereRadius(e){void 0!==this.configuration.sphereRadius&&this.configuration.sphereRadius;const t=e*(this.configuration.sphereRadiusScale||.01),n=this.configuration.minSphereRadius||2,i=this.configuration.maxSphereRadius||50;return Math.max(n,Math.min(i,t))}_updateClippingPlanesFromFaceSpheres(e){const t=e.getDefaultActor().actor.getMapper();this.originalClippingPlanes[0].origin=[...this.sphereStates[ke.XMIN].point],this.originalClippingPlanes[1].origin=[...this.sphereStates[ke.XMAX].point],this.originalClippingPlanes[2].origin=[...this.sphereStates[ke.YMIN].point],this.originalClippingPlanes[3].origin=[...this.sphereStates[ke.YMAX].point],this.originalClippingPlanes[4].origin=[...this.sphereStates[ke.ZMIN].point],this.originalClippingPlanes[5].origin=[...this.sphereStates[ke.ZMAX].point],t.removeAllClippingPlanes();for(let e=0;e<6;++e){const n=this.originalClippingPlanes[e].origin,i=this.originalClippingPlanes[e].normal,a=ye.Ay.newInstance({origin:n,normal:i});t.addClippingPlane(a)}}_updateCornerSpheresFromFaces(){const e=this.sphereStates[ke.XMIN].point[0],t=this.sphereStates[ke.XMAX].point[0],n=this.sphereStates[ke.YMIN].point[1],i=this.sphereStates[ke.YMAX].point[1],a=this.sphereStates[ke.ZMIN].point[2],o=this.sphereStates[ke.ZMAX].point[2],s=[{key:"XMIN_YMIN_ZMIN",pos:[e,n,a]},{key:"XMIN_YMIN_ZMAX",pos:[e,n,o]},{key:"XMIN_YMAX_ZMIN",pos:[e,i,a]},{key:"XMIN_YMAX_ZMAX",pos:[e,i,o]},{key:"XMAX_YMIN_ZMIN",pos:[t,n,a]},{key:"XMAX_YMIN_ZMAX",pos:[t,n,o]},{key:"XMAX_YMAX_ZMIN",pos:[t,i,a]},{key:"XMAX_YMAX_ZMAX",pos:[t,i,o]}];for(const e of s){const t=this.sphereStates.find(t=>t.uid===`corner_${e.key}`);t&&(t.point[0]=e.pos[0],t.point[1]=e.pos[1],t.point[2]=e.pos[2],t.sphereSource.setCenter(...t.point),t.sphereSource.modified())}}_updateFaceSpheresFromCorners(){const e=[this.sphereStates[ke.XMIN_YMIN_ZMIN].point,this.sphereStates[ke.XMIN_YMIN_ZMAX].point,this.sphereStates[ke.XMIN_YMAX_ZMIN].point,this.sphereStates[ke.XMIN_YMAX_ZMAX].point,this.sphereStates[ke.XMAX_YMIN_ZMIN].point,this.sphereStates[ke.XMAX_YMIN_ZMAX].point,this.sphereStates[ke.XMAX_YMAX_ZMIN].point,this.sphereStates[ke.XMAX_YMAX_ZMAX].point],t=e.map(e=>e[0]),n=e.map(e=>e[1]),i=e.map(e=>e[2]),a=Math.min(...t),o=Math.max(...t),s=Math.min(...n),r=Math.max(...n),l=Math.min(...i),d=Math.max(...i);this.sphereStates[ke.XMIN].point=[a,(s+r)/2,(l+d)/2],this.sphereStates[ke.XMAX].point=[o,(s+r)/2,(l+d)/2],this.sphereStates[ke.YMIN].point=[(a+o)/2,s,(l+d)/2],this.sphereStates[ke.YMAX].point=[(a+o)/2,r,(l+d)/2],this.sphereStates[ke.ZMIN].point=[(a+o)/2,(s+r)/2,l],this.sphereStates[ke.ZMAX].point=[(a+o)/2,(s+r)/2,d],[ke.XMIN,ke.XMAX,ke.YMIN,ke.YMAX,ke.ZMIN,ke.ZMAX].forEach(e=>{const t=this.sphereStates[e];t.sphereSource.setCenter(...t.point),t.sphereSource.modified()})}_updateCornerSpheres(){const e=this.sphereStates[ke.XMIN].point[0],t=this.sphereStates[ke.XMAX].point[0],n=this.sphereStates[ke.YMIN].point[1],i=this.sphereStates[ke.YMAX].point[1],a=this.sphereStates[ke.ZMIN].point[2],o=this.sphereStates[ke.ZMAX].point[2],s=[{key:"XMIN_YMIN_ZMIN",pos:[e,n,a]},{key:"XMIN_YMIN_ZMAX",pos:[e,n,o]},{key:"XMIN_YMAX_ZMIN",pos:[e,i,a]},{key:"XMIN_YMAX_ZMAX",pos:[e,i,o]},{key:"XMAX_YMIN_ZMIN",pos:[t,n,a]},{key:"XMAX_YMIN_ZMAX",pos:[t,n,o]},{key:"XMAX_YMAX_ZMIN",pos:[t,i,a]},{key:"XMAX_YMAX_ZMAX",pos:[t,i,o]}];for(const e of s){const t=this.sphereStates.find(t=>t.uid===`corner_${e.key}`);t&&(t.point[0]=e.pos[0],t.point[1]=e.pos[1],t.point[2]=e.pos[2],t.sphereSource.setCenter(...t.point),t.sphereSource.modified())}Object.values(this.edgeLines).forEach(({source:e,key1:t,key2:n})=>{const i=this.sphereStates.find(e=>e.uid===`corner_${t}`),a=this.sphereStates.find(e=>e.uid===`corner_${n}`);if(i&&a){const t=e.getPoints();t.setPoint(0,i.point[0],i.point[1],i.point[2]),t.setPoint(1,a.point[0],a.point[1],a.point[2]),t.modified(),e.modified()}})}_unsubscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,s.getEnabledElementByIds)(e,t),{element:i}=n;i.removeEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_subscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,s.getEnabledElementByIds)(e,t),{element:i}=n;i.addEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}}Ne.toolName="VolumeCropping";var Ve=n(7001),We=n(35381),Be=n(2076);const{RENDERING_DEFAULTS:He}=s.CONSTANTS;function Ge(){return"rgb(0, 200, 0)"}function Fe(){return!0}const ze=1;class Xe extends Ee.EC{constructor(e={},t={supportedInteractionTypes:["Mouse"],configuration:{viewportIndicators:!1,viewportIndicatorsConfig:{radius:5,x:null,y:null},extendReferenceLines:!0,initialCropFactor:.2,mobile:{enabled:!1,opacity:.8},lineColors:{AXIAL:[1,0,0],CORONAL:[0,1,0],SAGITTAL:[1,1,0],UNKNOWN:[0,0,1]},lineWidth:1.5,lineWidthActive:2.5}}){super(e,t),this._virtualAnnotations=[],this.sphereStates=[],this.draggingSphereIndex=null,this.toolCenter=[0,0,0],this.toolCenterMin=[0,0,0],this.toolCenterMax=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:t})=>{if(!e||!t)return void console.warn("VolumeCroppingControlTool: Missing renderingEngineId or viewportId");const n=(0,s.getEnabledElementByIds)(t,e);if(!n)return;const{viewport:i}=n;this._updateToolCentersFromViewport(i);const{element:a}=i,{position:o,focalPoint:l,viewPlaneNormal:d}=i.getCamera();let c=this._getAnnotations(n);c=this.filterInteractableAnnotationsForElement(a,c),c?.length&&(0,r.removeAnnotation)(c[0].annotationUID);const h=this._getOrientationFromNormal(i.getCamera().viewPlaneNormal),g={highlighted:!1,metadata:{cameraPosition:[...o],cameraFocalPoint:[...l],toolName:this.getToolName()},data:{handles:{toolCenter:this.toolCenter,toolCenterMin:this.toolCenterMin,toolCenterMax:this.toolCenterMax},activeOperation:null,activeViewportIds:[],viewportId:t,referenceLines:[],orientation:h}};return(0,r.addAnnotation)(g,a),{normal:d,point:i.canvasToWorld([100,100])}},this._getViewportsInfo=()=>(0,I.getToolGroup)(this.toolGroupId).viewportsInfo,this.resetCroppingSpheres=()=>{const e=this._getViewportsInfo();for(const t of e){const{viewportId:e,renderingEngineId:n}=t,i=(0,s.getEnabledElementByIds)(e,n),a=i.viewport,o=!0,l=!0,d=!0,c=!0,h=!0;a.resetCamera({resetPan:o,resetZoom:l,resetToCenter:d,resetRotation:c,suppressEvents:h}),a.resetSlabThickness();const{element:g}=a;let u=this._getAnnotations(i);u=this.filterInteractableAnnotationsForElement(g,u),u.length&&(0,r.removeAnnotation)(u[0].annotationUID),a.render()}this._computeToolCenter(e)},this.computeToolCenter=()=>{this._getViewportsInfo()},this._computeToolCenter=e=>{if(!e||!e[0])return void console.warn("  _computeToolCenter : No valid viewportsInfo for computeToolCenter.");const t=["AXIAL","CORONAL","SAGITTAL"],n=e.map(e=>{if(e.renderingEngineId){const t=(0,s.getRenderingEngine)(e.renderingEngineId).getViewport(e.viewportId);if(t&&t.getCamera){const e=this._getOrientationFromNormal(t.getCamera().viewPlaneNormal);if(e)return e}}return null}).filter(Boolean),i=t.find(e=>!n.includes(e)),a=[],o=[],r=e.filter(e=>{let n=null;if(e.renderingEngineId){const t=(0,s.getRenderingEngine)(e.renderingEngineId).getViewport(e.viewportId);t&&t.getCamera&&(n=this._getOrientationFromNormal(t.getCamera().viewPlaneNormal))}return n&&t.includes(n)});if(r.forEach(e=>{const{normal:t,point:n}=this.initializeViewport(e);a.push(t),o.push(n)}),2===r.length&&i){const e=[0,0,0];T.eR.cross(e,a[0],a[1]),T.eR.normalize(e,e);const t=[(o[0][0]+o[1][0])/2,(o[0][1]+o[1][1])/2,(o[0][2]+o[1][2])/2],n=null,s={highlighted:!1,metadata:{cameraPosition:[...t],cameraFocalPoint:[...t],toolName:this.getToolName()},data:{handles:{activeOperation:null,toolCenter:this.toolCenter,toolCenterMin:this.toolCenterMin,toolCenterMax:this.toolCenterMax},activeViewportIds:[],viewportId:i,referenceLines:[],orientation:n},isVirtual:!0,virtualNormal:e};this._virtualAnnotations=[s]}else if(1===r.length){let e=null;const n=r[0];if(n.renderingEngineId){const t=(0,s.getRenderingEngine)(n.renderingEngineId).getViewport(n.viewportId);t&&t.getCamera&&(e=this._getOrientationFromNormal(t.getCamera().viewPlaneNormal))}const i=o[0],a={AXIAL:[0,0,1],CORONAL:[0,1,0],SAGITTAL:[1,0,0]},l=t.filter(t=>t!==e).map(e=>{const t=a[e];return{highlighted:!1,metadata:{cameraPosition:[...i],cameraFocalPoint:[...i],toolName:this.getToolName()},data:{handles:{activeOperation:null,toolCenter:this.toolCenter,toolCenterMin:this.toolCenterMin,toolCenterMax:this.toolCenterMax},activeViewportIds:[],viewportId:e,referenceLines:[],orientation:e},isVirtual:!0,virtualNormal:t}});this._virtualAnnotations=l}e&&e.length&&(0,L.A)(e.map(({viewportId:e})=>e))},this.cancel=()=>{console.log("Not implemented yet")},this.isPointNearTool=(e,t,n,i)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i;t.highlighted=!0,this._activateModify(a),(0,Ve.hideElementCursor)(a),e.preventDefault()},this.onResetCamera=e=>{this.resetCroppingSpheres()},this.mouseMoveCallback=(e,t)=>{if(!t)return;const{element:n,currentPoints:i}=e.detail,a=i.canvas;let o=!1;for(let e=0;e<t.length;e++){const i=t[e];if((0,Be.isAnnotationLocked)(i.annotationUID))continue;const{data:s,highlighted:r}=i;if(!s.handles)continue;s.handles.activeOperation,s.activeViewportIds&&s.activeViewportIds.length>0&&s.activeViewportIds;s.activeViewportIds=[];let l=!1;l=this._pointNearTool(n,i,a,6);(l&&!r||!l&&r)&&(i.highlighted=!r,o=!0)}return o},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];const n=(0,s.getEnabledElement)(e);let i=null;n.viewport&&n.viewport.getCamera&&(i=this._getOrientationFromNormal(n.viewport.getCamera().viewPlaneNormal));const a=t.filter(e=>!!e.isVirtual||!(!e.data.orientation||!i||e.data.orientation!==i));return a},this.renderAnnotation=(e,t)=>{function n(e,t,n,i){const a=t[0]-e[0],o=t[1]-e[1],s=i[0]-n[0],r=i[1]-n[1],l=-s*o+a*r;if(Math.abs(l)<1e-8)return null;const d=(-o*(e[0]-n[0])+a*(e[1]-n[1]))/l,c=(s*(e[1]-n[1])-r*(e[0]-n[0]))/l;return d>=0&&d<=1&&c>=0&&c<=1?[e[0]+c*a,e[1]+c*o]:null}const i=this._getViewportsInfo();if(!i||0===i.length)return!1;let a=!1;const{viewport:o,renderingEngine:s}=e,{element:r}=o;let l=this._getAnnotations(e);this._virtualAnnotations&&this._virtualAnnotations.length&&(l=l.concat(this._virtualAnnotations));const d=o.getCamera(),c=this.filterInteractableAnnotationsForElement(r,l)[0];if(!c||!c.data)return a;const h=c.annotationUID,{clientWidth:g,clientHeight:u}=o.canvas,m=Math.sqrt(g*g+u*u),p=c.data,v=l,f=o.worldToCanvas(this.toolCenterMin),w=o.worldToCanvas(this.toolCenterMax),E=[],I=[0,0,g,u];v.forEach(e=>{const t=e.data,n="isVirtual"in e&&!0===e.isVirtual;let a,r,l,c,h,g,u;if(t.handles.toolCenter=this.toolCenter,n){const n=i.filter(e=>e.viewportId!==t.viewportId);if(2===n.length){const e=s.getViewport(n[0].viewportId),i=s.getViewport(n[1].viewportId),d=e.getCamera().viewPlaneNormal,m=i.getCamera().viewPlaneNormal,p=T.eR.create();T.eR.cross(p,d,m),T.eR.normalize(p,p),r={viewPlaneNormal:p,position:t.handles.toolCenter,focalPoint:t.handles.toolCenter,viewUp:[0,1,0]},l=o.canvas.clientWidth,c=o.canvas.clientHeight,h=Math.sqrt(l*l+c*c),g=[.5*l,.5*c],u=t.handles.toolCenter,a={id:t.viewportId,canvas:o.canvas,canvasToWorld:()=>t.handles.toolCenter}}else{r={viewPlaneNormal:e.virtualNormal??[0,0,1],position:t.handles.toolCenter,focalPoint:t.handles.toolCenter,viewUp:[0,1,0]},l=o.canvas.clientWidth,c=o.canvas.clientHeight,h=Math.sqrt(l*l+c*c),g=[.5*l,.5*c],u=t.handles.toolCenter,a={id:t.viewportId,canvas:o.canvas,canvasToWorld:()=>t.handles.toolCenter}}}else a=s.getViewport(t.viewportId),r=a.getCamera(),l=a.canvas.clientWidth,c=a.canvas.clientHeight,h=Math.sqrt(l*l+c*c),g=[.5*l,.5*c],u=a.canvasToWorld(g);const p=this._getReferenceLineControllable(a.id),v=[0,0,0];Ce.Ay.cross(d.viewPlaneNormal,r.viewPlaneNormal,v),Ce.Ay.normalize(v),Ce.Ay.multiplyScalar(v,h);const C=[0,0,0];Ce.Ay.add(u,v,C);Ce.Ay.subtract(u,v,[0,0,0]);const b=o.worldToCanvas(C),_=o.worldToCanvas([u[0]??0,u[1]??0,u[2]??0]),A=T.Zc.create();T.Zc.subtract(A,b,_),T.Zc.normalize(A,A);const S=T.Zc.create();T.Zc.scale(S,A,100*m);const M=p?T.Zc.clone(f):T.Zc.clone(_),D=T.Zc.create(),y=T.Zc.create();T.Zc.add(D,M,S),T.Zc.subtract(y,M,S),(0,We.A)(D,y,I),E.push([a,D,y,"min"]);const P=p?T.Zc.clone(w):T.Zc.clone(_),x=T.Zc.create(),R=T.Zc.create();T.Zc.add(x,P,S),T.Zc.subtract(R,P,S),(0,We.A)(x,R,I),E.push([a,x,R,"max"])}),p.referenceLines=E;const C=this._getReferenceLineColor(o.id),b=void 0!==C?C:"rgb(200, 200, 200)";if(E.forEach((e,i)=>{const a=[];for(let t=0;t<E.length;++t){if(t===i)continue;const o=E[t],s=n(e[1],e[2],o[1],o[2]);s&&a.push({with:o[3],point:s})}const o=e[0];let s=null;if(o&&o.id){const e=l.find(e=>e.data.viewportId===o.id);if(e&&e.data.orientation)s=String(e.data.orientation).toUpperCase();else{const e=o.id.toUpperCase();e.includes("AXIAL")?s="AXIAL":e.includes("CORONAL")?s="CORONAL":e.includes("SAGITTAL")&&(s="SAGITTAL")}}const r=this.configuration.lineColors||{},d=r[s]||r.unknown||[1,0,0],c=Array.isArray(d)?`rgb(${d.map(e=>Math.round(255*e)).join(",")})`:d,g=this._getReferenceLineControllable(o.id),u=p.activeViewportIds.find(e=>e===o.id);let m=this.configuration.lineWidth??1.5;null!==p.handles.activeOperation&&p.handles.activeOperation===ze&&u&&(m=this.configuration.activeLineWidth??2.5);const v=`${i}`;if(g&&(2===a.length&&(0,D.drawLine)(t,h,v,a[0].point,a[1].point,{color:c,lineWidth:m}),this.configuration.extendReferenceLines&&2===a.length&&this.configuration.extendReferenceLines&&2===a.length)){const n=a.map(t=>({...t,distance:T.Zc.distance(e[1],t.point)})).sort((e,t)=>e.distance-t.distance);(0,D.drawLine)(t,h,v+"_dashed_before",e[1],n[0].point,{color:c,lineWidth:m,lineDash:[4,4]}),(0,D.drawLine)(t,h,v+"_dashed_after",n[1].point,e[2],{color:c,lineWidth:m,lineDash:[4,4]})}}),a=!0,this.configuration.viewportIndicators){const{viewportIndicatorsConfig:e}=this.configuration,n=[g*(e?.xOffset||.95),u*(e?.yOffset||.05)],i=e?.circleRadius||.01*m,a="0";(0,D.drawCircle)(t,h,a,n,i,{color:b,fill:b})}return a},this._getAnnotations=e=>{const{viewport:t}=e,n=(0,r.getAnnotations)(this.getToolName(),t.element)||[],i=this._getViewportsInfo().map(({viewportId:e})=>e),a=n.filter(e=>{const{data:t}=e;return i.includes(t.viewportId)});return a},this._onSphereMoved=e=>{if(e.detail.originalClippingPlanes)this._syncWithVolumeCroppingTool(e.detail.originalClippingPlanes);else{if(e.detail.seriesInstanceUID!==this.seriesInstanceUID)return;const{draggingSphereIndex:t,toolCenter:n}=e.detail,i=[...this.toolCenterMin],a=[...this.toolCenterMax];if(t>=0&&t<=5){const e=Math.floor(t/2);return(t%2==0?i:a)[e]=n[e],this.setToolCenter(i,"min"),void this.setToolCenter(a,"max")}if(t>=6&&t<=13){const e=t;e<10?i[0]=n[0]:a[0]=n[0],[6,7,10,11].includes(e)?i[1]=n[1]:a[1]=n[1],e%2==0?i[2]=n[2]:a[2]=n[2],this.setToolCenter(i,"min"),this.setToolCenter(a,"max")}}},this._onNewVolume=()=>{const e=this._getViewportsInfo();if(e&&e.length>0){const{viewportId:t,renderingEngineId:n}=e[0],i=(0,s.getRenderingEngine)(n).getViewport(t),a=i.getActors();if(a.length>0){const e=a[0].actor.getMapper().getInputData();if(e){this.seriesInstanceUID=e.seriesInstanceUID,this._updateToolCentersFromViewport(i);((0,r.getAnnotations)(this.getToolName(),t)||[]).forEach(e=>{e.data&&e.data.handles&&(e.data.handles.toolCenter=[...this.toolCenter])})}}}this._computeToolCenter(e),(0,s.triggerEvent)(s.eventTarget,l.Events.VOLUMECROPPINGCONTROL_TOOL_CHANGED,{toolGroupId:this.toolGroupId,viewportsInfo:e,seriesInstanceUID:this.seriesInstanceUID})},this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{const{viewportId:n,renderingEngine:i,viewport:a}=e,o=t.filter(e=>e.data.viewportId!==n);if(!o||!o.length)return[];const r=a.getCamera(),{viewPlaneNormal:l,position:d}=r,c=o.filter(e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera();return!(s.utilities.isEqual(n.viewPlaneNormal,l,.01)&&s.utilities.isEqual(n.position,d,1))});return c},this._filterViewportWithSameOrientation=(e,t,n)=>{const{renderingEngine:i}=e,{data:a}=t,o=i.getViewport(a.viewportId),r=n.filter(e=>{const{data:t}=e,n=i.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)});if(!r||!r.length)return[];const l=o.getCamera(),d=l.viewPlaneNormal;Ce.Ay.normalize(d);const c=r.filter(e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera(),a=n.viewPlaneNormal;return Ce.Ay.normalize(a),s.utilities.isEqual(d,a,.01)&&s.utilities.isEqual(l.viewUp,n.viewUp,.01)});return c},this._activateModify=e=>{w.wk.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),(0,Ve.resetElementCursor)(n),this.editData=null;const i=(0,W.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,L.A)(i)},this._dragCallback=e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:i}=t,a=(0,s.getEnabledElement)(i),{viewport:o}=a;if(o.type===s.Enums.ViewportType.VOLUME_3D)return;const r=this._getAnnotations(a),d=this.filterInteractableAnnotationsForElement(i,r)[0];if(!d)return;const{handles:c}=d.data;if(c.activeOperation===ze){"min"===c.activeType?(this.toolCenterMin[0]+=n[0],this.toolCenterMin[1]+=n[1],this.toolCenterMin[2]+=n[2]):"max"===c.activeType?(this.toolCenterMax[0]+=n[0],this.toolCenterMax[1]+=n[1],this.toolCenterMax[2]+=n[2]):(this.toolCenter[0]+=n[0],this.toolCenter[1]+=n[1],this.toolCenter[2]+=n[2]);const e=this._getViewportsInfo();(0,L.A)(e.map(({viewportId:e})=>e)),(0,s.triggerEvent)(s.eventTarget,l.Events.VOLUMECROPPINGCONTROL_TOOL_CHANGED,{toolGroupId:this.toolGroupId,toolCenter:this.toolCenter,toolCenterMin:this.toolCenterMin,toolCenterMax:this.toolCenterMax,handleType:c.activeType,viewportOrientation:[],seriesInstanceUID:this.seriesInstanceUID})}},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||Ge,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||Fe;const n=(0,I.getToolGroup)(this.toolGroupId)?.viewportsInfo;if(s.eventTarget.addEventListener(l.Events.VOLUMECROPPING_TOOL_CHANGED,this._onSphereMoved),n&&n.length>0){const{viewportId:e,renderingEngineId:t}=n[0],i=((0,s.getEnabledElementByIds)(e,t),(0,s.getRenderingEngine)(t).getViewport(e).getActors());if(!i||!i.length)return void console.warn(`VolumeCroppingControlTool: No volume actors found in viewport ${e}.`);const a=i[0].actor.getMapper().getInputData();if(a){const e=a.getDimensions(),t=a.getSpacing(),n=a.getOrigin();this.seriesInstanceUID=a.seriesInstanceUID||"unknown";const i=this.configuration.initialCropFactor??.2;this.toolCenter=[n[0]+i*(e[0]-1)*t[0],n[1]+i*(e[1]-1)*t[1],n[2]+i*(e[2]-1)*t[2]];const o=1-i;this.toolCenterMin=[n[0]+i*(e[0]-1)*t[0],n[1]+i*(e[1]-1)*t[1],n[2]+i*(e[2]-1)*t[2]],this.toolCenterMax=[n[0]+o*(e[0]-1)*t[0],n[1]+o*(e[1]-1)*t[1],n[2]+o*(e[2]-1)*t[2]]}}}_updateToolCentersFromViewport(e){const t=e.getActors();if(!t||!t.length)return;const n=t[0].actor.getMapper().getInputData();if(!n)return;this.seriesInstanceUID=n.seriesInstanceUID||"unknown";const i=n.getDimensions(),a=n.getSpacing(),o=n.getOrigin(),s=this.configuration.initialCropFactor??.2,r=s/2,l=1-s/2;this.toolCenter=[o[0]+(r+l)/2*(i[0]-1)*a[0],o[1]+(r+l)/2*(i[1]-1)*a[1],o[2]+(r+l)/2*(i[2]-1)*a[2]],this.toolCenterMin=[o[0]+r*(i[0]-1)*a[0],o[1]+r*(i[1]-1)*a[1],o[2]+r*(i[2]-1)*a[2]],this.toolCenterMax=[o[0]+l*(i[0]-1)*a[0],o[1]+l*(i[1]-1)*a[1],o[2]+l*(i[2]-1)*a[2]]}onSetToolInactive(){console.debug(`VolumeCroppingControlTool: onSetToolInactive called for tool ${this.getToolName()}`)}onSetToolActive(){const e=this._getViewportsInfo();let t=!1;for(const n of e){const e=(0,s.getEnabledElementByIds)(n.viewportId,n.renderingEngineId),i=this._getAnnotations(e);if(i&&i.length>0){t=!0;break}}if(t)for(const t of e){const e=(0,s.getEnabledElementByIds)(t.viewportId,t.renderingEngineId);if(!e)continue;const n=this._getAnnotations(e);n&&n.length>0&&n.forEach(e=>{(0,r.removeAnnotation)(e.annotationUID)}),e.viewport.render()}else this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this._computeToolCenter(e),(0,s.triggerEvent)(s.eventTarget,l.Events.VOLUMECROPPINGCONTROL_TOOL_CHANGED,{toolGroupId:this.toolGroupId,viewportsInfo:e,seriesInstanceUID:this.seriesInstanceUID})}onSetToolEnabled(){console.debug(`VolumeCroppingControlTool: onSetToolEnabled called for tool ${this.getToolName()}`);this._getViewportsInfo()}onSetToolDisabled(){console.debug(`VolumeCroppingControlTool: onSetToolDisabled called for tool ${this.getToolName()}`);const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach(({renderingEngineId:e,viewportId:t})=>{const n=(0,s.getEnabledElementByIds)(t,e);if(!n)return;const i=this._getAnnotations(n);i?.length&&i.forEach(e=>{(0,r.removeAnnotation)(e.annotationUID)})})}_getOrientationFromNormal(e){if(!e)return null;const t={AXIAL:[0,0,1],CORONAL:[0,1,0],SAGITTAL:[1,0,0]},n=.01;for(const[i,a]of Object.entries(t)){if(Math.abs(e[0]-a[0])<n&&Math.abs(e[1]-a[1])<n&&Math.abs(e[2]-a[2])<n)return i;if(Math.abs(e[0]+a[0])<n&&Math.abs(e[1]+a[1])<n&&Math.abs(e[2]+a[2])<n)return i}return null}_syncWithVolumeCroppingTool(e){const t=e;if(t.length>=6){this.toolCenterMin=[t[0].origin[0],t[2].origin[1],t[4].origin[2]],this.toolCenterMax=[t[1].origin[0],t[3].origin[1],t[5].origin[2]],this.toolCenter=[(this.toolCenterMin[0]+this.toolCenterMax[0])/2,(this.toolCenterMin[1]+this.toolCenterMax[1])/2,(this.toolCenterMin[2]+this.toolCenterMax[2])/2];const e=this._getViewportsInfo();e.forEach(({viewportId:e,renderingEngineId:n})=>{const i=(0,s.getEnabledElementByIds)(e,n);if(i){this._getAnnotations(i).forEach(e=>{if(e.data&&e.data.handles&&e.data.orientation){const n=e.data.orientation;"AXIAL"===n?(e.data.handles.toolCenterMin=[t[0].origin[0],t[2].origin[1],e.data.handles.toolCenterMin[2]],e.data.handles.toolCenterMax=[t[1].origin[0],t[3].origin[1],e.data.handles.toolCenterMax[2]]):"CORONAL"===n?(e.data.handles.toolCenterMin=[t[0].origin[0],e.data.handles.toolCenterMin[1],t[4].origin[2]],e.data.handles.toolCenterMax=[t[1].origin[0],e.data.handles.toolCenterMax[1],t[5].origin[2]]):"SAGITTAL"===n&&(e.data.handles.toolCenterMin=[e.data.handles.toolCenterMin[0],t[2].origin[1],t[4].origin[2]],e.data.handles.toolCenterMax=[e.data.handles.toolCenterMax[0],t[3].origin[1],t[5].origin[2]]),e.data.handles.toolCenter=[(e.data.handles.toolCenterMin[0]+e.data.handles.toolCenterMax[0])/2,(e.data.handles.toolCenterMin[1]+e.data.handles.toolCenterMax[1])/2,(e.data.handles.toolCenterMin[2]+e.data.handles.toolCenterMax[2])/2]}})}}),this._virtualAnnotations&&this._virtualAnnotations.length>0&&this._virtualAnnotations.forEach(e=>{if(e.data&&e.data.handles&&e.data.orientation){const n=e.data.orientation.toUpperCase();"AXIAL"===n?(e.data.handles.toolCenterMin=[t[0].origin[0],t[2].origin[1],e.data.handles.toolCenterMin[2]],e.data.handles.toolCenterMax=[t[1].origin[0],t[3].origin[1],e.data.handles.toolCenterMax[2]]):"CORONAL"===n?(e.data.handles.toolCenterMin=[t[0].origin[0],e.data.handles.toolCenterMin[1],t[4].origin[2]],e.data.handles.toolCenterMax=[t[1].origin[0],e.data.handles.toolCenterMax[1],t[5].origin[2]]):"SAGITTAL"===n&&(e.data.handles.toolCenterMin=[e.data.handles.toolCenterMin[0],t[2].origin[1],t[4].origin[2]],e.data.handles.toolCenterMax=[e.data.handles.toolCenterMax[0],t[3].origin[1],t[5].origin[2]]),e.data.handles.toolCenter=[(e.data.handles.toolCenterMin[0]+e.data.handles.toolCenterMax[0])/2,(e.data.handles.toolCenterMin[1]+e.data.handles.toolCenterMax[1])/2,(e.data.handles.toolCenterMin[2]+e.data.handles.toolCenterMax[2])/2]}}),(0,L.A)(e.map(({viewportId:e})=>e))}}setToolCenter(e,t){"min"===t?this.toolCenterMin=[...e]:"max"===t&&(this.toolCenterMax=[...e]);const n=this._getViewportsInfo();(0,L.A)(n.map(({viewportId:e})=>e))}addNewAnnotation(e){const t=e.detail,{element:n}=t,i=(0,s.getEnabledElement)(n),{viewport:a}=i,o=this._getAnnotations(i),r=this.filterInteractableAnnotationsForElement(a.element,o);if(!r||0===r.length||!r[0])return null;const{data:l}=r[0],d=[],c=l.referenceLines||[];for(let e=0;e<c.length;++e){const t=c[e][0];this._getReferenceLineControllable(t.id)&&(d.push(t.id),e++)}return l.activeViewportIds=[...d],l.handles.activeOperation=ze,e.preventDefault(),(0,Ve.hideElementCursor)(n),this._activateModify(n),r[0]}handleSelectedCallback(e,t,n,i){this.toolSelectedCallback(e,t,i)}_unsubscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,s.getEnabledElementByIds)(e,t),{element:i}=n;i.removeEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_subscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,s.getEnabledElementByIds)(e,t),{element:i}=n;i.addEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach(t=>{this._applyDeltaShiftToViewportCamera(e,t,n)})}_applyDeltaShiftToViewportCamera(e,t,n){const{data:i}=t,a=e.getViewport(i.viewportId),o=a.getCamera(),s=o.viewPlaneNormal,r=Ce.Ay.dot(n,s),l=[...s];if(Ce.Ay.multiplyScalar(l,r),Math.abs(l[0])>.001||Math.abs(l[1])>.001||Math.abs(l[2])>.001){const e=[0,0,0],t=[0,0,0];Ce.Ay.add(o.focalPoint,l,e),Ce.Ay.add(o.position,l,t),a.setCamera({focalPoint:e,position:t}),a.render()}}_pointNearTool(e,t,n,i){const{data:a}=t,o=a.referenceLines,s=[];if(o)for(let e=0;e<o.length;++e){const t=o[e][0],r=o[e][1],l=o[e][2],d=o[e][3];re.distanceToPoint(r,l,[n[0],n[1]])<=i&&(s.push(t.id),a.handles.activeOperation=1,a.handles.activeType=d)}return a.activeViewportIds=[...s],this.editData={annotation:t},1===a.handles.activeOperation}}Xe.toolName="VolumeCroppingControl";class $e extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this._getImageDynamicRangeFromMiddleSlice=(e,t)=>{const n=Math.floor(t[2]/2),i=t[0]*t[1];let a,o;e instanceof Float32Array?(a=4,o=Float32Array):e instanceof Uint8Array?(a=1,o=Uint8Array):e instanceof Uint16Array?(a=2,o=Uint16Array):e instanceof Int16Array&&(a=2,o=Int16Array);const s=new o(e.buffer,n*i*a,i),{max:r,min:l}=this._getMinMax(s,i);return r-l}}touchDragCallback(e){this.mouseDragCallback(e)}mouseDragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,s.getEnabledElement)(t),{viewport:a}=i;let o,r,l,d,c,h,g=!1;const u=a.getProperties();if(a instanceof s.VolumeViewport){o=a.getVolumeId(),h=s.utilities.getViewportsWithVolumeId(o),({lower:r,upper:l}=u.voiRange);const e=s.cache.getVolume(o);if(!e)throw new Error("Volume not found "+o);d=e.metadata.Modality,g=e.scaling&&Object.keys(e.scaling).length>0}else{if(!u.voiRange)throw new Error("Viewport is not a valid type");{d=a.modality,({lower:r,upper:l}=u.voiRange);const{preScale:e={scaled:!1}}=a.getImageData?.()||{};g=e.scaled&&void 0!==e.scalingParameters?.suvbw}}c="PT"===d&&g?this.getPTScaledNewRange({deltaPointsCanvas:n.canvas,lower:r,upper:l,clientHeight:t.clientHeight,isPreScaled:g,viewport:a,volumeId:o}):this.getNewRange({viewport:a,deltaPointsCanvas:n.canvas,volumeId:o,lower:r,upper:l}),c.lower>=c.upper||(a.setProperties({voiRange:c}),a.render(),a instanceof s.VolumeViewport&&h.forEach(e=>{a!==e&&e.render()}))}getPTScaledNewRange({deltaPointsCanvas:e,lower:t,upper:n,clientHeight:i,viewport:a,volumeId:o,isPreScaled:s}){let r=4;r=s?5/i:this._getMultiplierFromDynamicRange(a,o)||4;return n-=e[1]*r,{lower:t,upper:n=s?Math.max(n,.1):n}}getNewRange({viewport:e,deltaPointsCanvas:t,volumeId:n,lower:i,upper:a}){const o=this._getMultiplierFromDynamicRange(e,n)||4,r=t[0]*o,l=t[1]*o;let{windowWidth:d,windowCenter:c}=s.utilities.windowLevel.toWindowLevel(i,a);d+=r,c+=l,d=Math.max(d,1);const h=e.getProperties().VOILUTFunction;return s.utilities.windowLevel.toLowHighRange(d,c,h)}_getMultiplierFromDynamicRange(e,t){let n;if(t){const i=s.cache.getVolume(t),{voxelManager:a}=e.getImageData(),o=a.getMiddleSliceData().reduce((e,t)=>[Math.min(e[0],t),Math.max(e[1],t)],[1/0,-1/0]),r=i?.metadata?.BitsStored,l=r?2**r:1/0,d=o[1]-o[0];n=Number.isFinite(d)?Math.min(d,l):l}else n=this._getImageDynamicRangeFromViewport(e);const i=n/1024;return Number.isFinite(i)?i>1?Math.round(i):i:1024}_getImageDynamicRangeFromViewport(e){const{imageData:t,voxelManager:n}=e.getImageData();if(n?.getRange){const e=n.getRange();return e[1]-e[0]}const i=t.getDimensions();if(t.getRange){const e=t.getRange();return e[1]-e[0]}let a,o;if(a=t.getScalarData?t.getScalarData():t.getPointData().getScalars().getData(),1!==i[2])return this._getImageDynamicRangeFromMiddleSlice(a,i);if(a.getRange)o=a.getRange();else{const{min:e,max:t}=this._getMinMax(a,a.length);o=[e,t]}return o[1]-o[0]}_getMinMax(e,t){let n=1/0,i=-1/0;for(let a=0;a<t;a++){const t=e[a];t<n&&(n=t),t>i&&(i=t)}return{max:i,min:n}}}$e.toolName="WindowLevel";class Ze extends Ee.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{minWindowWidth:10}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:r}=o;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,a,d,c),g=r.getFrameOfReferenceUID(),u={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...a],[...a],[...a],[...a]]},cachedStats:{}}};(0,E.lC)(u,i);const m=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m},this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(m),u},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a}=this.editData;this._deactivateDraw(n),(0,Ve.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,(0,E.O8)(i.annotationUID),(0,L.A)(a),(0,ae.triggerAnnotationCompleted)(i),this.applyWindowLevelRegion(i,n)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a}=this.editData,{data:o}=i,{currentPoints:r}=t,l=(0,s.getEnabledElement)(n),{worldToCanvas:d,canvasToWorld:c}=l.viewport,h=r.world,{points:g}=o.handles;g[3]=[...h];const u=d(g[0]),m=d(g[3]),p=[m[0],u[1]],v=[u[0],m[1]],f=c(p),w=c(v);g[1]=f,g[2]=w,i.invalidated=!0,(0,L.A)(a)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,E.Rh)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<o.length;e++){const a=o[e],{annotationUID:r,data:l}=a,{points:d}=l.handles,c=d.map(e=>i.worldToCanvas(e));s.annotationUID=r;const{color:h,lineWidth:g,lineDash:u}=this.getAnnotationStyle({annotation:a,styleSpecifier:s});if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const m=`${r}-rect`,p="0";(0,D.drawRect)(t,r,p,c[0],c[3],{color:h,lineDash:u,lineWidth:g},m),n=!0}return n},this.applyWindowLevelRegion=(e,t)=>{const n=(0,s.getEnabledElement)(t),{viewport:i}=n,a=Q(i),{data:o}=e,{points:r}=o.handles,l=r.map(e=>i.worldToCanvas(e)),d=l[0],c=l[3];let h=Math.min(d[0],c[0]),g=Math.min(d[1],c[1]),u=Math.abs(d[0]-c[0]),m=Math.abs(d[1]-c[1]);h=s.utilities.clip(h,0,a.width),g=s.utilities.clip(g,0,a.height),u=Math.floor(Math.min(u,Math.abs(a.width-h))),m=Math.floor(Math.min(m,Math.abs(a.height-g)));const p=function(e,t,n,i,a){const o=[];let s=0;const r=e.scalarData;let l,d,c;if(e.color)for(d=0;d<a;d++)for(c=0;c<i;c++){l=4*((d+n)*e.columns+(c+t));const i=r[l],a=r[l+1],h=r[l+2];o[s++]=.2126*i+.7152*a+.0722*h}else for(d=0;d<a;d++)for(c=0;c<i;c++)l=(d+n)*e.columns+(c+t),o[s++]=r[l];return o}(a,Math.round(h),Math.round(g),u,m),v=function(e,t,n){const i=e.length;let a=n,o=t,s=0;if(i<2)return{min:a,max:o,mean:(t+n)/2};for(let t=0;t<i;t++){const n=e[t];a=Math.min(a,n),o=Math.max(o,n),s+=n}return{min:a,max:o,mean:s/i}}(p,a.minPixelValue,a.maxPixelValue);void 0===this.configuration.minWindowWidth&&(this.configuration.minWindowWidth=10);const f=Math.max(Math.abs(v.max-v.min),this.configuration.minWindowWidth),w=v.mean,E=i.getProperties().VOILUTFunction,I=s.utilities.windowLevel.toLowHighRange(f,w,E);i.setProperties({voiRange:I}),i.render()},this.cancel=()=>null,this.isPointNearTool=()=>null,this.toolSelectedCallback=()=>null,this.handleSelectedCallback=()=>null,this._activateModify=()=>null,this._deactivateModify=()=>null}}Ze.toolName="WindowLevelRegion";class Ye extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t),this.deltaY=1}mouseWheelCallback(e){this._scroll(e)}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){this._scrollDrag(e)}_scrollDrag(e){const{deltaPoints:t,viewportId:n,renderingEngineId:i}=e.detail,{viewport:a}=(0,s.getEnabledElementByIds)(n,i),{debounceIfNotLoaded:o,invert:r,loop:l}=this.configuration,d=t.canvas[1];let c;a instanceof s.VolumeViewport&&(c=a.getVolumeId());const h=this._getPixelPerImage(a),g=d+this.deltaY;if(h)if(Math.abs(g)>=h){const e=Math.round(g/h);s.utilities.scroll(a,{delta:r?-e:e,volumeId:c,debounceLoading:o,loop:l}),this.deltaY=g%h}else this.deltaY=g}_scroll(e){const{wheel:t,element:n}=e.detail,{direction:i}=t,{invert:a}=this.configuration,{viewport:o}=(0,s.getEnabledElement)(n),r=i*(a?-1:1);s.utilities.scroll(o,{delta:r,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:o instanceof s.BaseVolumeViewport?o.getVolumeId():void 0,scrollSlabs:this.configuration.scrollSlabs})}_getPixelPerImage(e){const{element:t}=e,n=e.getNumberOfSlices();return Math.max(2,t.offsetHeight/Math.max(n,8))}}Ye.toolName="StackScroll";var je=n(25963);class qe extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.mouseWheelCallback=e=>{const{element:t,wheel:n}=e.detail,i=(0,s.getEnabledElement)(t),{viewport:a}=i,{invert:o}=this.configuration,r=10*n.direction*(o?-1:1);this.setAngle(a,r)},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,startPoints:i}=e.detail,a=n.world,o=i.world,r=(0,s.getEnabledElement)(t),{viewport:l}=r,d=l.getCamera(),c=[.5*t.clientWidth,.5*t.clientHeight],h=l.canvasToWorld(c);let g=(0,je.A)([o,h],[h,a]);const{viewPlaneNormal:u}=d,m=T.eR.sub(T.eR.create(),h,o),p=T.eR.sub(T.eR.create(),h,a),v=T.eR.cross(T.eR.create(),m,p);T.eR.dot(u,v)>0&&(g=-g),Number.isNaN(g)||this.setAngle(l,g)}setAngle(e,t){const{viewPlaneNormal:n,viewUp:i}=e.getCamera();if(e instanceof s.BaseVolumeViewport){const a=(t+360)%360*Math.PI/180,o=T.pB.identity(new Float32Array(16));T.pB.rotate(o,o,a,n);const s=T.eR.transformMat4(T.eR.create(),i,o);e.setCamera({viewUp:s})}else{const{rotation:n}=e.getViewPresentation();e.setViewPresentation({rotation:(n+t+360)%360})}e.render()}}qe.toolName="PlanarRotate";class Ke extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.001,maxZoomScale:3e3,pinchToZoom:!0,pan:!0,invert:!1}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,a=i.world,o=(0,s.getEnabledElement)(n).viewport.getCamera(),{focalPoint:r}=o;this.initialMousePosWorld=a;let l=T.eR.fromValues(r[0]-a[0],r[1]-a[1],r[2]-a[2]);return l=T.eR.normalize(T.eR.create(),l),this.dirVec=l,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=(e,t,n,i=!1)=>{const{element:a,deltaPoints:o}=e.detail,r=i?e.detail.deltaDistance.canvas:o.canvas[1],l=[a.clientWidth,a.clientHeight],{parallelScale:d,focalPoint:c,position:h}=n,g=r*(5/l[1])*(this.configuration.invert?-1:1),u=(1-g)*d;let m=c,p=h;if(!this.configuration.zoomToCenter){const e=T.eR.distance(c,this.initialMousePosWorld);p=T.eR.scaleAndAdd(T.eR.create(),h,this.dirVec,-e*g),m=T.eR.scaleAndAdd(T.eR.create(),c,this.dirVec,-e*g)}const v=t.getImageData();let f=[1,1,1],w=u,E=!1;if(v){f=v.spacing;const{dimensions:e}=v,n=e[0]*f[0],i=e[1]*f[1],a=l[0]/l[1],o=(0,s.getConfiguration)().rendering?.useLegacyCameraFOV?1.1:1,r=t.options?.displayArea,d=n*(r?.imageArea?.[0]??o),c=i*(r?.imageArea?.[1]??o);let h;h=d/c>a?d/a*.5:.5*c;const{minZoomScale:g,maxZoomScale:m}=this.configuration,p=h/m,I=h/g;u<p?(w=p,E=!0):u>I&&(w=I,E=!0)}t.setCamera({parallelScale:w,focalPoint:E?c:m,position:E?h:p})},this._dragPerspectiveProjection=(e,t,n,i=!1)=>{const{element:a,deltaPoints:o}=e.detail,s=i?e.detail.deltaDistance.canvas:o.canvas[1],r=[a.clientWidth,a.clientHeight],{position:l,focalPoint:d,viewPlaneNormal:c}=n,h=Ce.Ay.distance2BetweenPoints(l,d),g=Math.sqrt(h)/r[1],u=[-c[0],-c[1],-c[2]],m=this.configuration.invert?s/g:s*g;let p=m*u[0];l[0]+=p,d[0]+=p,p=m*u[1],l[1]+=p,d[1]+=p,p=m*u[2],l[2]+=p,d[2]+=p,t.setCamera({position:l,focalPoint:d})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}mouseWheelCallback(e){this._zoom(e)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){const{element:t,currentPoints:n}=e.detail,i=(0,s.getEnabledElement)(t),{viewport:a}=i,o=a.getCamera(),r=n.world,{focalPoint:l}=o;this.initialMousePosWorld=r;let d=T.eR.fromValues(l[0]-r[0],l[1]-r[1],l[2]-r[2]);d=T.eR.normalize(T.eR.create(),d),this.dirVec=d,o.parallelProjection?this._dragParallelProjection(e,a,o,!0):this._dragPerspectiveProjection(e,a,o,!0),a.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){const{element:t}=e.detail,n=(0,s.getEnabledElement)(t),{viewport:i}=n,a=i.getCamera();a.parallelProjection?this._dragParallelProjection(e,i,a):this._dragPerspectiveProjection(e,i,a),i.render()}_zoom(e){const{element:t,points:n}=e.detail,i=(0,s.getEnabledElement)(t),{viewport:a}=i,o=(a.getCamera(),e.detail.wheel.direction),r={detail:{element:t,eventName:l.Events.MOUSE_WHEEL,renderingEngineId:i.renderingEngineId,viewportId:a.id,camera:{},deltaPoints:{page:n.page,client:n.client,world:n.world,canvas:[0,5*-o]},startPoints:n,lastPoints:n,currentPoints:n}};a.type===s.Enums.ViewportType.STACK&&this.preMouseDownCallback(r),this._dragCallback(r)}_panCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,s.getEnabledElement)(t),a=n.world,o=i.viewport.getCamera(),{focalPoint:r,position:l}=o,d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],c=[r[0]-a[0],r[1]-a[1],r[2]-a[2]];i.viewport.setCamera({focalPoint:c,position:d}),i.viewport.render()}}Ke.toolName="Zoom";class Je extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}){super(e,t)}mouseClickCallback(e){const{element:t,currentPoints:n}=e.detail,i=(0,s.getEnabledElement)(t),{viewport:a,renderingEngine:o}=i,r=a.getVolumeId();if(!r)throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");let l=-1/0;const d=(0,V.getPointInLineOfSightWithCriteria)(a,n.world,r,(e,t)=>{if(e>l)return l=e,t});if(!d||!d.length)return;const{targetViewportIds:c,toolGroupId:h}=this.configuration;o.getViewports().filter(e=>{if(c?.indexOf(e.id)>=0)return!0;const t=(0,I.getToolGroupForViewport)(e.id,o.id);return!(!h||h!==t?.id)}).forEach(e=>{e instanceof s.VolumeViewport?e.jumpToWorld(d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")})}}Je.toolName="MIPJumpToClickTool";var Qe=n(89265);const{RENDERING_DEFAULTS:et}=s.CONSTANTS;function tt(){return"rgb(0, 200, 0)"}function nt(){return!0}function it(){return!0}function at(){return!0}const ot=1,st=2,rt=3;class lt extends Ee.EC{constructor(e={},t={supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!1,viewportIndicatorsConfig:{radius:5,x:null,y:null},autoPan:{enabled:!1,panSize:10},handleRadius:3,enableHDPIHandles:!1,referenceLinesCenterGapRadius:20,referenceLinesCenterGapRatio:null,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:s.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9,referenceLinesCenterGapRatio:.05}}}){super(e,t),this.toolCenter=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:t})=>{const n=(0,s.getEnabledElementByIds)(t,e);if(!n)return;const{FrameOfReferenceUID:i,viewport:a}=n,{element:o}=a,{position:l,focalPoint:d,viewPlaneNormal:c}=a.getCamera();let h=this._getAnnotations(n);h=this.filterInteractableAnnotationsForElement(o,h),h?.length&&(0,r.removeAnnotation)(h[0].annotationUID);const g={highlighted:!1,metadata:{cameraPosition:[...l],cameraFocalPoint:[...d],FrameOfReferenceUID:i,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:t}};return(0,r.addAnnotation)(g,o),{normal:c,point:a.canvasToWorld([a.canvas.clientWidth/2,a.canvas.clientHeight/2])}},this._getViewportsInfo=()=>(0,I.getToolGroup)(this.toolGroupId).viewportsInfo,this.resetCrosshairs=()=>{const e=this._getViewportsInfo();for(const t of e){const{viewportId:e,renderingEngineId:n}=t,i=(0,s.getEnabledElementByIds)(e,n),a=i.viewport,o=!0,l=!0,d=!0,c=!0,h=!0;a.resetCamera({resetPan:o,resetZoom:l,resetToCenter:d,resetRotation:c,suppressEvents:h}),a.resetSlabThickness();const{element:g}=a;let u=this._getAnnotations(i);u=this.filterInteractableAnnotationsForElement(g,u),u.length&&(0,r.removeAnnotation)(u[0].annotationUID),a.render()}this._computeToolCenter(e)},this.computeToolCenter=()=>{const e=this._getViewportsInfo();this._computeToolCenter(e)},this._computeToolCenter=e=>{if(!e.length||1===e.length)return void console.warn("For crosshairs to operate, at least two viewports must be given.");const[t,n,i]=e,{normal:a,point:o}=this.initializeViewport(t),{normal:r,point:l}=this.initializeViewport(n);let d=[0,0,0],c=T.eR.create();i?({normal:d,point:c}=this.initializeViewport(i)):(T.eR.add(c,o,l),T.eR.scale(c,c,.5),T.eR.cross(d,a,r));const h=s.utilities.planar.planeEquation(a,o),g=s.utilities.planar.planeEquation(r,l),u=s.utilities.planar.planeEquation(d,c),m=s.utilities.planar.threePlaneIntersection(h,g,u);this.setToolCenter(m)},this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.world,o=(0,s.getEnabledElement)(n),{viewport:r}=o;this._jump(o,a);const l=this._getAnnotations(o),d=this.filterInteractableAnnotationsForElement(r.element,l),{data:c}=d[0],{rotationPoints:h}=c.handles,g=[];for(let e=0;e<h.length-1;++e){const t=h[e][1],n=this._getReferenceLineControllable(t.id),i=this._getReferenceLineDraggableRotatable(t.id);n&&i&&(g.push(t.id),e++)}return c.activeViewportIds=[...g],c.handles.activeOperation=ot,e.preventDefault(),(0,Ve.hideElementCursor)(n),this._activateModify(n),d[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0,this._activateModify(i),(0,Ve.hideElementCursor)(i),e.preventDefault()},this.isPointNearTool=(e,t,n,i)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i;t.highlighted=!0,this._activateModify(a),(0,Ve.hideElementCursor)(a),e.preventDefault()},this.onCameraModified=e=>{const t=e.detail,{element:n}=t,i=(0,s.getEnabledElement)(n),{renderingEngine:a}=i,o=i.viewport,r=this._getAnnotations(i),d=this.filterInteractableAnnotationsForElement(n,r)[0];if(!d)return;const c=o.getCamera(),h=d.metadata.cameraPosition,g=[0,0,0];Ce.Ay.subtract(c.position,h,g);const u=d.metadata.cameraFocalPoint,m=[0,0,0];Ce.Ay.subtract(c.focalPoint,u,m),d.metadata.cameraPosition=[...c.position],d.metadata.cameraFocalPoint=[...c.focalPoint];const p=this._getReferenceLineControllable(o.id),v=this._getReferenceLineDraggableRotatable(o.id);if(!s.utilities.isEqual(c.position,h,.001)&&p&&v){let e=!1;s.utilities.isEqual(g,m,.001)||(e=!0);const t=Math.abs(Ce.Ay.dot(g,c.viewPlaneNormal))<.01;e||t||(this.toolCenter[0]+=g[0],this.toolCenter[1]+=g[1],this.toolCenter[2]+=g[2],(0,s.triggerEvent)(s.eventTarget,l.Events.CROSSHAIR_TOOL_CENTER_CHANGED,{toolGroupId:this.toolGroupId,toolCenter:this.toolCenter}))}if(this.configuration.autoPan?.enabled){(0,I.getToolGroupForViewport)(o.id,a.id).getViewportIds().filter(e=>e!==o.id).forEach(e=>{this._autoPanViewportIfNecessary(e,a)})}const f=(0,W.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,L.A)(f)},this.onResetCamera=e=>{this.resetCrosshairs()},this.mouseMoveCallback=(e,t)=>{const{element:n,currentPoints:i}=e.detail,a=i.canvas;let o=!1;for(let e=0;e<t.length;e++){const i=t[e];if((0,Be.isAnnotationLocked)(i.annotationUID))continue;const{data:s,highlighted:r}=i;if(!s.handles)continue;const l=s.handles.activeOperation,d=s.activeViewportIds&&s.activeViewportIds.length>0?[...s.activeViewportIds]:[];s.activeViewportIds=[],s.handles.activeOperation=null;let c=!1;c=!!this.getHandleNearImagePoint(n,i,a,6)||this._pointNearTool(n,i,a,6);c&&!r||!c&&r?(i.highlighted=!r,o=!0):s.handles.activeOperation===l&&this._areViewportIdArraysEqual(s.activeViewportIds,d)||(o=!0)}return o},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];const n=(0,s.getEnabledElement)(e),{viewportId:i}=n,a=t.filter(e=>e.data.viewportId===i);return a},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,renderingEngine:a}=e,{element:o}=i,s=this._getAnnotations(e),r=i.getCamera(),l=this.filterInteractableAnnotationsForElement(o,s)[0];if(!s?.length||!l?.data)return n;const d=l.annotationUID,{clientWidth:c,clientHeight:h}=i.canvas,g=Math.sqrt(c*c+h*h),u=Math.min(c,h),m=l.data,p=i.worldToCanvas(this.toolCenter),v=this._filterAnnotationsByUniqueViewportOrientations(e,s),f=[],w=[0,0,c,h];v.forEach(e=>{const{data:t}=e;t.handles.toolCenter=this.toolCenter;const n=a.getViewport(t.viewportId),o=n.getCamera(),s=this._getReferenceLineControllable(n.id),l=this._getReferenceLineDraggableRotatable(n.id),d=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:c,clientHeight:h}=n.canvas,m=Math.sqrt(c*c+h*h),E=[.5*c,.5*h],I=n.canvasToWorld(E),C=[0,0,0];Ce.Ay.cross(r.viewPlaneNormal,o.viewPlaneNormal,C),Ce.Ay.normalize(C),Ce.Ay.multiplyScalar(C,m);const b=[0,0,0];Ce.Ay.add(I,C,b);const _=[0,0,0];Ce.Ay.subtract(I,C,_);const A=i.worldToCanvas(b),S=i.worldToCanvas(I),M=T.Zc.create();T.Zc.subtract(M,A,S),T.Zc.normalize(M,M);const D=T.Zc.create();T.Zc.scale(D,M,100*g);const y=T.Zc.create();T.Zc.scale(y,M,.4*u);const P=T.Zc.create();T.Zc.scale(P,M,.2*u);const x=T.Zc.create(),R=this.configuration.mobile,{referenceLinesCenterGapRatio:L}=R?.enabled?R:this.configuration,O=L>0?u*L:this.configuration.referenceLinesCenterGapRadius;T.Zc.scale(x,M,2===v.length?O:0);const U=T.Zc.create(),k=T.Zc.create(),N=T.Zc.create(),V=T.Zc.create();let W=T.Zc.clone(p);l&&s||(W=T.Zc.clone(S)),T.Zc.add(U,W,x),T.Zc.add(k,W,D),T.Zc.subtract(N,W,x),T.Zc.subtract(V,W,D),(0,We.A)(U,k,w),(0,We.A)(N,V,w);const B=T.Zc.create();T.Zc.subtract(B,p,y);const H=T.Zc.create();T.Zc.add(H,p,y);let G=T.Zc.clone(p);!l&&d&&(G=T.Zc.clone(S));let F=[...this.toolCenter];!l&&d&&(F=[...I]);const z=[0,0,0];Ce.Ay.subtract(b,_,z),Ce.Ay.normalize(z);const{viewPlaneNormal:X}=r,{matrix:$}=Qe.A.buildFromDegree().rotate(90,X),Z=[0,0,0];T.eR.transformMat4(Z,z,$);const Y=n.getSlabThickness(),j=[...Z];Ce.Ay.multiplyScalar(j,Y);const q=[0,0,0];Ce.Ay.add(F,j,q);const K=i.worldToCanvas(q),J=T.Zc.create();T.Zc.subtract(J,G,K);const Q=T.Zc.create();T.Zc.subtract(Q,G,D),T.Zc.add(Q,Q,J);const ee=T.Zc.create();T.Zc.add(ee,G,D),T.Zc.add(ee,ee,J),(0,We.A)(Q,ee,w);const te=T.Zc.create();T.Zc.add(te,G,D),T.Zc.subtract(te,te,J);const ne=T.Zc.create();T.Zc.subtract(ne,G,D),T.Zc.subtract(ne,ne,J),(0,We.A)(te,ne,w);const ie=T.Zc.create(),ae=T.Zc.create(),oe=T.Zc.create(),se=T.Zc.create();T.Zc.subtract(ie,G,P),T.Zc.add(ie,ie,J),T.Zc.add(ae,G,P),T.Zc.add(ae,ae,J),T.Zc.subtract(oe,G,P),T.Zc.subtract(oe,oe,J),T.Zc.add(se,G,P),T.Zc.subtract(se,se,J),f.push([n,U,k,N,V,Q,ee,te,ne,B,H,ie,ae,oe,se])});const E=[],I=[],C=this._getReferenceLineColor(i.id),b=void 0!==C?C:"rgb(200, 200, 200)";if(f.forEach((e,n)=>{const a=e[0],o=this._getReferenceLineColor(a.id),s=this._getReferenceLineControllable(a.id),r=this._getReferenceLineDraggableRotatable(a.id)||this.configuration.mobile?.enabled,l=this._getReferenceLineSlabThicknessControlsOn(a.id)||this.configuration.mobile?.enabled,c=m.activeViewportIds.find(e=>e===a.id);let h=void 0!==o?o:"rgb(200, 200, 200)",g=1;const u=null!==m.handles.activeOperation&&m.handles.activeOperation===ot&&c;u&&(g=2.5);let p=`${n}`;if(s&&r?(p=`${n}One`,(0,D.drawLine)(t,d,p,e[1],e[2],{color:h,lineWidth:g}),p=`${n}Two`,(0,D.drawLine)(t,d,p,e[3],e[4],{color:h,lineWidth:g})):(0,D.drawLine)(t,d,p,e[2],e[4],{color:h,lineWidth:g}),s){h=void 0!==o?o:"rgb(200, 200, 200)";const s=m.handles.activeOperation===st,g=[e[9],e[10]],v=[i.canvasToWorld(e[9]),a,e[1],e[2]],f=[i.canvasToWorld(e[10]),a,e[3],e[4]];E.push(v,f);const w=m.handles.activeOperation===rt,C=[e[11],e[12],e[13],e[14]],b=[i.canvasToWorld(e[11]),a,e[5],e[6]],_=[i.canvasToWorld(e[12]),a,e[5],e[6]],T=[i.canvasToWorld(e[13]),a,e[7],e[8]],A=[i.canvasToWorld(e[14]),a,e[7],e[8]];I.push(b,_,T,A);let S=this.configuration.handleRadius*(this.configuration.enableHDPIHandles?window.devicePixelRatio:1),M=1;if(this.configuration.mobile?.enabled&&(S=this.configuration.mobile.handleRadius,M=this.configuration.mobile.opacity),(u||this.configuration.mobile?.enabled)&&!s&&!w&&r&&l){let e=`${n}One`;(0,D.drawHandles)(t,d,e,g,{color:h,handleRadius:S,opacity:M,type:"circle"}),e=`${n}Two`,(0,D.drawHandles)(t,d,e,C,{color:h,handleRadius:S,opacity:M,type:"rect"})}else if(u&&!s&&!w&&r){const e=`${n}`;(0,D.drawHandles)(t,d,e,g,{color:h,handleRadius:S,opacity:M,type:"circle"})}else if(c&&!s&&!w&&l){const e=`${n}`;(0,D.drawHandles)(t,d,e,C,{color:h,handleRadius:S,opacity:M,type:"rect"})}else if(s&&r){const e=`${n}`,i=this.configuration.handleRadius*(this.configuration.enableHDPIHandles?window.devicePixelRatio:1);(0,D.drawHandles)(t,d,e,g,{color:h,handleRadius:i,fill:h,type:"circle"})}else if(w&&c&&l){const e=this.configuration.handleRadius*(this.configuration.enableHDPIHandles?window.devicePixelRatio:1);(0,D.drawHandles)(t,d,p,C,{color:h,handleRadius:e,fill:h,type:"rect"})}a.getSlabThickness()>.5&&l&&(p=`${n}STOne`,(0,D.drawLine)(t,d,p,e[5],e[6],{color:h,width:1,lineDash:[2,3]}),p=`${n}STTwo`,(0,D.drawLine)(t,d,p,e[7],e[8],{color:h,width:e,lineDash:[2,3]}))}}),n=!0,m.handles.rotationPoints=E,m.handles.slabThicknessPoints=I,this.configuration.viewportIndicators){const{viewportIndicatorsConfig:e}=this.configuration,n=[c*(e?.xOffset||.95),h*(e?.yOffset||.05)],i=e?.circleRadius||.01*g,a="0";(0,D.drawCircle)(t,d,a,n,i,{color:b,fill:b})}return n},this._getAnnotations=e=>{const{viewport:t}=e,n=(0,r.getAnnotations)(this.getToolName(),t.element)||[],i=this._getViewportsInfo().map(({viewportId:e})=>e),a=n.filter(e=>{const{data:t}=e;return i.includes(t.viewportId)});return a},this._onNewVolume=()=>{const e=this._getViewportsInfo();this._computeToolCenter(e)},this._areViewportIdArraysEqual=(e,t)=>e.length===t.length&&(e.forEach(e=>{let n=!1;for(let i=0;i<t.length;++i)if(e===t[i]){n=!0;break}if(!1===n)return!1}),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{const{viewportId:n,renderingEngine:i,viewport:a}=e,o=t.filter(e=>e.data.viewportId!==n);if(!o||!o.length)return[];const r=a.getCamera(),{viewPlaneNormal:l,position:d}=r,c=o.filter(e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera();return!(s.utilities.isEqual(n.viewPlaneNormal,l,.01)&&s.utilities.isEqual(n.position,d,1))});return c},this._filterViewportWithSameOrientation=(e,t,n)=>{const{renderingEngine:i}=e,{data:a}=t,o=i.getViewport(a.viewportId),r=n.filter(e=>{const{data:t}=e,n=i.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)});if(!r||!r.length)return[];const l=o.getCamera(),d=l.viewPlaneNormal;Ce.Ay.normalize(d);const c=r.filter(e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera(),a=n.viewPlaneNormal;return Ce.Ay.normalize(a),s.utilities.isEqual(d,a,.01)&&s.utilities.isEqual(l.viewUp,n.viewUp,.01)});return c},this._filterAnnotationsByUniqueViewportOrientations=(e,t)=>{const{renderingEngine:n,viewport:i}=e,a=i.getCamera().viewPlaneNormal;Ce.Ay.normalize(a);const o=t.filter(e=>{const{data:t}=e,a=n.getViewport(t.viewportId),o=this._getReferenceLineControllable(a.id);return i!==a&&!0===o}),r=[];for(let e=0;e<o.length;++e){const t=o[e],{viewportId:i}=t.data,l=n.getViewport(i).getCamera(),d=l.viewPlaneNormal;if(Ce.Ay.normalize(d),s.utilities.isEqual(a,d,.01)||s.utilities.isOpposite(a,d,.01))continue;let c=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:i}=t.data,a=n.getViewport(i).getCamera();s.utilities.isEqual(a.viewPlaneNormal,l.viewPlaneNormal,.01)&&s.utilities.isEqual(a.position,l.position,1)&&(c=!0)}c||r.push(t)}const l=t.filter(e=>{const{data:t}=e,a=n.getViewport(t.viewportId),o=this._getReferenceLineControllable(a.id);return i!==a&&!0!==o});for(let e=0;e<l.length;++e){const t=l[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera(),d=o.viewPlaneNormal;if(Ce.Ay.normalize(d),s.utilities.isEqual(a,d,.01)||s.utilities.isOpposite(a,d,.01))continue;let c=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:i}=t.data,a=n.getViewport(i).getCamera();s.utilities.isEqual(a.viewPlaneNormal,o.viewPlaneNormal,.01)&&s.utilities.isEqual(a.position,o.position,1)&&(c=!0)}c||r.push(t)}const d=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<d.length;++e){const t=d[e];if(r.some(e=>e===t))continue;const{viewportId:i}=t.data,o=n.getViewport(i).getCamera(),l=o.viewPlaneNormal;if(Ce.Ay.normalize(l),s.utilities.isEqual(a,l,.01)||s.utilities.isOpposite(a,l,.01))continue;let c=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:i}=t.data,a=n.getViewport(i).getCamera();s.utilities.isEqual(a.viewPlaneNormal,o.viewPlaneNormal,.01)&&s.utilities.isEqual(a.position,o.position,1)&&(c=!0)}c||r.push(t)}return r},this._checkIfViewportsRenderingSameScene=(e,t)=>{const n=e.getAllVolumeIds(),i=t.getAllVolumeIds();return n.length===i.length&&n.every(e=>i.includes(e))},this._jump=(e,t)=>{w.wk.isInteractingWithTool=!0;const{viewport:n,renderingEngine:i}=e,a=this._getAnnotations(e),o=[0,0,0];Ce.Ay.subtract(t,this.toolCenter,o);const s=this._getAnnotationsForViewportsWithDifferentCameras(e,a).filter(e=>{const{data:t}=e,a=i.getViewport(t.viewportId),o=this._checkIfViewportsRenderingSameScene(n,a);return this._getReferenceLineControllable(a.id)&&this._getReferenceLineDraggableRotatable(a.id)&&o});return 0===s.length?(w.wk.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(i,s,o),w.wk.isInteractingWithTool=!1,!0)},this._activateModify=e=>{w.wk.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),(0,Ve.resetElementCursor)(n),this.editData=null;const i=(0,W.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,L.A)(i)},this._dragCallback=e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:i}=t,a=(0,s.getEnabledElement)(i),{renderingEngine:o,viewport:r}=a,l=this._getAnnotations(a),d=this.filterInteractableAnnotationsForElement(i,l)[0];if(!d)return;const{handles:c}=d.data,{currentPoints:h}=e.detail,g=h.canvas;if(c.activeOperation===ot){const e=this._getAnnotationsForViewportsWithDifferentCameras(a,l).filter(e=>{const{data:t}=e,n=o.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),a=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===a&&d.data.activeViewportIds.find(e=>e===n.id)});this._applyDeltaShiftToSelectedViewportCameras(o,e,n)}else if(c.activeOperation===st){const e=this._getAnnotationsForViewportsWithDifferentCameras(a,l).filter(e=>{const{data:t}=e,n=o.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),a=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===a}),n=T.Zc.create(),i=T.Zc.create(),s=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],d=r.worldToCanvas(s),c=t.currentPoints.canvas,h=T.Zc.create();T.Zc.sub(h,c,t.deltaPoints.canvas),T.Zc.sub(n,h,d),T.Zc.sub(i,c,d);let g=T.Zc.angle(n,i);this._isClockWise(d,h,c)&&(g*=-1),g=Math.round(100*g)/100;const u=r.getCamera().viewPlaneNormal,{matrix:m}=Qe.A.buildFromRadian().translate(s[0],s[1],s[2]).rotate(g,u).translate(-s[0],-s[1],-s[2]),p=[];e.forEach(e=>{const{data:t}=e;t.handles.toolCenter=s;const n=o.getViewport(t.viewportId),i=n.getCamera(),{viewUp:a,position:r,focalPoint:l}=i;a[0]+=r[0],a[1]+=r[1],a[2]+=r[2],T.eR.transformMat4(l,l,m),T.eR.transformMat4(r,r,m),T.eR.transformMat4(a,a,m),a[0]-=r[0],a[1]-=r[1],a[2]-=r[2],n.setCamera({position:r,viewUp:a,focalPoint:l}),p.push(n.id)}),o.renderViewports(p)}else if(c.activeOperation===rt){const e=this._getAnnotationsForViewportsWithDifferentCameras(a,l).filter(e=>{const{data:t}=e,n=o.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),a=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===i&&!0===a&&d.data.activeViewportIds.find(e=>e===n.id)});if(0===e.length)return;const i=this._filterViewportWithSameOrientation(a,e[0],l),c=[];c.push(r.id),i.forEach(e=>{const{data:i}=e,a=o.getViewport(i.viewportId),l=a.getCamera().viewPlaneNormal,h=Ce.Ay.dot(n,l),u=[...l];if(Ce.Ay.multiplyScalar(u,h),Math.abs(u[0])>.001||Math.abs(u[1])>.001||Math.abs(u[2])>.001){const e=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),n=t.lastPoints.world,i=[0,0,0],h=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(a.id)){const{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter(e=>e[1].uid===a.id);if(2===t.length){const e=r.canvasToWorld(t[0][3]),n=r.canvasToWorld(t[1][3]);Ce.Ay.add(e,n,h),Ce.Ay.multiplyScalar(h,.5)}}Ce.Ay.subtract(n,h,i);const m=Ce.Ay.dot(i,l),p=[...l];Ce.Ay.multiplyScalar(p,m);const v=[p[0],p[1],p[2]];T.eR.normalize(v,v);const f=[u[0],u[1],u[2]];T.eR.normalize(f,f);let w=a.getSlabThickness();s.utilities.isOpposite(v,f,.001)?w-=e:w+=e,w=Math.abs(w),w=Math.max(et.MINIMUM_SLAB_THICKNESS,w);this._pointNearReferenceLine(d,g,6,a)&&(w=et.MINIMUM_SLAB_THICKNESS);(0,I.getToolGroupForViewport)(a.id,o.id).getToolInstance(this.getToolName()).setSlabThickness(a,w),c.push(a.id)}}),o.renderViewports(c)}},this._pointNearReferenceLine=(e,t,n,i)=>{const{data:a}=e,{rotationPoints:o}=a.handles;for(let e=0;e<o.length-1;++e){const a=o[e][1];if(a.id!==i.id)continue;if(!this._getReferenceLineControllable(a.id))continue;const s={start:{x:o[e][2][0],y:o[e][2][1]},end:{x:o[e][3][0],y:o[e][3][1]}},r=re.distanceToPoint([s.start.x,s.start.y],[s.end.x,s.end.y],[t[0],t[1]]),l={start:{x:o[e+1][2][0],y:o[e+1][2][1]},end:{x:o[e+1][3][0],y:o[e+1][3][1]}},d=re.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]);if(r<=n||d<=n)return!0;e++}return!1},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||tt,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||nt,this._getReferenceLineDraggableRotatable=e.configuration?.getReferenceLineDraggableRotatable||it,this._getReferenceLineSlabThicknessControlsOn=e.configuration?.getReferenceLineSlabThicknessControlsOn||at}onSetToolActive(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this._computeToolCenter(e)}onSetToolPassive(){const e=this._getViewportsInfo();this._computeToolCenter(e)}onSetToolEnabled(){const e=this._getViewportsInfo();this._computeToolCenter(e)}onSetToolDisabled(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach(({renderingEngineId:e,viewportId:t})=>{const n=(0,s.getEnabledElementByIds)(t,e);if(!n)return;const i=this._getAnnotations(n);i?.length&&i.forEach(e=>{(0,r.removeAnnotation)(e.annotationUID)})})}setToolCenter(e,t=!1){this._getViewportsInfo().map(({renderingEngineId:t,viewportId:n})=>{const i=(0,s.getRenderingEngine)(t).getViewport(n),a=i.getCamera(),{focalPoint:o,position:r,viewPlaneNormal:l}=a,d=[e[0]-o[0],e[1]-o[1],e[2]-o[2]],c=d[0]*l[0]+d[1]*l[1]+d[2]*l[2],h=[c*l[0],c*l[1],c*l[2]],g=[o[0]+h[0],o[1]+h[1],o[2]+h[2]],u=[r[0]+h[0],r[1]+h[1],r[2]+h[2]];i.setCamera({focalPoint:g,position:u}),i.render()}),this.toolCenter=e,t||(0,s.triggerEvent)(s.eventTarget,l.Events.CROSSHAIR_TOOL_CENTER_CHANGED,{toolGroupId:this.toolGroupId,toolCenter:this.toolCenter})}getHandleNearImagePoint(e,t,n,i){const a=(0,s.getEnabledElement)(e),{viewport:o}=a;let r=this._getRotationHandleNearImagePoint(o,t,n,i);return null!==r?r:(r=this._getSlabThicknessHandleNearImagePoint(o,t,n,i),null!==r?r:void 0)}_unsubscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,s.getEnabledElementByIds)(e,t),{element:i}=n;i.removeEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_subscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,s.getEnabledElementByIds)(e,t),{element:i}=n;i.addEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_autoPanViewportIfNecessary(e,t){const n=t.getViewport(e),{clientWidth:i,clientHeight:a}=n.canvas,o=n.worldToCanvas(this.toolCenter),s=this.configuration.autoPan.panSize,r=[o[0],o[1]];if(o[0]<0?r[0]=s:o[0]>i&&(r[0]=i-s),o[1]<0?r[1]=s:o[1]>a&&(r[1]=a-s),r[0]===o[0]&&r[1]===o[1])return;const l=n.canvasToWorld(r),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],c=n.getCamera(),{focalPoint:h,position:g}=c,u=[g[0]-d[0],g[1]-d[1],g[2]-d[2]],m=[h[0]-d[0],h[1]-d[1],h[2]-d[2]];n.setCamera({focalPoint:m,position:u}),n.render()}setSlabThickness(e,t){let n;const{filterActorUIDsToSetSlabThickness:i}=this.configuration;i&&i.length>0&&(n=i);let a=this.configuration.slabThicknessBlendMode;t===et.MINIMUM_SLAB_THICKNESS&&(a=s.Enums.BlendModes.COMPOSITE);e.setBlendMode(a,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach(t=>{this._applyDeltaShiftToViewportCamera(e,t,n)})}_applyDeltaShiftToViewportCamera(e,t,n){const{data:i}=t,a=e.getViewport(i.viewportId),o=a.getCamera(),s=o.viewPlaneNormal,r=Ce.Ay.dot(n,s),l=[...s];if(Ce.Ay.multiplyScalar(l,r),Math.abs(l[0])>.001||Math.abs(l[1])>.001||Math.abs(l[2])>.001){const e=[0,0,0],t=[0,0,0];Ce.Ay.add(o.focalPoint,l,e),Ce.Ay.add(o.position,l,t),a.setCamera({focalPoint:e,position:t}),a.render()}}_getRotationHandleNearImagePoint(e,t,n,i){const{data:a}=t,{rotationPoints:o}=a.handles;for(let s=0;s<o.length;s++){const r=o[s][0],l=o[s][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineDraggableRotatable(l.id))continue;const d=e.worldToCanvas(r);if(T.Zc.distance(n,d)<i)return a.handles.activeOperation=st,this.editData={annotation:t},r}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,i){const{data:a}=t,{slabThicknessPoints:o}=a.handles;for(let s=0;s<o.length;s++){const r=o[s][0],l=o[s][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineSlabThicknessControlsOn(l.id))continue;const d=e.worldToCanvas(r);if(T.Zc.distance(n,d)<i)return a.handles.activeOperation=rt,a.activeViewportIds=[l.id],this.editData={annotation:t},r}return null}_pointNearTool(e,t,n,i){const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{clientWidth:r,clientHeight:l}=o.canvas,d=Math.sqrt(r*r+l*l),{data:c}=t,{rotationPoints:h}=c.handles,{slabThicknessPoints:g}=c.handles,u=[];for(let e=0;e<h.length-1;++e){const t=h[e][1],a=this._getReferenceLineControllable(t.id),o=this._getReferenceLineDraggableRotatable(t.id);if(!a||!o)continue;const s={start:{x:h[e][2][0],y:h[e][2][1]},end:{x:h[e][3][0],y:h[e][3][1]}},r=re.distanceToPoint([s.start.x,s.start.y],[s.end.x,s.end.y],[n[0],n[1]]),l={start:{x:h[e+1][2][0],y:h[e+1][2][1]},end:{x:h[e+1][3][0],y:h[e+1][3][1]}},d=re.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[n[0],n[1]]);(r<=i||d<=i)&&(u.push(t.id),c.handles.activeOperation=ot),e++}for(let e=0;e<g.length-1;++e){const t=g[e][1];if(u.find(e=>e===t.id))continue;const a=this._getReferenceLineControllable(t.id),o=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!a||!o)continue;const s=g[e][2],r=g[e][3],l=T.Zc.create();T.Zc.add(l,s,r),T.Zc.scale(l,l,.5);const h=T.Zc.create();T.Zc.subtract(h,s,l),T.Zc.normalize(h,h);const m=T.Zc.create();T.Zc.scale(m,h,.05*d);const p=T.Zc.create(),v=T.Zc.create();T.Zc.add(p,l,m),T.Zc.subtract(v,l,m);const f={start:{x:p[0],y:p[1]},end:{x:s[0],y:s[1]}},w=re.distanceToPoint([f.start.x,f.start.y],[f.end.x,f.end.y],[n[0],n[1]]),E={start:{x:v[0],y:v[1]},end:{x:r[0],y:r[1]}},I=re.distanceToPoint([E.start.x,E.start.y],[E.end.x,E.end.y],[n[0],n[1]]);(w<=i||I<=i)&&(u.push(t.id),c.handles.activeOperation=null),e++}return c.activeViewportIds=[...u],this.editData={annotation:t},c.handles.activeOperation===ot}}lt.toolName="Crosshairs";const dt="magnify-viewport";class ct extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}){super(e,t),this._hasBeenRemoved=!1,this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,a=(0,s.getEnabledElement)(n),{viewport:o,renderingEngine:r}=a;if(!(o instanceof s.StackViewport))throw new Error("MagnifyTool only works on StackViewports");const l=this._getReferencedImageId(o);if(!l)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const d=(0,W.getViewportIdsWithToolToRender)(n,this.getToolName());return this.editData={referencedImageId:l,viewportIdsToRender:d,enabledElement:a,renderingEngine:r,currentPoints:i},this._createMagnificationViewport(),this._activateDraw(n),(0,Ve.hideElementCursor)(n),e.preventDefault(),(0,L.A)(d),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{const{enabledElement:e,referencedImageId:t,viewportIdsToRender:n,renderingEngine:i,currentPoints:a}=this.editData,{viewport:o}=e,{element:r}=o,l=o.getProperties(),{rotation:d}=o.getViewPresentation(),{canvas:c,world:h}=a;let g;if(g=r.querySelector(".magnifyTool"),null===g){const e=document.createElement("div");e.classList.add("magnifyTool"),e.style.display="block",e.style.width=`${this.configuration.magnifyWidth}px`,e.style.height=`${this.configuration.magnifyHeight}px`,e.style.position="absolute",g=e;r.querySelector(".viewport-element").appendChild(e);const t={viewportId:dt,type:s.Enums.ViewportType.STACK,element:g};i.enableElement(t)}g.style.top=c[1]-this.configuration.magnifyHeight/2+"px",g.style.left=c[0]-this.configuration.magnifyWidth/2+"px";const u=i.getViewport(dt);u.setStack([t]).then(()=>{if(this._hasBeenRemoved)return;u.setProperties(l),u.setViewPresentation({rotation:d});const{parallelScale:e}=o.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:i}=u.getCamera(),a=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),s=[h[0],h[1],h[2]],r=[s[0]+a*i[0],s[1]+a*i[1],s[2]+a*i[2]];u.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:s,position:r}),u.render()}),g.style.display="block",(0,L.A)(n)},this._cancelCallback=e=>{e.preventDefault(),e.stopPropagation(),this._dragEndCallback(e)},this._dragCallback=e=>{const t=e.detail,{deltaPoints:n,element:i,currentPoints:a}=t,o=n.world,r=a.canvas,l=(0,s.getEnabledElement)(i),{renderingEngine:d}=l,c=d.getViewport(dt),h=i.querySelector(".magnifyTool");if(!h)return;h.style.top=r[1]-this.configuration.magnifyHeight/2+"px",h.style.left=r[0]-this.configuration.magnifyWidth/2+"px";const{focalPoint:g,position:u}=c.getCamera(),m=[u[0]+o[0],u[1]+o[1],u[2]+o[2]],p=[g[0]+o[0],g[1]+o[1],g[2]+o[2]];c.setCamera({focalPoint:p,position:m}),c.render()},this._dragEndCallback=e=>{let{element:t}=e.detail;if(void 0===t){const{enabledElement:e}=this.editData,{viewport:n}=e;t=n.element}const n=(0,s.getEnabledElement)(t),{renderingEngine:i}=n;i.disableElement(dt);const a=t.querySelector(".viewport-element"),o=a.querySelector(".magnifyTool");a.removeChild(o),this._deactivateDraw(t),(0,Ve.resetElementCursor)(t),this._hasBeenRemoved=!0},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,this._hasBeenRemoved=!1,e.addEventListener(l.Events.MOUSE_UP,this._dragEndCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._dragEndCallback),e.addEventListener("contextmenu",this._cancelCallback),e.addEventListener(l.Events.TOUCH_END,this._dragEndCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._dragEndCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener("contextmenu",this._cancelCallback),e.removeEventListener(l.Events.TOUCH_END,this._dragEndCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(e){const t=this.getTargetId(e);let n;return e instanceof s.StackViewport&&(n=t.split("imageId:")[1]),n}}ct.toolName="Magnify";var ht=n(29601),gt=n(77081),ut=n(82216);const{Events:mt}=s.Enums,pt=e=>e.uid!==e.referencedId;var vt;!function(e){e.ShowZoomFactorsList="showZoomFactorsList"}(vt||(vt={}));const ft=1-s.CONSTANTS.EPSILON;class wt extends Ee.EC{static{this.Actions=vt}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:3,zoomFactorList:[1.5,2,2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:{showZoomFactorsList:{method:"showZoomFactorsList",bindings:[{mouseButton:l.MouseBindings.Secondary,modifierKey:l.KeyboardBindings.Shift}]}}}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=(0,s.getEnabledElement)(i),{viewport:o,renderingEngine:l}=a,d=n.world,c=n.canvas,{magnifyingGlass:h}=this.configuration,{radius:g,zoomFactor:u,autoPan:m}=h,p=this._getCanvasHandlePoints(c,g),v=o.getCamera(),{viewPlaneNormal:f,viewUp:w}=v,E=this.getReferencedImageId(o,d,f,w),I=s.utilities.uuidv4(),C=s.utilities.uuidv4(),b=o.getFrameOfReferenceUID(),_={annotationUID:I,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...f],viewUp:[...w],FrameOfReferenceUID:b,referencedImageId:E},data:{sourceViewportId:o.id,magnifyViewportId:C,zoomFactor:u,isCanvasAnnotation:!0,handles:{points:p,activeHandleIndex:null}}};this.magnifyViewportManager.createViewport(_,{magnifyViewportId:C,sourceEnabledElement:a,position:c,radius:g,zoomFactor:u,autoPan:{enabled:m.enabled,padding:m.padding,callback:e=>{const t=_.data.handles.points,{canvas:n}=e.delta;for(let e=0,i=t.length;e<i;e++){const i=t[e];i[0]+=n[0],i[1]+=n[1],_.invalidated=!0}}}}),(0,r.addAnnotation)(_,i);const T=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return e.preventDefault(),(0,L.A)(T),_},this.onSetToolDisabled=()=>{this.magnifyViewportManager.dispose();(0,r.getAllAnnotations)().forEach(e=>{e.metadata.toolName===this.getToolName()&&(0,r.removeAnnotation)(e.annotationUID)})},this.isPointNearTool=(e,t,n,i)=>{const{data:a}=t,{points:o}=a.handles,s=o,r=s[0],l=s[2],d=s[3],c=.5*Math.abs(l[1]-r[1]),h=[d[0]+c,r[1]+c],g=(0,gt.getCanvasCircleRadius)([h,n]);return Math.abs(g-c)<2*i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},(0,Ve.hideElementCursor)(i),this._activateModify(i),(0,L.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;const{points:s}=o.handles,r=s.findIndex(e=>e===n),l=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r},this._activateModify(a),(0,Ve.hideElementCursor)(a),(0,L.A)(l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o}=this.editData,{data:s}=i;s.handles.activeHandleIndex=null,this._deactivateModify(n),(0,Ve.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{deltaPoints:n}=t,i=n?.canvas??[0,0,0],{annotation:a,viewportIdsToRender:o}=this.editData,{points:s}=a.data.handles;s.forEach(e=>{e[0]+=i[0],e[1]+=i[1]}),a.invalidated=!0,this.editData.hasMoved=!0,(0,L.A)(o)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o}=this.editData,{data:s}=i;if(void 0===o){const{deltaPoints:e}=t,n=e.canvas;s.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1]}),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;(0,L.A)(a)},this._dragHandle=e=>{const t=e.detail,{annotation:n}=this.editData,{data:i}=n,{points:a}=i.handles,o=a,s=o[0],r=o[2],l=o[3],d=.5*Math.abs(r[1]-s[1]),c=[l[0]+d,s[1]+d],{currentPoints:h}=t,g=h.canvas,u=(0,gt.getCanvasCircleRadius)([c,g]),m=this._getCanvasHandlePoints(c,u);a[0]=m[0],a[1]=m[1],a[2]=m[2],a[3]=m[3]},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;o=o?.filter(e=>e.data.sourceViewportId===i.id);const s=this.filterInteractableAnnotationsForElement(a,o);if(!s?.length)return n;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const a=s[e],{annotationUID:o,data:r}=a,{magnifyViewportId:d,zoomFactor:c,handles:h}=r,{points:g,activeHandleIndex:u}=h;l.annotationUID=o;this.getStyle("lineWidth",l,a),this.getStyle("lineDash",l,a);const m=this.getStyle("color",l,a),p=g,v=p[0],f=p[2],w=p[3],E=.5*Math.abs(f[1]-v[1]),I=[w[0]+E,v[1]+E];if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let C;if(!(0,ht.isAnnotationVisible)(o))continue;if((0,Be.isAnnotationLocked)(o)||this.editData||null===u||(C=[p[u]]),C){const e="0";(0,D.drawHandles)(t,o,e,C,{color:m})}const b=`${o}-advancedMagnify`,_="0";(0,D.drawCircle)(t,o,_,I,E,{color:m,lineWidth:5},b);const T=this.magnifyViewportManager.getViewport(d);T.position=I,T.radius=E,T.zoomFactor=c,T.update(),n=!0}return n},this._getCanvasHandlePoints=(e,t)=>[[e[0],e[1]-t,0],[e[0]+t,e[1],0],[e[0],e[1]+t,0],[e[0]-t,e[1],0]],this.magnifyViewportManager=Et.getInstance()}showZoomFactorsList(e,t){const{element:n,currentPoints:i}=e.detail,a=(0,s.getEnabledElement)(n),{viewport:o}=a,{canvas:r}=i,l=n.querySelector(":scope .viewport-element"),d=t.data.zoomFactor,c=this._getZoomFactorsListDropdown(d,e=>{void 0!==e&&(t.data.zoomFactor=Number.parseFloat(e),t.invalidated=!0),c.parentElement.removeChild(c),o.render()});Object.assign(c.style,{left:`${r[0]}px`,top:`${r[1]}px`}),l.appendChild(c),c.focus()}_getZoomFactorsListDropdown(e,t){const{zoomFactorList:n}=this.configuration.magnifyingGlass,i=document.createElement("select");return i.size=5,Object.assign(i.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach(e=>{i.addEventListener(e,e=>e.stopPropagation())}),i.addEventListener("change",e=>{e.stopPropagation(),t(i.value)}),i.addEventListener("keydown",e=>{((e.keyCode??27===e.which)||"escape"===e.key?.toLowerCase())&&(e.stopPropagation(),t())}),n.forEach(t=>{const n=document.createElement("option");n.label=t,n.title=`Zoom factor ${t.toFixed(1)}`,n.value=t,n.defaultSelected=t===e,i.add(n)}),i}}class Et{constructor(){this.createViewport=(e,t)=>{const{magnifyViewportId:n,sourceEnabledElement:i,position:a,radius:o,zoomFactor:s,autoPan:r}=t,{viewport:l}=i,{element:d}=l,c=new It({magnifyViewportId:n,sourceEnabledElement:i,radius:o,position:a,zoomFactor:s,autoPan:r});return this._addSourceElementEventListener(d),this._magnifyViewportsMap.set(c.viewportId,{annotation:e,magnifyViewport:c,magnifyViewportInfo:t}),c},this._annotationRemovedCallback=e=>{const{annotation:t}=e.detail;"AdvancedMagnify"===t.metadata.toolName&&this.destroyViewport(t.data.magnifyViewportId)},this._newStackImageCallback=e=>{const{viewportId:t,imageId:n}=e.detail,i=this._getMagnifyViewportsMapEntriesBySourceViewportId(t),{viewport:a}=(0,s.getEnabledElementByViewportId)(t);a.stackActorReInitialized&&this._reset(t),i.forEach(({annotation:e})=>{e.metadata.referencedImageId=n,e.invalidated=!0})},this._newVolumeImageCallback=e=>{const{renderingEngineId:t,viewportId:n}=e.detail,i=(0,s.getRenderingEngine)(t).getViewport(n),{viewPlaneNormal:a}=i.getCamera();this._getMagnifyViewportsMapEntriesBySourceViewportId(n).forEach(({annotation:e})=>{const{viewPlaneNormal:t}=e.metadata;if(!(Math.abs(T.eR.dot(t,a))>ft))return;const{handles:n}=e.data,o=i.canvasToWorld([0,0]),s=T.eR.sub(T.eR.create(),o,n.points[0]),r=T.eR.dot(s,a),l=T.eR.scale(T.eR.create(),a,r);for(let e=0,t=n.points.length;e<t;e++){const t=n.points[e];t[0]+=l[0],t[1]+=l[1],t[2]+=l[2]}e.invalidated=!0})},this._magnifyViewportsMap=new Map,this._initialize()}static getInstance(){return Et._singleton=Et._singleton??new Et,Et._singleton}getViewport(e){return this._magnifyViewportsMap.get(e)?.magnifyViewport}dispose(){this._removeEventListeners(),this._destroyViewports()}destroyViewport(e){const t=this._magnifyViewportsMap.get(e);if(t){const{magnifyViewport:n}=t,{viewport:i}=n.sourceEnabledElement,{element:a}=i;this._removeSourceElementEventListener(a),n.dispose(),this._magnifyViewportsMap.delete(e)}}_destroyViewports(){Array.from(this._magnifyViewportsMap.keys()).forEach(e=>this.destroyViewport(e))}_getMagnifyViewportsMapEntriesBySourceViewportId(e){return Array.from(this._magnifyViewportsMap.values()).filter(({magnifyViewport:t})=>{const{viewport:n}=t.sourceEnabledElement;return n.id===e})}_reset(e){this._getMagnifyViewportsMapEntriesBySourceViewportId(e).forEach(({magnifyViewport:t,annotation:n,magnifyViewportInfo:i})=>{this.destroyViewport(t.viewportId);const a=(0,s.getEnabledElementByViewportId)(e);this.createViewport(n,{...i,sourceEnabledElement:{...a}})})}_addEventListeners(){s.eventTarget.addEventListener(l.Events.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_removeEventListeners(){s.eventTarget.removeEventListener(l.Events.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_addSourceElementEventListener(e){e.addEventListener(mt.STACK_NEW_IMAGE,this._newStackImageCallback);const t=e=>{const{viewportId:t}=e.detail;this._reset(t)};e.addEventListener(mt.VIEWPORT_NEW_IMAGE_SET,t);const n=e=>{const{viewportId:t}=e.detail;this._reset(t)};e.addEventListener(mt.VOLUME_VIEWPORT_NEW_VOLUME,n),e.addEventListener(mt.VOLUME_NEW_IMAGE,this._newVolumeImageCallback),e.newStackHandler=t,e.newVolumeHandler=n}_removeSourceElementEventListener(e){e.removeEventListener(mt.STACK_NEW_IMAGE,this._newStackImageCallback),e.removeEventListener(mt.VOLUME_NEW_IMAGE,this._newVolumeImageCallback),e.removeEventListener(mt.VIEWPORT_NEW_IMAGE_SET,e.newStackHandler),e.removeEventListener(mt.VOLUME_VIEWPORT_NEW_VOLUME,e.newVolumeHandler),delete e.newStackHandler,delete e.newVolumeHandler}_initialize(){this._addEventListeners()}}class It{constructor({magnifyViewportId:e,sourceEnabledElement:t,radius:n=125,position:i=[0,0],zoomFactor:a,autoPan:o}){this._enabledElement=null,this._sourceToolGroup=null,this._magnifyToolGroup=null,this._isViewportReady=!1,this._radius=0,this._resized=!1,this._canAutoPan=!1,this._viewportId=e??s.utilities.uuidv4(),this._sourceEnabledElement=t,this._autoPan=o,this.radius=n,this.position=i,this.zoomFactor=a,this.visible=!0,this._browserMouseDownCallback=this._browserMouseDownCallback.bind(this),this._browserMouseUpCallback=this._browserMouseUpCallback.bind(this),this._handleToolModeChanged=this._handleToolModeChanged.bind(this),this._mouseDragCallback=this._mouseDragCallback.bind(this),this._resizeViewportAsync=(0,y.A)(this._resizeViewport.bind(this),1),this._initialize()}get sourceEnabledElement(){return this._sourceEnabledElement}get viewportId(){return this._viewportId}get radius(){return this._radius}set radius(e){Math.abs(this._radius-e)>1e-5&&(this._radius=e,this._resized=!0)}update(){const{radius:e,position:t,visible:n}=this,{viewport:i}=this._enabledElement,{element:a}=i,o=2*e,[s,r]=t;this._resized&&(this._resizeViewportAsync(),this._resized=!1),Object.assign(a.style,{display:n?"block":"hidden",width:`${o}px`,height:`${o}px`,left:-e+"px",top:-e+"px",transform:`translate(${s}px, ${r}px)`}),this._isViewportReady&&(this._syncViewports(),i.render())}dispose(){const{viewport:e}=this._enabledElement,{element:t}=e,n=e.getRenderingEngine();this._removeEventListeners(t),n.disableElement(e.id),t.parentNode&&t.parentNode.removeChild(t)}_handleToolModeChanged(e){const{_magnifyToolGroup:t}=this,{toolGroupId:n,toolName:i,mode:a,toolBindingsOptions:o}=e.detail;if(this._sourceToolGroup?.id===n)switch(a){case l.ToolModes.Active:t.setToolActive(i,o);break;case l.ToolModes.Passive:t.setToolPassive(i);break;case l.ToolModes.Enabled:t.setToolEnabled(i);break;case l.ToolModes.Disabled:t.setToolDisabled(i);break;default:throw new Error(`Unknow tool mode (${a})`)}}_inheritBorderRadius(e){const t=e.querySelector(".viewport-element"),n=e.querySelector(".cornerstone-canvas");t.style.borderRadius="inherit",n.style.borderRadius="inherit"}_createViewportNode(){const e=document.createElement("div"),{radius:t}=this,n=2*t;return e.classList.add("advancedMagnifyTool"),Object.assign(e.style,{display:"block",width:`${n}px`,height:`${n}px`,position:"absolute",overflow:"hidden",borderRadius:"50%",boxSizing:"border-box",left:-t+"px",top:-t+"px",transform:"translate(-1000px, -1000px)"}),e}_convertZoomFactorToParallelScale(e,t,n){const{parallelScale:i}=e.getCamera();return i*(1/n)*(t.canvas.offsetWidth/e.canvas.offsetWidth)}_isStackViewport(e){return"setStack"in e}_isVolumeViewport(e){return"addVolumes"in e}_cloneToolGroups(e,t){const n=e.getActors(),i=`${t.id}-toolGroup`,a=(0,I.getToolGroupForViewport)(e.id,e.renderingEngineId),o=a.clone(i,e=>{const t=a.getToolInstance(e);return t instanceof Ee.EC&&!(t instanceof wt)});return o.addViewport(t.id,t.renderingEngineId),n.filter(pt).forEach(e=>{(0,he.addSegmentationRepresentations)(this.viewportId,[{segmentationId:e.referencedId,type:l.SegmentationRepresentations.Labelmap}])}),{sourceToolGroup:a,magnifyToolGroup:o}}_cloneStack(e,t){const n=e.getImageIds();t.setStack(n).then(()=>{this._isViewportReady=!0,this.update()})}_cloneVolumes(e,t){const n=e.getActors().filter(e=>!pt(e)).map(e=>({volumeId:e.uid}));return t.setVolumes(n).then(()=>{this._isViewportReady=!0,this.update()}),t}_cloneViewport(e,t){const{viewportId:n}=this,i=e.getRenderingEngine(),{options:a}=e,o={element:t,viewportId:n,type:e.type,defaultOptions:{...a}};i.enableElement(o);const s=i.getViewport(n);this._isStackViewport(e)?this._cloneStack(e,s):this._isVolumeViewport(e)&&this._cloneVolumes(e,s),this._inheritBorderRadius(t);const r=this._cloneToolGroups(e,s);this._sourceToolGroup=r.sourceToolGroup,this._magnifyToolGroup=r.magnifyToolGroup}_cancelMouseEventCallback(e){e.stopPropagation(),e.preventDefault()}_browserMouseUpCallback(e){const{element:t}=this._enabledElement.viewport;document.removeEventListener("mouseup",this._browserMouseUpCallback),t.addEventListener("mouseup",this._cancelMouseEventCallback),t.addEventListener("mousemove",this._cancelMouseEventCallback)}_browserMouseDownCallback(e){const{element:t}=this._enabledElement.viewport;this._canAutoPan=!!e.target?.closest(".advancedMagnifyTool"),document.addEventListener("mouseup",this._browserMouseUpCallback),t.removeEventListener("mouseup",this._cancelMouseEventCallback),t.removeEventListener("mousemove",this._cancelMouseEventCallback)}_mouseDragCallback(e){if(!w.wk.isInteractingWithTool)return;const{_autoPan:t}=this;if(!t.enabled||!this._canAutoPan)return;const{currentPoints:n}=e.detail,{viewport:i}=this._enabledElement,{canvasToWorld:a}=i,{canvas:o}=n,{radius:s}=this,r=[s,s],l=(0,ut.distanceToPoint)(r,o),d=s-t.padding;if(l<=d)return;const c=l-d,h=T.Zc.sub(T.Zc.create(),o,r);T.Zc.normalize(h,h),T.Zc.scale(h,h,c);const g=T.Zc.add(T.Zc.create(),this.position,h),u=a(this.position),m=a(g),p=T.eR.sub(T.eR.create(),m,u),v={points:{currentPosition:{canvas:this.position,world:u},newPosition:{canvas:g,world:m}},delta:{canvas:h,world:p}};t.callback(v)}_addBrowserEventListeners(e){document.addEventListener("mousedown",this._browserMouseDownCallback,!0),e.addEventListener("mousedown",this._cancelMouseEventCallback),e.addEventListener("mouseup",this._cancelMouseEventCallback),e.addEventListener("mousemove",this._cancelMouseEventCallback),e.addEventListener("dblclick",this._cancelMouseEventCallback)}_removeBrowserEventListeners(e){document.removeEventListener("mousedown",this._browserMouseDownCallback,!0),document.removeEventListener("mouseup",this._browserMouseUpCallback),e.removeEventListener("mousedown",this._cancelMouseEventCallback),e.removeEventListener("mouseup",this._cancelMouseEventCallback),e.removeEventListener("mousemove",this._cancelMouseEventCallback),e.removeEventListener("dblclick",this._cancelMouseEventCallback)}_addEventListeners(e){s.eventTarget.addEventListener(l.Events.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(l.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._mouseDragCallback),this._addBrowserEventListeners(e)}_removeEventListeners(e){s.eventTarget.removeEventListener(l.Events.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(l.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._mouseDragCallback),this._removeBrowserEventListeners(e)}_initialize(){const{_sourceEnabledElement:e}=this,{viewport:t}=e,{canvas:n}=t,i=this._createViewportNode();n.parentNode.appendChild(i),this._addEventListeners(i),this._cloneViewport(t,i),this._enabledElement=(0,s.getEnabledElement)(i)}_syncViewportsCameras(e,t){const n=e.canvasToWorld(this.position),i=this._convertZoomFactorToParallelScale(e,t,this.zoomFactor),{focalPoint:a,position:o,viewPlaneNormal:s}=t.getCamera(),r=Math.sqrt(Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)+Math.pow(a[2]-o[2],2)),l=[n[0],n[1],n[2]],d=[l[0]+r*s[0],l[1]+r*s[1],l[2]+r*s[2]];t.setCamera({parallelScale:i,focalPoint:l,position:d})}_syncStackViewports(e,t){t.setImageIdIndex(e.getCurrentImageIdIndex())}_syncViewports(){const{viewport:e}=this._sourceEnabledElement,{viewport:t}=this._enabledElement,n=e.getProperties();t.getImageData()&&(t.setProperties(n),this._syncViewportsCameras(e,t),this._isStackViewport(e)&&this._syncStackViewports(e,t),this._syncViewportsCameras(e,t),t.render())}_resizeViewport(){const{viewport:e}=this._enabledElement;e.getRenderingEngine().resize()}}wt.toolName="AdvancedMagnify";var Ct=n(6030);const{EPSILON:bt}=s.CONSTANTS;class _t extends Ct.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",enforceSameFrameOfReference:!0,showFullDimension:!1}}){super(e,t),this.editData=null,this._init=()=>{const e=(0,s.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,W.filterViewportsWithToolEnabled)(t,this.getToolName());const n=e.getViewport(this.configuration.sourceViewportId);if(!n?.getImageData())return;const{element:i}=n,{viewUp:a,viewPlaneNormal:o}=n.getCamera(),l=s.utilities.getViewportImageCornersInWorld(n);let d=this.editData?.annotation;const c=n.getFrameOfReferenceUID();if(d)this.editData.annotation.data.handles.points=l;else{const e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...o],viewUp:[...a],FrameOfReferenceUID:c,referencedImageId:null},data:{handles:{points:l}}};(0,r.addAnnotation)(e,i),d=e}this.editData={sourceViewportId:n.id,renderingEngine:e,annotation:d},(0,L.A)(t.filter(e=>e.id!==n.id).map(e=>e.id))},this.onSetToolEnabled=()=>{this._init()},this.onSetToolConfiguration=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n}=e;if(!this.editData)return!1;const{annotation:i,sourceViewportId:a}=this.editData;let o=!1;const{viewport:r}=(0,s.getEnabledElementByViewportId)(a)||{};if(!r)return o;if(r.id===n.id)return o;if(!i||!i?.data?.handles?.points)return o;if(this.configuration.enforceSameFrameOfReference&&r.getFrameOfReferenceUID()!==n.getFrameOfReferenceUID())return o;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},d=i.data.handles.points[0],c=i.data.handles.points[1],h=i.data.handles.points[2],g=i.data.handles.points[3],{focalPoint:u,viewPlaneNormal:m,viewUp:p}=n.getCamera(),{viewPlaneNormal:v}=r.getCamera();if(this.isParallel(m,v))return o;const f=s.utilities.planar.planeEquation(m,u),w=[d,h,c,g],E=[d,c,h,g];let I=w,C=T.eR.subtract(T.eR.create(),w[0],w[1]);C=T.eR.normalize(T.eR.create(),C);let b=T.eR.subtract(T.eR.create(),w[2],w[0]);b=T.eR.normalize(T.eR.create(),b);const _=T.eR.cross(T.eR.create(),C,b);if(this.isParallel(_,m))return o;this.isPerpendicular(C,m)&&(I=E);const A=s.utilities.planar.linePlaneIntersection(I[0],I[1],f),S=s.utilities.planar.linePlaneIntersection(I[2],I[3],f),{annotationUID:M}=i;l.annotationUID=M;const y=this.getStyle("lineWidth",l,i),P=this.getStyle("lineDash",l,i),x=this.getStyle("color",l,i),R=this.getStyle("shadow",l,i);let L=[A,S].map(e=>n.worldToCanvas(e));if(this.configuration.showFullDimension&&(L=this.handleFullDimension(n,A,m,p,S,L)),L.length<2)return o;const O=`${M}-line`;return(0,D.drawLine)(t,M,"1",L[0],L[1],{color:x,width:y,lineDash:P,shadow:R},O),o=!0,o},this.isPerpendicular=(e,t)=>{const n=T.eR.dot(e,t);return Math.abs(n)<bt}}handleFullDimension(e,t,n,i,a,o){e.getRenderingEngine();const r=this.getTargetId(e),l=this.getTargetImageData(r),d=this.getReferencedImageId(e,t,n,i);if(d&&l)try{const{imageData:n,dimensions:i}=l,[r,c,h,g]=[n.indexToWorld([0,0,0]),n.indexToWorld([i[0]-1,0,0]),n.indexToWorld([i[0]-1,i[1]-1,0]),n.indexToWorld([0,i[1]-1,0])].map(e=>s.utilities.worldToImageCoords(d,e)),[u,m]=[t,a].map(e=>s.utilities.worldToImageCoords(d,e));o=[[r,c],[c,h],[g,h],[r,g]].map(([e,t])=>this.intersectInfiniteLines(e,t,u,m)).filter(e=>e&&this.isInBound(e,i)).map(t=>{const n=s.utilities.imageToWorldCoords(d,t);return e.worldToCanvas(n)})}catch(e){console.log(e)}return o}intersectInfiniteLines(e,t,n,i){const[a,o]=e,[s,r]=t,[l,d]=n,[c,h]=i,g=r-o,u=a-s,m=s*o-a*r,p=h-d,v=l-c,f=c*d-l*h;if(Math.abs(g*v-p*u)<bt)return;return[(u*f-v*m)/(g*v-p*u),(p*m-g*f)/(g*v-p*u)]}isParallel(e,t){return Math.abs(T.eR.dot(e,t))>1-bt}isInBound(e,t){return e[0]>=0&&e[0]<=t[0]&&e[1]>=0&&e[1]<=t[1]}}_t.toolName="ReferenceLines";const{EPSILON:Tt}=s.CONSTANTS;class At extends Ct.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}}){super(e,t),this.onSetToolEnabled=()=>{this._init()},this.onSetToolActive=()=>{this._init()},this._init=()=>{const e=this.configuration.sourceImageIds;if(!e?.length)return void console.warn("OverlayGridTool: No sourceImageIds provided in configuration");const t=s.metaData.get("imagePlaneModule",e[0]);if(!t)return void console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds");const{frameOfReferenceUID:n}=t,i=(0,I.getToolGroup)(this.toolGroupId).viewportsInfo;if(!i?.length)return void console.warn("OverlayGridTool: No viewports found");const a=(0,r.getAnnotations)(this.getToolName(),n);if(!a?.length){const t=e.map(e=>this.calculateImageIdPointSets(e)),i={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{viewportData:new Map,pointSets:t}};(0,r.addAnnotation)(i,n)}(0,L.A)(i.map(({viewportId:e})=>e))},this.calculateImageIdPointSets=e=>{const{imagePositionPatient:t,rows:n,columns:i,rowCosines:a,columnCosines:o,rowPixelSpacing:r,columnPixelSpacing:l}=s.metaData.get("imagePlaneModule",e),d=[...t],c=[...t],h=[...t],g=[...t];T.eR.scaleAndAdd(c,t,o,i*l),T.eR.scaleAndAdd(h,t,a,n*r),T.eR.scaleAndAdd(g,h,o,i*l);return{pointSet1:[d,h,c,g],pointSet2:[d,c,h,g]}},this.renderAnnotation=(e,t)=>{const n=this.configuration.sourceImageIds;let i=!1;if(!n?.length)return i;const{viewport:a,FrameOfReferenceUID:o}=e;if(a.getImageIds().length<2)return i;const l=(0,r.getAnnotations)(this.getToolName(),o);if(!l?.length)return i;const d=l[0],{annotationUID:c}=d,{focalPoint:h,viewPlaneNormal:g}=a.getCamera(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},m=this.getImageIdNormal(n[0]);if(this.isParallel(g,m))return i;const p=s.utilities.planar.planeEquation(g,h),v=d.data.pointSets,f=d.data.viewportData;for(let e=0;e<n.length;e++){const{pointSet1:n,pointSet2:i}=v[e],o=f.get(a.id)||this.initializeViewportData(f,a.id);if(!o.pointSetsToUse[e]){let t=n,a=T.eR.subtract(T.eR.create(),n[0],n[1]);a=T.eR.normalize(T.eR.create(),a),this.isPerpendicular(a,g)&&(t=i),o.pointSetsToUse[e]=t,o.lineStartsWorld[e]=s.utilities.planar.linePlaneIntersection(t[0],t[1],p),o.lineEndsWorld[e]=s.utilities.planar.linePlaneIntersection(t[2],t[3],p)}const r=o.lineStartsWorld[e],l=o.lineEndsWorld[e];u.annotationUID=c;const h=this.getStyle("lineWidth",u,d),m=this.getStyle("lineDash",u,d),w=this.getStyle("color",u,d),E=this.getStyle("shadow",u,d),I=[r,l].map(e=>a.worldToCanvas(e)),C=`${c}-line`,b=`${e}`;(0,D.drawLine)(t,c,b,I[0],I[1],{color:w,width:h,lineDash:m,shadow:E},C)}return i=!0,i},this.initializeViewportData=(e,t)=>(e.set(t,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(t)),this.isPerpendicular=(e,t)=>{const n=T.eR.dot(e,t);return Math.abs(n)<Tt}}isParallel(e,t){return Math.abs(T.eR.dot(e,t))>1-Tt}getImageIdNormal(e){const{imageOrientationPatient:t}=s.metaData.get("imagePlaneModule",e),n=T.eR.fromValues(t[0],t[1],t[2]),i=T.eR.fromValues(t[3],t[4],t[5]);return T.eR.cross(T.eR.create(),n,i)}}At.toolName="OverlayGrid";class St extends Ct.A{constructor(e={},t={configuration:{opacity:.5}}){super(e,t),this._init=()=>{const e=(0,I.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e?.length)return void console.warn(this.getToolName()+"Tool: No viewports found");const t=(0,s.getRenderingEngine)(e[0].renderingEngineId)?.getViewport(e[0].viewportId);if(!t)return;const n=t.getFrameOfReferenceUID(),i=(0,r.getAnnotations)(this.getToolName(),n);if(!i?.length){const t=new Map;!function(e,t){t.forEach(({viewportId:t,renderingEngineId:n})=>{const i=(0,s.getRenderingEngine)(n)?.getViewport(t);Mt(e,i)})}(t,e);const i={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{actorsWorldPointsMap:t}};(0,r.addAnnotation)(i,n)}(0,L.A)(e.map(({viewportId:e})=>e))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n,FrameOfReferenceUID:i}=e;let a=!1;const o=(0,r.getAnnotations)(this.getToolName(),i);if(!o?.length)return a;const s=o[0],{annotationUID:l}=s,d=s.data.actorsWorldPointsMap;Mt(d,n);const c=n.getActors(),h=Dt(n);return c.forEach(e=>{if(!e?.clippingFilter)return;const i=d.get(e.uid);if(!i)return;if(!i.get(h))return;let a=1;const{worldPointsSet:o,color:s}=i.get(h);for(let i=0;i<o.length;i++){const r=o[i].map(e=>n.worldToCanvas(e)),d={color:s,fillColor:s,fillOpacity:this.configuration.opacity,closePath:!0,lineWidth:2},c=e.uid+"#"+a;(0,D.drawPath)(t,l,c,r,d),a++}}),a=!0,a}}}function Mt(e,t){const n=t.getActors(),i=Dt(t);n.forEach(t=>{if(!t?.clippingFilter)return;let n=e.get(t.uid);if(n||(n=new Map,e.set(t.uid,n)),!n.get(i)){const e=j(t.clippingFilter.getOutputData());if(!e)return;const a=function(e){function t(e){let t=Math.floor(255*e).toString(16);return 1===t.length&&(t="0"+t),t}return"#"+t(e[0])+t(e[1])+t(e[2])}(t.actor.getProperty().getColor());n.set(i,{worldPointsSet:e,color:a})}})}function Dt(e){const{viewPlaneNormal:t}=e.getCamera(),n=e.getCurrentImageIdIndex();return`${e.id}-${function(e,t=5){return parseFloat(e[0]).toFixed(t)+","+parseFloat(e[1]).toFixed(t)+","+parseFloat(e[2]).toFixed(t)+","}(t)}-${n}`}St.toolName="SegmentationIntersection";class yt extends Ct.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}){super(e,t),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{const{detail:t}=e,{element:n,currentPoints:i}=t;this._currentCursorWorldPosition=i.world,this._currentCanvasPosition=i.canvas,this._elementWithCursor=n;const a=this.getActiveAnnotation(n);return null===a?(this.createInitialAnnotation(i.world,n),!1):(this.updateAnnotationPosition(n,a),!1)},this.createInitialAnnotation=(e,t)=>{const n=(0,s.getEnabledElement)(t);if(!n)throw new Error("No enabled element found");const{viewport:i,renderingEngine:a}=n;this.isDrawing=!0;const o=i.getCamera(),{viewPlaneNormal:l,viewUp:d}=o;if(!l||!d)throw new Error("Camera not found");const c=this.getReferencedImageId(i,e,l,d),h=i.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...l],viewUp:[...d],FrameOfReferenceUID:h,referencedImageId:c},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if((0,r.getAnnotations)(this.getToolName(),t).length>0)return null;if(null===(0,r.addAnnotation)(g,t))return;const u=(0,W.getViewportIdsWithToolToRender)(t,this.getToolName(),!1);(0,L.A)(u)},this.onCameraModified=e=>{const t=e.detail,{element:n,previousCamera:i,camera:a}=t,o=(0,s.getEnabledElement)(n).viewport;if(n!==this._elementWithCursor)return;const r=i.focalPoint,l=a.viewPlaneNormal,d=a.focalPoint,c=[0,0,0];if(Ce.Ay.subtract(d,r,c),0===c.reduce((e,t)=>e+t,0))return;const h=Ce.Ay.dot(c,l);if(Math.abs(h)<.01)return;if(!this._currentCanvasPosition)return;const g=o.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=g,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,FrameOfReferenceUID:a}=e,o=this._elementWithCursor===i.element;this.configuration.positionSync&&!o&&this.updateViewportImage(i);const{element:s}=i;let l=(0,r.getAnnotations)(this.getToolName(),s);if(!l?.length)return n;if(l=this.filterInteractableAnnotationsForElement(s,l),!l?.length)return n;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<l.length;e++){const a=l[e],{annotationUID:s,data:r}=a,{handles:c}=r,{points:h}=c;if(!s)return n;d.annotationUID=s;const g=parseFloat(this.getStyle("lineWidth",d,a)),u=g,m=this.getStyle("lineDash",d,a),p=this.getStyle("color",d,a);if(h[0].some(e=>isNaN(e)))return n;const v=h.map(e=>i.worldToCanvas(e));if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ht.isAnnotationVisible)(s))continue;const f={upper:"upper",right:"right",lower:"lower",left:"left"},[w,E]=v[0],I=o?20:7,C=o?5:7;(0,D.drawLine)(t,s,f.upper,[w,E-(I/2+C)],[w,E-I/2],{color:p,lineDash:m,lineWidth:u}),(0,D.drawLine)(t,s,f.lower,[w,E+(I/2+C)],[w,E+I/2],{color:p,lineDash:m,lineWidth:u}),(0,D.drawLine)(t,s,f.right,[w+(I/2+C),E],[w+I/2,E],{color:p,lineDash:m,lineWidth:u}),(0,D.drawLine)(t,s,f.left,[w-(I/2+C),E],[w-I/2,E],{color:p,lineDash:m,lineWidth:u}),n=!0}return n},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const e=(0,I.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map(e=>(0,s.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)).forEach(e=>{e&&(0,Ve.hideElementCursor)(e.viewport.element)})}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const e=(0,I.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map(e=>(0,s.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)).forEach(e=>{e&&(0,Ve.resetElementCursor)(e.viewport.element)})}getActiveAnnotation(e){const t=(0,r.getAnnotations)(this.getToolName(),e);if(!t.length)return null;return t[0]}updateAnnotationPosition(e,t){const n=this._currentCursorWorldPosition;if(!n)return;if(!t.data?.handles?.points)return;t.data.handles.points=[[...n]],t.invalidated=!0;const i=(0,W.getViewportIdsWithToolToRender)(e,this.getToolName(),!1);(0,s.getEnabledElement)(e)&&(0,L.A)(i)}filterInteractableAnnotationsForElement(e,t){if(!(t instanceof Array)||0===t.length)return[];const n=t[0],i=(0,s.getEnabledElement)(e)?.viewport;if(!i)return[];const a=i.getCamera(),{viewPlaneNormal:o,focalPoint:r}=a;if(!o||!r)return[];const l=n.data?.handles?.points;if(!(l instanceof Array)||1!==l.length)return[];const d=l[0],c=s.utilities.planar.planeEquation(o,r);return s.utilities.planar.planeDistanceToPoint(c,d)<this.configuration.displayThreshold?[n]:[]}updateViewportImage(e){const t=this._currentCursorWorldPosition;if(t&&!t.some(e=>isNaN(e)))if(e instanceof s.StackViewport){const n=s.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof s.VolumeViewport){const{focalPoint:n,viewPlaneNormal:i}=e.getCamera();if(!n||!i)return;const a=s.utilities.planar.planeEquation(i,n),o=s.utilities.planar.planeDistanceToPoint(a,t,!0);if(Math.abs(o)<.5)return;const r=T.eR.normalize(T.eR.create(),T.eR.fromValues(...i)),l=T.eR.scale(T.eR.create(),r,o),d=T.eR.add(T.eR.create(),T.eR.fromValues(...n),l);if(!0){e.setCamera({focalPoint:d});const t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}yt.toolName="ReferenceCursors";const Pt=[];class xt extends Ct.A{constructor(e={},t={configuration:{viewportId:"",scaleLocation:"bottom"}}){super(e,t),this.editData=null,this._init=()=>{const e=(0,s.getRenderingEngines)()[0];if(!e)return;const t=(0,I.getToolGroup)(this.toolGroupId).viewportsInfo;if(!t)return;const n=t.map(e=>(0,s.getEnabledElementByIds)(e.viewportId,e.renderingEngineId));let{viewport:i}=n[0];const{FrameOfReferenceUID:a}=n[0];if(this.configuration.viewportId&&n.forEach(e=>{e.viewport.id==this.configuration.viewportId&&(i=e.viewport)}),!i)return;const{viewUp:o,viewPlaneNormal:l}=i.getCamera(),d=s.utilities.getViewportImageCornersInWorld(i);let c=this.editData?.annotation;const h=(0,r.getAnnotations)(this.getToolName(),i.element);h.length&&(c=h.filter(e=>e.data.viewportId==i.id)[0]),n.forEach(e=>{const{viewport:t}=e;if(!Pt.includes(t.id)){const e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...l],viewUp:[...o],FrameOfReferenceUID:a,referencedImageId:null},data:{handles:{points:s.utilities.getViewportImageCornersInWorld(t)},viewportId:t.id}};Pt.push(t.id),(0,r.addAnnotation)(e,t.element),c=e}}),this.editData?.annotation&&this.editData.annotation.data.viewportId==i.id&&(this.editData.annotation.data.handles.points=d,this.editData.annotation.data.viewportId=i.id),this.editData={viewport:i,renderingEngine:e,annotation:c}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,t,n)=>{const i=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let a;return a="top"==n||"bottom"==n?i.filter(t=>t<.6*e&&t>.2*e):i.filter(e=>e<.6*t&&e>.2*t),a[0]},this.computeEndScaleTicks=(e,t)=>{const n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}},this.computeInnerScaleTicks=(e,t,n,i,a)=>{let o;"bottom"==t||"top"==t?o=a[0][0]-i[0][0]:"left"!=t&&"right"!=t||(o=a[0][1]-i[0][1]);const s=[],r=[],l=[];let d=e;e>=50&&(d=e/10);const c=o/d;for(let e=0;e<d-1;e++){const a={bottom:[[c*(e+1),0],[c*(e+1),5]],top:[[c*(e+1),0],[c*(e+1),-5]],left:[[0,c*(e+1)],[-5,c*(e+1)]],right:[[0,c*(e+1)],[5,c*(e+1)]]};s.push(`${n}-tick${e}`),r.push(`tick${e}`),(e+1)%5==0?l.push([[i[0][0]+a[t][0][0],i[0][1]+a[t][0][1]],[i[1][0]+a[t][0][0],i[1][1]+a[t][0][1]]]):l.push([[i[0][0]+a[t][0][0],i[0][1]+a[t][0][1]],[i[1][0]+a[t][1][0],i[1][1]+a[t][1][1]]])}return{tickIds:s,tickUIDs:r,tickCoordinates:l}},this.computeWorldScaleCoordinates=(e,t,n)=>{let i,a=T.eR.subtract(T.eR.create(),n[0],n[1]);a=T.eR.normalize(T.eR.create(),a);let o=T.eR.subtract(T.eR.create(),n[2],n[0]);o=T.eR.normalize(T.eR.create(),o);const s={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},r=T.eR.add(T.eR.create(),s[t][0],s[t][0]).map(e=>e/2),l=e/2/Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2));return"top"==t||"bottom"==t?i=[T.eR.subtract(T.eR.create(),r,o.map(e=>e*l)),T.eR.add(T.eR.create(),r,o.map(e=>e*l))]:"left"!=t&&"right"!=t||(i=[T.eR.add(T.eR.create(),r,a.map(e=>e*l)),T.eR.subtract(T.eR.create(),r,a.map(e=>e*l))]),i},this.computeCanvasScaleCoordinates=(e,t,n,i,a)=>{let o;if("top"==a||"bottom"==a){const i=t[0][0]-t[1][0];o=[[e.width/2-i/2,n.height],[e.width/2+i/2,n.height]]}else if("left"==a||"right"==a){const n=t[0][1]-t[1][1];o=[[i.width,e.height/2-n/2],[i.width,e.height/2+n/2]]}return o},this.computeScaleBounds=(e,t,n,i)=>{const a=t*Math.min(1e3,e.width),o=n*Math.min(1e3,e.height),s={bottom:[-o,-a],top:[o,a],left:[o,a],right:[-o,-a]},r={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:r[i][0]+s[i][0],width:r[i][1]+s[i][1]}}}renderAnnotation(e,t){if(!this.editData||!this.editData.viewport)return;const n=this.configuration.scaleLocation,{viewport:i}=e,a=(0,r.getAnnotations)(this.getToolName(),i.element).filter(e=>e.data.viewportId==i.id)[0],o=e.viewport.canvas,s=!1;if(!i)return s;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},d={width:o.width/window.devicePixelRatio||1,height:o.height/window.devicePixelRatio||1},c=a.data.handles.points[0],h=a.data.handles.points[1],g=a.data.handles.points[2],u=a.data.handles.points[3],m=[c,g,h,u],p=T.eR.distance(g,u),v=T.eR.distance(c,g),f=this.computeScaleBounds(d,.05,.05,n),w=this.computeScaleBounds(d,.05,.05,n),E=this.computeScaleSize(p,v,n),I=this.computeWorldScaleCoordinates(E,n,m).map(e=>i.worldToCanvas(e)),C=this.computeCanvasScaleCoordinates(d,I,w,f,n),b=this.computeEndScaleTicks(C,n),{annotationUID:_}=a;l.annotationUID=_;const A=this.getStyle("lineWidth",l,a),S=this.getStyle("lineDash",l,a),M=this.getStyle("color",l,a),y=this.getStyle("shadow",l,a),P=`${_}-scaleline`;(0,D.drawLine)(t,_,"1",C[0],C[1],{color:M,width:A,lineDash:S,shadow:y},P);const x=`${_}-left`;(0,D.drawLine)(t,_,"2",b.endTick1[0],b.endTick1[1],{color:M,width:A,lineDash:S,shadow:y},x);const R=`${_}-right`;(0,D.drawLine)(t,_,"3",b.endTick2[0],b.endTick2[1],{color:M,width:A,lineDash:S,shadow:y},R);const L={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},O=[C[0][0]+L[n][0],C[0][1]+L[n][1]],U=this._getTextLines(E),{tickIds:k,tickUIDs:N,tickCoordinates:V}=this.computeInnerScaleTicks(E,n,_,b.endTick1,b.endTick2);for(let e=0;e<N.length;e++)(0,D.drawLine)(t,_,N[e],V[e][0],V[e][1],{color:M,width:A,lineDash:S,shadow:y},k[e]);return(0,D.drawTextBox)(t,_,"text0",U,[O[0],O[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:M}),s}_getTextLines(e){let t,n;e>=50?(t=e/10,n=" cm"):(t=e,n=" mm");return[t.toString().concat(n)]}}xt.toolName="ScaleOverlay";var Rt=n(76712),Lt=n(16175),Ot=n(13271);class Ut extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{minSpacing:1,referencedToolNames:["PlanarFreehandROI","PlanarFreehandContourSegmentationTool"],toolShape:"circle",referencedToolName:"PlanarFreehandROI",updateCursorSize:"dynamic"}}){super(e,t),this.registeredShapes=new Map,this.isActive=!1,this.commonData={activeAnnotationUID:null,viewportIdsToRender:[],isEditingOpenContour:!1,canvasLocation:void 0},this.preMouseDownCallback=e=>{const t=e.detail,n=t.element;if(this.configureToolSize(e),this.selectFreehandTool(t),null!==this.commonData.activeAnnotationUID)return this.isActive=!0,(0,Ve.hideElementCursor)(n),this.activateModify(n),!0},this.mouseMoveCallback=e=>{this.mode===l.ToolModes.Active?(this.configureToolSize(e),this.updateCursor(e)):this.commonData.canvasLocation=void 0},this.endCallback=e=>{const t=e.detail,{element:n}=t,i=this.configuration,a=(0,s.getEnabledElement)(n);this.isActive=!1,this.deactivateModify(n),(0,Ve.resetElementCursor)(n);const{renderingEngineId:o,viewportId:r}=a,d=(0,I.getToolGroupForViewport)(r,o).getToolInstance(i.referencedToolName),c=this.filterSculptableAnnotationsForElement(n).find(e=>e.annotationUID===this.commonData.activeAnnotationUID);d.configuration.calculateStats&&(c.invalidated=!0),(0,ae.triggerAnnotationModified)(c,n,l.ChangeTypes.HandlesUpdated)},this.dragCallback=e=>{const t=e.detail,n=t.element;this.updateCursor(e);const i=this.filterSculptableAnnotationsForElement(n),a=i.find(e=>e.annotationUID===this.commonData.activeAnnotationUID);if(!i?.length||!this.isActive)return;const o=a.data.contour.polyline;this.sculpt(t,o)},this.registerShapes(Lt.A.shapeName,Lt.A),this.setToolShape(this.configuration.toolShape)}registerShapes(e,t){const n=new t;this.registeredShapes.set(e,n)}sculpt(e,t){const n=this.configuration,i=e.element,a=(0,s.getEnabledElement)(i),{viewport:o}=a,r=this.registeredShapes.get(this.selectedShape);this.sculptData={mousePoint:e.currentPoints.world,mouseCanvasPoint:e.currentPoints.canvas,deltaWorld:e.deltaPoints.world,points:t,maxSpacing:r.getMaxSpacing(n.minSpacing),element:i};const l=r.pushHandles(o,this.sculptData);void 0!==l.first&&this.insertNewHandles(l)}interpolatePointsWithinMaxSpacing(e,t,n,i){const{element:a}=this.sculptData,o=(0,s.getEnabledElement)(a),{viewport:r}=o,l=kt(e+1,t.length),d=r.worldToCanvas(t[e]),c=r.worldToCanvas(t[l]);N.point.distanceToPoint(d,c)>i&&n.push(e)}updateCursor(e){const t=e.detail,n=t.element,i=(0,s.getEnabledElement)(n),{renderingEngine:a,viewport:o}=i;this.commonData.viewportIdsToRender=[o.id];const r=this.filterSculptableAnnotationsForElement(n);if(!r?.length)return;const l=r.find(e=>e.annotationUID===this.commonData.activeAnnotationUID);if(this.commonData.canvasLocation=t.currentPoints.canvas,this.isActive)l.highlighted=!0;else{const e=this.registeredShapes.get(this.selectedShape),n=t.currentPoints.canvas;"dynamic"===this.configuration.updateCursorSize&&e.updateToolSize(n,o,l)}(0,L.t)(this.commonData.viewportIdsToRender)}filterSculptableAnnotationsForElement(e){const t=this.configuration,n=(0,s.getEnabledElement)(e),{renderingEngineId:i,viewportId:a}=n,o=[],r=(0,I.getToolGroupForViewport)(a,i).getToolInstance(t.referencedToolName);return t.referencedToolNames.forEach(t=>{const n=(0,E.Rh)(t,e);n&&o.push(...n)}),r.filterInteractableAnnotationsForElement(e,o)}configureToolSize(e){this.registeredShapes.get(this.selectedShape).configureToolSize(e)}insertNewHandles(e){const t=this.findNewHandleIndices(e);let n=0;for(let e=0;e<t?.length;e++){const i=t[e]+1+n;this.insertHandleRadially(i),n++}}findNewHandleIndices(e){const{points:t,maxSpacing:n}=this.sculptData,i=[];for(let a=e.first;a<=e.last;a++)this.interpolatePointsWithinMaxSpacing(a,t,i,n);return i}insertHandleRadially(e){const{points:t}=this.sculptData;if(e>t.length-1&&this.commonData.isEditingOpenContour)return;const n=this.registeredShapes.get(this.selectedShape),i=e-1,a=kt(e,t.length),o=n.getInsertPosition(i,a,this.sculptData);t.splice(e,0,o)}selectFreehandTool(e){const t=this.getClosestFreehandToolOnElement(e);void 0!==t&&(this.commonData.activeAnnotationUID=t)}getClosestFreehandToolOnElement(e){const{element:t}=e,n=(0,s.getEnabledElement)(t),{viewport:i}=n,a=this.configuration,o=this.filterSculptableAnnotationsForElement(t);if(!o?.length)return;const r=e.currentPoints.canvas,l={distance:1/0,toolIndex:void 0,annotationUID:void 0};for(let e=0;e<o?.length;e++){if(o[e].isLocked||!o[e].isVisible)continue;const t=(0,Ot.X)(i,o[e],r);-1!==t&&(t<l.distance&&(l.distance=t,l.toolIndex=e,l.annotationUID=o[e].annotationUID))}return this.commonData.isEditingOpenContour=!o[l.toolIndex].data.contour.closed,a.referencedToolName=o[l.toolIndex].metadata.toolName,l.annotationUID}activateModify(e){e.addEventListener(l.Events.MOUSE_UP,this.endCallback),e.addEventListener(l.Events.MOUSE_CLICK,this.endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this.dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this.endCallback),e.addEventListener(l.Events.TOUCH_END,this.endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this.dragCallback)}deactivateModify(e){e.removeEventListener(l.Events.MOUSE_UP,this.endCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this.endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this.dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this.endCallback),e.removeEventListener(l.Events.TOUCH_END,this.endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this.dragCallback)}setToolShape(e){this.selectedShape=this.registeredShapes.get(e)??Lt.A.shapeName}renderAnnotation(e,t){const{viewport:n}=e,{element:i}=n,a=this.commonData.viewportIdsToRender;if(!this.commonData.canvasLocation||this.mode!==l.ToolModes.Active||!a.includes(n.id))return;const o=this.filterSculptableAnnotationsForElement(i);if(!o?.length)return;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};let r=(0,Rt.h)("color",s,l.AnnotationStyleStates.Default,this.mode);this.isActive&&(r=(0,Rt.h)("color",s,l.AnnotationStyleStates.Highlighted,this.mode));this.registeredShapes.get(this.selectedShape).renderShape(t,this.commonData.canvasLocation,{color:r})}}const kt=(e,t)=>(e+t)%t;Ut.toolName="SculptorTool";const Nt=[0,0,1];class Vt extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:Nt,rotateIncrementDegrees:30}}){super(e,t)}mouseWheelCallback(e){const{element:t,wheel:n}=e.detail,i=(0,s.getEnabledElement)(t),{viewport:a}=i,{direction:o,rotateIncrementDegrees:r}=this.configuration,l=a.getCamera(),{viewUp:d,position:c,focalPoint:h}=l,{direction:g}=n,[u,m,p]=h,[v,f,w]=o,E=g*(r*Math.PI)/180,I=[0,0,0],C=[0,0,0],b=[0,0,0],_=T.pB.identity(new Float32Array(16));T.pB.translate(_,_,[u,m,p]),T.pB.rotate(_,_,E,[v,f,w]),T.pB.translate(_,_,[-u,-m,-p]),T.eR.transformMat4(I,c,_),T.eR.transformMat4(C,h,_),T.pB.identity(_),T.pB.rotate(_,_,E,[v,f,w]),T.eR.transformMat4(b,d,_),a.setCamera({position:I,viewUp:b,focalPoint:C}),a.render()}}Vt.toolName="VolumeRotateMouseWheel";var Wt=n(25072);class Bt extends Ee.EC{static{this.toolName="Label"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:Ht,changeTextCallback:Gt,preventHandleOutsideImage:!1}}){super(e,t),this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{annotationUID:r}=t,l=t.data.handles.points[0],d=o.worldToCanvas(l);if(T.Zc.distance(n,d)<i)return!0;const c=e.querySelector("svg");if(!c)return!1;const h=c.querySelector(`g[data-annotation-uid="${r}"]`);if(!h)return!1;const g=h,u=g.getBBox(),m=g.getAttribute("transform");let p=0,v=0;if(m){const e=m.match(/translate\(([-\d.]+)\s+([-\d.]+)\)/);e&&(p=parseFloat(e[1]),v=parseFloat(e[2]))}const f=u.x+p,w=u.y+v;return n[0]>=f&&n[0]<=f+u.width&&n[1]>=w&&n[1]<=w+u.height},this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world;(0,Ve.hideElementCursor)(i),this.isDrawing=!0;const o=this.createAnnotation(e,[[...a],[...a]]);(0,r.addAnnotation)(o,i);const s=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:o,newAnnotation:!0,viewportIdsToRender:s,offset:[0,0,0]},e.preventDefault(),(0,L.A)(s),this.configuration.getTextCallback(e=>{if(!e)return(0,r.removeAnnotation)(o.annotationUID),(0,L.A)(s),void(this.isDrawing=!1);(0,Ve.resetElementCursor)(i),o.data.label=e,(0,ae.triggerAnnotationCompleted)(o),(0,L.A)(s)}),this.createMemo(i,o,{newAnnotation:!0}),o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i,currentPoints:a}=n;t.highlighted=!0;const o=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());let s=[0,0,0];if(a&&a.world){const e=a.world,n=t.data.handles.points[0];s=[n[0]-e[0],n[1]-e[1],n[2]-e[2]]}this.editData={annotation:t,viewportIdsToRender:o,offset:s},this._activateModify(i),(0,Ve.hideElementCursor)(i),(0,L.A)(o),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o}=this.editData;this._deactivateDraw(n),this._deactivateModify(n),(0,Ve.resetElementCursor)(n),o&&this.createMemo(n,i,{newAnnotation:o}),this.editData=null,this.isDrawing=!1,this.doneEditMemo(),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i)},this._dragCallback=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,{annotation:o,viewportIdsToRender:s,offset:r}=this.editData;o.data.handles.points[0]=r?[a[0]+r[0],a[1]+r[1],a[2]+r[2]]:[...a],o.invalidated=!0,(0,L.A)(s),(0,ae.triggerAnnotationModified)(o,i,l.ChangeTypes.LabelChange)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;o=this.filterInteractableAnnotationsForElement(a,o);const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<o.length;e++){const a=o[e],{annotationUID:r,data:l}=a,d=l.handles.points[0];s.annotationUID=r;const c=i.worldToCanvas(d);if(n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ht.isAnnotationVisible)(r))continue;if(!l.label)continue;const h=this.getLinkedTextBoxStyle(s,a),g="1";(0,D.drawTextBox)(t,r,g,[l.label],c,{...h,padding:0})}return n}}static{this.hydrate=(e,t,n,i)=>{const a=(0,s.getEnabledElementByViewportId)(e);if(!a)return;const{viewport:o}=a,l=o.getFrameOfReferenceUID(),{viewPlaneNormal:d,viewUp:c}=o.getCamera(),h=new this,g=h.getReferencedImageId(o,t,d,c),u={annotationUID:i?.annotationUID||s.utilities.uuidv4(),data:{label:n,handles:{points:[t]}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:h.getToolName(),viewPlaneNormal:d,FrameOfReferenceUID:l,referencedImageId:g,...i}};(0,r.addAnnotation)(u,o.element),(0,L.A)([o.id])}}handleSelectedCallback(e,t,n,i){}_doneChangingTextCallback(e,t,n){t.data.label=n;const i=(0,W.getViewportIdsWithToolToRender)(e,this.getToolName());(0,L.A)(i),(0,ae.triggerAnnotationModified)(t,e)}_isInsideVolume(e,t,n){return s.utilities.indexWithinDimensions(e,n)&&s.utilities.indexWithinDimensions(t,n)}}function Ht(e){return e(prompt("Enter your annotation:"))}function Gt(e,t,n){return n(prompt("Enter your annotation:"))}Bt.toolName="Label";const{transformWorldToIndex:Ft}=s.utilities;class zt extends Ee.EC{static{this.toolName="Length"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Xt,actions:{undo:{method:"undo",bindings:[{key:"z"}]},redo:{method:"redo",bindings:[{key:"y"}]}}}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world;(0,Ve.hideElementCursor)(i),this.isDrawing=!0;const o=this.createAnnotation(e,[[...a],[...a]]);(0,r.addAnnotation)(o,i);const s=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:o,viewportIdsToRender:s,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,L.A)(s),o},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,[l,d]=r.handles.points,c=o.worldToCanvas(l),h=o.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return re.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,Ve.hideElementCursor)(i),(0,L.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:s}=this.editData,{data:l}=i;o&&!s||(l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),this.doneEditMemo(),o&&(0,ae.triggerAnnotationCompleted)(i),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:s,newAnnotation:r}=this.editData,{data:d}=i;if(this.createMemo(n,i,{newAnnotation:r}),s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;d.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0,(0,L.A)(a),i.invalidated&&(0,ae.triggerAnnotationModified)(i,n,l.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){const r=o[a],{annotationUID:c,data:h}=r,{points:g,activeHandleIndex:u}=h.handles;d.annotationUID=c;const{color:m,lineWidth:p,lineDash:v,shadow:f}=this.getAnnotationStyle({annotation:r,styleSpecifier:d}),w=g.map(e=>i.worldToCanvas(e));if(h.cachedStats[s]&&null!=h.cachedStats[s].unit?r.invalidated&&this._throttledCalculateCachedStats(r,l,e):(h.cachedStats[s]={length:null,unit:null},this._calculateCachedStats(r,l,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let E;if(!(0,ht.isAnnotationVisible)(c))continue;(0,Be.isAnnotationLocked)(c)||this.editData||null===u||(E=[w[u]]);const I=Boolean((0,Rt.h)("showHandlesAlways",{}));if(E||I){const e="0";(0,D.drawHandles)(t,c,e,w,{color:m,lineDash:v,lineWidth:p})}const C=`${c}-line`,b="1";if((0,D.drawLine)(t,c,b,w[0],w[1],{color:m,width:p,lineDash:v,shadow:f},C),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const _=this.getLinkedTextBoxStyle(d,r);if(!_.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const T=this.configuration.getTextLines(h,s);if(!h.handles.textBox.hasMoved){const e=(0,k.getTextBoxCoordsCanvas)(w);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const A=i.worldToCanvas(h.handles.textBox.worldPosition),S="1",M=(0,D.drawLinkedTextBox)(t,c,S,T,A,w,{},_),{x:y,y:P,width:x,height:R}=M;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([y,P]),topRight:i.canvasToWorld([y+x,P]),bottomLeft:i.canvasToWorld([y,P+R]),bottomRight:i.canvasToWorld([y+x,P+R])}}return n},this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,100,{trailing:!0})}static{this.hydrate=(e,t,n)=>{const i=(0,s.getEnabledElementByViewportId)(e);if(!i)return;const{FrameOfReferenceUID:a,referencedImageId:o,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase(zt,i,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||s.utilities.uuidv4(),data:{handles:{points:t}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:o,...g}};(0,r.addAnnotation)(u,c.element),(0,L.A)([c.id])}}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;let s,r=!1;n.worldPosition?r=!0:s=o.handles.points.findIndex(e=>e===n);const l=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(a),(0,Ve.hideElementCursor)(a),(0,L.A)(l),e.preventDefault()}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],a=e[2]-t[2];return Math.sqrt(n*n+i*i+a*a)}_calculateCachedStats(e,t,n){const i=e.data,{element:a}=n.viewport,o=i.handles.points[0],s=i.handles.points[1],{cachedStats:r}=i,d=Object.keys(r);for(let e=0;e<d.length;e++){const t=d[e],n=this.getTargetImageData(t);if(!n)continue;const{imageData:i,dimensions:a}=n,l=Ft(i,o),c=Ft(i,s),h=[l,c],{scale:g,unit:u}=(0,R.Op)(n,h),m=this._calculateLength(o,s)/g;this._isInsideVolume(l,c,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,r[t]={length:m,unit:u}}const c=e.invalidated;return e.invalidated=!1,c&&(0,ae.triggerAnnotationModified)(e,a,l.ChangeTypes.StatsUpdated),r}_isInsideVolume(e,t,n){return s.utilities.indexWithinDimensions(e,n)&&s.utilities.indexWithinDimensions(t,n)}}function Xt(e,t){const n=e.cachedStats[t],{length:i,unit:a}=n;if(null==i||isNaN(i))return;return[`${s.utilities.roundNumber(i)} ${a}`]}const{transformWorldToIndex:$t}=s.utilities;class Zt extends Ee.EC{static{this.toolName="Height"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Yt}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world;(0,Ve.hideElementCursor)(i),this.isDrawing=!0;const o=this.createAnnotation(e,[[...a],[...a]]);(0,r.addAnnotation)(o,i);const s=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:o,viewportIdsToRender:s,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,L.A)(s),o},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,[l,d]=r.handles.points,c=o.worldToCanvas(l),h=o.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return re.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,Ve.hideElementCursor)(i);(0,s.getEnabledElement)(i);(0,L.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:l}=this.editData,{data:d}=i;if(o&&!l)return;d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const c=(0,s.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,s.getEnabledElement)(n),{renderingEngine:c}=d;(0,L.A)(a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;(0,s.getEnabledElement)(e);return(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){const r=o[a],{annotationUID:c,data:h}=r,{points:g,activeHandleIndex:u}=h.handles;d.annotationUID=c;const{color:m,lineWidth:p,lineDash:v,shadow:f}=this.getAnnotationStyle({annotation:r,styleSpecifier:d}),w=g.map(e=>i.worldToCanvas(e));let E;if(h.cachedStats[s]&&null!=h.cachedStats[s].unit?r.invalidated&&this._throttledCalculateCachedStats(r,l,e):(h.cachedStats[s]={length:null,unit:null},this._calculateCachedStats(r,l,e)),!(0,ht.isAnnotationVisible)(c))continue;(0,Be.isAnnotationLocked)(c)||this.editData||null===u||(E=[w[u]]);const I=Boolean((0,Rt.h)("showHandlesAlways",{}));if(E||I){const e="0";(0,D.drawHandles)(t,c,e,w,{color:m,lineDash:v,lineWidth:p})}const C="0";if((0,D.drawHeight)(t,c,C,w[0],w[1],{color:m,width:p,lineDash:v}),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const b=this.getLinkedTextBoxStyle(d,r);if(!b.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const _=this.configuration.getTextLines(h,s);if(!h.handles.textBox.hasMoved){const e=(0,k.getTextBoxCoordsCanvas)(w);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const T=i.worldToCanvas(h.handles.textBox.worldPosition),A="1",S=(0,D.drawLinkedTextBox)(t,c,A,_,T,w,{},b),{x:M,y,width:P,height:x}=S;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([M,y]),topRight:i.canvasToWorld([M+P,y]),bottomLeft:i.canvasToWorld([M,y+x]),bottomRight:i.canvasToWorld([M+P,y+x])}}return n},this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=o.handles.points.findIndex(e=>e===n);const d=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,Ve.hideElementCursor)(a);const c=(0,s.getEnabledElement)(a),{renderingEngine:h}=c;(0,L.A)(d),e.preventDefault()}_calculateHeight(e,t){const n=t[0]-e[0],i=t[1]-e[1],a=t[2]-e[2];return 0==n?0!=i?Math.abs(a):0:0==i?Math.abs(a):0==a?Math.abs(i):void 0}_calculateCachedStats(e,t,n){const i=e.data,{element:a}=n.viewport,o=i.handles.points[0],s=i.handles.points[1],{cachedStats:r}=i,d=Object.keys(r);for(let e=0;e<d.length;e++){const t=d[e],n=this.getTargetImageData(t);if(!n)continue;const{imageData:i,dimensions:a}=n,l=$t(i,o),c=$t(i,s),h=[l,c],{scale:g,unit:u}=(0,R.Op)(n,h),m=this._calculateHeight(o,s)/g,p=this._isInsideVolume(l,c,a);this.isHandleOutsideImage=p,r[t]={height:m,unit:u}}const c=e.invalidated;return e.invalidated=!1,c&&(0,ae.triggerAnnotationModified)(e,a,l.ChangeTypes.StatsUpdated),r}_isInsideVolume(e,t,n){return s.utilities.indexWithinDimensions(e,n)&&s.utilities.indexWithinDimensions(t,n)}}function Yt(e,t){const n=e.cachedStats[t],{height:i,unit:a}=n;if(null==i||isNaN(i))return;return[`${s.utilities.roundNumber(i)} ${a}`]}var jt=n(18990);const{transformWorldToIndex:qt}=s.utilities;class Kt extends Ee.EC{static{this.toolName="Probe"}static{this.probeDefaults={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Jt,handleRadius:"6",textCanvasOffset:{x:6,y:-6}}}}constructor(e={},t){super(e,Ee.EC.mergeDefaultProps(Kt.probeDefaults,t)),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:l}=o;this.isDrawing=!0;const d=this.constructor.createAnnotationForViewport(l,{data:{handles:{points:[[...a]]}}});(0,r.addAnnotation)(d,i);const c=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:d,newAnnotation:!0,viewportIdsToRender:c},this._activateModify(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(c),d},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o}=this.editData,{viewportId:l,renderingEngine:d}=(0,s.getEnabledElement)(n);this.eventDispatchDetail={viewportId:l,renderingEngineId:d.id},this._deactivateModify(n),(0,Ve.resetElementCursor)(n),o&&this.createMemo(n,i,{newAnnotation:o}),this.editData=null,this.isDrawing=!1,this.doneEditMemo(),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,{annotation:o,viewportIdsToRender:s,newAnnotation:r}=this.editData,{data:l}=o;this.createMemo(i,o,{newAnnotation:r}),l.handles.points[0]=[...a],o.invalidated=!0,(0,L.A)(s)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const d=this.getTargetId(i),c=i.getRenderingEngine(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){const r=o[a],g=r.annotationUID,u=r.data,m=u.handles.points[0],p=i.worldToCanvas(m);h.annotationUID=g;const{color:v,lineWidth:f}=this.getAnnotationStyle({annotation:r,styleSpecifier:h});if(u.cachedStats||(u.cachedStats={}),u.cachedStats[d]&&null!==u.cachedStats[d].value){if(r.invalidated&&(this._calculateCachedStats(r,c,e),i instanceof s.VolumeViewport)){const{referencedImageId:e}=r.metadata;for(const t in u.cachedStats)if(t.startsWith("imageId")){c.getStackViewports().find(t=>{const n=s.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=s.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n})&&delete u.cachedStats[t]}}}else u.cachedStats[d]={Modality:null,index:null,value:null},this._calculateCachedStats(r,c,e,l.ChangeTypes.StatsUpdated);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ht.isAnnotationVisible)(g))continue;const w="0";(0,D.drawHandles)(t,g,w,[p],{color:v,lineWidth:f,handleRadius:this.configuration.handleRadius}),n=!0;const E=this.getLinkedTextBoxStyle(h,r);if(!E.visibility)continue;const I=this.configuration.getTextLines(u,d);if(I){const e=[p[0]+this.configuration.textCanvasOffset.x,p[1]+this.configuration.textCanvasOffset.y],n="0";(0,D.drawTextBox)(t,g,n,I,[e[0],e[1]],E)}}return n}}isPointNearTool(e,t,n,i){const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,l=r.handles.points[0],d=o.worldToCanvas(l);return T.Zc.distance(n,d)<i}toolSelectedCallback(){}static{this.hydrate=(e,t,n)=>{const i=(0,s.getEnabledElementByViewportId)(e);if(!i)return;const{FrameOfReferenceUID:a,referencedImageId:o,viewPlaneNormal:l,viewUp:d,instance:c,viewport:h}=this.hydrateBase(Kt,i,t,n),{toolInstance:g,...u}=n||{},m={annotationUID:n?.annotationUID||s.utilities.uuidv4(),data:{handles:{points:t}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:o,...u}};(0,r.addAnnotation)(m,h.element),(0,L.A)([h.id])}}getHandleNearImagePoint(e,t,n,i){const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,l=r.handles.points[0],d=o.worldToCanvas(l);if(!0===T.Zc.distance(n,d)<i)return l}handleSelectedCallback(e,t){const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},this._activateModify(i),(0,Ve.hideElementCursor)(i),(0,L.A)(a),e.preventDefault()}_calculateCachedStats(e,t,n,i=l.ChangeTypes.StatsUpdated){const a=e.data,{renderingEngineId:o,viewport:r}=n,{element:d}=r,c=a.handles.points[0],{cachedStats:h}=a,g=Object.keys(h);for(let t=0;t<g.length;t++){const n=g[t],i={isPreScaled:(0,jt.u)(r,n),isSuvScaled:this.isSuvScaled(r,n,e.metadata.referencedImageId)},a=this.getTargetImageData(n);if(!a)continue;const{dimensions:o,imageData:l,metadata:d,voxelManager:u}=a,m=d.Modality;let p=qt(l,c);if(p=T.eR.round(p,p),s.utilities.indexWithinDimensions(p,o)){this.isHandleOutsideImage=!1;let t,o=u.getAtIJKPoint(p);if(n.startsWith("imageId:")){const e=n.split("imageId:")[1],t=s.utilities.imageIdToURI(e),i=s.utilities.getViewportsWithImageURI(t)[0];p[2]=i.getCurrentImageIdIndex()}if("US"===m){const e=(0,R.Xw)(a,[p]),n=e.values.every(e=>null!==e);o=n?e.values:o,t=n?e.units:"raw"}else t=(0,ne.j)(m,e.metadata.referencedImageId,i);h[n]={index:p,value:o,Modality:m,modalityUnit:t},e.invalidated=!0}else this.isHandleOutsideImage=!0,h[n]={index:p,Modality:m}}const u=e.invalidated;return e.invalidated=!1,u&&(0,ae.triggerAnnotationModified)(e,d,i),h}}function Jt(e,t){const n=e.cachedStats[t],{index:i,value:a,modalityUnit:o}=n;if(void 0===a||!i)return;const r=[];if(r.push(`(${i[0]}, ${i[1]}, ${i[2]})`),a instanceof Array&&o instanceof Array)for(let e=0;e<a.length;e++)r.push(`${s.utilities.roundNumber(a[e])} ${o[e]}`);else r.push(`${s.utilities.roundNumber(a)} ${o}`);return r}const Qt=Kt;class en extends Qt{static{this.toolName="DragProbe"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:tn}}){super(e,t),this.postMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:r,renderingEngine:l}=o;this.isDrawing=!0;const d=r.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.getReferencedImageId(r,a,c,h),u={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:g},data:{label:"",handles:{points:[[...a]]},cachedStats:{}}},m=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:u,newAnnotation:!0,viewportIdsToRender:m},this._activateModify(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(m),u},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e;if(!this.editData)return n;const a=this.filterInteractableAnnotationsForElement(i.element,[this.editData.annotation]);if(!a?.length)return n;const o=this.getTargetId(i),s=i.getRenderingEngine(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l=this.editData.annotation,d=l.annotationUID,c=l.data,h=c.handles.points[0],g=i.worldToCanvas(h);r.annotationUID=d;const{color:u}=this.getAnnotationStyle({annotation:l,styleSpecifier:r});if(c.cachedStats[o]&&null!==c.cachedStats[o].value?l.invalidated&&this._calculateCachedStats(l,s,e):(c.cachedStats[o]={Modality:null,index:null,value:null},this._calculateCachedStats(l,s,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;(0,D.drawHandles)(t,d,"0",[g],{color:u}),n=!0;const m=this.configuration.getTextLines(c,o);if(m){const e=[g[0]+6,g[1]-6],n="0";(0,D.drawTextBox)(t,d,n,m,[e[0],e[1]],this.getLinkedTextBoxStyle(r,l))}return n}}}function tn(e,t){const n=e.cachedStats[t],{index:i,value:a,modalityUnit:o}=n;if(void 0===a)return;const s=[];return s.push(`(${i[0]}, ${i[1]}, ${i[2]})`),s.push(`${a.toFixed(2)} ${o}`),s}n(4010);var nn=n(62514),an=n(87009),on=n(73262);const{transformWorldToIndex:sn}=s.utilities;class rn extends Ee.EC{static{this.toolName="EllipticalROI"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,storePointData:!1,centerPointRadius:0,calculateStats:!0,getTextLines:ln,statsCalculator:on.BasicStatsCalculator}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world;this.isDrawing=!0;const o=this.createAnnotation(e,[[...a],[...a],[...a],[...a]]);(0,r.addAnnotation)(o,i);const s=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:o,viewportIdsToRender:s,centerWorld:a,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(s),o},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,{points:l}=r.handles,d=l.map(e=>o.worldToCanvas(e)),[c,h,g,u]=d,m=Math.hypot(g[0]-u[0],g[1]-u[1]),p=Math.hypot(h[0]-c[0],h[1]-c[1]),v=Math.atan2(g[1]-u[1],g[0]-u[0]),f=[(g[0]+u[0])/2,(h[1]+c[1])/2],w={center:f,xRadius:(m-i)/2,yRadius:(p-i)/2,angle:v},E={center:f,xRadius:(m+i)/2,yRadius:(p+i)/2,angle:v},I=this._pointInEllipseCanvas(w,n);return!(!this._pointInEllipseCanvas(E,n)||I)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,Ve.hideElementCursor)(i),this._activateModify(i);const o=(0,s.getEnabledElement)(i),{renderingEngine:r}=o;(0,L.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;let r,l,d,c,h,g,u=!1;if(n.worldPosition)u=!0;else{const{points:e}=o.handles,{viewport:t}=(0,s.getEnabledElement)(a),{worldToCanvas:i,canvasToWorld:u}=t;r=e.findIndex(e=>e===n);const m=e.map(i);g=m[r],c=Math.abs(m[2][0]-m[3][0]),h=Math.abs(m[0][1]-m[1][1]),l=[(m[2][0]+m[3][0])/2,(m[0][1]+m[1][1])/2],d=u(l)}const m=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:m,handleIndex:r,canvasWidth:c,canvasHeight:h,centerWorld:d,originalHandleCanvas:g,movingTextBox:u},this._activateModify(a),(0,Ve.hideElementCursor)(a),(0,L.A)(m),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:s}=this.editData,{data:l}=i;o&&!s||(this.doneEditMemo(),i.highlighted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i))},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,o=(0,s.getEnabledElement)(n),{viewport:r}=o,{canvasToWorld:d}=r,{annotation:c,viewportIdsToRender:h,centerWorld:g,newAnnotation:u}=this.editData;this.createMemo(n,c,{newAnnotation:u});const m=r.worldToCanvas(g),{data:p}=c,v=Math.abs(a[0]-m[0]),f=Math.abs(a[1]-m[1]),w=[m[0],m[1]-f],E=[m[0],m[1]+f],I=[m[0]-v,m[1]],C=[m[0]+v,m[1]];p.handles.points=[d(w),d(E),d(I),d(C)],c.invalidated=!0,this.editData.hasMoved=!0,(0,L.A)(h),(0,ae.triggerAnnotationModified)(c,n,l.ChangeTypes.HandlesUpdated)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r,newAnnotation:d}=this.editData;this.createMemo(n,i,{newAnnotation:d});const{data:c}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=c.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){const{deltaPoints:e}=t,n=e.world;c.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const h=(0,s.getEnabledElement)(n),{renderingEngine:g}=h;(0,L.A)(a),i.invalidated&&(0,ae.triggerAnnotationModified)(i,n,l.ChangeTypes.HandlesUpdated)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,{viewport:i}=(0,s.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:o}=i,{annotation:r,canvasWidth:l,canvasHeight:d,handleIndex:c,centerWorld:h,originalHandleCanvas:g}=this.editData,u=i.worldToCanvas(h),{data:m}=r,{points:p}=m.handles,{currentPoints:v}=t,f=v.canvas;if(0===c||1===c){const e=Math.abs(f[1]-u[1]),t=[u[0],u[1]-e],n=[u[0],u[1]+e];p[0]=a(t),p[1]=a(n);const i=l/2+(f[0]-g[0]),o=[u[0]-i,u[1]],s=[u[0]+i,u[1]];p[2]=a(o),p[3]=a(s)}else{const e=Math.abs(f[0]-u[0]),t=[u[0]-e,u[1]],n=[u[0]+e,u[1]];p[2]=a(t),p[3]=a(n);const i=d/2+(f[1]-g[1]),o=[u[0],u[1]-i],s=[u[0],u[1]+i];p[0]=a(o),p[1]=a(s)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const l=this.getTargetId(i),d=i.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){const r=o[a],{annotationUID:h,data:g}=r,{handles:u}=g,{points:m,activeHandleIndex:p}=u;c.annotationUID=h;const{color:v,lineWidth:f,lineDash:w}=this.getAnnotationStyle({annotation:r,styleSpecifier:c}),E=m.map(e=>i.worldToCanvas(e)),I=(0,an.getCanvasEllipseCorners)(E),{centerPointRadius:C}=this.configuration;if(g.cachedStats[l]&&null!=g.cachedStats[l].areaUnit){if(r.invalidated&&(this._throttledCalculateCachedStats(r,i,d,e),i instanceof s.VolumeViewport)){const{referencedImageId:e}=r.metadata;for(const t in g.cachedStats)if(t.startsWith("imageId")){d.getStackViewports().find(t=>{const n=s.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=s.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n})&&delete g.cachedStats[t]}}}else g.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(r,i,d);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let b;if(!(0,ht.isAnnotationVisible)(h))continue;(0,Be.isAnnotationLocked)(h)||this.editData||null===p||(b=[E[p]]);const _=Boolean((0,Rt.h)("showHandlesAlways",{}));if(b||_){const e="0";(0,D.drawHandles)(t,h,e,_?E:b,{color:v})}const T=`${h}-ellipse`,A="0";if((0,D.drawEllipseByCoordinates)(t,h,A,E,{color:v,lineDash:w,lineWidth:f},T),C>0){if(Math.min(Math.abs(I[0][0]-I[1][0])/2,Math.abs(I[0][1]-I[1][1])/2)>3*C){const e=this._getCanvasEllipseCenter(E);(0,D.drawCircle)(t,h,`${A}-center`,e,C,{color:v,lineDash:w,lineWidth:f})}}n=!0;const S=this.getLinkedTextBoxStyle(c,r);if(!S.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const M=this.configuration.getTextLines(g,l);if(!M||0===M.length)continue;let y;g.handles.textBox.hasMoved||(y=(0,k.getTextBoxCoordsCanvas)(I),g.handles.textBox.worldPosition=i.canvasToWorld(y));const P=i.worldToCanvas(g.handles.textBox.worldPosition),x="1",R=(0,D.drawLinkedTextBox)(t,h,x,M,P,E,{},S),{x:L,y:O,width:U,height:N}=R;g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([L,O]),topRight:i.canvasToWorld([L+U,O]),bottomLeft:i.canvasToWorld([L,O+N]),bottomRight:i.canvasToWorld([L+U,O+N])}}return n},this._calculateCachedStats=(e,t,n)=>{if(!this.configuration.calculateStats)return;const i=e.data,{element:a}=t,{points:o}=i.handles,r=o.map(e=>t.worldToCanvas(e)),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[h,g]=(0,an.getCanvasEllipseCorners)(r),u=t.canvasToWorld(h),m=t.canvasToWorld(g),{cachedStats:p}=i,v=Object.keys(p),f=u,w=m;for(let n=0;n<v.length;n++){const i=v[n],a=this.getTargetImageData(i);if(!a)continue;const{dimensions:o,imageData:r,metadata:l,voxelManager:h}=a,g=sn(r,f);g[0]=Math.floor(g[0]),g[1]=Math.floor(g[1]),g[2]=Math.floor(g[2]);const E=sn(r,w);if(E[0]=Math.floor(E[0]),E[1]=Math.floor(E[1]),E[2]=Math.floor(E[2]),this._isInsideVolume(g,E,o)){const n=[[Math.min(g[0],E[0]),Math.max(g[0],E[0])],[Math.min(g[1],E[1]),Math.max(g[1],E[1])],[Math.min(g[2],E[2]),Math.max(g[2],E[2])]],o=[(u[0]+m[0])/2,(u[1]+m[1])/2,(u[2]+m[2])/2],v=Math.abs(u[0]-m[0])/2,I=Math.abs(u[1]-m[1])/2,C=Math.abs(u[2]-m[2])/2,b={center:o,xRadius:v<s.EPSILON/2?0:v,yRadius:I<s.EPSILON/2?0:I,zRadius:C<s.EPSILON/2?0:C},{worldWidth:_,worldHeight:T}=(0,nn.A)(d,c,f,w),A=0===_&&0===T,S=[g,E],{scale:M,unit:D,areaUnit:y}=(0,R.Op)(a,S),P=(0,R.CQ)(a),x=Math.abs(Math.PI*(_/M/2)*(T/P/M/2)),L={isPreScaled:(0,jt.u)(t,i),isSuvScaled:this.isSuvScaled(t,i,e.metadata.referencedImageId)},O=(0,ne.j)(l.Modality,e.metadata.referencedImageId,L);let U;h&&(U=h.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:e=>(0,an.pointInEllipse)(b,e,{fast:!0}),boundsIJK:n,imageData:r,returnPoints:this.configuration.storePointData}));const k=this.configuration.statsCalculator.getStatistics();p[i]={Modality:l.Modality,area:x,mean:k.mean?.value,max:k.max?.value,min:k.min?.value,stdDev:k.stdDev?.value,statsArray:k.array,pointsInShape:U,isEmptyArea:A,areaUnit:y,modalityUnit:O}}else this.isHandleOutsideImage=!0,p[i]={Modality:l.Modality}}const E=e.invalidated;return e.invalidated=!1,E&&(0,ae.triggerAnnotationModified)(e,a,l.ChangeTypes.StatsUpdated),p},this._isInsideVolume=(e,t,n)=>s.utilities.indexWithinDimensions(e,n)&&s.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,100,{trailing:!0})}static{this.hydrate=(e,t,n)=>{const i=(0,s.getEnabledElementByViewportId)(e);if(!i)return;const{FrameOfReferenceUID:a,referencedImageId:o,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase(rn,i,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||s.utilities.uuidv4(),data:{handles:{points:t,activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:o,...g}};(0,r.addAnnotation)(u,c.element),(0,L.A)([c.id])}}_pointInEllipseCanvas(e,t){const{xRadius:n,yRadius:i,center:a,angle:o}=e,s=T.Zc.rotate(T.Zc.create(),t,a,-o);if(n<=0||i<=0)return!1;const r=[s[0]-a[0],s[1]-a[1]];return r[0]*r[0]/(n*n)+r[1]*r[1]/(i*i)<=1}_getCanvasEllipseCenter(e){const[t,n,i,a]=e,o=[i[0],n[1]],s=[a[0],t[1]];return[(o[0]+s[0])/2,(o[1]+s[1])/2]}}function ln(e,t){const n=e.cachedStats[t],{area:i,mean:a,stdDev:o,max:r,isEmptyArea:l,areaUnit:d,modalityUnit:c,min:h}=n,g=[];if(s.utilities.isNumber(i)){const e=l?"Area: Oblique not supported":`Area: ${s.utilities.roundNumber(i)} ${d}`;g.push(e)}return s.utilities.isNumber(a)&&g.push(`Mean: ${s.utilities.roundNumber(a)} ${c}`),s.utilities.isNumber(r)&&g.push(`Max: ${s.utilities.roundNumber(r)} ${c}`),s.utilities.isNumber(h)&&g.push(`Min: ${s.utilities.roundNumber(h)} ${c}`),s.utilities.isNumber(o)&&g.push(`Std Dev: ${s.utilities.roundNumber(o)} ${c}`),g}const{transformWorldToIndex:dn}=s.utilities;class cn extends Ee.EC{static{this.toolName="CircleROI"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,storePointData:!1,centerPointRadius:0,calculateStats:!0,getTextLines:hn,statsCalculator:on.BasicStatsCalculator,simplified:!0}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world;let o;this.isDrawing=!0,o=this.configuration.simplified?[[...a],[...a]]:[[...a],[...a],[...a],[...a],[...a]];const s=this.createAnnotation(e,o);(0,r.addAnnotation)(s,i);const l=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:s,viewportIdsToRender:l,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(l),s},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{points:r}=t.data.handles,l=r.map(e=>o.worldToCanvas(e)),d=l[0],c=(0,gt.getCanvasCircleRadius)([d,l[1]]),h=(0,gt.getCanvasCircleRadius)([d,n]);return Math.abs(h-c)<i/2},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,Ve.hideElementCursor)(i),this._activateModify(i),(0,L.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;let s,r=!1;if(n.worldPosition)r=!0;else{const{points:e}=o.handles;s=e.findIndex(e=>e===n)}const l=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(a),(0,Ve.hideElementCursor)(a),(0,L.A)(l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:s}=this.editData,{data:l}=i;o&&!s||(this.doneEditMemo(),i.highlighted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i))},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n,currentPoints:i}=t,{world:a,canvas:o}=i,r=(0,s.getEnabledElement)(n),{viewport:d}=r,{canvasToWorld:c}=d,{annotation:h,viewportIdsToRender:g,newAnnotation:u}=this.editData;this.createMemo(n,h,{newAnnotation:u});const{data:m}=h,p=m.handles.points[0],v=d.worldToCanvas(p);if(this.configuration.simplified)m.handles.points[1]=a;else{const e=T.Zc.distance(v,o);m.handles.points[0]=[...p],m.handles.points[1]=c([v[0],v[1]-e]),m.handles.points[2]=c([v[0],v[1]+e]),m.handles.points[3]=c([v[0]-e,v[1]]),m.handles.points[4]=c([v[0]+e,v[1]])}h.invalidated=!0,this.editData.hasMoved=!0,(0,L.A)(g),(0,ae.triggerAnnotationModified)(h,n,l.ChangeTypes.HandlesUpdated)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:s,newAnnotation:r}=this.editData;this.createMemo(n,i,{newAnnotation:r});const{data:d}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;(0,L.A)(a),i.invalidated&&(0,ae.triggerAnnotationModified)(i,n,l.ChangeTypes.HandlesUpdated)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,i=(0,s.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:o}=i.viewport,{annotation:r,handleIndex:l}=this.editData,{data:d}=r,{points:c}=d.handles,{currentPoints:h,deltaPoints:g}=t;if(0===l){const e=g.world;c.forEach(t=>{T.eR.add(t,t,e)})}else{const e=o(c[0]),t=h.canvas,n=T.Zc.distance(e,t);c[1]=a([e[0],e[1]-n]),c[2]=a([e[0],e[1]+n]),c[3]=a([e[0]-n,e[1]]),c[4]=a([e[0]+n,e[1]])}r.invalidated=!0},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;return t.highlighted=!1,t.data.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const l=this.getTargetId(i),d=i.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){const r=o[a],{annotationUID:h,data:g}=r,{handles:u}=g,{points:m,activeHandleIndex:p}=u;c.annotationUID=h;const{color:v,lineWidth:f,lineDash:w}=this.getAnnotationStyle({annotation:r,styleSpecifier:c}),E=m.map(e=>i.worldToCanvas(e)),I=E[0],C=(0,gt.getCanvasCircleRadius)([I,E[1]]),b=(0,gt.getCanvasCircleCorners)([I,E[1]]),{centerPointRadius:_}=this.configuration;if(g.cachedStats[l]&&null!=g.cachedStats[l].areaUnit){if(r.invalidated&&(this._throttledCalculateCachedStats(r,i,d,e),i instanceof s.VolumeViewport)){const{referencedImageId:e}=r.metadata;for(const t in g.cachedStats)if(t.startsWith("imageId")){d.getStackViewports().find(t=>{const n=s.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=s.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n})&&delete g.cachedStats[t]}}}else g.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(r,i,d,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let T;if(!(0,ht.isAnnotationVisible)(h))continue;(0,Be.isAnnotationLocked)(h)||this.editData||null===p||(T=this.configuration.simplified?[E[p]]:E);const A=Boolean((0,Rt.h)("showHandlesAlways",{}));if(T||A){const e="0";(0,D.drawHandles)(t,h,e,A?E:T,{color:v})}const S=`${h}-circle`,M="0";if((0,D.drawCircle)(t,h,M,I,C,{color:v,lineDash:w,lineWidth:f},S),_>0&&C>3*_&&(0,D.drawCircle)(t,h,`${M}-center`,I,_,{color:v,lineDash:w,lineWidth:f}),n=!0,this.configuration.calculateStats){const e=this.getLinkedTextBoxStyle(c,r);if(!e.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const n=this.configuration.getTextLines(g,l);if(!n||0===n.length)continue;let a;g.handles.textBox.hasMoved||(a=(0,k.getTextBoxCoordsCanvas)(b),g.handles.textBox.worldPosition=i.canvasToWorld(a));const o=i.worldToCanvas(g.handles.textBox.worldPosition),s="1",d=(0,D.drawLinkedTextBox)(t,h,s,n,o,[I,E[1]],{},e),{x:u,y:m,width:p,height:v}=d;g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([u,m]),topRight:i.canvasToWorld([u+p,m]),bottomLeft:i.canvasToWorld([u,m+v]),bottomRight:i.canvasToWorld([u+p,m+v])}}}return n},this._calculateCachedStats=(e,t,n,i)=>{if(!this.configuration.calculateStats)return;const a=e.data,{element:o}=t,r=e.invalidated,{points:d}=a.handles,c=d.map(e=>t.worldToCanvas(e)),h=c[0],g=c[1],{viewPlaneNormal:u,viewUp:m}=t.getCamera(),[p,v]=(0,gt.getCanvasCircleCorners)([h,g]),f=t.canvasToWorld(p),w=t.canvasToWorld(v),{cachedStats:E}=a,I=Object.keys(E),C=f,b=w;for(let n=0;n<I.length;n++){const i=I[n],a=this.getTargetImageData(i);if(!a)continue;const{dimensions:o,imageData:r,metadata:l,voxelManager:c}=a,h=dn(r,C);h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]);const g=dn(r,b);if(g[0]=Math.floor(g[0]),g[1]=Math.floor(g[1]),g[2]=Math.floor(g[2]),this._isInsideVolume(h,g,o)){const n=[[Math.min(h[0],g[0]),Math.max(h[0],g[0])],[Math.min(h[1],g[1]),Math.max(h[1],g[1])],[Math.min(h[2],g[2]),Math.max(h[2],g[2])]],o=d[0],p=Math.abs(f[0]-w[0])/2,v=Math.abs(f[1]-w[1])/2,I=Math.abs(f[2]-w[2])/2,_={center:o,xRadius:p<s.EPSILON/2?0:p,yRadius:v<s.EPSILON/2?0:v,zRadius:I<s.EPSILON/2?0:I},{worldWidth:T,worldHeight:A}=(0,nn.A)(u,m,C,b),S=0===T&&0===A,M=[h,g],{scale:D,unit:y,areaUnit:P}=(0,R.Op)(a,M),x=(0,R.CQ)(a),L=Math.abs(Math.PI*(T/D/2)*(A/x/D/2)),O={isPreScaled:(0,jt.u)(t,i),isSuvScaled:this.isSuvScaled(t,i,e.metadata.referencedImageId)},U=(0,ne.j)(l.Modality,e.metadata.referencedImageId,O);let k;c&&(k=c.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:e=>(0,an.pointInEllipse)(_,e,{fast:!0}),boundsIJK:n,imageData:r,returnPoints:this.configuration.storePointData}));const N=this.configuration.statsCalculator.getStatistics();E[i]={Modality:l.Modality,area:L,mean:N.mean?.value,max:N.max?.value,min:N.min?.value,pointsInShape:k,stdDev:N.stdDev?.value,statsArray:N.array,isEmptyArea:S,areaUnit:P,radius:T/2/D,radiusUnit:y,perimeter:2*Math.PI*(T/2)/D,modalityUnit:U}}else this.isHandleOutsideImage=!0,E[i]={Modality:l.Modality}}return e.invalidated=!1,r&&(0,ae.triggerAnnotationModified)(e,o,l.ChangeTypes.StatsUpdated),E},this._isInsideVolume=(e,t,n)=>s.utilities.indexWithinDimensions(e,n)&&s.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,100,{trailing:!0})}static{this.hydrate=(e,t,n)=>{const i=(0,s.getEnabledElementByViewportId)(e);if(!i)return;const{FrameOfReferenceUID:a,referencedImageId:o,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase(cn,i,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||s.utilities.uuidv4(),data:{handles:{points:t,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:o,...g}};(0,r.addAnnotation)(u,c.element),(0,L.A)([c.id])}}}function hn(e,t){const n=e.cachedStats[t],{radius:i,radiusUnit:a,area:o,mean:r,stdDev:l,max:d,min:c,isEmptyArea:h,areaUnit:g,modalityUnit:u}=n,m=[];if(s.utilities.isNumber(i)){const e=h?"Radius: Oblique not supported":`Radius: ${s.utilities.roundNumber(i)} ${a}`;m.push(e)}if(s.utilities.isNumber(o)){const e=h?"Area: Oblique not supported":`Area: ${s.utilities.roundNumber(o)} ${g}`;m.push(e)}return s.utilities.isNumber(r)&&m.push(`Mean: ${s.utilities.roundNumber(r)} ${u}`),s.utilities.isNumber(d)&&m.push(`Max: ${s.utilities.roundNumber(d)} ${u}`),s.utilities.isNumber(c)&&m.push(`Min: ${s.utilities.roundNumber(c)} ${u}`),s.utilities.isNumber(l)&&m.push(`Std Dev: ${s.utilities.roundNumber(l)} ${u}`),m}const gn=cn;class un extends Ee.EC{static{this.toolName="ETDRSGrid"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,degrees:[45,135,225,315],diameters:[10,30,60]}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:l,renderingEngine:d}=o;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,a,h,g),m=l.getFrameOfReferenceUID(),p={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u,...l.getViewReference({points:[a]})},data:{label:"",handles:{points:[[...a]]}}};(0,r.addAnnotation)(p,i);const v=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:v,newAnnotation:!0},this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(v),p},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,{points:l}=r.handles,d=o.worldToCanvas(l[0]),c=(0,gt.getCanvasCircleRadius)([d,n]);return Math.abs(c)<i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},(0,Ve.hideElementCursor)(i),this._activateModify(i);const o=(0,s.getEnabledElement)(i),{renderingEngine:r}=o;(0,L.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},this._activateModify(i),(0,Ve.hideElementCursor)(i);const o=(0,s.getEnabledElement)(i),{renderingEngine:r}=o;(0,L.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:l}=this.editData,{data:d}=i;if(o&&!l)return;i.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const{renderingEngine:c}=(0,s.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,o=(0,s.getEnabledElement)(n),{renderingEngine:r,viewport:l}=o,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h}=this.editData,{data:g}=c;g.handles.points=[d(a),d(a)],c.invalidated=!0,this.editData.hasMoved=!0,(0,L.A)(h)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a}=this.editData,{data:o}=i,{deltaPoints:r}=t,l=r.world;o.handles.points.forEach(e=>{e[0]+=l[0],e[1]+=l[1],e[2]+=l[2]}),i.invalidated=!0;const d=(0,s.getEnabledElement)(n),{renderingEngine:c}=d;(0,L.A)(a)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,i=(0,s.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:o}=i.viewport,{annotation:r}=this.editData,{data:l}=r,{points:d}=l.handles,c=d.map(e=>o(e)),{currentPoints:h}=t,g=h.canvas,u=g[0]-c[0][0],m=g[1]-c[0][1],p=g,v=[c[1][0]+u,c[1][1]+m];d[0]=a(p),d[1]=a(v)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:o}=(0,s.getEnabledElement)(e);return(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<o.length;e++){const a=o[e],{annotationUID:r,data:l}=a,{handles:d}=l,{points:c}=d;s.annotationUID=r;const{color:h,lineWidth:g,lineDash:u}=this.getAnnotationStyle({annotation:a,styleSpecifier:s}),m=c.map(e=>i.worldToCanvas(e))[0];if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ht.isAnnotationVisible)(r))continue;let p=`${r}-crosshair-vertical`,v=[m[0],m[1]+5],f=[m[0],m[1]-5];(0,D.drawLine)(t,r,p,v,f,{color:h,lineDash:u,lineWidth:g}),p=`${r}-crosshair-horizontal`,v=[m[0]+5,m[1]],f=[m[0]-5,m[1]],(0,D.drawLine)(t,r,p,v,f,{color:h,lineDash:u,lineWidth:g});const w=this.configuration.diameters.map(e=>this.worldMeasureToCanvas(e,i));for(let e=0;e<w.length;e++){const n=`${r}-circle-${e}`,i=`${r}-circle-${e}`;(0,D.drawCircle)(t,r,i,m,w[e]/2,{color:h,lineDash:u,lineWidth:g},n)}const E=e=>e*Math.PI/180,I=this.configuration.degrees.map(e=>E(e));for(let e=0;e<I.length;e++){const n=`${r}-line-${e}`,i=[Math.cos(I[e])*w[0]/2+m[0],Math.sin(I[e])*w[0]/2+m[1]],a=[Math.cos(I[e])*w[2]/2+m[0],Math.sin(I[e])*w[2]/2+m[1]];(0,D.drawLine)(t,r,n,i,a,{color:h,lineDash:u,lineWidth:g})}n=!0}return n}}worldMeasureToCanvas(e,t){const n=t.canvasToWorld([t.canvas.width/2,t.canvas.height/2]),{viewUp:i}=t.getCamera(),a=T.eR.scaleAndAdd(T.eR.create(),n,i,e),o=t.worldToCanvas(n),s=t.worldToCanvas(a);return Math.sqrt(Math.pow(s[0]-o[0],2)+Math.pow(s[1]-o[1],2))}}var mn=n(76910),pn=n(93126),vn=n(36320);const fn={resolution:20,controlPointAdditionDistance:6,controlPointDeletionDistance:6,showControlPointsConnectors:!1,controlPointAdditionEnabled:!0,controlPointDeletionEnabled:!0};var wn,En;!function(e){e.Cardinal="CARDINAL",e.Linear="LINEAR",e.CatmullRom="CATMULLROM",e.BSpline="BSPLINE"}(wn||(wn={})),function(e){e.AddControlPoint="addControlPoint",e.DeleteControlPoint="deleteControlPoint"}(En||(En={}));const In=["CatmullRomSplineROI","LinearSplineROI","BSplineROI","CardinalSplineROI"];class Cn extends vn.A{static{this.toolName="SplineROI"}static{this.SplineTypes=wn}static{this.Actions=En}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,calculateStats:!0,simplifiedSpline:!1,getTextLines:bn,contourHoleAdditionModifierKey:l.KeyboardBindings.Shift,decimate:{enabled:!1,epsilon:.1},spline:{configuration:{[wn.Cardinal]:{Class:ve,scale:.5},[wn.CatmullRom]:{Class:fe},[wn.Linear]:{Class:we},[wn.BSpline]:{Class:pe,controlPointAdditionEnabled:!1,controlPointDeletionEnabled:!1,showControlPointsConnectors:!0}},type:wn.CatmullRom,drawPreviewEnabled:!0,enableTwoPointPreview:!1,lastControlPointDeletionKeys:["Backspace","Delete"]},actions:{[En.AddControlPoint]:{method:"addControlPointCallback",bindings:[{mouseButton:l.MouseBindings.Primary,modifierKey:l.KeyboardBindings.Shift}]},[En.DeleteControlPoint]:{method:"deleteControlPointCallback",bindings:[{mouseButton:l.MouseBindings.Primary,modifierKey:l.KeyboardBindings.Ctrl}]}}}}){super(e,t),this.splineToolNames=["CatmullRomSplineROI","LinearSplineROI","BSplineROI","CardinalSplineROI"],this.isHandleOutsideImage=!1,this.fireChangeOnUpdate=null,this.isPointNearTool=(e,t,n,i)=>{const{instance:a}=t.data.spline;return a.isPointNearCurve(n,i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,L.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;let s,r=!1;if(n.worldPosition)r=!0;else{const{points:e}=o.handles;s=e.findIndex(e=>e===n)}const l=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(a),(0,L.A)(l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,contourHoleProcessingEnabled:d}=this.editData,{data:c}=i;i.autoGenerated=!1,c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const h=(0,s.getEnabledElement)(n),g=this.getTargetImageData(this.getTargetId(h.viewport)),{imageData:u,dimensions:m}=g;this.isHandleOutsideImage=c.handles.points.map(e=>s.utilities.transformWorldToIndex(u,e)).some(e=>!s.utilities.indexWithinDimensions(e,m)),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID);const p=o?l.ChangeTypes.Completed:l.ChangeTypes.HandlesUpdated;this.fireChangeOnUpdate?(this.fireChangeOnUpdate.annotationUID=i.annotationUID,this.fireChangeOnUpdate.changeType=p):this.fireChangeOnUpdate={annotationUID:i.annotationUID,changeType:p,contourHoleProcessingEnabled:d},(0,L.A)(a),this.doneEditMemo(),this.editData=null,this.isDrawing=!1},this._keyDownCallback=e=>{const t=e.detail,{element:n}=t,i=t.key??"",{lastControlPointDeletionKeys:a}=this.configuration.spline;if(!a.includes(i))return;const{annotation:o}=this.editData,{data:s}=o;if(3!==s.handles.points.length){{const e=s.handles.points.length-1;this._deleteControlPointByIndex(n,o,e)}e.preventDefault()}else this.cancel(n)},this._mouseMoveCallback=e=>{const{drawPreviewEnabled:t}=this.configuration.spline;if(!t)return;const{element:n}=e.detail,{renderingEngine:i}=(0,s.getEnabledElement)(n),a=(0,W.getViewportIdsWithToolToRender)(n,this.getToolName());this.editData.lastCanvasPoint=e.detail.currentPoints.canvas,(0,L.A)(a),e.preventDefault()},this._mouseDownCallback=e=>{const t=e.type===l.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:i}=this.editData,{data:a}=n;if(a.contour.closed)return;this.doneEditMemo();const o=e.detail,{currentPoints:s,element:r}=o,{canvas:d,world:c}=s;let h=a.handles.points.length>=2&&t,g=!0;if(a.handles.points.length&&this.createMemo(r,n,{newAnnotation:1===a.handles.points.length}),a.handles.points.length>=3){this.createMemo(r,n);const{instance:e}=a.spline,t=e.getClosestControlPointWithinDistance(d,10);0===t?.index&&(g=!1,h=!0)}g&&a.handles.points.push(c),a.contour.closed=a.contour.closed||h,n.invalidated=!0,(0,L.A)(i),a.contour.closed&&this._endCallback(e),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r,newAnnotation:l}=this.editData,{data:d}=i;if(this.createMemo(n,i,{newAnnotation:l}),r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){const{deltaPoints:e}=t,n=e.world;this.moveAnnotation(i,n)}else{const{currentPoints:e}=t,n=e.world;d.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const c=(0,s.getEnabledElement)(n),{renderingEngine:h}=c;(0,L.A)(a)},this.triggerAnnotationCompleted=(e,t)=>{const n=l.Events.ANNOTATION_COMPLETED,i={annotation:e,changeType:l.ChangeTypes.Completed,contourHoleProcessingEnabled:t};(0,s.triggerEvent)(s.eventTarget,n,i)},this.triggerAnnotationModified=(e,t,n=l.ChangeTypes.StatsUpdated)=>{const{viewportId:i,renderingEngineId:a}=t,o=l.Events.ANNOTATION_MODIFIED,r={annotation:e,viewportId:i,renderingEngineId:a,changeType:n};(0,s.triggerEvent)(s.eventTarget,o,r)},this.triggerChangeEvent=(e,t,n=l.ChangeTypes.StatsUpdated,i)=>{n===l.ChangeTypes.Completed?this.triggerAnnotationCompleted(e,i):this.triggerAnnotationModified(e,t,n)},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.KEY_DOWN,this._keyDownCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.KEY_DOWN,this._keyDownCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._renderStats=(e,t,n,i)=>{const a=e.data,o=this.getTargetId(t);if(!a.spline.instance.closed||!i.visibility)return;const s=this.configuration.getTextLines(a,o);if(!s||0===s.length)return;const r=a.handles.points.map(e=>t.worldToCanvas(e));if(!a.handles.textBox.hasMoved){const e=(0,k.getTextBoxCoordsCanvas)(r);a.handles.textBox.worldPosition=t.canvasToWorld(e)}const l=t.worldToCanvas(a.handles.textBox.worldPosition),d=(0,D.drawLinkedTextBox)(n,e.annotationUID??"","textBox",s,l,r,{},i),{x:c,y:h,width:g,height:u}=d;a.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([c,h]),topRight:t.canvasToWorld([c+g,h]),bottomLeft:t.canvasToWorld([c,h+u]),bottomRight:t.canvasToWorld([c+g,h+u])}},this.addControlPointCallback=(e,t)=>{const{data:n}=t,i=n.spline.type,a=this._getSplineConfig(i),o=a.controlPointAdditionDistance;if(!1===a.controlPointAdditionEnabled)return;const r=e.detail,{element:l}=r,d=(0,s.getEnabledElement)(l),{renderingEngine:c,viewport:h}=d,{canvasToWorld:g}=h,{instance:u}=n.spline,m=e.detail.currentPoints.canvas,p=u.getClosestPoint(m);if(p.distance>o)return;const{index:v,point:f}=u.addControlPointAtU(p.uValue);n.handles.points.splice(v,0,g(f)),t.invalidated=!0;const w=(0,W.getViewportIdsWithToolToRender)(l,this.getToolName());(0,L.A)(w)},this.deleteControlPointCallback=(e,t)=>{const n=t.data.spline.type,i=this._getSplineConfig(n),a=i.controlPointDeletionDistance;if(!1===i.controlPointDeletionEnabled)return;const o=e.detail,{element:s,currentPoints:r}=o,{canvas:l}=r,{instance:d}=t.data.spline,c=d.getClosestControlPointWithinDistance(l,a);c&&this._deleteControlPointByIndex(s,t,c.index)},this._calculateCachedStats=(e,t)=>{if(!this.configuration.calculateStats)return;const n=e.data;if(!n.contour.closed)return;const i=(0,s.getEnabledElement)(t);if(!i)return;const{viewport:a}=i,{cachedStats:o}=n,{polyline:r}=n.contour,d=Object.keys(o);for(let e=0;e<d.length;e++){const t=d[e],n=this.getTargetImageData(t);if(!n)continue;const{metadata:i}=n,l=r.map(e=>a.worldToCanvas(e)),c=l[0],h=a.canvasToWorld(c),g=a.canvasToWorld([c[0]+1,c[1]]),u=a.canvasToWorld([c[0],c[1]+1]),m=T.eR.distance(h,g),p=T.eR.distance(h,u),{imageData:v}=n,{scale:f,areaUnit:w}=(0,R.Op)(n,()=>{const{maxX:e,maxY:t,minX:n,minY:i}=N.polyline.getAABB(l),o=a.canvasToWorld([n,i]),r=s.utilities.transformWorldToIndex(v,o),d=a.canvasToWorld([e,t]);return[r,s.utilities.transformWorldToIndex(v,d)]});let E=N.polyline.getArea(l)/f/f;E*=m*p,o[t]={Modality:i.Modality,area:E,areaUnit:w}}const c=e.invalidated;return e.invalidated=!1,c&&this.triggerAnnotationModified(e,i,l.ChangeTypes.StatsUpdated),o},this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,100,{trailing:!0}),this.annotationCompletedBinded=this.annotationCompleted.bind(this)}annotationCompleted(e){const{sourceAnnotation:t}=e.detail;this.splineToolNames.includes(t?.metadata?.toolName)&&this.configuration.simplifiedSpline&&this.isContourSegmentationTool()&&(0,ee.convertContourSegmentationAnnotation)(t)}initializeListeners(){s.eventTarget.addEventListener(l.Events.ANNOTATION_COMPLETED,this.annotationCompletedBinded)}removeListeners(){s.eventTarget.removeEventListener(l.Events.ANNOTATION_COMPLETED,this.annotationCompletedBinded)}onSetToolEnabled(){this.initializeListeners()}onSetToolActive(){this.initializeListeners()}onSetToolDisabled(){this.removeListeners()}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,{canvas:a}=n,o=(0,mn.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey,s=this.createAnnotation(e);this.isDrawing=!0,this.addAnnotation(s,i);const r=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:s,viewportIdsToRender:r,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,lastCanvasPoint:a,contourHoleProcessingEnabled:o},this._activateDraw(i),e.preventDefault(),(0,L.A)(r),s}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;i&&(0,r.removeAnnotation)(t.annotationUID),super.cancelAnnotation(t);const a=(0,s.getEnabledElement)(e),{renderingEngine:o}=a;return(0,L.A)(n),this.editData=null,t.annotationUID}isContourSegmentationTool(){return!1}renderAnnotationInstance(e){const{enabledElement:t,targetId:n,svgDrawingHelper:i,annotationStyle:a}=e,{viewport:o}=t,{worldToCanvas:s}=o,{element:l}=o,d=e.annotation,{annotationUID:c,data:h,highlighted:g}=d,{handles:u}=h,{points:m,activeHandleIndex:p}=u,v=this.editData?.newAnnotation,{lineWidth:f,lineDash:w,color:E,locked:I}=a,C=m.map(e=>s(e)),{drawPreviewEnabled:b}=this.configuration.spline,_=d.data.spline.type,T=this._getSplineConfig(_),A=d.data.spline.instance,S=(0,r.getChildAnnotations)(d);if(-1!==S.findIndex(e=>!e))throw new Error(`Can't find annotation for child ${d.childAnnotationUIDs.join()}`);let M;if([d,...S].filter(e=>this._isSplineROIAnnotation(e)).forEach(e=>{const t=this._updateSplineInstance(l,e).getPolylinePoints();this.updateContourPolyline(e,{points:t,closed:h.contour.closed,targetWindingDirection:pn.W.Clockwise},o,{updateWindingDirection:h.contour.closed})}),super.renderAnnotationInstance(e),h.cachedStats[n]&&null!=h.cachedStats[n].areaUnit?d.invalidated&&this._throttledCalculateCachedStats(d,l):(h.cachedStats[n]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(d,l)),I||this.editData||null===p||(M=[C[p]]),M||v||g){const e="0";(0,D.drawHandles)(i,c,e,C,{color:E,lineWidth:f,handleRadius:"3"})}if(b&&A.numControlPoints>=1&&this.editData?.lastCanvasPoint&&!A.closed){const{lastCanvasPoint:e}=this.editData,{enableTwoPointPreview:t}=this.configuration.spline;if(1===A.numControlPoints&&t){const t=[C[0],e];(0,D.drawPolyline)(i,c,"previewSplineChange",t,{color:"#9EA0CA",lineDash:w,lineWidth:1})}else if(A.numControlPoints>1){const t=A.getPreviewPolylinePoints(e,10);(0,D.drawPolyline)(i,c,"previewSplineChange",t,{color:"#9EA0CA",lineDash:w,lineWidth:1})}}if(T.showControlPointsConnectors){const e=[...C];A.closed&&e.push(C[0]),(0,D.drawPolyline)(i,c,"controlPointsConnectors",e,{color:"rgba(255, 255, 255, 0.5)",lineWidth:1})}return this._renderStats(d,o,i,a.textbox),this.fireChangeOnUpdate?.annotationUID===c&&(this.triggerChangeEvent(d,t,this.fireChangeOnUpdate.changeType,this.fireChangeOnUpdate.contourHoleProcessingEnabled),this.fireChangeOnUpdate=null),d.invalidated=!1,!0}createInterpolatedSplineControl(e){if(e.data.handles.points?.length)return;const{polyline:t}=e.data.contour;if(!t||!t.length)return;e.data.handles.points=[];const{points:n}=e.data.handles,i=Math.max(10,Math.floor(t.length/20));for(let e=0;e<t.length-i;e+=i)n.push(t[e]);n.push(t[t.length-1])}isSplineAnnotation(e){return In.includes(e?.metadata?.toolName)}createSplineObjectFromType(e,t){const n=this._getSplineConfig(t),i=new n.Class;e.data.spline={type:n.type,instance:i,resolution:n.resolution}}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints,{type:i}=this.configuration.spline,a=this._getSplineConfig(i),o=new a.Class,r=()=>({type:a.type,instance:o,resolution:a.resolution});let l;return this.configuration.interpolation?.enabled&&(l=e=>{e.data.spline||=r(),this.createInterpolatedSplineControl(e)}),s.utilities.deepMerge(t,{data:{handles:{points:[[...n]]},spline:r(),cachedStats:{}},onInterpolationComplete:l})}_deleteControlPointByIndex(e,t,n){const i=(0,s.getEnabledElement)(e),{points:a}=t.data.handles;3===a.length?(0,r.removeAnnotation)(t.annotationUID):a.splice(n,1);const{renderingEngine:o}=i,l=(0,W.getViewportIdsWithToolToRender)(e,this.getToolName());t.invalidated=!0,(0,L.A)(l)}_isSplineROIAnnotation(e){return!!e.data?.spline}_getSplineConfig(e){const{configuration:t}=this,n=t.spline.configuration;return Object.assign({type:e},fn,n[e])}_updateSplineInstance(e,t){const n=(0,s.getEnabledElement)(e),{viewport:i}=n,{worldToCanvas:a}=i,{data:o}=t,{type:r,instance:l}=t.data.spline,d=this._getSplineConfig(r),c=o.handles.points.map(a),h=void 0!==d.resolution?parseInt(d.resolution):void 0,g=void 0!==d.scale?parseFloat(d.scale):void 0;return l.setControlPoints(c),l.closed=!!o.contour.closed,l.fixedResolution||void 0===h||l.resolution===h||(l.resolution=h,t.invalidated=!0),l instanceof ve&&!l.fixedScale&&void 0!==g&&l.scale!==g&&(l.scale=g,t.invalidated=!0),l}static{this.hydrate=(e,t,n)=>{const i=(0,s.getEnabledElementByViewportId)(e);if(!i)return;if(t.length<3)return void console.warn("Spline requires at least 3 control points");const{FrameOfReferenceUID:a,referencedImageId:o,viewPlaneNormal:l,viewUp:d,instance:c,viewport:h}=this.hydrateBase(Cn,i,t,n),g=n?.splineType||wn.CatmullRom,u=new(0,c._getSplineConfig(g).Class),{toolInstance:m,...p}=n||{},v={annotationUID:n?.annotationUID||s.utilities.uuidv4(),data:{handles:{points:t},label:"",cachedStats:{},spline:{type:g,instance:u},contour:{closed:!0}},highlighted:!1,autoGenerated:!1,invalidated:!0,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:o,...p}};(0,r.addAnnotation)(v,h.element),(0,L.A)([h.id])}}}function bn(e,t){const n=e.cachedStats[t],{area:i,isEmptyArea:a,areaUnit:o}=n,r=[];if(i){const e=a?"Area: Oblique not supported":`Area: ${s.utilities.roundNumber(i)} ${o}`;r.push(e)}return r}const _n=Cn;class Tn extends _n{static{this.toolName="SplineContourSegmentationTool"}constructor(e){super(s.utilities.deepMerge({configuration:{calculateStats:!1}},e)),this.annotationCutMergeCompletedBinded=this.annotationCutMergeCompleted.bind(this)}isContourSegmentationTool(){return!0}initializeListeners(){s.eventTarget.addEventListener(l.Events.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,this.annotationCutMergeCompletedBinded)}removeListeners(){s.eventTarget.removeEventListener(l.Events.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,this.annotationCutMergeCompletedBinded)}annotationCutMergeCompleted(e){const{sourceAnnotation:t}=e.detail;this.toolName===t?.metadata?.toolName&&this.splineToolNames.includes(t?.metadata?.toolName)&&this.configuration.simplifiedSpline&&(0,ee.convertContourSegmentationAnnotation)(t)}}n(28220);var An=n(37590),Sn=n(98013),Mn=n(78044),Dn=n(38776);class yn extends vn.A{static{this.toolName="LivewireContour"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextLines:xn,calculateStats:!0,preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:l.KeyboardBindings.Shift,snapHandleNearby:2,interpolation:{enabled:!1,nearestEdge:2,showInterpolationPolyline:!1},decimate:{enabled:!1,epsilon:.1},actions:{cancelInProgress:{method:"cancelInProgress",bindings:[{key:"Escape"}]}}}}){super(e,t),this.isHandleOutsideImage=!1,this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,r=i*i,l=t.data.contour.polyline.map(e=>o.worldToCanvas(e));let d=l[l.length-1];for(let e=0;e<l.length;e++){const t=l[e];if(N.lineSegment.distanceToPointSquared(d,t,n)<=r)return!0;d=t}return!1},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1};const o=(0,s.getEnabledElement)(i),{renderingEngine:r}=o;this._activateModify(i),(0,L.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;let r,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=o.handles;r=e.findIndex(e=>e===n)}const d=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a);const c=(0,s.getEnabledElement)(a),{renderingEngine:h}=c;(0,L.A)(d),e.preventDefault()},this._endCallback=(e,t=!1)=>{const n=e.detail,{element:i}=n,{annotation:a,viewportIdsToRender:o,newAnnotation:d,contourHoleProcessingEnabled:c}=this.editData,{data:h}=a;this.doneEditMemo(),h.handles.activeHandleIndex=null,this._deactivateModify(i),this._deactivateDraw(i),(0,Ve.resetElementCursor)(i);const g=(0,s.getEnabledElement)(i);if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage||t)return(0,r.removeAnnotation)(a.annotationUID),this.clearEditData(),void(0,L.A)(o);(0,L.A)(o);const u=d?l.ChangeTypes.Completed:l.ChangeTypes.HandlesUpdated;this.triggerChangeEvent(a,g,u,c),this.clearEditData()},this.triggerChangeEvent=(e,t,n=l.ChangeTypes.StatsUpdated,i=!1)=>{n===l.ChangeTypes.Completed?(0,ae.triggerContourAnnotationCompleted)(e,i):(0,ae.triggerAnnotationModified)(e,t.viewport.element,n)},this._mouseDownCallback=e=>{const t=e.type===l.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:i,worldToSlice:a,sliceToWorld:o,newAnnotation:r}=this.editData;if(this.editData.closed)return;const d=e.detail,{element:c}=d,{currentPoints:h}=d,{canvas:g,world:u}=h;let m=u;const p=(0,s.getEnabledElement)(c),{viewport:v,renderingEngine:f}=p,w=this.editData.currentPath.getControlPoints();let E=w.length>=2&&t;if(this.doneEditMemo(),this.createMemo(c,n,{newAnnotation:r&&1===w.length}),w.length>=2){const e={index:-1,distSquared:1/0};for(let t=0,n=w.length;t<n;t++){const n=o(w[t]),i=v.worldToCanvas(n),a=N.point.distanceToPointSquared(g,i);a<=100&&a<e.distSquared&&(e.distSquared=a,e.index=t)}0===e.index&&(E=!0)}const{snapHandleNearby:I}=this.configuration;if(I&&!this.editData.closed){const e=new Dn.j,t=this.scissors.findMinNearby(a(u),1),n=this.scissors.findPathToPoint(t);e.addPoints(n),e.prependPath(this.editData.confirmedPath),m=o(t),this.editData.currentPath=e}this.editData.closed=this.editData.closed||E,this.editData.confirmedPath=this.editData.currentPath;const C=this.editData.currentPath.getLastPoint();this.editData.confirmedPath.addControlPoint(C),n.data.handles.points.push(o(C)),this.scissors.startSearch(a(m)),n.invalidated=!0,(0,L.A)(i),this.editData.closed&&(this.updateAnnotation(this.editData.confirmedPath),this._endCallback(e)),e.preventDefault()},this._mouseMoveCallback=e=>{const{element:t,currentPoints:n}=e.detail,{world:i,canvas:a}=n,{renderingEngine:o}=(0,s.getEnabledElement)(t),r=(0,W.getViewportIdsWithToolToRender)(t,this.getToolName());this.editData.lastCanvasPoint=a;const{width:l,height:d}=this.scissors,{worldToSlice:c}=this.editData,h=c(i);if(h[0]<0||h[1]<0||h[0]>=l||h[1]>=d)return;const g=this.scissors.findPathToPoint(h),u=new Dn.j;u.addPoints(g),u.prependPath(this.editData.confirmedPath),this.editData.currentPath=u,(0,L.A)(r),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,movingTextBox:o,handleIndex:r,newAnnotation:l}=this.editData;this.createMemo(n,i,{newAnnotation:l});const{data:d}=i;if(o){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===r)console.warn("Drag annotation not implemented");else{const{currentPoints:e}=t,a=e.world;this.editHandle(a,n,i,r)}this.editData.hasMoved=!0;const c=(0,s.getEnabledElement)(n),{renderingEngine:h}=c;(0,L.A)(a)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;return i&&(0,r.removeAnnotation)(t.annotationUID),(0,L.A)(n),this.doneEditMemo(),this.scissors=null,t.annotationUID},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._calculateCachedStats=(e,t)=>{if(!this.configuration.calculateStats)return;const n=e.data;if(!n.contour.closed)return;const i=(0,s.getEnabledElement)(t),{viewport:a,renderingEngine:o}=i,{cachedStats:r}=n,{polyline:d}=n.contour,c=Object.keys(r);for(let e=0;e<c.length;e++){const t=c[e],n=this.getTargetImageData(t);if(!n)continue;const{metadata:i}=n,o=d.map(e=>a.worldToCanvas(e)),l=o[0],h=a.canvasToWorld(l),g=a.canvasToWorld([l[0]+1,l[1]]),u=a.canvasToWorld([l[0],l[1]+1]),m=T.eR.distance(h,g),p=T.eR.distance(h,u),{imageData:v}=n,{scale:f,areaUnit:w}=(0,R.Op)(n,()=>{const{maxX:e,maxY:t,minX:n,minY:i}=N.polyline.getAABB(o),r=a.canvasToWorld([n,i]),l=s.utilities.transformWorldToIndex(v,r),d=a.canvasToWorld([e,t]);return[l,s.utilities.transformWorldToIndex(v,d)]});let E=N.polyline.getArea(o)/f/f;E*=m*p,r[t]={Modality:i.Modality,area:E,areaUnit:w}}const h=e.invalidated;return e.invalidated=!1,h&&this.triggerAnnotationModified(e,i,l.ChangeTypes.StatsUpdated),r},this._renderStats=(e,t,n,i)=>{const a=e.data,o=this.getTargetId(t);if(!a.contour.closed||!i.visibility)return;const s=this.configuration.getTextLines(a,o);if(!s||0===s.length)return;const r=a.handles.points.map(e=>t.worldToCanvas(e));if(!a.handles.textBox.hasMoved){const e=(0,k.getTextBoxCoordsCanvas)(r);a.handles.textBox.worldPosition=t.canvasToWorld(e)}const l=t.worldToCanvas(a.handles.textBox.worldPosition),d=(0,D.drawLinkedTextBox)(n,e.annotationUID??"","textBox",s,l,r,{},i),{x:c,y:h,width:g,height:u}=d;a.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([c,h]),topRight:t.canvasToWorld([c+g,h]),bottomLeft:t.canvasToWorld([c,h+u]),bottomRight:t.canvasToWorld([c+g,h+u])}},this.triggerAnnotationModified=(e,t,n=l.ChangeTypes.StatsUpdated)=>{const{viewportId:i,renderingEngineId:a}=t,o=l.Events.ANNOTATION_MODIFIED,r={annotation:e,viewportId:i,renderingEngineId:a,changeType:n};(0,s.triggerEvent)(s.eventTarget,o,r)},this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,100,{trailing:!0})}setupBaseEditData(e,t,n,i,a){const o=(0,s.getEnabledElement)(t),{viewport:r}=o;this.isDrawing=!0;const l=r.getImageData(),{imageData:d}=l;let c,h,g,u,m;if(r instanceof s.VolumeViewport){if(!(r instanceof s.VolumeViewport))throw new Error("Viewport not supported");{const e=s.utilities.getCurrentVolumeViewportSlice(r),{sliceToIndexMatrix:t,indexToSliceMatrix:n}=e;c=e=>{const t=s.utilities.transformWorldToIndex(d,e),i=T.eR.transformMat4([0,0,0],t,n);return[i[0],i[1]]},h=e=>{const n=T.eR.transformMat4([0,0,0],[e[0],e[1],0],t);return s.utilities.transformIndexToWorld(d,n)},m=e.scalarData,g=e.width,u=e.height}}else g=l.dimensions[0],u=l.dimensions[1],c=e=>{const t=s.utilities.transformWorldToIndex(d,e);return[t[0],t[1]]},h=e=>s.utilities.transformIndexToWorld(d,[e[0],e[1],0]),m=l.scalarData;m=s.utilities.convertToGrayscale(m,g,u);const{voiRange:p}=r.getProperties(),v=c(e);this.scissors=Mn.f.createInstanceFromRawPixelData(m,g,u,p),i&&(this.scissorsNext=Mn.f.createInstanceFromRawPixelData(m,g,u,p),this.scissorsNext.startSearch(c(i))),this.scissors.startSearch(v);const f=!i,w=new Dn.j,E=new Dn.j,I=f?void 0:new Dn.j;w.addPoint(v),w.addControlPoint(v);const C=(0,W.getViewportIdsWithToolToRender)(t,this.getToolName()),b=r.worldToCanvas(e);this.editData={annotation:n,viewportIdsToRender:C,newAnnotation:f,hasMoved:!1,lastCanvasPoint:b,confirmedPath:w,currentPath:E,confirmedPathNext:I,closed:!1,handleIndex:this.editData?.handleIndex??n.handles?.activeHandleIndex,worldToSlice:c,sliceToWorld:h,contourHoleProcessingEnabled:a}}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,{world:a}=n,o=this.createAnnotation(e),s=(0,mn.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey;return this.setupBaseEditData(a,i,o,void 0,s),this.addAnnotation(o,i),this._activateDraw(i),e.preventDefault(),(0,L.A)(this.editData.viewportIdsToRender),o}clearEditData(){this.editData=null,this.scissors=null,this.scissorsNext=null,this.isDrawing=!1}editHandle(e,t,n,i){const{data:a}=n,{points:o}=a.handles,{length:s}=o,r=o[(i-1+s)%s],l=o[(i+1)%s];if(!this.editData?.confirmedPathNext){this.setupBaseEditData(r,t,n,l);const{polyline:e}=a.contour,o=new Dn.j,s=new Dn.j,{worldToSlice:d}=this.editData,c=(0,Sn.A)(n,i-1),h=(0,Sn.A)(n,i+1);if(-1===h||-1===c)throw new Error(`Can't find handle index ${-1===h&&l} ${-1===c&&r}`);0===i?s.addPoints(e.slice(h+1,c).map(d)):(o.addPoints(e.slice(0,c+1).map(d)),s.addPoints(e.slice(h,e.length).map(d))),this.editData.confirmedPath=o,this.editData.confirmedPathNext=s}const{editData:d,scissors:c}=this,{worldToSlice:h,sliceToWorld:g}=d,{activeHandleIndex:u}=a.handles;if(null==u)a.handles.activeHandleIndex=i;else if(u!==i)throw new Error(`Trying to edit a different handle than the one currently being edited ${i}!==${a.handles.activeHandleIndex}`);const m=h(e);if(m[0]<0||m[0]>=c.width||m[1]<0||m[1]>=c.height)return;o[i]=g(m);const p=c.findPathToPoint(m),v=this.scissorsNext.findPathToPoint(m),f=new Dn.j;f.prependPath(d.confirmedPath),0!==i&&f.addPoints(p),f.addPoints(v.reverse()),f.appendPath(d.confirmedPathNext),0===i&&f.addPoints(p),d.currentPath=f,n.invalidated=!0,d.hasMoved=!0,d.closed=!0}renderAnnotation(e,t){return this.updateAnnotation(this.editData?.currentPath),super.renderAnnotation(e,t)}isContourSegmentationTool(){return!1}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints;return s.utilities.deepMerge(t,{data:{handles:{points:[[...n]]}}})}cancelInProgress(e,t,n){this.editData?this._endCallback(n,!0):this.undo()}renderAnnotationInstance(e){const{annotation:t,enabledElement:n,svgDrawingHelper:i,annotationStyle:a,targetId:o}=e,{viewport:s}=n,{element:r}=s,{worldToCanvas:l}=s,{annotationUID:d,data:c,highlighted:h}=t,{handles:g}=c,u=this.editData?.newAnnotation,{lineWidth:m,lineDash:p,color:v}=a;if(h||u&&t.annotationUID===this.editData?.annotation?.annotationUID){const e="0",t=g.points.map(l);(0,D.drawHandles)(i,d,e,t,{color:v,lineDash:p,lineWidth:m})}return super.renderAnnotationInstance(e),c.cachedStats[o]&&null!==c.cachedStats[o]?.areaUnit?t.invalidated&&this._throttledCalculateCachedStats(t,r):(c.cachedStats[o]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(t,r)),this._renderStats(t,s,i,a.textbox),!0}updateAnnotation(e){if(!this.editData||!e)return;const{annotation:t,sliceToWorld:n,worldToSlice:i,closed:a,newAnnotation:o}=this.editData;let{pointArray:s}=e;s.length>1&&(s=[...s,s[0]]);const r=o&&a?pn.W.Clockwise:void 0;this.updateContourPolyline(t,{points:s,closed:a,targetWindingDirection:r},{canvasToWorld:n,worldToCanvas:i})}}const Pn=yn;function xn(e,t){const n=e.cachedStats[t],{area:i,areaUnit:a}=n,o=[];if(i){const e=`Area: ${s.utilities.roundNumber(i)} ${a}`;o.push(e)}return o}class Rn extends Pn{static{this.toolName="LivewireContourSegmentationTool"}updateInterpolatedAnnotation(e,t){!this.editData&&e.invalidated&&e.data.handles.interpolationSources&&(e.data.contour.originalPolyline=e.data.contour.polyline,queueMicrotask(()=>{if(!e.data.handles.interpolationSources)return;const{points:n}=e.data.handles,{element:i}=t.viewport;this.setupBaseEditData(n[0],i,e);const{length:a}=n,{scissors:o}=this,{nearestEdge:r,repeatInterpolation:d}=this.configuration.interpolation;e.data.handles.originalPoints=n;const{worldToSlice:c,sliceToWorld:h}=this.editData,g=[];if(r){let e=c(n[n.length-1]);n.forEach((t,i)=>{const a=c(t);e=a,g.push(a),o.startSearch(e),o.findPathToPoint(a),o.findPathToPoint(c(n[(i+3)%n.length]));const l=o.findMinNearby(a,r);s.utilities.isEqual(a,l)||(g[i]=l,e=l,n[i]=h(l))})}const u=new Dn.j;for(let e=0;e<a;e++){o.startSearch(c(n[e]));const t=o.findPathToPoint(c(n[(e+1)%a]));u.addPoints(t)}this.updateAnnotation(u),this.scissors=null,this.scissorsNext=null,this.editData=null,e.data.handles.interpolationSources=null,d&&(0,ae.triggerAnnotationModified)(e,t.viewport.element,l.ChangeTypes.InterpolationUpdated)}))}renderAnnotationInstance(e){const{enabledElement:t,svgDrawingHelper:n}=e,i=e.annotation,{annotationUID:a}=i,{viewport:o}=t,{worldToCanvas:s}=o,{showInterpolationPolyline:r}=this.configuration.interpolation||{};this.updateInterpolatedAnnotation?.(i,t);const{originalPolyline:l}=i.data.contour,d=super.renderAnnotationInstance(e);if(r&&l&&i.autoGenerated){const e=l.map(s);e.push(e[0]),(0,D.drawPolyline)(n,a,"interpolationContour-0",e,{color:"#70ffff",lineWidth:1,fillOpacity:0})}return d}isContourSegmentationTool(){return!0}}class Ln extends Ee.EC{static{this.toolName="ArrowAnnotate"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:On,changeTextCallback:Un,preventHandleOutsideImage:!1,arrowFirst:!0,arrowHeadStyle:"legacy"}}){super(e,t),this.addNewAnnotation=e=>{this.startGroupRecording();const t=e.detail,{currentPoints:n,element:i}=t,a=n.world;(0,Ve.hideElementCursor)(i),this.isDrawing=!0;const{arrowFirst:o}=this.configuration,s=this.createAnnotation(e,[[...a],[...a]],{data:{handles:{arrowFirst:o}}});(0,r.addAnnotation)(s,i);const l=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:s,viewportIdsToRender:l,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,L.A)(l),s},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,[l,d]=r.handles.points,c=o.worldToCanvas(l),h=o.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return re.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,Ve.hideElementCursor)(i);const o=(0,s.getEnabledElement)(i),{renderingEngine:r}=o;(0,L.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:s,movingTextBox:d}=this.editData,{data:c}=i;o&&!s||(c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),o?this.configuration.getTextCallback(e=>{if(!e)return(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),this.editData=null,void(this.isDrawing=!1);i.data.label=e,(0,ae.triggerAnnotationModified)(i,n,l.ChangeTypes.HandlesUpdated),(0,ae.triggerAnnotationCompleted)(i),this.createMemo(n,i,{newAnnotation:!!this.memo}),oe(i,n,e),this.endGroupRecording(),this.doneEditMemo(),(0,L.A)(a)}):d||(0,ae.triggerAnnotationModified)(i,n,l.ChangeTypes.HandlesUpdated),this.doneEditMemo(),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:s,newAnnotation:r}=this.editData;this.createMemo(n,i,{newAnnotation:r});const{data:d}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;d.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0,(0,L.A)(a),i.invalidated&&(0,ae.triggerAnnotationModified)(i,n,l.ChangeTypes.HandlesUpdated)},this.touchTapCallback=e=>{2==e.detail.taps&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=(0,r.getAnnotations)(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const a=i.find(e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6));if(!a)return;const o=a;this.configuration.changeTextCallback(a,e.detail,this._doneChangingTextCallback.bind(this,n,o)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<o.length;e++){const a=o[e],{annotationUID:r,data:l}=a,{handles:d,label:c}=l,{points:h,activeHandleIndex:g}=d;s.annotationUID=r;const{color:u,lineWidth:m,lineDash:p,markerSize:v}=this.getAnnotationStyle({annotation:a,styleSpecifier:s}),f=h.map(e=>i.worldToCanvas(e));let w;if((0,Be.isAnnotationLocked)(r)||this.editData||null===g||(w=[f[g]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ht.isAnnotationVisible)(r))continue;const E=Boolean((0,Rt.h)("showHandlesAlways",{}));if(w||E){const e="0";(0,D.drawHandles)(t,r,e,f,{color:u,lineWidth:m})}const I="1";if(this.configuration.arrowFirst?(0,D.drawArrow)(t,r,I,f[1],f[0],{color:u,width:m,lineDash:p,viaMarker:"legacy"!==this.configuration.arrowHeadStyle,markerSize:v}):(0,D.drawArrow)(t,r,I,f[0],f[1],{color:u,width:m,lineDash:p,viaMarker:"legacy"!==this.configuration.arrowHeadStyle,markerSize:v}),n=!0,!c)continue;const C=this.getLinkedTextBoxStyle(s,a);if(!C.visibility){l.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}if(!l.handles.textBox.hasMoved){const e=f[1];l.handles.textBox.worldPosition=i.canvasToWorld(e)}const b=i.worldToCanvas(l.handles.textBox.worldPosition),_="1",T=(0,D.drawLinkedTextBox)(t,r,_,[c],b,f,{},C),{x:A,y:S,width:M,height:y}=T;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([A,S]),topRight:i.canvasToWorld([A+M,S]),bottomLeft:i.canvasToWorld([A,S+y]),bottomRight:i.canvasToWorld([A+M,S+y])}}return n}}static{this.hydrate=(e,t,n,i)=>{const a=(0,s.getEnabledElementByViewportId)(e);if(!a)return;const{FrameOfReferenceUID:o,referencedImageId:l,viewPlaneNormal:d,instance:c,viewport:h}=this.hydrateBase(Ln,a,t,i),{toolInstance:g,...u}=i||{},m=this.createAnnotation({annotationUID:i?.annotationUID||s.utilities.uuidv4(),data:{label:n||"",handles:{points:t}},autoGenerated:!1,metadata:{toolName:c.getToolName(),viewPlaneNormal:d,FrameOfReferenceUID:o,referencedImageId:l,...u}});(0,r.addAnnotation)(m,h.element),(0,L.A)([h.id])}}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=o.handles.points.findIndex(e=>e===n);const d=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,Ve.hideElementCursor)(a);const c=(0,s.getEnabledElement)(a),{renderingEngine:h}=c;(0,L.A)(d),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.label=n;const i=(0,W.getViewportIdsWithToolToRender)(e,this.getToolName());(0,L.A)(i),(0,ae.triggerAnnotationModified)(t,e)}_isInsideVolume(e,t,n){return s.utilities.indexWithinDimensions(e,n)&&s.utilities.indexWithinDimensions(t,n)}}function On(e){return e(prompt("Enter your annotation:"))}function Un(e,t,n){return n(prompt("Enter your annotation:"))}class kn extends Ee.EC{static{this.toolName="Angle"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,showAngleArc:!1,arcOffset:5,preventHandleOutsideImage:!1,getTextLines:Nn}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world;(0,Ve.hideElementCursor)(i),this.isDrawing=!0;const o=this.createAnnotation(e,[[...a],[...a]]);(0,r.addAnnotation)(o,i);const s=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:o,viewportIdsToRender:s,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,L.A)(s),o},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,[l,d,c]=r.handles.points,h=o.worldToCanvas(l),g=o.worldToCanvas(d),u={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};if(re.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=i)return!0;if(!c)return!1;const m=o.worldToCanvas(c),p={start:{x:g[0],y:g[1]},end:{x:m[0],y:m[1]}};return re.distanceToPoint([p.start.x,p.start.y],[p.end.x,p.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,Ve.hideElementCursor)(i);const o=(0,s.getEnabledElement)(i),{renderingEngine:r}=o;(0,L.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:l}=this.editData,{data:d}=i;if(o&&!l)return;if(this.angleStartedNotYetCompleted&&2===d.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const c=(0,s.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),this.doneEditMemo(),o&&(0,ae.triggerAnnotationCompleted)(i),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r,newAnnotation:d}=this.editData,{data:c}=i;if(this.createMemo(n,i,{newAnnotation:d}),r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=c.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){const{deltaPoints:e}=t,n=e.world;c.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;c.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const h=(0,s.getEnabledElement)(n),{renderingEngine:g}=h;(0,L.A)(a),i.invalidated&&(0,ae.triggerAnnotationModified)(i,n,l.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){const r=o[a],{annotationUID:c,data:h}=r,{points:g,activeHandleIndex:u}=h.handles;d.annotationUID=c;const{color:m,lineWidth:p,lineDash:v,angleArcLineDash:f}=this.getAnnotationStyle({annotation:r,styleSpecifier:d}),w=g.map(e=>i.worldToCanvas(e));let E;if(h.cachedStats[s]&&null!=h.cachedStats[s].angle?r.invalidated&&this._throttledCalculateCachedStats(r,l,e):(h.cachedStats[s]={angle:null},this._calculateCachedStats(r,l,e)),(0,Be.isAnnotationLocked)(r.annotationUID)||this.editData||null===u||(E=[w[u]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ht.isAnnotationVisible)(c))continue;const I=Boolean((0,Rt.h)("showHandlesAlways",{}));if(E||I){const e="0";(0,D.drawHandles)(t,c,e,w,{color:m,lineDash:v,lineWidth:p})}let C="1";if((0,D.drawLine)(t,c,C,w[0],w[1],{color:m,width:p,lineDash:v}),n=!0,3!==w.length)return n;if(C="2",(0,D.drawLine)(t,c,C,w[1],w[2],{color:m,width:p,lineDash:v}),this.configuration.showAngleArc){const e=w[1],n=this.configuration.arcOffset,i=Math.min(re.distanceToPoint([e[0],e[1]],[w[0][0],w[0][1]],[w[2][0],w[2][1]]),re.distanceToPoint([e[0],e[1]],[w[2][0],w[2][1]],[w[0][0],w[0][1]]))/n,a=[];let o=Math.atan2(w[0][1]-e[1],w[0][0]-e[0]),s=Math.atan2(w[2][1]-e[1],w[2][0]-e[0]);s<o&&(s+=2*Math.PI);if(s-o>Math.PI){const e=o;o=s,s=e+2*Math.PI}const r=32;for(let t=0;t<=r;t++){const n=o+t/r*(s-o);a.push([e[0]+i*Math.cos(n),e[1]+i*Math.sin(n)])}(0,D.drawPath)(t,c,"3",a,{color:m,width:p,lineDash:f})}if(!h.cachedStats[s]?.angle)continue;const b=this.getLinkedTextBoxStyle(d,r);if(!b.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const _=this.configuration.getTextLines(h,s);if(!h.handles.textBox.hasMoved){const e=w[1];h.handles.textBox.worldPosition=i.canvasToWorld(e)}const T=i.worldToCanvas(h.handles.textBox.worldPosition),A="1",S=(0,D.drawLinkedTextBox)(t,c,A,_,T,w,{},b),{x:M,y,width:P,height:x}=S;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([M,y]),topRight:i.canvasToWorld([M+P,y]),bottomLeft:i.canvasToWorld([M,y+x]),bottomRight:i.canvasToWorld([M+P,y+x])}}return n},this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,100,{trailing:!0})}static{this.hydrate=(e,t,n)=>{const i=(0,s.getEnabledElementByViewportId)(e);if(!i)return;const{FrameOfReferenceUID:a,referencedImageId:o,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase(kn,i,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||s.utilities.uuidv4(),data:{handles:{points:t}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:o,...g}};(0,r.addAnnotation)(u,c.element),(0,L.A)([c.id])}}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=o.handles.points.findIndex(e=>e===n);const d=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,Ve.hideElementCursor)(a);const c=(0,s.getEnabledElement)(a),{renderingEngine:h}=c;(0,L.A)(d),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{element:a}=n.viewport;if(3!==i.handles.points.length)return;const o=i.handles.points[0],r=i.handles.points[1],d=i.handles.points[2],{cachedStats:c}=i,h=Object.keys(c);for(let e=0;e<h.length;e++){const t=h[e],n=(0,je.A)([o,r],[r,d]),{dimensions:i,imageData:a}=this.getTargetImageData(t);this.isHandleOutsideImage=[o,r,d].map(e=>s.utilities.transformWorldToIndex(a,e)).some(e=>!s.utilities.indexWithinDimensions(e,i)),c[t]={angle:isNaN(n)?"Incomplete Angle":n}}const g=e.invalidated;return e.invalidated=!1,g&&(0,ae.triggerAnnotationModified)(e,a,l.ChangeTypes.StatsUpdated),c}}function Nn(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;if(isNaN(i))return[`${i}`];return[`${s.utilities.roundNumber(i)} ${String.fromCharCode(176)}`]}var Vn=n(82983);class Wn extends Ee.EC{static{this.toolName="CobbAngle"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Bn,showArcLines:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world;(0,Ve.hideElementCursor)(i),this.isDrawing=!0;const o=this.createAnnotation(e,[[...a],[...a]]);(0,r.addAnnotation)(o,i);const s=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:o,viewportIdsToRender:s,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,L.A)(s),o},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,{distanceToPoint:l,distanceToPoint2:d}=this.distanceToLines({viewport:o,points:r.handles.points,canvasCoords:n,proximity:i});return l<=i||d<=i},this.toolSelectedCallback=(e,t,n,i,a=6)=>{const o=e.detail,{element:r}=o;t.highlighted=!0;const l=(0,W.getViewportIdsWithToolToRender)(r,this.getToolName()),d=(0,s.getEnabledElement)(r),{renderingEngine:c,viewport:h}=d,{isNearFirstLine:g,isNearSecondLine:u}=this.distanceToLines({viewport:h,points:t.data.handles.points,canvasCoords:i,proximity:a});this.editData={annotation:t,viewportIdsToRender:l,movingTextBox:!1,isNearFirstLine:g,isNearSecondLine:u},this._activateModify(r),(0,Ve.hideElementCursor)(r),(0,L.A)(l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:l}=this.editData,{data:d}=i;if(o&&!l)return;if(this.doneEditMemo(),this.angleStartedNotYetCompleted&&d.handles.points.length<4)return(0,Ve.resetElementCursor)(n),void(this.editData.handleIndex=d.handles.points.length);this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const c=(0,s.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i),this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const{annotation:t,handleIndex:n}=this.editData,i=e.detail,{element:a,currentPoints:o}=i,s=o.world,{data:r}=t;return 1===n?(r.handles.points[1]=s,void(this.editData.hasMoved=r.handles.points[1][0]!==r.handles.points[0][0]||r.handles.points[1][1]!==r.handles.points[0][0])):3===n?(r.handles.points[3]=s,this.editData.hasMoved=r.handles.points[3][0]!==r.handles.points[2][0]||r.handles.points[3][1]!==r.handles.points[2][0],void(this.angleStartedNotYetCompleted=!1)):(this.editData.hasMoved=!1,(0,Ve.hideElementCursor)(a),r.handles.points[2]=r.handles.points[3]=s,void(this.editData.handleIndex=r.handles.points.length-1))},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r,isNearFirstLine:d,isNearSecondLine:c,newAnnotation:h}=this.editData;this.createMemo(n,i,{newAnnotation:h});const{data:g}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=g.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o&&(d||c)){const{deltaPoints:e}=t,n=e.world,a=g.handles.points;if(d){[a[0],a[1]].forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})}else if(c){[a[2],a[3]].forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})}i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;g.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const u=(0,s.getEnabledElement)(n),{renderingEngine:m}=u;(0,L.A)(a),i.invalidated&&(0,ae.triggerAnnotationModified)(i,n,l.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;a.handles.points.length<4&&(0,r.removeAnnotation)(t.annotationUID),t.highlighted=!1,a.handles.activeHandleIndex=null;const o=(0,s.getEnabledElement)(e),{renderingEngine:l}=o;return(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_START,this._mouseDownCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_START,this._mouseDownCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_START,this._mouseDownCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_START,this._mouseDownCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){const r=o[a],{annotationUID:c,data:h}=r,{points:g,activeHandleIndex:u}=h.handles;d.annotationUID=c;const{color:m,lineWidth:p,lineDash:v}=this.getAnnotationStyle({annotation:r,styleSpecifier:d}),f=g.map(e=>i.worldToCanvas(e));let w;if(h.cachedStats[s]&&null!=h.cachedStats[s].angle?r.invalidated&&this._throttledCalculateCachedStats(r,l,e):(h.cachedStats[s]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},this._calculateCachedStats(r,l,e)),(0,Be.isAnnotationLocked)(c)||this.editData||null===u||(w=[f[u]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,ht.isAnnotationVisible)(c))continue;const E=Boolean((0,Rt.h)("showHandlesAlways",{}));if(w||E){const e="0";(0,D.drawHandles)(t,c,e,f,{color:m,lineDash:v,lineWidth:p})}const I=[f[0],f[1]],C=[f[2],f[3]];let b="line1";if((0,D.drawLine)(t,c,b,I[0],I[1],{color:m,width:p,lineDash:v}),n=!0,f.length<4)return n;b="line2",(0,D.drawLine)(t,c,b,C[0],C[1],{color:m,width:p,lineDash:v}),b="linkLine";const _=(0,Vn.f)(I[0],I[1]),T=(0,Vn.f)(C[0],C[1]);(0,D.drawLine)(t,c,b,_,T,{color:m,lineWidth:"1",lineDash:"1,4"});const{arc1Start:A,arc1End:S,arc2End:M,arc2Start:y}=h.cachedStats[s].points.canvas,{arc1Angle:P,arc2Angle:x}=h.cachedStats[s];if(this.configuration.showArcLines&&(b="arc1",(0,D.drawLine)(t,c,b,A,S,{color:m,lineWidth:"1"}),b="arc2",(0,D.drawLine)(t,c,b,y,M,{color:m,lineWidth:"1"})),!h.cachedStats[s]?.angle)continue;const R=this.getLinkedTextBoxStyle(d,r);if(!R.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const L=this.configuration.getTextLines(h,s);if(!h.handles.textBox.hasMoved){const e=(0,k.getTextBoxCoordsCanvas)(f);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const O=i.worldToCanvas(h.handles.textBox.worldPosition),U="cobbAngleText",N=(0,D.drawLinkedTextBox)(t,c,U,L,O,f,{},R),{x:V,y:W,width:B,height:H}=N;if(h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([V,W]),topRight:i.canvasToWorld([V+B,W]),bottomLeft:i.canvasToWorld([V,W+H]),bottomRight:i.canvasToWorld([V+B,W+H])},this.configuration.showArcLines){const e="arcAngle1",n=[`${P.toFixed(2)} ${String.fromCharCode(176)}`],i=(0,Vn.f)(A,S);(0,D.drawTextBox)(t,c,e,n,i,{...R,padding:3});const a="arcAngle2",o=[`${x.toFixed(2)} ${String.fromCharCode(176)}`],s=(0,Vn.f)(y,M);(0,D.drawTextBox)(t,c,a,o,s,{...R,padding:3})}}return n},this.distanceToLines=({viewport:e,points:t,canvasCoords:n,proximity:i})=>{const[a,o,s,r]=t,l=e.worldToCanvas(a),d=e.worldToCanvas(o),c=e.worldToCanvas(s),h=e.worldToCanvas(r),g={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},u={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}},m=re.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]]),p=re.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]]);let v=!1,f=!1;return m<=i?v=!0:p<=i&&(f=!0),{distanceToPoint:m,distanceToPoint2:p,isNearFirstLine:v,isNearSecondLine:f}},this.getArcsStartEndPoints=({firstLine:e,secondLine:t,mid1:n,mid2:i})=>{const a=[n,i],o=(0,je.A)(e,a),s=(0,je.A)(t,a),r=o>90?1:0,l=s>90?0:1,d=(0,Vn.f)(a[0],a[1]),c=Math.sqrt((a[1][0]-a[0][0])**2+(a[1][1]-a[0][1])**2),h=.1,g=(0,Vn.f)(e[0],e[1]),u=(0,Vn.f)(t[0],t[1]),m=[e[r][0]-g[0],e[r][1]-g[1]],p=Math.sqrt(m[0]**2+m[1]**2),v=[m[0]/p,m[1]/p],f=[g[0]+v[0]*c*h,g[1]+v[1]*c*h],w=[d[0]-n[0],d[1]-n[1]],E=Math.sqrt(w[0]**2+w[1]**2),I=[w[0]/E,w[1]/E],C=[n[0]+I[0]*c*h,n[1]+I[1]*c*h],b=[t[l][0]-u[0],t[l][1]-u[1]],_=Math.sqrt(b[0]**2+b[1]**2),T=[b[0]/_,b[1]/_],A=[u[0]+T[0]*c*h,u[1]+T[1]*c*h],S=[d[0]-i[0],d[1]-i[1]],M=Math.sqrt(S[0]**2+S[1]**2),D=[S[0]/M,S[1]/M];return{arc1Start:f,arc1End:C,arc2Start:A,arc2End:[i[0]+D[0]*c*h,i[1]+D[1]*c*h],arc1Angle:o>90?180-o:o,arc2Angle:s>90?180-s:s}},this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,25,{trailing:!0})}handleSelectedCallback(e,t,n,i="mouse"){const a=e.detail,{element:o}=a,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,W.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(o),(0,Ve.hideElementCursor)(o),(0,L.A)(d),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data;if(4!==i.handles.points.length)return;const a=[null,null],o=[null,null];let s=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){const n=T.eR.distance(i.handles.points[e],i.handles.points[t]);n<s&&(s=n,a[1]=i.handles.points[e],a[0]=i.handles.points[(e+1)%2],o[0]=i.handles.points[t],o[1]=i.handles.points[2+(t-1)%2])}const{viewport:r}=n,{element:d}=r,c=i.handles.points.map(e=>r.worldToCanvas(e)),h=[c[0],c[1]],g=[c[2],c[3]],u=(0,Vn.f)(h[0],h[1]),m=(0,Vn.f)(g[0],g[1]),{arc1Start:p,arc1End:v,arc2End:f,arc2Start:w,arc1Angle:E,arc2Angle:I}=this.getArcsStartEndPoints({firstLine:h,secondLine:g,mid1:u,mid2:m}),{cachedStats:C}=i,b=Object.keys(C);for(let e=0;e<b.length;e++){C[b[e]]={angle:(0,je.A)(a,o),arc1Angle:E,arc2Angle:I,points:{canvas:{arc1Start:p,arc1End:v,arc2End:f,arc2Start:w},world:{arc1Start:r.canvasToWorld(p),arc1End:r.canvasToWorld(v),arc2End:r.canvasToWorld(f),arc2Start:r.canvasToWorld(w)}}}}const _=e.invalidated;return e.invalidated=!1,_&&(0,ae.triggerAnnotationModified)(e,d,l.ChangeTypes.StatsUpdated),C}}function Bn(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;return[`${i.toFixed(2)} ${String.fromCharCode(176)}`]}const{transformWorldToIndex:Hn}=s.utilities;class Gn extends Ee.EC{static{this.toolName="UltrasoundDirectionalTool"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Fn,displayBothAxesDistances:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.startedDrawing)return;this.startedDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:l}=o;if(!(l instanceof s.StackViewport))throw new Error("UltrasoundDirectionalTool can only be used on a StackViewport");(0,Ve.hideElementCursor)(i),this.isDrawing=!0;const d=this.createAnnotation(e,[[...a],[...a]]);(0,r.addAnnotation)(d,i);const c=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:d,viewportIdsToRender:c,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,L.A)(c),d},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,[l,d]=r.handles.points,c=o.worldToCanvas(l),h=o.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return N.lineSegment.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=i},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:l}=this.editData,{data:d}=i;if(o&&!l)return;if(this.startedDrawing&&1===d.handles.points.length)return void(this.editData.handleIndex=1);this.startedDrawing=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const c=(0,s.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,s.getEnabledElement)(n),{renderingEngine:c}=d;(0,L.A)(a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,this.startedDrawing=!1,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){const r=o[a],{annotationUID:c,data:h}=r,{points:g}=h.handles;d.annotationUID=c;const u=this.getStyle("color",d,r),m=g.map(e=>i.worldToCanvas(e));if(h.cachedStats[s]&&null!=h.cachedStats[s].xValues?r.invalidated&&this._throttledCalculateCachedStats(r,l,e):(h.cachedStats[s]={xValues:[0,0],yValues:[0,0],isHorizontal:!1,units:[""],isUnitless:!1},this._calculateCachedStats(r,l,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let p="0";if((0,D.drawHandle)(t,c,p,m[0],{color:u},0),n=!0,2!==m.length)return n;p="1",(0,D.drawHandle)(t,c,p,m[1],{color:u},1);if(h.cachedStats[s].isUnitless){const e=`${c}-line-1`,n="1";(0,D.drawLine)(t,c,n,m[0],m[1],{color:u,width:1,shadow:this.configuration.shadow},e)}else{const e=m[0],n=m[1],i=n[1]-e[1],a=n[0]-e[0];let o=[0,0];o=h.cachedStats[s].isHorizontal?[e[0]+a,e[1]]:[e[0],e[1]+i];let r=`${c}-line-1`,l="1";(0,D.drawLine)(t,c,l,m[0],o,{color:u,width:1,shadow:this.configuration.shadow},r),r=`${c}-line-2`,l="2",(0,D.drawLine)(t,c,l,m[1],o,{color:u,width:1,lineDash:[1,1],shadow:this.configuration.shadow},r)}const v=this.getLinkedTextBoxStyle(d,r);if(!v.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const f=this.configuration.getTextLines(h,s,this.configuration);if(!h.handles.textBox.hasMoved){const e=m[1];h.handles.textBox.worldPosition=i.canvasToWorld(e)}const w=i.worldToCanvas(h.handles.textBox.worldPosition),E="1",I=(0,D.drawLinkedTextBox)(t,c,E,f,w,m,{},v),{x:C,y:b,width:_,height:T}=I;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([C,b]),topRight:i.canvasToWorld([C+_,b]),bottomLeft:i.canvasToWorld([C,b+T]),bottomRight:i.canvasToWorld([C+_,b+T])}}return n},this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,100,{trailing:!0})}toolSelectedCallback(e,t,n,i){}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;const r=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());let l,d=!1;n.worldPosition?d=!0:l=o.handles.points.findIndex(e=>e===n),this.editData={handleIndex:l,annotation:t,viewportIdsToRender:r},this._activateModify(a),(0,Ve.hideElementCursor)(a);const c=(0,s.getEnabledElement)(a),{renderingEngine:h}=c;(0,L.A)(r),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{element:a}=n.viewport;if(2!==i.handles.points.length)return;const{cachedStats:o}=i,s=Object.keys(o);for(let e=0;e<s.length;e++){const t=s[e],a=this.getTargetImageData(t);if(!a)continue;const{imageData:r}=a,l=i.handles.points[0],d=i.handles.points[1],c=Hn(r,l),h=Hn(r,d),{values:g,units:u}=(0,R.Xw)(a,[c]),{values:m,units:p}=(0,R.Xw)(a,[h]);let v,f,w,E,I=!1;if(u[0]!==p[0]||u[1]!==p[1]||"raw"===u[0]&&"raw"===p[0]){const e=(0,ut.distanceToPoint)(l,d);v=[e,0],f=[e,0],w=["px"],I=!0}else{const e=n.viewport.worldToCanvas(l),t=n.viewport.worldToCanvas(d),i=t[1]-e[1],a=t[0]-e[0];E=Math.abs(a)>Math.abs(i),v=[g[0],m[0]],f=[g[1],m[1]],w=[u[0],u[1]]}o[t]={xValues:v,yValues:f,isHorizontal:E,units:w,isUnitless:I}}const r=e.invalidated;return e.invalidated=!1,r&&(0,ae.triggerAnnotationModified)(e,a,l.ChangeTypes.StatsUpdated),o}}function Fn(e,t,n){const i=e.cachedStats[t],{xValues:a,yValues:o,units:r,isUnitless:l,isHorizontal:d}=i;if(l)return[`${s.utilities.roundNumber(a[0])} px`];if(n.displayBothAxesDistances){const e=Math.abs(a[1]-a[0]),t=Math.abs(o[1]-o[0]);return[`${s.utilities.roundNumber(e)} ${r[0]}`,`${s.utilities.roundNumber(t)} ${r[1]}`]}if(d){const e=Math.abs(a[1]-a[0]);return[`${s.utilities.roundNumber(e)} ${r[0]}`]}{const e=Math.abs(o[1]-o[0]);return[`${s.utilities.roundNumber(e)} ${r[1]}`]}}var zn=n(17787);const{transformIndexToWorld:Xn}=s.utilities;class $n extends Ee.EC{static{this.toolName="UltrasoundPleuraBLineTool"}static{this.USPleuraBLineAnnotationType={BLINE:"bLine",PLEURA:"pleura"}}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Zn,center:null,innerRadius:null,outerRadius:null,startAngle:null,endAngle:null,bLineColor:"rgb(60, 255, 60)",pleuraColor:"rgb(0, 4, 255)",drawDepthGuide:!0,depth_ratio:.5,depthGuideColor:"rgb(0, 255, 255)",depthGuideThickness:4,depthGuideDashLength:20,depthGuideDashGap:16,depthGuideOpacity:.2,fanOpacity:.1,showFanAnnotations:!0,updatePercentageCallback:null,actions:{undo:{method:"undo",bindings:[{key:"z"}]},redo:{method:"redo",bindings:[{key:"y"}]}}}}){super(e,t),this.pleuraAnnotations=[],this.bLineAnnotations=[],this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:l}=o;(0,Ve.hideElementCursor)(i),this.isDrawing=!0;const{viewPlaneNormal:d,viewUp:c,position:h}=l.getCamera(),g=this.getReferencedImageId(l,a,d,c),u={highlighted:!0,invalidated:!0,metadata:{...l.getViewReference({points:[a]}),toolName:this.getToolName(),referencedImageId:g,viewUp:c,cameraPosition:h},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null},annotationType:this.getActiveAnnotationType(),label:""}};(0,r.addAnnotation)(u,i);const m=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,L.A)(m),u},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,[l,d]=r.handles.points,c=o.worldToCanvas(l),h=o.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return re.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,Ve.hideElementCursor)(i),(0,L.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:s}=this.editData,{data:l}=i;o&&!s||(l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),this.doneEditMemo(),o&&(0,ae.triggerAnnotationCompleted)(i),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{viewport:i}=(0,s.getEnabledElement)(n)||{};if(!i)return;const{annotation:a,viewportIdsToRender:o,handleIndex:r,movingTextBox:d,newAnnotation:c}=this.editData,{data:h}=a;if(this.createMemo(n,a,{newAnnotation:c}),d){const{deltaPoints:e}=t,n=e.world,{textBox:i}=h.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world,o=h.handles.points,s=o.every(e=>{const t=[e[0]+n[0],e[1]+n[1],e[2]+n[2]];return this.isInsideFanShape(i,t)});s&&(o.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),a.invalidated=!0)}else{const{currentPoints:e}=t,n=e.world;this.isInsideFanShape(i,n)&&(h.handles.points[r]=[...n],a.invalidated=!0)}this.editData.hasMoved=!0,(0,L.A)(o),a.invalidated&&(0,ae.triggerAnnotationModified)(a,n,l.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;if(!this.getFanShapeGeometryParameters(i))return;const{imageData:o}=i.getImageData()||{};if(!o)return n;this.configuration.drawDepthGuide&&this.drawDepthGuide(t,i);let s=(0,r.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;this.getTargetId(i),i.getRenderingEngine();const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},d=i.worldToCanvas(Xn(o,this.configuration.center)),c=this.getIndexToCanvasRatio(i),h=this.configuration.innerRadius*c,g=this.configuration.outerRadius*c,u=i.getCurrentImageId(),m=s.filter(e=>e.data.annotationType===$n.USPleuraBLineAnnotationType.PLEURA&&e.metadata.referencedImageId===u).map(e=>{const t=e.data.handles.points.map(e=>i.worldToCanvas(e));return(0,zn.R3)(d,t)}),p=(0,zn.l7)(m),v=[],f=[],w=e=>{const{annotationUID:a,data:o}=e,{points:s,activeHandleIndex:r}=o.handles;l.annotationUID=a;const{color:c,lineWidth:u,lineDash:m,shadow:w}=this.getAnnotationStyle({annotation:e,styleSpecifier:l}),E=s.map(e=>i.worldToCanvas(e));if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let I;if(!(0,ht.isAnnotationVisible)(a))return;if((0,Be.isAnnotationLocked)(a)||this.editData||null===r||(I=[E[r]]),I){const n="0";(0,D.drawHandles)(t,a,n,E,{color:this.getColorForLineType(e),fill:this.getColorForLineType(e),lineDash:m,lineWidth:u})}const C=`${a}-line`;if((0,D.drawLine)(t,a,"1",E[0],E[1],{color:this.getColorForLineType(e),width:u,lineDash:m,shadow:w},C),this.configuration.showFanAnnotations){const n=(0,zn.R3)(d,E);let i=0;if(e.data.annotationType===$n.USPleuraBLineAnnotationType.BLINE){(0,zn.V0)(f,n).forEach(n=>{(0,zn.IM)(n,p).forEach(n=>{i++;const o=`${a}-fan-${i}`,s=`2-${i}`;(0,D.drawFan)(t,a,s,d,h,g,n[0],n[1],{color:"transparent",fill:this.getColorForLineType(e),fillOpacity:this.configuration.fanOpacity,width:u,lineDash:m,shadow:w},o,10),f.push(n)})})}else if(e.data.annotationType===$n.USPleuraBLineAnnotationType.PLEURA){(0,zn.V0)(v,n).forEach((n,o)=>{i++;const s=`${a}-fan-${i}`,r=`2-${i}`;(0,D.drawFan)(t,a,r,d,h,g,n[0],n[1],{color:"transparent",fill:this.getColorForLineType(e),fillOpacity:this.configuration.fanOpacity,width:u,lineDash:m,shadow:w},s,5),v.push(n)})}}},E=s.filter(e=>e.data.annotationType===$n.USPleuraBLineAnnotationType.PLEURA&&e.metadata.referencedImageId===u);E.forEach(e=>{if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;w(e)});const I=s.filter(e=>e.data.annotationType===$n.USPleuraBLineAnnotationType.BLINE&&e.metadata.referencedImageId===u);return I.forEach(e=>{if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;w(e)}),n=!0,this.configuration.updatePercentageCallback&&i&&this.configuration.updatePercentageCallback(this.calculateBLinePleuraPercentage(i)),n},this.activeAnnotationType=$n.USPleuraBLineAnnotationType.BLINE}static filterAnnotations(e,t=()=>!0){const n=(0,r.getAnnotations)($n.toolName,e);if(!n?.length)return[];const i=n.filter(e=>{const n=e.metadata.referencedImageId;return t(n)});return i}static countAnnotations(e,t=()=>!0){const n=(0,r.getAnnotations)($n.toolName,e),{viewport:i}=(0,s.getEnabledElement)(e),a=i.getImageIds(),o=e=>{const t=a.findIndex(t=>t===e);return-1===t?0:t};if(!n?.length)return;const l=new Map;return n.forEach(e=>{const n=e.metadata.referencedImageId;if(!t(n))return;const{annotationType:i}=e.data;let a;a=l.has(n)?l.get(n):{frame:o(n),bLine:0,pleura:0},i===$n.USPleuraBLineAnnotationType.PLEURA?a.pleura++:i===$n.USPleuraBLineAnnotationType.BLINE&&a.bLine++,l.set(n,a)}),l}static deleteAnnotations(e,t=()=>!1){const n=(0,r.getAnnotations)($n.toolName,e);n?.length&&n.forEach(e=>{t(e.metadata.referencedImageId)&&(0,r.removeAnnotation)(e.annotationUID)})}setActiveAnnotationType(e){this.activeAnnotationType=e}getActiveAnnotationType(){return this.activeAnnotationType}deleteLastAnnotationType(e,t){let n;const i=(0,r.getAnnotations)($n.toolName,e);if(t===$n.USPleuraBLineAnnotationType.PLEURA?n=i.filter(e=>e.data.annotationType===$n.USPleuraBLineAnnotationType.PLEURA):t===$n.USPleuraBLineAnnotationType.BLINE&&(n=i.filter(e=>e.data.annotationType===$n.USPleuraBLineAnnotationType.BLINE)),n?.length>0){const e=n.pop();(0,r.removeAnnotation)(e.annotationUID)}}static{this.hydrate=(e,t,n)=>{const i=(0,s.getEnabledElementByViewportId)(e);if(!i)return;const{FrameOfReferenceUID:a,referencedImageId:o,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase($n,i,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||s.utilities.uuidv4(),data:{handles:{points:t}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:o,...g}};(0,r.addAnnotation)(u,c.element),(0,L.A)([c.id])}}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:o}=t;t.highlighted=!0;let s,r=!1;n.worldPosition?r=!0:s=o.handles.points.findIndex(e=>e===n);const l=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(a),(0,Ve.hideElementCursor)(a),(0,L.A)(l),e.preventDefault()}isInsideFanShape(e,t){if(!this.getFanShapeGeometryParameters(e))return!1;const{imageData:n}=e.getImageData()||{};if(n){const i=e.worldToCanvas(n.indexToWorld(this.configuration.center)),a=e.worldToCanvas(t),o=(0,zn.xA)(i,a);return o>=this.configuration.startAngle&&o<=this.configuration.endAngle}}updateFanGeometryConfiguration(e){e&&(this.isFanShapeGeometryParametersValid(e)&&(this.configuration.center=[e.center[0],e.center[1],0]),this.configuration.innerRadius=e.innerRadius,this.configuration.outerRadius=e.outerRadius,this.configuration.startAngle=e.startAngle,this.configuration.endAngle=e.endAngle)}deriveFanGeometryFromViewport(e){const t=e.getCurrentImageId(),{fanGeometry:n}=ce(t)||{};n&&this.updateFanGeometryConfiguration(n)}isFanShapeGeometryParametersValid(e){return e||(e=this.configuration),e?.center&&e?.innerRadius>0&&e?.outerRadius&&e?.startAngle>0&&e?.startAngle<360&&e?.endAngle>0&&e?.endAngle<360}getFanShapeGeometryParameters(e){if(this.isFanShapeGeometryParametersValid())return!0;if(!this.isFanShapeGeometryParametersValid()){const t=e.getCurrentImageId(),n=s.metaData.get("ultrasoundFanShapeGeometry",t);this.updateFanGeometryConfiguration(n)}return this.isFanShapeGeometryParametersValid()||this.deriveFanGeometryFromViewport(e),this.isFanShapeGeometryParametersValid()}calculateBLinePleuraPercentage(e){if(!this.getFanShapeGeometryParameters(e))return;const{imageData:t}=e.getImageData()||{};if(!t)return;const{element:n}=e,i=e.worldToCanvas(t.indexToWorld(this.configuration.center)),a=e.getCurrentImageId(),o=(0,r.getAnnotations)(this.getToolName(),n)||[],s=o.filter(e=>e.data.annotationType===$n.USPleuraBLineAnnotationType.PLEURA&&e.metadata.referencedImageId===a).map(t=>t.data.handles.points.map(t=>e.worldToCanvas(t))),l=o.filter(e=>e.data.annotationType===$n.USPleuraBLineAnnotationType.BLINE&&e.metadata.referencedImageId===a).map(t=>t.data.handles.points.map(t=>e.worldToCanvas(t)));return(0,zn.Mo)(i,s,l)}getColorForLineType(e){const{annotationType:t}=e.data,{bLineColor:n,pleuraColor:i}=this.configuration;return t===$n.USPleuraBLineAnnotationType.BLINE?n:t===$n.USPleuraBLineAnnotationType.PLEURA?i:n}getIndexToCanvasRatio(e){const{imageData:t}=e.getImageData()||{},n=e.worldToCanvas(t.indexToWorld([1,0,0])),i=e.worldToCanvas(t.indexToWorld([2,0,0])),a=[i[0]-n[0],i[1]-n[1]];return Math.sqrt(a[0]*a[0]+a[1]*a[1])}drawDepthGuide(e,t){if(!this.getFanShapeGeometryParameters(t))return;const{imageData:n}=t.getImageData()||{};if(!n)return;const i=e=>180*e/Math.PI,a=e=>e*Math.PI/180,o=e=>t.worldToCanvas(Xn(n,e)),s=this.configuration.innerRadius+this.configuration.depth_ratio*(this.configuration.outerRadius-this.configuration.innerRadius),r=this.configuration.startAngle,l=this.configuration.endAngle-r,d=a(l)*s;let c=Math.round(d/(this.configuration.depthGuideDashLength+this.configuration.depthGuideDashGap));c<=0&&(c=Math.max(15,Math.round(l/5)));const h=l/c;for(let n=0;n<c;n++){const l=a(r+n*h),d=a(r+n*h+i(this.configuration.depthGuideDashLength)/s),c=[this.configuration.center[0]+s*Math.cos(l),this.configuration.center[1]+s*Math.sin(l),0],g=[this.configuration.center[0]+s*Math.cos(d),this.configuration.center[1]+s*Math.sin(d),0];(0,D.drawLine)(e,t.id,`depthGuide-${n}`,o(c),o(g),{color:this.configuration.depthGuideColor,lineWidth:this.configuration.depthGuideThickness,strokeOpacity:this.configuration.depthGuideOpacity})}}_isInsideVolume(e,t,n){return s.utilities.indexWithinDimensions(e,n)&&s.utilities.indexWithinDimensions(t,n)}}function Zn(e,t){return[""]}class Yn extends Ee.EC{static{this.toolName="KeyImage"}static{this.dataSeries={data:{seriesLevel:!0}}}static{this.dataPoint={data:{isPoint:!0}}}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:jn,changeTextCallback:qn,canvasPosition:[10,10],canvasSize:10,handleRadius:"6",seriesLevel:!1,isPoint:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{element:n,currentPoints:i}=t,a=(0,s.getEnabledElement)(n),{viewport:o}=a,l=i.world,d=this.constructor.createAnnotationForViewport(o,{data:{handles:{points:[[...l]]},seriesLevel:this.configuration.seriesLevel,isPoint:this.configuration.isPoint}});(0,r.addAnnotation)(d,n);const c=(0,W.getViewportIdsWithToolToRender)(n,this.getToolName());return e.preventDefault(),(0,L.A)(c),this.configuration.getTextCallback(e=>{if(!e)return(0,r.removeAnnotation)(d.annotationUID),(0,L.A)(c),void(this.isDrawing=!1);d.data.label=e,(0,ae.triggerAnnotationCompleted)(d),(0,L.A)(c)}),this.createMemo(n,d,{newAnnotation:!0}),d},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t;if(!r?.isPoint)return!1;const{canvasPosition:l,canvasSize:d}=this.configuration;return!!l?.length&&(Math.abs(n[0]-l[0]+d/2)<=d/2&&Math.abs(n[1]-l[1]+d/2)<=d/2)},this.toolSelectedCallback=(e,t)=>{t.highlighted=!0,e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o}=this.editData,{viewportId:l,renderingEngine:d}=(0,s.getEnabledElement)(n);this.eventDispatchDetail={viewportId:l,renderingEngineId:d.id},this._deactivateModify(n),(0,Ve.resetElementCursor)(n),o&&this.createMemo(n,i,{newAnnotation:o}),this.editData=null,this.isDrawing=!1,this.doneEditMemo(),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,L.A)(a),o&&(0,ae.triggerAnnotationCompleted)(i)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=(0,r.getAnnotations)(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const a=i.find(e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6));if(!a)return;const o=a;this.createMemo(n,o),this.configuration.changeTextCallback(a,e.detail,this._doneChangingTextCallback.bind(this,n,o)),this.isDrawing=!1,this.doneEditMemo(),e.stopImmediatePropagation(),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,{annotation:o,viewportIdsToRender:s,newAnnotation:r}=this.editData,{data:l}=o;this.createMemo(i,o,{newAnnotation:r}),l.handles.points[0]=[...a],o.invalidated=!0,(0,L.A)(s)},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let o=(0,r.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<o.length;e++){const a=o[e],{annotationUID:r,data:l}=a;s.annotationUID=r;const{color:d,lineWidth:c}=this.getAnnotationStyle({annotation:a,styleSpecifier:s}),{canvasPosition:h,canvasSize:g}=this.configuration,u="1";if(l?.isPoint){const e=l.handles.points[0],n=i.worldToCanvas(e);(0,D.drawHandles)(t,r,u,[n],{color:d,lineWidth:c,handleRadius:this.configuration.handleRadius})}else h?.length&&(0,D.drawArrow)(t,r,u,h.map(e=>e+g),h,{color:d,width:1});if(n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n}return n}}handleSelectedCallback(e,t){const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},this._activateModify(i),(0,Ve.hideElementCursor)(i),(0,L.A)(a),e.preventDefault()}static setPoint(e,t=!e.data.isPoint,n){e.data.isPoint=t,(0,ae.triggerAnnotationModified)(e,n)}_doneChangingTextCallback(e,t,n){t.data.label=n;const i=(0,W.getViewportIdsWithToolToRender)(e,this.getToolName());(0,L.A)(i),(0,ae.triggerAnnotationModified)(t,e)}cancel(e){if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,L.A)(n),i&&(0,ae.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}}_isInsideVolume(e,t,n){return s.utilities.indexWithinDimensions(e,n)&&s.utilities.indexWithinDimensions(t,n)}}function jn(e){return e(prompt("Enter your annotation:"))}function qn(e,t,n){return n(prompt("Enter your annotation:"))}var Kn=n(17343);class Jn extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>this._deleteNearbyAnnotations(e,"mouse"),this.preTouchStartCallback=e=>this._deleteNearbyAnnotations(e,"touch")}_deleteNearbyAnnotations(e,t){const{renderingEngineId:n,viewportId:i,element:a,currentPoints:o}=e.detail,s=(0,I.getToolGroupForViewport)(i,n);if(!s)return!1;const l=s._toolInstances,d=[];for(const e in l){const n=l[e];if("function"!=typeof n.isPointNearTool||"function"!=typeof n.filterInteractableAnnotationsForElement)continue;const i=(0,r.getAnnotations)(e,a),s=n.filterInteractableAnnotationsForElement(a,i);if(s)for(const e of s)n.isPointNearTool(a,e,o.canvas,10,t)&&d.push(e.annotationUID)}for(const e of d){(0,Kn.setAnnotationSelected)(e);const t=(0,r.getAnnotation)(e);Ee.EC.createAnnotationMemo(a,t,{deleting:!0}),(0,r.removeAnnotation)(e)}return e.preventDefault(),!0}}Jn.toolName="Eraser";var Qn=n(10639);class ei extends Qn.A{static{this.toolName="RegionSegment"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{isPartialVolume:!0,positiveSeedVariance:.5,negativeSeedVariance:.9}}){super(e,t),this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,{world:a}=i,o=(0,s.getEnabledElement)(n),{viewport:r}=o;this.growCutData.circleBorderPoint=a,(0,L.A)([r.id])},this._endCallback=async e=>{const t=e.detail,{element:n}=t,i=(0,s.getEnabledElement)(n),{viewport:a}=i;this.runGrowCut(),this._deactivateDraw(n),this.growCutData=null,(0,Ve.resetElementCursor)(n),(0,L.A)([a.id])},this._deactivateDraw=e=>{e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback)}}async preMouseDownCallback(e){const t=e.detail,{element:n,currentPoints:i}=t,{world:a}=i,o=(0,s.getEnabledElement)(n),{viewport:r,renderingEngine:l}=o;return await super.preMouseDownCallback(e),Object.assign(this.growCutData,{circleCenterPoint:a,circleBorderPoint:a}),this._activateDraw(n),(0,Ve.hideElementCursor)(n),(0,L.A)([r.id]),!0}async getGrowCutLabelmap(e){const{segmentation:{referencedVolumeId:t},renderingEngineId:n,viewportId:i,circleCenterPoint:a,circleBorderPoint:o,options:r}=e,l=(0,s.getRenderingEngine)(n).getViewport(i),d={center:a,radius:T.eR.len(T.eR.sub(T.eR.create(),a,o))};return U.growCut.runGrowCutForSphere(t,d,l,r)}_activateDraw(e){e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback)}renderAnnotation(e,t){if(!this.growCutData)return;const{viewport:n}=e,{segmentation:i,circleCenterPoint:a,circleBorderPoint:o}=this.growCutData,r=n.worldToCanvas(a),l=n.worldToCanvas(o),d=T.Zc.sub(T.Zc.create(),l,r),c=T.Zc.len(d);if(s.utilities.isEqual(c,0))return;const{color:h}=this.getSegmentStyle({segmentationId:i.segmentationId,segmentIndex:i.segmentIndex,viewportId:n.id});(0,D.drawCircle)(t,"growcut","0",r,c,{color:h})}}var ti=n(16171);class ni extends Qn.A{static{this.toolName="RegionSegmentPlus"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{isPartialVolume:!1,positiveSeedVariance:.4,negativeSeedVariance:.9,subVolumePaddingPercentage:.1,islandRemoval:{enabled:!1}}}){super(e,t),this.mouseTimer=null,this.allowedToProceed=!1}mouseMoveCallback(e){if(this.mode!==l.ToolModes.Active)return;const t=e.detail,{currentPoints:n,element:i}=t,{world:a}=n;i.style.cursor="default",null!==this.mouseTimer&&(window.clearTimeout(this.mouseTimer),this.mouseTimer=null),this.mouseTimer=window.setTimeout(()=>{this.onMouseStable(e,a,i)},this.configuration.mouseStabilityDelay||500)}async onMouseStable(e,t,n){await super.preMouseDownCallback(e);const i=s.cache.getVolume(this.growCutData.segmentation.referencedVolumeId),a=(0,ti.sG)(i,t,{})||{positiveSeedIndices:new Set,negativeSeedIndices:new Set},{positiveSeedIndices:o,negativeSeedIndices:r}=a;let l;o.size/r.size>20||r.size<30?(l="not-allowed",this.allowedToProceed=!1):(l="copy",this.allowedToProceed=!0);const d=(0,s.getEnabledElement)(n);n&&(n.style.cursor=l,requestAnimationFrame(()=>{n.style.cursor!==l&&(n.style.cursor=l)})),this.allowedToProceed&&(this.seeds=a),d&&d.viewport&&d.viewport.render()}async preMouseDownCallback(e){if(!this.allowedToProceed)return!1;const t=e.detail,{currentPoints:n,element:i}=t;(0,s.getEnabledElement)(i)&&(i.style.cursor="wait",requestAnimationFrame(()=>{"wait"!==i.style.cursor&&(i.style.cursor="wait")}));const{world:a}=n;return await super.preMouseDownCallback(e),this.growCutData=s.utilities.deepMerge(this.growCutData,{worldPoint:a,islandRemoval:{worldIslandPoints:[a]}}),this.growCutData.worldPoint=a,this.growCutData.islandRemoval={worldIslandPoints:[a]},await this.runGrowCut(),i&&(i.style.cursor="default"),!0}getRemoveIslandData(e){const{worldPoint:t}=e;return{worldIslandPoints:[t]}}async getGrowCutLabelmap(e){const{segmentation:{referencedVolumeId:t},worldPoint:n,options:i}=e,{subVolumePaddingPercentage:a}=this.configuration,o={...i,subVolumePaddingPercentage:a,seeds:this.seeds};return U.growCut.runOneClickGrowCut({referencedVolumeId:t,worldPosition:n,options:o})}}const ii=[-1/0,-995],ai=[0,1900],oi=[1e3,1900],{transformWorldToIndex:si,transformIndexToWorld:ri}=s.utilities;class li extends Qn.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{isPartialVolume:!0,positivePixelRange:ai,negativePixelRange:ii,islandRemoval:{enabled:!0,islandPixelRange:oi}}}){super(e,t),this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,{world:a}=i,o=(0,s.getEnabledElement)(n),{viewport:r}=o,l=this._getHorizontalLineWorldPoints(o,a);this.growCutData.horizontalLines[1]=l,(0,L.A)([r.id])},this._endCallback=async e=>{const t=e.detail,{element:n}=t,i=(0,s.getEnabledElement)(n),{viewport:a}=i;await this.runGrowCut(),this._deactivateDraw(n),this.growCutData=null,(0,Ve.resetElementCursor)(n),(0,L.A)([a.id])},this._deactivateDraw=e=>{e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback)}}async preMouseDownCallback(e){const t=e.detail,{element:n,currentPoints:i}=t,{world:a}=i,o=(0,s.getEnabledElement)(n),{viewport:r,renderingEngine:l}=o,d=this._getHorizontalLineWorldPoints(o,a);return await super.preMouseDownCallback(e),this.growCutData.horizontalLines=[d,d],this._activateDraw(n),(0,Ve.hideElementCursor)(n),(0,L.A)([r.id]),!0}renderAnnotation(e,t){if(!this.growCutData)return;const{segmentation:n,horizontalLines:i}=this.growCutData;if(2!==i.length)return;const{viewport:a}=e,{segmentationId:o,segmentIndex:s}=n,[r,l]=i,[d,c]=r,[h,g]=l,u=[d,c,g,h].map(e=>a.worldToCanvas(e)),{color:m,fillColor:p,lineWidth:v,fillOpacity:f,lineDash:w}=this.getSegmentStyle({segmentationId:o,segmentIndex:s,viewportId:a.id});(0,D.drawPolyline)(t,"growCutRect","0",u,{color:m,fillColor:p,fillOpacity:f,lineWidth:v,lineDash:w,closePath:!0})}async getGrowCutLabelmap(e){const{segmentation:{segmentIndex:t,referencedVolumeId:n},renderingEngineId:i,viewportId:a,horizontalLines:o}=e,r=(0,s.getRenderingEngine)(i).getViewport(a),[l,d]=o,c=[l[0],l[1],d[1],d[0]],h=s.cache.getVolume(n),{topLeft:g,bottomRight:u}=this._getWorldBoundingBoxFromProjectedSquare(r,c),m={boundingBox:{ijkTopLeft:si(h.imageData,g),ijkBottomRight:si(h.imageData,u)}},p=this.configuration,v={positiveSeedValue:t,negativeSeedValue:255,negativePixelRange:p.negativePixelRange,positivePixelRange:p.positivePixelRange};return U.growCut.runGrowCutForBoundingBox(n,m,v)}getRemoveIslandData(){const{segmentation:{segmentIndex:e,referencedVolumeId:t,labelmapVolumeId:n}}=this.growCutData,i=s.cache.getVolume(t),a=s.cache.getVolume(n),o=i.voxelManager.getCompleteScalarDataArray(),r=a.voxelManager.getCompleteScalarDataArray(),{islandPixelRange:l}=this.configuration.islandRemoval,d=[];for(let t=0,n=r.length;t<n;t++){if(r[t]!==e)continue;const n=o[t];n>=l[0]&&n<=l[1]&&d.push(t)}return{islandPointIndexes:d}}_activateDraw(e){e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback)}_projectWorldPointAcrossSlices(e,t,n){const i=this._getViewportVolume(e),{dimensions:a}=i,o=si(i.imageData,t),r=n.findIndex(e=>s.utilities.isEqual(Math.abs(e),1));if(-1===r)throw new Error("Non-orthogonal direction vector");const l=[...o],d=[...o];return l[r]=0,d[r]=a[r]-1,[l,d]}_getCuboidIJKEdgePointsFromProjectedWorldPoint(e,t){const{viewPlaneNormal:n}=e.getCamera();return this._projectWorldPointAcrossSlices(e,t,n)}_getWorldCuboidCornerPoints(e,t){const n=[],i=this._getViewportVolume(e);return t.forEach(t=>{const a=this._getCuboidIJKEdgePointsFromProjectedWorldPoint(e,t).map(e=>ri(i.imageData,e));n.push(...a)}),n}_getWorldBoundingBoxFromProjectedSquare(e,t){const n=this._getWorldCuboidCornerPoints(e,t),i=[...n[0]],a=[...n[0]];return n.forEach(e=>{T.eR.min(i,i,e),T.eR.max(a,a,e)}),{topLeft:i,bottomRight:a}}_getViewportVolume(e){if(!(e instanceof s.BaseVolumeViewport))throw new Error("Viewport is not a BaseVolumeViewport");const t=e.getAllVolumeIds()[0];return s.cache.getVolume(t)}_getHorizontalLineIJKPoints(e,t){const{viewport:n}=e,i=this._getViewportVolume(n),{dimensions:a}=i,o=si(i.imageData,t),{viewUp:r,viewPlaneNormal:l}=n.getCamera(),d=T.eR.cross(T.eR.create(),r,l).findIndex(e=>s.utilities.isEqual(Math.abs(e),1)),c=[...o],h=[...o];return c[d]=0,h[d]=a[d]-1,[c,h]}_getHorizontalLineWorldPoints(e,t){const{viewport:n}=e,i=this._getViewportVolume(n),[a,o]=this._getHorizontalLineIJKPoints(e,t);return[ri(i.imageData,a),ri(i.imageData,o)]}}li.toolName="WholeBodySegment";var di=n(23631),ci=n(10088),hi=n(47347),gi=n(98870);class ui extends di.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:ci.pY,ERASE_INSIDE:hi.M},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:r}=o;this.isDrawing=!0;const d=r.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=he.activeSegmentation.getActiveSegmentation(r.id);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:u}=g,m=he.segmentIndex.getActiveSegmentIndex(u),p=he.segmentLocking.getLockedSegmentIndices(u),v=he.config.color.getSegmentIndexColor(r.id,u,m),{representationData:f}=(0,gi.getSegmentation)(u),w=f[l.SegmentationRepresentations.Labelmap],E={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:v},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null}}},I=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());if(this.editData={annotation:E,segmentIndex:m,segmentationId:u,segmentsLocked:p,segmentColor:v,viewportIdsToRender:I,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null},r instanceof s.BaseVolumeViewport){const{volumeId:e}=w,t=s.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const e=(0,gi.getCurrentLabelmapImageIdForViewport)(r.id,u);this.editData={...this.editData,imageId:e}}return this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(I),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o}=this.editData,{data:r}=i,{currentPoints:l}=t,d=(0,s.getEnabledElement)(n),{worldToCanvas:c,canvasToWorld:h}=d.viewport,g=l.world,{points:u}=r.handles;let m,p,v,f,w,E,I,C;switch(u[o]=[...g],o){case 0:case 3:m=c(u[0]),f=c(u[3]),p=[f[0],m[1]],v=[m[0],f[1]],E=h(p),I=h(v),u[1]=E,u[2]=I;break;case 1:case 2:p=c(u[1]),v=c(u[2]),m=[v[0],p[1]],f=[p[0],v[1]],w=h(m),C=h(f),u[0]=w,u[3]=C}i.invalidated=!0,this.editData.hasMoved=!0,(0,L.A)(a)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:o}=this.editData,{data:r}=i;if(a&&!o)return;r.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const l=(0,s.getEnabledElement)(n),d={...this.editData,points:r.handles.points,createMemo:this.createMemo.bind(this)};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(l,d),this.doneEditMemo()},this._activateDraw=e=>{e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{annotation:a}=this.editData,o=a.metadata,s=a.annotationUID,r=a.data,{points:l}=r.handles,d=l.map(e=>i.worldToCanvas(e)),c=`rgb(${o.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,D.drawRect)(t,s,"0",d[0],d[3],{color:c}),n=!0,n}}}ui.toolName="RectangleScissor";var mi=n(56789),pi=n(33852);class vi extends di.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:mi.kr,ERASE_INSIDE:pi.r},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=n.canvas,r=(0,s.getEnabledElement)(i),{viewport:l}=r;this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=he.activeSegmentation.getActiveSegmentation(l.id);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:u}=g,m=he.segmentIndex.getActiveSegmentIndex(u),p=he.segmentLocking.getLockedSegmentIndices(u),v=he.config.color.getSegmentIndexColor(l.id,u,m),{representationData:f}=(0,gi.getSegmentation)(u),w=f.Labelmap;if(!w)throw new Error("No labelmap data found for the active segmentation, create one before using scissors tool");const E={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:v},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},I=[l.id];if(this.editData={annotation:E,centerCanvas:o,segmentIndex:m,segmentationId:u,segmentsLocked:p,segmentColor:v,viewportIdsToRender:I,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null},l instanceof s.BaseVolumeViewport){const{volumeId:e}=w,t=s.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const e=(0,gi.getCurrentLabelmapImageIdForViewport)(l.id,u);this.editData={...this.editData,imageId:e}}return this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(I),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,o=(0,s.getEnabledElement)(n),{renderingEngine:r,viewport:l}=o,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h,centerCanvas:g}=this.editData,{data:u}=c,m=Math.abs(a[0]-g[0]),p=Math.abs(a[1]-g[1]),v=Math.sqrt(m*m+p*p),f=[g[0],g[1]+v],w=[g[0],g[1]-v],E=[g[0]-v,g[1]],I=[g[0]+v,g[1]];u.handles.points=[d(f),d(w),d(E),d(I)],c.invalidated=!0,this.editData.hasMoved=!0,(0,L.A)(h)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:o}=this.editData,{data:r}=i,{viewPlaneNormal:l,viewUp:d}=i.metadata;if(a&&!o)return;r.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const c=(0,s.getEnabledElement)(n),h={...this.editData,points:r.handles.points,viewPlaneNormal:l,viewUp:d,createMemo:this.createMemo.bind(this)};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(c,h),this.doneEditMemo()},this._activateDraw=e=>{e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:a}=this.editData;if(!a.includes(i.id))return n;const{annotation:o}=this.editData,s=o.metadata,r=o.annotationUID,l=o.data,{points:d}=l.handles,c=d.map(e=>i.worldToCanvas(e)),h=c[0],g=c[1],u=[Math.floor((h[0]+g[0])/2),Math.floor((h[1]+g[1])/2)],m=Math.abs(h[1]-Math.floor((h[1]+g[1])/2)),p=`rgb(${s.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,D.drawCircle)(t,r,"0",u,m,{color:p}),n=!0,n}}}vi.toolName="CircleScissor";var fi=n(17492),wi=n(1989);class Ei extends di.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:fi.Jq,ERASE_INSIDE:wi._},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;this.doneEditMemo();const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=n.canvas,r=(0,s.getEnabledElement)(i),{viewport:l}=r;this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=he.activeSegmentation.getActiveSegmentation(l.id);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:u}=g,m=he.segmentIndex.getActiveSegmentIndex(u),p=he.segmentLocking.getLockedSegmentIndices(u),v=he.config.color.getSegmentIndexColor(l.id,u,m);this.isDrawing=!0;const f={metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:v},data:{invalidated:!0,handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},w=[l.id];this.editData={annotation:f,centerCanvas:o,segmentIndex:m,segmentationId:u,segmentsLocked:p,segmentColor:v,toolGroupId:this.toolGroupId,viewportIdsToRender:w,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null};const{representationData:E}=(0,gi.getSegmentation)(u),I=this.getEditData({viewport:l,representationData:E,segmentsLocked:p,segmentationId:u});return this.editData={...this.editData,...I},this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(w),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,o=(0,s.getEnabledElement)(n),{renderingEngine:r,viewport:l}=o,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h,centerCanvas:g}=this.editData,{data:u}=c,m=Math.abs(a[0]-g[0]),p=Math.abs(a[1]-g[1]),v=Math.sqrt(m*m+p*p),f=[g[0],g[1]+v],w=[g[0],g[1]-v],E=[g[0]-v,g[1]],I=[g[0]+v,g[1]];u.handles.points=[d(f),d(w),d(E),d(I)],c.invalidated=!0,this.editData.hasMoved=!0,(0,L.A)(h)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:o,segmentIndex:r,segmentsLocked:l}=this.editData,{data:d}=i,{viewPlaneNormal:c,viewUp:h}=i.metadata;if(a&&!o)return;i.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const g=(0,s.getEnabledElement)(n),u={...this.editData,points:d.handles.points,segmentIndex:r,segmentsLocked:l,viewPlaneNormal:c,viewUp:h,createMemo:this.createMemo.bind(this)};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(g,u),this.doneEditMemo()},this._activateDraw=e=>{e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:a}=this.editData;if(!a.includes(i.id))return n;const{annotation:o}=this.editData,s=o.metadata,r=o.annotationUID,l=o.data,{points:d}=l.handles,c=d.map(e=>i.worldToCanvas(e)),h=c[0],g=c[1],u=[Math.floor((h[0]+g[0])/2),Math.floor((h[1]+g[1])/2)],m=Math.abs(h[1]-Math.floor((h[1]+g[1])/2)),p=`rgb(${s.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,D.drawCircle)(t,r,"0",u,m,{color:p}),n=!0,n}}}Ei.toolName="SphereScissor";n(40336),n(67847);const{transformWorldToIndex:Ii}=s.utilities;class Ci extends gn{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{simplified:!0,storePointData:!1,numSlicesToPropagate:10,calculatePointsInsideVolume:!0,getTextLines:bi,statsCalculator:on.BasicStatsCalculator,showTextBox:!1,throttleTimeout:100}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:l,renderingEngine:d}=o;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c;let u,m,p;if(l instanceof s.StackViewport)throw new Error("Stack Viewport Not implemented");{const e=this.getTargetId(l);p=s.utilities.getVolumeId(e),m=s.cache.getVolume(p),u=s.utilities.getClosestImageId(m,a,h)}const v=s.utilities.getSpacingInNormalDirection(m,h),f=this._getStartCoordinate(a,v,h),w=this._getEndCoordinate(a,v,h),E=l.getFrameOfReferenceUID();let I;I=this.configuration.simplified?[[...a],[...a]]:[[...a],[...a],[...a],[...a],[...a]];const C={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:E,referencedImageId:u,volumeId:p,spacingInNormal:v,enabledElement:o},data:{label:"",startCoordinate:f,endCoordinate:w,handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:I,activeHandleIndex:null},cachedStats:{pointsInVolume:[],projectionPoints:[],statistics:[]},labelmapUID:null}};this._computeProjectionPoints(C,m),(0,r.addAnnotation)(C,i);const b=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:C,viewportIdsToRender:b,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(b),C},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:l}=this.editData,{data:d}=i;if(o&&!l)return;i.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n);const{metadata:c}=i,{enabledElement:h}=c;this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID);const g=this.getTargetId(h.viewport),u=s.cache.getVolume(g.split(/volumeId:|\?/)[1]);this._computePointsInsideVolume(i,u,g,h),(0,L.A)(a),o?(0,ae.triggerAnnotationCompleted)(i):(0,ae.triggerAnnotationModified)(i,n)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e;let a=(0,r.getAnnotations)(this.getToolName(),i.element);if(!a?.length)return n;a=(0,V.filterAnnotationsWithinSamePlane)(a,i.getCamera());const o={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const r=a[e],{annotationUID:l,data:d,metadata:c}=r,{startCoordinate:h,endCoordinate:g}=d,{points:u,activeHandleIndex:m}=d.handles,{enabledElement:p}=c;o.annotationUID=l;const v=this.getStyle("lineWidth",o,r),f=this.getStyle("lineDash",o,r),w=this.getStyle("color",o,r),E=u.map(e=>i.worldToCanvas(e)),I=E[0],C=(0,gt.getCanvasCircleRadius)([E[0],E[1]]),{centerPointRadius:b}=this.configuration,_=(0,gt.getCanvasCircleCorners)([E[0],E[1]]),T=i.getCamera().focalPoint,A=i.getCamera().viewPlaneNormal;let S=h,M=g;Array.isArray(h)&&(S=this._getCoordinateForViewplaneNormal(S,A),d.startCoordinate=S),Array.isArray(g)&&(M=this._getCoordinateForViewplaneNormal(M,A),d.endCoordinate=M);const y=s.utilities.roundToPrecision(d.startCoordinate),P=s.utilities.roundToPrecision(d.endCoordinate),x=this._getCoordinateForViewplaneNormal(T,A),R=s.utilities.roundToPrecision(x);if(R<Math.min(y,P)||R>Math.max(y,P))continue;const L=s.utilities.roundToPrecision((d.startCoordinate+d.endCoordinate)/2);let O=!1;R===L&&(O=!0),d.handles.points[0][this._getIndexOfCoordinatesForViewplaneNormal(A)]=L;const U=p.viewport?.volumeIds.values();for(const e of U)r.invalidated&&r.metadata.volumeId===e&&this._throttledCalculateCachedStats(r,p);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let N;if(!(0,ht.isAnnotationVisible)(l))continue;if((0,Be.isAnnotationLocked)(l)||this.editData||null===m||!O||(N=this.configuration.simplified?[E[m]]:E),N){const e="0";(0,D.drawHandles)(t,l,e,N,{color:w})}let V=v,W=f;O?(V=v,W=[]):W=[5,5];const B="0";if((0,D.drawCircle)(t,l,B,I,C,{color:w,lineDash:W,lineWidth:V}),b>0&&C>3*b&&(0,D.drawCircle)(t,l,`${B}-center`,I,b,{color:w,lineDash:f,lineWidth:v}),n=!0,this.configuration.showTextBox){const e=this.getLinkedTextBoxStyle(o,r);if(!e.visibility){d.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const n=this.configuration.getTextLines(d,{metadata:c});if(!n||0===n.length)continue;let a;d.handles.textBox.hasMoved||(a=(0,k.getTextBoxCoordsCanvas)(_),d.handles.textBox.worldPosition=i.canvasToWorld(a));const s=i.worldToCanvas(d.handles.textBox.worldPosition),h="1",g=(0,D.drawLinkedTextBox)(t,l,h,n,s,[E[0],E[1]],{},e),{x:u,y:m,width:p,height:v}=g;d.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([u,m]),topRight:i.canvasToWorld([u+p,m]),bottomLeft:i.canvasToWorld([u,m+v]),bottomRight:i.canvasToWorld([u+p,m+v])}}}return n},this.configuration.calculatePointsInsideVolume?this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStatsTool,this.configuration.throttleTimeout,{trailing:!0}):this._throttledCalculateCachedStats=(0,y.A)(this._calculateCachedStatsTool,this.configuration.throttleTimeout)}_computeProjectionPoints(e,t){const{data:n,metadata:i}=e,{viewPlaneNormal:a,spacingInNormal:o}=i,{startCoordinate:r,endCoordinate:l}=n,{points:d}=n.handles,c=this._getIndexOfCoordinatesForViewplaneNormal(a),h=T.eR.clone(d[0]);h[c]=r;const g=T.eR.clone(d[0]);g[c]=l;const u=T.eR.create();T.eR.subtract(u,g,h);const m=T.eR.length(u);if(0===m){const e=d.map(e=>{const t=T.eR.clone(e);return t[c]=r,Array.from(t)});return void(n.cachedStats.projectionPoints=[e])}T.eR.normalize(u,u);const p=s.utilities.deepClone(d);p[0][c]=r,p[1][c]=r;const v=[];for(let e=0;e<=m+1e-6;e+=o)v.push(p.map(t=>{const n=T.eR.create();return T.eR.scaleAndAdd(n,t,u,e),Array.from(n)}));n.cachedStats.projectionPoints=v}_computePointsInsideVolume(e,t,n,i){const{data:a,metadata:o}=e,{viewPlaneNormal:s,viewUp:r}=o,{viewport:l}=i,d=a.cachedStats.projectionPoints,c=[[]],h=this.getTargetImageData(n),g=a.handles.points.map(e=>l.worldToCanvas(e)),u=(0,gt.getCanvasCircleCorners)([g[0],g[1]])[0],m=(0,gt.getCanvasCircleCorners)([g[0],g[1]])[1],p=l.canvasToWorld(u),v=l.canvasToWorld(m),{worldWidth:f,worldHeight:w}=(0,nn.A)(s,r,p,v),E=(0,R.Op)(h,a.handles.points),I=(0,R.CQ)(h),C=Math.abs(Math.PI*(f/E.scale/2)*(w/I/E.scale/2)),b={isPreScaled:(0,jt.u)(l,n),isSuvScaled:this.isSuvScaled(l,n,e.metadata.referencedImageId)},_=(0,ne.j)(o.Modality,e.metadata.referencedImageId,b);for(let e=0;e<d.length;e++){if(!t)continue;const n=d[e][0],i=d[e].map(e=>l.worldToCanvas(e)),[a,o]=(0,gt.getCanvasCircleCorners)([i[0],i[1]]),r=l.canvasToWorld(a),h=l.canvasToWorld(o),g=r,u=h,{dimensions:m,imageData:p,voxelManager:v}=t,f=Ii(p,g),w=Ii(p,n),E=this._getIndexOfCoordinatesForViewplaneNormal(s);f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]),f[E]=w[E];const I=Ii(p,u);if(I[0]=Math.floor(I[0]),I[1]=Math.floor(I[1]),I[2]=Math.floor(I[2]),I[E]=w[E],this._isInsideVolume(f,I,m)){const e=[[Math.min(f[0],I[0]),Math.max(f[0],I[0])],[Math.min(f[1],I[1]),Math.max(f[1],I[1])],[Math.min(f[2],I[2]),Math.max(f[2],I[2])]],t={center:n,xRadius:Math.abs(r[0]-h[0])/2,yRadius:Math.abs(r[1]-h[1])/2,zRadius:Math.abs(r[2]-h[2])/2},i=v.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:e=>(0,an.pointInEllipse)(t,e),boundsIJK:e,imageData:p,returnPoints:this.configuration.storePointData});c.push(i)}}const T=this.configuration.statsCalculator.getStatistics();a.cachedStats.pointsInVolume=c,a.cachedStats.statistics={Modality:o.Modality,area:C,mean:T.mean?.value,stdDev:T.stdDev?.value,max:T.max?.value,statsArray:T.array,areaUnit:E.areaUnit,modalityUnit:_}}_calculateCachedStatsTool(e,t){const n=e.data,{viewport:i}=t,{cachedStats:a}=n,o=this.getTargetId(i),r=s.cache.getVolume(o.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(e,r),this._computePointsInsideVolume(e,r,o,t),e.invalidated=!1,(0,ae.triggerAnnotationModified)(e,i.element),a}_getStartCoordinate(e,t,n){const i=this.configuration.numSlicesToPropagate,a=Math.round(i/2),o=T.eR.create();T.eR.scaleAndAdd(o,e,n,a*-t);return this._getCoordinateForViewplaneNormal(o,n)}_getEndCoordinate(e,t,n){const i=this.configuration.numSlicesToPropagate,a=i-Math.round(i/2),o=T.eR.create();T.eR.scaleAndAdd(o,e,n,a*t);return this._getCoordinateForViewplaneNormal(o,n)}_getIndexOfCoordinatesForViewplaneNormal(e){const t=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])];return t.indexOf(Math.max(...t))}_getCoordinateForViewplaneNormal(e,t){return e[this._getIndexOfCoordinatesForViewplaneNormal(t)]}}function bi(e,t={}){const n=e.cachedStats.statistics,{area:i,mean:a,max:o,stdDev:r,areaUnit:l,modalityUnit:d}=n;if(void 0===a)return;const c=[];return c.push(`Area: ${s.utilities.roundNumber(i)} ${l}`),c.push(`Mean: ${s.utilities.roundNumber(a)} ${d}`),c.push(`Max: ${s.utilities.roundNumber(o)} ${d}`),c.push(`Std Dev: ${s.utilities.roundNumber(r)} ${d}`),c}Ci.toolName="CircleROIStartEndThreshold";var _i=n(48736),Ti=n(49906),Ai=n(84882);const{transformWorldToIndex:Si,isEqual:Mi}=s.utilities;class Di extends Ee.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:r}=o,d=r.getCamera(),{viewPlaneNormal:c}=d,h=he.activeSegmentation.getActiveSegmentation(r.id);if(!h)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:g}=h,u=he.segmentIndex.getActiveSegmentIndex(g),m=he.segmentLocking.getLockedSegmentIndices(g),{representationData:p}=(0,gi.getSegmentation)(g);let v,f,w,E;if(this.doneEditMemo(),r instanceof s.BaseVolumeViewport){const{volumeId:e}=p[l.SegmentationRepresentations.Labelmap],t=s.cache.getVolume(e);({dimensions:v,direction:f}=t),E=t.voxelManager,w=Si(t.imageData,a)}else{const e=(0,gi.getCurrentLabelmapImageIdForViewport)(r.id,g);if(!e)throw new Error("No active segmentation imageId detected, create one before using scissors tool");const{imageData:t}=r.getImageData();v=t.getDimensions(),f=t.getDirection();const n=s.cache.getImage(e);E=n.voxelManager,w=Si(t,a)}const I=this.getFixedDimension(c,f);if(void 0===I)return void console.warn("Oblique paint fill not yet supported");const{floodFillGetter:C,getLabelValue:b,getScalarDataPositionFromPlane:_,inPlaneSeedPoint:T,fixedDimensionValue:A}=this.generateHelpers(E,v,w,I);if(w[0]<0||w[0]>=v[0]||w[1]<0||w[1]>=v[1]||w[2]<0||w[2]>=v[2])return;const S=b(w[0],w[1],w[2]);if(m.includes(S))return;const M=(0,Ai.A)(C,T),{flooded:D}=M;D.forEach(e=>{const t=_(e[0],e[1]);E.setAtIndex(t,u)});const y=this.getFramesModified(I,A,M);return(0,Ti.triggerSegmentationDataModified)(g,y),!0},this.getFramesModified=(e,t,n)=>{const{flooded:i}=n;if(2===e)return[t];let a=1/0,o=-1/0;for(let e=0;e<i.length;e++){const t=i[e][1];t<a&&(a=t),t>o&&(o=t)}const s=[];for(let e=a;e<=o;e++)s.push(e);return s},this.generateHelpers=(e,t,n,i=2)=>{let a,o;switch(i){case 0:a=n[0],o=[n[1],n[2]];break;case 1:a=n[1],o=[n[0],n[2]];break;case 2:a=n[2],o=[n[0],n[1]];break;default:throw new Error(`Invalid fixedDimension: ${i}`)}const s=(t,n,i)=>e.getAtIJK(t,n,i),r=this.generateFloodFillGetter(t,i,a,s);return{getScalarDataPositionFromPlane:this.generateGetScalarDataPositionFromPlane((t,n,i)=>e.toIndex([t,n,i]),i,a),getLabelValue:s,floodFillGetter:r,inPlaneSeedPoint:o,fixedDimensionValue:a}},this.generateFloodFillGetter=(e,t,n,i)=>{let a;switch(t){case 0:a=(t,a)=>{if(!(t>=e[1]||t<0||a>=e[2]||a<0))return i(n,t,a)};break;case 1:a=(t,a)=>{if(!(t>=e[0]||t<0||a>=e[2]||a<0))return i(t,n,a)};break;case 2:a=(t,a)=>{if(!(t>=e[0]||t<0||a>=e[1]||a<0))return i(t,a,n)};break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return a},this.generateGetScalarDataPositionFromPlane=(e,t,n)=>{let i;switch(t){case 0:i=(t,i)=>e(n,t,i);break;case 1:i=(t,i)=>e(t,n,i);break;case 2:i=(t,i)=>e(t,i,n);break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return i}}getFixedDimension(e,t){const n=t.slice(0,3),i=t.slice(3,6),a=t.slice(6,9),o=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],s=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(Mi(o,s))return 0;const r=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];if(Mi(o,r))return 1;const l=[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2])];return Mi(o,l)?2:void 0}}Di.toolName="PaintFill";var yi,Pi=n(25161),xi=n(85825),Ri=n(45700),Li=n(94199);!function(e){e[e.ANNOTATED_CUBE=1]="ANNOTATED_CUBE",e[e.AXES=2]="AXES",e[e.CUSTOM=3]="CUSTOM"}(yi||(yi={}));class Oi extends Ee.oS{static{this.CUBE=1}static{this.AXIS=2}static{this.VTPFILE=3}static{this.OVERLAY_MARKER_TYPES=yi}constructor(e={},t={configuration:{orientationWidget:{enabled:!0,viewportCorner:Pi.Ay.Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:100,maxPixelSize:300},overlayMarkerType:Oi.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:{[Oi.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE]:{faceProperties:{xPlus:{text:"L",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"R",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"S"},zMinus:{text:"I"}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}},[Oi.OVERLAY_MARKER_TYPES.AXES]:{},[Oi.OVERLAY_MARKER_TYPES.CUSTOM]:{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}}}}){super(e,t),this._resizeObservers=new Map,this.onSetToolEnabled=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolActive=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolDisabled=()=>{this.cleanUpData(),this._unsubscribeToViewportNewVolumeSet()},this._getViewportsInfo=()=>(0,I.getToolGroup)(this.toolGroupId).viewportsInfo,this.resize=e=>{const t=this.orientationMarkers[e];if(!t)return;const{orientationWidget:n}=t;n.updateViewport()},this.orientationMarkers={},this.updatingOrientationMarker={}}_unsubscribeToViewportNewVolumeSet(){const e=()=>{this._getViewportsInfo().forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,s.getEnabledElementByIds)(e,t),{element:i}=n;i.removeEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this));this._resizeObservers.get(e).unobserve(i)})};s.eventTarget.removeEventListener(l.Events.TOOLGROUP_VIEWPORT_ADDED,t=>{t.detail.toolGroupId===this.toolGroupId&&(e(),this.initViewports())})}_subscribeToViewportEvents(){const e=()=>{this._getViewportsInfo().forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,s.getEnabledElementByIds)(e,t),{element:i}=n;this.initViewports(),i.addEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this));const a=new ResizeObserver(()=>{setTimeout(()=>{const n=(0,s.getEnabledElementByIds)(e,t);if(!n)return;const{viewport:i}=n;this.resize(e),i.render()},100)});a.observe(i),this._resizeObservers.set(e,a)})};e(),s.eventTarget.addEventListener(l.Events.TOOLGROUP_VIEWPORT_ADDED,t=>{t.detail.toolGroupId===this.toolGroupId&&(e(),this.initViewports())})}cleanUpData(){(0,s.getRenderingEngines)()[0].getViewports().forEach(e=>{const t=this.orientationMarkers[e.id];if(!t)return;const{actor:n,orientationWidget:i}=t;i?.setEnabled(!1),i?.delete(),n?.delete();e.getRenderingEngine().getOffscreenMultiRenderWindow(e.id).getRenderWindow().render(),e.getRenderingEngine().render(),delete this.orientationMarkers[e.id]})}initViewports(){const e=(0,s.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,W.filterViewportsWithToolEnabled)(t,this.getToolName()),t.forEach(e=>{const t=e.getWidget(this.getToolName());t&&!t.isDeleted()||this.addAxisActorInViewport(e)})}async addAxisActorInViewport(e){const t=e.id;if(!this.updatingOrientationMarker[t]){this.updatingOrientationMarker[t]=!0;const n=this.configuration.overlayMarkerType,i=this.configuration.overlayConfiguration[n];if(this.orientationMarkers[t]){const{actor:n,orientationWidget:i}=this.orientationMarkers[t];e.getRenderer().removeActor(n),i.setEnabled(!1)}let a;1===n?a=this.createAnnotationCube(i):2===n?a=Ri.Ay.newInstance():3===n&&(a=await this.createCustomActor());const o=e.getRenderer(),s=e.getRenderingEngine().getOffscreenMultiRenderWindow(t).getRenderWindow(),{enabled:r,viewportCorner:l,viewportSize:d,minPixelSize:c,maxPixelSize:h}=this.configuration.orientationWidget,g=Pi.Ay.newInstance({actor:a,interactor:s.getInteractor(),parentRenderer:o});g.setEnabled(r),g.setViewportCorner(l),g.setViewportSize(d),g.setMinPixelSize(c),g.setMaxPixelSize(h),g.updateMarkerOrientation(),this.orientationMarkers[t]={orientationWidget:g,actor:a},e.addWidget(this.getToolName(),g),s.render(),e.getRenderingEngine().render(),this.updatingOrientationMarker[t]=!1}}async createCustomActor(){const e=this.configuration.overlayConfiguration[yi.CUSTOM].polyDataURL,t=await fetch(e),n=await t.arrayBuffer(),i=Li.Ay.newInstance();i.parseAsArrayBuffer(n),i.update();const a=_e.Ay.newInstance();a.shallowCopy(i.getOutputData()),a.getPointData().setActiveScalars("Color");const o=De.Ay.newInstance();o.setInputData(a),o.setColorModeToDirectScalars();const s=Se.Ay.newInstance();return s.setMapper(o),s.rotateZ(180),s}createAnnotationCube(e){const t=xi.Ay.newInstance();return t.setDefaultStyle({...e.defaultStyle}),t.setXPlusFaceProperty({...e.faceProperties.xPlus}),t.setXMinusFaceProperty({...e.faceProperties.xMinus}),t.setYPlusFaceProperty({...e.faceProperties.yPlus}),t.setYMinusFaceProperty({...e.faceProperties.yMinus}),t.setZPlusFaceProperty({...e.faceProperties.zPlus}),t.setZMinusFaceProperty({...e.faceProperties.zMinus}),t}async createAnnotatedCubeActor(){const e=xi.Ay.newInstance(),{faceProperties:t,defaultStyle:n}=this.configuration.annotatedCube;return e.setDefaultStyle(n),Object.keys(t).forEach(n=>{const i=`set${n.charAt(0).toUpperCase()+n.slice(1)}FaceProperty`;e[i](t[n])}),e}}Oi.toolName="OrientationMarker";var Ui=n(26228),ki=n(70930);class Ni extends Ee.oS{static{this.SelectMode={Inside:"Inside",Border:"Border"}}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{hoverTimeout:100,mode:Ni.SelectMode.Border,searchRadius:6}}){super(e,t),this.mouseMoveCallback=e=>{if(this.mode===l.ToolModes.Active)return this.hoverTimer&&clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout(()=>{this._setActiveSegment(e),this.hoverTimer=null},this.configuration.hoverTimeout),!0},this.onSetToolEnabled=()=>{this.onSetToolActive()},this.onSetToolActive=()=>{this.hoverTimer=null},this.onSetToolDisabled=()=>{this.hoverTimer=null},this.hoverTimer=null}_setActiveSegment(e={}){if(w.wk.isInteractingWithTool)return;const{element:t,currentPoints:n}=e.detail,i=n.world,a=(0,s.getEnabledElement)(t);if(!a)return;const{viewport:o}=a,r=(0,Ui.getActiveSegmentation)(o.id);r&&this._setActiveSegmentForType(r,i,o)}_setActiveSegmentForType(e,t,n){if(!n.getImageData())return;const{segmentationId:i,representationData:a}=e;let o;if(this.configuration.mode===Ni.SelectMode.Inside?o=(0,U.getSegmentIndexAtWorldPoint)(i,t,{viewport:n}):a.Labelmap?o=(0,U.getSegmentIndexAtLabelmapBorder)(i,t,{viewport:n,searchRadius:this.configuration.searchRadius}):a.Contour?o=(0,U.getHoveredContourSegmentationAnnotation)(i):a.Surface,!o||0===o)return;(0,ki.setActiveSegmentIndex)(i,o);const s=n.getRenderingEngine().getViewports().map(e=>e.id);(0,Ti.triggerSegmentationModified)(i),(0,L.A)(s)}}Ni.toolName="SegmentSelectTool";var Vi=n(93733);class Wi extends Wt.A{static{this.toolName="SegmentBidirectional"}constructor(e={}){super(e),this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:i}=e,{element:a}=i,o=i.id;let s=(0,r.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const l=this.getTargetId(i),d=i.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<s.length;a++){const r=s[a],{annotationUID:h,data:g}=r,{points:u,activeHandleIndex:m}=g.handles,p=u.map(e=>i.worldToCanvas(e));c.annotationUID=h;const{segmentIndex:v,segmentationId:f}=r.metadata,{lineWidth:w,lineDash:E,shadow:I}=this.getAnnotationStyle({annotation:r,styleSpecifier:c}),C=`rgb(${(0,Vi.getSegmentIndexColor)(o,f,v).slice(0,3).join(",")})`;if(g.cachedStats[l]&&null!=g.cachedStats[l].unit?r.invalidated&&this._throttledCalculateCachedStats(r,d,e):(g.cachedStats[l]={length:null,width:null,unit:null},this._calculateCachedStats(r,d,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let b;if(!(0,ht.isAnnotationVisible)(h))continue;if((0,Be.isAnnotationLocked)(h)||this.editData||null===m||(b=[p[m]]),b){const e="0";(0,D.drawHandles)(t,h,e,b,{color:C})}const _=`${h}-line-1`,T=`${h}-line-2`,A="0";(0,D.drawLine)(t,h,A,p[0],p[1],{color:C,lineWidth:w,lineDash:E,shadow:I},_);const S="1";(0,D.drawLine)(t,h,S,p[2],p[3],{color:C,lineWidth:w,lineDash:E,shadow:I},T),n=!0;const M=this.getLinkedTextBoxStyle(c,r);if(!M.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}M.color=C;const y=this.configuration.getTextLines(g,l);if(!y||0===y.length)continue;let P;g.handles.textBox.hasMoved||(P=(0,k.getTextBoxCoordsCanvas)(p),g.handles.textBox.worldPosition=i.canvasToWorld(P));const x=i.worldToCanvas(g.handles.textBox.worldPosition),R="1",L=(0,D.drawLinkedTextBox)(t,h,R,y,x,p,{},M),{x:O,y:U,width:N,height:V}=L;g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([O,U]),topRight:i.canvasToWorld([O+N,U]),bottomLeft:i.canvasToWorld([O,U+V]),bottomRight:i.canvasToWorld([O+N,U+V])}}return n}}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:l}=o;this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.getReferencedImageId(l,a,c,h),u=l.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:u,referencedImageId:g,...l.getViewReference({points:[a]})},data:{handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};(0,r.addAnnotation)(m,i);const p=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:p,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(p),m}static{this.hydrate=(e,t,n)=>{const i=(0,s.getEnabledElementByViewportId)(e);if(!i)return;const{viewport:a}=i,o=(0,r.getAllAnnotations)().filter(e=>"SegmentBidirectional"===e.metadata.toolName),l=o.find(e=>{const{metadata:t}=e;return t.segmentIndex===n?.segmentIndex&&t.segmentationId===n?.segmentationId});l&&(0,r.removeAnnotation)(l.annotationUID);const{FrameOfReferenceUID:d,referencedImageId:c,viewPlaneNormal:h,instance:g}=this.hydrateBase(Wi,i,t[0],n),[u,m]=t,[p,v]=u,[f,w]=m,E=[p,v,f,w],{toolInstance:I,...C}=n||{},b={annotationUID:n?.annotationUID||s.utilities.uuidv4(),data:{handles:{points:E,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{segmentIndex:n?.segmentIndex,segmentationId:n?.segmentationId,toolName:g.getToolName(),viewPlaneNormal:h,FrameOfReferenceUID:d,referencedImageId:c,...C}};return(0,r.addAnnotation)(b,a.element),(0,L.A)([a.id]),b}}}n(99522);class Bi extends Ee.oS{constructor(e={data:{handles:{textBox:{worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{hoverTimeout:100,searchRadius:6,color:null,background:null}}){super(e,t),this.mouseMoveCallback=e=>(this.hoverTimer&&clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout(()=>{this._setHoveredSegment(e),this.hoverTimer=null},this.configuration.hoverTimeout),!0),this.onSetToolEnabled=()=>{this.onSetToolActive()},this.onSetToolActive=()=>{this.hoverTimer=null},this.onSetToolDisabled=()=>{this.hoverTimer=null},this.data=e.data??{handles:{textBox:{worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}},this.hoverTimer=null}_setHoveredSegment(e={}){if(w.wk.isInteractingWithTool)return;const{element:t,currentPoints:n}=e.detail,i=n.world,a=(0,s.getEnabledElement)(t);if(!a)return;const{viewport:o}=a,r=(0,Ui.getActiveSegmentation)(o.id);r&&this._setHoveredSegmentForType(r,i,o)}_setHoveredSegmentForType(e,t,n){if(!n.getImageData())return;const{segmentationId:i}=e,a=(0,U.getSegmentIndexAtWorldPoint)(i,t,{viewport:n}),o=e.segments[a],s=this.configuration.color??he.config.color.getSegmentIndexColor(n.id,i,a),r=o?.label,l=n.worldToCanvas(t);if(this._editData={hoveredSegmentIndex:a,hoveredSegmentLabel:r,canvasCoordinates:l,color:s},!a||0===a)return;const d=n.getRenderingEngine().getViewports().map(e=>e.id);(0,Ti.triggerSegmentationModified)(i),(0,L.A)(d)}renderAnnotation(e,t){if(!this._editData)return;const{viewport:n}=e,{hoveredSegmentIndex:i,hoveredSegmentLabel:a,canvasCoordinates:o,color:s}=this._editData;if(!i)return;const r=[o[0]+-15,o[1]+-15],l=(0,D.drawTextBox)(t,"segmentSelectLabelAnnotation","segmentSelectLabelTextBox",[a??"(unnamed segment)"],r,{color:`rgba(${s[0]}, ${s[1]}, ${s[2]}, ${s[3]})`,background:this.configuration.background??void 0}),d=o[0],c=o[1],{width:h,height:g}=l;this.data.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([d,c]),topRight:n.canvasToWorld([d+h,c]),bottomLeft:n.canvasToWorld([d,c+g]),bottomRight:n.canvasToWorld([d+h,c+g])}}}Bi.toolName="SegmentLabelTool";var Hi=n(93210);class Gi extends An.A{static{this.toolName="LabelMapEditWithContour"}static{this.annotationsToViewportMap=new Map}static{this.viewportIdsChecked=[]}constructor(e={}){super(s.utilities.deepMerge({configuration:{calculateStats:!1,allowOpenContours:!1}},e)),this.onViewportAddedToToolGroupBinded=this.onViewportAddedToToolGroup.bind(this),this.onSegmentationModifiedBinded=this.onSegmentationModified.bind(this)}initializeListeners(){Gi.annotationsToViewportMap.clear(),Gi.viewportIdsChecked=[],s.eventTarget.addEventListener(l.Events.ANNOTATION_MODIFIED,this.annotationModified),s.eventTarget.addEventListener(l.Events.ANNOTATION_COMPLETED,this.annotationCompleted),s.eventTarget.addEventListener(l.Events.TOOLGROUP_VIEWPORT_ADDED,this.onViewportAddedToToolGroupBinded),s.eventTarget.addEventListener(l.Events.SEGMENTATION_MODIFIED,this.onSegmentationModifiedBinded),s.eventTarget.addEventListener(l.Events.SEGMENTATION_REPRESENTATION_MODIFIED,this.onSegmentationModifiedBinded)}cleanUpListeners(){Gi.annotationsToViewportMap.clear(),Gi.viewportIdsChecked=[],s.eventTarget.removeEventListener(l.Events.ANNOTATION_MODIFIED,this.annotationModified),s.eventTarget.removeEventListener(l.Events.ANNOTATION_COMPLETED,this.annotationCompleted),s.eventTarget.removeEventListener(l.Events.TOOLGROUP_VIEWPORT_ADDED,this.onViewportAddedToToolGroup.bind(this)),s.eventTarget.removeEventListener(l.Events.SEGMENTATION_MODIFIED,this.onSegmentationModified.bind(this)),s.eventTarget.removeEventListener(l.Events.SEGMENTATION_REPRESENTATION_MODIFIED,this.onSegmentationModified.bind(this))}async checkContourSegmentation(e){if(Gi.viewportIdsChecked.includes(e))return;const t=he.getActiveSegmentation(e);if(!t)return console.log("No active segmentation detected"),!1;const n=t.segmentationId;return t.representationData.Contour?Gi.viewportIdsChecked.push(e):(Gi.viewportIdsChecked.push(e),await he.addContourRepresentationToViewport(e,[{segmentationId:n,type:l.SegmentationRepresentations.Contour}]),he.addRepresentationData({segmentationId:n,type:l.SegmentationRepresentations.Contour,data:{}})),!0}onViewportAddedToToolGroup(e){const{toolGroupId:t,viewportId:n}=e.detail;t===this.toolGroupId&&this.checkContourSegmentation(n)}onSegmentationModified(e){const{segmentationId:t}=e.detail||{};if(!t)return;const n=(0,Hi.ny)(t);n&&n.forEach(async({viewportId:e})=>await this.checkContourSegmentation(e))}onSetToolEnabled(){this.initializeListeners()}onSetToolActive(){this.initializeListeners()}onSetToolDisabled(){this.cleanUpListeners()}annotationModified(e){const{annotation:t,renderingEngineId:n,viewportId:i}=e.detail,a=(0,s.getRenderingEngine)(n)?.getViewport(i);a&&Gi.annotationsToViewportMap.set(t.annotationUID,a)}annotationCompleted(e){const{annotation:t}=e.detail,{polyline:n}=t.data?.contour||{};if(t?.metadata?.toolName===Gi.toolName&&n&&Gi.annotationsToViewportMap.has(t.annotationUID)){const e=Gi.annotationsToViewportMap.get(t.annotationUID);n.length>3&&_i.A.viewportContoursToLabelmap(e)}}}var Fi=n(33657);class zi extends Ee.EC{static{this.toolName="VideoRedaction"}constructor(e={}){super(e,{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,s.getEnabledElement)(i),{viewport:r}=o;this.isDrawing=!0;const l=this.constructor.createAnnotationForViewport(r,{data:{handles:{points:[[...a],[...a],[...a],[...a]]}}});(0,E.lC)(l,i);const d=(0,W.getViewportIdsWithToolToRender)(i,this.getToolName(),!1);return this.editData={annotation:l,viewportUIDsToRender:d,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,Ve.hideElementCursor)(i),e.preventDefault(),(0,L.A)(d),l},this.getHandleNearImagePoint=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,{points:l}=r.handles;for(let e=0;e<l.length;e++){const t=l[e],a=o.worldToCanvas(t);if(!0===T.Zc.distance(n,a)<i)return r.handles.activeHandleIndex=e,t}r.handles.activeHandleIndex=null},this.isPointNearTool=(e,t,n,i)=>{const a=(0,s.getEnabledElement)(e),{viewport:o}=a,{data:r}=t,{points:l}=r.handles,d=o.worldToCanvas(l[0]),c=o.worldToCanvas(l[3]),h=this._getRectangleImageCoordinates([d,c]),g=[n[0],n[1]],{left:u,top:m,width:p,height:v}=h;if(Fi.distanceToPoint([u,m,p,v],g)<=i)return!0},this.toolSelectedCallback=(e,t,n="mouse")=>{const i=e.detail,{element:a}=i,{data:o}=t;o.active=!0;const s=(0,W.getViewportIdsWithToolToRender)(a,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:s},this._activateModify(a),(0,Ve.hideElementCursor)(a),(0,L.A)(s),e.preventDefault()},this.handleSelectedCallback=(e,t,n,i="mouse")=>{const a=e.detail,{element:o}=a,{data:s}=t;s.active=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,W.getViewportIdsWithToolToRender)(o,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:d,handleIndex:r},this._activateModify(o),(0,Ve.hideElementCursor)(o),(0,L.A)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:a,newAnnotation:o,hasMoved:s}=this.editData,{data:r}=i;o&&!s||(this.doneEditMemo(),r.active=!1,r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,Ve.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,E.O8)(i.annotationUID),(0,L.A)(a))},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:a,handleIndex:o,newAnnotation:r}=this.editData;this.createMemo(n,i,{newAnnotation:r});const{data:l}=i;if(void 0===o){const{deltaPoints:e}=t,n=e.world,{points:i}=l.handles;i.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),l.invalidated=!0}else{const{currentPoints:e}=t,i=(0,s.getEnabledElement)(n),{worldToCanvas:a,canvasToWorld:r}=i.viewport,d=e.world,{points:c}=l.handles;let h,g,u,m,p,v,f,w;switch(c[o]=[...d],o){case 0:case 3:h=a(c[0]),m=a(c[3]),g=[m[0],h[1]],u=[h[0],m[1]],v=r(g),f=r(u),c[1]=v,c[2]=f;break;case 1:case 2:g=a(c[1]),u=a(c[2]),h=[u[0],g[1]],m=[g[0],u[1]],p=r(h),w=r(m),c[0]=p,c[3]=w}l.invalidated=!0}this.editData.hasMoved=!0;(0,s.getEnabledElement)(n);(0,L.A)(a)},this._activateDraw=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._activateModify=e=>{w.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{w.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{const n=!1,{viewport:i}=e,{element:a}=i;let o=(0,E.Rh)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<o.length;e++){const n=o[e],{annotationUID:a}=n,r=n.data,{points:l,activeHandleIndex:d}=r.handles,c=l.map(e=>i.worldToCanvas(e)),h=this.getStyle("lineWidth",s,n),g=this.getStyle("lineDash",s,n),u=this.getStyle("color",s,n);if(!i.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");let m;if(this.editData||null===d||(m=[c[d]]),m){const e="0";(0,D.drawHandles)(t,a,e,m,{color:u})}const p="0";(0,D.drawRedactionRect)(t,a,p,c[0],c[3],{color:"black",lineDash:g,lineWidth:h})}},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,i,a)=>{const{data:o}=e,{viewportUID:r,renderingEngineUID:d,sceneUID:c}=a,h=o.handles.points[0],g=o.handles.points[3],{cachedStats:u}=o,m=Object.keys(u);for(let e=0;e<m.length;e++){const a=m[e],{imageVolume:o}=this._getImageVolumeFromTargetUID(a,i),{dimensions:s,scalarData:r,vtkImageData:l,metadata:d}=o,c=T.eR.fromValues(0,0,0),p=T.eR.fromValues(0,0,0);if(l.worldToIndexVec3(h,c),c[0]=Math.floor(c[0]),c[1]=Math.floor(c[1]),c[2]=Math.floor(c[2]),l.worldToIndexVec3(g,p),p[0]=Math.floor(p[0]),p[1]=Math.floor(p[1]),p[2]=Math.floor(p[2]),this._isInsideVolume(c,p,s)){this.isHandleOutsideImage=!1;const e=Math.min(c[0],p[0]),i=Math.max(c[0],p[0]),o=Math.min(c[1],p[1]),l=Math.max(c[1],p[1]),m=Math.min(c[2],p[2]),v=Math.max(c[2],p[2]),{worldWidth:f,worldHeight:w}=(0,nn.A)(t,n,h,g),E=f*w;let I=0,C=0,b=0;const _=s[0],T=s[0]*s[1];for(let t=m;t<=v;t++)for(let n=o;n<=l;n++)for(let a=e;a<=i;a++){I++,C+=r[t*T+n*_+a]}C/=I;for(let t=m;t<=v;t++)for(let n=o;n<=l;n++)for(let a=e;a<=i;a++){const e=r[t*T+n*_+a]-C;b+=e*e}b/=I,b=Math.sqrt(b),u[a]={Modality:d.Modality,area:E,mean:C,stdDev:b}}else this.isHandleOutsideImage=!0,u[a]={Modality:d.Modality}}const p=e.invalidated;if(e.invalidated=!1,p){const t=l.Events.ANNOTATION_MODIFIED,n={annotation:e,viewportUID:r,renderingEngineUID:d,sceneUID:c,changeType:l.ChangeTypes.StatsUpdated};(0,s.triggerEvent)(s.eventTarget,t,n)}return u},this._isInsideVolume=(e,t,n)=>s.utilities.indexWithinDimensions(e,n)&&s.utilities.indexWithinDimensions(t,n),this._getTargetVolumeUID=e=>{if(this.configuration.volumeUID)return this.configuration.volumeUID;const t=e.getVolumeActors();return t||t.length?t[0].uid:void 0},this._throttledCalculateCachedStats=(0,P.A)(this._calculateCachedStats,100,{trailing:!0})}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,Ve.resetElementCursor)(e);const{annotation:t,viewportUIDsToRender:n}=this.editData,{data:i}=t;return i.active=!1,i.handles.activeHandleIndex=null,(0,L.A)(n),this.editData=null,t.annotationUID}_getImageVolumeFromTargetUID(e,t){let n;if(e.startsWith("stackTarget")){const i=e.indexOf(":"),a=e.substring(i+1);n=t.getViewport(a).getImageData()}else n=s.cache.getVolume(e);return{imageVolume:n,viewport:undefined}}_getTargetStackUID(e){return`stackTarget:${e.uid}`}}var Xi=n(58498),$i=n(42008),Zi=n(28906);const Yi=1,ji=-1,qi=new Set;const Ki={};function Ji(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,Ki,n),Zi.m.obj(e,t),Zi.m.algo(e,t,1,1),function(e){e.requestData=(t,n)=>{const[i]=t;n[0]||(n[0]=_e.Ay.newInstance());const[a]=n;e.extractContours(i,a),a.modified()},e.traverseLoop=(e,t,n,i,a)=>{let o=n,s=i,r=!1,l=0;for(;!r;){const{cellPointIds:n}=e.getCellPoints(o);if(!n)continue;s=n[0]!==s?n[0]:n[1],l++;const d=t*l;a.push({t:d,ptId:s});const c=e.getPointCells(s);if(2!==c.length||s===i)return s;2===c.length?(o=c[0]!==o?c[0]:c[1],qi.add(o)):r=!0}return s},e.extractContours=(t,n)=>{const i=[];qi.clear();const a=t.getLines();n.getPoints().setData(Float32Array.from(t.getPoints().getData()));for(let n=0;n<a.getNumberOfCells();n++){if(qi.has(n))continue;const{cellPointIds:a}=t.getCellPoints(n);if(!a)continue;qi.add(n);const o=a[0],s=[];s.push({t:0,ptId:o}),o!==e.traverseLoop(t,Yi,n,o,s)&&(e.traverseLoop(t,ji,n,o,s),s.sort((e,t)=>e.t<t.t?-1:1),s.length&&s[0].ptId!==s[s.length-1]?.ptId&&s.push({...s[s.length-1]})),s.length&&i.push(s)}const o=n.getLines();o.resize(0),i.forEach(e=>{o.insertNextCell(e.map(e=>e.ptId))})}}(e)}var Qi={newInstance:Zi.m.newInstance(Ji,"vtkContourLoopExtraction"),extend:Ji},ea=n(61088);const{math:{polyline:{containsPoint:ta,getAABB:na,projectTo2D:ia}},geometricSurfaceUtils:{checkStandardBasis:aa,rotatePoints:oa},boundingBox:{getBoundingBoxAroundShapeWorld:sa},planar:{isPlaneIntersectingAABB:ra}}=a;const la={polySeg:null,polySegInitializing:!1,polySegInitializingPromise:null,async initializePolySeg(e){let t;try{t=(await async function(e){try{if("@icr/polyseg-wasm"===e)return n.e(7758).then(n.bind(n,65745))}catch(e){return console.warn("Error importing module:",e),null}}("@icr/polyseg-wasm")).default}catch(e){return console.error(e),void console.debug("Warning: '@icr/polyseg-wasm' module not found. Please install it separately.")}this.polySegInitializing?await this.polySegInitializingPromise:this.polySeg?.instance||(this.polySegInitializing=!0,this.polySegInitializingPromise=new Promise(n=>{this.polySeg=new t,this.polySeg.initialize({updateProgress:e}).then(()=>{this.polySegInitializing=!1,n()})}),await this.polySegInitializingPromise)},async convertContourToSurface(e,...t){const{polylines:n,numPointsArray:i}=e,[a]=t;await this.initializePolySeg(a);return await this.polySeg.instance.convertContourRoiToSurface(n,i)},async convertLabelmapToSurface(e,...t){const[n]=t;await this.initializePolySeg(n);const i=this.polySeg.instance.convertLabelmapToSurface(e.scalarData,e.dimensions,e.spacing,e.direction,e.origin,[e.segmentIndex]),a=aa(e.direction);if(!a.isStandard){const t=oa(a.rotationMatrix,e.origin,i.points);i.points=[...t]}return i},async convertContourToVolumeLabelmap(e,...t){const[n]=t;await this.initializePolySeg(n);const{segmentIndices:i,scalarData:a,annotationUIDsInSegmentMap:o,dimensions:r,origin:l,direction:d,spacing:c}=e,h=s.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:r,scalarData:a}),g=Xi.Ay.newInstance();g.setDimensions(r),g.setOrigin(l),g.setDirection(d),g.setSpacing(c);const u=$i.Ay.newInstance({name:"Pixels",numberOfComponents:1,values:a});g.getPointData().setScalars(u),g.modified();for(const e of i){const t=o.get(e);for(const n of t){if(!n.polyline)continue;const{polyline:t,holesPolyline:i}=n,o=sa(t),[l,d,c]=s.utilities.transformWorldToIndex(g,[o[0][0],o[1][0],o[2][0]]),[u,m,p]=s.utilities.transformWorldToIndex(g,[o[0][1],o[1][1],o[2][1]]),{projectedPolyline:v,sharedDimensionIndex:f}=ia(t),w=i?.map(e=>{const{projectedPolyline:t}=ia(e);return t}),E=(f+1)%3,I=(f+2)%3;s.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:r,scalarData:a}).forEach(({pointIJK:t})=>{h.setAtIJKPoint(t,e)},{imageData:g,isInObject:e=>{const t=[e[E],e[I]];return ta(v,t,{holes:w})},boundsIJK:[[l,u],[d,m],[c,p]]})}}return h.scalarData},async convertContourToStackLabelmap(e,...t){const[n]=t;await this.initializePolySeg(n);const{segmentationsInfo:i,annotationUIDsInSegmentMap:a,segmentIndices:o}=e,r=new Map;i.forEach((e,t)=>{const{dimensions:n,scalarData:i,direction:a,spacing:o,origin:l}=e,d=s.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:n,scalarData:i}),c=Xi.Ay.newInstance();c.setDimensions(n),c.setOrigin(l),c.setDirection(a),c.setSpacing(o);const h=$i.Ay.newInstance({name:"Pixels",numberOfComponents:1,values:i});c.getPointData().setScalars(h),c.modified(),r.set(t,{manager:d,imageData:c})});for(const e of o){const t=a.get(e);for(const n of t){if(!n.polyline)continue;const{polyline:t,holesPolyline:i,referencedImageId:a}=n,o=sa(t),{manager:l,imageData:d}=r.get(a),[c,h,g]=s.utilities.transformWorldToIndex(d,[o[0][0],o[1][0],o[2][0]]),[u,m,p]=s.utilities.transformWorldToIndex(d,[o[0][1],o[1][1],o[2][1]]),{projectedPolyline:v,sharedDimensionIndex:f}=ia(t),w=i?.map(e=>{const{projectedPolyline:t}=ia(e);return t}),E=(f+1)%3,I=(f+2)%3;s.utilities.VoxelManager.createImageVoxelManager({width:d.getDimensions()[0],height:d.getDimensions()[1],scalarData:d.getPointData().getScalars().getData()}).forEach(({pointIJK:t})=>{l.setAtIJKPoint(t,e)},{imageData:d,isInObject:e=>{const t=[e[E],e[I]];return ta(v,t,{holes:w})},boundsIJK:[[c,u],[h,m],[g,p]]})}}return i.forEach((e,t)=>{const{manager:n}=r.get(t);e.scalarData=n.scalarData}),i},async convertSurfaceToVolumeLabelmap(e,...t){const[n]=t;await this.initializePolySeg(n);return this.polySeg.instance.convertSurfaceToLabelmap(e.points,e.polys,e.dimensions,e.spacing,e.direction,e.origin)},async convertSurfacesToVolumeLabelmap(e,...t){const[n]=t;await this.initializePolySeg(n);const{segmentsInfo:i}=e,a=Array.from(i.keys()).map(t=>{const{points:n,polys:a}=i.get(t);return{...this.polySeg.instance.convertSurfaceToLabelmap(n,a,e.dimensions,e.spacing,e.direction,e.origin),segmentIndex:t}}),o=await Promise.all(a),r=Xi.Ay.newInstance();r.setDimensions(e.dimensions),r.setOrigin(e.origin),r.setSpacing(e.spacing),r.setDirection(e.direction);const l=e.dimensions[0]*e.dimensions[1]*e.dimensions[2],d=$i.Ay.newInstance({name:"Pixels",numberOfComponents:1,values:new Uint8Array(l)});r.getPointData().setScalars(d),r.modified();const{dimensions:c}=e,h=r.getPointData().getScalars().getData(),g=s.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:c,scalarData:h}),u=o.map(e=>{const{data:t,dimensions:n,direction:i,origin:a,spacing:o}=e,r=Xi.Ay.newInstance();r.setDimensions(n),r.setOrigin(a),r.setSpacing(o),r.setDirection(i);const l=$i.Ay.newInstance({name:"Pixels",numberOfComponents:1,values:t});r.getPointData().setScalars(l),r.modified();const d=s.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:n,scalarData:t}),c=r.getExtent();return{volume:r,voxelManager:d,extent:c,scalarData:t,segmentIndex:e.segmentIndex}});return s.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:r.getDimensions(),scalarData:r.getPointData().getScalars().getData()}).forEach(({pointIJK:e,pointLPS:t})=>{try{for(const n of u){const{volume:i,extent:a,voxelManager:o,segmentIndex:s}=n,r=i.worldToIndex(t);if(r[0]<a[0]||r[0]>a[1]||r[1]<a[2]||r[1]>a[3]||r[2]<a[4]||r[2]>a[5])continue;const l=r.map(Math.round);if(o.getAtIJK(...l)>0){g.setAtIJKPoint(e,s);break}}}catch(e){}},{imageData:r}),g.scalarData},getSurfacesAABBs({surfacesInfo:e}){const t=new Map;for(const{points:n,id:i}of e){const e=na(n,{numDimensions:3});t.set(i,e)}return t},cutSurfacesIntoPlanes({planesInfo:e,surfacesInfo:t,surfacesAABB:n=new Map},i,a){const o=e.length,s=ea.Ay.newInstance(),r=ye.Ay.newInstance();s.setCutFunction(r);const l=_e.Ay.newInstance();try{for(const[d,c]of e.entries()){const{sliceIndex:e,planes:h}=c,g=new Map;for(const e of t){const{points:t,polys:i,id:a,segmentIndex:o}=e,d=n.get(a)||na(t,{numDimensions:3});n.has(a)||n.set(a,d);const{minX:c,minY:u,minZ:m,maxX:p,maxY:v,maxZ:f}=d,{origin:w,normal:E}=h[0];if(!ra(w,E,c,u,m,p,v,f))continue;l.getPoints().setData(t,3),l.getPolys().setData(i),l.modified(),s.setInputData(l),r.setOrigin(w),r.setNormal(E);try{s.update()}catch(e){console.warn("Error during clipping",e);continue}const I=s.getOutputData();if(!I||!I.getPoints()||0===I.getPoints().getNumberOfPoints())continue;const C=I;C.buildLinks();const b=Qi.newInstance();b.setInputData(C);try{b.update();const e=b.getOutputData();e&&e.getPoints()&&e.getLines()&&e.getPoints().getNumberOfPoints()>0&&e.getLines().getNumberOfCells()>0&&g.set(o,{points:e.getPoints().getData(),lines:e.getLines().getData(),numberOfCells:e.getLines().getNumberOfCells(),segmentIndex:o})}catch(e){console.warn("Error during loop extraction:",e);continue}}i({progress:(d+1)/o}),a({sliceIndex:e,polyDataResults:g})}}catch(e){console.warn("Error during processing",e)}finally{t=null,r.delete()}}};(0,o.p)(la)},93952:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]]},18262:(e,t,n)=>{"use strict";n.d(t,{A:()=>h});var i=n(85204),a=n(15327);const o="viewport-element";function s(e,t){if(i.wk.svgNodeCache[e])return i.wk.svgNodeCache[e][t]?i.wk.svgNodeCache[e][t].domRef:void 0}function r(e,t,n,a){if(!i.wk.svgNodeCache[t])return null;i.wk.svgNodeCache[t][a]={touched:!0,domRef:n},e.appendChild(n)}function l(e,t){i.wk.svgNodeCache[e]&&i.wk.svgNodeCache[e][t]&&(i.wk.svgNodeCache[e][t].touched=!0)}function d(e,t){i.wk.svgNodeCache[t]&&Object.keys(i.wk.svgNodeCache[t]).forEach(n=>{const a=i.wk.svgNodeCache[t][n];!a.touched&&a.domRef&&(e.removeChild(a.domRef),delete i.wk.svgNodeCache[t][n])})}const c=function(e){const t=(0,a.getEnabledElement)(e),{viewportId:n,renderingEngineId:c}=t,h=`${n}:${c}`,g=function(e){const t=`.${o}`,n=e.querySelector(t),i=n?.querySelector(":scope > .svg-layer");return i}(e);return Object.keys(i.wk.svgNodeCache[h]).forEach(e=>{i.wk.svgNodeCache[h][e].touched=!1}),{svgLayerElement:g,svgNodeCacheForCanvas:i.wk.svgNodeCache,getSvgNode:s.bind(this,h),appendNode:r.bind(this,g,h),setNodeTouched:l.bind(this,h),clearUntouched:d.bind(this,g,h)}};const h=function(e,t){const n=c(e);t(n),n.clearUntouched()}},12004:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n(97181),a=n(85899),o=n(56442);const s=function(e,t,n,s,r,l={},d=""){const{color:c,fill:h,width:g,lineWidth:u,lineDash:m,fillOpacity:p,strokeOpacity:v}=Object.assign({color:"rgb(0, 255, 0)",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},l),f=u||g,w=(0,i.A)(t,"circle",n),E=e.getSvgNode(w),I={cx:`${s[0]}`,cy:`${s[1]}`,r:`${r}`,stroke:c,fill:h,"stroke-width":f,"stroke-dasharray":m,"fill-opacity":p,"stroke-opacity":v};if(E)(0,a.A)(I,E),e.setNodeTouched(w);else{const t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==d&&t.setAttribute("data-id",d),(0,o.A)(I,t),e.appendNode(t,w)}}},95074:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n(97181),a=n(85899),o=n(56442);const s=function(e,t,n,s,r={},l=""){const{color:d,width:c,lineWidth:h,lineDash:g}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},r),u=h||c,m=(0,i.A)(t,"ellipse",n),p=e.getSvgNode(m),[v,f,w,E]=s,I=Math.hypot(w[0]-E[0],w[1]-E[1]),C=Math.hypot(f[0]-v[0],f[1]-v[1]),b=180*Math.atan2(w[1]-E[1],w[0]-E[0])/Math.PI,_=[(w[0]+E[0])/2,(f[1]+v[1])/2],T={cx:`${_[0]}`,cy:`${_[1]}`,rx:`${I/2}`,ry:`${C/2}`,stroke:d,fill:"transparent",transform:`rotate(${b} ${_[0]} ${_[1]})`,"stroke-width":u,"stroke-dasharray":g};if(p)(0,a.A)(T,p),e.setNodeTouched(m);else{const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==l&&t.setAttribute("data-id",l),(0,o.A)(T,t),e.appendNode(t,m)}}},56745:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(94042);const a=function(e,t,n,a,o={}){a.forEach((a,s)=>{(0,i.A)(e,t,n,a,o,s)})}},1595:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var i=n(26290),a=n(92118),o=n(90554);const s=function(e,t,n,i,s,r,l={}){const d=i.length>0?(0,o.A)(i,s):s,c=function(e){const{x:t,y:n,height:i,width:a}=e,o=a/2,s=i/2;return[[t+o,n],[t,n+s],[t+o,n+i],[t+a,n+s]]}(r),h=(0,o.A)(c,d),g=Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},l);(0,a.A)(e,t,`link-${n}`,d,h,g)};const r=function(e,t,n,a,o,r,l,d={}){const c=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},d),h=(0,i.A)(e,t,n,a,o,c);return s(e,t,n,r,o,h,c),h}},97530:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});n(97181);var i=n(75076);function a(e,t,n,a,o,s={},r=""){const l=[a[0],a[1]],d=[o[0],a[1]],c=[a[0],o[1]],h=[o[0],o[1]];(0,i.A)(e,t,n,[l,d,c,h],s,r)}},74347:(e,t,n)=>{"use strict";n.d(t,{draw:()=>i.A,drawArrow:()=>C,drawCircle:()=>a.A,drawEllipseByCoordinates:()=>o.A,drawFan:()=>p,drawHandle:()=>r.A,drawHandles:()=>s.A,drawHeight:()=>d,drawLine:()=>l.A,drawLinkedTextBox:()=>v.A,drawPath:()=>h.A,drawPolyline:()=>c.A,drawRect:()=>f.A,drawRectByCoordinates:()=>w.A,drawRedactionRect:()=>b,drawTextBox:()=>E.A});var i=n(18262),a=n(12004),o=(n(85856),n(95074)),s=n(56745),r=n(94042),l=n(92118);function d(e,t,n,i,a,o={}){if(isNaN(i[0])||isNaN(i[1])||isNaN(a[0])||isNaN(a[1]))return;const{color:s,width:r,lineWidth:d,lineDash:c}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},o),h=a[0]+(i[0]-a[0])/2,g=[h,i[1]],u=[h,a[1]],m={start:i,end:g},p={start:g,end:u},v={start:u,end:a};(0,l.A)(e,t,"1",m.start,m.end,{color:s,width:r,lineWidth:d,lineDash:c}),(0,l.A)(e,t,"2",p.start,p.end,{color:s,width:r,lineWidth:d,lineDash:c}),(0,l.A)(e,t,"3",v.start,v.end,{color:s,width:r,lineWidth:d,lineDash:c})}var c=n(98812),h=n(17311),g=n(97181),u=n(85899),m=n(56442);const p=function(e,t,n,i,a,o,s,r,l={},d="",c){const{color:h,fill:p,width:v,lineWidth:f,lineDash:w,fillOpacity:E,strokeOpacity:I}=Object.assign({color:"rgb(0, 255, 0)",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},l),C=f||v,b=(0,g.A)(t,"fan",n),_=e.getSvgNode(b),T=s*Math.PI/180,A=r*Math.PI/180,S=i[0],M=i[1],D=S+o*Math.cos(T),y=M+o*Math.sin(T),P=S+o*Math.cos(A),x=M+o*Math.sin(A),R=S+a*Math.cos(T),L=M+a*Math.sin(T),O=r-s<=180?0:1;let U=`M ${D} ${y}`;U+=` A ${o} ${o} 0 ${O} 1 ${P} ${x}`,U+=` L ${S+a*Math.cos(A)} ${M+a*Math.sin(A)}`,U+=` A ${a} ${a} 0 ${O} 0 ${R} ${L}`,U+=" Z";const k={d:U,stroke:h,fill:p,"stroke-width":C,"stroke-dasharray":w,"fill-opacity":E,"stroke-opacity":I,"mix-blend-mode":"normal"};if(_)(0,u.A)(k,_),e.setNodeTouched(b);else{const t=document.createElementNS("http://www.w3.org/2000/svg","path");""!==d&&t.setAttribute("data-id",d),void 0!==c&&(t.style.zIndex=c.toString()),(0,m.A)(k,t),e.appendNode(t,b)}};var v=n(1595),f=n(97530),w=n(75076),E=n(26290);const I="http://www.w3.org/2000/svg";function C(e,t,n,i,a,o={}){if(isNaN(i[0])||isNaN(i[1])||isNaN(a[0])||isNaN(a[1]))return;const{viaMarker:s=!1,color:r="rgb(0, 255, 0)",markerSize:d=10}=o;if(!s)return void function(e,t,n,i,a,o={}){const{color:s="rgb(0, 255, 0)",width:r=2,lineWidth:d,lineDash:c}=o,h=10,g=Math.atan2(a[1]-i[1],a[0]-i[0]),u={start:[a[0]-h*Math.cos(g-Math.PI/7),a[1]-h*Math.sin(g-Math.PI/7)],end:a},m={start:[a[0]-h*Math.cos(g+Math.PI/7),a[1]-h*Math.sin(g+Math.PI/7)],end:a};(0,l.A)(e,t,n,i,a,{color:s,width:r,lineWidth:d,lineDash:c}),(0,l.A)(e,t,"2",u.start,u.end,{color:s,width:r,lineWidth:d,lineDash:c}),(0,l.A)(e,t,"3",m.start,m.end,{color:s,width:r,lineWidth:d,lineDash:c})}(e,t,n,i,a,o);const c=`${`arrow-${t}`}-${e.svgLayerElement.id}`,h=e.svgLayerElement.querySelector("defs");let g=h.querySelector(`#${c}`);if(g){g.setAttribute("markerWidth",`${d}`),g.setAttribute("markerHeight",`${d}`);const e=g.querySelector("path");e&&e.setAttribute("fill",r)}else{g=document.createElementNS(I,"marker"),g.setAttribute("id",c),g.setAttribute("viewBox","0 0 10 10"),g.setAttribute("refX","8"),g.setAttribute("refY","5"),g.setAttribute("markerWidth",`${d}`),g.setAttribute("markerHeight",`${d}`),g.setAttribute("orient","auto");const e=document.createElementNS(I,"path");e.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),e.setAttribute("fill",r),g.appendChild(e),h.appendChild(g)}o.markerEndId=c,(0,l.A)(e,t,n,i,a,o)}function b(e,t,n,i,a,o={}){const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},o),c=l||r,h=(0,g.A)(t,"rect",n),p=e.getSvgNode(h),v=[Math.min(i[0],a[0]),Math.min(i[1],a[1])],f=Math.abs(i[0]-a[0]),w=Math.abs(i[1]-a[1]),E={x:`${v[0]}`,y:`${v[1]}`,width:`${f}`,height:`${w}`,stroke:s,fill:"black","stroke-width":c,"stroke-dasharray":d};if(p)(0,u.A)(E,p),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");(0,m.A)(E,t),e.appendNode(t,h)}}},75183:(e,t,n)=>{"use strict";var i;n.d(t,{A:()=>a}),function(e){e.Interaction="Interaction",e.HandlesUpdated="HandlesUpdated",e.StatsUpdated="StatsUpdated",e.InitialSetup="InitialSetup",e.Completed="Completed",e.InterpolationUpdated="InterpolationUpdated",e.History="History",e.MetadataReferenceModified="MetadataReferenceModified",e.LabelChange="LabelChange"}(i||(i={}));const a=i},10401:(e,t,n)=>{"use strict";var i;n.d(t,{H:()=>i}),function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(i||(i={}))},21418:(e,t,n)=>{"use strict";n.d(t,{kt:()=>i.A});n(91099),n(68014),n(41343);n(41666),n(82603);n(17806);var i=n(39595);n(24917),n(15327),n(99737);n(59452),n(93210),n(97577);n(33283),n(58859);n(42008),n(58498),n(78231);new Map;n(56534),n(15295),n(82056),n(77609),n(3444),n(49941),n(65172);n(58640)},24917:(e,t,n)=>{"use strict";n.d(t,{h6:()=>v});var i=n(15327),a=n(99737),o=n(18682),s=n(93210),r=n(67014),l=n(25894),d=n(684),c=n(68040),h=n(85204),g=n(37590),u=n(77609);const m={[o.A.Labelmap]:d.Ay,[o.A.Contour]:l.A,[o.A.Surface]:r.Ay},p=g.A.toolName;function v(e){f.renderSegmentationsForViewport(e)}const f=new class{constructor(){this._needsRender=new Set,this._pendingRenderQueue=[],this._animationFrameSet=!1,this._animationFrameHandle=null,this._getAllViewports=()=>(0,i.getRenderingEngines)().flatMap(e=>e.getViewports()),this._renderFlaggedSegmentations=()=>{this._throwIfDestroyed();if(Array.from(this._needsRender).forEach(e=>{this._triggerRender(e)}),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._pendingRenderQueue.length>0){const e=this._pendingRenderQueue.shift();e&&e.length>0&&this._setViewportsToBeRenderedNextFrame(e)}}}renderSegmentationsForViewport(e){const t=e?[e]:this._getViewportIdsForSegmentation();this._setViewportsToBeRenderedNextFrame(t)}renderSegmentation(e){const t=this._getViewportIdsForSegmentation(e);this._setViewportsToBeRenderedNextFrame(t)}_getViewportIdsForSegmentation(e){const t=this._getAllViewports(),n=[];for(const i of t){const t=i.id;if(e){const i=(0,s.r$)(t,{segmentationId:e});i?.length>0&&n.push(t)}else{const e=(0,s.r$)(t);e?.length>0&&n.push(t)}}return n}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setViewportsToBeRenderedNextFrame(e){this._animationFrameSet?this._pendingRenderQueue.push(e):(e.forEach(e=>{this._needsRender.add(e)}),this._render())}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedSegmentations),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,s.r$)(e);if(!t?.length)return;const{viewport:n}=(0,i.getEnabledElementByViewportId)(e)||{};if(!n)return;const o=[],r=t.map(e=>{e.type===a.SegmentationRepresentations.Contour&&this._addPlanarFreeHandToolIfAbsent(n);const t=m[e.type];try{const i=t.render(n,e);o.push(i)}catch(e){console.error(e)}return Promise.resolve({segmentationId:e.segmentationId,type:e.type})});Promise.allSettled(r).then(e=>{const t=e.filter(e=>"fulfilled"===e.status).map(e=>e.value);n.element.addEventListener(i.Enums.Events.IMAGE_RENDERED,function e(n){const{element:o,viewportId:s}=n.detail;o.removeEventListener(i.Enums.Events.IMAGE_RENDERED,e),t.forEach(e=>{const t={viewportId:s,segmentationId:e.segmentationId,type:e.type};(0,i.triggerEvent)(i.eventTarget,a.Events.SEGMENTATION_RENDERED,{...t})})}),n.render()})}_addPlanarFreeHandToolIfAbsent(e){p in h.wk.tools||(0,c.Gx)(g.A);const t=(0,u.getToolGroupForViewport)(e.id);t.hasTool(p)||(t.addTool(p),t.setToolPassive(p))}}},59475:(e,t,n)=>{"use strict";n.d(t,{Zm:()=>h,_6:()=>m,cC:()=>g});var i=n(15327),a=n(99737),o=n(642),s=n(99341),r=n(49906),l=n(92686),d=n(75419);const c={colorLUT:[],segmentations:[],viewportSegRepresentations:{}};async function h({imageIds:e,options:t}){const n=e,a=t?.volumeId||i.utilities.uuidv4();return await i.volumeLoader.createAndCacheVolumeFromImages(a,n),{volumeId:a}}async function g({segmentationId:e,options:t}){const n=m.getSegmentation(e),i=n.representationData.Labelmap,{volumeId:a}=await h({imageIds:i.imageIds,options:t});n.representationData.Labelmap.volumeId=a}function u(e){const t=o.Ay.newInstance(),n=s.Ay.newInstance();return n.addPoint(0,0),e===a.SegmentationRepresentations.Labelmap?{cfun:t,ofun:n}:{}}const m=new class{constructor(e){this._stackLabelmapImageIdReferenceMap=new Map,this._labelmapImageIdReferenceMap=new Map,e||=i.utilities.uuidv4(),this.state=Object.freeze(i.utilities.deepClone(c)),this.uid=e}getState(){return this.state}updateState(e){const t=i.utilities.deepClone(this.state);e(t),this.state=Object.freeze(t)}getColorLUT(e){return this.state.colorLUT[e]}getNextColorLUTIndex(){return this.state.colorLUT.length}resetState(){this._stackLabelmapImageIdReferenceMap.clear(),this._labelmapImageIdReferenceMap.clear(),this.state=Object.freeze(i.utilities.deepClone(c))}getSegmentation(e){return this.state.segmentations.find(t=>t.segmentationId===e)}updateSegmentation(e,t){this.updateState(n=>{const i=n.segmentations.find(t=>t.segmentationId===e);i?Object.assign(i,t):console.warn(`Segmentation with id ${e} not found. Update aborted.`)}),(0,r.triggerSegmentationModified)(e)}addSegmentation(e){if(this.getSegmentation(e.segmentationId))throw new Error(`Segmentation with id ${e.segmentationId} already exists`);this.updateState(t=>{const n=i.utilities.deepClone(e);if(n.representationData.Labelmap&&"volumeId"in n.representationData.Labelmap&&!("imageIds"in n.representationData.Labelmap)){const e=this.getLabelmapImageIds(n.representationData);n.representationData.Labelmap.imageIds=e}t.segmentations.push(n)}),(0,d.R)(e.segmentationId)}removeSegmentation(e){this.updateState(t=>{const n=t.segmentations.filter(t=>t.segmentationId!==e);t.segmentations.splice(0,t.segmentations.length,...n)}),(0,r.triggerSegmentationRemoved)(e)}addSegmentationRepresentation(e,t,n,o){if(!(0,i.getEnabledElementByViewportId)(e))return;this.getSegmentationRepresentations(e,{type:n,segmentationId:t}).length>0?console.debug("A segmentation representation of type",n,"already exists in viewport",e,"for segmentation",t):(this.updateState(i=>{i.viewportSegRepresentations[e]||(i.viewportSegRepresentations[e]=[],l.Y.setRenderInactiveSegmentations(e,!0)),n!==a.SegmentationRepresentations.Labelmap?this.addDefaultSegmentationRepresentation(i,e,t,n,o):this.addLabelmapRepresentation(i,e,t,o)}),(0,r.triggerSegmentationRepresentationModified)(e,t,n))}addDefaultSegmentationRepresentation(e,t,n,i,a){const o=e.segmentations.find(e=>e.segmentationId===n);if(!o)return;const s={};Object.keys(o.segments).forEach(e=>{s[Number(e)]={visible:!0}}),e.viewportSegRepresentations[t].push({segmentationId:n,type:i,active:!0,visible:!0,colorLUTIndex:a?.colorLUTIndex||0,segments:s,config:{...u(i),...a}}),this._setActiveSegmentation(e,t,n)}addLabelmapRepresentation(e,t,n,o=u(a.SegmentationRepresentations.Labelmap)){if(!(0,i.getEnabledElementByViewportId)(t))return;const s=this.getSegmentation(n);if(!s)return;const{representationData:r}=s;if(!r.Labelmap)return this.addDefaultSegmentationRepresentation(e,t,n,a.SegmentationRepresentations.Labelmap,o);this.processLabelmapRepresentationAddition(t,n),this.addDefaultSegmentationRepresentation(e,t,n,a.SegmentationRepresentations.Labelmap,o)}async processLabelmapRepresentationAddition(e,t){const n=(0,i.getEnabledElementByViewportId)(e);if(!n)return;const a=this.getSegmentation(t);if(!a)return;const o=n.viewport instanceof i.BaseVolumeViewport,{representationData:s}=a,r="volumeId"in s.Labelmap;n.viewport;o||r||this.updateLabelmapSegmentationImageReferences(e,a.segmentationId)}_updateLabelmapSegmentationReferences(e,t,n,i){const a=t.getCurrentImageId();let o=!1;for(const i of n){t.isReferenceViewable({referencedImageId:i},{asOverlay:!0})&&(o=!0,this._stackLabelmapImageIdReferenceMap.get(e).set(a,i),this._updateLabelmapImageIdReferenceMap({segmentationId:e,referenceImageId:a,labelmapImageId:i}))}return i&&i(t,e,n),o?this._stackLabelmapImageIdReferenceMap.get(e).get(a):void 0}updateLabelmapSegmentationImageReferences(e,t){const n=this.getSegmentation(t);if(!n)return;this._stackLabelmapImageIdReferenceMap.has(t)||this._stackLabelmapImageIdReferenceMap.set(t,new Map);const{representationData:a}=n;if(!a.Labelmap)return;const o=this.getLabelmapImageIds(a),s=(0,i.getEnabledElementByViewportId)(e).viewport;return this._updateLabelmapSegmentationReferences(t,s,o,null)}_updateAllLabelmapSegmentationImageReferences(e,t){const n=this.getSegmentation(t);if(!n)return;this._stackLabelmapImageIdReferenceMap.has(t)||this._stackLabelmapImageIdReferenceMap.set(t,new Map);const{representationData:a}=n;if(!a.Labelmap)return;const o=this.getLabelmapImageIds(a),s=(0,i.getEnabledElementByViewportId)(e).viewport;this._updateLabelmapSegmentationReferences(t,s,o,(e,t,n)=>{e.getImageIds().forEach((i,a)=>{for(const o of n){e.isReferenceViewable({referencedImageId:o,sliceIndex:a},{asOverlay:!0,withNavigation:!0})&&(this._stackLabelmapImageIdReferenceMap.get(t).set(i,o),this._updateLabelmapImageIdReferenceMap({segmentationId:t,referenceImageId:i,labelmapImageId:o}))}})})}getLabelmapImageIds(e){const t=e.Labelmap;let n;if(t.imageIds)n=t.imageIds;else if(!n&&t.volumeId){const e=t.volumeId;n=i.cache.getVolume(e).imageIds}return n}getLabelmapImageIdsForImageId(e,t){const n=this._generateMapKey({segmentationId:t,referenceImageId:e});return this._labelmapImageIdReferenceMap.get(n)}getCurrentLabelmapImageIdsForViewport(e,t){const n=(0,i.getEnabledElementByViewportId)(e);if(!n)return;const a=n.viewport.getCurrentImageId();return this.getLabelmapImageIdsForImageId(a,t)}getCurrentLabelmapImageIdForViewport(e,t){const n=(0,i.getEnabledElementByViewportId)(e);if(!n)return;if(!this._stackLabelmapImageIdReferenceMap.has(t))return;const a=n.viewport.getCurrentImageId();return this._stackLabelmapImageIdReferenceMap.get(t).get(a)}getStackSegmentationImageIdsForViewport(e,t){if(!this.getSegmentation(t))return[];this._updateAllLabelmapSegmentationImageReferences(e,t);const{viewport:n}=(0,i.getEnabledElementByViewportId)(e),a=n.getImageIds(),o=this._stackLabelmapImageIdReferenceMap.get(t);return a.map(e=>o.get(e))}removeSegmentationRepresentationsInternal(e,t){const n=[];return this.updateState(i=>{if(!i.viewportSegRepresentations[e])return;const a=i.viewportSegRepresentations[e];let o=!1;if(!t||Object.values(t).every(e=>void 0===e))n.push(...a),delete i.viewportSegRepresentations[e];else{const{segmentationId:s,type:r}=t;i.viewportSegRepresentations[e]=a.filter(e=>{const t=s&&r&&e.segmentationId===s&&e.type===r||s&&!r&&e.segmentationId===s||!s&&r&&e.type===r;return t&&(n.push(e),e.active&&(o=!0)),!t}),0===i.viewportSegRepresentations[e].length?delete i.viewportSegRepresentations[e]:o&&(i.viewportSegRepresentations[e][0].active=!0)}}),n}removeSegmentationRepresentations(e,t){const n=this.removeSegmentationRepresentationsInternal(e,t);n.forEach(t=>{(0,r.triggerSegmentationRepresentationRemoved)(e,t.segmentationId,t.type)});const i=this.getSegmentationRepresentations(e);return i.length>0&&i[0].active&&(0,r.triggerSegmentationRepresentationModified)(e,i[0].segmentationId,i[0].type),n}removeSegmentationRepresentation(e,t,n){const i=this.removeSegmentationRepresentationsInternal(e,t);return n||i.forEach(({segmentationId:t,type:n})=>{(0,r.triggerSegmentationRepresentationRemoved)(e,t,n)}),i}_updateLabelmapImageIdReferenceMap({segmentationId:e,referenceImageId:t,labelmapImageId:n}){const i=this._generateMapKey({segmentationId:e,referenceImageId:t});if(!this._labelmapImageIdReferenceMap.has(i))return void this._labelmapImageIdReferenceMap.set(i,[n]);const a=this._labelmapImageIdReferenceMap.get(i),o=Array.from(new Set([...a,n]));this._labelmapImageIdReferenceMap.set(i,o)}_setActiveSegmentation(e,t,n){const i=e.viewportSegRepresentations[t];i&&i.forEach(e=>{e.active=e.segmentationId===n})}setActiveSegmentation(e,t){this.updateState(n=>{const i=n.viewportSegRepresentations[e];i&&i.forEach(e=>{e.active=e.segmentationId===t})}),(0,r.triggerSegmentationRepresentationModified)(e,t)}getActiveSegmentation(e){if(!this.state.viewportSegRepresentations[e])return;const t=this.state.viewportSegRepresentations[e].find(e=>e.active);return t?this.getSegmentation(t.segmentationId):void 0}getSegmentationRepresentations(e,t={}){const n=this.state.viewportSegRepresentations[e];return n?t.type||t.segmentationId?n.filter(e=>{const n=!t.type||e.type===t.type,i=!t.segmentationId||e.segmentationId===t.segmentationId;return n&&i}):n:[]}getSegmentationRepresentation(e,t){return this.getSegmentationRepresentations(e,t)[0]}getSegmentationRepresentationVisibility(e,t){const n=this.getSegmentationRepresentation(e,t);return n?.visible}setSegmentationRepresentationVisibility(e,t,n){this.updateState(i=>{const a=this.getSegmentationRepresentations(e,t);a&&a.forEach(e=>{e.visible=n,Object.entries(e.segments).forEach(([e,t])=>{t.visible=n})})}),(0,r.triggerSegmentationRepresentationModified)(e,t.segmentationId,t.type)}addColorLUT(e,t){this.updateState(n=>{n.colorLUT[t]&&console.warn("Color LUT table already exists, overwriting"),n.colorLUT[t]=i.utilities.deepClone(e)})}removeColorLUT(e){this.updateState(t=>{delete t.colorLUT[e]})}_getStackIdForImageIds(e){return e.map(e=>e.slice(-Math.round(.15*e.length))).join("_")}getAllViewportSegmentationRepresentations(){return Object.entries(this.state.viewportSegRepresentations).map(([e,t])=>({viewportId:e,representations:t}))}getSegmentationRepresentationsBySegmentationId(e){const t=[];return Object.entries(this.state.viewportSegRepresentations).forEach(([n,i])=>{const a=i.filter(t=>t.segmentationId===e);a.length>0&&t.push({viewportId:n,representations:a})}),t}_generateMapKey({segmentationId:e,referenceImageId:t}){return`${e}-${t}`}}("DEFAULT")},92686:(e,t,n)=>{"use strict";n.d(t,{Y:()=>r});var i=n(67772),a=n(53486),o=n(99737),s=n(15327);const r=new class{constructor(){this.config={global:{},segmentations:{},viewportsStyle:{}}}setStyle(e,t){const{viewportId:n,segmentationId:i,type:a,segmentIndex:o}=e,s=this.getStyle(e);let r;if(r=n||i?this.copyActiveToInactiveIfNotProvided({...s,...t},a):{...s,...t},!a)throw new Error("Type is required to set a style");if(n){this.config.viewportsStyle[n]||(this.config.viewportsStyle[n]={renderInactiveSegmentations:!1,representations:{}});const e=this.config.viewportsStyle[n].representations;if(i){e[i]||(e[i]={}),e[i][a]||(e[i][a]={});const t=e[i][a];void 0!==o?(t.perSegment||(t.perSegment={}),t.perSegment[o]=r):t.allSegments=r}else{const t="__allSegmentations__";e[t]||(e[t]={}),e[t][a]||(e[t][a]={}),e[t][a].allSegments=r}}else if(i){this.config.segmentations[i]||(this.config.segmentations[i]={}),this.config.segmentations[i][a]||(this.config.segmentations[i][a]={});const e=this.config.segmentations[i][a];void 0!==o?(e.perSegment||(e.perSegment={}),e.perSegment[o]=r):e.allSegments=r}else this.config.global[a]=r}copyActiveToInactiveIfNotProvided(e,t){const n={...e};if(t===o.SegmentationRepresentations.Labelmap){const e=n;e.renderOutlineInactive??=e.renderOutline,e.outlineWidthInactive??=e.outlineWidth,e.renderFillInactive??=e.renderFill,e.fillAlphaInactive??=e.fillAlpha,e.outlineOpacityInactive??=e.outlineOpacity}else if(t===o.SegmentationRepresentations.Contour){const e=n;e.outlineWidthInactive??=e.outlineWidth,e.outlineOpacityInactive??=e.outlineOpacity,e.outlineDashInactive??=e.outlineDash,e.renderOutlineInactive??=e.renderOutline,e.renderFillInactive??=e.renderFill,e.fillAlphaInactive??=e.fillAlpha}return n}getStyle(e){const{viewportId:t,segmentationId:n,type:i,segmentIndex:a}=e;let o=this.getDefaultStyle(i),s=!1;if(this.config.global[i]&&(o={...o,...this.config.global[i]}),this.config.segmentations[n]?.[i]&&(o={...o,...this.config.segmentations[n][i].allSegments},void 0!==a&&this.config.segmentations[n][i].perSegment?.[a]&&(o={...o,...this.config.segmentations[n][i].perSegment[a]})),t&&this.config.viewportsStyle[t]){s=this.config.viewportsStyle[t].renderInactiveSegmentations;const e="__allSegmentations__";this.config.viewportsStyle[t].representations[e]?.[i]&&(o={...o,...this.config.viewportsStyle[t].representations[e][i].allSegments}),n&&this.config.viewportsStyle[t].representations[n]?.[i]&&(o={...o,...this.config.viewportsStyle[t].representations[n][i].allSegments},void 0!==a&&this.config.viewportsStyle[t].representations[n][i].perSegment?.[a]&&(o={...o,...this.config.viewportsStyle[t].representations[n][i].perSegment[a]}))}return o}getRenderInactiveSegmentations(e){return this.config.viewportsStyle[e]?.renderInactiveSegmentations}setRenderInactiveSegmentations(e,t){this.config.viewportsStyle[e]||(this.config.viewportsStyle[e]={renderInactiveSegmentations:!1,representations:{}}),this.config.viewportsStyle[e].renderInactiveSegmentations=t}getDefaultStyle(e){switch(e){case o.SegmentationRepresentations.Labelmap:return(0,a.A)();case o.SegmentationRepresentations.Contour:return(0,i.A)();case o.SegmentationRepresentations.Surface:return{};default:throw new Error(`Unknown representation type: ${e}`)}}clearSegmentationStyle(e){this.config.segmentations[e]&&delete this.config.segmentations[e]}clearAllSegmentationStyles(){this.config.segmentations={}}clearViewportStyle(e){this.config.viewportsStyle[e]&&delete this.config.viewportsStyle[e]}clearAllViewportStyles(){for(const e in this.config.viewportsStyle){const t=this.config.viewportsStyle[e].renderInactiveSegmentations;this.config.viewportsStyle[e]={renderInactiveSegmentations:t,representations:{}}}}resetToGlobalStyle(){this.clearAllSegmentationStyles(),this.clearAllViewportStyles()}hasCustomStyle(e){const{type:t}=e,n=this.getStyle(e),i=this.getDefaultStyle(t);return!s.utilities.deepEqual(n,i)}}},26228:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getActiveSegmentation:()=>o,setActiveSegmentation:()=>s});var i=n(67165),a=n(59475);function o(e){return(0,i.T)(e)}function s(e,t){!function(e,t){a._6.setActiveSegmentation(e,t)}(e,t)}},4714:(e,t,n)=>{"use strict";n.d(t,{u:()=>r});var i=n(15327),a=n(59475),o=n(70906),s=n(93952);function r(e,t){const n=a._6,r=t??(0,o.u)();let l=[...e];if(i.utilities.isEqual(l[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),l=[[0,0,0,0],...l]),l=l.map(e=>3===e.length?[e[0],e[1],e[2],255]:e),l.length<255){const e=s.A.slice(l.length);l=[...l,...e]}return n.addColorLUT(l,r),r}},74283:(e,t,n)=>{"use strict";n.d(t,{At:()=>s,gR:()=>o});var i=n(99737),a=n(55894);function o(e,t){t.map(t=>(0,a.U)(e,t))}function s(e,t){return o(e,t.map(e=>({...e,type:i.SegmentationRepresentations.Contour})))}},30935:(e,t,n)=>{"use strict";n.d(t,{d:()=>l});var i=n(59475),a=n(49906),o=n(99737),s=n(15327);const r=function(e){const{segmentationId:t,representation:n,config:i}=e,{type:a,data:r}=n,l=r?{...r}:{};if(!l)throw new Error("Segmentation representation data may not be undefined");var d;a===o.SegmentationRepresentations.Contour&&((d=l).geometryIds=d.geometryIds??[],d.annotationUIDsMap=d.annotationUIDsMap??new Map);const c=function(e,t,n){const i={};e?Object.entries(e).forEach(([e,t])=>{const{label:n,locked:a,cachedStats:o,active:s,...r}=t,l={segmentIndex:Number(e),label:n??`Segment ${e}`,locked:a??!1,cachedStats:o??{},active:s??!1,...r};i[e]=l}):t===o.SegmentationRepresentations.Contour?function(e,t){const{geometryIds:n}=t;n?.forEach(t=>{const n=s.cache.getGeometry(t);if(n?.data){const{segmentIndex:t}=n.data;e[t]={segmentIndex:t}}})}(i,n):t===o.SegmentationRepresentations.Surface?function(e,t){const{geometryIds:n}=t;n?.forEach(t=>{const n=s.cache.getGeometry(t);if(n?.data){const{segmentIndex:t}=n.data;e[t]={segmentIndex:t}}})}(i,n):i[1]={segmentIndex:1,label:"Segment 1",locked:!1,cachedStats:{},active:!0};return i}(i?.segments,a,l);return delete i?.segments,{segmentationId:t,label:i?.label??null,cachedStats:i?.cachedStats??{},segments:c,representationData:{[a]:{...l}}}};function l(e,t){const n=i._6;e.forEach(e=>{const i=r(e);n.addSegmentation(i),t||(0,a.triggerSegmentationModified)(i.segmentationId)})}},93733:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addColorLUT:()=>r,getSegmentIndexColor:()=>d,setColorLUT:()=>l,setSegmentIndexColor:()=>c});var i=n(4714),a=n(50409),o=n(93210),s=n(49906);function r(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");return(0,i.u)(e,t)}function l(e,t,n){if(!(0,a.B)(n))throw new Error(`setColorLUT: could not find colorLUT with index ${n}`);const i=(0,o.r$)(e,{segmentationId:t});if(!i)throw new Error(`viewport specific state for viewport ${e} does not exist`);i.forEach(e=>{e.colorLUTIndex=n}),(0,s.triggerSegmentationRepresentationModified)(e,t)}function d(e,t,n){const i=(0,o.r$)(e,{segmentationId:t});if(!i||0===i.length)return null;const s=i[0],{colorLUTIndex:r}=s,l=(0,a.B)(r);let d=l[n];if(!d){if("number"!=typeof n)return console.warn(`Can't create colour for LUT index ${n}`),null;d=l[n]=[0,0,0,0]}return d}function c(e,t,n,i){const a=d(e,t,n);for(let e=0;e<i.length;e++)a[e]=i[e];(0,s.triggerSegmentationRepresentationModified)(e,t)}},98798:(e,t,n)=>{"use strict";n.d(t,{Q:()=>s});var i=n(15327),a=n(99737),o=n(64063);function s(e,t,n){const s={segmentationId:e,modifiedSlicesToUse:t,segmentIndex:n};(0,o.HM)(e),(0,i.triggerEvent)(i.eventTarget,a.Events.SEGMENTATION_DATA_MODIFIED,s)}},67165:(e,t,n)=>{"use strict";n.d(t,{T:()=>a});var i=n(59475);function a(e){return i._6.getActiveSegmentation(e)}},70906:(e,t,n)=>{"use strict";n.d(t,{u:()=>a});var i=n(59475);function a(){return i._6.getNextColorLUTIndex()}},93210:(e,t,n)=>{"use strict";n.d(t,{Ut:()=>o,ny:()=>s,r$:()=>a});var i=n(59475);function a(e,t={}){return i._6.getSegmentationRepresentations(e,t)}function o(e,t){const n=i._6;if(!t.segmentationId||!t.type)throw new Error("getSegmentationRepresentation: No segmentationId or type provided, you need to provide at least one of them");const a=n.getSegmentationRepresentations(e,t);return a?.[0]}function s(e){return i._6.getSegmentationRepresentationsBySegmentationId(e)}},33658:(e,t,n)=>{"use strict";n.d(t,{I:()=>a});var i=n(59475);function a(e,t){return i._6.getSegmentationRepresentationVisibility(e,t)}},70758:(e,t,n)=>{"use strict";n.d(t,{K:()=>a});var i=n(59475);function a(){return i._6.getState().segmentations}},42568:(e,t,n)=>{"use strict";n.d(t,{a:()=>o,z:()=>s});var i=n(33283),a=n(59475);function o(e,t){return s(e).map(e=>(t&&e.type,(0,i.T)(e.segmentationId))).filter(e=>void 0!==e)}function s(e){return a._6.getState().viewportSegRepresentations[e]}},93690:(e,t,n)=>{"use strict";n.d(t,{f:()=>s});var i=n(15327),a=n(33283),o=n(98149);function s({segmentationId:e,options:t}){const n=(0,a.T)(e);if(!n)return;const{volumeId:s}=n.representationData.Labelmap,r=i.cache.getVolume(s);return(0,o.X)({segmentationId:e,viewportId:t.viewportId,imageIds:r.imageIds,options:t})}},6994:(e,t,n)=>{"use strict";n.d(t,{a:()=>a});var i=n(59475);async function a(e){return(0,i.Zm)(e)}},55126:(e,t,n)=>{"use strict";n.d(t,{activeSegmentation:()=>s,addContourRepresentationToViewport:()=>a.At,addRepresentationData:()=>o.A,addSegmentationRepresentations:()=>a.gR,config:()=>i,getActiveSegmentation:()=>m.T,segmentIndex:()=>c,segmentLocking:()=>r,state:()=>l});var i={};n.r(i),n.d(i,{color:()=>d});n(53662);var a=n(74283),o=(n(30935),n(44188));n(59475),n(49906);var s=n(26228),r=n(26795),l=n(98870),d=n(93733);n(93210);n(33658),n(24917);n(70758),n(42568),n(92686);var c=n(70930),h=(n(31994),n(6273)),g=n(6994);n(15327),n(33283);var u=n(93690);n(60740),n(58859),n(82056),n(56534);n(99522),n(63427),n(97577);var m=n(67165);h.p,g.a,u.f},44188:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(33283),a=n(18682);const o=function({segmentationId:e,type:t,data:n}){const o=(0,i.T)(e);if(!o)throw new Error(`Segmentation ${e} not found`);switch(o.representationData[t]&&console.warn(`Representation data of type ${t} already exists for segmentation ${e}, overwriting it.`),t){case a.A.Labelmap:case a.A.Contour:case a.A.Surface:n&&(o.representationData[t]=n);break;default:throw new Error(`Invalid representation type ${t}`)}}},55894:(e,t,n)=>{"use strict";n.d(t,{U:()=>c});var i=n(93952),a=n(58640),o=n(99737),s=n(49906),r=n(4714),l=n(59475),d=n(70930);function c(e,t){const{segmentationId:n,config:i}=t,r={colorLUTIndex:h(i),...i};if(l._6.addSegmentationRepresentation(e,n,t.type,r),!(0,d.getActiveSegmentIndex)(n)){let e=1;const t=l._6.getSegmentation(n);if(t){const n=Object.keys(t.segments);n.length>0&&(e=n.map(e=>Number(e)).sort()[0])}(0,d.setActiveSegmentIndex)(n,e)}t.type===o.SegmentationRepresentations.Contour&&(0,a.t)([e]),(0,s.triggerSegmentationModified)(n)}function h(e){const{colorLUTOrIndex:t}=e||{};if(void 0===t){return(0,r.u)(JSON.parse(JSON.stringify(i.A)))}if("number"==typeof t)return t;if(Array.isArray(t)&&t.every(e=>Array.isArray(e)&&4===e.length)){return(0,r.u)(t)}return(0,r.u)(JSON.parse(JSON.stringify(i.A)))}},63427:(e,t,n)=>{"use strict";n.d(t,{j:()=>r,z:()=>s});var i=n(59475),a=n(49906),o=n(53662);function s(e){const t=i._6;t.getAllViewportSegmentationRepresentations().filter(({representations:t})=>t.some(t=>t.segmentationId===e)).map(({viewportId:e})=>e).forEach(t=>{(0,o.nc)(t,{segmentationId:e})}),t.removeSegmentation(e),(0,a.triggerSegmentationRemoved)(e)}function r(){const e=i._6;e.getState().segmentations.map(e=>e.segmentationId).forEach(e=>{s(e)}),e.resetState()}},53662:(e,t,n)=>{"use strict";n.d(t,{us:()=>u,OE:()=>p,kN:()=>m,E8:()=>c,nc:()=>h,JC:()=>v});var i=n(18682),a=n(684),o=n(25894),s=n(93210),r=n(15327),l=n(59475),d=n(67014);function c(e,t,n){return g(e,t,n)}function h(e,t,n){return g(e,t,n)}function g(e,t,n){const{segmentationId:c,type:h}=t;return function(e,t,n,l){const c=(0,s.r$)(e,{segmentationId:t,type:n});c.forEach(t=>{t.type===i.A.Labelmap?a.Ay.removeRepresentation(e,t.segmentationId,l):t.type===i.A.Contour?o.A.removeRepresentation(e,t.segmentationId,l):t.type===i.A.Surface&&d.Ay.removeRepresentation(e,t.segmentationId,l)});const{viewport:h}=(0,r.getEnabledElementByViewportId)(e)||{};h&&h.render()}(e,c,h,n),l._6.removeSegmentationRepresentations(e,{segmentationId:c,type:h})}function u(){l._6.getAllViewportSegmentationRepresentations().forEach(({viewportId:e,representations:t})=>{t.forEach(({segmentationId:t,type:n})=>{c(e,{segmentationId:t,type:n})})}),l._6.resetState()}function m(e,t,n){c(e,{segmentationId:t,type:i.A.Labelmap},n)}function p(e,t,n){c(e,{segmentationId:t,type:i.A.Contour},n)}function v(e,t,n){c(e,{segmentationId:t,type:i.A.Surface},n)}},70930:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getActiveSegmentIndex:()=>l.Q,setActiveSegmentIndex:()=>c});var i=n(77609),a=n(35706),o=n(33283),s=n(58859),r=n(49906),l=n(60740),d=n(93210);function c(e,t){const n=(0,o.T)(e);"string"==typeof t&&(console.warn("segmentIndex is a string, converting to number"),t=Number(t)),Object.values(n.segments).forEach(e=>{e.active=!1}),n.segments[t]||(n.segments[t]={segmentIndex:t,label:"",locked:!1,cachedStats:{},active:!1}),!0!==n.segments[t].active&&(n.segments[t].active=!0,(0,r.triggerSegmentationModified)(e));const l=(0,s.P)(e);l.forEach(n=>{(0,d.r$)(n,{segmentationId:e}).forEach(e=>{e.segments[t]||(e.segments[t]={visible:!0})})}),l.forEach(e=>{const t=(0,i.getToolGroupForViewport)(e);(0,a.E)(t.id)})}},26795:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getLockedSegmentIndices:()=>d,isSegmentIndexLocked:()=>r,setSegmentIndexLocked:()=>l});var i=n(33283),a=n(2076),o=n(49906),s=n(31994);function r(e,t){const n=(0,i.T)(e);if(!n)throw new Error(`No segmentation state found for ${e}`);const{segments:a}=n;return a[t].locked}function l(e,t,n=!0){const r=(0,i.T)(e);if(!r)throw new Error(`No segmentation state found for ${e}`);const{segments:l}=r;l[t].locked=n,r?.representationData?.Contour&&function(e,t,n){const i=(0,s.getAnnotationsUIDMapFromSegmentation)(e.segmentationId);if(!i)return;const o=i.get(t);o&&o.forEach(e=>{(0,a.setAnnotationLocked)(e,n)})}(r,t,n),(0,o.triggerSegmentationModified)(e)}function d(e){const t=(0,i.T)(e);if(!t)throw new Error(`No segmentation state found for ${e}`);const{segments:n}=t;return Object.keys(n).filter(e=>n[e].locked).map(e=>parseInt(e))}},98870:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addColorLUT:()=>l.u,addSegmentations:()=>o.d,destroy:()=>E,getColorLUT:()=>d.B,getCurrentLabelmapImageIdForViewport:()=>p.vl,getCurrentLabelmapImageIdsForViewport:()=>p.aF,getNextColorLUTIndex:()=>c.u,getSegmentation:()=>i.T,getSegmentationRepresentation:()=>w.Ut,getSegmentationRepresentations:()=>w.r$,getSegmentationRepresentationsBySegmentationId:()=>w.ny,getSegmentations:()=>a.K,getStackSegmentationImageIdsForViewport:()=>f,getViewportIdsWithSegmentation:()=>m.P,getViewportSegmentationRepresentations:()=>u.z,getViewportSegmentations:()=>u.a,removeAllSegmentationRepresentations:()=>r.us,removeAllSegmentations:()=>s.j,removeColorLUT:()=>g,removeContourRepresentation:()=>r.OE,removeLabelmapRepresentation:()=>r.kN,removeSegmentation:()=>s.z,removeSegmentationRepresentation:()=>r.E8,removeSurfaceRepresentation:()=>r.JC,updateLabelmapSegmentationImageReferences:()=>v.t});var i=n(33283),a=n(70758),o=n(30935),s=n(63427),r=n(53662),l=n(4714),d=n(50409),c=n(70906),h=n(59475);function g(e){h._6.removeColorLUT(e)}var u=n(42568),m=n(58859),p=n(97577),v=n(78231);function f(e,t){return h._6.getStackSegmentationImageIdsForViewport(e,t)}var w=n(93210);function E(){h._6.resetState()}},78231:(e,t,n)=>{"use strict";n.d(t,{t:()=>a});var i=n(59475);function a(e,t){return i._6.updateLabelmapSegmentationImageReferences(e,t)}},98484:(e,t,n)=>{"use strict";n.d(t,{B:()=>a});var i=n(33283);function a(e){const t=(0,i.T)(e);if(!t)return;const n=t.representationData?.Contour;if(!n)return;const{annotationUIDsMap:a}=n;return a||void 0}},31994:(e,t,n)=>{"use strict";n.d(t,{getAnnotationsUIDMapFromSegmentation:()=>i.B});var i=n(98484);n(16493),n(10407),n(53097),n(96629),n(38928),n(19741),n(85512),n(68362),n(64540)},65136:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(15327),a=n(85204);const o=function(e,t){t||(t=(0,i.getRenderingEngines)().find(t=>t.getViewports().find(t=>t.id===e))?.id);const n=a.wk.toolGroups.filter(n=>n.viewportsInfo.some(n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)));if(n.length){if(n.length>1)throw new Error(`Multiple tool groups found for renderingEngineId: ${t} and viewportId: ${e}. You should only\n      have one tool group per viewport in a renderingEngine.`);return n[0]}}},48145:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});let i={};const a=i},25072:(e,t,n)=>{"use strict";n.d(t,{A:()=>T});var i=n(3823),a=n(15327),o=n(4096),s=n(85817),r=n(27730),l=n(82056),d=n(2076),c=n(29601),h=n(44049),g=n(74347),u=n(85204),m=n(99737),p=n(60810),v=n(93258),f=n(473),w=n(7001),E=n(58640),I=n(76712);const{transformWorldToIndex:C}=a.utilities;class b extends s.EC{static{this.toolName="Bidirectional"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:_}}){super(e,t),this.isPointNearTool=(e,t,n,i)=>{const o=(0,a.getEnabledElement)(e),{viewport:s}=o,{data:r}=t,{points:l}=r.handles;let d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[1]),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},g=v.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]);return g<=i||(d=s.worldToCanvas(l[2]),c=s.worldToCanvas(l[3]),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},g=v.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]),g<=i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=(0,p.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i);const s=(0,a.getEnabledElement)(i),{renderingEngine:r}=s;(0,E.A)(o),(0,w.hideElementCursor)(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,s=t.data;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,p.getViewportIdsWithToolToRender)(o,this.getToolName());(0,w.hideElementCursor)(o),this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(o);const c=(0,a.getEnabledElement)(o),{renderingEngine:h}=c;(0,E.A)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:s,newAnnotation:r,hasMoved:d}=this.editData,{data:c}=o;if(r&&!d)return;this.doneEditMemo(),c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n);const{renderingEngine:g}=(0,a.getEnabledElement)(n);if(void 0!==this.editData.handleIndex){const{points:e}=c.handles,t=i.eR.distance(e[0],e[1]);if(i.eR.distance(e[2],e[3])>t){const t=[[...e[2]],[...e[3]]],n=[...e[0]],a=[...e[1]],o=i.Zc.create();i.Zc.set(o,t[1][0]-t[0][0],t[1][1]-t[1][0]);const s=i.Zc.create();i.Zc.set(s,-o[1],o[0]);const r=i.Zc.create();let l;i.Zc.set(r,a[0]-n[0],a[1]-n[0]),l=i.Zc.dot(r,s)>0?[n,a]:[a,n],c.handles.points=[t[0],t[1],l[0],l[1]]}}this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(o.annotationUID),(0,E.A)(s),r&&(0,h.triggerAnnotationCompleted)(o),this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:o}=t,s=(0,a.getEnabledElement)(o),{viewport:r}=s,{worldToCanvas:l}=r,{annotation:d,viewportIdsToRender:c,handleIndex:g,newAnnotation:u}=this.editData;this.createMemo(o,d,{newAnnotation:u});const{data:p}=d,v=n.world;p.handles.points[g]=[...v];const f=p.handles.points.map(l),w={start:{x:f[0][0],y:f[0][1]},end:{x:f[1][0],y:f[1][1]}},I=(f[2][0],f[2][1],f[3][0],f[3][1],i.Zc.distance(f[0],f[1])/3),C=w.start.x-w.end.x,b=w.start.y-w.end.y,_=Math.sqrt(C*C+b*b),T=C/_,A=b/_,S=(w.start.x+w.end.x)/2,M=(w.start.y+w.end.y)/2,D=S+I*A,y=M-I*T,P=S-I*A,x=M+I*T;p.handles.points[2]=r.canvasToWorld([D,y]),p.handles.points[3]=r.canvasToWorld([P,x]),d.invalidated=!0,(0,E.A)(c),(0,h.triggerAnnotationModified)(d,o,m.ChangeTypes.HandlesUpdated),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:s,newAnnotation:r}=this.editData;this.createMemo(n,i,{newAnnotation:r});const{data:l}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else this._dragModifyHandle(e),i.invalidated=!0;(0,E.A)(a),i.invalidated&&(0,h.triggerAnnotationModified)(i,n,m.ChangeTypes.HandlesUpdated)},this._dragModifyHandle=e=>{const t=e.detail,{currentPoints:n,element:o}=t,s=(0,a.getEnabledElement)(o),{viewport:r}=s,{annotation:l,handleIndex:d}=this.editData,{data:c}=l,h=n.world,g=[r.worldToCanvas(c.handles.points[0]),r.worldToCanvas(c.handles.points[1]),r.worldToCanvas(c.handles.points[2]),r.worldToCanvas(c.handles.points[3])],u={start:{x:g[0][0],y:g[0][1]},end:{x:g[1][0],y:g[1][1]}},m={start:{x:g[2][0],y:g[2][1]},end:{x:g[3][0],y:g[3][1]}},p=[...h],f=r.worldToCanvas(p);if(0===d||1===d){const e=g[0===d?1:0],t=i.Zc.set(i.Zc.create(),f[0]-e[0],f[1]-e[1]),n=i.Zc.set(i.Zc.create(),g[d][0]-e[0],g[d][1]-e[1]);i.Zc.normalize(t,t),i.Zc.normalize(n,n);const a={start:{x:e[0],y:e[1]},end:{x:f[0],y:f[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(a,m))return;const o=e,s=this._getSignedAngle(n,t);let l=g[2][0],h=g[2][1],u=g[3][0],v=g[3][1];l-=o[0],h-=o[1],u-=o[0],v-=o[1];const w=l*Math.cos(s)-h*Math.sin(s),E=l*Math.sin(s)+h*Math.cos(s),I=u*Math.cos(s)-v*Math.sin(s),C=u*Math.sin(s)+v*Math.cos(s);l=w+o[0],h=E+o[1],u=I+o[0],v=C+o[1];const b=r.canvasToWorld([l,h]),_=r.canvasToWorld([u,v]);c.handles.points[d]=p,c.handles.points[2]=b,c.handles.points[3]=_}else{const e=2===d?3:2,t={longLineSegment:{start:u.start,end:u.end},shortLineSegment:{start:m.start,end:m.end}},n=i.Zc.subtract(i.Zc.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),a=i.Zc.normalize(i.Zc.create(),n),o=i.Zc.subtract(i.Zc.create(),[f[0],f[1]],[g[d][0],g[d][1]]),s=i.Zc.length(o),l=this._getSignedAngle(a,o),h=Math.cos(l)*s,w=i.Zc.scaleAndAdd(i.Zc.create(),[g[e][0],g[e][1]],a,h);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:f[0],y:f[1]},end:{x:w[0],y:w[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;if(!v.intersectLine([f[0],f[1]],[w[0],w[1]],[u.start.x,u.start.y],[u.end.x,u.end.y]))return;c.handles.points[e]=r.canvasToWorld(w),c.handles.points[d]=p}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,E.A)(n),i&&(0,h.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:i}=e,{element:a}=i;let o=(0,l.getAnnotations)(this.getToolName(),a);if(!o?.length)return n;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){const l=o[a],{annotationUID:u,data:m}=l,{points:p,activeHandleIndex:v}=m.handles,w=p.map(e=>i.worldToCanvas(e));h.annotationUID=u;const{color:E,lineWidth:C,lineDash:b,shadow:_}=this.getAnnotationStyle({annotation:l,styleSpecifier:h});if(m.cachedStats[s]&&null!=m.cachedStats[s].unit?l.invalidated&&this._throttledCalculateCachedStats(l,r,e):(m.cachedStats[s]={length:null,width:null,unit:null},this._calculateCachedStats(l,r,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let T;if(!(0,c.isAnnotationVisible)(u))continue;(0,d.isAnnotationLocked)(u)||this.editData||null===v||(T=[w[v]]);const A=Boolean((0,I.h)("showHandlesAlways",{}));if(T||A){const e="0";(0,g.drawHandles)(t,u,e,A?w:T,{color:E})}const S=`${u}-line-1`,M=`${u}-line-2`,D="0";(0,g.drawLine)(t,u,D,w[0],w[1],{color:E,lineDash:b,lineWidth:C,shadow:_},S);const y="1";(0,g.drawLine)(t,u,y,w[2],w[3],{color:E,lineDash:b,lineWidth:C,shadow:_},M),n=!0;const P=this.getLinkedTextBoxStyle(h,l);if(!P.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const x=this.configuration.getTextLines(m,s);if(!x||0===x.length)continue;let R;m.handles.textBox.hasMoved||(R=(0,f.getTextBoxCoordsCanvas)(w),m.handles.textBox.worldPosition=i.canvasToWorld(R));const L=i.worldToCanvas(m.handles.textBox.worldPosition),O="1",U=(0,g.drawLinkedTextBox)(t,u,O,x,L,w,{},P),{x:k,y:N,width:V,height:W}=U;m.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([k,N]),topRight:i.canvasToWorld([k+V,N]),bottomLeft:i.canvasToWorld([k,N+W]),bottomRight:i.canvasToWorld([k+V,N+W])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{const n=i.Zc.create();i.Zc.set(n,t.end.x-t.start.x,t.end.y-t.start.y),i.Zc.normalize(n,n);const a={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!v.intersectLine([a.start.x,a.start.y],[a.end.x,a.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._calculateCachedStats=(e,t,n)=>{const{data:i}=e,{element:a}=n.viewport,s=i.handles.points[0],r=i.handles.points[1],l=i.handles.points[2],d=i.handles.points[3],{cachedStats:c}=i,g=Object.keys(c);for(let e=0;e<g.length;e++){const t=g[e],n=this.getTargetImageData(t);if(!n)continue;const{imageData:i,dimensions:a}=n,h=C(i,s),u=C(i,r),m=C(i,l),p=C(i,d),v=[h,u],f=[m,p],{scale:w,unit:E}=(0,o.Op)(n,v),{scale:I,unit:b}=(0,o.Op)(n,f),_=this._calculateLength(s,r)/w,T=this._calculateLength(l,d)/I,A=_>T?_:T,S=_>T?T:_,M=_>T?E:b,D=_>T?b:E;this._isInsideVolume(h,u,m,p,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[t]={length:A,width:S,unit:M,widthUnit:D}}const u=e.invalidated;return e.invalidated=!1,u&&(0,h.triggerAnnotationModified)(e,a,m.ChangeTypes.StatsUpdated),c},this._isInsideVolume=(e,t,n,i,o)=>a.utilities.indexWithinDimensions(e,o)&&a.utilities.indexWithinDimensions(t,o)&&a.utilities.indexWithinDimensions(n,o)&&a.utilities.indexWithinDimensions(i,o),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,a=n.world;this.isDrawing=!0;const o=this.createAnnotation(e,[[...a],[...a],[...a],[...a]]);(0,l.addAnnotation)(o,i);const s=(0,p.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:o,viewportIdsToRender:s,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,w.hideElementCursor)(i),e.preventDefault(),(0,E.A)(s),o}static{this.hydrate=(e,t,n)=>{const i=(0,a.getEnabledElementByViewportId)(e);if(!i)return;const{FrameOfReferenceUID:o,referencedImageId:s,viewPlaneNormal:r,instance:d,viewport:c}=this.hydrateBase(b,i,t[0],n),[h,g]=t,[u,m]=h,[p,v]=g,f=[u,m,p,v],{toolInstance:w,...I}=n||{},C={annotationUID:n?.annotationUID||a.utilities.uuidv4(),data:{handles:{points:f,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:o,referencedImageId:s,...I}};return(0,l.addAnnotation)(C,c.element),(0,E.A)([c.id]),C}}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],a=e[2]-t[2];return Math.sqrt(n*n+i*i+a*a)}}function _(e,t){const{cachedStats:n,label:i}=e,{length:o,width:s,unit:r}=n[t],l=[];return i&&l.push(i),void 0===o||l.push(`L: ${a.utilities.roundNumber(o)} ${r||r}`,`W: ${a.utilities.roundNumber(s)} ${r}`),l}const T=b},37590:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var i=n(15327),a=n(49906),o=n(28220);class s extends o.A{static{this.toolName="PlanarFreehandContourSegmentationTool"}constructor(e){super(i.utilities.deepMerge({configuration:{calculateStats:!1,allowOpenContours:!1}},e))}isContourSegmentationTool(){return!0}renderAnnotationInstance(e){const t=e.annotation,{invalidated:n}=t,i=super.renderAnnotationInstance(e);if(n){const{segmentationId:e}=t.data.segmentation;(0,a.triggerSegmentationDataModified)(e)}return i}}const r=s},28220:(e,t,n)=>{"use strict";n.d(t,{A:()=>R});n(85817);var i=n(15327),a=n(3823),o=n(4096),s=n(95527),r=n(13165),l=n(27730),d=n(60810),c=n(58640),h=n(55927),g=n(92400),u=n(57999),m=n(69855),p=n(70734),v=n(58161),f=n(44049),w=n(74347),E=n(473),I=n(92984),C=n(18990),b=n(73262),_=n(93843),T=n(36320),A=n(99737),S=n(40634);const{pointCanProjectOnLine:M}=s.polyline,{EPSILON:D}=i.CONSTANTS,y=1-D;class P extends T.A{static{this.toolName="PlanarFreehandROI"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,shadow:!0,preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:A.KeyboardBindings.Shift,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,makeClockWise:!0,subPixelResolution:4,smoothing:{smoothOnAdd:!1,smoothOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},interpolation:{enabled:!1,onInterpolationComplete:null},decimate:{enabled:!1,epsilon:.1},displayOnePointAsCrosshairs:!1,calculateStats:!0,getTextLines:x,statsCalculator:b.BasicStatsCalculator}}){super(e,t),this.isDrawing=!1,this.isEditingClosed=!1,this.isEditingOpen=!1,this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,i=this.createAnnotation(e);this.addAnnotation(i,n);const a=(0,d.getViewportIdsWithToolToRender)(n,this.getToolName());return this.activateDraw(e,i,a),e.preventDefault(),(0,c.A)(a),i},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,o=(0,d.getViewportIdsWithToolToRender)(a,this.getToolName());this.activateOpenContourEndEdit(e,t,o,n)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n,a=(0,d.getViewportIdsWithToolToRender)(i,this.getToolName());t.data.contour.closed?this.activateClosedContourEdit(e,t,a):this.activateOpenContourEdit(e,t,a),e.preventDefault()},this.isPointNearTool=(e,t,n,a)=>{const o=(0,i.getEnabledElement)(e),{viewport:s}=o,{polyline:r}=t.data.contour;let l=s.worldToCanvas(r[0]);for(let e=1;e<r.length;e++){const t=l,i=s.worldToCanvas(r[e]);if(M(n,t,i,a))return!0;l=i}if(!t.data.contour.closed)return!1;const d=s.worldToCanvas(r[0]),c=s.worldToCanvas(r[r.length-1]);return M(n,d,c,a)},this.cancel=e=>{const t=this.isDrawing,n=this.isEditingOpen,i=this.isEditingClosed;t?this.cancelDrawing(e):n?this.cancelOpenContourEdit(e):i&&this.cancelClosedContourEdit(e)},this._calculateCachedStats=(e,t,n,r)=>{const{data:l}=e,{cachedStats:d}=l,{polyline:c,closed:h}=l.contour,g=Object.keys(d);for(let n=0;n<g.length;n++){const r=g[n],u=this.getTargetImageData(r);if(!u)continue;const{imageData:m,metadata:p}=u,v=c.map(e=>t.worldToCanvas(e)),f={isPreScaled:(0,C.u)(t,r),isSuvScaled:this.isSuvScaled(t,r,e.metadata.referencedImageId)},w=(0,S.j)(p.Modality,e.metadata.referencedImageId,f),E=(0,o.Op)(u,()=>{const e=l.contour.polyline,n=e.length,a=new Array(n);for(let i=0;i<n;i++)a[i]=t.worldToCanvas(e[i]);const{maxX:o,maxY:r,minX:d,minY:c}=s.polyline.getAABB(a),h=t.canvasToWorld([d,c]),g=i.utilities.transformWorldToIndex(m,h),u=t.canvasToWorld([o,r]);return[g,i.utilities.transformWorldToIndex(m,u)]}),I=v[0],b=t.canvasToWorld(I),_=t.canvasToWorld([I[0]+1,I[1]]),T=t.canvasToWorld([I[0],I[1]+1]),A=a.eR.distance(b,_),M=a.eR.distance(b,T);h?this.updateClosedCachedStats({targetId:r,viewport:t,canvasCoordinates:v,points:c,imageData:m,metadata:p,cachedStats:d,modalityUnit:w,calibratedScale:E,deltaInX:A,deltaInY:M}):this.updateOpenCachedStats({metadata:p,targetId:r,cachedStats:d,modalityUnit:w,calibratedScale:E,points:c})}const u=e.invalidated;return e.invalidated=!1,u&&(0,f.triggerAnnotationModified)(e,r.viewport.element,A.ChangeTypes.StatsUpdated),d},this._renderStats=(e,t,n,i)=>{const{data:a}=e,o=this.getTargetId(t),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id,annotationUID:e.annotationUID},r=this.getLinkedTextBoxStyle(s,e);if(!r.visibility)return;const l=this.configuration.getTextLines(a,o);if(!l||0===l.length)return;const d=a.contour.polyline.map(e=>t.worldToCanvas(e));if(!a.handles.textBox.hasMoved){const e=(0,E.getTextBoxCoordsCanvas)(d);a.handles.textBox.worldPosition=t.canvasToWorld(e)}const c=t.worldToCanvas(a.handles.textBox.worldPosition),h=(0,w.drawLinkedTextBox)(i,e.annotationUID??"","1",l,c,d,{},r),{x:g,y:u,width:m,height:p}=h;a.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([g,u]),topRight:t.canvasToWorld([g+m,u]),bottomLeft:t.canvasToWorld([g,u+p]),bottomRight:t.canvasToWorld([g+m,u+p])}},(0,h.A)(this),(0,g.A)(this),(0,u.A)(this),(0,m.A)(this),(0,p.A)(this),(0,v.A)(this),this._throttledCalculateCachedStats=(0,l.A)(this._calculateCachedStats,100,{trailing:!0})}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,i.getEnabledElement)(e),{viewport:a}=n;let o;if(a instanceof i.VolumeViewport){const e=a.getCamera(),{spacingInNormalDirection:n}=i.utilities.getTargetVolumeAndSpacingInNormalDir(a,e);o=this.filterAnnotationsWithinSlice(t,e,n)}else o=(0,r.filterAnnotationsForDisplay)(a,t);return o}filterAnnotationsWithinSlice(e,t,n){const{viewPlaneNormal:o}=t,s=e.filter(e=>{let n=e.metadata.viewPlaneNormal;if(!e.metadata.referencedImageId&&!n&&e.metadata.FrameOfReferenceUID){for(const n of e.data.contour.polyline){const e=a.eR.sub(a.eR.create(),n,t.focalPoint),o=a.eR.dot(e,t.viewPlaneNormal);if(!i.utilities.isEqual(o,0))return!1}return e.metadata.viewPlaneNormal=t.viewPlaneNormal,e.metadata.cameraFocalPoint=t.focalPoint,!0}if(!n){const{referencedImageId:t}=e.metadata,{imageOrientationPatient:o}=i.metaData.get("imagePlaneModule",t),s=a.eR.fromValues(o[0],o[1],o[2]),r=a.eR.fromValues(o[3],o[4],o[5]);n=a.eR.create(),a.eR.cross(n,s,r),e.metadata.viewPlaneNormal=n}const s=Math.abs(a.eR.dot(o,n))>y;return n&&s});if(!s.length)return[];const r=n/2,{focalPoint:l}=t,d=[];for(const e of s){const t=e.data.contour.polyline[0];if(!e.isVisible)continue;const n=a.eR.create();a.eR.sub(n,l,t);const i=a.eR.dot(n,o);Math.abs(i)<r&&d.push(e)}return d}isContourSegmentationTool(){return!1}createAnnotation(e){const t=e.detail.currentPoints.world,n=super.createAnnotation(e);return i.utilities.deepMerge(n,{data:{contour:{polyline:[[...t]]},label:"",cachedStats:{}},onInterpolationComplete:e=>{e.data.handles.points.length=0}})}getAnnotationStyle(e){return super.getAnnotationStyle(e)}renderAnnotationInstance(e){const{enabledElement:t,targetId:n,svgDrawingHelper:i}=e,a=e.annotation;let o=!1;const{viewport:s,renderingEngine:r}=t,l=this.isDrawing,d=this.isEditingOpen,c=this.isEditingClosed;if(l||d||c){const e=this.commonData.annotation.annotationUID;if(a.annotationUID===e)if(l)this.renderContourBeingDrawn(t,i,a);else if(c)this.renderClosedContourBeingEdited(t,i,a);else{if(!d)throw new Error(`Unknown ${this.getToolName()} annotation rendering state`);this.renderOpenContourBeingEdited(t,i,a)}else this.configuration.displayOnePointAsCrosshairs&&1===a.data.contour.polyline.length?this.renderPointContourWithMarker(t,i,a):this.renderContour(t,i,a);o=!0}else this.configuration.displayOnePointAsCrosshairs&&1===a.data.contour.polyline.length?this.renderPointContourWithMarker(t,i,a):this.renderContour(t,i,a);if(this.configuration.calculateStats)return this._calculateStatsIfActive(a,n,s,r,t),this._renderStats(a,s,t,i),o}_calculateStatsIfActive(e,t,n,i,a){const o=this.commonData?.annotation.annotationUID;if((e.annotationUID!==o||this.commonData?.movingTextBox)&&!this.commonData?.movingTextBox){const{data:o}=e;o.cachedStats[t]?.unit?e.invalidated&&this._throttledCalculateCachedStats(e,n,i,a):(o.cachedStats[t]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,unit:null},this._calculateCachedStats(e,n,i,a))}}updateClosedCachedStats({viewport:e,points:t,imageData:n,metadata:a,cachedStats:o,targetId:r,modalityUnit:l,canvasCoordinates:d,calibratedScale:c,deltaInX:h,deltaInY:g}){const{scale:u,areaUnit:m,unit:p}=c,{voxelManager:v}=e.getImageData(),f=i.utilities.transformWorldToIndex(n,t[0]);f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]);let w=f[0],E=f[0],C=f[1],b=f[1],T=f[2],A=f[2];for(let e=1;e<t.length;e++){const a=i.utilities.transformWorldToIndex(n,t[e]);a[0]=Math.floor(a[0]),a[1]=Math.floor(a[1]),a[2]=Math.floor(a[2]),w=Math.min(w,a[0]),E=Math.max(E,a[0]),C=Math.min(C,a[1]),b=Math.max(b,a[1]),T=Math.min(T,a[2]),A=Math.max(A,a[2])}const S=i.utilities.transformWorldToIndex(n,t[1]);S[0]=Math.floor(S[0]),S[1]=Math.floor(S[1]),S[2]=Math.floor(S[2]);let M=s.polyline.getArea(d)/u/u;M*=h*g;const D=(0,_.A)(t,closed)/u,y=.01*(E-w),P=.01*(b-C),x=.01*(A-T);w=Math.floor(w-y),E=Math.ceil(E+y),C=Math.floor(C-P),b=Math.ceil(b+P),T=Math.floor(T-x),A=Math.ceil(A+x);const R=[[w,E],[C,b],[T,A]],L=n.indexToWorld([E,b,A]),O=e.worldToCanvas(L);let U,k=0,N=[],V=0;v&&(U=v.forEach(this.configuration.statsCalculator.statsCallback,{imageData:n,isInObject:(t,n)=>{let i=!0;const a=e.worldToCanvas(t);return a[1]!=k&&(V=0,k=a[1],N=(0,I.getLineSegmentIntersectionsCoordinates)(d,a,[O[0],a[1]]),N.sort(function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1})),N.length&&a[0]>N[0][0]&&(N.shift(),V++),V%2==0&&(i=!1),i},boundsIJK:R,returnPoints:this.configuration.storePointData}));const W=this.configuration.statsCalculator.getStatistics();o[r]={Modality:a.Modality,area:M,perimeter:D,mean:W.mean?.value,max:W.max?.value,min:W.min?.value,stdDev:W.stdDev?.value,statsArray:W.array,pointsInShape:U,areaUnit:m,modalityUnit:l,unit:p}}updateOpenCachedStats({targetId:e,metadata:t,cachedStats:n,modalityUnit:i,calibratedScale:a,points:o}){const{scale:s,unit:r}=a,l=(0,_.A)(o,closed)/s;n[e]={Modality:t.Modality,length:l,modalityUnit:i,unit:r}}}function x(e,t){const n=e.cachedStats[t],{area:a,mean:o,stdDev:s,length:r,perimeter:l,max:d,min:c,isEmptyArea:h,unit:g,areaUnit:u,modalityUnit:m}=n||{},p=[];if(i.utilities.isNumber(a)){const e=h?"Area: Oblique not supported":`Area: ${i.utilities.roundNumber(a)} ${u}`;p.push(e)}return i.utilities.isNumber(o)&&p.push(`Mean: ${i.utilities.roundNumber(o)} ${m}`),i.utilities.isNumber(d)&&p.push(`Max: ${i.utilities.roundNumber(d)} ${m}`),i.utilities.isNumber(c)&&p.push(`Min: ${i.utilities.roundNumber(c)} ${m}`),i.utilities.isNumber(s)&&p.push(`Std Dev: ${i.utilities.roundNumber(s)} ${m}`),i.utilities.isNumber(l)&&p.push(`Perimeter: ${i.utilities.roundNumber(l)} ${g}`),i.utilities.isNumber(r)&&p.push(`${i.utilities.roundNumber(r)} ${g}`),p}const R=P},4010:(e,t,n)=>{"use strict";n.d(t,{A:()=>M});var i=n(85817),a=n(15327),o=n(4096),s=n(27730),r=n(6802),l=n(2076),d=n(29601),c=n(44049),h=n(74347),g=n(85204),u=n(99737),m=n(60810),p=n(33657),v=n(473),f=n(35489),w=n(7001),E=n(58640),I=n(40634),C=n(18990),b=n(73262),_=n(76712);const{transformWorldToIndex:T}=a.utilities;class A extends i.EC{static{this.toolName="RectangleROI"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,shadow:!0,preventHandleOutsideImage:!1,calculateStats:!0,getTextLines:S,statsCalculator:b.BasicStatsCalculator}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,s=(0,a.getEnabledElement)(i),{viewport:l}=s;this.isDrawing=!0;const d=this.constructor.createAnnotationForViewport(l,{data:{handles:{points:[[...o],[...o],[...o],[...o]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}}});(0,r.lC)(d,i);const c=(0,m.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:d,viewportIdsToRender:c,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,w.hideElementCursor)(i),e.preventDefault(),(0,E.A)(c),d},this.isPointNearTool=(e,t,n,i)=>{const o=(0,a.getEnabledElement)(e),{viewport:s}=o,{data:r}=t,{points:l}=r.handles,d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[3]),h=this._getRectangleImageCoordinates([d,c]),g=[n[0],n[1]],{left:u,top:m,width:v,height:f}=h;return p.distanceToPoint([u,m,v,f],g)<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=(0,m.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i),(0,w.hideElementCursor)(i);const s=(0,a.getEnabledElement)(i),{renderingEngine:r}=s;(0,E.A)(o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,m.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(o),(0,w.hideElementCursor)(o);const c=(0,a.getEnabledElement)(o),{renderingEngine:h}=c;(0,E.A)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:s}=this.editData,{data:l}=i;o&&!s||(l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n),this.doneEditMemo(),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.O8)(i.annotationUID),(0,E.A)(a),o&&(0,c.triggerAnnotationCompleted)(i))},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:s,movingTextBox:r,newAnnotation:l}=this.editData;this.createMemo(n,i,{newAnnotation:l});const{data:d}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world,{points:a}=d.handles;a.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{const{currentPoints:e}=t,o=(0,a.getEnabledElement)(n),{worldToCanvas:r,canvasToWorld:l}=o.viewport,c=e.world,{points:h}=d.handles;let g,u,m,p,v,f,w,E;switch(h[s]=[...c],s){case 0:case 3:g=r(h[0]),p=r(h[3]),u=[p[0],g[1]],m=[g[0],p[1]],f=l(u),w=l(m),h[1]=f,h[2]=w;break;case 1:case 2:u=r(h[1]),m=r(h[2]),g=[m[0],u[1]],p=[u[0],m[1]],v=l(g),E=l(p),h[0]=v,h[3]=E}i.invalidated=!0}this.editData.hasMoved=!0;(0,a.getEnabledElement)(n);(0,E.A)(o),i.invalidated&&(0,c.triggerAnnotationModified)(i,n,u.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;return t.highlighted=!1,a.handles.activeHandleIndex=null,(0,E.A)(n),i&&(0,c.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(u.Events.MOUSE_UP,this._endCallback),e.addEventListener(u.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(u.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(u.Events.TOUCH_END,this._endCallback),e.addEventListener(u.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(u.Events.MOUSE_UP,this._endCallback),e.removeEventListener(u.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(u.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(u.Events.TOUCH_END,this._endCallback),e.removeEventListener(u.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(u.Events.MOUSE_UP,this._endCallback),e.addEventListener(u.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(u.Events.TOUCH_END,this._endCallback),e.addEventListener(u.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(u.Events.MOUSE_UP,this._endCallback),e.removeEventListener(u.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(u.Events.TOUCH_END,this._endCallback),e.removeEventListener(u.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(u.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let s=(0,r.Rh)(this.getToolName(),o);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(o,s),!s?.length)return n;const c=this.getTargetId(i),g=i.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<s.length;o++){const r=s[o],{annotationUID:m,data:p}=r,{points:f,activeHandleIndex:w}=p.handles,E=f.map(e=>i.worldToCanvas(e));u.annotationUID=m;const{color:I,lineWidth:C,lineDash:b}=this.getAnnotationStyle({annotation:r,styleSpecifier:u}),{viewPlaneNormal:T,viewUp:A}=i.getCamera();if(p.cachedStats[c]&&null!=p.cachedStats[c].areaUnit){if(r.invalidated&&(this._throttledCalculateCachedStats(r,T,A,g,e),i instanceof a.VolumeViewport)){const{referencedImageId:e}=r.metadata;for(const t in p.cachedStats)if(t.startsWith("imageId")){g.getStackViewports().find(t=>{const n=a.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=a.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n})&&delete p.cachedStats[t]}}}else p.cachedStats[c]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(r,T,A,g,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let S;if(!(0,d.isAnnotationVisible)(m))continue;(0,l.isAnnotationLocked)(m)||this.editData||null==w||(S=[E[w]]);const M=Boolean((0,_.h)("showHandlesAlways",{}));if(S||M){const e="0";(0,h.drawHandles)(t,m,e,M?E:S,{color:I})}const D=`${m}-rect`,y="0";(0,h.drawRectByCoordinates)(t,m,y,E,{color:I,lineDash:b,lineWidth:C},D),n=!0;const P=this.getLinkedTextBoxStyle(u,r);if(!P.visibility){p.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const x=this.configuration.getTextLines(p,c);if(!x||0===x.length)continue;if(!p.handles.textBox.hasMoved){const e=(0,v.getTextBoxCoordsCanvas)(E);p.handles.textBox.worldPosition=i.canvasToWorld(e)}const R=i.worldToCanvas(p.handles.textBox.worldPosition),L="1",O=(0,h.drawLinkedTextBox)(t,m,L,x,R,E,{},P),{x:U,y:k,width:N,height:V}=O;p.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([U,k]),topRight:i.canvasToWorld([U+N,k]),bottomLeft:i.canvasToWorld([U,k+V]),bottomRight:i.canvasToWorld([U+N,k+V])}}return n},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,i,a)=>{if(!this.configuration.calculateStats)return;const{data:s}=e,{viewport:r}=a,{element:l}=r,d=s.handles.points[0],h=s.handles.points[3],{cachedStats:g}=s,m=Object.keys(g);for(let i=0;i<m.length;i++){const a=m[i],s=this.getTargetImageData(a);if(!s)continue;const{dimensions:l,imageData:c,metadata:u,voxelManager:p}=s,v=T(c,d);v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]);const w=T(c,h);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(v,w,l)){this.isHandleOutsideImage=!1;const i=[[Math.min(v[0],w[0]),Math.max(v[0],w[0])],[Math.min(v[1],w[1]),Math.max(v[1],w[1])],[Math.min(v[2],w[2]),Math.max(v[2],w[2])]],{worldWidth:l,worldHeight:m}=(0,f.A)(t,n,d,h),E=[v,w],{scale:b,areaUnit:_}=(0,o.Op)(s,E),T=Math.abs(l*m)/(b*b),A={isPreScaled:(0,C.u)(r,a),isSuvScaled:this.isSuvScaled(r,a,e.metadata.referencedImageId)},S=(0,I.j)(u.Modality,e.metadata.referencedImageId,A);let M;p&&(M=p.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:i,imageData:c,returnPoints:this.configuration.storePointData}));const D=this.configuration.statsCalculator.getStatistics();g[a]={Modality:u.Modality,area:T,mean:D.mean?.value,stdDev:D.stdDev?.value,max:D.max?.value,min:D.min?.value,statsArray:D.array,pointsInShape:M,areaUnit:_,modalityUnit:S}}else this.isHandleOutsideImage=!0,g[a]={Modality:u.Modality}}const p=e.invalidated;return e.invalidated=!1,p&&(0,c.triggerAnnotationModified)(e,l,u.ChangeTypes.StatsUpdated),g},this._isInsideVolume=(e,t,n)=>a.utilities.indexWithinDimensions(e,n)&&a.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}static{this.hydrate=(e,t,n)=>{const i=(0,a.getEnabledElementByViewportId)(e);if(!i)return;const{FrameOfReferenceUID:o,referencedImageId:s,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase(A,i,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||a.utilities.uuidv4(),data:{handles:{points:t,activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:o,referencedImageId:s,...g}};(0,r.lC)(u,c.element),(0,E.A)([c.id])}}}function S(e,t){const n=e.cachedStats[t],{area:i,mean:o,max:s,stdDev:r,areaUnit:l,modalityUnit:d,min:c}=n;if(null==o)return;const h=[];return a.utilities.isNumber(i)&&h.push(`Area: ${a.utilities.roundNumber(i)} ${l}`),a.utilities.isNumber(o)&&h.push(`Mean: ${a.utilities.roundNumber(o)} ${d}`),a.utilities.isNumber(s)&&h.push(`Max: ${a.utilities.roundNumber(s)} ${d}`),a.utilities.isNumber(c)&&h.push(`Min: ${a.utilities.roundNumber(c)} ${d}`),a.utilities.isNumber(r)&&h.push(`Std Dev: ${a.utilities.roundNumber(r)} ${d}`),h}const M=A},48736:(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var i=n(15327),a=n(3823),o=n(99737),s=n(17492),r=n(1989),l=n(56789),d=n(33852),c=n(74347),h=n(7001),g=n(58640),u=n(23631),m=n(40905);class p extends u.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:l.kr,ERASE_INSIDE_CIRCLE:d.r,FILL_INSIDE_SPHERE:s.Jq,ERASE_INSIDE_SPHERE:r._,THRESHOLD_INSIDE_CIRCLE:l.q,THRESHOLD_INSIDE_SPHERE:s.rd,THRESHOLD_INSIDE_SPHERE_WITH_ISLAND_REMOVAL:s.Sw},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25,useCenterSegmentIndex:!1,preview:{enabled:!1,previewColors:{0:[255,255,255,128]},previewTimeMs:250,previewMoveDistance:8,dragMoveDistance:4,dragTimeMs:500},actions:{[o.StrategyCallbacks.AcceptPreview]:{method:o.StrategyCallbacks.AcceptPreview,bindings:[{key:"Enter"}]},[o.StrategyCallbacks.RejectPreview]:{method:o.StrategyCallbacks.RejectPreview,bindings:[{key:"Escape"}]},[o.StrategyCallbacks.Interpolate]:{method:o.StrategyCallbacks.Interpolate,bindings:[{key:"i"}],configuration:{useBallStructuringElement:!0,noUseDistanceTransform:!0,noUseExtrapolation:!0}},interpolateExtrapolation:{method:o.StrategyCallbacks.Interpolate,bindings:[{key:"e"}],configuration:{}}}}}){super(e,t),this._lastDragInfo=null,this.onSetToolPassive=e=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=e=>{this.disableCursor()},this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:s}=t,r=(0,i.getEnabledElement)(n),{viewport:l}=r;this._editData=this.createEditData(n),this._activateDraw(n),(0,h.hideElementCursor)(n),e.preventDefault(),this._previewData.isDrag=!1,this._previewData.timerStart=Date.now();const d=a.Zc.clone(s.canvas),c=l.canvasToWorld([d[0],d[1]]);this._lastDragInfo={canvas:d,world:a.eR.clone(c)};const u=this._hoverData||this.createHoverData(n);(0,g.A)(u.viewportIdsToRender);const m=this.getOperationData(n);return this.applyActiveStrategyCallback(r,m,o.StrategyCallbacks.OnInteractionStart),!0},this.mouseMoveCallback=e=>{if(this.mode===o.ToolModes.Active){if(this.updateCursor(e),!this.configuration.preview.enabled)return;const{previewTimeMs:t,previewMoveDistance:n,dragMoveDistance:i}=this.configuration.preview,{currentPoints:o,element:s}=e.detail,{canvas:r}=o,{startPoint:l,timer:d,timerStart:c,isDrag:h}=this._previewData;if(h)return;const g=a.Zc.distance(r,l),u=Date.now()-c;if((g>n||u>t&&g>i)&&(d&&(window.clearTimeout(d),this._previewData.timer=null),h||this.rejectPreview(s)),!this._previewData.timer){const e=window.setTimeout(this.previewCallback,250);Object.assign(this._previewData,{timerStart:Date.now(),timer:e,startPoint:r,element:s})}}},this.previewCallback=()=>{if(this._previewData.isDrag)return void(this._previewData.timer=null);this._previewData.timer=null;const e=this.getOperationData(this._previewData.element),t=(0,i.getEnabledElement)(this._previewData.element);if(!t)return;const{viewport:n}=t,a=this.configuration.activeStrategy,s=(0,m.S)({operationData:e,viewport:n,strategy:a});if(!e)return;const r=this.createMemo(e.segmentationId,s.segmentationVoxelManager);this._previewData.preview=this.applyActiveStrategyCallback((0,i.getEnabledElement)(this._previewData.element),{...e,...s,memo:r},o.StrategyCallbacks.Preview)},this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,s=(0,i.getEnabledElement)(n),{viewport:r}=s;this.updateCursor(e);const{viewportIdsToRender:l}=this._hoverData;(0,g.A)(l);const d=a.Zc.distance(o.canvas,this._previewData.startPoint),{dragTimeMs:c,dragMoveDistance:h}=this.configuration.preview;if(!this._previewData.isDrag&&Date.now()-this._previewData.timerStart<c&&d<h)return;if(this._previewData.timer&&(window.clearTimeout(this._previewData.timer),this._previewData.timer=null),!this._lastDragInfo){const e=this._previewData.startPoint,t=r.canvasToWorld([e[0],e[1]]);this._lastDragInfo={canvas:a.Zc.clone(e),world:a.eR.clone(t)}}const u=o.canvas,m=r.canvasToWorld([u[0],u[1]]);this._hoverData=this.createHoverData(n,u),this._calculateCursor(n,u);const p=this.getOperationData(n);p.strokePointsWorld=[a.eR.clone(this._lastDragInfo.world),a.eR.clone(m)],this._previewData.preview=this.applyActiveStrategy(s,p);const v=a.Zc.clone(u);this._lastDragInfo={canvas:v,world:a.eR.clone(m)},this._previewData.element=n,this._previewData.timerStart=Date.now()+c,this._previewData.isDrag=!0,this._previewData.startPoint=v},this._endCallback=e=>{const t=e.detail,{element:n}=t,a=(0,i.getEnabledElement)(n),s=this.getOperationData(n);this._previewData.preview||this._previewData.isDrag||this.applyActiveStrategy(a,s),this.doneEditMemo(),this._deactivateDraw(n),(0,h.resetElementCursor)(n),this.updateCursor(e),this._editData=null,this._lastDragInfo=null,this.applyActiveStrategyCallback(a,s,o.StrategyCallbacks.OnInteractionEnd),this._previewData.isDrag||this.acceptPreview(n)},this._activateDraw=e=>{e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0,this.rejectPreview()}updateCursor(e){const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas;this._hoverData=this.createHoverData(n,a),this._calculateCursor(n,a),this._hoverData&&(0,g.A)(this._hoverData.viewportIdsToRender)}_calculateCursor(e,t){const n=(0,i.getEnabledElement)(e),{viewport:o}=n,{canvasToWorld:s}=o,r=o.getCamera(),{brushSize:l}=this.configuration,d=a.eR.fromValues(r.viewUp[0],r.viewUp[1],r.viewUp[2]),c=a.eR.fromValues(r.viewPlaneNormal[0],r.viewPlaneNormal[1],r.viewPlaneNormal[2]),h=a.eR.create();a.eR.cross(h,d,c);const g=s([t[0],t[1]]),u=a.eR.create(),m=a.eR.create(),p=a.eR.create(),v=a.eR.create();for(let e=0;e<=2;e++)u[e]=g[e]-d[e]*l,m[e]=g[e]+d[e]*l,p[e]=g[e]-h[e]*l,v[e]=g[e]+h[e]*l;if(!this._hoverData)return;const{brushCursor:f}=this._hoverData,{data:w}=f;void 0===w.handles&&(w.handles={}),w.handles.points=[u,m,p,v];const E=this.configuration.activeStrategy,I=this.configuration.strategies[E];"function"==typeof I?.computeInnerCircleRadius&&I.computeInnerCircleRadius({configuration:this.configuration,viewport:o}),w.invalidated=!1}getStatistics(e,t){if(!e)return;const n=(0,i.getEnabledElement)(e);return this.applyActiveStrategyCallback(n,this.getOperationData(e),o.StrategyCallbacks.GetStatistics,t)}rejectPreview(e=this._previewData.element){if(!e)return;this.doneEditMemo();const t=(0,i.getEnabledElement)(e);t&&(this.applyActiveStrategyCallback(t,this.getOperationData(e),o.StrategyCallbacks.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1)}acceptPreview(e=this._previewData.element){e&&super.acceptPreview(e)}interpolate(e,t){if(!e)return;const n=(0,i.getEnabledElement)(e);this._previewData.preview=this.applyActiveStrategyCallback(n,this.getOperationData(e),o.StrategyCallbacks.Interpolate,t.configuration),this._previewData.isDrag=!0}invalidateBrushCursor(){if(void 0===this._hoverData)return;const{data:e}=this._hoverData.brushCursor,{viewport:t}=this._hoverData;e.invalidated=!0;const{segmentColor:n}=this.getActiveSegmentationData(t)||{};this._hoverData.brushCursor.metadata.segmentColor=n}renderAnnotation(e,t){if(!this._hoverData)return;const{viewport:n}=e;if(!this._hoverData.viewportIdsToRender.includes(n.id))return;const i=this._hoverData.brushCursor;if(!0===i.data.invalidated){const{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}const a=i.metadata;if(!a)return;const o=a.brushCursorUID,s=i.data,{points:r}=s.handles,l=r.map(e=>n.worldToCanvas(e)),d=l[0],h=l[1],g=[Math.floor((d[0]+h[0])/2),Math.floor((d[1]+h[1])/2)],u=Math.abs(d[1]-Math.floor((d[1]+h[1])/2)),m=`rgb(${a.segmentColor?.slice(0,3)||[0,0,0]})`;if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");(0,c.drawCircle)(t,o,"0",g,u,{color:m,lineDash:0===this.centerSegmentIndexInfo.segmentIndex?[1,2]:null});const{dynamicRadiusInCanvas:p}=this.configuration?.threshold||{dynamicRadiusInCanvas:0};if(p){const e="1";(0,c.drawCircle)(t,o,e,g,p,{color:m})}}}p.toolName="Brush";const v=p},23631:(e,t,n)=>{"use strict";n.d(t,{A:()=>E});var i=n(15327),a=n(85817),o=n(18682),s=n(67165),r=n(26795),l=n(33283),d=n(97577),c=n(93733),h=n(60740),g=n(99737),u=n(2397),m=n(82056),p=n(13165),v=n(92984),f=n(49906),w=n(99522);class E extends a.oS{static{this.previewData={preview:null,element:null,timerStart:0,timer:null,startPoint:[NaN,NaN],isDrag:!1}}constructor(e,t){super(e,t),this.memoMap=new Map,this.acceptedMemoIds=new Map,this.centerSegmentIndexInfo={segmentIndex:null,hasSegmentIndex:!1,hasPreviewIndex:!1,changedIndices:[]}}_historyRedoHandler(e){const{id:t,operationType:n}=e.detail;if("labelmap"===n){if(this.acceptedMemoIds.has(t)){this._hoverData=null;const e=this.acceptedMemoIds.get(t),n=e?.element,a=this.getOperationData(n);a.segmentIndex=e?.segmentIndex,n&&this.applyActiveStrategyCallback((0,i.getEnabledElement)(n),a,g.StrategyCallbacks.AcceptPreview)}this._previewData.isDrag=!0}}get _previewData(){return E.previewData}hasPreviewData(){return!!this._previewData.preview}shouldResolvePreviewRequests(){return("Active"===this.mode||"Enabled"===this.mode)&&this.hasPreviewData()}createMemo(e,t){const n=t.id;if(this.memo&&this.memo.segmentationVoxelManager===t)return this.memo;let i=this.memoMap.get(n);return i?i.redoVoxelManager&&(i=u.createLabelmapMemo(e,t),this.memoMap.set(n,i)):(i=u.createLabelmapMemo(e,t),this.memoMap.set(n,i)),this.memo=i,i}createEditData(e){const t=(0,i.getEnabledElement)(e),{viewport:n}=t,a=(0,s.T)(n.id);if(!a){const e=new CustomEvent(i.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"No active segmentation detected, create a segmentation representation before using the brush tool"},cancelable:!0});return i.eventTarget.dispatchEvent(e),null}const{segmentationId:o}=a,d=(0,r.getLockedSegmentIndices)(o),{representationData:c}=(0,l.T)(o);return this.getEditData({viewport:n,representationData:c,segmentsLocked:d,segmentationId:o})}getEditData({viewport:e,representationData:t,segmentsLocked:n,segmentationId:a}){if(e instanceof i.BaseVolumeViewport){const{volumeId:a}=t[o.A.Labelmap],s=e.getActors();if(e instanceof i.StackViewport){const e=new CustomEvent(i.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"Cannot perform brush operation on the selected viewport"},cancelable:!0});return i.eventTarget.dispatchEvent(e),null}const r=s.map(e=>i.cache.getVolume(e.referencedId)),l=i.cache.getVolume(a),d=r.find(e=>i.utilities.isEqual(e.dimensions,l.dimensions))?.volumeId||r[0]?.volumeId;return{volumeId:a,referencedVolumeId:this.configuration.threshold?.volumeId??d,segmentsLocked:n}}{const t=(0,d.vl)(e.id,a);if(!t)return;return{imageId:t,segmentsLocked:n}}}createHoverData(e,t){const n=(0,i.getEnabledElement)(e),{viewport:a}=n,o=a.getCamera(),{viewPlaneNormal:s,viewUp:r}=o,l=[a.id],{segmentIndex:d,segmentationId:c,segmentColor:h}=this.getActiveSegmentationData(a)||{};return{brushCursor:{metadata:{viewPlaneNormal:[...s],viewUp:[...r],FrameOfReferenceUID:a.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:h},data:{}},centerCanvas:t,segmentIndex:d,viewport:a,segmentationId:c,segmentColor:h,viewportIdsToRender:l}}getActiveSegmentationData(e){const t=e.id,n=(0,s.T)(t);if(!n)return;const{segmentationId:i}=n,a=(0,h.Q)(i);if(!a)return;return{segmentIndex:a,segmentationId:i,segmentColor:(0,c.getSegmentIndexColor)(t,i,a)}}getOperationData(e){const t=this._editData||this.createEditData(e),{segmentIndex:n,segmentationId:a,brushCursor:o}=this._hoverData||this.createHoverData(e),{data:s,metadata:r={}}=o||{},{viewPlaneNormal:l,viewUp:d}=r,h=this.configuration.preview?.previewColors?.[n],{viewport:g}=(0,i.getEnabledElement)(e),u=(0,c.getSegmentIndexColor)(g.id,a,n);if(!h&&!u)return;let m=null,p=null;this.configuration.preview?.enabled&&(m=h||function(e,t,n,i,a=.4){return[Math.round(e+(255-e)*a),Math.round(t+(255-t)*a),Math.round(n+(255-n)*a),i]}(...u),p=255);return{...t,points:s?.handles?.points,segmentIndex:n,viewPlaneNormal:l,previewOnHover:!this._previewData.isDrag,toolGroupId:this.toolGroupId,segmentationId:a,viewUp:d,centerSegmentIndexInfo:this.centerSegmentIndexInfo,activeStrategy:this.configuration.activeStrategy,configuration:this.configuration,previewColor:m,previewSegmentIndex:p,createMemo:this.createMemo.bind(this)}}addPreview(e=this._previewData.element,t){const{_previewData:n}=this,a=t?.acceptReject;!0===a?this.acceptPreview(e):!1===a&&this.rejectPreview(e);const o=(0,i.getEnabledElement)(e),s=this.applyActiveStrategyCallback(o,this.getOperationData(e),g.StrategyCallbacks.AddPreview);return n.isDrag=!0,s?.modified&&(n.preview=s,n.element=e),s}rejectPreview(e=this._previewData.element){if(!e)return;this.doneEditMemo();const t=(0,i.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),g.StrategyCallbacks.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1}acceptPreview(e=this._previewData.element){if(!e)return;const t=this.getOperationData(e);this.memo&&this.memo.id&&this.acceptedMemoIds.set(this.memo.id,{element:e,segmentIndex:t.segmentIndex});const n=(0,i.getEnabledElement)(e);this.applyActiveStrategyCallback(n,t,g.StrategyCallbacks.AcceptPreview),this.doneEditMemo(),this._previewData.preview=null,this._previewData.isDrag=!1}static viewportContoursToLabelmap(e,t){const n=t?.removeContours??!0,i=(0,m.getAllAnnotations)(),a=(0,p.filterAnnotationsForDisplay)(e,i);if(!a?.length)return;const o=a.filter(e=>e.data.contour?.polyline?.length);if(!o.length)return;const s=new E({},{configuration:{strategies:{FILL_INSIDE_CIRCLE:w.fillInsideCircle},activeStrategy:"FILL_INSIDE_CIRCLE"}}).addPreview(e.element),{memo:r,segmentationId:l}=s,d=r?.voxelManager,c=d.sourceVoxelManager||d,{dimensions:g}=d,u=e.getDefaultActor().actor.getMapper().getInputData();for(const e of o){const t=[[1/0,-1/0],[1/0,-1/0],[1/0,-1/0]],{polyline:i}=e.data.contour;for(const e of i){u.worldToIndex(e).forEach((e,n)=>{t[n][0]=Math.min(t[n][0],e),t[n][1]=Math.max(t[n][1],e)})}t.forEach((e,t)=>{e[0]=Math.round(Math.max(0,e[0])),e[1]=Math.round(Math.min(g[t]-1,e[1]))});const a=(0,h.Q)(l),o=e.data.handles?.[0]||i[0],s=u.worldToIndex(o).map(Math.round),r=c.getAtIJKPoint(s)||0;let p=!1,f=!1;for(const e of i){const t=u.worldToIndex(e).map(Math.round),n=c.getAtIJKPoint(t);n===r?p=!0:n>=0&&(f=!0)}const w=p&&f?r:0===r?a:0;for(let e=t[0][0];e<=t[0][1];e++)for(let n=t[1][0];n<=t[1][1];n++)for(let a=t[2][0];a<=t[2][1];a++){const t=u.indexToWorld([e,n,a]);(0,v.isPointInsidePolyline3D)(t,i)&&d.setAtIJK(e,n,a,w)}n&&(0,m.removeAnnotation)(e.annotationUID)}const I=d.getArrayOfModifiedSlices();(0,f.triggerSegmentationDataModified)(l,I)}}},56789:(e,t,n)=>{"use strict";n.d(t,{C$:()=>u,kr:()=>w,mu:()=>p,pB:()=>v,q:()=>E});var i=n(3823),a=n(15327),o=n(72282),s=n(55887),r=n(99737),l=n(11990),d=n(62783);const{transformWorldToIndex:c,transformIndexToWorld:h,isEqual:g}=a.utilities;function u(e){const[t,n,i,a]=e;return[[i[0],n[1]],[a[0],t[1]],[i[0],t[1]],[a[0],n[1]]]}const m={[r.StrategyCallbacks.Initialize]:e=>{const{points:t,viewport:n,segmentationImageData:a,viewUp:s,viewPlaneNormal:r}=e;if(!t)return;const l=i.eR.create();t.length>=2?(i.eR.add(l,t[0],t[1]),i.eR.scale(l,l,.5)):i.eR.copy(l,t[0]),e.centerWorld=l,e.centerIJK=c(a,l);const d=t.length>=2?i.eR.distance(t[0],t[1])/2:0,h=u(t.map(e=>n.worldToCanvas(e))).map(e=>n.canvasToWorld(e)),g=i.eR.fromValues(s[0],s[1],s[2]);i.eR.normalize(g,g);const m=i.eR.fromValues(r[0],r[1],r[2]);i.eR.normalize(m,m);const v=i.eR.create();i.eR.cross(v,g,m),i.eR.normalize(v,v);const f=(e.strokePointsWorld&&e.strokePointsWorld.length>0?e.strokePointsWorld:[e.centerWorld]).map(e=>i.eR.clone(e)),w=f.flatMap(e=>function(e,t,n,a){const o=i.eR.fromValues(e[0],e[1],e[2]),s=i.eR.create();i.eR.scaleAndAdd(s,o,t,a);const r=i.eR.create();i.eR.scaleAndAdd(r,o,t,-a);const l=i.eR.create();i.eR.scaleAndAdd(l,o,n,a);const d=i.eR.create();return i.eR.scaleAndAdd(d,o,n,-a),[r,s,d,l]}(e,g,v,d)),E=w.map(e=>c(a,e)),I=(0,o.getBoundingBoxAroundShapeIJK)(E,a.getDimensions());e.strokePointsWorld=f,e.isInObject=p(h,{strokePointsWorld:f,segmentationImageData:a,radius:d}),e.isInObjectBoundsIJK=I}};function p(e=[],t={}){if(!e||4!==e.length)throw new Error("createPointInEllipse: cornersInWorld must have 4 points");const[n,a,o,s]=e,r=i.eR.create();i.eR.add(r,n,a),i.eR.scale(r,r,.5);const l=i.eR.create();i.eR.subtract(l,s,n);const c=i.eR.length(l)/2;i.eR.normalize(l,l);const u=i.eR.create();i.eR.subtract(u,o,n);const m=i.eR.length(u)/2;i.eR.normalize(u,u);const p=i.eR.create();i.eR.cross(p,l,u),i.eR.normalize(p,p);const v=t.radius??Math.max(c,m),f=function(e,t){if(!e.length||t<=0)return null;const n=t*t,i=e.map(e=>[e[0],e[1],e[2]]),a=[];for(let e=1;e<i.length;e++){const t=i[e-1],n=i[e],o=n[0]-t[0],s=n[1]-t[1],r=n[2]-t[2],l=o*o+s*s+r*r;a.push({start:t,vector:[o,s,r],lengthSquared:l})}return e=>{if(!e)return!1;for(const t of i){const i=e[0]-t[0],a=e[1]-t[1],o=e[2]-t[2];if(i*i+a*a+o*o<=n)return!0}for(const{start:t,vector:i,lengthSquared:o}of a){if(0===o){const i=e[0]-t[0],a=e[1]-t[1],o=e[2]-t[2];if(i*i+a*a+o*o<=n)return!0;continue}const a=e[0]-t[0],s=e[1]-t[1],r=e[2]-t[2],l=a*i[0]+s*i[1]+r*i[2],d=Math.max(0,Math.min(1,l/o)),c=t[0]+i[0]*d,h=t[1]+i[1]*d,g=t[2]+i[2]*d,u=e[0]-c,m=e[1]-h,p=e[2]-g;if(u*u+m*m+p*p<=n)return!0}return!1}}(t.strokePointsWorld||[],v);if(g(c,m)){const e={center:r,radius:c,radius2:c*c};return(n,i)=>{let a=n;return!a&&i&&t.segmentationImageData&&(a=h(t.segmentationImageData,i)),!!a&&(!!f?.(a)||(0,d.d)(e,a))}}return(e,a)=>{let o=e;if(!o&&a&&t.segmentationImageData&&(o=h(t.segmentationImageData,a)),!o)return!1;if(f?.(o))return!0;const s=i.eR.create();i.eR.subtract(s,o,r);const d=i.eR.dot(s,p),g=i.eR.create();i.eR.scaleAndAdd(g,s,p,-d);const v=i.eR.create(),w=i.eR.create();i.eR.subtract(w,r,n),i.eR.subtract(v,g,w);const E=i.eR.dot(v,l),I=i.eR.dot(v,u);return E*E/(c*c)+I*I/(m*m)<=1}}const v=new s.A("Circle",l.A.regionFill,l.A.setValue,m,l.A.determineSegmentIndex,l.A.preview,l.A.labelmapStatistics),f=new s.A("CircleThreshold",l.A.regionFill,l.A.setValue,m,l.A.determineSegmentIndex,l.A.dynamicThreshold,l.A.threshold,l.A.preview,l.A.islandRemoval,l.A.labelmapStatistics),w=v.strategyFunction,E=f.strategyFunction},10088:(e,t,n)=>{"use strict";n.d(t,{pY:()=>u});var i=n(3823),a=n(15327),o=n(72282),s=n(55887),r=n(99737),l=n(11990);const{transformWorldToIndex:d}=a.utilities,c={[r.StrategyCallbacks.Initialize]:e=>{const{points:t,viewport:n,segmentationImageData:s}=e;if(!t)return;const r=i.eR.fromValues(0,0,0);t.forEach(e=>{i.eR.add(r,r,e)}),i.eR.scale(r,r,1/t.length),e.centerWorld=r,e.centerIJK=d(s,r);const{boundsIJK:l,pointInShapeFn:c}=function(e,t,n){let s=t.map(e=>d(n,e));s=s.map(e=>e.map(e=>Math.round(e)));const r=(0,o.getBoundingBoxAroundShapeIJK)(s,n.getDimensions()),[l,c,h,g]=t,u=i.eR.create(),m=i.eR.create();i.eR.subtract(u,c,l),i.eR.subtract(m,g,l);const p=i.eR.length(u),v=i.eR.length(m);i.eR.normalize(u,u),i.eR.normalize(m,m);const f=i.eR.create();i.eR.cross(f,u,m),i.eR.normalize(f,f);const w=n.getDirection(),E=n.getSpacing(),{viewPlaneNormal:I}=e.getCamera(),C=a.utilities.getSpacingInNormalDirection({direction:w,spacing:E},I),b=e=>{const t=i.eR.create();i.eR.subtract(t,e,l);const n=i.eR.dot(t,u),a=i.eR.dot(t,m),o=Math.abs(i.eR.dot(t,f));return n>=-C&&n<=p+C&&a>=-C&&a<=v+C&&o<=C};return{boundsIJK:r,pointInShapeFn:b}}(n,t,s);e.isInObject=c,e.isInObjectBoundsIJK=l}};const h=new s.A("Rectangle",l.A.regionFill,l.A.setValue,c,l.A.determineSegmentIndex,l.A.preview,l.A.labelmapStatistics),g=new s.A("RectangleThreshold",l.A.regionFill,l.A.setValue,c,l.A.determineSegmentIndex,l.A.dynamicThreshold,l.A.threshold,l.A.preview,l.A.islandRemoval,l.A.labelmapStatistics),u=h.strategyFunction;g.strategyFunction},99522:(e,t,n)=>{"use strict";n.d(t,{fillInsideCircle:()=>i.kr});n(10088);var i=n(56789)},13369:()=>{},64485:(e,t,n)=>{"use strict";n.d(t,{x:()=>o});var i=n(15327),a=(n(82056),n(3823));function o(e,t,n){const o=e.getImageIds();if(!o||!o.length)return;const s=o.map(e=>{const{imagePositionPatient:o}=i.metaData.get("imagePlaneModule",e),s=function(e,t,n){const i=a.eR.create();a.eR.sub(i,e,t);const o=a.eR.dot(i,n);return Math.abs(o)}(t,o,n);return{imageId:e,distance:s}});return s.sort((e,t)=>e.distance-t.distance),s[0].imageId}},76802:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i=function(e,t){const n=e.findIndex(([e,t])=>e===t);if(-1===n)throw new Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e}},87063:(e,t,n)=>{"use strict";n.d(t,{C:()=>r,g:()=>s});var i=n(15327);const{EPSILON:a}=i.CONSTANTS;function o(e,t,n=!1){let i=1/0,o=n?-1/0:0,s=1/0,r=n?-1/0:0,l=1/0,d=n?-1/0:0;const c=3===e[0]?.length;for(let t=0;t<e.length;t++){const n=e[t];i=Math.min(n[0],i),o=Math.max(n[0],o),s=Math.min(n[1],s),r=Math.max(n[1],r),c&&(l=Math.min(n[2]??l,l),d=Math.max(n[2]??d,d))}return t?(i=Math.max(n?t[0]+a:0,i),o=Math.min(n?t[0]-a:t[0]-1,o),s=Math.max(n?t[1]+a:0,s),r=Math.min(n?t[1]-a:t[1]-1,r),c&&3===t.length&&(l=Math.max(n?t[2]+a:0,l),d=Math.min(n?t[2]-a:t[2]-1,d))):n||(i=Math.max(0,i),o=Math.min(1/0,o),s=Math.max(0,s),r=Math.min(1/0,r),c&&(l=Math.max(0,l),d=Math.min(1/0,d))),c?[[i,o],[s,r],[l,d]]:[[i,o],[s,r],null]}function s(e,t){return o(e,t,!1)}function r(e,t){return o(e,t,!0)}},72282:(e,t,n)=>{"use strict";n.r(t),n.d(t,{extend2DBoundingBoxInViewAxis:()=>i.A,getBoundingBoxAroundShape:()=>a.g,getBoundingBoxAroundShapeIJK:()=>a.g,getBoundingBoxAroundShapeWorld:()=>a.C});var i=n(76802),a=n(87063)},56534:(e,t,n)=>{"use strict";n.d(t,{addContourSegmentationAnnotation:()=>s.V,convertContourSegmentationAnnotation:()=>d,createPolylineHole:()=>c.rK,removeContourSegmentationAnnotation:()=>o.M});n(62854);var i=n(15327),a=n(6802),o=n(37354),s=n(85263),r=n(44049);const l="PlanarFreehandContourSegmentationTool";function d(e){const{polyline:t}=e.data?.contour||{};if(!t||t.length<3)return void console.warn("Skipping creation of new annotation due to invalid polyline:",t);(0,a.O8)(e.annotationUID),(0,o.M)(e);const n=t[0],d=t[t.length-1],c={metadata:{...e.metadata,toolName:l,originalToolName:e.metadata.originalToolName||e.metadata.toolName},data:{cachedStats:{},handles:{points:[n,d],textBox:e.data.handles.textBox?{...e.data.handles.textBox}:void 0},contour:{...e.data.contour},spline:e.data.spline,segmentation:{...e.data.segmentation}},annotationUID:i.utilities.uuidv4(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:e.interpolationUID,interpolationCompleted:e.interpolationCompleted};return(0,a.lC)(c,e.metadata.FrameOfReferenceUID),(0,s.V)(c),(0,r.triggerAnnotationModified)(c),c}n(29031),n(21536),n(78130),n(3444),n(49941),n(1318);var c=n(65172);n(98916),n(86591),n(52634),n(63890)},46228:(e,t,n)=>{"use strict"},98013:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n(15327),a=n(3823);const{isEqual:o}=i.utilities;function s(e,t){const{polyline:n}=e.data.contour,{points:i}=e.data.handles,{length:s}=i;if(t===s)return n.length;if(t<0&&(t=(t+s)%s),0===t)return 0;const r=i[t],l=n.findIndex(e=>o(r,e));if(-1!==l)return l;let d=1/0;return n.reduce((e,t,n)=>{const i=a.eR.squaredDistance(t,r);return i<d?(d=i,n):e},-1)}},37546:(e,t,n)=>{"use strict"},52905:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(45217);const a=function(e,t,n){let a,o,s,r,l,d,c=0,h=!1,g=!1,u=!0;const m=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function p(t){const n=a,i=o;return a=o=void 0,c=t,r=e.apply(i,n),r}function v(e,t){return m?window.requestAnimationFrame(e):setTimeout(e,t)}function f(e){const n=e-d;return void 0===d||n>=t||n<0||g&&e-c>=s}function w(){const e=Date.now();if(f(e))return E(e);l=v(w,function(e){const n=e-c,i=t-(e-d);return g?Math.min(i,s-n):i}(e))}function E(e){return l=void 0,u&&a?p(e):(a=o=void 0,r)}function I(...e){const n=Date.now(),i=f(n);if(a=e,o=this,d=n,i){if(void 0===l)return function(e){return c=e,l=v(w,t),h?p(e):r}(d);if(g)return l=v(w,t),p(d)}return void 0===l&&(l=v(w,t)),r}return t=Number(t)||0,(0,i.A)(n)&&(h=Boolean(n.leading),g="maxWait"in n,s=g?Math.max(Number(n.maxWait)||0,t):s,u="trailing"in n?Boolean(n.trailing):u),I.cancel=function(){void 0!==l&&function(e){if(m)return window.cancelAnimationFrame(e);clearTimeout(e)}(l),c=0,a=d=o=l=void 0},I.flush=function(){return void 0===l?r:E(Date.now())},I.pending=function(){return void 0!==l},I}},1239:(e,t,n)=>{"use strict";function i(e){const t=function(e){const t=[e[0],e[1]].sort(s),n=[e[0],e[1]].sort(r),i=t[t.length-1],a=n[0],o=n[n.length-1];return{top:a,bottom:o,right:i};function s(e,t){return e[0]<t[0]?-1:1}function r(e,t){return e[1]<t[1]?-1:1}}(e),n=(t.top[1]+t.bottom[1])/2;return[t.right[0],n]}n.d(t,{A:()=>i})},473:(e,t,n)=>{"use strict";n.d(t,{getTextBoxCoordsCanvas:()=>i.A});var i=n(1239)},4096:(e,t,n)=>{"use strict";n.d(t,{CQ:()=>m,Op:()=>g,Xw:()=>u});var i=n(15327);const{CalibrationTypes:a}=i.Enums,o="px",s="voxels",r=[1,2,3,4],l=["3,3","4,7"],d=["4,3","4,7"],c={0:"px",1:"percent",2:"dB",3:"cm",4:"seconds",5:"hertz",6:"dB/seconds",7:"cm/sec",8:"cm",9:"cm/s",12:"degrees"},h="",g=(e,t)=>{const{calibration:n,hasPixelSpacing:d}=e;let g=d?"mm":o;const u=d?"mm":s;let m=g+h,p=1,v="";if(!n||!n.type&&!n.sequenceOfUltrasoundRegions)return{unit:g,areaUnit:m,scale:p,volumeUnit:u};if(n.type===a.UNCALIBRATED)return{unit:o,areaUnit:o+h,scale:p,volumeUnit:s};if(n.sequenceOfUltrasoundRegions){let e,a;if(Array.isArray(t)&&2===t.length)[e,a]=t;else if("function"==typeof t){const n=t();e=n[0],a=n[1]}let d=n.sequenceOfUltrasoundRegions.filter(t=>e[0]>=t.regionLocationMinX0&&e[0]<=t.regionLocationMaxX1&&e[1]>=t.regionLocationMinY0&&e[1]<=t.regionLocationMaxY1&&a[0]>=t.regionLocationMinX0&&a[0]<=t.regionLocationMaxX1&&a[1]>=t.regionLocationMinY0&&a[1]<=t.regionLocationMaxY1);if(!d?.length)return{unit:g,areaUnit:m,scale:p,volumeUnit:u};if(d=d.filter(e=>r.includes(e.regionDataType)&&l.includes(`${e.physicalUnitsXDirection},${e.physicalUnitsYDirection}`)),!d.length)return{unit:o,areaUnit:o+h,scale:p,volumeUnit:s};const f=d[0],w=Math.abs(f.physicalDeltaX),E=Math.abs(f.physicalDeltaY);if(!i.utilities.isEqual(w,E,.001))return{unit:o,areaUnit:o+h,scale:p,volumeUnit:s};p=1/w,v="US Region",g=c[f.physicalUnitsXDirection]||"unknown",m=g+h}else n.scale&&(p=n.scale);return[a.ERMF,a.USER,a.ERROR,a.PROJECTION,a.CALIBRATED,a.UNKNOWN].includes(n?.type)&&(v=n.type),{unit:g+(v?` ${v}`:""),areaUnit:m+(v?` ${v}`:""),scale:p,volumeUnit:u+(v?` ${v}`:"")}},u=(e,t)=>{const[n]=t,{calibration:i}=e;let a=["raw"],o=[null],s="";if(!i||!i.type&&!i.sequenceOfUltrasoundRegions)return{units:a,values:o};if(i.sequenceOfUltrasoundRegions){const e=i.sequenceOfUltrasoundRegions.filter(e=>r.includes(e.regionDataType)&&d.includes(`${e.physicalUnitsXDirection},${e.physicalUnitsYDirection}`));if(!e?.length)return{units:a,values:o};const t=e.find(e=>n[0]>=e.regionLocationMinX0&&n[0]<=e.regionLocationMaxX1&&n[1]>=e.regionLocationMinY0&&n[1]<=e.regionLocationMaxY1);if(!t)return{units:a,values:o};const{referencePixelX0:l=0,referencePixelY0:h=0}=t,{physicalDeltaX:g,physicalDeltaY:u}=t,m=(n[1]-t.regionLocationMinY0-h)*u;s="US Region",o=[(n[0]-t.regionLocationMinX0-l)*g,m],a=[c[t.physicalUnitsXDirection],c[t.physicalUnitsYDirection]]}return{units:a,values:o,calibrationType:s}},m=e=>e.calibration?.aspect||1},4296:(e,t,n)=>{"use strict";n.d(t,{R:()=>l,l:()=>d});var i=n(15327),a=n(3823),o=n(72282);const{transformWorldToIndex:s}=i.utilities;function r(e,t,n){const[i,r]=e,l=a.eR.fromValues((i[0]+r[0])/2,(i[1]+r[1])/2,(i[2]+r[2])/2),d=a.eR.distance(i,r)/2,{boundsIJK:c,topLeftWorld:h,bottomRightWorld:g}=function(e,t,n,i,r){const l=e.getDimensions(),{row:d,column:c,normal:h}=t,g=a.eR.create(),u=a.eR.create();a.eR.scaleAndAdd(g,i,h,r),a.eR.scaleAndAdd(u,i,h,-r),a.eR.scaleAndAdd(g,g,c,-r),a.eR.scaleAndAdd(u,u,c,r),a.eR.scaleAndAdd(g,g,d,-r),a.eR.scaleAndAdd(u,u,d,r);const m=s(e,g),p=s(e,u),v=n.map(t=>s(e,t)),f=(0,o.getBoundingBoxAroundShapeIJK)([m,p,...v],l);return{boundsIJK:f,topLeftWorld:g,bottomRightWorld:u}}(t,n,e,l,d);return{boundsIJK:c,centerWorld:l,radiusWorld:d,topLeftWorld:h,bottomRightWorld:g}}function l(e,t){const n=t.getDirection(),i=a.eR.fromValues(n[0],n[1],n[2]),o=a.eR.fromValues(n[3],n[4],n[5]),s=a.eR.fromValues(n[6],n[7],n[8]);return r(e,t,{row:i,column:o,normal:a.eR.negate(a.eR.create(),s)})}function d(e,t,n){if(!n)throw new Error("viewport is required in order to calculate the sphere bounds");const i=n.getCamera(),o=a.eR.fromValues(i.viewUp[0],i.viewUp[1],i.viewUp[2]),s=a.eR.fromValues(i.viewPlaneNormal[0],i.viewPlaneNormal[1],i.viewPlaneNormal[2]),l=a.eR.create();a.eR.cross(l,o,s);return r(e,t,{row:l,normal:s,column:a.eR.negate(a.eR.create(),o)})}},40133:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(15295);function a(e){const t=(0,i.A)(e);if(!t?.length)return;return t.find(t=>t.getImageIds().some(t=>t===e.metadata.referencedImageId))??t[0]}},45217:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i=function(e){const t=typeof e;return null!==e&&("object"===t||"function"===t)}},95527:(e,t,n)=>{"use strict";n.r(t),n.d(t,{BasicStatsCalculator:()=>a,aabb:()=>i,angle:()=>g,circle:()=>o,ellipse:()=>s,lineSegment:()=>r,point:()=>l,polyline:()=>d,rectangle:()=>c,vec2:()=>h});var i=n(88638),a=n(73262),o=n(77081),s=n(87009),r=n(93258),l=n(82216),d=n(92984),c=n(33657),h=n(23324),g=n(83923)},93258:(e,t,n)=>{"use strict";n.r(t),n.d(t,{distanceToPoint:()=>i.A,distanceToPointSquared:()=>a.A,distanceToPointSquaredInfo:()=>o.A,intersectLine:()=>s.A,isPointOnLineSegment:()=>r.A});var i=n(86978),a=n(18989),o=n(73149),s=n(81205),r=n(91818)},62783:(e,t,n)=>{"use strict";function i(e,t){const{center:n,radius:i}=e,a=e.radius2||i*i;return(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1])+(t[2]-n[2])*(t[2]-n[2])<=a}n.d(t,{d:()=>i})},13179:(e,t,n)=>{"use strict";var i=n(68915);class a{static{this.calculators=new Map}static{this.indices=[]}static{this.mode="collective"}static statsInit(e){const{storePointData:t,indices:n,mode:a}=e;this.mode=a,this.indices=n,this.calculators.clear(),"individual"===this.mode?n.forEach(e=>{this.calculators.set(e,new i.C3({storePointData:t}))}):this.calculators.set(n,new i.C3({storePointData:t}))}static statsCallback(e){const{segmentIndex:t,...n}=e;if(!t)throw new Error("Segment index is required for stats calculation");const i="individual"===this.mode?this.calculators.get(t):this.calculators.get(this.indices);if(!i)throw new Error(`No calculator found for segment ${t}`);i.statsCallback(n)}static getStatistics(e){if("individual"===this.mode){const t={};return this.calculators.forEach((n,i)=>{t[i]=n.getStatistics(e)}),t}return this.calculators.get(this.indices).getStatistics(e)}}},60199:(e,t,n)=>{"use strict";n(3823),n(60213)},84882:(e,t,n)=>{"use strict";function i(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}n.d(t,{A:()=>a});const a=function(e,t,n={}){const a=n.onFlood,o=n.onBoundary,s=n.equals,r=n.filter,l=n.diagonals||!1,d=f(t),c=function(){const e=function(e){const t=[],n=function(e){return e.split("").map(function(e){return parseInt(e,10)-1})};for(let a=0;a<Math.pow(3,e);a+=1){const o=i(a.toString(3),"0",e);t.push(n(o))}return t}(t.length);return e.filter(function(e){const t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||l)})}(),h=[],g=[],u=new Set,m=n.bounds;for(h.push({currentArgs:t});h.length>0;)p(h.pop());return{flooded:g};function p(e){const t=e.currentArgs,n=e.previousArgs;v(t)||(function(e){const[t,n,i=0]=e,a=t+32768+65536*(n+32768+65536*(i+32768));u.add(a)}(t),function(e){const t=f(e);return s?s(t,d):t===d}(t)?(function(e){g.push(e),a&&a(...e)}(t),function(e){for(let t=0;t<c.length;t+=1){const n=c[t],i=e.slice(0);for(let t=0;t<e.length;t+=1)i[t]+=n[t];!1!==r?.(i)&&(v(i)||h.push({currentArgs:i,previousArgs:e}))}}(t)):function(e){const[t,n,i=0]=e,a=t+32768+65536*(n+32768+65536*(i+32768));m?.set(a,e),o&&o(...e)}(n))}function v(e){const[t,n,i=0]=e,a=t+32768+65536*(n+32768+65536*(i+32768));return u.has(a)}function f(t){return e(...t)}}},14957:(e,t,n)=>{"use strict";n.d(t,{n:()=>o});var i=n(77609),a=n(48736);function o(e,t){const n=(0,i.getToolGroup)(e);if(void 0===n)return[];const o=n._toolInstances;if(!Object.keys(o).length)return[];if(t&&o[t])return[o[t]];return Object.values(o).filter(e=>e instanceof a.A)}},20527:(e,t,n)=>{"use strict";n.d(t,{L:()=>o});var i=n(6802),a=n(98870);function o(e){const t=(0,a.getSegmentation)(e),{annotationUIDsMap:n}=t.representationData.Contour;for(const[e,t]of n.entries()){if(Array.from(t).find(e=>(0,i.gw)(e).highlighted))return e}}},46507:(e,t,n)=>{"use strict";n.d(t,{T:()=>s});var i=n(15327),a=n(98870),o=n(91963);function s(e,t,{viewport:n,searchRadius:s}){const l=(0,a.getSegmentation)(e).representationData.Labelmap;if(n instanceof i.BaseVolumeViewport){const{volumeId:e}=l,a=i.cache.getVolume(e);if(!a)return;const o=a.voxelManager,d=a.imageData,c=i.utilities.transformWorldToIndex(d,t),h=o.getAtIJK(c[0],c[1],c[2]),g=function(e,t,n,a,o){const s=(t,o)=>{const s=[e[0]+t,e[1]+o],r=n.canvasToWorld(s),l=a.get("voxelManager").voxelManager,d=i.utilities.transformWorldToIndex(a,r);return l.getAtIJK(d[0],d[1],d[2])};return r(s,t,o)}(n.worldToCanvas(t),h,n,d,s);return g?h:void 0}const d=(0,a.getCurrentLabelmapImageIdForViewport)(n.id,e);if(!i.cache.getImage(d))return;const c=(0,o.wV)(n.id,e),h=c?.actor.getMapper().getInputData(),g=i.utilities.transformWorldToIndex(h,t),u=h.getDimensions(),m=h.voxelManager||i.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:u,scalarData:h.getPointData().getScalars().getData()}),p=m.getAtIJKPoint(g),v=function(e,t,n,i,a){const o=(t,i,a)=>{const o=[e[0]+t,e[1]+i,e[2]+a];return n.getAtIJK(o[0],o[1],o[2])};return r(o,i,a)}(g,0,m,p);return v?p:void 0}function r(e,t,n=1){const i=Array.from({length:2*n+1},(e,t)=>t-n);for(const n of i)for(const a of i)for(const o of i){if(0===n&&0===a&&0===o)continue;const i=e(n,a,o);if(void 0!==i&&t!==i)return!0}return!1}},71751:(e,t,n)=>{"use strict";n.d(t,{hX:()=>d});var i=n(15327),a=n(99737),o=n(98870),s=n(6802),r=n(92984),l=n(59452);function d(e,t,n={}){const d=(0,o.getSegmentation)(e),c=d.representationData,h=n?.representationType??Object.keys(c)[0];if(!h)throw new Error(`Segmentation ${e} does not have any representations`);switch(h){case a.SegmentationRepresentations.Labelmap:return function(e,t,{viewport:n}){const a=e.representationData.Labelmap;if(n instanceof i.BaseVolumeViewport){const{volumeId:e}=a,n=i.cache.getVolume(e);if(!n)return;return n.imageData.getScalarValueFromWorld(t)}const s=(0,o.getCurrentLabelmapImageIdsForViewport)(n.id,e.segmentationId);if(s.length>1)return void console.warn("Segment selection for labelmaps with multiple imageIds in stack viewports is not supported yet.");const r=s[0];if(!i.cache.getImage(r))return;const d=(0,l.wV)(n.id,e.segmentationId),c=d?.actor.getMapper().getInputData(),h=i.utilities.transformWorldToIndex(c,t),g=c.getDimensions(),u=c.voxelManager||i.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:g,scalarData:c.getPointData().getScalars().getData()});return u.getAtIJKPoint(h)}(d,t,n);case a.SegmentationRepresentations.Contour:return function(e,t,{viewport:n}){const a=e.representationData.Contour,o=Array.from(a.annotationUIDsMap.keys()),{viewPlaneNormal:l}=n.getCamera();for(const e of o){const n=a.annotationUIDsMap.get(e);if(n)for(const a of n){const n=(0,s.gw)(a);if(!n)continue;const{polyline:o}=n.data.contour;if(i.utilities.isEqual(l,n.metadata.viewPlaneNormal)&&(0,r.isPointInsidePolyline3D)(t,o))return Number(e)}}}(d,t,n);default:return}}},2733:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i="\nconst MAX_STRENGTH = 65535f;\n\n// Workgroup size - X*Y*Z must be multiple of 32 for better performance\noverride workGroupSizeX = 1u;\noverride workGroupSizeY = 1u;\noverride workGroupSizeZ = 1u;\n\n// Compare the current voxel to neighbors using a 9x9x9 window\noverride windowSize = 9i;\n\nstruct Params {\n  size: vec3u,\n  iteration: u32,\n}\n\n// New structure to track bounds of modified voxels\nstruct Bounds {\n  minX: atomic<i32>,\n  minY: atomic<i32>,\n  minZ: atomic<i32>,\n  maxX: atomic<i32>,\n  maxY: atomic<i32>,\n  maxZ: atomic<i32>,\n}\n\n@group(0) @binding(0) var<uniform> params: Params;\n@group(0) @binding(1) var<storage> volumePixelData: array<f32>;\n@group(0) @binding(2) var<storage, read_write> labelmap: array<u32>;\n@group(0) @binding(3) var<storage, read_write> strengthData: array<f32>;\n@group(0) @binding(4) var<storage> prevLabelmap: array<u32>;\n@group(0) @binding(5) var<storage> prevStrengthData: array<f32>;\n@group(0) @binding(6) var<storage, read_write> updatedVoxelsCounter: array<atomic<u32>>;\n@group(0) @binding(7) var<storage, read_write> modifiedBounds: Bounds;\n\nfn getPixelIndex(ijkPos: vec3u) -> u32 {\n  let numPixelsPerSlice = params.size.x * params.size.y;\n  return ijkPos.x + ijkPos.y * params.size.x + ijkPos.z * numPixelsPerSlice;\n}\n\nfn updateBounds(position: vec3i) {\n  // Atomically update min bounds (use min operation)\n  let oldMinX = atomicMin(&modifiedBounds.minX, position.x);\n  let oldMinY = atomicMin(&modifiedBounds.minY, position.y);\n  let oldMinZ = atomicMin(&modifiedBounds.minZ, position.z);\n\n  // Atomically update max bounds (use max operation)\n  let oldMaxX = atomicMax(&modifiedBounds.maxX, position.x);\n  let oldMaxY = atomicMax(&modifiedBounds.maxY, position.y);\n  let oldMaxZ = atomicMax(&modifiedBounds.maxZ, position.z);\n}\n\n@compute @workgroup_size(workGroupSizeX, workGroupSizeY, workGroupSizeZ)\nfn main(\n  @builtin(global_invocation_id) globalId: vec3u,\n) {\n  // Make sure it will not get out of bounds for volume with sizes that\n  // are not multiple of workGroupSize\n  if (\n    globalId.x >= params.size.x ||\n    globalId.y >= params.size.y ||\n    globalId.z >= params.size.z\n  ) {\n    return;\n  }\n\n  // Initialize bounds for the first iteration\n  if (params.iteration == 0 && globalId.x == 0 && globalId.y == 0 && globalId.z == 0) {\n    // Initialize to opposite extremes to ensure any update will improve the bounds\n    atomicStore(&modifiedBounds.minX, i32(params.size.x));\n    atomicStore(&modifiedBounds.minY, i32(params.size.y));\n    atomicStore(&modifiedBounds.minZ, i32(params.size.z));\n    atomicStore(&modifiedBounds.maxX, -1);\n    atomicStore(&modifiedBounds.maxY, -1);\n    atomicStore(&modifiedBounds.maxZ, -1);\n  }\n\n  let currentCoord = vec3i(globalId);\n  let currentPixelIndex = getPixelIndex(globalId);\n\n  let numPixels = arrayLength(&volumePixelData);\n  let currentPixelValue = volumePixelData[currentPixelIndex];\n\n  if (params.iteration == 0) {\n    // All non-zero initial labels are given maximum strength\n    strengthData[currentPixelIndex] = select(MAX_STRENGTH, 0., labelmap[currentPixelIndex] == 0);\n\n    // Update bounds for non-zero initial labels\n    if (labelmap[currentPixelIndex] != 0) {\n      updateBounds(currentCoord);\n    }\n    return;\n  }\n\n  // It should at least copy the values from previous state\n  var newLabel = prevLabelmap[currentPixelIndex];\n  var newStrength = prevStrengthData[currentPixelIndex];\n\n  let window = i32(ceil(f32(windowSize - 1) * .5));\n  let minWindow = -1i * window;\n  let maxWindow = 1i * window;\n\n  for (var k = minWindow; k <= maxWindow; k++) {\n    for (var j = minWindow; j <= maxWindow; j++) {\n      for (var i = minWindow; i <= maxWindow; i++) {\n        // Skip current voxel\n        if (i == 0 && j == 0 && k == 0) {\n          continue;\n        }\n\n        let neighborCoord = currentCoord + vec3i(i, j, k);\n\n        //  Boundary conditions. Do not grow outside of the volume\n        if (\n          neighborCoord.x < 0i || neighborCoord.x >= i32(params.size.x) ||\n          neighborCoord.y < 0i || neighborCoord.y >= i32(params.size.y) ||\n          neighborCoord.z < 0i || neighborCoord.z >= i32(params.size.z)\n        ) {\n          continue;\n        }\n\n        let neighborIndex = getPixelIndex(vec3u(neighborCoord));\n        let neighborPixelValue = volumePixelData[neighborIndex];\n        let prevNeighborStrength = prevStrengthData[neighborIndex];\n        let strengthCost = abs(neighborPixelValue - currentPixelValue);\n        let takeoverStrength = prevNeighborStrength - strengthCost;\n\n        if (takeoverStrength > newStrength) {\n          newLabel = prevLabelmap[neighborIndex];\n          newStrength = takeoverStrength;\n        }\n      }\n    }\n  }\n\n  if (labelmap[currentPixelIndex] != newLabel) {\n    atomicAdd(&updatedVoxelsCounter[params.iteration], 1u);\n\n    // Update bounds for modified voxels\n    updateBounds(currentCoord);\n  }\n\n  labelmap[currentPixelIndex] = newLabel;\n  strengthData[currentPixelIndex] = newStrength;\n}\n"},95373:(e,t,n)=>{"use strict";n.r(t),n.d(t,{run:()=>i.e,runGrowCutForBoundingBox:()=>o.z,runGrowCutForSphere:()=>a.n,runOneClickGrowCut:()=>s.HW});var i=n(66499),a=n(73569),o=n(20271),s=n(16171)},66499:(e,t,n)=>{"use strict";n.d(t,{e:()=>r});var i=n(15327),a=n(2733);const o=2136746229.76,s={windowSize:3,maxProcessingTime:3e4,inspection:{numCyclesInterval:5,numCyclesBelowThreshold:3,threshold:1e-4}};async function r(e,t,n=s){const r=[8,8,4],{windowSize:l,maxProcessingTime:d}=Object.assign({},s,n),c=Object.assign({},s.inspection,n.inspection),h=i.cache.getVolume(e),g=i.cache.getVolume(t),[u,m,p]=h.dimensions;if(g.dimensions[0]!==u||g.dimensions[1]!==m||g.dimensions[2]!==p)throw new Error("Volume and labelmap must have the same size");let v=Math.floor(Math.sqrt(m**2+u**2+p**2)/2);v=Math.min(v,500);const f=g.voxelManager.getCompleteScalarDataArray();let w=h.voxelManager.getCompleteScalarDataArray();w instanceof Float32Array||(w=new Float32Array(w));const E={maxStorageBufferBindingSize:o,maxBufferSize:o},I=await(navigator.gpu?.requestAdapter()),C=await I.requestDevice({requiredLimits:E}),b=w.byteLength,_=v*Uint32Array.BYTES_PER_ELEMENT,T=6*Int32Array.BYTES_PER_ELEMENT,A=C.createShaderModule({code:a.A}),S=new Uint32Array([u,m,p,0]),M=C.createBuffer({size:S.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),D=C.createBuffer({size:b,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});C.queue.writeBuffer(D,0,w);const y=[0,1].map(()=>C.createBuffer({size:b,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}));C.queue.writeBuffer(y[0],0,new Uint32Array(f));const P=[0,1].map(()=>C.createBuffer({size:b,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})),x=C.createBuffer({size:_,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),R=C.createBuffer({size:T,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),L=new Int32Array([u,m,p,-1,-1,-1]);C.queue.writeBuffer(R,0,L);const O=C.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:7,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),U=[0,1].map(e=>{const t=y[e],n=P[e],i=y[(e+1)%2],a=P[(e+1)%2];return C.createBindGroup({layout:O,entries:[{binding:0,resource:{buffer:M}},{binding:1,resource:{buffer:D}},{binding:2,resource:{buffer:t}},{binding:3,resource:{buffer:n}},{binding:4,resource:{buffer:i}},{binding:5,resource:{buffer:a}},{binding:6,resource:{buffer:x}},{binding:7,resource:{buffer:R}}]})}),k=C.createComputePipeline({layout:C.createPipelineLayout({bindGroupLayouts:[O]}),compute:{module:A,entryPoint:"main",constants:{workGroupSizeX:r[0],workGroupSizeY:r[1],workGroupSizeZ:r[2],windowSize:l}}}),N=[Math.ceil(u/r[0]),Math.ceil(m/r[1]),Math.ceil(p/r[2])],V=C.createBuffer({size:_,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),W=d?performance.now()+d:0;let B=c.numCyclesInterval,H=0;for(let e=0;e<v;e++){S[3]=e,C.queue.writeBuffer(M,0,S);const t=C.createCommandEncoder(),n=t.beginComputePass();n.setPipeline(k),n.setBindGroup(0,U[e%2]),n.dispatchWorkgroups(N[0],N[1],N[2]),n.end(),t.copyBufferToBuffer(x,e*Uint32Array.BYTES_PER_ELEMENT,V,e*Uint32Array.BYTES_PER_ELEMENT,Uint32Array.BYTES_PER_ELEMENT),C.queue.submit([t.finish()]);if(e>0&&!(e%B)){await V.mapAsync(GPUMapMode.READ,0,_);const t=V.getMappedRange(0,_),n=new Uint32Array(t.slice(0))[e]/w.length;if(V.unmap(),e>=1&&n<c.threshold){if(B=1,H++,H===c.numCyclesBelowThreshold)break}else B=c.numCyclesInterval}if(W&&performance.now()>W){console.warn(`Exceeded processing time limit (${d})ms`);break}}const G=C.createCommandEncoder(),F=(v+1)%2,z=C.createBuffer({size:b,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),X=C.createBuffer({size:T,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});G.copyBufferToBuffer(y[F],0,z,0,b),G.copyBufferToBuffer(R,0,X,0,T),C.queue.submit([G.finish()]),await z.mapAsync(GPUMapMode.READ,0,b);const $=z.getMappedRange(0,b),Z=new Uint32Array($);f.set(Z),z.unmap(),await X.mapAsync(GPUMapMode.READ,0,T);const Y=X.getMappedRange(0,T),j=new Int32Array(Y.slice(0));X.unmap();const q=j[0],K=j[1],J=j[2],Q=j[3],ee=j[4],te=j[5];g.voxelManager.setCompleteScalarDataArray(f),g.voxelManager.clearBounds(),g.voxelManager.setBounds([[q,Q],[K,ee],[J,te]])}},20271:(e,t,n)=>{"use strict";n.d(t,{z:()=>c});var i=n(15327),a=n(66499);const o=254,s=255,r=[-1/0,-995],l=[0,1900];async function d(e,t){const n=i.volumeLoader.createAndCacheDerivedLabelmapVolume(e.volumeId);return function(e,t,n){const{positiveSeedValue:i=o,positivePixelRange:a=l}=n,s=e.voxelManager.getCompleteScalarDataArray(),[r,d,c]=(t.voxelManager.getCompleteScalarDataArray(),t.dimensions),h=Math.floor(c/2),g=Math.max(h-3,0),u=Math.max(g+5,c),m=r*d;for(let e=g;e<u;e++){const n=e*m;for(let e=0;e<d;e++){const o=e*r;for(let e=0;e<r;e++){const r=n+o+e,l=s[r];l>=a[0]&&l<=a[1]&&t.voxelManager.setAtIndex(r,i)}}}}(e,n,t),function(e,t,n){const{negativeSeedValue:i=s,negativePixelRange:a=r}=n,o=e.voxelManager.getCompleteScalarDataArray(),[l,d,c]=t.dimensions,h=Math.floor(c/2),g=new Array(l*d).fill(!1),u=h*l*d,m=(e,n)=>{const s=[[e,n]];for(;s.length;){const[e,n]=s.shift(),r=n*l+e;if(e<0||e>=l||n<0||n>=d||g[r])continue;g[r]=!0;const c=u+r,h=o[c];h<a[0]||h>a[1]||(t.voxelManager.setAtIndex(c,i),s.push([e-1,n]),s.push([e+1,n]),s.push([e,n-1]),s.push([e,n+1]))}},p=(e,t,n,i)=>{for(let s=e;s!==t;s+=n){const e=i*l+s,t=o[u+e];if(t<a[0]||t>a[1])break;g[e]||m(s,i)}};for(let e=0;e<d;e++)p(0,l-1,1,e),p(l-1,0,-1,e)}(e,n,t),n}async function c(e,t,n){const{boundingBox:o}=t,{ijkTopLeft:s,ijkBottomRight:r}=o,l={minX:s[0],maxX:r[0],minY:s[1],maxY:r[1],minZ:s[2],maxZ:r[2]},c=i.utilities.createSubVolume(e,l,{targetBuffer:{type:"Float32Array"}}),h=await d(c,n);return await(0,a.e)(c.volumeId,h.volumeId),h}},73569:(e,t,n)=>{"use strict";n.d(t,{n:()=>m});var i=n(3823),a=n(15327),o=n(66499),s=n(4296);const{transformWorldToIndex:r}=a.utilities,l=254,d=255,c=.1,h=.8;function g(e,t){const n=e.imageData.getDirection(),a=i.eR.fromValues(n[3],n[4],n[5]),{center:o,radius:l}=t,d=e.imageData,c=i.eR.scaleAndAdd(i.eR.create(),o,a,-l),h=i.eR.scaleAndAdd(i.eR.create(),o,a,l);return function(e,t){const{topLeftWorld:n,bottomRightWorld:i}=t,a=r(e.imageData,n),o=r(e.imageData,i);return{...t,topLeftIJK:a,bottomRightIJK:o}}(e,(0,s.R)([h,c],d))}async function u(e,t,n,o){const s=await a.volumeLoader.createAndCacheDerivedLabelmapVolume(e.volumeId);return function(e,t,n,i){const a=e.voxelManager.getCompleteScalarDataArray(),o=n.center,[s,d,h]=e.dimensions,g=s*d,u=r(e.imageData,o),m=a[u[2]*g+u[1]*s+u[0]],p=i.positiveSeedValue??l,v=i.positiveSeedVariance??c,f=Math.abs(m*v),w=m-f,E=m+f,I=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],C=u[2]*g+u[1]*s+u[0];t.voxelManager.setAtIndex(C,p);const b=[u];for(;b.length;){const e=b.shift(),[n,i,o]=e;for(let e=0,r=I.length;e<r;e++){const r=I[e],l=n+r[0],c=i+r[1],u=o+r[2];if(l<0||l>=s||c<0||c>=d||u<0||u>=h)continue;const m=u*g+c*s+l,v=a[m];t.voxelManager.getAtIndex(m)===p||v<w||v>E||(t.voxelManager.setAtIndex(m,p),b.push([l,c,u]))}}}(e,s,t,o),function(e,t,n,o,s){const l=e.voxelManager.getCompleteScalarDataArray(),[c,g,u]=t.dimensions,m=c*g,{worldVecRowDir:p,worldVecSliceDir:v}=a.utilities.getVolumeDirectionVectors(t.imageData,o.getCamera()),f=r(e.imageData,n.center),w=l[f[2]*c*g+f[1]*c+f[0]],E=s.negativeSeedVariance??h,I=s?.negativeSeedValue??d,C=Math.abs(w*E),b=w-C,_=w+C,T=2*Math.PI/360,A=i.Yu.setAxisAngle(i.Yu.create(),v,T),S=i.eR.clone(p);for(let e=0;e<360;e++){const e=i.eR.scaleAndAdd(i.eR.create(),n.center,S,n.radius),a=r(t.imageData,e),[o,s,d]=a;if(i.eR.transformQuat(S,S,A),o<0||o>=c||s<0||s>=g||d<0||d>=u)continue;const h=o+s*c+d*m,p=l[h];(p<b||p>_)&&t.voxelManager.setAtIndex(h,I)}}(e,s,t,n,o),s}async function m(e,t,n,i){const s=function(e,t,n){const i=e.imageData,o=n.getCamera(),{ijkVecRowDir:s,ijkVecColDir:r}=a.utilities.getVolumeDirectionVectors(i,o);if([s,r].some(e=>!a.utilities.isEqual(Math.abs(e[0]),1)&&!a.utilities.isEqual(Math.abs(e[1]),1)&&!a.utilities.isEqual(Math.abs(e[2]),1)))return void console.warn("Oblique view is not supported!");const{boundsIJK:l}=g(e,t),d={minX:l[0][0],maxX:l[0][1]+1,minY:l[1][0],maxY:l[1][1]+1,minZ:l[2][0],maxZ:l[2][1]+1};return a.utilities.createSubVolume(e.volumeId,d,{targetBuffer:{type:"Float32Array"}})}(a.cache.getVolume(e),t,n),r=await u(s,t,n,i);return await(0,o.e)(s.volumeId,r.volumeId),r}},16171:(e,t,n)=>{"use strict";n.d(t,{HW:()=>d,sG:()=>l});var i=n(15327),a=n(66499),o=n(10564);const{transformWorldToIndex:s}=i.utilities,r=1e5;function l(e,t,n){const{dimensions:a,imageData:l}=e,[d,c,h]=a,g=e.voxelManager,u=g.getCompleteScalarDataArray(),m=d*c,p=n?.initialNeighborhoodRadius??o.Sp,v=n?.positiveStdDevMultiplier??o.ee,f=n?.negativeStdDevMultiplier??o.ag,w=n?.negativeSeedMargin??o.BX,E=n?.negativeSeedsTargetPatches??o.Zi,I=s(l,t).map(Math.round),C=g.toIndex(I);if(I[0]<0||I[0]>=d||I[1]<0||I[1]>=c||I[2]<0||I[2]>=h)return console.warn("Click position is outside volume bounds."),null;const b=i.utilities.calculateNeighborhoodStats(u,a,I,p);0===b.count&&(b.mean=u[C],b.stdDev=0);const _=b.mean-v*b.stdDev,T=b.mean+v*b.stdDev,A=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]];let S=1/0,M=1/0,D=1/0,y=-1/0,P=-1/0,x=-1/0;const R=new Set,L=[],O=u[C];if(!(O>=_&&O<=T))return console.warn("Clicked voxel intensity is outside the calculated positive range. No positive seeds generated."),{positiveSeedIndices:new Set,negativeSeedIndices:new Set};R.add(C),L.push(I),S=y=I[0],M=P=I[1],D=x=I[2];let U=0;for(;U<L.length&&R.size<r;){const[e,t,n]=L[U++];S=Math.min(e,S),M=Math.min(t,M),D=Math.min(n,D),y=Math.max(e,y),P=Math.max(t,P),x=Math.max(n,x);for(let i=0;i<A.length;i++){const[a,o,s]=A[i],l=e+a,g=t+o,p=n+s;if(l<0||l>=d||g<0||g>=c||p<0||p>=h)continue;const v=p*m+g*d+l;if(R.has(v))continue;const f=u[v];f>=_&&f<=T&&(R.add(v),R.size<r&&L.push([l,g,p]))}}if(R.size>=r&&console.debug(`Reached maximum number of positive seeds (${r}). Stopping BFS.`),0===R.size)return console.warn("No positive seeds found after BFS."),{positiveSeedIndices:new Set,negativeSeedIndices:new Set};let k=0,N=0;R.forEach(e=>{const t=u[e];k+=t,N+=t*t});const V=R.size,W=k/V,B=N/V-W*W,H=f*Math.sqrt(Math.max(0,B)),G=Math.max(0,S-w),F=Math.max(0,M-w),z=Math.max(0,D-w),X=Math.min(d-1,y+w),$=Math.min(c-1,P+w),Z=Math.min(h-1,x+w),Y=new Set;let j=0,q=0;const K=E*o.gN;for(;q<E&&j<K;){j++;const e=Math.floor(Math.random()*(X-G+1)+G),t=Math.floor(Math.random()*($-F+1)+F),n=Math.floor(Math.random()*(Z-z+1)+z),i=n*m+t*d+e;if(R.has(i)||Y.has(i))continue;const a=u[i];if(Math.abs(a-W)>H){let i=!1;for(let a=-1;a<=1;a++){const o=t+a;if(!(o<0||o>=c))for(let t=-1;t<=1;t++){const a=e+t;if(a<0||a>=d)continue;const s=n*m+o*d+a;R.has(s)||Y.has(s)||(Y.add(s),i=!0)}}i&&q++}}return 0===Y.size&&console.warn("Could not find any negative seeds. GrowCut might fail or produce poor results."),console.debug("positiveSeedIndices",R.size),console.debug("negativeSeedIndices",Y.size),{positiveSeedIndices:R,negativeSeedIndices:Y}}async function d({referencedVolumeId:e,worldPosition:t,options:n}){const s=i.cache.getVolume(e),d=i.volumeLoader.createAndCacheDerivedLabelmapVolume(e);d.voxelManager.forEach(({index:e,value:t})=>{0!==t&&d.voxelManager.setAtIndex(e,0)});const c=n.seeds??l(s,t,n),h=n?.positiveSeedValue??o.VD,g=n?.negativeSeedValue??o.bs;if(!c)return null;const{positiveSeedIndices:u,negativeSeedIndices:m}=c;return u.size<10||u.size>r||m.size<10?(console.warn("Not enough seeds found. GrowCut might fail or produce poor results."),d):(u.forEach(e=>{d.voxelManager.setAtIndex(e,h)}),m.forEach(e=>{d.voxelManager.setAtIndex(e,g)}),await(0,a.e)(e,d.volumeId,n),d)}},93759:(e,t,n)=>{"use strict";n.d(t,{floodFill:()=>i.A,getHoveredContourSegmentationAnnotation:()=>s.L,getOrCreateSegmentationVolume:()=>l.A,getSegmentIndexAtLabelmapBorder:()=>o.T,getSegmentIndexAtWorldPoint:()=>a.hX,growCut:()=>r});n(8582),n(52323),n(4334),n(97492),n(24917);var i=n(84882),a=(n(17014),n(49492),n(68915),n(13179),n(73706),n(13276),n(14514),n(22592),n(35706),n(25758),n(71751)),o=n(46507),s=n(20527),r=(n(14957),n(95373)),l=(n(2397),n(67912),n(30722));n(83075),n(38440),n(21345),n(93690),n(6994),n(12853),n(78773),n(88274)},35706:(e,t,n)=>{"use strict";n.d(t,{E:()=>s});var i=n(77609),a=n(58640),o=n(14957);function s(e){const t=(0,i.getToolGroup)(e);if(void 0===t)return;(0,o.n)(e).forEach(e=>{e.invalidateBrushCursor()});const n=t.getViewportsInfo();if(!Object.keys(n).map(e=>n[e]).length)return;const s=t.getViewportIds();(0,a.A)(s)}},60213:(e,t,n)=>{"use strict";n(15327),n(3823)},27730:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(52905),a=n(45217);const o=function(e,t,n){let o=!0,s=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return(0,a.A)(n)&&(o="leading"in n?Boolean(n.leading):o,s="trailing"in n?Boolean(n.trailing):s),(0,i.A)(e,t,{leading:o,trailing:s,maxWait:t})}},76260:(e,t,n)=>{"use strict";function i(e,t){const n=l(e),i=l(t);return{page:c(n.page,i.page),client:c(n.client,i.client),canvas:c(n.canvas,i.canvas),world:(a=n.world,o=i.world,[a[0]-o[0],a[1]-o[1],a[2]-o[2]])};var a,o}function a(e,t){const n=l(e),i=l(t);return{page:g(n.page,i.page),client:g(n.client,i.client),canvas:g(n.canvas,i.canvas),world:u(n.world,i.world)}}function o(e,t){const n=h(e),i=h(t);return{page:n.page-i.page,client:n.client-i.client,canvas:n.canvas-i.canvas,world:n.world-i.world}}function s(e){return JSON.parse(JSON.stringify(e))}function r(e){return JSON.parse(JSON.stringify(e))}function l(e){return e.reduce((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function d(e){return e.reduce((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function c(e,t){return[e[0]-t[0],e[1]-t[1]]}function h(e){const t=[];for(let n=0;n<e.length;n++)for(let i=0;i<e.length;i++)n<i&&t.push({page:g(e[n].page,e[i].page),client:g(e[n].client,e[i].client),canvas:g(e[n].canvas,e[i].canvas),world:u(e[n].world,e[i].world)});return t.reduce((e,n)=>({page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length}),{page:0,client:0,canvas:0,world:0})}function g(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function u(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}n.d(t,{copyPoints:()=>r,copyPointsList:()=>s,getDeltaDistance:()=>a,getDeltaDistanceBetweenIPoints:()=>o,getDeltaPoints:()=>i,getMeanTouchPoints:()=>d})},94779:(e,t,n)=>{"use strict";n.d(t,{_:()=>s});var i=n(15327),a=n(56069),o=n(77609);function s(e){e.forEach(e=>{const t=(0,o.getToolGroup)(e);if(!t)return void console.warn(`ToolGroup not available for ${e}`);t.getViewportsInfo().forEach(e=>{const{renderingEngineId:t,viewportId:n}=e,o=(0,i.getRenderingEngine)(t);if(!o)return void console.warn(`RenderingEngine not available for ${t}`);const s=o.getViewport(n);(0,a.A)(s.element)})})}},58640:(e,t,n)=>{"use strict";n.d(t,{A:()=>s,t:()=>o});var i=n(15327),a=n(56069);function o(e){e.length&&e.forEach(e=>{const t=(0,i.getEnabledElementByViewportId)(e);if(!t)return void console.warn(`Viewport not available for ${e}`);const{viewport:n}=t;if(!n)return void console.warn(`Viewport not available for ${e}`);const o=n.element;(0,a.A)(o)})}const s=o},60810:(e,t,n)=>{"use strict";n.d(t,{filterViewportsWithToolEnabled:()=>i.A,getViewportIdsWithToolToRender:()=>a.A});n(3198);var i=n(9356),a=n(14543);n(67514)},19027:(e,t,n)=>{"use strict";n.d(t,{isViewportPreScaled:()=>i.u});var i=n(18990)},18990:(e,t,n)=>{"use strict";n.d(t,{u:()=>a});var i=n(15327);function a(e,t){if(e instanceof i.BaseVolumeViewport){const e=i.utilities.getVolumeId(t),n=i.cache.getVolume(e);return!!n?.scaling&&Object.keys(n.scaling).length>0}if(e instanceof i.StackViewport){const{preScale:t}=e.getImageData()||{};return!!t?.scaled}return!1}},20646:(e,t,n)=>{"use strict";var i;n.d(t,{U:()=>i}),function(e){e.Top="top",e.Left="left",e.Bottom="bottom",e.Right="right"}(i||(i={}))},51807:(e,t,n)=>{"use strict";n.d(t,{ColorbarRangeTextPosition:()=>i.U});var i=n(20646)},62612:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>a,kP:()=>i});const i={DEFAULT:0,SINGLE:1,DOUBLE:2};var a={AttributeCopyOperations:{COPYTUPLE:0,INTERPOLATE:1,PASSDATA:2,ALLCOPY:3},AttributeLimitTypes:{MAX:0,EXACT:1,NOLIMIT:2},AttributeTypes:{SCALARS:0,VECTORS:1,NORMALS:2,TCOORDS:3,TENSORS:4,GLOBALIDS:5,PEDIGREEIDS:6,EDGEFLAG:7,NUM_ATTRIBUTES:8},CellGhostTypes:{DUPLICATECELL:1,HIGHCONNECTIVITYCELL:2,LOWCONNECTIVITYCELL:4,REFINEDCELL:8,EXTERIORCELL:16,HIDDENCELL:32},DesiredOutputPrecision:i,PointGhostTypes:{DUPLICATEPOINT:1,HIDDENPOINT:2},ghostArrayName:"vtkGhostType"}},58498:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>u});var i=n(28906),a=n(16632),o=n(21734),s=n(69147),r=n(24964),l=n(85278),d=n(3823);const{vtkErrorMacro:c}=i.m;const h={direction:null,indexToWorld:null,worldToIndex:null,spacing:[1,1,1],origin:[0,0,0],extent:[0,-1,0,-1,0,-1],dataDescription:l.e.EMPTY};function g(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,h,n),s.Ay.extend(e,t,n),t.direction?Array.isArray(t.direction)&&(t.direction=new Float64Array(t.direction.slice(0,9))):t.direction=d.w0.identity(new Float64Array(9)),t.indexToWorld=new Float64Array(16),t.worldToIndex=new Float64Array(16),i.m.get(e,t,["indexToWorld","worldToIndex"]),i.m.setGetArray(e,t,["origin","spacing"],3),i.m.setGetArray(e,t,["direction"],9),i.m.getArray(e,t,["extent"],6),function(e,t){t.classHierarchy.push("vtkImageData"),e.setExtent=function(){if(t.deleted)return c("instance deleted - cannot call any method"),!1;for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];const o=1===i.length?i[0]:i;if(6!==o.length)return!1;const s=t.extent.some((e,t)=>e!==o[t]);return s&&(t.extent=o.slice(),t.dataDescription=r.A.getDataDescriptionFromExtent(t.extent),e.modified()),s},e.setDimensions=function(){let n,i,a;if(t.deleted)c("instance deleted - cannot call any method");else{if(1===arguments.length){const e=arguments.length<=0?void 0:arguments[0];n=e[0],i=e[1],a=e[2]}else{if(3!==arguments.length)return void c("Bad dimension specification");n=arguments.length<=0?void 0:arguments[0],i=arguments.length<=1?void 0:arguments[1],a=arguments.length<=2?void 0:arguments[2]}e.setExtent(0,n-1,0,i-1,0,a-1)}},e.getDimensions=()=>[t.extent[1]-t.extent[0]+1,t.extent[3]-t.extent[2]+1,t.extent[5]-t.extent[4]+1],e.getNumberOfCells=()=>{const t=e.getDimensions();let n=1;for(let e=0;e<3;e++){if(0===t[e])return 0;t[e]>1&&(n*=t[e]-1)}return n},e.getNumberOfPoints=()=>{const t=e.getDimensions();return t[0]*t[1]*t[2]},e.getPoint=n=>{const i=e.getDimensions();if(0===i[0]||0===i[1]||0===i[2])return c("Requesting a point from an empty image."),null;const a=new Float64Array(3);switch(t.dataDescription){case l.e.EMPTY:return null;case l.e.SINGLE_POINT:break;case l.e.X_LINE:a[0]=n;break;case l.e.Y_LINE:a[1]=n;break;case l.e.Z_LINE:a[2]=n;break;case l.e.XY_PLANE:a[0]=n%i[0],a[1]=n/i[0];break;case l.e.YZ_PLANE:a[1]=n%i[1],a[2]=n/i[1];break;case l.e.XZ_PLANE:a[0]=n%i[0],a[2]=n/i[0];break;case l.e.XYZ_GRID:a[0]=n%i[0],a[1]=n/i[0]%i[1],a[2]=n/(i[0]*i[1]);break;default:c("Invalid dataDescription")}const o=[0,0,0];return e.indexToWorld(a,o),o},e.getBounds=()=>e.extentToBounds(e.getSpatialExtent()),e.extentToBounds=e=>o.Ay.transformBounds(e,t.indexToWorld),e.getSpatialExtent=()=>o.Ay.inflate([...t.extent],.5),e.computeTransforms=()=>{d.pB.fromTranslation(t.indexToWorld,t.origin),t.indexToWorld[0]=t.direction[0],t.indexToWorld[1]=t.direction[1],t.indexToWorld[2]=t.direction[2],t.indexToWorld[4]=t.direction[3],t.indexToWorld[5]=t.direction[4],t.indexToWorld[6]=t.direction[5],t.indexToWorld[8]=t.direction[6],t.indexToWorld[9]=t.direction[7],t.indexToWorld[10]=t.direction[8],d.pB.scale(t.indexToWorld,t.indexToWorld,t.spacing),d.pB.invert(t.worldToIndex,t.indexToWorld)},e.indexToWorld=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return d.eR.transformMat4(n,e,t.indexToWorld),n},e.indexToWorldVec3=e.indexToWorld,e.worldToIndex=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return d.eR.transformMat4(n,e,t.worldToIndex),n},e.worldToIndexVec3=e.worldToIndex,e.indexToWorldBounds=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return o.Ay.transformBounds(e,t.indexToWorld,n)},e.worldToIndexBounds=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return o.Ay.transformBounds(e,t.worldToIndex,n)},e.onModified(e.computeTransforms),e.computeTransforms(),e.getCenter=()=>o.Ay.getCenter(e.getBounds()),e.computeHistogram=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=[0,0,0,0,0,0];e.worldToIndexBounds(t,i);const s=[0,0,0],r=[0,0,0];o.Ay.computeCornerPoints(i,s,r),(0,a.b)(s,s),(0,a.b)(r,r);const l=e.getDimensions();(0,a.c)(s,[0,0,0],[l[0]-1,l[1]-1,l[2]-1],s),(0,a.c)(r,[0,0,0],[l[0]-1,l[1]-1,l[2]-1],r);const d=l[0],c=l[0]*l[1],h=e.getPointData().getScalars().getData();let g=-1/0,u=1/0,m=0,p=0,v=0;for(let e=s[2];e<=r[2];e++)for(let t=s[1];t<=r[1];t++){let a=s[0]+t*d+e*c;for(let o=s[0];o<=r[0];o++){if(!n||n([o,t,e],i)){const e=h[a];e>g&&(g=e),e<u&&(u=e),m+=e*e,p+=e,v+=1}++a}}const f=v>0?p/v:0,w=v?Math.abs(m/v-f*f):0;return{minimum:u,maximum:g,average:f,variance:w,sigma:Math.sqrt(w),count:v}},e.computeIncrements=function(e){const t=[];let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;for(let i=0;i<3;++i)t[i]=n,n*=e[2*i+1]-e[2*i]+1;return t},e.computeOffsetIndex=t=>{let[n,i,a]=t;const o=e.getExtent(),s=e.getPointData().getScalars().getNumberOfComponents(),r=e.computeIncrements(o,s);return Math.floor((Math.round(n)-o[0])*r[0]+(Math.round(i)-o[2])*r[1]+(Math.round(a)-o[4])*r[2])},e.getOffsetIndexFromWorld=t=>{const n=e.getExtent(),i=e.worldToIndex(t);for(let e=0;e<3;++e)if(i[e]<n[2*e]||i[e]>n[2*e+1])return c(`GetScalarPointer: Pixel ${i} is not in memory. Current extent = ${n}`),NaN;return e.computeOffsetIndex(i)},e.getScalarValueFromWorld=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=e.getPointData().getScalars().getNumberOfComponents();if(n<0||n>=i)return c(`GetScalarPointer: Scalar Component ${n} is not within bounds. Current Scalar numberOfComponents: ${i}`),NaN;const a=e.getOffsetIndexFromWorld(t);return Number.isNaN(a)?a:e.getPointData().getScalars().getComponent(a,n)}}(e,t)}var u={newInstance:i.m.newInstance(g,"vtkImageData"),extend:g}},642:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>w});var i=n(28906),a=n(16632),o=n(80993),s=n(25128);const{ColorSpace:r,Scale:l}=s.Ay,{ScalarMappingTarget:d}=o.Ay,{vtkDebugMacro:c,vtkErrorMacro:h,vtkWarningMacro:g}=i.m;function u(e,t){const n=e[0],i=e[1],a=e[2],o=Math.sqrt(n*n+i*i+a*a),s=o>.001?Math.acos(n/o):0,r=s>.001?Math.atan2(a,i):0;t[0]=o,t[1]=s,t[2]=r}function m(e,t){if(e[0]>=t-.1)return e[2];const n=e[1]*Math.sqrt(t*t-e[0]*e[0])/(e[0]*Math.sin(e[1]));return e[2]>-.3*Math.PI?e[2]+n:e[2]-n}function p(e,t,n,i){const o=[],s=[];(0,a.N)(t,o),(0,a.N)(n,s);const r=[],l=[];u(o,r),u(s,l);let d=e;if(r[1]>.05&&l[1]>.05&&function(e,t){let n=e-t;for(n<0&&(n=-n);n>=2*Math.PI;)n-=2*Math.PI;return n>Math.PI&&(n=2*Math.PI-n),n}(r[2],l[2])>.33*Math.PI){let t=Math.max(r[0],l[0]);t=Math.max(88,t),e<.5?(l[0]=t,l[1]=0,l[2]=0,d*=2):(r[0]=t,r[1]=0,r[2]=0,d=2*d-1)}r[1]<.05&&l[1]>.05?r[2]=m(l,r[0]):l[1]<.05&&r[1]>.05&&(l[2]=m(r,l[0]));const c=[];c[0]=(1-d)*r[0]+d*l[0],c[1]=(1-d)*r[1]+d*l[1],c[2]=(1-d)*r[2]+d*l[2];const h=[];!function(e,t){const n=e[0],i=e[1],a=e[2];t[0]=n*Math.cos(i),t[1]=n*Math.sin(i)*Math.cos(a),t[2]=n*Math.sin(i)*Math.sin(a)}(c,h),(0,a.O)(h,i)}const v={clamping:!0,colorSpace:r.RGB,hSVWrap:!0,scale:l.LINEAR,nanColor:null,belowRangeColor:null,aboveRangeColor:null,useAboveRangeColor:!1,useBelowRangeColor:!1,allowDuplicateScalars:!1,table:null,tableSize:0,buildTime:null,nodes:null,discretize:!1,numberOfValues:256};function f(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,v,n),o.Ay.extend(e,t,n),t.table=[],t.nodes=[],t.nanColor=[.5,0,0,1],t.belowRangeColor=[0,0,0,1],t.aboveRangeColor=[1,1,1,1],t.buildTime={},i.m.obj(t.buildTime),i.m.get(e,t,["buildTime","mappingRange"]),i.m.setGet(e,t,["useAboveRangeColor","useBelowRangeColor","discretize","numberOfValues",{type:"enum",name:"colorSpace",enum:r},{type:"enum",name:"scale",enum:l}]),i.m.setArray(e,t,["nanColor","belowRangeColor","aboveRangeColor"],4),i.m.getArray(e,t,["nanColor","belowRangeColor","aboveRangeColor"]),function(e,t){t.classHierarchy.push("vtkColorTransferFunction"),e.getSize=()=>t.nodes.length,e.addRGBPoint=(t,n,i,a)=>e.addRGBPointLong(t,n,i,a,.5,0),e.addRGBPointLong=function(n,i,a,o){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.5,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;if(s<0||s>1)return h("Midpoint outside range [0.0, 1.0]"),-1;if(r<0||r>1)return h("Sharpness outside range [0.0, 1.0]"),-1;t.allowDuplicateScalars||e.removePoint(n);const l={x:n,r:i,g:a,b:o,midpoint:s,sharpness:r};t.nodes.push(l),e.sortAndUpdateRange();let d=0;for(;d<t.nodes.length&&t.nodes[d].x!==n;d++);return d<t.nodes.length?d:-1},e.addHSVPoint=(t,n,i,a)=>e.addHSVPointLong(t,n,i,a,.5,0),e.addHSVPointLong=function(t,n,i,o){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.5,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const l=[],d=[n,i,o];return(0,a.h)(d,l),e.addRGBPoint(t,l[0],l[1],l[2],s,r)},e.setNodes=n=>{if(t.nodes!==n){const i=JSON.stringify(t.nodes);t.nodes=n;const a=JSON.stringify(t.nodes);if(e.sortAndUpdateRange()||i!==a)return e.modified(),!0}return!1},e.sortAndUpdateRange=()=>{const n=JSON.stringify(t.nodes);t.nodes.sort((e,t)=>e.x-t.x);const i=JSON.stringify(t.nodes),a=e.updateRange();return a||n===i?a:(e.modified(),!0)},e.updateRange=()=>{const n=[2];n[0]=t.mappingRange[0],n[1]=t.mappingRange[1];const i=t.nodes.length;return i?(t.mappingRange[0]=t.nodes[0].x,t.mappingRange[1]=t.nodes[i-1].x):(t.mappingRange[0]=0,t.mappingRange[1]=0),(n[0]!==t.mappingRange[0]||n[1]!==t.mappingRange[1])&&(e.modified(),!0)},e.removePoint=n=>{let i=0;for(;i<t.nodes.length&&t.nodes[i].x!==n;i++);const a=i;if(i>=t.nodes.length)return-1;let o=!1;return t.nodes.splice(i,1),0!==i&&i!==t.nodes.length||(o=e.updateRange()),o||e.modified(),a},e.movePoint=(n,i)=>{if(n!==i){e.removePoint(i);for(let a=0;a<t.nodes.length;a++)if(t.nodes[a].x===n){t.nodes[a].x=i,e.sortAndUpdateRange();break}}},e.removeAllPoints=()=>{t.nodes=[],e.sortAndUpdateRange()},e.addRGBSegment=(n,i,a,o,s,r,l,d)=>{e.sortAndUpdateRange();for(let e=0;e<t.nodes.length;)t.nodes[e].x>=n&&t.nodes[e].x<=s?t.nodes.splice(e,1):e++;e.addRGBPointLong(n,i,a,o,.5,0),e.addRGBPointLong(s,r,l,d,.5,0),e.modified()},e.addHSVSegment=(t,n,i,o,s,r,l,d)=>{const c=[n,i,o],h=[r,l,d],g=[],u=[];(0,a.h)(c,g),(0,a.h)(h,u),e.addRGBSegment(t,g[0],g[1],g[2],s,u[0],u[1],u[2])},e.mapValue=t=>{const n=[];return e.getColor(t,n),[Math.floor(255*n[0]+.5),Math.floor(255*n[1]+.5),Math.floor(255*n[2]+.5),255]},e.getColor=(n,i)=>{if(t.indexedLookup){const t=e.getSize(),a=e.getAnnotatedValueIndexInternal(n);if(a<0||0===t){const t=e.getNanColorByReference();i[0]=t[0],i[1]=t[1],i[2]=t[2]}else{const n=[];e.getNodeValue(a%t,n),i[0]=n[1],i[1]=n[2],i[2]=n[3]}return}e.getTable(n,n,1,i)},e.getRedValue=t=>{const n=[];return e.getColor(t,n),n[0]},e.getGreenValue=t=>{const n=[];return e.getColor(t,n),n[1]},e.getBlueValue=t=>{const n=[];return e.getColor(t,n),n[2]},e.getTable=(n,i,o,s)=>{const d=Number(n),c=Number(i);if((0,a.i)(d)||(0,a.i)(c)){for(let e=0;e<o;e++)s[3*e+0]=t.nanColor[0],s[3*e+1]=t.nanColor[1],s[3*e+2]=t.nanColor[2];return}let g=0;const u=t.nodes.length;let m=0,v=0,f=0;0!==u&&(m=t.nodes[u-1].r,v=t.nodes[u-1].g,f=t.nodes[u-1].b);let w=0,E=0,I=0;const C=[0,0,0],b=[0,0,0];let _=0,T=0;const A=[];let S=t.scale===l.LOG10;S&&(S=t.mappingRange[0]>0);let M=0,D=0,y=0;S&&(M=Math.log10(d),D=Math.log10(c));for(let n=0;n<o;n++){const i=3*n;if(o>1?S?(y=M+n/(o-1)*(D-M),w=10**y):w=d+n/(o-1)*(c-d):S?(y=.5*(M+D),w=10**y):w=.5*(d+c),t.discretize){const e=t.mappingRange;if(w>=e[0]&&w<=e[1]){const n=t.numberOfValues,i=e[1]-e[0];if(n<=1)w=e[0]+i/2;else{const t=(w-e[0])/i,o=(0,a.K)(n*t);w=e[0]+o/(n-1)*i}}}for(;g<u&&w>t.nodes[g].x;)g++,g<u&&(E=t.nodes[g-1].x,I=t.nodes[g].x,S&&(E=Math.log10(E),I=Math.log10(I)),C[0]=t.nodes[g-1].r,b[0]=t.nodes[g].r,C[1]=t.nodes[g-1].g,b[1]=t.nodes[g].g,C[2]=t.nodes[g-1].b,b[2]=t.nodes[g].b,_=t.nodes[g-1].midpoint,T=t.nodes[g-1].sharpness,_<1e-5&&(_=1e-5),_>.99999&&(_=.99999));if(w>t.mappingRange[1])s[i]=0,s[i+1]=0,s[i+2]=0,t.clamping&&(e.getUseAboveRangeColor()?(s[i]=t.aboveRangeColor[0],s[i+1]=t.aboveRangeColor[1],s[i+2]=t.aboveRangeColor[2]):(s[i]=m,s[i+1]=v,s[i+2]=f));else if(w<t.mappingRange[0]||(0,a.L)(w)&&w<0)s[i]=0,s[i+1]=0,s[i+2]=0,t.clamping&&(e.getUseBelowRangeColor()?(s[i]=t.belowRangeColor[0],s[i+1]=t.belowRangeColor[1],s[i+2]=t.belowRangeColor[2]):u>0&&(s[i]=t.nodes[0].r,s[i+1]=t.nodes[0].g,s[i+2]=t.nodes[0].b));else if(0===g&&(Math.abs(w-d)<1e-6||t.discretize))u>0?(s[i]=t.nodes[0].r,s[i+1]=t.nodes[0].g,s[i+2]=t.nodes[0].b):(s[i]=0,s[i+1]=0,s[i+2]=0);else{let e=0;if(e=S?(y-E)/(I-E):(w-E)/(I-E),e=e<_?.5*e/_:.5+.5*(e-_)/(1-_),T>.99){if(e<.5){s[i]=C[0],s[i+1]=C[1],s[i+2]=C[2];continue}s[i]=b[0],s[i+1]=b[1],s[i+2]=b[2];continue}if(T<.01){if(t.colorSpace===r.RGB)s[i]=(1-e)*C[0]+e*b[0],s[i+1]=(1-e)*C[1]+e*b[1],s[i+2]=(1-e)*C[2]+e*b[2];else if(t.colorSpace===r.HSV){const n=[],o=[];(0,a.M)(C,n),(0,a.M)(b,o),t.hSVWrap&&(n[0]-o[0]>.5||o[0]-n[0]>.5)&&(n[0]>o[0]?n[0]-=1:o[0]-=1);const r=[];r[0]=(1-e)*n[0]+e*o[0],r[0]<0&&(r[0]+=1),r[1]=(1-e)*n[1]+e*o[1],r[2]=(1-e)*n[2]+e*o[2],(0,a.h)(r,A),s[i]=A[0],s[i+1]=A[1],s[i+2]=A[2]}else if(t.colorSpace===r.LAB){const t=[],n=[];(0,a.N)(C,t),(0,a.N)(b,n);const o=[];o[0]=(1-e)*t[0]+e*n[0],o[1]=(1-e)*t[1]+e*n[1],o[2]=(1-e)*t[2]+e*n[2],(0,a.O)(o,A),s[i]=A[0],s[i+1]=A[1],s[i+2]=A[2]}else t.colorSpace===r.DIVERGING?(p(e,C,b,A),s[i]=A[0],s[i+1]=A[1],s[i+2]=A[2]):h("ColorSpace set to invalid value.",t.colorSpace);continue}e<.5?e=.5*(2*e)**(1+10*T):e>.5&&(e=1-.5*(2*(1-e))**(1+10*T));const n=e*e,o=n*e,l=2*o-3*n+1,d=-2*o+3*n,c=o-2*n+e,g=o-n;let u,m;if(t.colorSpace===r.RGB)for(let e=0;e<3;e++)u=b[e]-C[e],m=(1-T)*u,s[i+e]=l*C[e]+d*b[e]+c*m+g*m;else if(t.colorSpace===r.HSV){const e=[],n=[];(0,a.M)(C,e),(0,a.M)(b,n),t.hSVWrap&&(e[0]-n[0]>.5||n[0]-e[0]>.5)&&(e[0]>n[0]?e[0]-=1:n[0]-=1);const o=[];for(let t=0;t<3;t++)u=n[t]-e[t],m=(1-T)*u,o[t]=l*e[t]+d*n[t]+c*m+g*m,0===t&&o[t]<0&&(o[t]+=1);(0,a.h)(o,A),s[i]=A[0],s[i+1]=A[1],s[i+2]=A[2]}else if(t.colorSpace===r.LAB){const e=[],t=[];(0,a.N)(C,e),(0,a.N)(b,t);const n=[];for(let i=0;i<3;i++)u=t[i]-e[i],m=(1-T)*u,n[i]=l*e[i]+d*t[i]+c*m+g*m;(0,a.O)(n,A),s[i]=A[0],s[i+1]=A[1],s[i+2]=A[2]}else t.colorSpace===r.DIVERGING?(p(e,C,b,A),s[i]=A[0],s[i+1]=A[1],s[i+2]=A[2]):h("ColorSpace set to invalid value.");for(let e=0;e<3;e++)s[i+e]=s[i+e]<0?0:s[i+e],s[i+e]=s[i+e]>1?1:s[i+e]}}},e.getUint8Table=function(n,i,a){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(e.getMTime()<=t.buildTime&&t.tableSize===a&&t.tableWithAlpha!==o)return t.table;if(0===t.nodes.length)return h("Attempting to lookup a value with no points in the function"),t.table;const s=o?4:3;t.tableSize===a&&t.tableWithAlpha===o||(t.table=new Uint8Array(a*s),t.tableSize=a,t.tableWithAlpha=o);const r=[];e.getTable(n,i,a,r);for(let e=0;e<a;e++)t.table[e*s+0]=Math.floor(255*r[3*e+0]+.5),t.table[e*s+1]=Math.floor(255*r[3*e+1]+.5),t.table[e*s+2]=Math.floor(255*r[3*e+2]+.5),o&&(t.table[e*s+3]=255);return t.buildTime.modified(),t.table},e.buildFunctionFromArray=n=>{e.removeAllPoints();const i=n.getNumberOfComponents();for(let e=0;e<n.getNumberOfTuples();e++)switch(i){case 3:t.nodes.push({x:e,r:n.getComponent(e,0),g:n.getComponent(e,1),b:n.getComponent(e,2),midpoint:.5,sharpness:0});break;case 4:t.nodes.push({x:n.getComponent(e,0),r:n.getComponent(e,1),g:n.getComponent(e,2),b:n.getComponent(e,3),midpoint:.5,sharpness:0});break;case 5:t.nodes.push({x:e,r:n.getComponent(e,0),g:n.getComponent(e,1),b:n.getComponent(e,2),midpoint:n.getComponent(e,4),sharpness:n.getComponent(e,5)});break;case 6:t.nodes.push({x:n.getComponent(e,0),r:n.getComponent(e,1),g:n.getComponent(e,2),b:n.getComponent(e,3),midpoint:n.getComponent(e,4),sharpness:n.getComponent(e,5)})}e.sortAndUpdateRange()},e.buildFunctionFromTable=(n,i,a,o)=>{let s=0;e.removeAllPoints(),a>1&&(s=(i-n)/(a-1));for(let e=0;e<a;e++){const i={x:n+s*e,r:o[3*e],g:o[3*e+1],b:o[3*e+2],sharpness:0,midpoint:.5};t.nodes.push(i)}e.sortAndUpdateRange()},e.getNodeValue=(e,n)=>e<0||e>=t.nodes.length?(h("Index out of range!"),-1):(n[0]=t.nodes[e].x,n[1]=t.nodes[e].r,n[2]=t.nodes[e].g,n[3]=t.nodes[e].b,n[4]=t.nodes[e].midpoint,n[5]=t.nodes[e].sharpness,1),e.setNodeValue=(n,i)=>{if(n<0||n>=t.nodes.length)return h("Index out of range!"),-1;const a=t.nodes[n].x;return t.nodes[n].x=i[0],t.nodes[n].r=i[1],t.nodes[n].g=i[2],t.nodes[n].b=i[3],t.nodes[n].midpoint=i[4],t.nodes[n].sharpness=i[5],a!==i[0]?e.sortAndUpdateRange():e.modified(),1},e.getNumberOfAvailableColors=()=>{if(t.indexedLookup&&e.getSize())return e.getSize();if(t.tableSize)return t.tableSize;const n=t.nodes?.length??0;return Math.max(4094,n)},e.getIndexedColor=(t,n)=>{const i=e.getSize();if(i>0&&t>=0){const a=[];e.getNodeValue(t%i,a);for(let e=0;e<3;++e)n[e]=a[e+1];return void(n[3]=1)}const a=e.getNanColorByReference();n[0]=a[0],n[1]=a[1],n[2]=a[2],n[3]=1},e.fillFromDataPointer=(t,n)=>{if(!(t<=0)&&n){e.removeAllPoints();for(let i=0;i<t;i++)e.addRGBPoint(n[4*i],n[4*i+1],n[4*i+2],n[4*i+3])}},e.setMappingRange=(n,i)=>{const a=[n,i],o=e.getRange();if(o[1]===a[1]&&o[0]===a[0])return;if(a[1]===a[0])return void h("attempt to set zero width color range");const s=(a[1]-a[0])/(o[1]-o[0]),r=a[0]-o[0]*s;for(let e=0;e<t.nodes.length;++e)t.nodes[e].x=t.nodes[e].x*s+r;t.mappingRange[0]=a[0],t.mappingRange[1]=a[1],e.modified()},e.adjustRange=n=>{const i=e.getRange(),a=[];i[0]<n[0]?(e.getColor(n[0],a),e.addRGBPoint(n[0],a[0],a[1],a[2])):(e.getColor(i[0],a),e.addRGBPoint(n[0],a[0],a[1],a[2])),i[1]>n[1]?(e.getColor(n[1],a),e.addRGBPoint(n[1],a[0],a[1],a[2])):(e.getColor(i[1],a),e.addRGBPoint(n[1],a[0],a[1],a[2])),e.sortAndUpdateRange();for(let e=0;e<t.nodes.length;)t.nodes[e].x>=n[0]&&t.nodes[e].x<=n[1]?t.nodes.splice(e,1):++e;return 1},e.estimateMinNumberOfSamples=(t,n)=>{const i=e.findMinimumXDistance();return Math.ceil((n-t)/i)},e.findMinimumXDistance=()=>{if(t.nodes.length<2)return-1;let e=Number.MAX_VALUE;for(let n=0;n<t.nodes.length-1;n++){const i=t.nodes[n+1].x-t.nodes[n].x;i<e&&(e=i)}return e},e.mapScalarsThroughTable=(n,i,a,o)=>{0!==e.getSize()?t.indexedLookup?e.mapDataIndexed(n,i,a,o):e.mapData(n,i,a,o):c("Transfer Function Has No Points!")},e.mapData=(t,n,i,a)=>{if(0===e.getSize())return void g("Transfer Function Has No Points!");const o=Math.floor(255*e.getAlpha()+.5),s=t.getNumberOfTuples(),r=t.getNumberOfComponents(),l=n.getData(),c=t.getData(),h=[];if(i===d.RGBA)for(let t=0;t<s;t++){const n=c[t*r+a];e.getColor(n,h),l[4*t]=Math.floor(255*h[0]+.5),l[4*t+1]=Math.floor(255*h[1]+.5),l[4*t+2]=Math.floor(255*h[2]+.5),l[4*t+3]=o}if(i===d.RGB)for(let t=0;t<s;t++){const n=c[t*r+a];e.getColor(n,h),l[3*t]=Math.floor(255*h[0]+.5),l[3*t+1]=Math.floor(255*h[1]+.5),l[3*t+2]=Math.floor(255*h[2]+.5)}if(i===d.LUMINANCE)for(let t=0;t<s;t++){const n=c[t*r+a];e.getColor(n,h),l[t]=Math.floor(76.5*h[0]+150.45*h[1]+28.05*h[2]+.5)}if(i===d.LUMINANCE_ALPHA)for(let t=0;t<s;t++){const n=c[t*r+a];e.getColor(n,h),l[2*t]=Math.floor(76.5*h[0]+150.45*h[1]+28.05*h[2]+.5),l[2*t+1]=o}},e.applyColorMap=n=>{const i=JSON.stringify(t.colorSpace);n.ColorSpace&&(t.colorSpace=r[n.ColorSpace.toUpperCase()],void 0===t.colorSpace&&(h(`ColorSpace ${n.ColorSpace} not supported, using RGB instead`),t.colorSpace=r.RGB));let a=i!==JSON.stringify(t.colorSpace);const o=a||JSON.stringify(t.nanColor);if(n.NanColor)for(t.nanColor=[].concat(n.NanColor);t.nanColor.length<4;)t.nanColor.push(1);a=a||o!==JSON.stringify(t.nanColor);const s=a||JSON.stringify(t.nodes);if(n.RGBPoints){const e=n.RGBPoints.length;t.nodes=[];const i=.5,a=0;for(let o=0;o<e;o+=4)t.nodes.push({x:n.RGBPoints[o],r:n.RGBPoints[o+1],g:n.RGBPoints[o+2],b:n.RGBPoints[o+3],midpoint:i,sharpness:a})}const l=e.sortAndUpdateRange(),d=!l&&(a||s!==JSON.stringify(t.nodes));return d&&e.modified(),l||d}}(e,t)}var w={newInstance:i.m.newInstance(f,"vtkColorTransferFunction"),extend:f,...s.Ay}},9175:(e,t,n)=>{"use strict";n.r(t),n.d(t,{add:()=>c,angle:()=>W,bezier:()=>x,ceil:()=>m,clone:()=>o,copy:()=>l,create:()=>a,cross:()=>D,dist:()=>Y,distance:()=>C,div:()=>Z,divide:()=>u,dot:()=>M,equals:()=>F,exactEquals:()=>G,floor:()=>p,forEach:()=>J,fromValues:()=>r,hermite:()=>P,inverse:()=>A,len:()=>q,length:()=>s,lerp:()=>y,max:()=>f,min:()=>v,mul:()=>$,multiply:()=>g,negate:()=>T,normalize:()=>S,random:()=>R,rotateX:()=>k,rotateY:()=>N,rotateZ:()=>V,round:()=>w,scale:()=>E,scaleAndAdd:()=>I,set:()=>d,sqrDist:()=>j,sqrLen:()=>K,squaredDistance:()=>b,squaredLength:()=>_,str:()=>H,sub:()=>X,subtract:()=>h,transformMat3:()=>O,transformMat4:()=>L,transformQuat:()=>U,zero:()=>B});var i=n(24457);function a(){var e=new i.ARRAY_TYPE(3);return i.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function o(e){var t=new i.ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function s(e){var t=e[0],n=e[1],i=e[2];return Math.hypot(t,n,i)}function r(e,t,n){var a=new i.ARRAY_TYPE(3);return a[0]=e,a[1]=t,a[2]=n,a}function l(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function d(e,t,n,i){return e[0]=t,e[1]=n,e[2]=i,e}function c(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function h(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function g(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e}function u(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e}function m(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function p(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function v(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e}function f(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e}function w(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function E(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function I(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e[2]=t[2]+n[2]*i,e}function C(e,t){var n=t[0]-e[0],i=t[1]-e[1],a=t[2]-e[2];return Math.hypot(n,i,a)}function b(e,t){var n=t[0]-e[0],i=t[1]-e[1],a=t[2]-e[2];return n*n+i*i+a*a}function _(e){var t=e[0],n=e[1],i=e[2];return t*t+n*n+i*i}function T(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function A(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function S(e,t){var n=t[0],i=t[1],a=t[2],o=n*n+i*i+a*a;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function M(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function D(e,t,n){var i=t[0],a=t[1],o=t[2],s=n[0],r=n[1],l=n[2];return e[0]=a*l-o*r,e[1]=o*s-i*l,e[2]=i*r-a*s,e}function y(e,t,n,i){var a=t[0],o=t[1],s=t[2];return e[0]=a+i*(n[0]-a),e[1]=o+i*(n[1]-o),e[2]=s+i*(n[2]-s),e}function P(e,t,n,i,a,o){var s=o*o,r=s*(2*o-3)+1,l=s*(o-2)+o,d=s*(o-1),c=s*(3-2*o);return e[0]=t[0]*r+n[0]*l+i[0]*d+a[0]*c,e[1]=t[1]*r+n[1]*l+i[1]*d+a[1]*c,e[2]=t[2]*r+n[2]*l+i[2]*d+a[2]*c,e}function x(e,t,n,i,a,o){var s=1-o,r=s*s,l=o*o,d=r*s,c=3*o*r,h=3*l*s,g=l*o;return e[0]=t[0]*d+n[0]*c+i[0]*h+a[0]*g,e[1]=t[1]*d+n[1]*c+i[1]*h+a[1]*g,e[2]=t[2]*d+n[2]*c+i[2]*h+a[2]*g,e}function R(e,t){t=t||1;var n=2*i.RANDOM()*Math.PI,a=2*i.RANDOM()-1,o=Math.sqrt(1-a*a)*t;return e[0]=Math.cos(n)*o,e[1]=Math.sin(n)*o,e[2]=a*t,e}function L(e,t,n){var i=t[0],a=t[1],o=t[2],s=n[3]*i+n[7]*a+n[11]*o+n[15];return s=s||1,e[0]=(n[0]*i+n[4]*a+n[8]*o+n[12])/s,e[1]=(n[1]*i+n[5]*a+n[9]*o+n[13])/s,e[2]=(n[2]*i+n[6]*a+n[10]*o+n[14])/s,e}function O(e,t,n){var i=t[0],a=t[1],o=t[2];return e[0]=i*n[0]+a*n[3]+o*n[6],e[1]=i*n[1]+a*n[4]+o*n[7],e[2]=i*n[2]+a*n[5]+o*n[8],e}function U(e,t,n){var i=n[0],a=n[1],o=n[2],s=n[3],r=t[0],l=t[1],d=t[2],c=a*d-o*l,h=o*r-i*d,g=i*l-a*r,u=a*g-o*h,m=o*c-i*g,p=i*h-a*c,v=2*s;return c*=v,h*=v,g*=v,u*=2,m*=2,p*=2,e[0]=r+c+u,e[1]=l+h+m,e[2]=d+g+p,e}function k(e,t,n,i){var a=[],o=[];return a[0]=t[0]-n[0],a[1]=t[1]-n[1],a[2]=t[2]-n[2],o[0]=a[0],o[1]=a[1]*Math.cos(i)-a[2]*Math.sin(i),o[2]=a[1]*Math.sin(i)+a[2]*Math.cos(i),e[0]=o[0]+n[0],e[1]=o[1]+n[1],e[2]=o[2]+n[2],e}function N(e,t,n,i){var a=[],o=[];return a[0]=t[0]-n[0],a[1]=t[1]-n[1],a[2]=t[2]-n[2],o[0]=a[2]*Math.sin(i)+a[0]*Math.cos(i),o[1]=a[1],o[2]=a[2]*Math.cos(i)-a[0]*Math.sin(i),e[0]=o[0]+n[0],e[1]=o[1]+n[1],e[2]=o[2]+n[2],e}function V(e,t,n,i){var a=[],o=[];return a[0]=t[0]-n[0],a[1]=t[1]-n[1],a[2]=t[2]-n[2],o[0]=a[0]*Math.cos(i)-a[1]*Math.sin(i),o[1]=a[0]*Math.sin(i)+a[1]*Math.cos(i),o[2]=a[2],e[0]=o[0]+n[0],e[1]=o[1]+n[1],e[2]=o[2]+n[2],e}function W(e,t){var n=e[0],i=e[1],a=e[2],o=t[0],s=t[1],r=t[2],l=Math.sqrt(n*n+i*i+a*a)*Math.sqrt(o*o+s*s+r*r),d=l&&M(e,t)/l;return Math.acos(Math.min(Math.max(d,-1),1))}function B(e){return e[0]=0,e[1]=0,e[2]=0,e}function H(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function G(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function F(e,t){var n=e[0],a=e[1],o=e[2],s=t[0],r=t[1],l=t[2];return Math.abs(n-s)<=i.EPSILON*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(a-r)<=i.EPSILON*Math.max(1,Math.abs(a),Math.abs(r))&&Math.abs(o-l)<=i.EPSILON*Math.max(1,Math.abs(o),Math.abs(l))}var z,X=h,$=g,Z=u,Y=C,j=b,q=s,K=_,J=(z=a(),function(e,t,n,i,a,o){var s,r;for(t||(t=3),n||(n=0),r=i?Math.min(i*t+n,e.length):e.length,s=n;s<r;s+=t)z[0]=e[s],z[1]=e[s+1],z[2]=e[s+2],a(z,z,o),e[s]=z[0],e[s+1]=z[1],e[s+2]=z[2];return e})},38153:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(18642),a=n(33760);function o(e){let t,n,o;function r(e,i,a=0,o=e.length){if(a<o){if(0!==t(i,i))return o;do{const t=a+o>>>1;n(e[t],i)<0?a=t+1:o=t}while(a<o)}return a}return 2!==e.length?(t=i.A,n=(t,n)=>(0,i.A)(e(t),n),o=(t,n)=>e(t)-n):(t=e===i.A||e===a.A?e:s,n=e,o=e),{left:r,center:function(e,t,n=0,i=e.length){const a=r(e,t,n,i-1);return a>n&&o(e[a-1],t)>-o(e[a],t)?a-1:a},right:function(e,i,a=0,o=e.length){if(a<o){if(0!==t(i,i))return o;do{const t=a+o>>>1;n(e[t],i)<=0?a=t+1:o=t}while(a<o)}return a}}}function s(){return 0}},44779:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(43183);function a(){return(0,i.A)(arguments)}},80136:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i=e=>()=>e},20825:(e,t,n)=>{"use strict";function i(e,t){return e=+e,t=+t,function(n){return e*(1-n)+t*n}}n.d(t,{A:()=>i})},20919:(e,t,n)=>{"use strict";function i(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e(i/(t-1));return n}n.d(t,{A:()=>i})},66822:(e,t,n)=>{"use strict";function i(e,t){return e=+e,t=+t,function(n){return Math.round(e*(1-n)+t*n)}}n.d(t,{A:()=>i})}}]);
//# sourceMappingURL=3190.bundle.c70985174db8526ae0a2.js.map