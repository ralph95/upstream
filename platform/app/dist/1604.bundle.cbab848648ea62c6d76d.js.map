{"version":3,"file":"1604.bundle.cbab848648ea62c6d76d.js","mappings":"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","sources":["webpack:///../../../extensions/dicom-microscopy/src/id.js","webpack:///../../../extensions/dicom-microscopy/src/utils/coordinateFormatScoord3d2Geometry.js","webpack:///../../../extensions/dicom-microscopy/src/utils/styles.js","webpack:///../../../extensions/dicom-microscopy/src/tools/viewerManager.js","webpack:///../../../extensions/dicom-microscopy/src/utils/RoiAnnotation.js","webpack:///../../../extensions/dicom-microscopy/src/utils/areaOfPolygon.js","webpack:///../../../extensions/dicom-microscopy/src/services/MicroscopyService.ts","webpack:///../../../extensions/dicom-microscopy/src/components/MicroscopyPanel/MicroscopyPanel.tsx","webpack:///../../../extensions/dicom-microscopy/src/utils/dcmCodeValues.js","webpack:///../../../extensions/dicom-microscopy/src/utils/toArray.js","webpack:///../../../extensions/dicom-microscopy/src/utils/loadSR.ts","webpack:///../../../extensions/dicom-microscopy/src/utils/getSourceDisplaySet.js","webpack:///../../../extensions/dicom-microscopy/src/DicomMicroscopySRSopClassHandler.js","webpack:///../../../extensions/dicom-microscopy/src/DicomMicroscopyANNSopClassHandler.js","webpack:///../../../extensions/dicom-microscopy/src/utils/loadAnnotation.js","webpack:///../../../extensions/dicom-microscopy/src/index.tsx","webpack:///../../../extensions/dicom-microscopy/src/getPanelModule.tsx","webpack:///../../../extensions/dicom-microscopy/src/getCommandsModule.ts","webpack:///../../../extensions/dicom-microscopy/src/getCustomizationModule.ts","webpack:///../../../extensions/dicom-microscopy/src/utils/dicomWebClient.ts"],"sourcesContent":["import packageJson from '../package.json';\r\n\r\nconst id = packageJson.name;\r\n\r\nexport { id };\r\n","import { inv, multiply } from 'mathjs';\r\n\r\n// TODO -> This is pulled out of some internal logic from Dicom Microscopy Viewer,\r\n// We should likely just expose this there.\r\n\r\nexport default function coordinateFormatScoord3d2Geometry(coordinates, pyramid) {\r\n  let transform = false;\r\n  if (!Array.isArray(coordinates[0])) {\r\n    coordinates = [coordinates];\r\n    transform = true;\r\n  }\r\n  const metadata = pyramid[pyramid.length - 1];\r\n  const orientation = metadata.ImageOrientationSlide;\r\n  const spacing = _getPixelSpacing(metadata);\r\n  const origin = metadata.TotalPixelMatrixOriginSequence[0];\r\n  const offset = [\r\n    Number(origin.XOffsetInSlideCoordinateSystem),\r\n    Number(origin.YOffsetInSlideCoordinateSystem),\r\n  ];\r\n\r\n  coordinates = coordinates.map(c => {\r\n    const slideCoord = [c[0], c[1]];\r\n    const pixelCoord = mapSlideCoord2PixelCoord({\r\n      offset,\r\n      orientation,\r\n      spacing,\r\n      point: slideCoord,\r\n    });\r\n    return [pixelCoord[0], -(pixelCoord[1] + 1), 0];\r\n  });\r\n  if (transform) {\r\n    return coordinates[0];\r\n  }\r\n  return coordinates;\r\n}\r\n\r\nfunction _getPixelSpacing(metadata) {\r\n  if (metadata.PixelSpacing) {\r\n    return metadata.PixelSpacing;\r\n  }\r\n  const functionalGroup = metadata.SharedFunctionalGroupsSequence[0];\r\n  const pixelMeasures = functionalGroup.PixelMeasuresSequence[0];\r\n  return pixelMeasures.PixelSpacing;\r\n}\r\n\r\nfunction mapSlideCoord2PixelCoord(options) {\r\n  // X and Y Offset in Slide Coordinate System\r\n  if (!('offset' in options)) {\r\n    throw new Error('Option \"offset\" is required.');\r\n  }\r\n  if (!Array.isArray(options.offset)) {\r\n    throw new Error('Option \"offset\" must be an array.');\r\n  }\r\n  if (options.offset.length !== 2) {\r\n    throw new Error('Option \"offset\" must be an array with 2 elements.');\r\n  }\r\n  const offset = options.offset;\r\n\r\n  // Image Orientation Slide with direction cosines for Row and Column direction\r\n  if (!('orientation' in options)) {\r\n    throw new Error('Option \"orientation\" is required.');\r\n  }\r\n  if (!Array.isArray(options.orientation)) {\r\n    throw new Error('Option \"orientation\" must be an array.');\r\n  }\r\n  if (options.orientation.length !== 6) {\r\n    throw new Error('Option \"orientation\" must be an array with 6 elements.');\r\n  }\r\n  const orientation = options.orientation;\r\n\r\n  // Pixel Spacing along the Row and Column direction\r\n  if (!('spacing' in options)) {\r\n    throw new Error('Option \"spacing\" is required.');\r\n  }\r\n  if (!Array.isArray(options.spacing)) {\r\n    throw new Error('Option \"spacing\" must be an array.');\r\n  }\r\n  if (options.spacing.length !== 2) {\r\n    throw new Error('Option \"spacing\" must be an array with 2 elements.');\r\n  }\r\n  const spacing = options.spacing;\r\n\r\n  // X and Y coordinate in the Slide Coordinate System\r\n  if (!('point' in options)) {\r\n    throw new Error('Option \"point\" is required.');\r\n  }\r\n  if (!Array.isArray(options.point)) {\r\n    throw new Error('Option \"point\" must be an array.');\r\n  }\r\n  if (options.point.length !== 2) {\r\n    throw new Error('Option \"point\" must be an array with 2 elements.');\r\n  }\r\n  const point = options.point;\r\n\r\n  const m = [\r\n    [orientation[0] * spacing[1], orientation[3] * spacing[0], offset[0]],\r\n    [orientation[1] * spacing[1], orientation[4] * spacing[0], offset[1]],\r\n    [0, 0, 1],\r\n  ];\r\n  const mInverted = inv(m);\r\n\r\n  const vSlide = [[point[0]], [point[1]], [1]];\r\n\r\n  const vImage = multiply(mInverted, vSlide);\r\n\r\n  const row = Number(vImage[1][0].toFixed(4));\r\n  const col = Number(vImage[0][0].toFixed(4));\r\n  return [col, row];\r\n}\r\n","const defaultFill = {\r\n  color: 'rgba(255,255,255,0.4)',\r\n};\r\n\r\nconst emptyFill = {\r\n  color: 'rgba(255,255,255,0.0)',\r\n};\r\n\r\nconst defaultStroke = {\r\n  color: 'rgb(0,255,0)',\r\n  width: 1.5,\r\n};\r\n\r\nconst activeStroke = {\r\n  color: 'rgb(255,255,0)',\r\n  width: 1.5,\r\n};\r\n\r\nconst defaultStyle = {\r\n  image: {\r\n    circle: {\r\n      fill: defaultFill,\r\n      stroke: activeStroke,\r\n      radius: 5,\r\n    },\r\n  },\r\n  fill: defaultFill,\r\n  stroke: activeStroke,\r\n};\r\n\r\nconst emptyStyle = {\r\n  image: {\r\n    circle: {\r\n      fill: emptyFill,\r\n      stroke: defaultStroke,\r\n      radius: 5,\r\n    },\r\n  },\r\n  fill: emptyFill,\r\n  stroke: defaultStroke,\r\n};\r\n\r\nconst styles = {\r\n  active: defaultStyle,\r\n  default: emptyStyle,\r\n};\r\n\r\nexport default styles;\r\n","import coordinateFormatScoord3d2Geometry from '../utils/coordinateFormatScoord3d2Geometry';\r\nimport styles from '../utils/styles';\r\n\r\nimport { PubSubService } from '@ohif/core';\r\n\r\n// Events from the third-party viewer\r\nconst ApiEvents = {\r\n  /** Triggered when a ROI was added. */\r\n  ROI_ADDED: 'dicommicroscopyviewer_roi_added',\r\n  /** Triggered when a ROI was modified. */\r\n  ROI_MODIFIED: 'dicommicroscopyviewer_roi_modified',\r\n  /** Triggered when a ROI was removed. */\r\n  ROI_REMOVED: 'dicommicroscopyviewer_roi_removed',\r\n  /** Triggered when a ROI was drawn. */\r\n  ROI_DRAWN: `dicommicroscopyviewer_roi_drawn`,\r\n  /** Triggered when a ROI was selected. */\r\n  ROI_SELECTED: `dicommicroscopyviewer_roi_selected`,\r\n  /** Triggered when a viewport move has started. */\r\n  MOVE_STARTED: `dicommicroscopyviewer_move_started`,\r\n  /** Triggered when a viewport move has ended. */\r\n  MOVE_ENDED: `dicommicroscopyviewer_move_ended`,\r\n  /** Triggered when a loading of data has started. */\r\n  LOADING_STARTED: `dicommicroscopyviewer_loading_started`,\r\n  /** Triggered when a loading of data has ended. */\r\n  LOADING_ENDED: `dicommicroscopyviewer_loading_ended`,\r\n  /** Triggered when an error occurs during loading of data. */\r\n  LOADING_ERROR: `dicommicroscopyviewer_loading_error`,\r\n  /* Triggered when the loading of an image tile has started. */\r\n  FRAME_LOADING_STARTED: `dicommicroscopyviewer_frame_loading_started`,\r\n  /* Triggered when the loading of an image tile has ended. */\r\n  FRAME_LOADING_ENDED: `dicommicroscopyviewer_frame_loading_ended`,\r\n  /* Triggered when the error occurs during loading of an image tile. */\r\n  FRAME_LOADING_ERROR: `dicommicroscopyviewer_frame_loading_ended`,\r\n};\r\n\r\nconst EVENTS = {\r\n  ADDED: 'added',\r\n  MODIFIED: 'modified',\r\n  REMOVED: 'removed',\r\n  UPDATED: 'updated',\r\n  SELECTED: 'selected',\r\n};\r\n\r\n/**\r\n * ViewerManager encapsulates the complexity of the third-party viewer and\r\n * expose only the features/behaviors that are relevant to the application\r\n */\r\nclass ViewerManager extends PubSubService {\r\n  constructor(viewer, viewportId, container, studyInstanceUID, seriesInstanceUID) {\r\n    super(EVENTS);\r\n    this.viewer = viewer;\r\n    this.viewportId = viewportId;\r\n    this.container = container;\r\n    this.studyInstanceUID = studyInstanceUID;\r\n    this.seriesInstanceUID = seriesInstanceUID;\r\n\r\n    this.onRoiAdded = this.roiAddedHandler.bind(this);\r\n    this.onRoiModified = this.roiModifiedHandler.bind(this);\r\n    this.onRoiRemoved = this.roiRemovedHandler.bind(this);\r\n    this.onRoiSelected = this.roiSelectedHandler.bind(this);\r\n    this.contextMenuCallback = () => {};\r\n\r\n    // init symbols\r\n    const symbols = Object.getOwnPropertySymbols(this.viewer);\r\n    this._drawingSource = symbols.find(p => p.description === 'drawingSource');\r\n    this._pyramid = symbols.find(p => p.description === 'pyramid');\r\n    this._map = symbols.find(p => p.description === 'map');\r\n    this._affine = symbols.find(p => p.description === 'affine');\r\n\r\n    this.registerEvents();\r\n    this.activateDefaultInteractions();\r\n  }\r\n\r\n  addContextMenuCallback(callback) {\r\n    this.contextMenuCallback = callback;\r\n  }\r\n\r\n  /**\r\n   * Destroys this managed viewer instance, clearing all the event handlers\r\n   */\r\n  destroy() {\r\n    this.unregisterEvents();\r\n  }\r\n\r\n  /**\r\n   * This is to overrides the _broadcastEvent method of PubSubService and always\r\n   * send the ROI graphic object and this managed viewer instance.\r\n   * Due to the way that PubSubService is written, the same name override of the\r\n   * function doesn't work.\r\n   *\r\n   * @param {String} key key Subscription key\r\n   * @param {Object} roiGraphic ROI graphic object created by the third-party API\r\n   */\r\n  publish(key, roiGraphic) {\r\n    this._broadcastEvent(key, {\r\n      roiGraphic,\r\n      managedViewer: this,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Registers all the relevant event handlers for the third-party API\r\n   */\r\n  registerEvents() {\r\n    this.container.addEventListener(ApiEvents.ROI_ADDED, this.onRoiAdded);\r\n    this.container.addEventListener(ApiEvents.ROI_MODIFIED, this.onRoiModified);\r\n    this.container.addEventListener(ApiEvents.ROI_REMOVED, this.onRoiRemoved);\r\n    this.container.addEventListener(ApiEvents.ROI_SELECTED, this.onRoiSelected);\r\n  }\r\n\r\n  /**\r\n   * Clears all the relevant event handlers for the third-party API\r\n   */\r\n  unregisterEvents() {\r\n    this.container.removeEventListener(ApiEvents.ROI_ADDED, this.onRoiAdded);\r\n    this.container.removeEventListener(ApiEvents.ROI_MODIFIED, this.onRoiModified);\r\n    this.container.removeEventListener(ApiEvents.ROI_REMOVED, this.onRoiRemoved);\r\n    this.container.removeEventListener(ApiEvents.ROI_SELECTED, this.onRoiSelected);\r\n  }\r\n\r\n  /**\r\n   * Handles the ROI_ADDED event triggered by the third-party API\r\n   *\r\n   * @param {Event} event Event triggered by the third-party API\r\n   */\r\n  roiAddedHandler(event) {\r\n    const roiGraphic = event.detail.payload;\r\n    this.publish(EVENTS.ADDED, roiGraphic);\r\n    this.publish(EVENTS.UPDATED, roiGraphic);\r\n  }\r\n\r\n  /**\r\n   * Handles the ROI_MODIFIED event triggered by the third-party API\r\n   *\r\n   * @param {Event} event Event triggered by the third-party API\r\n   */\r\n  roiModifiedHandler(event) {\r\n    const roiGraphic = event.detail.payload;\r\n    this.publish(EVENTS.MODIFIED, roiGraphic);\r\n    this.publish(EVENTS.UPDATED, roiGraphic);\r\n  }\r\n\r\n  /**\r\n   * Handles the ROI_REMOVED event triggered by the third-party API\r\n   *\r\n   * @param {Event} event Event triggered by the third-party API\r\n   */\r\n  roiRemovedHandler(event) {\r\n    const roiGraphic = event.detail.payload;\r\n    this.publish(EVENTS.REMOVED, roiGraphic);\r\n    this.publish(EVENTS.UPDATED, roiGraphic);\r\n  }\r\n\r\n  /**\r\n   * Handles the ROI_SELECTED event triggered by the third-party API\r\n   *\r\n   * @param {Event} event Event triggered by the third-party API\r\n   */\r\n  roiSelectedHandler(event) {\r\n    const roiGraphic = event.detail.payload;\r\n    this.publish(EVENTS.SELECTED, roiGraphic);\r\n  }\r\n\r\n  /**\r\n   * Run the given callback operation without triggering any events for this\r\n   * instance, so subscribers will not be affected\r\n   *\r\n   * @param {Function} callback Callback that will run sinlently\r\n   */\r\n  runSilently(callback) {\r\n    this.unregisterEvents();\r\n    callback();\r\n    this.registerEvents();\r\n  }\r\n\r\n  /**\r\n   * Removes all the ROI graphics from the third-party API\r\n   */\r\n  clearRoiGraphics() {\r\n    this.runSilently(() => this.viewer.removeAllROIs());\r\n  }\r\n\r\n  showROIs() {\r\n    this.viewer.showROIs();\r\n  }\r\n\r\n  hideROIs() {\r\n    this.viewer.hideROIs();\r\n  }\r\n\r\n  /**\r\n   * Adds the given ROI graphic into the third-party API\r\n   *\r\n   * @param {Object} roiGraphic ROI graphic object to be added\r\n   */\r\n  addRoiGraphic(roiGraphic) {\r\n    this.runSilently(() => this.viewer.addROI(roiGraphic, styles.default));\r\n  }\r\n\r\n  /**\r\n   * Adds the given ROI graphic into the third-party API, and also add a label.\r\n   * Used for importing from SR.\r\n   *\r\n   * @param {Object} roiGraphic ROI graphic object to be added.\r\n   * @param {String} label The label of the annotation.\r\n   */\r\n  addRoiGraphicWithLabel(roiGraphic, label) {\r\n    // NOTE: Dicom Microscopy Viewer will override styles for \"Text\" evaluations\r\n    // to hide all other geometries, we are not going to use its label.\r\n    // if (label) {\r\n    //   if (!roiGraphic.properties) roiGraphic.properties = {};\r\n    //   roiGraphic.properties.label = label;\r\n    // }\r\n    this.runSilently(() => this.viewer.addROI(roiGraphic, styles.default));\r\n\r\n    this._broadcastEvent(EVENTS.ADDED, {\r\n      roiGraphic,\r\n      managedViewer: this,\r\n      label,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sets ROI style\r\n   *\r\n   * @param {String} uid ROI graphic UID to be styled\r\n   * @param {object} styleOptions - Style options\r\n   * @param {object} styleOptions.stroke - Style options for the outline of the geometry\r\n   * @param {number[]} styleOptions.stroke.color - RGBA color of the outline\r\n   * @param {number} styleOptions.stroke.width - Width of the outline\r\n   * @param {object} styleOptions.fill - Style options for body the geometry\r\n   * @param {number[]} styleOptions.fill.color - RGBA color of the body\r\n   * @param {object} styleOptions.image - Style options for image\r\n   */\r\n  setROIStyle(uid, styleOptions) {\r\n    this.viewer.setROIStyle(uid, styleOptions);\r\n  }\r\n\r\n  /**\r\n   * Removes the ROI graphic with the given UID from the third-party API\r\n   *\r\n   * @param {String} uid ROI graphic UID to be removed\r\n   */\r\n  removeRoiGraphic(uid) {\r\n    this.viewer.removeROI(uid);\r\n  }\r\n\r\n  /**\r\n   * Update properties of regions of interest.\r\n   *\r\n   * @param {object} roi - ROI to be updated\r\n   * @param {string} roi.uid - Unique identifier of the region of interest\r\n   * @param {object} roi.properties - ROI properties\r\n   * @returns {void}\r\n   */\r\n  updateROIProperties({ uid, properties }) {\r\n    this.viewer.updateROI({ uid, properties });\r\n  }\r\n\r\n  /**\r\n   * Toggles overview map\r\n   *\r\n   * @returns {void}\r\n   */\r\n  toggleOverviewMap() {\r\n    this.viewer.toggleOverviewMap();\r\n  }\r\n\r\n  /**\r\n   * Activates the viewer default interactions\r\n   * @returns {void}\r\n   */\r\n  activateDefaultInteractions() {\r\n    /** Disable browser's native context menu inside the canvas */\r\n    document.querySelector('.DicomMicroscopyViewer').addEventListener(\r\n      'contextmenu',\r\n      event => {\r\n        event.preventDefault();\r\n        // comment out when context menu for microscopy is enabled\r\n        // if (typeof this.contextMenuCallback === 'function') {\r\n        //   this.contextMenuCallback(event);\r\n        // }\r\n      },\r\n      false\r\n    );\r\n    const defaultInteractions = [\r\n      [\r\n        'dragPan',\r\n        {\r\n          bindings: {\r\n            mouseButtons: ['middle'],\r\n          },\r\n        },\r\n      ],\r\n      [\r\n        'dragZoom',\r\n        {\r\n          bindings: {\r\n            mouseButtons: ['right'],\r\n          },\r\n        },\r\n      ],\r\n      ['modify', {}],\r\n    ];\r\n    this.activateInteractions(defaultInteractions);\r\n  }\r\n\r\n  /**\r\n   * Activates interactions\r\n   * @param {Array} interactions Interactions to be activated\r\n   * @returns {void}\r\n   */\r\n  activateInteractions(interactions) {\r\n    const interactionsMap = {\r\n      draw: activate => (activate ? 'activateDrawInteraction' : 'deactivateDrawInteraction'),\r\n      modify: activate => (activate ? 'activateModifyInteraction' : 'deactivateModifyInteraction'),\r\n      translate: activate =>\r\n        activate ? 'activateTranslateInteraction' : 'deactivateTranslateInteraction',\r\n      snap: activate => (activate ? 'activateSnapInteraction' : 'deactivateSnapInteraction'),\r\n      dragPan: activate =>\r\n        activate ? 'activateDragPanInteraction' : 'deactivateDragPanInteraction',\r\n      dragZoom: activate =>\r\n        activate ? 'activateDragZoomInteraction' : 'deactivateDragZoomInteraction',\r\n      select: activate => (activate ? 'activateSelectInteraction' : 'deactivateSelectInteraction'),\r\n    };\r\n\r\n    const availableInteractionsName = Object.keys(interactionsMap);\r\n    availableInteractionsName.forEach(availableInteractionName => {\r\n      const interaction = interactions.find(\r\n        interaction => interaction[0] === availableInteractionName\r\n      );\r\n      if (!interaction) {\r\n        const deactivateInteractionMethod = interactionsMap[availableInteractionName](false);\r\n        this.viewer[deactivateInteractionMethod]();\r\n      } else {\r\n        const [name, config] = interaction;\r\n        const activateInteractionMethod = interactionsMap[name](true);\r\n        this.viewer[activateInteractionMethod](config);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Accesses the internals of third-party API and returns the OpenLayers Map\r\n   *\r\n   * @returns {Object} OpenLayers Map component instance\r\n   */\r\n  _getMapView() {\r\n    const map = this._getMap();\r\n    return map.getView();\r\n  }\r\n\r\n  _getMap() {\r\n    const symbols = Object.getOwnPropertySymbols(this.viewer);\r\n    const _map = symbols.find(s => String(s) === 'Symbol(map)');\r\n    window['map'] = this.viewer[_map];\r\n    return this.viewer[_map];\r\n  }\r\n\r\n  /**\r\n   * Returns the current state for the OpenLayers View\r\n   *\r\n   * @returns {Object} Current view state\r\n   */\r\n  getViewState() {\r\n    const view = this._getMapView();\r\n    return {\r\n      center: view.getCenter(),\r\n      resolution: view.getResolution(),\r\n      zoom: view.getZoom(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Sets the current state for the OpenLayers View\r\n   *\r\n   * @param {Object} viewState View state to be applied\r\n   */\r\n  setViewState(viewState) {\r\n    const view = this._getMapView();\r\n\r\n    view.setZoom(viewState.zoom);\r\n    view.setResolution(viewState.resolution);\r\n    view.setCenter(viewState.center);\r\n  }\r\n\r\n  setViewStateByExtent(roiAnnotation) {\r\n    const coordinates = roiAnnotation.getCoordinates();\r\n\r\n    if (Array.isArray(coordinates[0]) && !coordinates[2]) {\r\n      this._jumpToPolyline(coordinates);\r\n    } else if (Array.isArray(coordinates[0])) {\r\n      this._jumpToPolygonOrEllipse(coordinates);\r\n    } else {\r\n      this._jumpToPoint(coordinates);\r\n    }\r\n  }\r\n\r\n  _jumpToPoint(coord) {\r\n    const pyramid = this.viewer[this._pyramid].metadata;\r\n\r\n    const mappedCoord = coordinateFormatScoord3d2Geometry(coord, pyramid);\r\n    const view = this._getMapView();\r\n\r\n    view.setCenter(mappedCoord);\r\n  }\r\n\r\n  _jumpToPolyline(coord) {\r\n    const pyramid = this.viewer[this._pyramid].metadata;\r\n\r\n    const mappedCoord = coordinateFormatScoord3d2Geometry(coord, pyramid);\r\n    const view = this._getMapView();\r\n\r\n    const x = mappedCoord[0];\r\n    const y = mappedCoord[1];\r\n\r\n    const xab = (x[0] + y[0]) / 2;\r\n    const yab = (x[1] + y[1]) / 2;\r\n    const midpoint = [xab, yab];\r\n\r\n    view.setCenter(midpoint);\r\n  }\r\n\r\n  _jumpToPolygonOrEllipse(coordinates) {\r\n    const pyramid = this.viewer[this._pyramid].metadata;\r\n\r\n    let minX = Infinity;\r\n    let maxX = -Infinity;\r\n    let minY = Infinity;\r\n    let maxY = -Infinity;\r\n\r\n    coordinates.forEach(coord => {\r\n      let mappedCoord = coordinateFormatScoord3d2Geometry(coord, pyramid);\r\n\r\n      const [x, y] = mappedCoord;\r\n      if (x < minX) {\r\n        minX = x;\r\n      } else if (x > maxX) {\r\n        maxX = x;\r\n      }\r\n\r\n      if (y < minY) {\r\n        minY = y;\r\n      } else if (y > maxY) {\r\n        maxY = y;\r\n      }\r\n    });\r\n\r\n    const width = maxX - minX;\r\n    const height = maxY - minY;\r\n\r\n    minX -= 0.5 * width;\r\n    maxX += 0.5 * width;\r\n    minY -= 0.5 * height;\r\n    maxY += 0.5 * height;\r\n\r\n    const map = this._getMap();\r\n    map.getView().fit([minX, minY, maxX, maxY], map.getSize());\r\n  }\r\n}\r\n\r\nexport { EVENTS };\r\n\r\nexport default ViewerManager;\r\n","import areaOfPolygon from './areaOfPolygon';\r\n\r\nimport { PubSubService } from '@ohif/core';\r\n\r\nconst EVENTS = {\r\n  LABEL_UPDATED: 'labelUpdated',\r\n  GRAPHIC_UPDATED: 'graphicUpdated',\r\n  VIEW_UPDATED: 'viewUpdated',\r\n  REMOVED: 'removed',\r\n};\r\n\r\n/**\r\n * Represents a single annotation for the Microscopy Viewer\r\n */\r\nclass RoiAnnotation extends PubSubService {\r\n  constructor(roiGraphic, studyInstanceUID, seriesInstanceUID, label = '', viewState = null) {\r\n    super(EVENTS);\r\n    this.uid = roiGraphic.uid;\r\n    this.roiGraphic = roiGraphic;\r\n    this.studyInstanceUID = studyInstanceUID;\r\n    this.seriesInstanceUID = seriesInstanceUID;\r\n    this.label = label;\r\n    this.viewState = viewState;\r\n    this.setMeasurements(roiGraphic);\r\n  }\r\n\r\n  getScoord3d() {\r\n    const roiGraphic = this.roiGraphic;\r\n\r\n    const roiGraphicSymbols = Object.getOwnPropertySymbols(roiGraphic);\r\n    const _scoord3d = roiGraphicSymbols.find(s => String(s) === 'Symbol(scoord3d)');\r\n\r\n    return roiGraphic[_scoord3d];\r\n  }\r\n\r\n  getCoordinates() {\r\n    const scoord3d = this.getScoord3d();\r\n    const scoord3dSymbols = Object.getOwnPropertySymbols(scoord3d);\r\n\r\n    const _coordinates = scoord3dSymbols.find(s => String(s) === 'Symbol(coordinates)');\r\n\r\n    const coordinates = scoord3d[_coordinates];\r\n    return coordinates;\r\n  }\r\n\r\n  /**\r\n   * When called will trigger the REMOVED event\r\n   */\r\n  destroy() {\r\n    this._broadcastEvent(EVENTS.REMOVED, this);\r\n  }\r\n\r\n  /**\r\n   * Updates the ROI graphic for the annotation and triggers the GRAPHIC_UPDATED\r\n   * event\r\n   *\r\n   * @param {Object} roiGraphic\r\n   */\r\n  setRoiGraphic(roiGraphic) {\r\n    this.roiGraphic = roiGraphic;\r\n    this.setMeasurements();\r\n    this._broadcastEvent(EVENTS.GRAPHIC_UPDATED, this);\r\n  }\r\n\r\n  /**\r\n   * Update ROI measurement values based on its scoord3d coordinates.\r\n   *\r\n   * @returns {void}\r\n   */\r\n  setMeasurements() {\r\n    const type = this.roiGraphic.scoord3d.graphicType;\r\n    const coordinates = this.roiGraphic.scoord3d.graphicData;\r\n\r\n    switch (type) {\r\n      case 'ELLIPSE':\r\n        // This is a circle so only need one side\r\n        const point1 = coordinates[0];\r\n        const point2 = coordinates[1];\r\n\r\n        let xLength2 = point2[0] - point1[0];\r\n        let yLength2 = point2[1] - point1[1];\r\n\r\n        xLength2 *= xLength2;\r\n        yLength2 *= yLength2;\r\n\r\n        const length = Math.sqrt(xLength2 + yLength2);\r\n        const radius = length / 2;\r\n\r\n        const areaEllipse = Math.PI * radius * radius;\r\n        this._area = areaEllipse;\r\n        this._length = undefined;\r\n        break;\r\n\r\n      case 'POLYGON':\r\n        const areaPolygon = areaOfPolygon(coordinates);\r\n        this._area = areaPolygon;\r\n        this._length = undefined;\r\n        break;\r\n\r\n      case 'POINT':\r\n        this._area = undefined;\r\n        this._length = undefined;\r\n        break;\r\n\r\n      case 'POLYLINE':\r\n        let len = 0;\r\n        for (let i = 1; i < coordinates.length; i++) {\r\n          const p1 = coordinates[i - 1];\r\n          const p2 = coordinates[i];\r\n\r\n          let xLen = p2[0] - p1[0];\r\n          let yLen = p2[1] - p1[1];\r\n\r\n          xLen *= xLen;\r\n          yLen *= yLen;\r\n          len += Math.sqrt(xLen + yLen);\r\n        }\r\n\r\n        this._area = undefined;\r\n        this._length = len;\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the OpenLayer Map's view state for the annotation and triggers the\r\n   * VIEW_UPDATED event\r\n   *\r\n   * @param {Object} viewState The new view state for the annotation\r\n   */\r\n  setViewState(viewState) {\r\n    this.viewState = viewState;\r\n    this._broadcastEvent(EVENTS.VIEW_UPDATED, this);\r\n  }\r\n\r\n  /**\r\n   * Update the label for the annotation and triggers the LABEL_UPDATED event\r\n   *\r\n   * @param {String} label New label for the annotation\r\n   */\r\n  setLabel(label, finding) {\r\n    this.label = label || (finding && finding.CodeMeaning);\r\n    this.finding = finding || {\r\n      CodingSchemeDesignator: '@ohif/extension-dicom-microscopy',\r\n      CodeValue: label,\r\n      CodeMeaning: label,\r\n    };\r\n    this._broadcastEvent(EVENTS.LABEL_UPDATED, this);\r\n  }\r\n\r\n  /**\r\n   * Returns the geometry type of the annotation concatenated with the label\r\n   * defined for the annotation.\r\n   * Difference with getDetailedLabel() is that this will return empty string for empty\r\n   * label.\r\n   *\r\n   * @returns {String} Text with geometry type and label\r\n   */\r\n  getLabel() {\r\n    const label = this.label ? `${this.label}` : '';\r\n    return label;\r\n  }\r\n\r\n  /**\r\n   * Returns the geometry type of the annotation concatenated with the label\r\n   * defined for the annotation\r\n   *\r\n   * @returns {String} Text with geometry type and label\r\n   */\r\n  getDetailedLabel() {\r\n    const label = this.label ? `${this.label}` : '(empty)';\r\n    return label;\r\n  }\r\n\r\n  getLength() {\r\n    return this._length;\r\n  }\r\n\r\n  getArea() {\r\n    return this._area;\r\n  }\r\n}\r\n\r\nexport { EVENTS };\r\n\r\nexport default RoiAnnotation;\r\n","export default function areaOfPolygon(coordinates) {\r\n  // Shoelace algorithm.\r\n  const n = coordinates.length;\r\n  let area = 0.0;\r\n  let j = n - 1;\r\n\r\n  for (let i = 0; i < n; i++) {\r\n    area += (coordinates[j][0] + coordinates[i][0]) * (coordinates[j][1] - coordinates[i][1]);\r\n    j = i; // j is previous vertex to i\r\n  }\r\n\r\n  // Return absolute value of half the sum\r\n  // (The value is halved as we are summing up triangles, not rectangles).\r\n  return Math.abs(area / 2.0);\r\n}\r\n","import ViewerManager, { EVENTS as ViewerEvents } from '../tools/viewerManager';\r\nimport RoiAnnotation, { EVENTS as AnnotationEvents } from '../utils/RoiAnnotation';\r\nimport styles from '../utils/styles';\r\nimport { DicomMetadataStore, PubSubService } from '@ohif/core';\r\n\r\nconst EVENTS = {\r\n  ANNOTATION_UPDATED: 'annotationUpdated',\r\n  ANNOTATION_SELECTED: 'annotationSelected',\r\n  ANNOTATION_REMOVED: 'annotationRemoved',\r\n  RELABEL: 'relabel',\r\n  DELETE: 'delete',\r\n};\r\n\r\n/**\r\n * MicroscopyService is responsible to manage multiple third-party API's\r\n * microscopy viewers expose methods to manage the interaction with these\r\n * viewers and handle their ROI graphics to create, remove and modify the\r\n * ROI annotations relevant to the application\r\n */\r\nexport default class MicroscopyService extends PubSubService {\r\n  public static REGISTRATION = servicesManager => {\r\n    return {\r\n      name: 'microscopyService',\r\n      altName: 'MicroscopyService',\r\n      create: props => {\r\n        return new MicroscopyService(props);\r\n      },\r\n    };\r\n  };\r\n\r\n  servicesManager: any;\r\n\r\n  managedViewers = new Set();\r\n  roiUids = new Set();\r\n  annotations = {};\r\n  selectedAnnotation = null;\r\n  pendingFocus = false;\r\n\r\n  constructor({ servicesManager, extensionManager }) {\r\n    super(EVENTS);\r\n    this.servicesManager = servicesManager;\r\n    this.peerImport = extensionManager.appConfig.peerImport;\r\n    this._onRoiAdded = this._onRoiAdded.bind(this);\r\n    this._onRoiModified = this._onRoiModified.bind(this);\r\n    this._onRoiRemoved = this._onRoiRemoved.bind(this);\r\n    this._onRoiUpdated = this._onRoiUpdated.bind(this);\r\n    this._onRoiSelected = this._onRoiSelected.bind(this);\r\n    this.isROIsVisible = true;\r\n  }\r\n\r\n  /**\r\n   * Clears all the annotations and managed viewers, setting the manager state\r\n   * to its initial state\r\n   */\r\n  clear() {\r\n    this.managedViewers.forEach(managedViewer => managedViewer.destroy());\r\n    this.managedViewers.clear();\r\n    for (const key in this.annotations) {\r\n      delete this.annotations[key];\r\n    }\r\n\r\n    this.roiUids.clear();\r\n    this.selectedAnnotation = null;\r\n    this.pendingFocus = false;\r\n  }\r\n\r\n  clearAnnotations() {\r\n    Object.keys(this.annotations).forEach(uid => {\r\n      this.removeAnnotation(this.annotations[uid]);\r\n    });\r\n  }\r\n\r\n  public importDicomMicroscopyViewer(): Promise<any> {\r\n    return this.peerImport('dicom-microscopy-viewer');\r\n  }\r\n\r\n  /**\r\n   * Observes when a ROI graphic is added, creating the correspondent annotation\r\n   * with the current graphic and view state.\r\n   * Creates a subscription for label updating for the created annotation and\r\n   * publishes an ANNOTATION_UPDATED event when it happens.\r\n   * Also triggers the relabel process after the graphic is placed.\r\n   *\r\n   * @param {Object} data The published data\r\n   * @param {Object} data.roiGraphic The added ROI graphic object\r\n   * @param {ViewerManager} data.managedViewer The origin viewer for the event\r\n   */\r\n  _onRoiAdded(data) {\r\n    const { roiGraphic, managedViewer, label } = data;\r\n    const { studyInstanceUID, seriesInstanceUID } = managedViewer;\r\n    const viewState = managedViewer.getViewState();\r\n\r\n    const roiAnnotation = new RoiAnnotation(\r\n      roiGraphic,\r\n      studyInstanceUID,\r\n      seriesInstanceUID,\r\n      '',\r\n      viewState\r\n    );\r\n\r\n    this.roiUids.add(roiGraphic.uid);\r\n    this.annotations[roiGraphic.uid] = roiAnnotation;\r\n\r\n    roiAnnotation.subscribe(AnnotationEvents.LABEL_UPDATED, () => {\r\n      this._broadcastEvent(EVENTS.ANNOTATION_UPDATED, roiAnnotation);\r\n    });\r\n\r\n    if (label !== undefined) {\r\n      roiAnnotation.setLabel(label);\r\n    } else {\r\n      const onRelabel = item =>\r\n        managedViewer.updateROIProperties({\r\n          uid: roiGraphic.uid,\r\n          properties: { label: item.label, finding: item.finding },\r\n        });\r\n      this.triggerRelabel(roiAnnotation, true, onRelabel);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Observes when a ROI graphic is modified, updating the correspondent\r\n   * annotation with the current graphic and view state.\r\n   *\r\n   * @param {Object} data The published data\r\n   * @param {Object} data.roiGraphic The modified ROI graphic object\r\n   */\r\n  _onRoiModified(data) {\r\n    const { roiGraphic, managedViewer } = data;\r\n    const roiAnnotation = this.getAnnotation(roiGraphic.uid);\r\n    if (!roiAnnotation) {\r\n      return;\r\n    }\r\n    roiAnnotation.setRoiGraphic(roiGraphic);\r\n    roiAnnotation.setViewState(managedViewer.getViewState());\r\n  }\r\n\r\n  /**\r\n   * Observes when a ROI graphic is removed, reflecting the removal in the\r\n   * annotations' state.\r\n   *\r\n   * @param {Object} data The published data\r\n   * @param {Object} data.roiGraphic The removed ROI graphic object\r\n   */\r\n  _onRoiRemoved(data) {\r\n    const { roiGraphic } = data;\r\n    this.roiUids.delete(roiGraphic.uid);\r\n    this.annotations[roiGraphic.uid].destroy();\r\n    delete this.annotations[roiGraphic.uid];\r\n    this._broadcastEvent(EVENTS.ANNOTATION_REMOVED, roiGraphic);\r\n  }\r\n\r\n  /**\r\n   * Observes any changes on ROI graphics and synchronize all the managed\r\n   * viewers to reflect those changes.\r\n   * Also publishes an ANNOTATION_UPDATED event to notify the subscribers.\r\n   *\r\n   * @param {Object} data The published data\r\n   * @param {Object} data.roiGraphic The added ROI graphic object\r\n   * @param {ViewerManager} data.managedViewer The origin viewer for the event\r\n   */\r\n  _onRoiUpdated(data) {\r\n    const { roiGraphic, managedViewer } = data;\r\n    this.synchronizeViewers(managedViewer);\r\n    this._broadcastEvent(EVENTS.ANNOTATION_UPDATED, this.getAnnotation(roiGraphic.uid));\r\n  }\r\n\r\n  /**\r\n   * Observes when an ROI is selected.\r\n   * Also publishes an ANNOTATION_SELECTED event to notify the subscribers.\r\n   *\r\n   * @param {Object} data The published data\r\n   * @param {Object} data.roiGraphic The added ROI graphic object\r\n   * @param {ViewerManager} data.managedViewer The origin viewer for the event\r\n   */\r\n  _onRoiSelected(data) {\r\n    const { roiGraphic } = data;\r\n    const selectedAnnotation = this.getAnnotation(roiGraphic.uid);\r\n    if (selectedAnnotation && selectedAnnotation !== this.getSelectedAnnotation()) {\r\n      if (this.selectedAnnotation) {\r\n        this.clearSelection();\r\n      }\r\n      this.selectedAnnotation = selectedAnnotation;\r\n      this._broadcastEvent(EVENTS.ANNOTATION_SELECTED, selectedAnnotation);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates the subscriptions for the managed viewer being added\r\n   *\r\n   * @param {ViewerManager} managedViewer The viewer being added\r\n   */\r\n  _addManagedViewerSubscriptions(managedViewer) {\r\n    managedViewer._roiAddedSubscription = managedViewer.subscribe(\r\n      ViewerEvents.ADDED,\r\n      this._onRoiAdded\r\n    );\r\n    managedViewer._roiModifiedSubscription = managedViewer.subscribe(\r\n      ViewerEvents.MODIFIED,\r\n      this._onRoiModified\r\n    );\r\n    managedViewer._roiRemovedSubscription = managedViewer.subscribe(\r\n      ViewerEvents.REMOVED,\r\n      this._onRoiRemoved\r\n    );\r\n    managedViewer._roiUpdatedSubscription = managedViewer.subscribe(\r\n      ViewerEvents.UPDATED,\r\n      this._onRoiUpdated\r\n    );\r\n    managedViewer._roiSelectedSubscription = managedViewer.subscribe(\r\n      ViewerEvents.UPDATED,\r\n      this._onRoiSelected\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Removes the subscriptions for the managed viewer being removed\r\n   *\r\n   * @param {ViewerManager} managedViewer The viewer being removed\r\n   */\r\n  _removeManagedViewerSubscriptions(managedViewer) {\r\n    managedViewer._roiAddedSubscription && managedViewer._roiAddedSubscription.unsubscribe();\r\n    managedViewer._roiModifiedSubscription && managedViewer._roiModifiedSubscription.unsubscribe();\r\n    managedViewer._roiRemovedSubscription && managedViewer._roiRemovedSubscription.unsubscribe();\r\n    managedViewer._roiUpdatedSubscription && managedViewer._roiUpdatedSubscription.unsubscribe();\r\n    managedViewer._roiSelectedSubscription && managedViewer._roiSelectedSubscription.unsubscribe();\r\n\r\n    managedViewer._roiAddedSubscription = null;\r\n    managedViewer._roiModifiedSubscription = null;\r\n    managedViewer._roiRemovedSubscription = null;\r\n    managedViewer._roiUpdatedSubscription = null;\r\n    managedViewer._roiSelectedSubscription = null;\r\n  }\r\n\r\n  /**\r\n   * Returns the managed viewers that are displaying the image with the given\r\n   * study and series UIDs\r\n   *\r\n   * @param {String} studyInstanceUID UID for the study\r\n   * @param {String} seriesInstanceUID UID for the series\r\n   *\r\n   * @returns {Array} The managed viewers for the given series UID\r\n   */\r\n  _getManagedViewersForSeries(studyInstanceUID, seriesInstanceUID) {\r\n    const filter = managedViewer =>\r\n      managedViewer.studyInstanceUID === studyInstanceUID &&\r\n      managedViewer.seriesInstanceUID === seriesInstanceUID;\r\n    return Array.from(this.managedViewers).filter(filter);\r\n  }\r\n\r\n  /**\r\n   * Returns the managed viewers that are displaying the image with the given\r\n   * study UID\r\n   *\r\n   * @param {String} studyInstanceUID UID for the study\r\n   *\r\n   * @returns {Array} The managed viewers for the given series UID\r\n   */\r\n  getManagedViewersForStudy(studyInstanceUID) {\r\n    const filter = managedViewer => managedViewer.studyInstanceUID === studyInstanceUID;\r\n    return Array.from(this.managedViewers).filter(filter);\r\n  }\r\n\r\n  getManagedViewersForViewport(viewportId) {\r\n    const filter = managedViewer => managedViewer.viewportId === viewportId;\r\n    return Array.from(this.managedViewers).filter(filter);\r\n  }\r\n\r\n  /**\r\n   * Restores the created annotations for the viewer being added\r\n   *\r\n   * @param {ViewerManager} managedViewer The viewer being added\r\n   */\r\n  _restoreAnnotations(managedViewer) {\r\n    const { studyInstanceUID, seriesInstanceUID } = managedViewer;\r\n    const annotations = this.getAnnotationsForSeries(studyInstanceUID, seriesInstanceUID);\r\n    annotations.forEach(roiAnnotation => {\r\n      managedViewer.addRoiGraphic(roiAnnotation.roiGraphic);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a managed viewer instance for the given third-party API's viewer.\r\n   * Restores existing annotations for the given study/series.\r\n   * Adds event subscriptions for the viewer being added.\r\n   * Focuses the selected annotation when the viewer is being loaded into the\r\n   * active viewport.\r\n   *\r\n   * @param viewer - Third-party viewer API's object to be managed\r\n   * @param viewportId - The viewport Id where the viewer will be loaded\r\n   * @param container - The DOM element where it will be rendered\r\n   * @param studyInstanceUID - The study UID of the loaded image\r\n   * @param seriesInstanceUID - The series UID of the loaded image\r\n   * @param displaySets - All displaySets related to the same StudyInstanceUID\r\n   *\r\n   * @returns {ViewerManager} managed viewer\r\n   */\r\n  addViewer(viewer, viewportId, container, studyInstanceUID, seriesInstanceUID) {\r\n    // Check if a viewer already exists for this viewportId\r\n    const existingViewer = Array.from(this.managedViewers).find(mv => mv.viewportId === viewportId);\r\n    if (existingViewer) {\r\n      // If a viewer exists, remove it first\r\n      this.removeViewer(existingViewer.viewer);\r\n    }\r\n\r\n    const managedViewer = new ViewerManager(\r\n      viewer,\r\n      viewportId,\r\n      container,\r\n      studyInstanceUID,\r\n      seriesInstanceUID\r\n    );\r\n\r\n    this._restoreAnnotations(managedViewer);\r\n    viewer._manager = managedViewer;\r\n    this.managedViewers.add(managedViewer);\r\n\r\n    // this._potentiallyLoadSR(studyInstanceUID, displaySets);\r\n    this._addManagedViewerSubscriptions(managedViewer);\r\n\r\n    if (this.pendingFocus) {\r\n      this.pendingFocus = false;\r\n      this.focusAnnotation(this.selectedAnnotation, viewportId);\r\n    }\r\n\r\n    return managedViewer;\r\n  }\r\n\r\n  _potentiallyLoadSR(StudyInstanceUID, displaySets) {\r\n    const studyMetadata = DicomMetadataStore.getStudy(StudyInstanceUID);\r\n    const smDisplaySet = displaySets.find(ds => ds.Modality === 'SM');\r\n\r\n    const { FrameOfReferenceUID, othersFrameOfReferenceUID } = smDisplaySet;\r\n\r\n    if (!studyMetadata) {\r\n      return;\r\n    }\r\n\r\n    let derivedDisplaySets = FrameOfReferenceUID\r\n      ? displaySets.filter(\r\n          ds =>\r\n            ds.ReferencedFrameOfReferenceUID === FrameOfReferenceUID ||\r\n            // sometimes each depth instance has the different FrameOfReferenceID\r\n            othersFrameOfReferenceUID.includes(ds.ReferencedFrameOfReferenceUID)\r\n        )\r\n      : [];\r\n\r\n    if (!derivedDisplaySets.length) {\r\n      return;\r\n    }\r\n\r\n    derivedDisplaySets = derivedDisplaySets.filter(ds => ds.Modality === 'SR');\r\n\r\n    if (derivedDisplaySets.some(ds => ds.isLoaded === true)) {\r\n      // Don't auto load\r\n      return;\r\n    }\r\n\r\n    // find most recent and load it.\r\n    let recentDateTime = 0;\r\n    let recentDisplaySet = derivedDisplaySets[0];\r\n\r\n    derivedDisplaySets.forEach(ds => {\r\n      const dateTime = Number(`${ds.SeriesDate}${ds.SeriesTime}`);\r\n      if (dateTime > recentDateTime) {\r\n        recentDateTime = dateTime;\r\n        recentDisplaySet = ds;\r\n      }\r\n    });\r\n\r\n    if (recentDisplaySet.isLoading) {\r\n      return;\r\n    }\r\n\r\n    recentDisplaySet.isLoading = true;\r\n\r\n    recentDisplaySet.load(smDisplaySet);\r\n  }\r\n\r\n  /**\r\n   * Removes the given third-party viewer API's object from the managed viewers\r\n   * and clears all its event subscriptions\r\n   *\r\n   * @param {Object} viewer Third-party viewer API's object to be removed\r\n   */\r\n  removeViewer(viewer) {\r\n    const managedViewer = viewer._manager;\r\n\r\n    this._removeManagedViewerSubscriptions(managedViewer);\r\n    managedViewer.destroy();\r\n    this.managedViewers.delete(managedViewer);\r\n  }\r\n\r\n  /**\r\n   * Toggle ROIs visibility\r\n   */\r\n  toggleROIsVisibility() {\r\n    this.isROIsVisible ? this.hideROIs() : this.showROIs;\r\n    this.isROIsVisible = !this.isROIsVisible;\r\n  }\r\n\r\n  /**\r\n   * Hide all ROIs\r\n   */\r\n  hideROIs() {\r\n    this.managedViewers.forEach(mv => mv.hideROIs());\r\n  }\r\n\r\n  /** Show all ROIs */\r\n  showROIs() {\r\n    this.managedViewers.forEach(mv => mv.showROIs());\r\n  }\r\n\r\n  /**\r\n   * Returns a RoiAnnotation instance for the given ROI UID\r\n   *\r\n   * @param {String} uid UID of the annotation\r\n   *\r\n   * @returns {RoiAnnotation} The RoiAnnotation instance found for the given UID\r\n   */\r\n  getAnnotation(uid) {\r\n    return this.annotations[uid];\r\n  }\r\n\r\n  /**\r\n   * Returns all the RoiAnnotation instances being managed\r\n   *\r\n   * @returns {Array} All RoiAnnotation instances\r\n   */\r\n  getAnnotations() {\r\n    const annotations = [];\r\n    Object.keys(this.annotations).forEach(uid => {\r\n      annotations.push(this.getAnnotation(uid));\r\n    });\r\n    return annotations;\r\n  }\r\n\r\n  /**\r\n   * Returns the RoiAnnotation instances registered with the given study UID\r\n   *\r\n   * @param {String} studyInstanceUID UID for the study\r\n   */\r\n  getAnnotationsForStudy(studyInstanceUID) {\r\n    const filter = a => a.studyInstanceUID === studyInstanceUID;\r\n    return this.getAnnotations().filter(filter);\r\n  }\r\n\r\n  /**\r\n   * Returns the RoiAnnotation instances registered with the given study and\r\n   * series UIDs\r\n   *\r\n   * @param {String} studyInstanceUID UID for the study\r\n   * @param {String} seriesInstanceUID UID for the series\r\n   */\r\n  getAnnotationsForSeries(studyInstanceUID, seriesInstanceUID) {\r\n    const filter = annotation =>\r\n      annotation.studyInstanceUID === studyInstanceUID &&\r\n      annotation.seriesInstanceUID === seriesInstanceUID;\r\n    return this.getAnnotations().filter(filter);\r\n  }\r\n\r\n  /**\r\n   * Returns the selected RoiAnnotation instance or null if none is selected\r\n   *\r\n   * @returns {RoiAnnotation} The selected RoiAnnotation instance\r\n   */\r\n  getSelectedAnnotation() {\r\n    return this.selectedAnnotation;\r\n  }\r\n\r\n  /**\r\n   * Clear current RoiAnnotation selection\r\n   */\r\n  clearSelection() {\r\n    if (this.selectedAnnotation) {\r\n      this.setROIStyle(this.selectedAnnotation.uid, {\r\n        stroke: {\r\n          color: '#00ff00',\r\n        },\r\n      });\r\n    }\r\n    this.selectedAnnotation = null;\r\n  }\r\n\r\n  /**\r\n   * Selects the given RoiAnnotation instance, publishing an ANNOTATION_SELECTED\r\n   * event to notify all the subscribers\r\n   *\r\n   * @param {RoiAnnotation} roiAnnotation The instance to be selected\r\n   */\r\n  selectAnnotation(roiAnnotation) {\r\n    if (this.selectedAnnotation) {\r\n      this.clearSelection();\r\n    }\r\n\r\n    this.selectedAnnotation = roiAnnotation;\r\n    this._broadcastEvent(EVENTS.ANNOTATION_SELECTED, roiAnnotation);\r\n    this.setROIStyle(roiAnnotation.uid, styles.active);\r\n  }\r\n\r\n  /**\r\n   * Toggles overview map\r\n   *\r\n   * @param viewportId The active viewport index\r\n   * @returns {void}\r\n   */\r\n  toggleOverviewMap(viewportId) {\r\n    const managedViewers = Array.from(this.managedViewers);\r\n    const managedViewer = managedViewers.find(mv => mv.viewportId === viewportId);\r\n    if (managedViewer) {\r\n      managedViewer.toggleOverviewMap();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a RoiAnnotation instance from the managed annotations and reflects\r\n   * its removal on all third-party viewers being managed\r\n   *\r\n   * @param {RoiAnnotation} roiAnnotation The instance to be removed\r\n   */\r\n  removeAnnotation(roiAnnotation) {\r\n    const { uid, studyInstanceUID, seriesInstanceUID } = roiAnnotation;\r\n    const filter = managedViewer =>\r\n      managedViewer.studyInstanceUID === studyInstanceUID &&\r\n      managedViewer.seriesInstanceUID === seriesInstanceUID;\r\n\r\n    const managedViewers = Array.from(this.managedViewers).filter(filter);\r\n\r\n    managedViewers.forEach(managedViewer => managedViewer.removeRoiGraphic(uid));\r\n\r\n    if (this.annotations[uid]) {\r\n      this.roiUids.delete(uid);\r\n      this.annotations[uid].destroy();\r\n      delete this.annotations[uid];\r\n\r\n      this._broadcastEvent(EVENTS.ANNOTATION_REMOVED, roiAnnotation);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Focus the given RoiAnnotation instance by changing the OpenLayers' Map view\r\n   * state of the managed viewer with the given viewport index.\r\n   * If the image for the given annotation is not yet loaded into the viewport,\r\n   * it will set a pendingFocus flag to true in order to perform the focus when\r\n   * the managed viewer instance is created.\r\n   *\r\n   * @param {RoiAnnotation} roiAnnotation RoiAnnotation instance to be focused\r\n   * @param {string} viewportId Index of the viewport to focus\r\n   */\r\n  focusAnnotation(roiAnnotation, viewportId) {\r\n    const filter = mv => mv.viewportId === viewportId;\r\n    const managedViewer = Array.from(this.managedViewers).find(filter);\r\n    if (managedViewer) {\r\n      managedViewer.setViewStateByExtent(roiAnnotation);\r\n    } else {\r\n      this.pendingFocus = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Synchronize the ROI graphics for all the managed viewers that has the same\r\n   * series UID of the given managed viewer\r\n   *\r\n   * @param {ViewerManager} baseManagedViewer Reference managed viewer\r\n   */\r\n  synchronizeViewers(baseManagedViewer) {\r\n    const { studyInstanceUID, seriesInstanceUID } = baseManagedViewer;\r\n    const managedViewers = this._getManagedViewersForSeries(studyInstanceUID, seriesInstanceUID);\r\n\r\n    // Prevent infinite loops arrising from updates.\r\n    managedViewers.forEach(managedViewer => this._removeManagedViewerSubscriptions(managedViewer));\r\n\r\n    managedViewers.forEach(managedViewer => {\r\n      if (managedViewer === baseManagedViewer) {\r\n        return;\r\n      }\r\n\r\n      const annotations = this.getAnnotationsForSeries(studyInstanceUID, seriesInstanceUID);\r\n      managedViewer.clearRoiGraphics();\r\n      annotations.forEach(roiAnnotation => {\r\n        managedViewer.addRoiGraphic(roiAnnotation.roiGraphic);\r\n      });\r\n    });\r\n\r\n    managedViewers.forEach(managedViewer => this._addManagedViewerSubscriptions(managedViewer));\r\n  }\r\n\r\n  /**\r\n   * Activates interactions across all the viewers being managed\r\n   *\r\n   * @param {Array} interactions interactions\r\n   */\r\n  activateInteractions(interactions) {\r\n    this.managedViewers.forEach(mv => mv.activateInteractions(interactions));\r\n    this.activeInteractions = interactions;\r\n  }\r\n\r\n  getActiveInteractions() {\r\n    return this.activeInteractions;\r\n  }\r\n\r\n  /**\r\n   * Triggers the relabelling process for the given RoiAnnotation instance, by\r\n   * publishing the RELABEL event to notify the subscribers\r\n   *\r\n   * @param {RoiAnnotation} roiAnnotation The instance to be relabelled\r\n   * @param {boolean} newAnnotation Whether the annotation is newly drawn (so it deletes on cancel).\r\n   */\r\n  triggerRelabel(roiAnnotation, newAnnotation = false, onRelabel) {\r\n    if (!onRelabel) {\r\n      onRelabel = ({ label }) =>\r\n        this.managedViewers.forEach(mv =>\r\n          mv.updateROIProperties({\r\n            uid: roiAnnotation.uid,\r\n            properties: { label },\r\n          })\r\n        );\r\n    }\r\n\r\n    this._broadcastEvent(EVENTS.RELABEL, {\r\n      roiAnnotation,\r\n      deleteCallback: () => this.removeAnnotation(roiAnnotation),\r\n      successCallback: onRelabel,\r\n      newAnnotation,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Triggers the deletion process for the given RoiAnnotation instance, by\r\n   * publishing the DELETE event to notify the subscribers\r\n   *\r\n   * @param {RoiAnnotation} roiAnnotation The instance to be deleted\r\n   */\r\n  triggerDelete(roiAnnotation) {\r\n    this._broadcastEvent(EVENTS.DELETE, roiAnnotation);\r\n  }\r\n\r\n  /**\r\n   * Set ROI style for all managed viewers\r\n   *\r\n   * @param {string} uid The ROI uid that will be styled\r\n   * @param {object} styleOptions - Style options\r\n   * @param {object*} styleOptions.stroke - Style options for the outline of the geometry\r\n   * @param {number[]} styleOptions.stroke.color - RGBA color of the outline\r\n   * @param {number} styleOptions.stroke.width - Width of the outline\r\n   * @param {object*} styleOptions.fill - Style options for body the geometry\r\n   * @param {number[]} styleOptions.fill.color - RGBA color of the body\r\n   * @param {object*} styleOptions.image - Style options for image\r\n   */\r\n  setROIStyle(uid, styleOptions) {\r\n    this.managedViewers.forEach(mv => mv.setROIStyle(uid, styleOptions));\r\n  }\r\n\r\n  /**\r\n   * Get all managed viewers\r\n   *\r\n   * @returns {Array} managedViewers\r\n   */\r\n  getAllManagedViewers() {\r\n    return Array.from(this.managedViewers);\r\n  }\r\n}\r\n\r\nexport { EVENTS };\r\n","import React, { useState, useEffect } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { callInputDialog } from '@ohif/extension-default';\r\nimport { ExtensionManager, CommandsManager, DicomMetadataStore } from '@ohif/core';\r\nimport { DataRow } from '@ohif/ui-next';\r\nimport { withTranslation, WithTranslation } from 'react-i18next';\r\nimport { EVENTS as MicroscopyEvents } from '../../services/MicroscopyService';\r\nimport dcmjs from 'dcmjs';\r\nimport constructSR from '../../utils/constructSR';\r\nimport { saveByteArray } from '../../utils/saveByteArray';\r\n\r\nlet saving = false;\r\nconst { datasetToBuffer } = dcmjs.data;\r\n\r\nconst formatArea = area => {\r\n  let mult = 1;\r\n  let unit = 'mm';\r\n  if (area > 1000000) {\r\n    unit = 'm';\r\n    mult = 1 / 1000000;\r\n  } else if (area < 1) {\r\n    unit = 'μm';\r\n    mult = 1000000;\r\n  }\r\n  return `${(area * mult).toFixed(2)} ${unit}²`;\r\n};\r\n\r\nconst formatLength = (length, unit) => {\r\n  let mult = 1;\r\n  if (unit == 'km' || (!unit && length > 1000000)) {\r\n    unit = 'km';\r\n    mult = 1 / 1000000;\r\n  } else if (unit == 'm' || (!unit && length > 1000)) {\r\n    unit = 'm';\r\n    mult = 1 / 1000;\r\n  } else if (unit == 'μm' || (!unit && length < 1)) {\r\n    unit = 'μm';\r\n    mult = 1000;\r\n  } else if (unit && unit != 'mm') {\r\n    throw new Error(`Unknown length unit ${unit}`);\r\n  } else {\r\n    unit = 'mm';\r\n  }\r\n  return `${(length * mult).toFixed(2)} ${unit}`;\r\n};\r\n\r\ninterface IMicroscopyPanelProps extends WithTranslation {\r\n  viewports: PropTypes.array;\r\n  activeViewportId: PropTypes.string;\r\n\r\n  //\r\n  onSaveComplete?: PropTypes.func; // callback when successfully saved annotations\r\n  onRejectComplete?: PropTypes.func; // callback when rejected annotations\r\n\r\n  //\r\n  servicesManager: AppTypes.ServicesManager;\r\n  extensionManager: ExtensionManager;\r\n  commandsManager: CommandsManager;\r\n}\r\n\r\n/**\r\n * Microscopy Measurements Panel Component\r\n *\r\n * @param props\r\n * @returns\r\n */\r\nfunction MicroscopyPanel(props: IMicroscopyPanelProps) {\r\n  const { microscopyService } = props.servicesManager.services;\r\n\r\n  const [studyInstanceUID, setStudyInstanceUID] = useState(null as string | null);\r\n  const [roiAnnotations, setRoiAnnotations] = useState([] as any[]);\r\n  const [selectedAnnotation, setSelectedAnnotation] = useState(null as any);\r\n  const { servicesManager, extensionManager } = props;\r\n\r\n  const { uiDialogService, displaySetService } = servicesManager.services;\r\n\r\n  useEffect(() => {\r\n    const viewport = props.viewports.get(props.activeViewportId);\r\n    if (viewport?.displaySetInstanceUIDs[0]) {\r\n      const displaySet = displaySetService.getDisplaySetByUID(viewport.displaySetInstanceUIDs[0]);\r\n      if (displaySet) {\r\n        setStudyInstanceUID(displaySet.StudyInstanceUID);\r\n      }\r\n    }\r\n  }, [props.viewports, props.activeViewportId]);\r\n\r\n  useEffect(() => {\r\n    const onAnnotationUpdated = () => {\r\n      const roiAnnotations = microscopyService.getAnnotationsForStudy(studyInstanceUID);\r\n      setRoiAnnotations(roiAnnotations);\r\n    };\r\n\r\n    const onAnnotationSelected = () => {\r\n      const selectedAnnotation = microscopyService.getSelectedAnnotation();\r\n      setSelectedAnnotation(selectedAnnotation);\r\n    };\r\n\r\n    const onAnnotationRemoved = () => {\r\n      onAnnotationUpdated();\r\n    };\r\n\r\n    const { unsubscribe: unsubscribeAnnotationUpdated } = microscopyService.subscribe(\r\n      MicroscopyEvents.ANNOTATION_UPDATED,\r\n      onAnnotationUpdated\r\n    );\r\n    const { unsubscribe: unsubscribeAnnotationSelected } = microscopyService.subscribe(\r\n      MicroscopyEvents.ANNOTATION_SELECTED,\r\n      onAnnotationSelected\r\n    );\r\n    const { unsubscribe: unsubscribeAnnotationRemoved } = microscopyService.subscribe(\r\n      MicroscopyEvents.ANNOTATION_REMOVED,\r\n      onAnnotationRemoved\r\n    );\r\n    onAnnotationUpdated();\r\n    onAnnotationSelected();\r\n\r\n    // on unload unsubscribe from events\r\n    return () => {\r\n      unsubscribeAnnotationUpdated();\r\n      unsubscribeAnnotationSelected();\r\n      unsubscribeAnnotationRemoved();\r\n    };\r\n  }, [studyInstanceUID]);\r\n\r\n  /**\r\n   * On clicking \"Save Annotations\" button, prompt an input modal for the\r\n   * new series' description, and continue to save.\r\n   *\r\n   * @returns\r\n   */\r\n  const promptSave = () => {\r\n    const annotations = microscopyService.getAnnotationsForStudy(studyInstanceUID);\r\n\r\n    if (!annotations || saving) {\r\n      return;\r\n    }\r\n\r\n    callInputDialog({\r\n      uiDialogService,\r\n      title: 'Enter description of the Series',\r\n      defaultValue: '',\r\n      onSave: (value: string) => {\r\n        saveFunction(value);\r\n      },\r\n    });\r\n  };\r\n\r\n  const getAllDisplaySets = (studyMetadata: any) => {\r\n    let allDisplaySets = [] as any[];\r\n    studyMetadata.series.forEach((series: any) => {\r\n      const displaySets = displaySetService.getDisplaySetsForSeries(series.SeriesInstanceUID);\r\n      allDisplaySets = allDisplaySets.concat(displaySets);\r\n    });\r\n    return allDisplaySets;\r\n  };\r\n\r\n  /**\r\n   * Save annotations as a series\r\n   *\r\n   * @param SeriesDescription - series description\r\n   * @returns\r\n   */\r\n  const saveFunction = async (SeriesDescription: string) => {\r\n    const dataSource = extensionManager.getActiveDataSource()[0];\r\n    const { onSaveComplete } = props;\r\n    const annotations = microscopyService.getAnnotationsForStudy(studyInstanceUID);\r\n\r\n    saving = true;\r\n\r\n    // There is only one viewer possible for one study,\r\n    // Since once study contains multiple resolution levels (series) of one whole\r\n    // Slide image.\r\n\r\n    const studyMetadata = DicomMetadataStore.getStudy(studyInstanceUID);\r\n    const displaySets = getAllDisplaySets(studyMetadata);\r\n    const smDisplaySet = displaySets.find(ds => ds.Modality === 'SM');\r\n\r\n    // Get the next available series number after 4700.\r\n\r\n    const dsWithMetadata = displaySets.filter(\r\n      ds => ds.metadata && ds.metadata.SeriesNumber && typeof ds.metadata.SeriesNumber === 'number'\r\n    );\r\n\r\n    // Generate next series number\r\n    const seriesNumbers = dsWithMetadata.map(ds => ds.metadata.SeriesNumber);\r\n    const maxSeriesNumber = Math.max(...seriesNumbers, 4700);\r\n    const SeriesNumber = maxSeriesNumber + 1;\r\n\r\n    const { instance: metadata } = smDisplaySet;\r\n\r\n    // construct SR dataset\r\n    const dataset = constructSR(metadata, { SeriesDescription, SeriesNumber }, annotations);\r\n\r\n    // Save in DICOM format\r\n    try {\r\n      if (dataSource) {\r\n        if (dataSource.wadoRoot == 'saveDicom') {\r\n          // download as DICOM file\r\n          const part10Buffer = datasetToBuffer(dataset);\r\n          saveByteArray(part10Buffer, `sr-microscopy.dcm`);\r\n        } else {\r\n          // Save into Web Data source\r\n          const { StudyInstanceUID } = dataset;\r\n          await dataSource.store.dicom(dataset);\r\n          if (StudyInstanceUID) {\r\n            dataSource.deleteStudyMetadataPromise(StudyInstanceUID);\r\n          }\r\n        }\r\n        onSaveComplete({\r\n          title: 'SR Saved',\r\n          message: 'Measurements downloaded successfully',\r\n          type: 'success',\r\n        });\r\n      } else {\r\n        console.error('Server unspecified');\r\n      }\r\n    } catch (error) {\r\n      onSaveComplete({\r\n        title: 'SR Save Failed',\r\n        message: error.message || error.toString(),\r\n        type: 'error',\r\n      });\r\n    } finally {\r\n      saving = false;\r\n    }\r\n  };\r\n\r\n  /**\r\n   * On clicking \"Reject annotations\" button\r\n   */\r\n  const onDeleteCurrentSRHandler = async () => {\r\n    try {\r\n      const activeViewport = props.viewports[props.activeViewportId];\r\n      const { StudyInstanceUID } = activeViewport;\r\n\r\n      // TODO: studies?\r\n      const study = DicomMetadataStore.getStudy(StudyInstanceUID);\r\n\r\n      const lastDerivedDisplaySet = study.derivedDisplaySets.sort((ds1: any, ds2: any) => {\r\n        const dateTime1 = Number(`${ds1.SeriesDate}${ds1.SeriesTime}`);\r\n        const dateTime2 = Number(`${ds2.SeriesDate}${ds2.SeriesTime}`);\r\n        return dateTime1 > dateTime2;\r\n      })[study.derivedDisplaySets.length - 1];\r\n\r\n      // TODO: use dataSource.reject.dicom()\r\n      // await DICOMSR.rejectMeasurements(\r\n      //   study.wadoRoot,\r\n      //   lastDerivedDisplaySet.StudyInstanceUID,\r\n      //   lastDerivedDisplaySet.SeriesInstanceUID\r\n      // );\r\n      props.onRejectComplete({\r\n        title: 'Report rejected',\r\n        message: 'Latest report rejected successfully',\r\n        type: 'success',\r\n      });\r\n    } catch (error) {\r\n      props.onRejectComplete({\r\n        title: 'Failed to reject report',\r\n        message: error.message,\r\n        type: 'error',\r\n      });\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Handler for clicking event of an annotation item.\r\n   *\r\n   * @param param0\r\n   */\r\n  const onMeasurementItemClickHandler = ({ uid }: { uid: string }) => {\r\n    const roiAnnotation = microscopyService.getAnnotation(uid);\r\n    microscopyService.selectAnnotation(roiAnnotation);\r\n    microscopyService.focusAnnotation(roiAnnotation, props.activeViewportId);\r\n  };\r\n\r\n  /**\r\n   * Handler for \"Edit\" action of an annotation item\r\n   * @param param0\r\n   */\r\n  const onMeasurementItemEditHandler = ({ uid, isActive }: { uid: string; isActive: boolean }) => {\r\n    props.commandsManager.runCommand('setLabel', { uid }, 'MICROSCOPY');\r\n  };\r\n\r\n  const onMeasurementDeleteHandler = ({ uid, isActive }: { uid: string; isActive: boolean }) => {\r\n    const roiAnnotation = microscopyService.getAnnotation(uid);\r\n    microscopyService.removeAnnotation(roiAnnotation);\r\n  };\r\n\r\n  // Convert ROI annotations managed by microscopyService into our\r\n  // own format for display\r\n  const data = roiAnnotations.map((roiAnnotation, index) => {\r\n    const label = roiAnnotation.getDetailedLabel();\r\n    const area = roiAnnotation.getArea();\r\n    const length = roiAnnotation.getLength();\r\n    const shortAxisLength = roiAnnotation.roiGraphic.properties.shortAxisLength;\r\n    const isSelected: boolean = selectedAnnotation === roiAnnotation;\r\n\r\n    // other events\r\n    const { uid } = roiAnnotation;\r\n\r\n    // display text\r\n    const displayText = [];\r\n\r\n    if (area !== undefined) {\r\n      displayText.push(formatArea(area));\r\n    } else if (length !== undefined) {\r\n      displayText.push(\r\n        shortAxisLength\r\n          ? `${formatLength(length, 'μm')} x ${formatLength(shortAxisLength, 'μm')}`\r\n          : `${formatLength(length, 'μm')}`\r\n      );\r\n    }\r\n\r\n    // convert to measurementItem format compatible with <MeasurementTable /> component\r\n    return {\r\n      uid,\r\n      index,\r\n      label,\r\n      isActive: isSelected,\r\n      displayText,\r\n      roiAnnotation,\r\n    };\r\n  });\r\n\r\n  return (\r\n    <>\r\n      <div\r\n        className=\"ohif-scrollbar overflow-y-auto overflow-x-hidden\"\r\n        data-cy={'measurements-panel'}\r\n      >\r\n        <div className=\"flex flex-col\">\r\n          {data.map(item => (\r\n            <DataRow\r\n              key={item.uid}\r\n              number={item.index + 1}\r\n              title={item.label}\r\n              isSelected={item.isActive}\r\n              onSelect={() => onMeasurementItemClickHandler({ uid: item.uid })}\r\n              details={{\r\n                primary: item.displayText,\r\n                secondary: [],\r\n              }}\r\n              isVisible={true}\r\n              onToggleVisibility={() => {}}\r\n              isLocked={false}\r\n              onToggleLocked={() => {}}\r\n              onRename={() =>\r\n                onMeasurementItemEditHandler({ uid: item.uid, isActive: item.isActive })\r\n              }\r\n              onDelete={() =>\r\n                onMeasurementDeleteHandler({ uid: item.uid, isActive: item.isActive })\r\n              }\r\n              onColor={() => {}}\r\n              disableEditing={false}\r\n              description={item.displayText.join(', ')}\r\n            />\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n\r\nconst connectedMicroscopyPanel = withTranslation(['MicroscopyTable', 'Common'])(MicroscopyPanel);\r\n\r\nexport default connectedMicroscopyPanel;\r\n","const DCM_CODE_VALUES = {\r\n  IMAGING_MEASUREMENTS: '126010',\r\n  MEASUREMENT_GROUP: '125007',\r\n  IMAGE_REGION: '111030',\r\n  FINDING: '121071',\r\n  TRACKING_UNIQUE_IDENTIFIER: '112039',\r\n  LENGTH: '410668003',\r\n  AREA: '42798000',\r\n  SHORT_AXIS: 'G-A186',\r\n  LONG_AXIS: 'G-A185',\r\n  ELLIPSE_AREA: 'G-D7FE', // TODO: Remove this\r\n  ANNOTATION: '121071',\r\n  ANNOTATION_GROUP: '121072',\r\n  ANNOTATION_LABEL: '121073',\r\n};\r\n\r\nexport default DCM_CODE_VALUES;\r\n","export default function toArray(item) {\r\n  return Array.isArray(item) ? item : [item];\r\n}\r\n","import dcmjs from 'dcmjs';\r\n\r\nimport DCM_CODE_VALUES from './dcmCodeValues';\r\nimport toArray from './toArray';\r\n\r\nconst MeasurementReport = dcmjs.adapters.DICOMMicroscopyViewer.MeasurementReport;\r\n\r\n// Define as async so that it returns a promise, expected by the ViewportGrid\r\nexport default async function loadSR(\r\n  microscopyService,\r\n  microscopySRDisplaySet,\r\n  referencedDisplaySet\r\n) {\r\n  const naturalizedDataset = microscopySRDisplaySet.metadata;\r\n\r\n  const { StudyInstanceUID, FrameOfReferenceUID } = referencedDisplaySet;\r\n\r\n  const managedViewers = microscopyService.getManagedViewersForStudy(StudyInstanceUID);\r\n\r\n  if (!managedViewers || !managedViewers.length) {\r\n    return;\r\n  }\r\n\r\n  microscopySRDisplaySet.isLoaded = true;\r\n\r\n  const { rois, labels } = await _getROIsFromToolState(microscopyService, naturalizedDataset, FrameOfReferenceUID);\r\n\r\n  const managedViewer = managedViewers[0];\r\n\r\n  for (let i = 0; i < rois.length; i++) {\r\n    // NOTE: When saving Microscopy SR, we are attaching identifier property\r\n    // to each ROI, and when read for display, it is coming in as \"TEXT\"\r\n    // evaluation.\r\n    // As the Dicom Microscopy Viewer will override styles for \"Text\" evaluations\r\n    // to hide all other geometries, we are going to manually remove that\r\n    // evaluation item.\r\n    const roi = rois[i];\r\n    const roiSymbols = Object.getOwnPropertySymbols(roi);\r\n    const _properties = roiSymbols.find(s => s.description === 'properties');\r\n    const properties = roi[_properties];\r\n    properties['evaluations'] = [];\r\n\r\n    managedViewer.addRoiGraphicWithLabel(roi, labels[i]);\r\n  }\r\n}\r\n\r\nasync function _getROIsFromToolState(microscopyService, naturalizedDataset, FrameOfReferenceUID) {\r\n  const toolState = MeasurementReport.generateToolState(naturalizedDataset);\r\n  const tools = Object.getOwnPropertyNames(toolState);\r\n  // Does a dynamic import to prevent webpack from rebuilding the library\r\n  const DICOMMicroscopyViewer = await microscopyService.importDicomMicroscopyViewer();\r\n\r\n  const measurementGroupContentItems = _getMeasurementGroups(naturalizedDataset);\r\n\r\n  const rois = [];\r\n  const labels = [];\r\n\r\n  tools.forEach(t => {\r\n    const toolSpecificToolState = toolState[t];\r\n    let scoord3d;\r\n\r\n    const capsToolType = t.toUpperCase();\r\n\r\n    const measurementGroupContentItemsForTool = measurementGroupContentItems.filter(mg => {\r\n      const imageRegionContentItem = toArray(mg.ContentSequence).find(\r\n        ci => ci.ConceptNameCodeSequence.CodeValue === DCM_CODE_VALUES.IMAGE_REGION\r\n      );\r\n\r\n      return imageRegionContentItem.GraphicType === capsToolType;\r\n    });\r\n\r\n    toolSpecificToolState.forEach((coordinates, index) => {\r\n      const properties = {};\r\n\r\n      const options = {\r\n        coordinates,\r\n        frameOfReferenceUID: FrameOfReferenceUID,\r\n      };\r\n\r\n      if (t === 'Polygon') {\r\n        scoord3d = new DICOMMicroscopyViewer.scoord3d.Polygon(options);\r\n      } else if (t === 'Polyline') {\r\n        scoord3d = new DICOMMicroscopyViewer.scoord3d.Polyline(options);\r\n      } else if (t === 'Point') {\r\n        scoord3d = new DICOMMicroscopyViewer.scoord3d.Point(options);\r\n      } else if (t === 'Ellipse') {\r\n        scoord3d = new DICOMMicroscopyViewer.scoord3d.Ellipse(options);\r\n      } else {\r\n        throw new Error('Unsupported tool type');\r\n      }\r\n\r\n      const measurementGroup = measurementGroupContentItemsForTool[index];\r\n      const findingGroup = toArray(measurementGroup.ContentSequence).find(\r\n        ci => ci.ConceptNameCodeSequence.CodeValue === DCM_CODE_VALUES.FINDING\r\n      );\r\n\r\n      const trackingGroup = toArray(measurementGroup.ContentSequence).find(\r\n        ci => ci.ConceptNameCodeSequence.CodeValue === DCM_CODE_VALUES.TRACKING_UNIQUE_IDENTIFIER\r\n      );\r\n\r\n      /**\r\n       * Extract presentation state from tracking identifier.\r\n       * Currently is stored in SR but should be stored in its tags.\r\n       */\r\n      if (trackingGroup) {\r\n        const regExp = /\\(([^)]+)\\)/;\r\n        const matches = regExp.exec(trackingGroup.TextValue);\r\n        if (matches && matches[1]) {\r\n          properties.presentationState = JSON.parse(matches[1]);\r\n          properties.marker = properties.presentationState.marker;\r\n        }\r\n      }\r\n\r\n      let measurements = toArray(measurementGroup.ContentSequence).filter(ci =>\r\n        [\r\n          DCM_CODE_VALUES.LENGTH,\r\n          DCM_CODE_VALUES.AREA,\r\n          DCM_CODE_VALUES.SHORT_AXIS,\r\n          DCM_CODE_VALUES.LONG_AXIS,\r\n          DCM_CODE_VALUES.ELLIPSE_AREA,\r\n        ].includes(ci.ConceptNameCodeSequence.CodeValue)\r\n      );\r\n\r\n      let evaluations = toArray(measurementGroup.ContentSequence).filter(ci =>\r\n        [DCM_CODE_VALUES.TRACKING_UNIQUE_IDENTIFIER].includes(ci.ConceptNameCodeSequence.CodeValue)\r\n      );\r\n\r\n      /**\r\n       * TODO: Resolve bug in DCMJS.\r\n       * ConceptNameCodeSequence should be a sequence with only one item.\r\n       */\r\n      evaluations = evaluations.map(evaluation => {\r\n        const e = { ...evaluation };\r\n        e.ConceptNameCodeSequence = toArray(e.ConceptNameCodeSequence);\r\n        return e;\r\n      });\r\n\r\n      /**\r\n       * TODO: Resolve bug in DCMJS.\r\n       * ConceptNameCodeSequence should be a sequence with only one item.\r\n       */\r\n      measurements = measurements.map(measurement => {\r\n        const m = { ...measurement };\r\n        m.ConceptNameCodeSequence = toArray(m.ConceptNameCodeSequence);\r\n        return m;\r\n      });\r\n\r\n      if (measurements && measurements.length) {\r\n        properties.measurements = measurements;\r\n        console.log('[SR] retrieving measurements...', measurements);\r\n      }\r\n\r\n      if (evaluations && evaluations.length) {\r\n        properties.evaluations = evaluations;\r\n        console.log('[SR] retrieving evaluations...', evaluations);\r\n      }\r\n\r\n      const roi = new DICOMMicroscopyViewer.roi.ROI({ scoord3d, properties });\r\n      rois.push(roi);\r\n\r\n      if (findingGroup) {\r\n        labels.push(findingGroup.ConceptCodeSequence.CodeValue);\r\n      } else {\r\n        labels.push('');\r\n      }\r\n    });\r\n  });\r\n\r\n  return { rois, labels };\r\n}\r\n\r\nfunction _getMeasurementGroups(naturalizedDataset) {\r\n  const { ContentSequence } = naturalizedDataset;\r\n\r\n  const imagingMeasurementsContentItem = ContentSequence.find(\r\n    ci => ci.ConceptNameCodeSequence.CodeValue === DCM_CODE_VALUES.IMAGING_MEASUREMENTS\r\n  );\r\n\r\n  const measurementGroupContentItems = toArray(\r\n    imagingMeasurementsContentItem.ContentSequence\r\n  ).filter(ci => ci.ConceptNameCodeSequence.CodeValue === DCM_CODE_VALUES.MEASUREMENT_GROUP);\r\n\r\n  return measurementGroupContentItems;\r\n}\r\n","/**\r\n * Get referenced SM displaySet from SR displaySet\r\n *\r\n * @param {*} allDisplaySets\r\n * @param {*} microscopySRDisplaySet\r\n * @returns\r\n */\r\nexport default function getSourceDisplaySet(allDisplaySets, microscopySRDisplaySet) {\r\n  const { ReferencedFrameOfReferenceUID, metadata } = microscopySRDisplaySet;\r\n\r\n  if (metadata.ReferencedSeriesSequence) {\r\n    const { ReferencedSeriesSequence } = metadata;\r\n    const referencedSeries = ReferencedSeriesSequence[0];\r\n    const { SeriesInstanceUID } = referencedSeries;\r\n    const displaySets = allDisplaySets.filter(ds => ds.SeriesInstanceUID === SeriesInstanceUID);\r\n    return displaySets[0];\r\n  }\r\n\r\n  const otherDisplaySets = allDisplaySets.filter(\r\n    ds => ds.displaySetInstanceUID !== microscopySRDisplaySet.displaySetInstanceUID\r\n  );\r\n  const referencedDisplaySet = otherDisplaySets.find(\r\n    displaySet =>\r\n      displaySet.Modality === 'SM' &&\r\n      (displaySet.FrameOfReferenceUID === ReferencedFrameOfReferenceUID ||\r\n        // sometimes each depth instance has the different FrameOfReferenceID\r\n        displaySet.othersFrameOfReferenceUID.includes(ReferencedFrameOfReferenceUID))\r\n  );\r\n\r\n  if (!referencedDisplaySet && otherDisplaySets.length >= 1) {\r\n    console.warn(\r\n      'No display set with FrameOfReferenceUID',\r\n      ReferencedFrameOfReferenceUID,\r\n      'single series, assuming data error, defaulting to only series.'\r\n    );\r\n    return otherDisplaySets.find(displaySet => displaySet.Modality === 'SM');\r\n  }\r\n\r\n  return referencedDisplaySet;\r\n}\r\n","import OHIF, { DicomMetadataStore } from '@ohif/core';\r\nimport loadSR from './utils/loadSR';\r\nimport toArray from './utils/toArray';\r\nimport DCM_CODE_VALUES from './utils/dcmCodeValues';\r\nimport getSourceDisplaySet from './utils/getSourceDisplaySet';\r\n\r\nconst { utils } = OHIF;\r\n\r\nconst SOP_CLASS_UIDS = {\r\n  COMPREHENSIVE_3D_SR: '1.2.840.10008.5.1.4.1.1.88.34',\r\n};\r\n\r\nconst SOPClassHandlerId =\r\n  '@ohif/extension-dicom-microscopy.sopClassHandlerModule.DicomMicroscopySRSopClassHandler';\r\n\r\nfunction _getReferencedFrameOfReferenceUID(naturalizedDataset) {\r\n  const { ContentSequence } = naturalizedDataset;\r\n\r\n  const imagingMeasurementsContentItem = ContentSequence.find(\r\n    ci => ci.ConceptNameCodeSequence.CodeValue === DCM_CODE_VALUES.IMAGING_MEASUREMENTS\r\n  );\r\n\r\n  const firstMeasurementGroupContentItem = toArray(\r\n    imagingMeasurementsContentItem.ContentSequence\r\n  ).find(ci => ci.ConceptNameCodeSequence.CodeValue === DCM_CODE_VALUES.MEASUREMENT_GROUP);\r\n\r\n  const imageRegionContentItem = toArray(firstMeasurementGroupContentItem.ContentSequence).find(\r\n    ci => ci.ConceptNameCodeSequence.CodeValue === DCM_CODE_VALUES.IMAGE_REGION\r\n  );\r\n\r\n  return imageRegionContentItem.ReferencedFrameOfReferenceUID;\r\n}\r\n\r\nfunction _getDisplaySetsFromSeries(instances, servicesManager, extensionManager) {\r\n  // If the series has no instances, stop here\r\n  if (!instances || !instances.length) {\r\n    throw new Error('No instances were provided');\r\n  }\r\n\r\n  const { displaySetService, microscopyService } = servicesManager.services;\r\n\r\n  const instance = instances[0];\r\n\r\n  // TODO ! Consumption of DICOMMicroscopySRSOPClassHandler to a derived dataset or normal dataset?\r\n  // TODO -> Easy to swap this to a \"non-derived\" displaySet, but unfortunately need to put it in a different extension.\r\n  const naturalizedDataset = DicomMetadataStore.getSeries(\r\n    instance.StudyInstanceUID,\r\n    instance.SeriesInstanceUID\r\n  ).instances[0];\r\n  const ReferencedFrameOfReferenceUID = _getReferencedFrameOfReferenceUID(naturalizedDataset);\r\n\r\n  const {\r\n    FrameOfReferenceUID,\r\n    SeriesDescription,\r\n    ContentDate,\r\n    ContentTime,\r\n    SeriesNumber,\r\n    StudyInstanceUID,\r\n    SeriesInstanceUID,\r\n    SOPInstanceUID,\r\n    SOPClassUID,\r\n  } = instance;\r\n\r\n  const displaySet = {\r\n    isOverlayDisplaySet: true,\r\n    plugin: 'microscopy',\r\n    Modality: 'SR',\r\n    altImageText: 'Microscopy SR',\r\n    displaySetInstanceUID: utils.guid(),\r\n    SOPInstanceUID,\r\n    SeriesInstanceUID,\r\n    StudyInstanceUID,\r\n    ReferencedFrameOfReferenceUID,\r\n    SOPClassHandlerId,\r\n    SOPClassUID,\r\n    SeriesDescription,\r\n    // Map the content date/time to the series date/time, these are only used for filtering.\r\n    SeriesDate: ContentDate,\r\n    SeriesTime: ContentTime,\r\n    SeriesNumber,\r\n    instance,\r\n    metadata: naturalizedDataset,\r\n    isDerived: true,\r\n    isLoading: false,\r\n    isLoaded: false,\r\n    loadError: false,\r\n  };\r\n\r\n  displaySet.load = function (referencedDisplaySet) {\r\n    return loadSR(microscopyService, displaySet, referencedDisplaySet).catch(error => {\r\n      displaySet.isLoaded = false;\r\n      displaySet.loadError = true;\r\n      throw new Error(error);\r\n    });\r\n  };\r\n\r\n  displaySet.getSourceDisplaySet = function () {\r\n    let allDisplaySets = [];\r\n    const studyMetadata = DicomMetadataStore.getStudy(StudyInstanceUID);\r\n    studyMetadata.series.forEach(series => {\r\n      const displaySets = displaySetService.getDisplaySetsForSeries(series.SeriesInstanceUID);\r\n      allDisplaySets = allDisplaySets.concat(displaySets);\r\n    });\r\n    return getSourceDisplaySet(allDisplaySets, displaySet);\r\n  };\r\n\r\n  return [displaySet];\r\n}\r\n\r\nexport default function getDicomMicroscopySRSopClassHandler({ servicesManager, extensionManager }) {\r\n  const getDisplaySetsFromSeries = instances => {\r\n    return _getDisplaySetsFromSeries(instances, servicesManager, extensionManager);\r\n  };\r\n\r\n  return {\r\n    name: 'DicomMicroscopySRSopClassHandler',\r\n    sopClassUids: [SOP_CLASS_UIDS.COMPREHENSIVE_3D_SR],\r\n    getDisplaySetsFromSeries,\r\n  };\r\n}\r\n","import OHIF, { DicomMetadataStore } from '@ohif/core';\r\nimport loadAnnotation from './utils/loadAnnotation';\r\nimport getSourceDisplaySet from './utils/getSourceDisplaySet';\r\n\r\nconst { utils } = OHIF;\r\n\r\nconst SOP_CLASS_UIDS = {\r\n  MICROSCOPY_BULK_SIMPLE_ANNOTATION: '1.2.840.10008.5.1.4.1.1.91.1',\r\n};\r\n\r\nconst SOPClassHandlerId =\r\n  '@ohif/extension-dicom-microscopy.sopClassHandlerModule.DicomMicroscopyANNSopClassHandler';\r\n\r\nfunction _getDisplaySetsFromSeries(instances, servicesManager, extensionManager) {\r\n  // If the series has no instances, stop here\r\n  if (!instances || !instances.length) {\r\n    throw new Error('No instances were provided');\r\n  }\r\n\r\n  const { displaySetService, microscopyService } = servicesManager.services;\r\n\r\n  // Sort instances by date/time in ascending order (oldest first)\r\n  const sortedInstances = [...instances].sort((a, b) => {\r\n    const dateA = `${a.ContentDate}${a.ContentTime}`;\r\n    const dateB = `${b.ContentDate}${b.ContentTime}`;\r\n    return dateA.localeCompare(dateB);\r\n  });\r\n\r\n  // Get the most recent instance (last in the sorted array)\r\n  const instance = sortedInstances[sortedInstances.length - 1];\r\n\r\n  const naturalizedDataset = DicomMetadataStore.getSeries(\r\n    instance.StudyInstanceUID,\r\n    instance.SeriesInstanceUID\r\n  ).instances[0];\r\n\r\n  const {\r\n    SeriesDescription,\r\n    ContentDate,\r\n    ContentTime,\r\n    SeriesNumber,\r\n    StudyInstanceUID,\r\n    SeriesInstanceUID,\r\n    SOPInstanceUID,\r\n    SOPClassUID,\r\n  } = instance;\r\n\r\n  const displaySet = {\r\n    isOverlayDisplaySet: true,\r\n    plugin: 'microscopy',\r\n    Modality: 'ANN',\r\n    thumbnailSrc: null,\r\n    altImageText: 'Microscopy Annotation',\r\n    displaySetInstanceUID: utils.uuidv4(),\r\n    SOPInstanceUID,\r\n    SeriesInstanceUID,\r\n    StudyInstanceUID,\r\n    SOPClassHandlerId,\r\n    SOPClassUID,\r\n    SeriesDescription,\r\n    // Map the content date/time to the series date/time, these are only used for filtering.\r\n    SeriesDate: ContentDate,\r\n    SeriesTime: ContentTime,\r\n    SeriesNumber,\r\n    instance,\r\n    metadata: naturalizedDataset,\r\n    isDerived: true,\r\n    isLoading: false,\r\n    isLoaded: false,\r\n    loadError: false,\r\n  };\r\n\r\n  displaySet.load = function () {\r\n    return loadAnnotation({\r\n      microscopyService,\r\n      displaySet,\r\n      extensionManager,\r\n      servicesManager,\r\n    }).catch(error => {\r\n      displaySet.isLoaded = false;\r\n      displaySet.loadError = true;\r\n      throw new Error(error);\r\n    });\r\n  };\r\n\r\n  displaySet.getSourceDisplaySet = function () {\r\n    let allDisplaySets = [];\r\n    const studyMetadata = DicomMetadataStore.getStudy(StudyInstanceUID);\r\n    studyMetadata.series.forEach(series => {\r\n      const displaySets = displaySetService.getDisplaySetsForSeries(series.SeriesInstanceUID);\r\n      allDisplaySets = allDisplaySets.concat(displaySets);\r\n    });\r\n    const ds = getSourceDisplaySet(allDisplaySets, displaySet);\r\n    return ds;\r\n  };\r\n\r\n  return [displaySet];\r\n}\r\n\r\nexport default function getDicomMicroscopyANNSopClassHandler({\r\n  servicesManager,\r\n  extensionManager,\r\n}) {\r\n  const getDisplaySetsFromSeries = instances => {\r\n    return _getDisplaySetsFromSeries(instances, servicesManager, extensionManager);\r\n  };\r\n\r\n  return {\r\n    name: 'DicomMicroscopyANNSopClassHandler',\r\n    sopClassUids: [SOP_CLASS_UIDS.MICROSCOPY_BULK_SIMPLE_ANNOTATION],\r\n    getDisplaySetsFromSeries,\r\n  };\r\n}\r\n","import getDicomWebClient from './dicomWebClient';\r\n\r\n/**\r\n * Loads and displays DICOM Microscopy Bulk Simple Annotations.\r\n *\r\n * This utility function:\r\n * 1. Retrieves series metadata from a DICOMweb server using study and series instance UIDs\r\n * 2. Converts metadata into MicroscopyBulkSimpleAnnotations objects\r\n * 3. Adds annotations to the viewer in groups (identified by AnnotationGroupUID)\r\n * 4. Applies a consistent yellow color ([255, 234, 0]) to all annotation groups\r\n * 5. Makes the annotation groups visible in the viewer\r\n *\r\n * @param {Object} params - The parameters object\r\n * @param {Object} params.microscopyService - Service for handling microscopy operations\r\n * @param {Object} params.displaySet - The display set containing metadata\r\n * @param {Object} params.extensionManager - Manager for extensions\r\n * @param {Object} params.servicesManager - Manager for services\r\n * @returns {Promise} A promise that resolves with the loaded display set\r\n */\r\nexport default function loadAnnotation({\r\n  microscopyService,\r\n  displaySet,\r\n  extensionManager,\r\n  servicesManager,\r\n}) {\r\n  const { uiNotificationService } = servicesManager.services;\r\n  return new Promise(async (resolve, reject) => {\r\n    try {\r\n      displaySet.isLoading = true;\r\n      const { metadata } = displaySet;\r\n\r\n      const dicomMicroscopyModule = await microscopyService.importDicomMicroscopyViewer();\r\n\r\n      const client = getDicomWebClient({\r\n        extensionManager,\r\n        servicesManager,\r\n      });\r\n\r\n      const viewportId = servicesManager.services.viewportGridService.getActiveViewportId();\r\n      const managedViewers = microscopyService.getManagedViewersForViewport(viewportId);\r\n      const managedViewer = managedViewers[0];\r\n\r\n      client\r\n        .retrieveSeriesMetadata({\r\n          studyInstanceUID: metadata.StudyInstanceUID,\r\n          seriesInstanceUID: metadata.SeriesInstanceUID,\r\n        })\r\n        .then(async retrievedMetadata => {\r\n          const annotations = retrievedMetadata.map(\r\n            metadata =>\r\n              new dicomMicroscopyModule.metadata.MicroscopyBulkSimpleAnnotations({ metadata })\r\n          );\r\n\r\n          uiNotificationService.show({\r\n            message: 'Loading annotations...',\r\n            type: 'info',\r\n          });\r\n\r\n          await Promise.all(\r\n            annotations.map(async ann => {\r\n              try {\r\n                await managedViewer.viewer.addAnnotationGroups(ann);\r\n\r\n                ann.AnnotationGroupSequence.forEach(item => {\r\n                  const annotationGroupUID = item.AnnotationGroupUID;\r\n                  managedViewer.viewer.setAnnotationGroupStyle(annotationGroupUID, {\r\n                    color: [255, 234, 0],\r\n                  });\r\n                });\r\n\r\n                ann.AnnotationGroupSequence.forEach(item => {\r\n                  const annotationGroupUID = item.AnnotationGroupUID;\r\n                  managedViewer.viewer.showAnnotationGroup(annotationGroupUID);\r\n                });\r\n              } catch (error) {\r\n                console.error('failed to add annotation groups:', error);\r\n                uiNotificationService.show({\r\n                  title: 'Error loading annotations',\r\n                  message: error.message,\r\n                  type: 'error',\r\n                });\r\n              }\r\n            })\r\n          );\r\n\r\n          displaySet.isLoaded = true;\r\n          displaySet.isLoading = false;\r\n          resolve(displaySet);\r\n        });\r\n    } catch (error) {\r\n      console.error('Error loading annotation:', error);\r\n      reject(error);\r\n    }\r\n  });\r\n}\r\n","import { id } from './id';\r\nimport React, { Suspense, useMemo } from 'react';\r\nimport getPanelModule from './getPanelModule';\r\nimport getCommandsModule from './getCommandsModule';\r\nimport getCustomizationModule from './getCustomizationModule';\r\nimport { Types } from '@ohif/core';\r\n\r\nimport { useViewportGrid } from '@ohif/ui-next';\r\nimport getDicomMicroscopySRSopClassHandler from './DicomMicroscopySRSopClassHandler';\r\nimport getDicomMicroscopyANNSopClassHandler from './DicomMicroscopyANNSopClassHandler';\r\nimport MicroscopyService from './services/MicroscopyService';\r\nimport { useResizeDetector } from 'react-resize-detector';\r\nimport debounce from 'lodash.debounce';\r\n\r\nconst Component = React.lazy(() => {\r\n  return import('./DicomMicroscopyViewport');\r\n});\r\n\r\nconst MicroscopyViewport = props => {\r\n  return (\r\n    <Suspense fallback={<div>Loading...</div>}>\r\n      <Component {...props} />\r\n    </Suspense>\r\n  );\r\n};\r\n\r\n/**\r\n * You can remove any of the following modules if you don't need them.\r\n */\r\nconst extension: Types.Extensions.Extension = {\r\n  /**\r\n   * Only required property. Should be a unique value across all extensions.\r\n   * You ID can be anything you want, but it should be unique.\r\n   */\r\n  id,\r\n\r\n  async preRegistration({ servicesManager }) {\r\n    servicesManager.registerService(MicroscopyService.REGISTRATION(servicesManager));\r\n  },\r\n\r\n  /**\r\n   * ViewportModule should provide a list of viewports that will be available in OHIF\r\n   * for Modes to consume and use in the viewports. Each viewport is defined by\r\n   * {name, component} object. Example of a viewport module is the CornerstoneViewport\r\n   * that is provided by the Cornerstone extension in OHIF.\r\n   */\r\n  getViewportModule({ servicesManager }) {\r\n    /**\r\n     *\r\n     * @param props {*}\r\n     * @param props.displaySets\r\n     * @param props.viewportId\r\n     * @param props.viewportLabel\r\n     * @param props.dataSource\r\n     * @param props.viewportOptions\r\n     * @param props.displaySetOptions\r\n     * @returns\r\n     */\r\n    const ExtendedMicroscopyViewport = props => {\r\n      const { viewportOptions } = props;\r\n\r\n      const [viewportGrid, viewportGridService] = useViewportGrid();\r\n      const { activeViewportId } = viewportGrid;\r\n\r\n      const displaySetsKey = useMemo(() => {\r\n        return props.displaySets.map(ds => ds.displaySetInstanceUID).join('-');\r\n      }, [props.displaySets]);\r\n\r\n      const onResize = debounce(() => {\r\n        const { microscopyService } = servicesManager.services;\r\n        const managedViewer = microscopyService.getAllManagedViewers();\r\n\r\n        if (managedViewer && managedViewer.length > 0) {\r\n          managedViewer[0].viewer.resize();\r\n        }\r\n      }, 100);\r\n\r\n      const { ref: resizeRef } = useResizeDetector({\r\n        onResize,\r\n        handleHeight: true,\r\n        handleWidth: true,\r\n      });\r\n\r\n      return (\r\n        <MicroscopyViewport\r\n          key={displaySetsKey}\r\n          activeViewportId={activeViewportId}\r\n          setViewportActive={(viewportId: string) => {\r\n            viewportGridService.setActiveViewportId(viewportId);\r\n          }}\r\n          viewportData={viewportOptions}\r\n          resizeRef={resizeRef}\r\n          {...props}\r\n        />\r\n      );\r\n    };\r\n\r\n    return [\r\n      {\r\n        name: 'microscopy-dicom',\r\n        component: ExtendedMicroscopyViewport,\r\n      },\r\n    ];\r\n  },\r\n\r\n  getToolbarModule({ servicesManager }) {\r\n    return [\r\n      {\r\n        name: 'evaluate.microscopyTool',\r\n        evaluate: ({ button }) => {\r\n          const { microscopyService } = servicesManager.services;\r\n\r\n          const activeInteractions = microscopyService.getActiveInteractions();\r\n          if (!activeInteractions) {\r\n            return false;\r\n          }\r\n          const isPrimaryActive = activeInteractions.find(interactions => {\r\n            const sameMouseButton = interactions[1].bindings.mouseButtons.includes('left');\r\n\r\n            if (!sameMouseButton) {\r\n              return false;\r\n            }\r\n\r\n            const notDraw = interactions[0] !== 'draw';\r\n\r\n            // there seems to be a custom logic for draw tool for some reason\r\n            return notDraw\r\n              ? interactions[0] === button.id\r\n              : interactions[1].geometryType === button.id;\r\n          });\r\n\r\n          return {\r\n            disabled: false,\r\n            className: isPrimaryActive\r\n              ? '!text-black bg-primary-light'\r\n              : '!text-common-bright hover:!bg-[rgb(var(--primary-dark))] hover:!text-primary-light',\r\n            // Todo: isActive right now is used for nested buttons where the primary\r\n            // button needs to be fully rounded (vs partial rounded) when active\r\n            // otherwise it does not have any other use\r\n            isActive: isPrimaryActive,\r\n          };\r\n        },\r\n      },\r\n    ];\r\n  },\r\n\r\n  /**\r\n   * SopClassHandlerModule should provide a list of sop class handlers that will be\r\n   * available in OHIF for Modes to consume and use to create displaySets from Series.\r\n   * Each sop class handler is defined by a { name, sopClassUids, getDisplaySetsFromSeries}.\r\n   * Examples include the default sop class handler provided by the default extension\r\n   */\r\n  getSopClassHandlerModule(params) {\r\n    return [\r\n      getDicomMicroscopySRSopClassHandler(params),\r\n      getDicomMicroscopyANNSopClassHandler(params),\r\n    ];\r\n  },\r\n\r\n  getPanelModule,\r\n\r\n  getCommandsModule,\r\n\r\n  getCustomizationModule,\r\n};\r\n\r\nexport default extension;\r\n","import React from 'react';\r\nimport type { Types } from '@ohif/core';\r\nimport { useViewportGrid } from '@ohif/ui-next';\r\nimport MicroscopyPanel from './components/MicroscopyPanel/MicroscopyPanel';\r\n\r\n// TODO:\r\n// - No loading UI exists yet\r\n// - cancel promises when component is destroyed\r\n// - show errors in UI for thumbnails if promise fails\r\n\r\nexport default function getPanelModule({\r\n  commandsManager,\r\n  extensionManager,\r\n  servicesManager,\r\n}: Types.Extensions.ExtensionParams) {\r\n  const wrappedMeasurementPanel = ({}) => {\r\n    const [{ activeViewportId, viewports }] = useViewportGrid();\r\n\r\n    return (\r\n      <MicroscopyPanel\r\n        viewports={viewports}\r\n        activeViewportId={activeViewportId}\r\n        onSaveComplete={() => {}}\r\n        onRejectComplete={() => {}}\r\n        commandsManager={commandsManager}\r\n        servicesManager={servicesManager}\r\n        extensionManager={extensionManager}\r\n      />\r\n    );\r\n  };\r\n\r\n  return [\r\n    {\r\n      name: 'measure',\r\n      iconName: 'tab-linear',\r\n      iconLabel: 'Measure',\r\n      label: 'Measurements',\r\n      secondaryLabel: 'Measurements',\r\n      component: wrappedMeasurementPanel,\r\n    },\r\n  ];\r\n}\r\n","import { CommandsManager, ExtensionManager } from '@ohif/core';\r\nimport { callInputDialog } from '@ohif/extension-default';\r\nimport styles from './utils/styles';\r\n\r\nexport default function getCommandsModule({\r\n  servicesManager,\r\n  commandsManager,\r\n  extensionManager,\r\n}: {\r\n  servicesManager: AppTypes.ServicesManager;\r\n  commandsManager: CommandsManager;\r\n  extensionManager: ExtensionManager;\r\n}) {\r\n  const { viewportGridService, uiDialogService, microscopyService } = servicesManager.services;\r\n\r\n  const actions = {\r\n    // Measurement tool commands:\r\n    deleteMeasurement: ({ uid }) => {\r\n      if (uid) {\r\n        const roiAnnotation = microscopyService.getAnnotation(uid);\r\n        if (roiAnnotation) {\r\n          microscopyService.removeAnnotation(roiAnnotation);\r\n        }\r\n      }\r\n    },\r\n\r\n    setLabel: ({ uid }) => {\r\n      const roiAnnotation = microscopyService.getAnnotation(uid);\r\n      callInputDialog({\r\n        uiDialogService,\r\n        defaultValue: '',\r\n        onSave: (value: string) => {\r\n          roiAnnotation.setLabel(value);\r\n          microscopyService.triggerRelabel(roiAnnotation);\r\n        },\r\n      });\r\n    },\r\n\r\n    setToolActive: ({ toolName, toolGroupId = 'MICROSCOPY' }) => {\r\n      const dragPanOnMiddle = [\r\n        'dragPan',\r\n        {\r\n          bindings: {\r\n            mouseButtons: ['middle'],\r\n          },\r\n        },\r\n      ];\r\n      const dragZoomOnRight = [\r\n        'dragZoom',\r\n        {\r\n          bindings: {\r\n            mouseButtons: ['right'],\r\n          },\r\n        },\r\n      ];\r\n      if (\r\n        ['line', 'box', 'circle', 'point', 'polygon', 'freehandpolygon', 'freehandline'].indexOf(\r\n          toolName\r\n        ) >= 0\r\n      ) {\r\n        // TODO: read from configuration\r\n        const options = {\r\n          geometryType: toolName,\r\n          vertexEnabled: true,\r\n          styleOptions: styles.default,\r\n          bindings: {\r\n            mouseButtons: ['left'],\r\n          },\r\n        } as any;\r\n        if ('line' === toolName) {\r\n          options.minPoints = 2;\r\n          options.maxPoints = 2;\r\n        } else if ('point' === toolName) {\r\n          delete options.styleOptions;\r\n          delete options.vertexEnabled;\r\n        }\r\n\r\n        microscopyService.activateInteractions([\r\n          ['draw', options],\r\n          dragPanOnMiddle,\r\n          dragZoomOnRight,\r\n        ]);\r\n      } else if (toolName == 'dragPan') {\r\n        microscopyService.activateInteractions([\r\n          [\r\n            'dragPan',\r\n            {\r\n              bindings: {\r\n                mouseButtons: ['left', 'middle'],\r\n              },\r\n            },\r\n          ],\r\n          dragZoomOnRight,\r\n        ]);\r\n      } else {\r\n        microscopyService.activateInteractions([\r\n          [\r\n            toolName,\r\n            {\r\n              bindings: {\r\n                mouseButtons: ['left'],\r\n              },\r\n            },\r\n          ],\r\n          dragPanOnMiddle,\r\n          dragZoomOnRight,\r\n        ]);\r\n      }\r\n    },\r\n    toggleOverlays: () => {\r\n      // overlay\r\n      const overlays = document.getElementsByClassName('microscopy-viewport-overlay');\r\n      let onoff = false; // true if this will toggle on\r\n      for (let i = 0; i < overlays.length; i++) {\r\n        if (i === 0) {\r\n          onoff = overlays.item(0).classList.contains('hidden');\r\n        }\r\n        overlays.item(i).classList.toggle('hidden');\r\n      }\r\n\r\n      // overview\r\n      const { activeViewportId } = viewportGridService.getState();\r\n      microscopyService.toggleOverviewMap(activeViewportId);\r\n    },\r\n    toggleAnnotations: () => {\r\n      microscopyService.toggleROIsVisibility();\r\n    },\r\n  };\r\n\r\n  const definitions = {\r\n    deleteMeasurement: {\r\n      commandFn: actions.deleteMeasurement,\r\n    },\r\n    setLabel: {\r\n      commandFn: actions.setLabel,\r\n    },\r\n    setToolActive: {\r\n      commandFn: actions.setToolActive,\r\n    },\r\n    toggleOverlays: {\r\n      commandFn: actions.toggleOverlays,\r\n    },\r\n    toggleAnnotations: {\r\n      commandFn: actions.toggleAnnotations,\r\n    },\r\n  };\r\n\r\n  return {\r\n    actions,\r\n    definitions,\r\n    defaultContext: 'MICROSCOPY',\r\n  };\r\n}\r\n","export default function getCustomizationModule() {\r\n  return [];\r\n}\r\n","import { errorHandler, DicomMetadataStore } from '@ohif/core';\r\nimport { StaticWadoClient } from '@ohif/extension-default';\r\n\r\n/**\r\n * create a DICOMwebClient object to be used by Dicom Microscopy Viewer\r\n *\r\n * Referenced the code from `/extensions/default/src/DicomWebDataSource/index.js`\r\n *\r\n * @param param0\r\n * @returns\r\n */\r\nexport default function getDicomWebClient({ extensionManager, servicesManager }: withAppTypes) {\r\n  const dataSourceConfig = window.config.dataSources.find(\r\n    ds => ds.sourceName === extensionManager.activeDataSourceName\r\n  );\r\n  const { userAuthenticationService } = servicesManager.services;\r\n\r\n  const { wadoRoot, staticWado, singlepart } = dataSourceConfig.configuration;\r\n\r\n  const wadoConfig = {\r\n    url: wadoRoot || '/dicomlocal',\r\n    staticWado,\r\n    singlepart,\r\n    headers: userAuthenticationService.getAuthorizationHeader(),\r\n    errorInterceptor: errorHandler.getHTTPErrorHandler(),\r\n  };\r\n\r\n  const client = new StaticWadoClient(wadoConfig);\r\n  client.wadoURL = wadoConfig.url;\r\n\r\n  if (extensionManager.activeDataSourceName === 'dicomlocal') {\r\n    /**\r\n     * For local data source, override the retrieveInstanceFrames() method of the\r\n     * dicomweb-client to retrieve image data from memory cached metadata.\r\n     * Other methods of the client doesn't matter, as we are feeding the DMV\r\n     * with the series metadata already.\r\n     *\r\n     * @param {Object} options\r\n     * @param {String} options.studyInstanceUID - Study Instance UID\r\n     * @param {String} options.seriesInstanceUID - Series Instance UID\r\n     * @param {String} options.sopInstanceUID - SOP Instance UID\r\n     * @param {String} options.frameNumbers - One-based indices of Frame Items\r\n     * @param {Object} [options.queryParams] - HTTP query parameters\r\n     * @returns {ArrayBuffer[]} Rendered Frame Items as byte arrays\r\n     */\r\n    //\r\n    client.retrieveInstanceFrames = async options => {\r\n      if (!('studyInstanceUID' in options)) {\r\n        throw new Error('Study Instance UID is required for retrieval of instance frames');\r\n      }\r\n      if (!('seriesInstanceUID' in options)) {\r\n        throw new Error('Series Instance UID is required for retrieval of instance frames');\r\n      }\r\n      if (!('sopInstanceUID' in options)) {\r\n        throw new Error('SOP Instance UID is required for retrieval of instance frames');\r\n      }\r\n      if (!('frameNumbers' in options)) {\r\n        throw new Error('frame numbers are required for retrieval of instance frames');\r\n      }\r\n      console.log(\r\n        `retrieve frames ${options.frameNumbers.toString()} of instance ${options.sopInstanceUID}`\r\n      );\r\n\r\n      const instance = DicomMetadataStore.getInstance(\r\n        options.studyInstanceUID,\r\n        options.seriesInstanceUID,\r\n        options.sopInstanceUID\r\n      );\r\n\r\n      const frameNumbers = Array.isArray(options.frameNumbers)\r\n        ? options.frameNumbers\r\n        : options.frameNumbers.split(',');\r\n\r\n      return frameNumbers.map(fr =>\r\n        Array.isArray(instance.PixelData) ? instance.PixelData[+fr - 1] : instance.PixelData\r\n      );\r\n    };\r\n  }\r\n\r\n  return client;\r\n}\r\n"],"names":["id","packageJson","coordinateFormatScoord3d2Geometry","coordinates","pyramid","transform","Array","isArray","metadata","length","orientation","ImageOrientationSlide","spacing","PixelSpacing","functionalGroup","SharedFunctionalGroupsSequence","PixelMeasuresSequence","_getPixelSpacing","origin","TotalPixelMatrixOriginSequence","offset","Number","XOffsetInSlideCoordinateSystem","YOffsetInSlideCoordinateSystem","map","c","slideCoord","pixelCoord","options","Error","point","m","mInverted","inv","vSlide","vImage","multiply","row","toFixed","mapSlideCoord2PixelCoord","defaultFill","color","emptyFill","defaultStroke","width","activeStroke","active","image","circle","fill","stroke","radius","default","ApiEvents","ROI_ADDED","ROI_MODIFIED","ROI_REMOVED","ROI_DRAWN","ROI_SELECTED","MOVE_STARTED","MOVE_ENDED","LOADING_STARTED","LOADING_ENDED","LOADING_ERROR","FRAME_LOADING_STARTED","FRAME_LOADING_ENDED","FRAME_LOADING_ERROR","EVENTS","ADDED","MODIFIED","REMOVED","UPDATED","SELECTED","ViewerManager","PubSubService","constructor","viewer","viewportId","container","studyInstanceUID","seriesInstanceUID","super","this","onRoiAdded","roiAddedHandler","bind","onRoiModified","roiModifiedHandler","onRoiRemoved","roiRemovedHandler","onRoiSelected","roiSelectedHandler","contextMenuCallback","symbols","Object","getOwnPropertySymbols","_drawingSource","find","p","description","_pyramid","_map","_affine","registerEvents","activateDefaultInteractions","addContextMenuCallback","callback","destroy","unregisterEvents","publish","key","roiGraphic","_broadcastEvent","managedViewer","addEventListener","removeEventListener","event","detail","payload","runSilently","clearRoiGraphics","removeAllROIs","showROIs","hideROIs","addRoiGraphic","addROI","styles","addRoiGraphicWithLabel","label","setROIStyle","uid","styleOptions","removeRoiGraphic","removeROI","updateROIProperties","properties","updateROI","toggleOverviewMap","document","querySelector","preventDefault","activateInteractions","bindings","mouseButtons","interactions","interactionsMap","draw","activate","modify","translate","snap","dragPan","dragZoom","select","keys","forEach","availableInteractionName","interaction","name","config","activateInteractionMethod","deactivateInteractionMethod","_getMapView","_getMap","getView","s","String","window","getViewState","view","center","getCenter","resolution","getResolution","zoom","getZoom","setViewState","viewState","setZoom","setResolution","setCenter","setViewStateByExtent","roiAnnotation","getCoordinates","_jumpToPolyline","_jumpToPolygonOrEllipse","_jumpToPoint","coord","mappedCoord","x","y","midpoint","minX","Infinity","maxX","minY","maxY","height","fit","getSize","LABEL_UPDATED","GRAPHIC_UPDATED","VIEW_UPDATED","RoiAnnotation","setMeasurements","getScoord3d","scoord3d","setRoiGraphic","type","graphicType","graphicData","point1","point2","xLength2","yLength2","Math","sqrt","areaEllipse","PI","_area","_length","undefined","areaPolygon","n","area","j","i","abs","areaOfPolygon","len","p1","p2","xLen","yLen","setLabel","finding","CodeMeaning","CodingSchemeDesignator","CodeValue","getLabel","getDetailedLabel","getLength","getArea","ANNOTATION_UPDATED","ANNOTATION_SELECTED","ANNOTATION_REMOVED","RELABEL","DELETE","MicroscopyService","servicesManager","extensionManager","managedViewers","Set","roiUids","annotations","selectedAnnotation","pendingFocus","peerImport","appConfig","_onRoiAdded","_onRoiModified","_onRoiRemoved","_onRoiUpdated","_onRoiSelected","isROIsVisible","clear","clearAnnotations","removeAnnotation","importDicomMicroscopyViewer","data","add","subscribe","AnnotationEvents","onRelabel","item","triggerRelabel","getAnnotation","delete","synchronizeViewers","getSelectedAnnotation","clearSelection","_addManagedViewerSubscriptions","_roiAddedSubscription","ViewerEvents","_roiModifiedSubscription","_roiRemovedSubscription","_roiUpdatedSubscription","_roiSelectedSubscription","_removeManagedViewerSubscriptions","unsubscribe","_getManagedViewersForSeries","from","filter","getManagedViewersForStudy","getManagedViewersForViewport","_restoreAnnotations","getAnnotationsForSeries","addViewer","existingViewer","mv","removeViewer","_manager","focusAnnotation","_potentiallyLoadSR","StudyInstanceUID","displaySets","studyMetadata","DicomMetadataStore","getStudy","smDisplaySet","ds","Modality","FrameOfReferenceUID","othersFrameOfReferenceUID","derivedDisplaySets","ReferencedFrameOfReferenceUID","includes","some","isLoaded","recentDateTime","recentDisplaySet","dateTime","SeriesDate","SeriesTime","isLoading","load","toggleROIsVisibility","getAnnotations","push","getAnnotationsForStudy","a","annotation","selectAnnotation","baseManagedViewer","activeInteractions","getActiveInteractions","newAnnotation","deleteCallback","successCallback","triggerDelete","getAllManagedViewers","_MicroscopyService","REGISTRATION","altName","create","props","datasetToBuffer","dcmjs","formatLength","unit","mult","connectedMicroscopyPanel","withTranslation","microscopyService","services","setStudyInstanceUID","useState","roiAnnotations","setRoiAnnotations","setSelectedAnnotation","uiDialogService","displaySetService","useEffect","viewport","viewports","get","activeViewportId","displaySetInstanceUIDs","displaySet","getDisplaySetByUID","onAnnotationUpdated","onAnnotationSelected","unsubscribeAnnotationUpdated","MicroscopyEvents","unsubscribeAnnotationSelected","unsubscribeAnnotationRemoved","onAnnotationRemoved","index","shortAxisLength","isSelected","displayText","formatArea","isActive","React","className","DataRow","number","title","onSelect","onMeasurementItemClickHandler","details","primary","secondary","isVisible","onToggleVisibility","isLocked","onToggleLocked","onRename","onMeasurementItemEditHandler","commandsManager","runCommand","onDelete","onMeasurementDeleteHandler","onColor","disableEditing","join","IMAGING_MEASUREMENTS","MEASUREMENT_GROUP","IMAGE_REGION","FINDING","TRACKING_UNIQUE_IDENTIFIER","LENGTH","AREA","SHORT_AXIS","LONG_AXIS","ELLIPSE_AREA","ANNOTATION","ANNOTATION_GROUP","ANNOTATION_LABEL","toArray","MeasurementReport","DICOMMicroscopyViewer","async","loadSR","microscopySRDisplaySet","referencedDisplaySet","naturalizedDataset","rois","labels","toolState","generateToolState","tools","getOwnPropertyNames","measurementGroupContentItems","ContentSequence","ci","ConceptNameCodeSequence","DCM_CODE_VALUES","_getMeasurementGroups","t","toolSpecificToolState","capsToolType","toUpperCase","measurementGroupContentItemsForTool","mg","GraphicType","frameOfReferenceUID","Polygon","Polyline","Point","Ellipse","measurementGroup","findingGroup","trackingGroup","matches","exec","TextValue","presentationState","JSON","parse","marker","measurements","evaluations","evaluation","e","measurement","console","log","roi","ROI","ConceptCodeSequence","_getROIsFromToolState","getSourceDisplaySet","allDisplaySets","ReferencedSeriesSequence","referencedSeries","SeriesInstanceUID","otherDisplaySets","displaySetInstanceUID","warn","utils","OHIF","SOP_CLASS_UIDS","_getDisplaySetsFromSeries","instances","instance","getSeries","firstMeasurementGroupContentItem","_getReferencedFrameOfReferenceUID","SeriesDescription","ContentDate","ContentTime","SeriesNumber","SOPInstanceUID","SOPClassUID","isOverlayDisplaySet","plugin","altImageText","guid","SOPClassHandlerId","isDerived","loadError","catch","error","series","getDisplaySetsForSeries","concat","getDicomMicroscopySRSopClassHandler","sopClassUids","getDisplaySetsFromSeries","sortedInstances","sort","b","dateA","dateB","localeCompare","thumbnailSrc","uuidv4","uiNotificationService","Promise","resolve","reject","dicomMicroscopyModule","client","getDicomWebClient","viewportGridService","getActiveViewportId","retrieveSeriesMetadata","then","retrievedMetadata","MicroscopyBulkSimpleAnnotations","show","message","all","addAnnotationGroups","ann","AnnotationGroupSequence","annotationGroupUID","AnnotationGroupUID","setAnnotationGroupStyle","showAnnotationGroup","loadAnnotation","getDicomMicroscopyANNSopClassHandler","Component","MicroscopyViewport","Suspense","fallback","extension","preRegistration","registerService","getViewportModule","component","viewportOptions","viewportGrid","useViewportGrid","displaySetsKey","useMemo","onResize","debounce","resize","ref","resizeRef","useResizeDetector","handleHeight","handleWidth","_extends","setViewportActive","setActiveViewportId","viewportData","getToolbarModule","evaluate","button","isPrimaryActive","geometryType","disabled","getSopClassHandlerModule","params","getPanelModule","iconName","iconLabel","secondaryLabel","wrappedMeasurementPanel","MicroscopyPanel","onSaveComplete","onRejectComplete","getCommandsModule","actions","deleteMeasurement","callInputDialog","defaultValue","onSave","value","setToolActive","toolName","toolGroupId","dragPanOnMiddle","dragZoomOnRight","indexOf","vertexEnabled","minPoints","maxPoints","toggleOverlays","overlays","getElementsByClassName","onoff","classList","contains","toggle","getState","toggleAnnotations","definitions","commandFn","defaultContext","getCustomizationModule","dataSourceConfig","dataSources","sourceName","activeDataSourceName","userAuthenticationService","wadoRoot","staticWado","singlepart","configuration","wadoConfig","url","headers","getAuthorizationHeader","errorInterceptor","errorHandler","getHTTPErrorHandler","StaticWadoClient","wadoURL","retrieveInstanceFrames","frameNumbers","toString","sopInstanceUID","getInstance","split","fr","PixelData"],"sourceRoot":""}