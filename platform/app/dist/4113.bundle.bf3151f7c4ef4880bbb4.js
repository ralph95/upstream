"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[4113],{74137:(e,n,t)=>{t.d(n,{Ay:()=>c,bY:()=>s,n7:()=>r,sh:()=>i});var a=t(53434);const{CodeScheme:o}=a.QX.Cornerstone3D,i={POINT:"POINT",MULTIPOINT:"MULTIPOINT",POLYLINE:"POLYLINE",CIRCLE:"CIRCLE",ELLIPSE:"ELLIPSE"},r={ImagingMeasurementReport:"126000",ImageLibrary:"111028",ImagingMeasurements:"126010",MeasurementGroup:"125007",ImageLibraryGroup:"126200",TrackingUniqueIdentifier:"112040",TrackingIdentifier:"112039",Finding:"121071",FindingSite:"G-C0E3",FindingSiteSCT:"363698007"},s={SRT:"SRT",SCT:"SCT",CornerstoneCodeSchemes:[o.CodingSchemeDesignator,"CST4"]},c={CodeNameCodeSequenceValues:r,CodingSchemeDesignators:s,RelationshipType:{INFERRED_FROM:"INFERRED FROM",CONTAINS:"CONTAINS"},SCOORDTypes:i}},34113:(e,n,t)=>{t.r(n),t.d(n,{Enums:()=>u.Ay,createReferencedImageDisplaySet:()=>ge.A,default:()=>he,hydrateStructuredReport:()=>K,srProtocol:()=>_,toolNames:()=>p});var a=t(86326),o=t(42356),i=t(68523),r=t(37948),s=t(53434),c=t(4667),l=t(15327),d=t(3823),u=t(74137);const S=1e-4,g=({GraphicData:e,ValueType:n,imageId:t})=>{const a=[];if("SCOORD3D"===n)for(let n=0;n<e.length;n+=3)a.push([e[n],e[n+1],e[n+2]]);else for(let n=0;n<e.length;n+=2){const o=l.utilities.imageToWorldCoords(t,[e[n],e[n+1]]);a.push(o)}return a};const m=function({GraphicType:e,GraphicData:n,ValueType:t,imageId:a}){let o=[];switch(e){case u.sh.POINT:case u.sh.MULTIPOINT:case u.sh.POLYLINE:o=g({GraphicData:n,ValueType:t,imageId:a});break;case u.sh.CIRCLE:{const e=g({GraphicData:n,ValueType:t,imageId:a});if(!a)return e;const i=e[0],r=e[1],s=d.eR.distance(i,r),c=l.metaData.get("imagePlaneModule",a);if(!c)throw new Error("No imagePlaneModule found");const{columnCosines:u,rowCosines:S}=c,m=d.eR.create();d.eR.scaleAndAdd(m,i,u,s);const p=d.eR.create();d.eR.scaleAndAdd(p,i,u,-s);const f=d.eR.create();d.eR.scaleAndAdd(f,i,S,s);const h=d.eR.create();d.eR.scaleAndAdd(h,i,S,-s),o=[m,p,f,h];break}case u.sh.ELLIPSE:{const e=g({GraphicData:n,ValueType:t,imageId:a});if(!a)return e;const i=d.eR.fromValues(...e[0]),r=d.eR.fromValues(...e[1]),s=d.eR.fromValues(...e[2]),c=d.eR.fromValues(...e[3]),u=d.eR.create();d.eR.sub(u,r,i),d.eR.normalize(u,u);const m=d.eR.create();d.eR.sub(m,c,s),d.eR.normalize(m,m);const p=l.metaData.get("imagePlaneModule",a);if(!p)throw new Error("imageId does not have imagePlaneModule metadata");const{columnCosines:f}=p,h=d.eR.fromValues(...f),I=Math.abs(d.eR.dot(h,u)),R=Math.abs(d.eR.dot(h,m)),C=Math.abs(I),D=Math.abs(R);o=[],Math.abs(C-1)<S?o=[e[0],e[1],e[2],e[3]]:Math.abs(D-1)<S?o=[e[2],e[3],e[0],e[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");break}default:console.warn("Unsupported GraphicType:",e)}return o},p={DICOMSRDisplay:"DICOMSRDisplay",SRLength:"SRLength",SRBidirectional:"SRBidirectional",SREllipticalROI:"SREllipticalROI",SRCircleROI:"SRCircleROI",SRArrowAnnotate:"SRArrowAnnotate",SRAngle:"SRAngle",SRCobbAngle:"SRCobbAngle",SRRectangleROI:"SRRectangleROI",SRPlanarFreehandROI:"SRPlanarFreehandROI",SRSCOORD3DPoint:"SRSCOORD3DPoint"},{MeasurementReport:f}=s.QX.Cornerstone3D;function h({measurement:e,imageId:n=null,frameNumber:t=null,displaySet:a}){let o=p.DICOMSRDisplay;const i=e.coords.reduce((e,t)=>(e[t.GraphicType]=e[t.GraphicType]||[],e[t.GraphicType].push(m({...t,imageId:n})),e),{}),{TrackingUniqueIdentifier:r}=e,{ValueType:s,GraphicType:d}=e.coords[0],u=i[d];let S=null,g=null;if(n){const e=l.metaData.get("imagePlaneModule",n);S=e?.frameOfReferenceUID}if("SCOORD3D"===s){f.getAdapterForTrackingIdentifier(e.TrackingIdentifier)||(o=p.SRSCOORD3DPoint),S=e.coords[0].ReferencedFrameOfReferenceSequence,g={FrameOfReferenceUID:S,point:u[0][0]}}e.viewReference={planeRestriction:g,FrameOfReferenceUID:S,referencedImageId:n};const h={annotationUID:r,highlighted:!1,isLocked:!1,isPreview:o===p.DICOMSRDisplay,invalidated:!1,metadata:{toolName:o,planeRestriction:g,valueType:s,graphicType:d,FrameOfReferenceUID:S,referencedImageId:n,displaySetInstanceUID:a.displaySetInstanceUID},data:{label:e.labels?.[0]?.value||void 0,displayText:e.displayText||void 0,handles:{textBox:e.textBox??{},points:u[0]},cachedStats:{},frameNumber:t,renderableData:i,TrackingUniqueIdentifier:r,labels:e.labels}};c.annotation.state.addAnnotation(h)}const{MeasurementReport:I}=s.QX.Cornerstone3D;const R=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-sr"}').UU,C="dicom-sr",D=`${R}.sopClassHandlerModule.${C}`,T="dicom-sr-3d",O=`${R}.sopClassHandlerModule.${T}`,{sopClassDictionary:y}=o.Wp,{CORNERSTONE_3D_TOOLS_SOURCE_NAME:E,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:U}=r.Enums,{MetadataProvider:N}=o.Ly,{TEXT_ANNOTATION_POSITION:b,COMMENT_CODE:w,CodeScheme:v}=s.QX.Cornerstone3D,M=[y.BasicTextSR,y.EnhancedSR,y.ComprehensiveSR,y.Comprehensive3DSR];function P(e,n){return this.instances.push(...e),o.Wp.sortStudyInstances(this.instances),this.instance=this.instances[this.instances.length-1],this.isLoaded=!1,this}function x(e,n,t){if(!e||!e.length)throw new Error("No instances were provided");o.Wp.sortStudyInstances(e);const a=e[e.length-1],{StudyInstanceUID:r,SeriesInstanceUID:s,SOPInstanceUID:c,SeriesDescription:l,SeriesNumber:d,SeriesDate:S,SeriesTime:g,ConceptNameCodeSequence:m,SOPClassUID:p}=a;((e,n)=>{n.forEach(n=>{if(n.StudyInstanceUID!==e)throw console.warn("Not all instances have the same UID",e,n),new Error(`Instances ${n.SOPInstanceUID} does not belong to ${e}`)})})(a.StudyInstanceUID,e);const f=p===y.Comprehensive3DSR,h=m?.CodeValue===u.n7.ImagingMeasurementReport,R={Modality:"SR",displaySetInstanceUID:o.Wp.guid(),SeriesDescription:l,SeriesNumber:d,SeriesDate:S,SeriesTime:g,SOPInstanceUID:c,SeriesInstanceUID:s,StudyInstanceUID:r,SOPClassHandlerId:f?O:D,SOPClassUID:p,instances:e,referencedImages:null,measurements:null,isDerivedDisplaySet:!0,isLoaded:!1,isImagingMeasurementReport:h,sopClassUids:M,instance:a,addInstances:P,label:l||`${i.A.t("Series")} ${d} - ${i.A.t("SR")}`};return R.load=()=>async function(e,n,t){const{displaySetService:a,measurementService:o}=n.services,i=t.getDataSources(),r=i[0],{ContentSequence:s}=e.instance;async function c(n,t=null,a=null){for(const o in n)if("object"==typeof n[o]&&null!==n[o])await c(n[o],n,o);else if(Array.isArray(n[o]))await Promise.all(n[o].map(e=>c(e,n,o)));else if("BulkDataURI"===o){const i=await r.retrieve.bulkDataURI({BulkDataURI:n[o],StudyInstanceUID:e.instance.StudyInstanceUID,SeriesInstanceUID:e.instance.SeriesInstanceUID,SOPInstanceUID:e.instance.SOPInstanceUID});t&&a&&(t[a]=new Float32Array(i))}}!0!==e.isLoaded&&await c(s);e.isImagingMeasurementReport?(e.referencedImages=function(e){const n=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.ImageLibrary);if(!n)return[];const t=q(n.ContentSequence).find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.ImageLibraryGroup);if(!t)return[];const a=[];return q(t.ContentSequence).forEach(e=>{const{ReferencedSOPSequence:n}=e;if(n)for(const e of q(n))if(e.ReferencedSOPClassUID){const{ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:t}=e;a.push({ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:t})}}),a}(s),e.measurements=function(e){const n=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.ImagingMeasurements);if(!n)return[];const t=function(e){const n={};return e.forEach(e=>{const t=q(e.ContentSequence),a=t.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.TrackingUniqueIdentifier);a||console.warn("No Tracking Unique Identifier, skipping ambiguous measurement.");const o=a.UID;void 0===n[o]?n[o]=[...t]:t.forEach(e=>{e.ConceptNameCodeSequence.CodeValue!==u.n7.TrackingUniqueIdentifier&&n[o].push(e)})}),n}(q(n.ContentSequence).filter(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.MeasurementGroup)),a=[];return Object.keys(t).forEach(e=>{const n=function(e){if(e.some(e=>function(e){return"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType}(e)&&!function(e){const n=e.ConceptNameCodeSequence[0];return n&&n.CodeValue===b.value&&n.CodingSchemeDesignator===b.schemeDesignator}(e)))return function(e){const n=e.find(e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType),t=e.find(e=>"UIDREF"===e.ValueType),a=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.TrackingIdentifier);if(!n)return void console.warn(`graphic ValueType ${n.ValueType} not currently supported, skipping annotation.`);const o=e.filter(e=>"NUM"===e.ValueType),{ConceptNameCodeSequence:i}=n,{CodeValue:r,CodingSchemeDesignator:s}=i,c=`${s}:${r}`,l=V(n),d="SCOORD3D"===l.ValueType,S=d?3:2,g=l.GraphicData.length/S,m={loaded:!1,labels:[],coords:[l],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:a.TextValue,graphicCode:c,is3DMeasurement:d,pointsLength:g,graphicType:l.GraphicType};o.forEach(e=>{const{ConceptNameCodeSequence:n,MeasuredValueSequence:t}=e;t&&m.labels.push(k(n,t))});const p=e.filter(e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===u.bY.SCT&&e.ConceptNameCodeSequence.CodeValue===u.n7.FindingSiteSCT);p.length&&m.labels.push({label:u.n7.FindingSiteSCT,value:p[0].ConceptCodeSequence.CodeMeaning});return m}(e);return function(e){const n=e.filter(e=>"NUM"===e.ValueType),t=e.find(e=>"UIDREF"===e.ValueType),a=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.TrackingIdentifier),o=e.find(e=>e.ConceptNameCodeSequence.CodeValue===u.n7.Finding),i=e.filter(e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===u.bY.SRT&&e.ConceptNameCodeSequence.CodeValue===u.n7.FindingSite),r=e.filter(e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===w.schemeDesignator&&e.ConceptNameCodeSequence.CodeValue===w.value),s={loaded:!1,labels:[],coords:[],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:a.TextValue};if(r)for(const e of r)e.TextValue&&s.labels.push({label:e.TextValue,value:""});o&&u.bY.CornerstoneCodeSchemes.includes(o.ConceptCodeSequence.CodingSchemeDesignator)&&o.ConceptCodeSequence.CodeValue===v.codeValues.CORNERSTONEFREETEXT&&s.labels.push({label:v.codeValues.CORNERSTONEFREETEXT,value:o.ConceptCodeSequence.CodeMeaning});if(i.length){const e=i.find(e=>u.bY.CornerstoneCodeSchemes.includes(e.ConceptCodeSequence.CodingSchemeDesignator)&&e.ConceptCodeSequence.CodeValue===v.codeValues.CORNERSTONEFREETEXT);e&&s.labels.push({label:v.codeValues.CORNERSTONEFREETEXT,value:e.ConceptCodeSequence.CodeMeaning})}return n.forEach(e=>{const{ConceptNameCodeSequence:n,ContentSequence:t,MeasuredValueSequence:a}=e,{ValueType:o}=t;if("SCOORD"===!o)return void console.warn(`Graphic ${o} not currently supported, skipping annotation.`);const i=V(t);i&&s.coords.push(i),a&&s.labels.push(k(n,a))}),s}(e)}(t[e]);n&&a.push(n)}),a}(s)):(e.referencedImages=[],e.measurements=[]);const l=o.getSourceMappings(E,U);e.isHydrated=!1,e.isRehydratable=function(e,n){if(!n||!n.length)return!1;const t=new Set;for(const e of n)t.add(e.annotationType);const{measurements:a}=e;for(let e=0;e<a.length;e++){const n=a[e];if(!n)continue;const{TrackingIdentifier:o="",graphicType:i,graphicCode:r,pointsLength:s}=n;if(!o&&!i){console.warn("No tracking identifier  or graphicType for measurement ",n);continue}const c=I.getAdapterForTrackingIdentifier(o),l=I.getAdaptersForTypes(r,i,s),d=c&&t.has(c.toolType)||l&&l.some(e=>t.has(e.toolType));if(d)return!0;console.log("Measurement is not rehydratable",o,a[e])}return console.log("No measurements found which were rehydratable"),!1}(e,l),e.isLoaded=!0,a.activeDisplaySets.forEach(t=>{L(e,t,r,n)}),a.subscribe(a.EVENTS.DISPLAY_SETS_ADDED,t=>{const{displaySetsAdded:a}=t;a.forEach(t=>{L(e,t,r,n)})})}(R,n,t),[R]}function A({measurement:e,displaySet:n}){return e.coords[0].ReferencedFrameOfReferenceSequence===n.FrameOfReferenceUID}function L(e,n,t,a){const{customizationService:o}=a.services,i=e.measurements.filter(e=>!1===e.loaded);if(!i.length||n.unsupported)return;const r=new Map,s=t.getImageIdsForDisplaySet(n);for(const e of s){const{SOPInstanceUID:n,frameNumber:t}=N.getUIDsFromImageID(e),a=`${n}:${t||1}`;r.set(a,e)}if(!i?.length)return;const c=e.SOPClassUID===y.Comprehensive3DSR;for(let t=i.length-1;t>=0;t--){let a=i[t];const s="SCOORD3D"===a.coords?.[0]?.ValueType,l=o.getCustomization("onBeforeSRAddMeasurement");if("function"==typeof l&&(a=l({measurement:a,StudyInstanceUID:e.StudyInstanceUID,SeriesInstanceUID:e.SeriesInstanceUID})),c&&s&&A({measurement:a,displaySet:n})){h({measurement:a,displaySet:n}),a.loaded=!0,a.displaySetInstanceUID=n.displaySetInstanceUID,i.splice(t,1);continue}const d=a.coords[0].ReferencedSOPSequence;if(!d)continue;const{ReferencedSOPInstanceUID:u}=d,S=d.ReferencedFrameNumber||1,g=`${u}:${S}`,m=r.get(g);m&&F(a,u,S)&&(h({measurement:a,imageId:m,frameNumber:S,displaySet:n}),a.loaded=!0,a.imageId=m,a.displaySetInstanceUID=n.displaySetInstanceUID,a.ReferencedSOPInstanceUID=u,a.frameNumber=S,i.splice(t,1))}}function F(e,n,t){const{coords:a}=e,o=e.coords[0].ReferencedSOPSequence&&e.coords[0].ReferencedSOPSequence?.ReferencedFrameNumber||1;if(t&&Number(t)!==Number(o))return!1;for(let e=0;e<a.length;e++){const t=a[e],{ReferencedSOPInstanceUID:o}=t.ReferencedSOPSequence;if(o===n)return!0}return!1}const V=e=>{const{ValueType:n,GraphicType:t,GraphicData:a}=e,o={ValueType:n,GraphicType:t,GraphicData:a};return o.ReferencedSOPSequence=e.ContentSequence?.ReferencedSOPSequence,o.ReferencedFrameOfReferenceSequence=e.ReferencedFrameOfReferenceUID||e.ContentSequence?.ReferencedFrameOfReferenceSequence,o};function k(e,n){const{CodeMeaning:t}=e,{NumericValue:a,MeasurementUnitsCodeSequence:o}=n,{CodeValue:i}=o;return{label:t,value:`${a?Number(a).toFixed(2):""} ${i}`}}function q(e){return e?Array.isArray(e)?e:[e]:[]}const B=function(e){const{servicesManager:n,extensionManager:t}=e,a=e=>x(e,n,t);return[{name:C,sopClassUids:M,getDisplaySetsFromSeries:a},{name:T,sopClassUids:[y.Comprehensive3DSR],getDisplaySetsFromSeries:a}]},_={id:"@ohif/sr",name:"SR Key Images",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{srDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SR"}}]}},stages:[{name:"SR Key Images",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId"}]}]}]};var $=t(5842);const G=function(e,n){const t={};function a(a,o){const i=a.metadata?.referencedImageId??s.W6;t[i]||(t[i]={});const r=t[i];r[o]||(r[o]={data:[]});const c=e.find(e=>e.uid===a.annotationUID),l=r[o].data;let{finding:d}=c;const u=[];c.label&&(n.includes(o)?d={CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:c.label}:u.push({CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:c.label})),c.findingSites&&u.push(...c.findingSites);const S=Object.assign({},a,{finding:d,findingSites:u});l.push(S)}const o=e.map(e=>e.uid).slice(),i=c.annotation.state.getAnnotationManager(),r=i.getFramesOfReference();for(let e=0;e<r.length;e++){const n=r[e],s=i.getAnnotations(n),c=Object.keys(s);for(let e=0;e<c.length;e++){const n=c[e],i=s[n];if(i)for(let e=0;e<i.length;e++){const r=i[e],s=o.findIndex(e=>e===r.annotationUID);if(-1!==s&&(a(r,n),o.splice(s,1),!o.length))return t}}}return t},{CodeScheme:W}=s.QX.Cornerstone3D;const{locking:H}=c.annotation,{guid:z}=o.Ay.utils,{MeasurementReport:X}=s.QX.Cornerstone3D,{CORNERSTONE_3D_TOOLS_SOURCE_NAME:j,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:Y}=r.Enums,Q=(e,n)=>{if(!n||"CORNERSTONEJS"===n.CodingSchemeDesignator)return;const t=`${n.CodingSchemeDesignator}:${n.CodeValue}`;return{...e[t],ref:t,...n,text:n.CodeMeaning}},J=(e,n)=>{if(!n||!n.length)return;const t=[];for(let a=0;a<n.length;a++){const o=Q(e,n[a][0]||n[a]);o&&t.push(o)}return t.length&&t||void 0};function K({servicesManager:e,extensionManager:n,commandsManager:t},a){const i=n.getActiveDataSource()[0],{measurementService:r,displaySetService:s,customizationService:c}=e.services,d=c.getCustomization("codingValues"),u=c.getCustomization("panelMeasurement.disableEditing"),S=s.getDisplaySetByUID(a),g=r.getSourceMappings(j,Y);if(!g||!g.length)throw new Error("Attempting to hydrate measurements service when no mappings present. This shouldn't be reached.");const m=o.H8.getInstance(S.StudyInstanceUID,S.SeriesInstanceUID,S.SOPInstanceUID),p={};S.measurements.forEach(e=>{const{ReferencedSOPInstanceUID:n,imageId:t,frameNumber:a=1}=e,o=`${n}:${a}`;p[o]||(p[o]=t)});const f=m;let h=X.generateToolState(f,p,l.metaData);const I=c.getCustomization("onBeforeSRHydration")?.value;"function"==typeof I&&(h=I({storedMeasurementByAnnotationType:h,displaySet:S}));const R=g.map(e=>e.annotationType),C={};Object.keys(h).forEach(e=>{R.includes(e)&&(C[e]=h[e])});const D=[];let T;Object.keys(C).forEach(e=>{C[e].forEach(e=>{const n=e.annotation.data?.frameNumber||1,t=p[`${e.sopInstanceUid}:${n}`];D.includes(t)||D.push(t)})});const O=[];for(let e=0;e<D.length;e++){const n=D[e];if(!n)continue;const{SeriesInstanceUID:t,StudyInstanceUID:a}=l.metaData.get("instance",n);O.includes(t)||O.push(t),T?T!==a&&console.warn("NO SUPPORT FOR SRs THAT HAVE MEASUREMENTS FROM MULTIPLE STUDIES."):T=a}function y(n){const t=n.annotation.data&&n.annotation.data.frameNumber||1,a=p[`${n.sopInstanceUid}:${t}`];if(!a)return function(e,n){const{FrameOfReferenceUID:t}=e.annotation.metadata,{points:a}=e.annotation.data.handles,{displaySetService:o}=n.services,i=o.getDisplaySetsBy(e=>e.FrameOfReferenceUID===t);if(!i.length||!a?.length)return{FrameOfReferenceUID:t};const r=function(e,n){if(!e?.length)return void console.warn("No display set found for",n);if(1===e.length)return e[0];const t=e.find(e=>e.isReconstructable);if(t)return t;return e[0]}(i,e.annotation),s={...Z(r,a),volumeId:r.displaySetInstanceUID,FrameOfReferenceUID:t};return l.utilities.updatePlaneRestriction(a,s),s}(n,e);const o=l.metaData.get("instance",a),{FrameOfReferenceUID:i}=o;return{referencedImageId:a,FrameOfReferenceUID:i}}return Object.keys(C).forEach(e=>{C[e].forEach(n=>{n.uid=z();const a=y(n),{imageId:o}=a,s={annotationUID:n.annotation.annotationUID,data:n.annotation.data,metadata:{...a,toolName:e}};l.utilities.updatePlaneRestriction(s.data.handles.points,s.metadata);const c=r.getSource(j,Y);s.data.label=function(e){const{findingSites:n=[],finding:t,annotation:a}=e;if(a.data.label)return a.data.label;let o=n.find(e=>e.CodeValue===W.codeValues.CORNERSTONEFREETEXT);return o?o.CodeMeaning:t&&t.CodeValue===W.codeValues.CORNERSTONEFREETEXT?t.CodeMeaning:void 0}(n),s.data.finding=Q(d,n.finding?.[0]),s.data.findingSites=J(d,n.findingSites),s.data.findingSites?.forEach(e=>{e.type&&(s.data[e.type]=e)});const S=g.find(n=>n.annotationType===e),m=r.addRawMeasurement(c,e,{annotation:s},S.toMeasurementSchema,i);t.runCommand("updateMeasurement",{uid:m,code:s.data.finding}),u&&H.setAnnotationLocked(m,!0),o&&!D.includes(o)&&D.push(o)})}),S.isHydrated=!0,{StudyInstanceUID:T,SeriesInstanceUIDs:O}}function Z(e,n){const t=function(e){if(1===e.length||2===e.length)return e;const n=0,t=Math.ceil(e.length/4),a=Math.ceil(e.length/2),o=[e[n],e[t],e[a]];return o}(n),a=function(e){const n=1/e.length,t=d.eR.create();for(const a of e)d.eR.scaleAndAdd(t,t,a,n);return t}(t);return{cameraFocalPoint:a,viewPlaneNormal:null,viewUp:null}}const{MeasurementReport:ee}=s.QX.Cornerstone3D,{log:ne}=o.Ay,te=(e,n,t={})=>{const a=G(e,n),o=ee.generateReport(a,l.metaData,t),{dataset:i}=o;return void 0===i.SpecificCharacterSet&&(i.SpecificCharacterSet="ISO_IR 192"),i.InstanceNumber=t.InstanceNumber??1,i},ae=e=>{const{servicesManager:n,extensionManager:t,commandsManager:a}=e,{customizationService:i}=n.services,r={changeColorMeasurement:({uid:e})=>{throw new Error("Unsupported operation: changeColorMeasurement")},downloadReport:({measurementData:e,additionalFindingTypes:n,options:t={}})=>{const a=te(e,n,t),o=$.Ay.data.datasetToBlob(a),i=URL.createObjectURL(o);window.location.assign(i)},storeMeasurements:async({measurementData:e,dataSource:n,additionalFindingTypes:t,options:a={}})=>{if(ne.info("[DICOMSR] storeMeasurements"),!n||!n.store||!n.store.dicom)return ne.error("[DICOMSR] datasource has no dataSource.store.dicom endpoint!"),Promise.reject({});try{const r=te(e,t,a),{StudyInstanceUID:s,ContentSequence:c}=r;if(!c?.[4].ContentSequence?.length)throw console.log("naturalizedReport missing imaging content",r),new Error("Invalid report, no content");if(!r.SOPClassUID)throw new Error("No sop class uid");const l=i.getCustomization("onBeforeDicomStore");let d;return"function"==typeof l&&(d=l({dicomDict:d,measurementData:e,naturalizedReport:r})),await n.store.dicom(r,null,d),s&&n.deleteStudyMetadataPromise(s),o.H8.addInstances([r],!0),r}catch(e){throw console.warn(e),ne.error(`[DICOMSR] Error while saving the measurements: ${e.message}`),new Error(e.message||"Error while saving the measurements.")}},hydrateStructuredReport:({displaySetInstanceUID:e})=>K({servicesManager:n,extensionManager:t,commandsManager:a},e)};return{actions:r,definitions:{downloadReport:r.downloadReport,storeMeasurements:r.storeMeasurements,hydrateStructuredReport:r.hydrateStructuredReport},defaultContext:"CORNERSTONE_STRUCTURED_REPORT"}};var oe=t(76654);class ie extends c.AnnotationTool{constructor(e={},n={configuration:{}}){super(e,n),this.isPointNearTool=()=>null,this.getHandleNearImagePoint=()=>null,this.renderAnnotation=(e,n)=>{const{viewport:t}=e,{element:a}=t;let o=c.annotation.state.getAnnotations(this.getToolName(),a);if(!o?.length)return;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return;const i=(0,oe.eF)(a),{activeIndex:r,trackingUniqueIdentifiers:s}=i,l=s[r],d=o.filter(e=>s.includes(e.data?.TrackingUniqueIdentifier));if(!t._actors?.size)return;const S={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},{style:g}=c.annotation.config;for(let e=0;e<d.length;e++){const a=d[e],o=a.annotationUID,{renderableData:i,TrackingUniqueIdentifier:r}=a.data,{referencedImageId:s}=a.metadata;S.annotationUID=o;const m=g.getToolGroupToolStyles(this.toolGroupId)[this.getToolName()],p=this.getStyle("lineWidth",S,a),f=this.getStyle("lineDash",S,a),h={color:r===l?"rgb(0, 255, 0)":this.getStyle("color",S,a),lineDash:f,lineWidth:p,...m};Object.keys(i).forEach(e=>{const r=i[e];let l,d;switch(e){case u.sh.POINT:l=this.renderPoint;break;case u.sh.MULTIPOINT:l=this.renderMultipoint;break;case u.sh.POLYLINE:l=this.renderPolyLine;break;case u.sh.CIRCLE:l=this.renderEllipse;break;case u.sh.ELLIPSE:l=this.renderEllipse,d=c.utilities.math.ellipse.getCanvasEllipseCorners;break;default:throw new Error(`Unsupported GraphicType: ${e}`)}const g=l(n,t,r,o,s,h);this.renderTextBox(n,t,g,d,a,S,h)})}}}_getTextBoxLinesFromLabels(e){const n=Math.min(e.length,5),t=[];for(let a=0;a<n;a++){const n=e[a];t.push(`${se(n.label)}: ${n.value}`)}return t}renderPolyLine(e,n,t,a,o,i){const r={color:i.color,width:i.lineWidth,lineDash:i.lineDash};let s=[];return t.map((t,o)=>{const i=t.map(e=>n.worldToCanvas(e)),l=`${o}`;2===i.length?c.drawing.drawLine(e,a,l,i[0],i[1],r):c.drawing.drawPolyline(e,a,l,i,r),s=s.concat(i)}),s}renderMultipoint(e,n,t,a,o,i){let r;t.map((t,o)=>{r=t.map(e=>n.worldToCanvas(e));c.drawing.drawHandles(e,a,"0",r,{color:i.color})})}renderPoint(e,n,t,a,o,i){const r=[];return t.map((t,s)=>{const d=t[0];if(r.push(n.worldToCanvas(d)),void 0!==t[1])r.push(n.worldToCanvas(t[1]));else{const e=l.metaData.get("imagePixelModule",o);let t=10,a=10;if(e){const{columns:n,rows:o}=e;t=n/10,a=o/10}const i=l.utilities.worldToImageCoords(o,d),s=l.utilities.imageToWorldCoords(o,[i[0]+t,i[1]+a]);r.push(n.worldToCanvas(s))}const u=`${s}`;c.drawing.drawArrow(e,a,u,r[1],r[0],{color:i.color,width:i.lineWidth})}),r}renderEllipse(e,n,t,a,o,i){let r;return t.map((t,o)=>{if(0===t.length)return;const s=t,l=n.getRotation();let d;r=s.map(e=>n.worldToCanvas(e)),d=90==l||270==l?c.utilities.math.ellipse.getCanvasEllipseCorners([r[2],r[3],r[0],r[1]]):c.utilities.math.ellipse.getCanvasEllipseCorners(r);const u=`${o}`;c.drawing.drawEllipse(e,a,u,d[0],d[1],{color:i.color,width:i.lineWidth,lineDash:i.lineDash})}),r}renderTextBox(e,n,t,a,o,i,r={}){if(!t||!o)return;const{annotationUID:s,data:l={}}=o,{labels:d}=l,{color:u}=r;let S=t;"function"==typeof a&&(S=a(t));const g=this._getTextBoxLinesFromLabels(d),m=c.utilities.drawing.getTextBoxCoordsCanvas(S);o.data?.handles?.textBox?.worldPosition||(o.data.handles.textBox.worldPosition=n.canvasToWorld(m));const p=n.worldToCanvas(o.data.handles.textBox.worldPosition),f=this.getLinkedTextBoxStyle(i,o),h=c.drawing.drawLinkedTextBox(e,s,"1",g,p,t,{},{...f,color:u}),{x:I,y:R,width:C,height:D}=h;o.data.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([I,R]),topRight:n.canvasToWorld([I+C,R]),bottomLeft:n.canvasToWorld([I,R+D]),bottomRight:n.canvasToWorld([I+C,R+D])}}}ie.toolName=p.DICOMSRDisplay;const re={"Short Axis":"W: ","Long Axis":"L: ",AREA:"Area: ",Length:"",CORNERSTONEFREETEXT:""};function se(e){const n=re[e];return void 0!==n?n:e}class ce extends c.AnnotationDisplayTool{constructor(e={},n={configuration:{}}){super(e,n),this.isPointNearTool=()=>null,this.getHandleNearImagePoint=()=>null,this.renderAnnotation=(e,n)=>{const{viewport:t}=e,{element:a}=t,o=c.annotation.state.getAnnotations(this.getToolName(),a);if(!o?.length)return;const i=o;if(!t._actors?.size)return;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<i.length;e++){const a=i[e],o=a.annotationUID,{renderableData:s}=a.data,{POINT:l}=s;r.annotationUID=o;const d=this.getStyle("lineWidth",r,a),u=this.getStyle("lineDash",r,a),S={color:this.getStyle("color",r,a),lineDash:u,lineWidth:d},g=l[0][0];if(!t.isReferenceViewable({FrameOfReferenceUID:a.metadata.FrameOfReferenceUID,cameraFocalPoint:g},{asNearbyProjection:!0}))continue;const m=t.worldToCanvas(g),p=[m,[m[0]+20,m[1]+20]];c.drawing.drawArrow(n,o,"1",p[1],p[0],{color:S.color,width:S.lineWidth}),this.renderTextBox(n,t,p,a,r,S)}}}_getTextBoxLinesFromLabels(e){Math.min(e.length,5);return[]}renderTextBox(e,n,t,a,o,i={}){if(!t||!a)return;const{annotationUID:r,data:s={}}=a,{labels:l}=s,d=[];for(const e of l)"363698007"===e.label&&d.push(`Finding Site: ${e.value}`);const{color:u}=i,S=t,g=c.utilities.drawing.getTextBoxCoordsCanvas(S);a.data?.handles?.textBox?.worldPosition||(a.data.handles.textBox.worldPosition=n.canvasToWorld(g));const m=n.worldToCanvas(a.data.handles.textBox.worldPosition),p=this.getLinkedTextBoxStyle(o,a),f=c.drawing.drawLinkedTextBox(e,r,"1",d,m,t,{},{...p,color:u}),{x:h,y:I,width:R,height:C}=f;a.data.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([h,I]),topRight:n.canvasToWorld([h+R,I]),bottomLeft:n.canvasToWorld([h,I+C]),bottomRight:n.canvasToWorld([h+R,I+C])}}getLinkedTextBoxStyle(e,n){return{visibility:this.getStyle("textBoxVisibility",e,n),fontFamily:this.getStyle("textBoxFontFamily",e,n),fontSize:this.getStyle("textBoxFontSize",e,n),color:this.getStyle("textBoxColor",e,n),shadow:this.getStyle("textBoxShadow",e,n),background:this.getStyle("textBoxBackground",e,n),lineWidth:this.getStyle("textBoxLinkLineWidth",e,n),lineDash:this.getStyle("textBoxLinkLineDash",e,n)}}}ce.toolName=p.SRSCOORD3DPoint;const le={toAnnotation:e=>{},toMeasurement:({servicesManager:e,getValueTypeFromToolType:n},t)=>{const{displaySetService:a}=e.services,{annotation:o}=t,{metadata:i,data:r,annotationUID:s}=o;if(!i||!r)return console.warn("Probe tool: Missing metadata or data"),null;const{toolName:c,FrameOfReferenceUID:l}=i,{points:d}=r.handles,u=a.getActiveDisplaySets().filter(e=>e.FrameOfReferenceUID===l),S=u.filter(e=>e.isReconstructable)[0]||u[0],{StudyInstanceUID:g,SeriesInstanceUID:m}=u[0]||{},p=function(e){const{data:n}=e;if(!n)return[""];const{labels:t}=n,a=[];for(const e of t)"33636980076"===e.label&&a.push(`Finding Site: ${e.value}`);return{primary:a,secondary:[]}}(o);return{uid:s,points:d,metadata:i,referenceStudyUID:g,referenceSeriesUID:m,displaySetInstanceUID:S?.displaySetInstanceUID,toolName:i.toolName,label:r.label,displayText:p,data:r.cachedStats,type:n?.(c)??null}}};function de(e,n,t={}){class a extends n{constructor(e,n){e.configuration=e.configuration?{...e.configuration,...t}:t,super(e,n)}}a.toolName=e,(0,c.addTool)(a)}const{CORNERSTONE_3D_TOOLS_SOURCE_NAME:ue,CORNERSTONE_3D_TOOLS_SOURCE_VERSION:Se}=r.Enums;var ge=t(92643);function me(){return me=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)({}).hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},me.apply(null,arguments)}const pe=a.lazy(()=>t.e(2701).then(t.bind(t,62701))),fe=e=>a.createElement(a.Suspense,{fallback:a.createElement("div",null,"Loading...")},a.createElement(pe,e)),he={id:R,onModeEnter:function({servicesManager:e}){const{displaySetService:n}=e.services;[...n.getDisplaySetCache().values()].filter(e=>e.SOPClassHandlerId===D||e.SOPClassHandlerId===O).forEach(e=>{e.isHydrated=!1})},preRegistration:function({configuration:e={},servicesManager:n}){const{measurementService:t}=n.services;de(p.DICOMSRDisplay,ie),de(p.SRLength,c.LengthTool),de(p.SRBidirectional,c.BidirectionalTool),de(p.SREllipticalROI,c.EllipticalROITool),de(p.SRCircleROI,c.CircleROITool),de(p.SRArrowAnnotate,c.ArrowAnnotateTool),de(p.SRAngle,c.AngleTool),de(p.SRPlanarFreehandROI,c.PlanarFreehandROITool),de(p.SRRectangleROI,c.RectangleROITool),de(p.SRSCOORD3DPoint,ce),de(p.SRCobbAngle,c.CobbAngleTool);const a=t.getSource(ue,Se),{POINT:o}=t.VALUE_TYPES;t.addMapping(a,"SRSCOORD3DPoint",o,le.toAnnotation,le.toMeasurement.bind(null,{servicesManager:n}));const i={lineDash:"4,4"};c.annotation.config.style.setToolGroupToolStyles("SRToolGroup",{[p.DICOMSRDisplay]:i,SRLength:i,SRBidirectional:i,SREllipticalROI:i,SRCircleROI:i,SRArrowAnnotate:i,SRCobbAngle:i,SRAngle:i,SRPlanarFreehandROI:i,SRRectangleROI:i,global:{}})},getViewportModule:({servicesManager:e,extensionManager:n})=>[{name:"dicom-sr",component:t=>a.createElement(fe,me({servicesManager:e,extensionManager:n},t))}],getCommandsModule:ae,getSopClassHandlerModule:B,getUtilityModule:({servicesManager:e})=>[{name:"tools",exports:{toolNames:p}}]}},76654:(e,n,t)=>{t.d(n,{eF:()=>r,m1:()=>i});var a=t(15327);const o={TrackingUniqueIdentifier:null,trackingIdentifiersByViewportId:{}};function i(e,n,t=0){const i=(0,a.getEnabledElement)(e),{viewport:r}=i;o.trackingIdentifiersByViewportId[r.id]={trackingUniqueIdentifiers:n,activeIndex:t}}function r(e){const n=(0,a.getEnabledElement)(e),{viewport:t}=n;return o.trackingIdentifiersByViewportId[t.id]?o.trackingIdentifiersByViewportId[t.id]:{trackingUniqueIdentifiers:[]}}},92643:(e,n,t)=>{t.d(n,{A:()=>r});const a=t(42356).Ly.ImageSet,o=(e,n)=>{const{displaySetInstanceUID:t,ReferencedSOPInstanceUID:a}=e,o=n.getDisplaySetByUID(t);if(o.images)return o.images.find(e=>e.SOPInstanceUID===a)},i=(e,n)=>{const t=[],a={};for(const i of n.measurements){const{imageId:n}=i;if(!n)continue;if(a[n])continue;const r=o(i,e);r?(a[n]=r,t.push(r)):console.log("Measurement",i,"had no instances found")}return t},r=(e,n)=>{const t=i(e,n),o=new a(t),r=t[0];if(r)return o.setAttributes({displaySetInstanceUID:o.uid,SeriesDate:r.SeriesDate,SeriesTime:r.SeriesTime,SeriesInstanceUID:o.uid,StudyInstanceUID:r.StudyInstanceUID,SeriesNumber:r.SeriesNumber||0,SOPClassUID:r.SOPClassUID,SeriesDescription:`${n.SeriesDescription} KO ${n.instance.SeriesNumber}`,Modality:"KO",isMultiFrame:!1,numImageFrames:t.length,SOPClassHandlerId:"@ohif/extension-default.sopClassHandlerModule.stack",isReconstructable:!1,isCompositeStack:!0,madeInClient:!0,excludeFromThumbnailBrowser:!0,updateInstances:function(){this.images.splice(0,this.images.length,...i(e,n)),this.numImageFrames=this.images.length}}),e.addDisplaySets(o),o}}}]);
//# sourceMappingURL=4113.bundle.bf3151f7c4ef4880bbb4.js.map