"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[1604],{65090:(e,t,i)=>{i.r(t),i.d(t,{default:()=>Q});const n=JSON.parse('{"UU":"@ohif/extension-dicom-microscopy"}').UU;var o=i(86326),r=i(96283),s=i(39548),a=i(42356),c=i(99993),d=i(55807);function l(e,t){let i=!1;Array.isArray(e[0])||(e=[e],i=!0);const n=t[t.length-1],o=n.ImageOrientationSlide,r=function(e){if(e.PixelSpacing)return e.PixelSpacing;const t=e.SharedFunctionalGroupsSequence[0];return t.PixelMeasuresSequence[0].PixelSpacing}(n),s=n.TotalPixelMatrixOriginSequence[0],a=[Number(s.XOffsetInSlideCoordinateSystem),Number(s.YOffsetInSlideCoordinateSystem)];return e=e.map(e=>{const t=[e[0],e[1]],i=function(e){if(!("offset"in e))throw new Error('Option "offset" is required.');if(!Array.isArray(e.offset))throw new Error('Option "offset" must be an array.');if(2!==e.offset.length)throw new Error('Option "offset" must be an array with 2 elements.');const t=e.offset;if(!("orientation"in e))throw new Error('Option "orientation" is required.');if(!Array.isArray(e.orientation))throw new Error('Option "orientation" must be an array.');if(6!==e.orientation.length)throw new Error('Option "orientation" must be an array with 6 elements.');const i=e.orientation;if(!("spacing"in e))throw new Error('Option "spacing" is required.');if(!Array.isArray(e.spacing))throw new Error('Option "spacing" must be an array.');if(2!==e.spacing.length)throw new Error('Option "spacing" must be an array with 2 elements.');const n=e.spacing;if(!("point"in e))throw new Error('Option "point" is required.');if(!Array.isArray(e.point))throw new Error('Option "point" must be an array.');if(2!==e.point.length)throw new Error('Option "point" must be an array with 2 elements.');const o=e.point,r=[[i[0]*n[1],i[3]*n[0],t[0]],[i[1]*n[1],i[4]*n[0],t[1]],[0,0,1]],s=(0,d.WCD)(r),a=[[o[0]],[o[1]],[1]],c=(0,d.lwT)(s,a),l=Number(c[1][0].toFixed(4));return[Number(c[0][0].toFixed(4)),l]}({offset:a,orientation:o,spacing:r,point:t});return[i[0],-(i[1]+1),0]}),i?e[0]:e}const u={color:"rgba(255,255,255,0.4)"},h={color:"rgba(255,255,255,0.0)"},p={color:"rgb(0,255,0)",width:1.5},m={color:"rgb(255,255,0)",width:1.5},g={active:{image:{circle:{fill:u,stroke:m,radius:5}},fill:u,stroke:m},default:{image:{circle:{fill:h,stroke:p,radius:5}},fill:h,stroke:p}},I={ROI_ADDED:"dicommicroscopyviewer_roi_added",ROI_MODIFIED:"dicommicroscopyviewer_roi_modified",ROI_REMOVED:"dicommicroscopyviewer_roi_removed",ROI_DRAWN:"dicommicroscopyviewer_roi_drawn",ROI_SELECTED:"dicommicroscopyviewer_roi_selected",MOVE_STARTED:"dicommicroscopyviewer_move_started",MOVE_ENDED:"dicommicroscopyviewer_move_ended",LOADING_STARTED:"dicommicroscopyviewer_loading_started",LOADING_ENDED:"dicommicroscopyviewer_loading_ended",LOADING_ERROR:"dicommicroscopyviewer_loading_error",FRAME_LOADING_STARTED:"dicommicroscopyviewer_frame_loading_started",FRAME_LOADING_ENDED:"dicommicroscopyviewer_frame_loading_ended",FRAME_LOADING_ERROR:"dicommicroscopyviewer_frame_loading_ended"},S={ADDED:"added",MODIFIED:"modified",REMOVED:"removed",UPDATED:"updated",SELECTED:"selected"};class f extends a.Rc{constructor(e,t,i,n,o){super(S),this.viewer=e,this.viewportId=t,this.container=i,this.studyInstanceUID=n,this.seriesInstanceUID=o,this.onRoiAdded=this.roiAddedHandler.bind(this),this.onRoiModified=this.roiModifiedHandler.bind(this),this.onRoiRemoved=this.roiRemovedHandler.bind(this),this.onRoiSelected=this.roiSelectedHandler.bind(this),this.contextMenuCallback=()=>{};const r=Object.getOwnPropertySymbols(this.viewer);this._drawingSource=r.find(e=>"drawingSource"===e.description),this._pyramid=r.find(e=>"pyramid"===e.description),this._map=r.find(e=>"map"===e.description),this._affine=r.find(e=>"affine"===e.description),this.registerEvents(),this.activateDefaultInteractions()}addContextMenuCallback(e){this.contextMenuCallback=e}destroy(){this.unregisterEvents()}publish(e,t){this._broadcastEvent(e,{roiGraphic:t,managedViewer:this})}registerEvents(){this.container.addEventListener(I.ROI_ADDED,this.onRoiAdded),this.container.addEventListener(I.ROI_MODIFIED,this.onRoiModified),this.container.addEventListener(I.ROI_REMOVED,this.onRoiRemoved),this.container.addEventListener(I.ROI_SELECTED,this.onRoiSelected)}unregisterEvents(){this.container.removeEventListener(I.ROI_ADDED,this.onRoiAdded),this.container.removeEventListener(I.ROI_MODIFIED,this.onRoiModified),this.container.removeEventListener(I.ROI_REMOVED,this.onRoiRemoved),this.container.removeEventListener(I.ROI_SELECTED,this.onRoiSelected)}roiAddedHandler(e){const t=e.detail.payload;this.publish(S.ADDED,t),this.publish(S.UPDATED,t)}roiModifiedHandler(e){const t=e.detail.payload;this.publish(S.MODIFIED,t),this.publish(S.UPDATED,t)}roiRemovedHandler(e){const t=e.detail.payload;this.publish(S.REMOVED,t),this.publish(S.UPDATED,t)}roiSelectedHandler(e){const t=e.detail.payload;this.publish(S.SELECTED,t)}runSilently(e){this.unregisterEvents(),e(),this.registerEvents()}clearRoiGraphics(){this.runSilently(()=>this.viewer.removeAllROIs())}showROIs(){this.viewer.showROIs()}hideROIs(){this.viewer.hideROIs()}addRoiGraphic(e){this.runSilently(()=>this.viewer.addROI(e,g.default))}addRoiGraphicWithLabel(e,t){this.runSilently(()=>this.viewer.addROI(e,g.default)),this._broadcastEvent(S.ADDED,{roiGraphic:e,managedViewer:this,label:t})}setROIStyle(e,t){this.viewer.setROIStyle(e,t)}removeRoiGraphic(e){this.viewer.removeROI(e)}updateROIProperties({uid:e,properties:t}){this.viewer.updateROI({uid:e,properties:t})}toggleOverviewMap(){this.viewer.toggleOverviewMap()}activateDefaultInteractions(){document.querySelector(".DicomMicroscopyViewer").addEventListener("contextmenu",e=>{e.preventDefault()},!1);this.activateInteractions([["dragPan",{bindings:{mouseButtons:["middle"]}}],["dragZoom",{bindings:{mouseButtons:["right"]}}],["modify",{}]])}activateInteractions(e){const t={draw:e=>e?"activateDrawInteraction":"deactivateDrawInteraction",modify:e=>e?"activateModifyInteraction":"deactivateModifyInteraction",translate:e=>e?"activateTranslateInteraction":"deactivateTranslateInteraction",snap:e=>e?"activateSnapInteraction":"deactivateSnapInteraction",dragPan:e=>e?"activateDragPanInteraction":"deactivateDragPanInteraction",dragZoom:e=>e?"activateDragZoomInteraction":"deactivateDragZoomInteraction",select:e=>e?"activateSelectInteraction":"deactivateSelectInteraction"};Object.keys(t).forEach(i=>{const n=e.find(e=>e[0]===i);if(n){const[e,i]=n,o=t[e](!0);this.viewer[o](i)}else{const e=t[i](!1);this.viewer[e]()}})}_getMapView(){return this._getMap().getView()}_getMap(){const e=Object.getOwnPropertySymbols(this.viewer).find(e=>"Symbol(map)"===String(e));return window.map=this.viewer[e],this.viewer[e]}getViewState(){const e=this._getMapView();return{center:e.getCenter(),resolution:e.getResolution(),zoom:e.getZoom()}}setViewState(e){const t=this._getMapView();t.setZoom(e.zoom),t.setResolution(e.resolution),t.setCenter(e.center)}setViewStateByExtent(e){const t=e.getCoordinates();Array.isArray(t[0])&&!t[2]?this._jumpToPolyline(t):Array.isArray(t[0])?this._jumpToPolygonOrEllipse(t):this._jumpToPoint(t)}_jumpToPoint(e){const t=l(e,this.viewer[this._pyramid].metadata);this._getMapView().setCenter(t)}_jumpToPolyline(e){const t=l(e,this.viewer[this._pyramid].metadata),i=this._getMapView(),n=t[0],o=t[1],r=[(n[0]+o[0])/2,(n[1]+o[1])/2];i.setCenter(r)}_jumpToPolygonOrEllipse(e){const t=this.viewer[this._pyramid].metadata;let i=1/0,n=-1/0,o=1/0,r=-1/0;e.forEach(e=>{let s=l(e,t);const[a,c]=s;a<i?i=a:a>n&&(n=a),c<o?o=c:c>r&&(r=c)});const s=n-i,a=r-o;i-=.5*s,n+=.5*s,o-=.5*a,r+=.5*a;const c=this._getMap();c.getView().fit([i,o,n,r],c.getSize())}}const v=f;const E={LABEL_UPDATED:"labelUpdated",GRAPHIC_UPDATED:"graphicUpdated",VIEW_UPDATED:"viewUpdated",REMOVED:"removed"};class y extends a.Rc{constructor(e,t,i,n="",o=null){super(E),this.uid=e.uid,this.roiGraphic=e,this.studyInstanceUID=t,this.seriesInstanceUID=i,this.label=n,this.viewState=o,this.setMeasurements(e)}getScoord3d(){const e=this.roiGraphic;return e[Object.getOwnPropertySymbols(e).find(e=>"Symbol(scoord3d)"===String(e))]}getCoordinates(){const e=this.getScoord3d();return e[Object.getOwnPropertySymbols(e).find(e=>"Symbol(coordinates)"===String(e))]}destroy(){this._broadcastEvent(E.REMOVED,this)}setRoiGraphic(e){this.roiGraphic=e,this.setMeasurements(),this._broadcastEvent(E.GRAPHIC_UPDATED,this)}setMeasurements(){const e=this.roiGraphic.scoord3d.graphicType,t=this.roiGraphic.scoord3d.graphicData;switch(e){case"ELLIPSE":const e=t[0],i=t[1];let n=i[0]-e[0],o=i[1]-e[1];n*=n,o*=o;const r=Math.sqrt(n+o)/2,s=Math.PI*r*r;this._area=s,this._length=void 0;break;case"POLYGON":const a=function(e){const t=e.length;let i=0,n=t-1;for(let o=0;o<t;o++)i+=(e[n][0]+e[o][0])*(e[n][1]-e[o][1]),n=o;return Math.abs(i/2)}(t);this._area=a,this._length=void 0;break;case"POINT":this._area=void 0,this._length=void 0;break;case"POLYLINE":let c=0;for(let e=1;e<t.length;e++){const i=t[e-1],n=t[e];let o=n[0]-i[0],r=n[1]-i[1];o*=o,r*=r,c+=Math.sqrt(o+r)}this._area=void 0,this._length=c}}setViewState(e){this.viewState=e,this._broadcastEvent(E.VIEW_UPDATED,this)}setLabel(e,t){this.label=e||t&&t.CodeMeaning,this.finding=t||{CodingSchemeDesignator:"@ohif/extension-dicom-microscopy",CodeValue:e,CodeMeaning:e},this._broadcastEvent(E.LABEL_UPDATED,this)}getLabel(){return this.label?`${this.label}`:""}getDetailedLabel(){return this.label?`${this.label}`:"(empty)"}getLength(){return this._length}getArea(){return this._area}}const D=y;var w;const A={ANNOTATION_UPDATED:"annotationUpdated",ANNOTATION_SELECTED:"annotationSelected",ANNOTATION_REMOVED:"annotationRemoved",RELABEL:"relabel",DELETE:"delete"};class b extends a.Rc{constructor({servicesManager:e,extensionManager:t}){super(A),this.servicesManager=void 0,this.managedViewers=new Set,this.roiUids=new Set,this.annotations={},this.selectedAnnotation=null,this.pendingFocus=!1,this.servicesManager=e,this.peerImport=t.appConfig.peerImport,this._onRoiAdded=this._onRoiAdded.bind(this),this._onRoiModified=this._onRoiModified.bind(this),this._onRoiRemoved=this._onRoiRemoved.bind(this),this._onRoiUpdated=this._onRoiUpdated.bind(this),this._onRoiSelected=this._onRoiSelected.bind(this),this.isROIsVisible=!0}clear(){this.managedViewers.forEach(e=>e.destroy()),this.managedViewers.clear();for(const e in this.annotations)delete this.annotations[e];this.roiUids.clear(),this.selectedAnnotation=null,this.pendingFocus=!1}clearAnnotations(){Object.keys(this.annotations).forEach(e=>{this.removeAnnotation(this.annotations[e])})}importDicomMicroscopyViewer(){return this.peerImport("dicom-microscopy-viewer")}_onRoiAdded(e){const{roiGraphic:t,managedViewer:i,label:n}=e,{studyInstanceUID:o,seriesInstanceUID:r}=i,s=i.getViewState(),a=new D(t,o,r,"",s);if(this.roiUids.add(t.uid),this.annotations[t.uid]=a,a.subscribe(E.LABEL_UPDATED,()=>{this._broadcastEvent(A.ANNOTATION_UPDATED,a)}),void 0!==n)a.setLabel(n);else{const e=e=>i.updateROIProperties({uid:t.uid,properties:{label:e.label,finding:e.finding}});this.triggerRelabel(a,!0,e)}}_onRoiModified(e){const{roiGraphic:t,managedViewer:i}=e,n=this.getAnnotation(t.uid);n&&(n.setRoiGraphic(t),n.setViewState(i.getViewState()))}_onRoiRemoved(e){const{roiGraphic:t}=e;this.roiUids.delete(t.uid),this.annotations[t.uid].destroy(),delete this.annotations[t.uid],this._broadcastEvent(A.ANNOTATION_REMOVED,t)}_onRoiUpdated(e){const{roiGraphic:t,managedViewer:i}=e;this.synchronizeViewers(i),this._broadcastEvent(A.ANNOTATION_UPDATED,this.getAnnotation(t.uid))}_onRoiSelected(e){const{roiGraphic:t}=e,i=this.getAnnotation(t.uid);i&&i!==this.getSelectedAnnotation()&&(this.selectedAnnotation&&this.clearSelection(),this.selectedAnnotation=i,this._broadcastEvent(A.ANNOTATION_SELECTED,i))}_addManagedViewerSubscriptions(e){e._roiAddedSubscription=e.subscribe(S.ADDED,this._onRoiAdded),e._roiModifiedSubscription=e.subscribe(S.MODIFIED,this._onRoiModified),e._roiRemovedSubscription=e.subscribe(S.REMOVED,this._onRoiRemoved),e._roiUpdatedSubscription=e.subscribe(S.UPDATED,this._onRoiUpdated),e._roiSelectedSubscription=e.subscribe(S.UPDATED,this._onRoiSelected)}_removeManagedViewerSubscriptions(e){e._roiAddedSubscription&&e._roiAddedSubscription.unsubscribe(),e._roiModifiedSubscription&&e._roiModifiedSubscription.unsubscribe(),e._roiRemovedSubscription&&e._roiRemovedSubscription.unsubscribe(),e._roiUpdatedSubscription&&e._roiUpdatedSubscription.unsubscribe(),e._roiSelectedSubscription&&e._roiSelectedSubscription.unsubscribe(),e._roiAddedSubscription=null,e._roiModifiedSubscription=null,e._roiRemovedSubscription=null,e._roiUpdatedSubscription=null,e._roiSelectedSubscription=null}_getManagedViewersForSeries(e,t){return Array.from(this.managedViewers).filter(i=>i.studyInstanceUID===e&&i.seriesInstanceUID===t)}getManagedViewersForStudy(e){return Array.from(this.managedViewers).filter(t=>t.studyInstanceUID===e)}getManagedViewersForViewport(e){return Array.from(this.managedViewers).filter(t=>t.viewportId===e)}_restoreAnnotations(e){const{studyInstanceUID:t,seriesInstanceUID:i}=e;this.getAnnotationsForSeries(t,i).forEach(t=>{e.addRoiGraphic(t.roiGraphic)})}addViewer(e,t,i,n,o){const r=Array.from(this.managedViewers).find(e=>e.viewportId===t);r&&this.removeViewer(r.viewer);const s=new v(e,t,i,n,o);return this._restoreAnnotations(s),e._manager=s,this.managedViewers.add(s),this._addManagedViewerSubscriptions(s),this.pendingFocus&&(this.pendingFocus=!1,this.focusAnnotation(this.selectedAnnotation,t)),s}_potentiallyLoadSR(e,t){const i=a.H8.getStudy(e),n=t.find(e=>"SM"===e.Modality),{FrameOfReferenceUID:o,othersFrameOfReferenceUID:r}=n;if(!i)return;let s=o?t.filter(e=>e.ReferencedFrameOfReferenceUID===o||r.includes(e.ReferencedFrameOfReferenceUID)):[];if(!s.length)return;if(s=s.filter(e=>"SR"===e.Modality),s.some(e=>!0===e.isLoaded))return;let c=0,d=s[0];s.forEach(e=>{const t=Number(`${e.SeriesDate}${e.SeriesTime}`);t>c&&(c=t,d=e)}),d.isLoading||(d.isLoading=!0,d.load(n))}removeViewer(e){const t=e._manager;this._removeManagedViewerSubscriptions(t),t.destroy(),this.managedViewers.delete(t)}toggleROIsVisibility(){this.isROIsVisible?this.hideROIs():this.showROIs,this.isROIsVisible=!this.isROIsVisible}hideROIs(){this.managedViewers.forEach(e=>e.hideROIs())}showROIs(){this.managedViewers.forEach(e=>e.showROIs())}getAnnotation(e){return this.annotations[e]}getAnnotations(){const e=[];return Object.keys(this.annotations).forEach(t=>{e.push(this.getAnnotation(t))}),e}getAnnotationsForStudy(e){return this.getAnnotations().filter(t=>t.studyInstanceUID===e)}getAnnotationsForSeries(e,t){return this.getAnnotations().filter(i=>i.studyInstanceUID===e&&i.seriesInstanceUID===t)}getSelectedAnnotation(){return this.selectedAnnotation}clearSelection(){this.selectedAnnotation&&this.setROIStyle(this.selectedAnnotation.uid,{stroke:{color:"#00ff00"}}),this.selectedAnnotation=null}selectAnnotation(e){this.selectedAnnotation&&this.clearSelection(),this.selectedAnnotation=e,this._broadcastEvent(A.ANNOTATION_SELECTED,e),this.setROIStyle(e.uid,g.active)}toggleOverviewMap(e){const t=Array.from(this.managedViewers).find(t=>t.viewportId===e);t&&t.toggleOverviewMap()}removeAnnotation(e){const{uid:t,studyInstanceUID:i,seriesInstanceUID:n}=e;Array.from(this.managedViewers).filter(e=>e.studyInstanceUID===i&&e.seriesInstanceUID===n).forEach(e=>e.removeRoiGraphic(t)),this.annotations[t]&&(this.roiUids.delete(t),this.annotations[t].destroy(),delete this.annotations[t],this._broadcastEvent(A.ANNOTATION_REMOVED,e))}focusAnnotation(e,t){const i=Array.from(this.managedViewers).find(e=>e.viewportId===t);i?i.setViewStateByExtent(e):this.pendingFocus=!0}synchronizeViewers(e){const{studyInstanceUID:t,seriesInstanceUID:i}=e,n=this._getManagedViewersForSeries(t,i);n.forEach(e=>this._removeManagedViewerSubscriptions(e)),n.forEach(n=>{if(n===e)return;const o=this.getAnnotationsForSeries(t,i);n.clearRoiGraphics(),o.forEach(e=>{n.addRoiGraphic(e.roiGraphic)})}),n.forEach(e=>this._addManagedViewerSubscriptions(e))}activateInteractions(e){this.managedViewers.forEach(t=>t.activateInteractions(e)),this.activeInteractions=e}getActiveInteractions(){return this.activeInteractions}triggerRelabel(e,t=!1,i){i||(i=({label:t})=>this.managedViewers.forEach(i=>i.updateROIProperties({uid:e.uid,properties:{label:t}}))),this._broadcastEvent(A.RELABEL,{roiAnnotation:e,deleteCallback:()=>this.removeAnnotation(e),successCallback:i,newAnnotation:t})}triggerDelete(e){this._broadcastEvent(A.DELETE,e)}setROIStyle(e,t){this.managedViewers.forEach(i=>i.setROIStyle(e,t))}getAllManagedViewers(){return Array.from(this.managedViewers)}}w=b,b.REGISTRATION=e=>({name:"microscopyService",altName:"MicroscopyService",create:e=>new w(e)});var R=i(5842);const{datasetToBuffer:O}=R.Ay.data,_=(e,t)=>{let i=1;if("km"==t||!t&&e>1e6)t="km",i=1e-6;else if("m"==t||!t&&e>1e3)t="m",i=.001;else if("μm"==t||!t&&e<1)t="μm",i=1e3;else{if(t&&"mm"!=t)throw new Error(`Unknown length unit ${t}`);t="mm"}return`${(e*i).toFixed(2)} ${t}`};const M=(0,c.CI)(["MicroscopyTable","Common"])(function(e){const{microscopyService:t}=e.servicesManager.services,[i,n]=(0,o.useState)(null),[s,a]=(0,o.useState)([]),[c,d]=(0,o.useState)(null),{servicesManager:l,extensionManager:u}=e,{uiDialogService:h,displaySetService:p}=l.services;(0,o.useEffect)(()=>{const t=e.viewports.get(e.activeViewportId);if(t?.displaySetInstanceUIDs[0]){const e=p.getDisplaySetByUID(t.displaySetInstanceUIDs[0]);e&&n(e.StudyInstanceUID)}},[e.viewports,e.activeViewportId]),(0,o.useEffect)(()=>{const e=()=>{const e=t.getAnnotationsForStudy(i);a(e)},n=()=>{const e=t.getSelectedAnnotation();d(e)},{unsubscribe:o}=t.subscribe(A.ANNOTATION_UPDATED,e),{unsubscribe:r}=t.subscribe(A.ANNOTATION_SELECTED,n),{unsubscribe:s}=t.subscribe(A.ANNOTATION_REMOVED,()=>{e()});return e(),n(),()=>{o(),r(),s()}},[i]);const m=s.map((e,t)=>{const i=e.getDetailedLabel(),n=e.getArea(),o=e.getLength(),r=e.roiGraphic.properties.shortAxisLength,s=c===e,{uid:a}=e,d=[];return void 0!==n?d.push((e=>{let t=1,i="mm";return e>1e6?(i="m",t=1e-6):e<1&&(i="μm",t=1e6),`${(e*t).toFixed(2)} ${i}²`})(n)):void 0!==o&&d.push(r?`${_(o,"μm")} x ${_(r,"μm")}`:`${_(o,"μm")}`),{uid:a,index:t,label:i,isActive:s,displayText:d,roiAnnotation:e}});return o.createElement(o.Fragment,null,o.createElement("div",{className:"ohif-scrollbar overflow-y-auto overflow-x-hidden","data-cy":"measurements-panel"},o.createElement("div",{className:"flex flex-col"},m.map(i=>o.createElement(r.x3Y,{key:i.uid,number:i.index+1,title:i.label,isSelected:i.isActive,onSelect:()=>(({uid:i})=>{const n=t.getAnnotation(i);t.selectAnnotation(n),t.focusAnnotation(n,e.activeViewportId)})({uid:i.uid}),details:{primary:i.displayText,secondary:[]},isVisible:!0,onToggleVisibility:()=>{},isLocked:!1,onToggleLocked:()=>{},onRename:()=>(({uid:t,isActive:i})=>{e.commandsManager.runCommand("setLabel",{uid:t},"MICROSCOPY")})({uid:i.uid,isActive:i.isActive}),onDelete:()=>(({uid:e,isActive:i})=>{const n=t.getAnnotation(e);t.removeAnnotation(n)})({uid:i.uid,isActive:i.isActive}),onColor:()=>{},disableEditing:!1,description:i.displayText.join(", ")})))))}),U=M;const N={IMAGING_MEASUREMENTS:"126010",MEASUREMENT_GROUP:"125007",IMAGE_REGION:"111030",FINDING:"121071",TRACKING_UNIQUE_IDENTIFIER:"112039",LENGTH:"410668003",AREA:"42798000",SHORT_AXIS:"G-A186",LONG_AXIS:"G-A185",ELLIPSE_AREA:"G-D7FE",ANNOTATION:"121071",ANNOTATION_GROUP:"121072",ANNOTATION_LABEL:"121073"};function C(e){return Array.isArray(e)?e:[e]}const T=R.Ay.adapters.DICOMMicroscopyViewer.MeasurementReport;async function V(e,t,i){const n=t.metadata,{StudyInstanceUID:o,FrameOfReferenceUID:r}=i,s=e.getManagedViewersForStudy(o);if(!s||!s.length)return;t.isLoaded=!0;const{rois:a,labels:c}=await async function(e,t,i){const n=T.generateToolState(t),o=Object.getOwnPropertyNames(n),r=await e.importDicomMicroscopyViewer(),s=function(e){const{ContentSequence:t}=e,i=C(t.find(e=>e.ConceptNameCodeSequence.CodeValue===N.IMAGING_MEASUREMENTS).ContentSequence).filter(e=>e.ConceptNameCodeSequence.CodeValue===N.MEASUREMENT_GROUP);return i}(t),a=[],c=[];return o.forEach(e=>{const t=n[e];let o;const d=e.toUpperCase(),l=s.filter(e=>C(e.ContentSequence).find(e=>e.ConceptNameCodeSequence.CodeValue===N.IMAGE_REGION).GraphicType===d);t.forEach((t,n)=>{const s={},d={coordinates:t,frameOfReferenceUID:i};if("Polygon"===e)o=new r.scoord3d.Polygon(d);else if("Polyline"===e)o=new r.scoord3d.Polyline(d);else if("Point"===e)o=new r.scoord3d.Point(d);else{if("Ellipse"!==e)throw new Error("Unsupported tool type");o=new r.scoord3d.Ellipse(d)}const u=l[n],h=C(u.ContentSequence).find(e=>e.ConceptNameCodeSequence.CodeValue===N.FINDING),p=C(u.ContentSequence).find(e=>e.ConceptNameCodeSequence.CodeValue===N.TRACKING_UNIQUE_IDENTIFIER);if(p){const e=/\(([^)]+)\)/.exec(p.TextValue);e&&e[1]&&(s.presentationState=JSON.parse(e[1]),s.marker=s.presentationState.marker)}let m=C(u.ContentSequence).filter(e=>[N.LENGTH,N.AREA,N.SHORT_AXIS,N.LONG_AXIS,N.ELLIPSE_AREA].includes(e.ConceptNameCodeSequence.CodeValue)),g=C(u.ContentSequence).filter(e=>[N.TRACKING_UNIQUE_IDENTIFIER].includes(e.ConceptNameCodeSequence.CodeValue));g=g.map(e=>{const t={...e};return t.ConceptNameCodeSequence=C(t.ConceptNameCodeSequence),t}),m=m.map(e=>{const t={...e};return t.ConceptNameCodeSequence=C(t.ConceptNameCodeSequence),t}),m&&m.length&&(s.measurements=m,console.log("[SR] retrieving measurements...",m)),g&&g.length&&(s.evaluations=g,console.log("[SR] retrieving evaluations...",g));const I=new r.roi.ROI({scoord3d:o,properties:s});a.push(I),h?c.push(h.ConceptCodeSequence.CodeValue):c.push("")})}),{rois:a,labels:c}}(e,n,r),d=s[0];for(let e=0;e<a.length;e++){const t=a[e];t[Object.getOwnPropertySymbols(t).find(e=>"properties"===e.description)].evaluations=[],d.addRoiGraphicWithLabel(t,c[e])}}function L(e,t){const{ReferencedFrameOfReferenceUID:i,metadata:n}=t;if(n.ReferencedSeriesSequence){const{ReferencedSeriesSequence:t}=n,i=t[0],{SeriesInstanceUID:o}=i;return e.filter(e=>e.SeriesInstanceUID===o)[0]}const o=e.filter(e=>e.displaySetInstanceUID!==t.displaySetInstanceUID),r=o.find(e=>"SM"===e.Modality&&(e.FrameOfReferenceUID===i||e.othersFrameOfReferenceUID.includes(i)));return!r&&o.length>=1?(console.warn("No display set with FrameOfReferenceUID",i,"single series, assuming data error, defaulting to only series."),o.find(e=>"SM"===e.Modality)):r}const{utils:P}=a.Ay,G="1.2.840.10008.5.1.4.1.1.88.34";function x(e,t,i){if(!e||!e.length)throw new Error("No instances were provided");const{displaySetService:n,microscopyService:o}=t.services,r=e[0],s=a.H8.getSeries(r.StudyInstanceUID,r.SeriesInstanceUID).instances[0],c=function(e){const{ContentSequence:t}=e,i=C(t.find(e=>e.ConceptNameCodeSequence.CodeValue===N.IMAGING_MEASUREMENTS).ContentSequence).find(e=>e.ConceptNameCodeSequence.CodeValue===N.MEASUREMENT_GROUP);return C(i.ContentSequence).find(e=>e.ConceptNameCodeSequence.CodeValue===N.IMAGE_REGION).ReferencedFrameOfReferenceUID}(s),{FrameOfReferenceUID:d,SeriesDescription:l,ContentDate:u,ContentTime:h,SeriesNumber:p,StudyInstanceUID:m,SeriesInstanceUID:g,SOPInstanceUID:I,SOPClassUID:S}=r,f={isOverlayDisplaySet:!0,plugin:"microscopy",Modality:"SR",altImageText:"Microscopy SR",displaySetInstanceUID:P.guid(),SOPInstanceUID:I,SeriesInstanceUID:g,StudyInstanceUID:m,ReferencedFrameOfReferenceUID:c,SOPClassHandlerId:"@ohif/extension-dicom-microscopy.sopClassHandlerModule.DicomMicroscopySRSopClassHandler",SOPClassUID:S,SeriesDescription:l,SeriesDate:u,SeriesTime:h,SeriesNumber:p,instance:r,metadata:s,isDerived:!0,isLoading:!1,isLoaded:!1,loadError:!1,load:function(e){return V(o,f,e).catch(e=>{throw f.isLoaded=!1,f.loadError=!0,new Error(e)})},getSourceDisplaySet:function(){let e=[];return a.H8.getStudy(m).series.forEach(t=>{const i=n.getDisplaySetsForSeries(t.SeriesInstanceUID);e=e.concat(i)}),L(e,f)}};return[f]}function F({servicesManager:e,extensionManager:t}){return{name:"DicomMicroscopySRSopClassHandler",sopClassUids:[G],getDisplaySetsFromSeries:t=>x(t,e)}}var q=i(70956);const{utils:k}=a.Ay,H="1.2.840.10008.5.1.4.1.1.91.1";function j(e,t,i){if(!e||!e.length)throw new Error("No instances were provided");const{displaySetService:n,microscopyService:o}=t.services,r=[...e].sort((e,t)=>{const i=`${e.ContentDate}${e.ContentTime}`,n=`${t.ContentDate}${t.ContentTime}`;return i.localeCompare(n)}),s=r[r.length-1],c=a.H8.getSeries(s.StudyInstanceUID,s.SeriesInstanceUID).instances[0],{SeriesDescription:d,ContentDate:l,ContentTime:u,SeriesNumber:h,StudyInstanceUID:p,SeriesInstanceUID:m,SOPInstanceUID:g,SOPClassUID:I}=s,S={isOverlayDisplaySet:!0,plugin:"microscopy",Modality:"ANN",thumbnailSrc:null,altImageText:"Microscopy Annotation",displaySetInstanceUID:k.uuidv4(),SOPInstanceUID:g,SeriesInstanceUID:m,StudyInstanceUID:p,SOPClassHandlerId:"@ohif/extension-dicom-microscopy.sopClassHandlerModule.DicomMicroscopyANNSopClassHandler",SOPClassUID:I,SeriesDescription:d,SeriesDate:l,SeriesTime:u,SeriesNumber:h,instance:s,metadata:c,isDerived:!0,isLoading:!1,isLoaded:!1,loadError:!1};return S.load=function(){return function({microscopyService:e,displaySet:t,extensionManager:i,servicesManager:n}){const{uiNotificationService:o}=n.services;return new Promise(async(r,s)=>{try{t.isLoading=!0;const{metadata:s}=t,a=await e.importDicomMicroscopyViewer(),c=(0,q.A)({extensionManager:i,servicesManager:n}),d=n.services.viewportGridService.getActiveViewportId(),l=e.getManagedViewersForViewport(d)[0];c.retrieveSeriesMetadata({studyInstanceUID:s.StudyInstanceUID,seriesInstanceUID:s.SeriesInstanceUID}).then(async e=>{const i=e.map(e=>new a.metadata.MicroscopyBulkSimpleAnnotations({metadata:e}));o.show({message:"Loading annotations...",type:"info"}),await Promise.all(i.map(async e=>{try{await l.viewer.addAnnotationGroups(e),e.AnnotationGroupSequence.forEach(e=>{const t=e.AnnotationGroupUID;l.viewer.setAnnotationGroupStyle(t,{color:[255,234,0]})}),e.AnnotationGroupSequence.forEach(e=>{const t=e.AnnotationGroupUID;l.viewer.showAnnotationGroup(t)})}catch(e){console.error("failed to add annotation groups:",e),o.show({title:"Error loading annotations",message:e.message,type:"error"})}})),t.isLoaded=!0,t.isLoading=!1,r(t)})}catch(e){console.error("Error loading annotation:",e),s(e)}})}({microscopyService:o,displaySet:S,extensionManager:i,servicesManager:t}).catch(e=>{throw S.isLoaded=!1,S.loadError=!0,new Error(e)})},S.getSourceDisplaySet=function(){let e=[];a.H8.getStudy(p).series.forEach(t=>{const i=n.getDisplaySetsForSeries(t.SeriesInstanceUID);e=e.concat(i)});return L(e,S)},[S]}function B({servicesManager:e,extensionManager:t}){return{name:"DicomMicroscopyANNSopClassHandler",sopClassUids:[H],getDisplaySetsFromSeries:i=>j(i,e,t)}}var $=i(81980),W=i(62051),z=i.n(W);function Y(){return Y=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)({}).hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},Y.apply(null,arguments)}const Z=o.lazy(()=>i.e(5802).then(i.bind(i,85802))),X=e=>o.createElement(o.Suspense,{fallback:o.createElement("div",null,"Loading...")},o.createElement(Z,e)),K={id:n,async preRegistration({servicesManager:e}){e.registerService(b.REGISTRATION(e))},getViewportModule:({servicesManager:e})=>[{name:"microscopy-dicom",component:t=>{const{viewportOptions:i}=t,[n,s]=(0,r.ihW)(),{activeViewportId:a}=n,c=(0,o.useMemo)(()=>t.displaySets.map(e=>e.displaySetInstanceUID).join("-"),[t.displaySets]),d=z()(()=>{const{microscopyService:t}=e.services,i=t.getAllManagedViewers();i&&i.length>0&&i[0].viewer.resize()},100),{ref:l}=(0,$.u)({onResize:d,handleHeight:!0,handleWidth:!0});return o.createElement(X,Y({key:c,activeViewportId:a,setViewportActive:e=>{s.setActiveViewportId(e)},viewportData:i,resizeRef:l},t))}}],getToolbarModule:({servicesManager:e})=>[{name:"evaluate.microscopyTool",evaluate:({button:t})=>{const{microscopyService:i}=e.services,n=i.getActiveInteractions();if(!n)return!1;const o=n.find(e=>{if(!e[1].bindings.mouseButtons.includes("left"))return!1;return"draw"!==e[0]?e[0]===t.id:e[1].geometryType===t.id});return{disabled:!1,className:o?"!text-black bg-primary-light":"!text-common-bright hover:!bg-[rgb(var(--primary-dark))] hover:!text-primary-light",isActive:o}}}],getSopClassHandlerModule:e=>[F(e),B(e)],getPanelModule:function({commandsManager:e,extensionManager:t,servicesManager:i}){return[{name:"measure",iconName:"tab-linear",iconLabel:"Measure",label:"Measurements",secondaryLabel:"Measurements",component:({})=>{const[{activeViewportId:n,viewports:s}]=(0,r.ihW)();return o.createElement(U,{viewports:s,activeViewportId:n,onSaveComplete:()=>{},onRejectComplete:()=>{},commandsManager:e,servicesManager:i,extensionManager:t})}}]},getCommandsModule:function({servicesManager:e,commandsManager:t,extensionManager:i}){const{viewportGridService:n,uiDialogService:o,microscopyService:r}=e.services,a={deleteMeasurement:({uid:e})=>{if(e){const t=r.getAnnotation(e);t&&r.removeAnnotation(t)}},setLabel:({uid:e})=>{const t=r.getAnnotation(e);(0,s.callInputDialog)({uiDialogService:o,defaultValue:"",onSave:e=>{t.setLabel(e),r.triggerRelabel(t)}})},setToolActive:({toolName:e,toolGroupId:t="MICROSCOPY"})=>{const i=["dragPan",{bindings:{mouseButtons:["middle"]}}],n=["dragZoom",{bindings:{mouseButtons:["right"]}}];if(["line","box","circle","point","polygon","freehandpolygon","freehandline"].indexOf(e)>=0){const t={geometryType:e,vertexEnabled:!0,styleOptions:g.default,bindings:{mouseButtons:["left"]}};"line"===e?(t.minPoints=2,t.maxPoints=2):"point"===e&&(delete t.styleOptions,delete t.vertexEnabled),r.activateInteractions([["draw",t],i,n])}else"dragPan"==e?r.activateInteractions([["dragPan",{bindings:{mouseButtons:["left","middle"]}}],n]):r.activateInteractions([[e,{bindings:{mouseButtons:["left"]}}],i,n])},toggleOverlays:()=>{const e=document.getElementsByClassName("microscopy-viewport-overlay");let t=!1;for(let i=0;i<e.length;i++)0===i&&(t=e.item(0).classList.contains("hidden")),e.item(i).classList.toggle("hidden");const{activeViewportId:i}=n.getState();r.toggleOverviewMap(i)},toggleAnnotations:()=>{r.toggleROIsVisibility()}};return{actions:a,definitions:{deleteMeasurement:{commandFn:a.deleteMeasurement},setLabel:{commandFn:a.setLabel},setToolActive:{commandFn:a.setToolActive},toggleOverlays:{commandFn:a.toggleOverlays},toggleAnnotations:{commandFn:a.toggleAnnotations}},defaultContext:"MICROSCOPY"}},getCustomizationModule:function(){return[]}},Q=K},70956:(e,t,i)=>{i.d(t,{A:()=>r});var n=i(42356),o=i(39548);function r({extensionManager:e,servicesManager:t}){const i=window.config.dataSources.find(t=>t.sourceName===e.activeDataSourceName),{userAuthenticationService:r}=t.services,{wadoRoot:s,staticWado:a,singlepart:c}=i.configuration,d={url:s||"/dicomlocal",staticWado:a,singlepart:c,headers:r.getAuthorizationHeader(),errorInterceptor:n.r_.getHTTPErrorHandler()},l=new o.StaticWadoClient(d);return l.wadoURL=d.url,"dicomlocal"===e.activeDataSourceName&&(l.retrieveInstanceFrames=async e=>{if(!("studyInstanceUID"in e))throw new Error("Study Instance UID is required for retrieval of instance frames");if(!("seriesInstanceUID"in e))throw new Error("Series Instance UID is required for retrieval of instance frames");if(!("sopInstanceUID"in e))throw new Error("SOP Instance UID is required for retrieval of instance frames");if(!("frameNumbers"in e))throw new Error("frame numbers are required for retrieval of instance frames");console.log(`retrieve frames ${e.frameNumbers.toString()} of instance ${e.sopInstanceUID}`);const t=n.H8.getInstance(e.studyInstanceUID,e.seriesInstanceUID,e.sopInstanceUID);return(Array.isArray(e.frameNumbers)?e.frameNumbers:e.frameNumbers.split(",")).map(e=>Array.isArray(t.PixelData)?t.PixelData[+e-1]:t.PixelData)}),l}}}]);
//# sourceMappingURL=1604.bundle.cbab848648ea62c6d76d.js.map