"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[9548],{52675:(e,t,a)=>{a.d(t,{A:()=>c});var n=a(86326),s=a(96283),r=a(42356);function i(){return i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},i.apply(null,arguments)}const o=({commandsManager:e,items:t,...a})=>{const{servicesManager:o}=(0,r.Jg)(),{customizationService:c}=o.services,l=c.getCustomization("ohif.menuContent")??(({item:t})=>n.createElement(s._26,{onClick:()=>t.onClick({commandsManager:e,servicesManager:o,...a})},n.createElement("div",{className:"flex items-center gap-2"},t.iconName&&n.createElement(s.FI1.ByName,{name:t.iconName}),n.createElement("span",null,t.label))));return n.createElement(s.SQm,{hideWhenDetached:!0,align:"start",onClick:e=>{e.stopPropagation(),e.preventDefault()}},t?.map((t,s)=>n.createElement(l,i({key:t.id||`menu-item-${s}`,item:t,commandsManager:e,servicesManager:o},a))))};function c(e){const{menuItemsKey:t,getMenuItems:a=o,commandsManager:i}=e,{servicesManager:c}=(0,r.Jg)(),{customizationService:l}=c.services,u=l.getCustomization(t);if(!u?.length)return null;return function(e){return n.createElement(s.rId,null,n.createElement(s.tyb,{asChild:!0},n.createElement(s.$nd,{variant:"ghost",size:"icon",className:"hidden group-hover:inline-flex data-[state=open]:inline-flex",onClick:e=>{e.preventDefault(),e.stopPropagation()}},n.createElement(s.FI1.More,null))),a({...e,commandsManager:i,servicesManager:c,items:u}))}}},40565:(e,t,a)=>{a.d(t,{A:()=>g});var n=a(86326),s=a(96283),r=a(42356),i=a(4194),o=a(3329);const c=[{id:"settings",iconName:"Settings",value:!1}];var l=a(52675);const{sortStudyInstances:u,formatDate:d,createStudyBrowserTabs:m}=r.Wp,p=["SR","SEG","RTSTRUCT","RTPLAN","RTDOSE","DOC","PMAP"];const g=function({getImageSrc:e,getStudiesForPatientByMRN:t,requestDisplaySetCreationForStudy:a,dataSource:g,customMapDisplaySets:y,onClickUntrack:I,onDoubleClickThumbnailHandlerCallBack:h}){const{servicesManager:v,commandsManager:D,extensionManager:w}=(0,r.Jg)(),{displaySetService:b,customizationService:E}=v.services,x=(0,i.Zp)(),M=E.getCustomization("studyBrowser.studyMode")||"all",C=(0,s.Bzx)().StudyInstanceUIDs,P=(0,n.useRef)(new Set),[{activeViewportId:U,viewports:O,isHangingProtocolLayout:N}]=(0,s.ihW)(),[R,T]=(0,n.useState)(M),[A,k]=(0,n.useState)("primary"===M&&C.length>0?[C[0]]:[...C]),[V,L]=(0,n.useState)(!1),[F,B]=(0,n.useState)([]),[$,H]=(0,n.useState)([]),[_,z]=(0,n.useState)({}),[W,q]=(0,n.useState)({}),[j,G]=(0,n.useState)(null),[Y,J]=(0,n.useState)(E.getCustomization("studyBrowser.viewPresets")),[X,K]=(0,n.useState)(c),Q=y||S,Z=(0,n.useCallback)(async e=>{const t=E.getCustomization("studyBrowser.thumbnailDoubleClickCallback"),a={activeViewportId:U,commandsManager:D,servicesManager:v,isHangingProtocolLayout:N,appConfig:w._appConfig},n=t?.callbacks.map(e=>e(a));for(const t of n)await t(e);h?.(e)},[U,D,v,N,E]);(0,n.useEffect)(()=>{C.forEach(e=>async function(e){if(P.current.has(e))return;P.current.add(e);const a=await g.query.studies.search({studyInstanceUid:e});if(!a?.length)throw x("/notfoundstudy","_self"),new Error("Invalid study URL");let n=a;try{n=await t(a)}catch(e){console.warn(e)}const s=n.map(e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time})).map(e=>({studyInstanceUid:e.StudyInstanceUID,date:d(e.StudyDate)||"",description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:Number(e.NumInstances)}));B(e=>{const t=[...e];for(const a of s)e.find(e=>e.studyInstanceUid===a.studyInstanceUid)||t.push(a);return t})}(e))},[C,g,t,x]),(0,n.useEffect)(()=>{if(!V){if(U){const e=250+10*b.getActiveDisplaySets().length;window.setTimeout(()=>L(!0),e)}return}let t=b.activeDisplaySets;t=t.filter(e=>!p.includes(e.Modality)||null===e.thumbnailSrc),t.length&&t.forEach(async t=>{const a={},n=b.getDisplaySetByUID(t.displaySetInstanceUID),s=f(n,g.getImageIdsForDisplaySet(t));if(n?.unsupported)return;let{thumbnailSrc:r}=n;if(!r&&n.getThumbnailSrc&&(r=await n.getThumbnailSrc({getImageSrc:e})),!r&&s){const t=await e(s);n.thumbnailSrc=t}a[t.displaySetInstanceUID]=r,q(e=>({...e,...a}))})},[b,g,e,U,V]),(0,n.useEffect)(()=>{const e=b.activeDisplaySets;if(!e.length)return;const t=Q(e,_,W,O);y||u(t),H(t)},[b.activeDisplaySets,_,O,W,y]),(0,n.useEffect)(()=>{const t=b.subscribe(b.EVENTS.DISPLAY_SETS_ADDED,t=>{if(!V)return;const{displaySetsAdded:a,options:n}=t;a.forEach(async t=>{const a=t.displaySetInstanceUID,s={},r=b.getDisplaySetByUID(a);if(r?.unsupported)return;n?.madeInClient&&G(a);const i=f(r,g.getImageIdsForDisplaySet(r));if(!i)return;let{thumbnailSrc:o}=r;!o&&r.getThumbnailSrc&&(o=await r.getThumbnailSrc({getImageSrc:e})),o||(o=await e(i),r.thumbnailSrc=o),s[a]=o,q(e=>({...e,...s}))})});return()=>{t.unsubscribe()}},[b,g,e,V]),(0,n.useEffect)(()=>{const e=b.subscribe(b.EVENTS.DISPLAY_SETS_CHANGED,e=>{const t=Q(e,_,W,O);y||u(t),H(t)}),t=b.subscribe(b.EVENTS.DISPLAY_SET_SERIES_METADATA_INVALIDATED,()=>{const e=Q(b.getActiveDisplaySets(),_,W,O);y||u(e),H(e)});return()=>{e.unsubscribe(),t.unsubscribe()}},[_,W,O,b,y]);const ee=m(C,F,$);(0,n.useEffect)(()=>{if(j){const e=j,t=document.getElementById(`thumbnail-${e}`);t&&"function"==typeof t.scrollIntoView&&(t.scrollIntoView({behavior:"smooth"}),G(null))}},[j,A,R]),(0,n.useEffect)(()=>{if(!j)return;const e=function(e,t,a){const n=t.find(e=>e.name===a)||t[0],s=[n,...t];for(let t=0;t<s.length;t++){const a=s[t].studies.find(t=>t.displaySets.find(t=>t.displaySetInstanceUID===e));if(a)return{tabName:s[t].name,StudyInstanceUID:a.studyInstanceUid}}}(j,ee,R);if(!e)return;const{tabName:t,StudyInstanceUID:a}=e;T(t);if(!A.includes(a)){const e=[...A,a];k(e)}},[A,j,ee]);const te=O.get(U)?.displaySetInstanceUIDs;return n.createElement(n.Fragment,null,n.createElement(n.Fragment,null,n.createElement(o.T,{viewPresets:Y,updateViewPresetValue:e=>{if(!e)return;const t=Y.map(t=>(t.selected=t.id===e.id,t));J(t)},actionIcons:X,updateActionIconValue:e=>{e.value=!e.value;const t=[...X];K(t)}}),n.createElement(s.wvv,{orientation:"horizontal",className:"bg-[rgb(var(--background))]",thickness:"2px"})),n.createElement(s.M4o,{tabs:ee,servicesManager:v,activeTabName:R,expandedStudyInstanceUIDs:A,onClickStudy:function(e){const t=A.includes(e),n=t?[...A.filter(t=>t!==e)]:[...A,e];if(k(n),!t){a(b,e,!0)}},onClickTab:e=>{T(e)},onClickUntrack:I,onClickThumbnail:()=>{},onDoubleClickThumbnail:Z,activeDisplaySetInstanceUIDs:te,showSettings:X.find(e=>"settings"===e.id)?.value,viewPresets:Y,ThumbnailMenuItems:(0,l.A)({commandsManager:D,servicesManager:v,menuItemsKey:"studyBrowser.thumbnailMenuItems"}),StudyMenuItems:(0,l.A)({commandsManager:D,servicesManager:v,menuItemsKey:"studyBrowser.studyMenuItems"})}))};function S(e,t,a,n){const s=[],r=[];return e.filter(e=>!e.excludeFromThumbnailBrowser).forEach(e=>{const{thumbnailSrc:n,displaySetInstanceUID:i}=e,o=function(e){if(p.includes(e.Modality)||e?.unsupported||null===e.thumbnailSrc)return"thumbnailNoImage";return"thumbnail"}(e),c="thumbnail"===o?s:r,l=t?.[i];c.push({displaySetInstanceUID:i,description:e.SeriesDescription||"",seriesNumber:e.SeriesNumber,modality:e.Modality,seriesDate:d(e.SeriesDate),numInstances:e.numImageFrames,loadingProgress:l,countIcon:e.countIcon,messages:e.messages,StudyInstanceUID:e.StudyInstanceUID,componentType:o,imageSrc:n||a[i],dragData:{type:"displayset",displaySetInstanceUID:i},isHydratedForDerivedDisplaySet:e.isHydrated})}),[...s,...r]}function f(e,t){let a;if(e.isDynamicVolume){const t=e.dynamicVolumeInfo.timePoints,n=t[Math.floor(t.length/2)];a=n[Math.floor(n.length/2)]}else a=t[Math.floor(t.length/2)];return a}},3329:(e,t,a)=>{a.d(t,{T:()=>r});var n=a(86326),s=a(96283);function r({viewPresets:e,updateViewPresetValue:t,actionIcons:a,updateActionIconValue:r}){return n.createElement(n.Fragment,null,n.createElement("div",{className:"bg-muted flex h-[40px] select-none rounded-t p-2"},n.createElement("div",{className:"flex h-[24px] w-full select-none justify-center self-center text-[14px]"},n.createElement("div",{className:"flex w-full items-center gap-[10px]"},n.createElement("div",{className:"flex items-center justify-center"},n.createElement("div",{className:"text-primary flex items-center space-x-1"},a.map((e,t)=>n.createElement(s.FI1[e.iconName]||s.FI1.MissingIcon,{key:t,onClick:()=>r(e),className:"cursor-pointer"})))),n.createElement("div",{className:"ml-auto flex h-full items-center justify-center"},n.createElement(s.OY8,{type:"single",value:e.filter(e=>e.selected)[0].id,onValueChange:a=>{const n=e.find(e=>e.id===a);t(n)}},e.map((e,t)=>n.createElement(s.dzE,{key:t,"aria-label":e.id,value:e.id,className:"text-actions-primary"},n.createElement(s.FI1[e.iconName]||s.FI1.MissingIcon)))))))))}},20528:(e,t,a)=>{a.d(t,{M:()=>i});var n=a(86326),s=a(42356);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},r.apply(null,arguments)}function i({buttonSection:e="primary",viewportId:t,location:a}){const{toolbarButtons:i,onInteraction:o,isItemOpen:c,isItemLocked:l,openItem:u,closeItem:d,toggleLock:m}=(0,s.tR)({buttonSection:e});return i.length?n.createElement(n.Fragment,null,i?.map(e=>{if(!e)return null;const{id:s,Component:i,componentProps:p}=e,g={...p,isOpen:c(s,t),isLocked:l(s,t),onOpen:()=>u(s,t),onClose:()=>d(s,t),onToggleLock:()=>m(s,t),viewportId:t},S=n.createElement(i,r({key:s,id:s,location:a,onInteraction:e=>{o({...e,itemId:s,viewportId:t})}},g));return n.createElement("div",{key:s,className:"contents"},S)})):null}},39548:(e,t,a)=>{a.r(t),a.d(t,{ContextMenuController:()=>Xt,CustomizableContextMenuTypes:()=>n,MoreDropdownMenu:()=>Ns.A,PanelStudyBrowserHeader:()=>Cs.T,StaticWadoClient:()=>T,Toolbar:()=>Ee.M,Toolbox:()=>Os,callInputDialog:()=>ws,callInputDialogAutoComplete:()=>bs,cleanDenaturalizedDataset:()=>Ss,colorPickerDialog:()=>xs,createReportAsync:()=>Ta,createReportDialogPrompt:()=>Ye,default:()=>Ts,dicomWebUtils:()=>s,getStudiesForPatientByMRN:()=>We,promptLabelAnnotation:()=>Ms,promptSaveReport:()=>Ba,requestDisplaySetCreationForStudy:()=>qe,useDisplaySetSelectorStore:()=>Da,useHangingProtocolStageIndexStore:()=>ba,usePatientInfo:()=>Ce,useToggleHangingProtocolStore:()=>Na,useToggleOneUpViewportGridStore:()=>Ra,useUIStateStore:()=>hs,useViewportGridStore:()=>ha,useViewportsByPositionStore:()=>Ca,utils:()=>r});var n={};a.r(n);var s={};a.r(s),a.d(s,{cleanDenaturalizedDataset:()=>Ss,fixBulkDataURI:()=>L,fixMultiValueKeys:()=>ys,transferDenaturalizedDataset:()=>fs});var r={};a.r(r),a.d(r,{Toolbox:()=>Os,addIcon:()=>Ps});var i=a(83562),o=a(42356),c=a(45476);const{getString:l,getName:u,getModalities:d}=o.ll;function m(e){if(!e||!e.length)return[];const t=[];return e.forEach(e=>t.push({studyInstanceUid:l(e["0020000D"]),date:l(e["00080020"]),time:l(e["00080030"]),accession:l(e["00080050"])||"",mrn:l(e["00100020"])||"",patientName:o.Wp.formatPN(u(e["00100010"]))||"",instances:Number(l(e["00201208"]))||0,description:l(e["00081030"])||"",modalities:l(d(e["00080060"],e["00080061"]))||""})),t}async function p(e,t,a,n){return await e.searchForStudies({studyInstanceUid:void 0,queryParams:n})}function g(e,t={}){if(!e)return;const a=["00081030","00080060"].join(","),n=void 0!==e?.disableWildcard?!e.disableWildcard:t.supportsWildcard,s=e=>n&&e?`*${e}*`:e,r={PatientName:s(e.patientName),"00100020":s(e.patientId),AccessionNumber:s(e.accessionNumber),StudyDescription:s(e.studyDescription),ModalitiesInStudy:e.modalitiesInStudy,limit:e.limit||101,offset:e.offset||0,fuzzymatching:!0===t.supportsFuzzyMatching,includefield:a};if(e.startDate&&e.endDate)r.StudyDate=`${e.startDate}-${e.endDate}`;else if(e.startDate){const t=new Date,a=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),s=`${t.getFullYear()}${n}${a}`;r.StudyDate=`${e.startDate}-${s}`}else if(e.endDate){const t="19700102";r.StudyDate=`${t}-${e.endDate}`}if(e.studyInstanceUid){let t=e.studyInstanceUid;t=Array.isArray(t)?t.join():t,t=t.replace(/[^0-9.]+/g,"\\"),r.StudyInstanceUID=t}const i={};return Object.keys(r).forEach(e=>{void 0!==r[e]&&""!==r[e]&&(i[e]=r[e])}),i}function S({instance:e,frame:t,config:a,thumbnail:n=!1}){if(!e)return;if(e.imageId&&void 0===t)return e.imageId;if(e.url)return e.url;const s=n?"thumbnailRendering":"imageRendering";if(a[s]&&"wadouri"!==a[s])return function(e,t,a){const n=function(e,t,a){const n=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=e;return`${t.wadoRoot}/studies/${a}/series/${n}/instances/${s}`}(e,t);return`${n}/frames/${a=a||1}`}(e,t,a);if(n)return`wadors:${n}`}(e,a,t);{const n=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=t,r=[];r.push("requestType=WADO"),r.push(`studyUID=${a}`),r.push(`seriesUID=${n}`),r.push(`objectUID=${s}`),r.push("contentType=application/dicom"),r.push("transferSyntax=*");const i=r.join("&");return`${e.wadoUriRoot}?${i}`}(a,e);let s="dicomweb:"+n;return void 0!==t&&(s+="&frame="+t),s}}var f=a(5842);class y{constructor(e,t,a={},n=void 0,s=void 0){this.client=e,this.studyInstanceUID=t,this.filters=a,this.sortCriteria=n,this.sortFunction=s}async execLoad(){const e=await this.preLoad(),t=await this.load(e);return await this.posLoad(t)}async runLoaders(e){let t;for(const a of e)if(t=await a(),t&&t.length)break;if(e.next().done&&!t)throw new Error("RetrieveMetadataLoader failed");return t}async configLoad(){}async preLoad(){}async load(e){}async posLoad(e){}}class I extends y{getOptions(){const{studyInstanceUID:e,filters:t}=this,a={studyInstanceUID:e},{seriesInstanceUID:n}=t;return n&&(a.seriesInstanceUID=n),a}*getLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n}=this;a&&e.push(n.retrieveSeriesMetadata.bind(n,{studyInstanceUID:t,seriesInstanceUID:a})),e.push(n.retrieveStudyMetadata.bind(n,{studyInstanceUID:t})),yield*e}async load(e){const t=this.getLoaders();return this.runLoaders(t)}async posLoad(e){return e}}const h=["00080021","00080031","0008103E","00200011"].join(",");class v{constructor(){this.metadata=void 0,this.processFunction=void 0,this.internalPromise=void 0,this.thenFunction=void 0,this.rejectFunction=void 0}setMetadata(e){this.metadata=e}setProcessFunction(e){this.processFunction=e}getPromise(){return this.start()}start(){return this.internalPromise||(this.internalPromise=this.processFunction(),this.thenFunction&&(this.then(this.thenFunction),this.thenFunction=void 0),this.rejectFunction&&(this.reject(this.rejectFunction),this.rejectFunction=void 0)),this.internalPromise}then(e){if(this.internalPromise)return this.internalPromise.then(e);this.thenFunction=e}reject(e){if(this.internalPromise)return this.internalPromise.reject(e);this.rejectFunction=e}}class D extends y{*getPreLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n}=this;let s={studyInstanceUID:t,queryParams:{includefield:h}};a&&(s.queryParams.SeriesInstanceUID=a,e.push(n.searchForSeries.bind(n,s))),e.push(n.searchForSeries.bind(n,s)),yield*e}async preLoad(){const e=this.getPreLoaders(),t=await this.runLoaders(e),a=this.sortCriteria,n=this.sortFunction,{naturalizeDataset:s}=f.Ay.data.DicomMetaDictionary,r=t.map(s);return(0,c.LM)(r,a,n)}async load(e){const{client:t,studyInstanceUID:a}=this,n=function(e,t,a){return Object.freeze({hasNext:()=>a.length>0,next(){const{seriesInstanceUID:n,metadata:s}=a.shift(),r=new v;return r.setMetadata(s),r.setProcessFunction(()=>e.retrieveSeriesMetadata({studyInstanceUID:t,seriesInstanceUID:n})),r}})}(t,a,e.map(e=>({seriesInstanceUID:e.SeriesInstanceUID,metadata:e}))),s=[];for(;n.hasNext();){const e=n.next();s.push(e)}return{preLoadData:e,promises:s}}async posLoad({preLoadData:e,promises:t}){return{preLoadData:e,promises:t}}}const w=async function(e,t,a,n={},s,r){const i=new(!1!==a?D:I)(e,t,n,s,r);return await i.execLoad()};const b=function(e,t,a,n,s,r){const{seriesInstanceUID:i}=n;return new Promise((o,c)=>{const l=i.map(i=>{const o=Object.assign({},n,{seriesInstanceUID:i});return w(e,t,a,o,s,r)});!0===a?Promise.all(l).then(e=>{const t={preLoadData:[],promises:[]};e.forEach(({preLoadData:e,promises:a})=>{t.preLoadData=t.preLoadData.concat(e),t.promises=t.promises.concat(a)}),o(t)},c):Promise.all(l).then(e=>{o(e.flat())},c)})},E="RetrieveStudyMetadata",x=new Map;function M(e,t,a,n,s,r,i={}){if(!e)throw new Error(`${E}: Required 'dicomWebClient' parameter not provided.`);if(!t)throw new Error(`${E}: Required 'StudyInstanceUID' parameter not provided.`);const o=`${i.name}:${t}`;if(x.has(o))return x.get(o);let c;return c=n&&n.seriesInstanceUID&&Array.isArray(n.seriesInstanceUID)?b(e,t,a,n,s,r):new Promise((i,o)=>{w(e,t,a,n,s,r).then(function(e){i(e)},o)}),x.set(o,c),c}function C(e){x.has(e)&&x.delete(e)}function P(e,t,a){if(a+e.length>t.length)return!1;let n=a;for(let a=0;a<e.length;a++)if(e[a]!==t[n++])return!1;return!0}const U=function(e,t,a){a=a||0;const n=function(e){const t=new Uint8Array(e.length);for(let a=0,n=e.length;a<n;a++)t[a]=e.charCodeAt(a);return t}(t);for(let t=a;t<e.length;t++)if(n[0]===e[t]&&P(n,e,t))return t;return-1};function O(e){const t=new Uint8Array(e[0]);if(t.length<25)return e;const a=U(t,"--");if(a>6)return e;const n=U(t,"\r\n\r\n",a);if(n>512)return e;const s=function(e,t,a){t=t||0,a=a||e.length-t;let n="";for(let s=t;s<t+a;s++)n+=String.fromCharCode(e[s]);return n}(t,0,n),r=function(e){for(let t=0;t<e.length;t++)if("--"===e[t].substr(0,2))return e[t]}(s.split("\r\n"));if(!r)return e;const i=n+4,o=U(t,r,i);return-1===o?e:[t.slice(i,o-2).buffer]}const{DICOMwebClient:N}=i.FH,R=N;R._orig_buildMultipartAcceptHeaderFieldValue||(R._orig_buildMultipartAcceptHeaderFieldValue=R._buildMultipartAcceptHeaderFieldValue,R._buildMultipartAcceptHeaderFieldValue=function(e,t){return 1===e.length&&e[0].mediaType.endsWith("/*")?"*/*":R._orig_buildMultipartAcceptHeaderFieldValue(e,t)});class T extends i.FH.DICOMwebClient{constructor(e){super(e),this.config=void 0,this.staticWado=void 0,this.staticWado=e.staticWado,this.config=e}retrieveBulkData(e){const t=!1!==this.config.fixBulkdataMultipart,a={...e};return this.staticWado&&(a.mediaTypes=[{mediaType:"application/*"}]),super.retrieveBulkData(a).then(e=>t?O(e):e)}retrieveInstanceFrames(e){return this.staticWado?super.retrieveInstanceFrames({...e,mediaTypes:[{mediaType:"image/*"}]}):super.retrieveInstanceFrames(e)}async searchForStudies(e){if(!this.staticWado)return super.searchForStudies(e);const t=await super.searchForStudies(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter(e=>{for(const t of Object.keys(T.studyFilterKeys))if(!this.filterItem(t,n,e,T.studyFilterKeys))return!1;return!0})}async searchForSeries(e){if(!this.staticWado)return super.searchForSeries(e);const t=await super.searchForSeries(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter(e=>{for(const t of Object.keys(T.seriesFilterKeys))if(!this.filterItem(t,n,e,T.seriesFilterKeys))return!1;return!0})}compareValues(e,t,a){const{fuzzyMatching:n}=a;if(Array.isArray(e))return e.find(e=>this.compareValues(e,t,a));if(Array.isArray(t))return t.find(t=>this.compareValues(e,t,a));if(t?.Alphabetic&&(t=t.Alphabetic),n&&"string"==typeof t&&"string"==typeof e){const a=e=>e.toLowerCase(),n=a(e),s=a(t),r=e=>e.split(/[\s^]+/).filter(Boolean),i=r(n),o=r(s);return i.every(e=>o.some(t=>t.startsWith(e)))}if("string"==typeof t){if(0===t.length)return!0;if(0===e.length||"*"===e)return!0;if("*"===e[0]&&"*"===e[e.length-1])return-1!=t.indexOf(e.substring(1,e.length-1));if("*"===e[e.length-1])return-1!=t.indexOf(e.substring(0,e.length-1));if("*"===e[0])return t.indexOf(e.substring(1))===t.length-e.length+1}return e===t}compareDateRange(e,t){if(!t)return!0;const a=e.indexOf("-");if(-1===a)return this.compareValues(e,t,{});const n=e.substring(0,a),s=e.substring(a+1);return(!n||t>=n)&&(!s||t<=s)}filterItem(e,t,a,n){const{supportsFuzzyMatching:s=!1}=this.config,r={fuzzyMatching:(e=>-1!==e.indexOf("name"))(e)&&s},i=n[e]||e;if(!t)return!0;const o=t[e]||t[i];if(!o)return!0;const c=a[e]||a[i];if(!c)return!1;if("DA"===c.vr&&c.Value?.[0])return this.compareDateRange(o,c.Value[0]);const l=c.Value;return this.compareValues(o,l,r)}toLowerParams(e){const t={};return Object.entries(e).forEach(([e,a])=>{t[e.toLowerCase()]=a}),t}}T.studyFilterKeys={studyinstanceuid:"0020000D",patientname:"00100010","00100020":"mrn",studydescription:"00081030",studydate:"00080020",modalitiesinstudy:"00080061",accessionnumber:"00080050"},T.seriesFilterKeys={seriesinstanceuid:"0020000E",seriesnumber:"00200011",modality:"00080060"};const A=(e,t)=>{const{instance:a,tag:n="PixelData",defaultPath:s="/pixeldata",defaultType:r="video/mp4"}=t,i=a[n],{StudyInstanceUID:o,SeriesInstanceUID:c,SOPInstanceUID:l}=a,u=i&&i.BulkDataURI||`series/${c}/instances/${l}${s}`,d=-1!==u.indexOf("?"),m=-1!==u.indexOf("accept="),p=u+(m?"":(d?"&":"?")+`accept=${r}`);if(p.startsWith("series/")){const{wadoRoot:t}=e;return`${t}/studies/${o}/${p}`}return p},k=(e,t)=>{const{wadoRoot:a}=e,{instance:n,tag:s="PixelData"}=t,{StudyInstanceUID:r,SeriesInstanceUID:i,SOPInstanceUID:o}=n,c=n[s]?.BulkDataURI??"";if(-1===c?.indexOf("?"))return"PixelData"===s||"EncapsulatedDocument"===s?`${a}/studies/${r}/series/${i}/instances/${o}/rendered`:void 0},V=(e,t)=>{const{singlepart:a}=e,{instance:n,tag:s="PixelData",defaultType:r="video/mp4",singlepart:i="video",url:c=null}=t;if(c)return c;const l=n[s];if(l){if(l.DirectRetrieveURL)return l.DirectRetrieveURL;if(l.InlineBinary){const e=o.Wp.b64toBlob(l.InlineBinary,r);return l.DirectRetrieveURL=URL.createObjectURL(e),l.DirectRetrieveURL}if(!a||!0!==a&&-1===a.indexOf(i)){if(l.retrieveBulkData){const e={mediaType:r};return l.retrieveBulkData(e).then(e=>(l.DirectRetrieveURL=URL.createObjectURL(new Blob([e],{type:r})),l.DirectRetrieveURL))}return void console.warn("Unable to retrieve",s,"from",n)}}return k(e,t)||A(e,t)};function L(e,t,a){let{BulkDataURI:n}=e;const{bulkDataURI:s={}}=a;n=s.transform?.(n)||n;const{startsWith:r,prefixWith:i=""}=s;if(r&&n.startsWith(r)&&(n=i+n.substring(r.length),e.BulkDataURI=n),!n.startsWith("http")&&!e.BulkDataURI.startsWith("/")){const{StudyInstanceUID:r,SeriesInstanceUID:i}=t,o=n.startsWith("instances/")||n.startsWith("../");return void(n.startsWith("series/")||n.startsWith("bulkdata/")||"studies"===s.relativeResolution&&!o?e.BulkDataURI=`${a.wadoRoot}/studies/${r}/${n}`:!o&&"series"!==s.relativeResolution&&s.relativeResolution||(e.BulkDataURI=`${a.wadoRoot}/studies/${r}/series/${i}/${n}`))}if("/"===n[0]&&a.wadoRoot.startsWith("http")){const t=new URL(a.wadoRoot);e.BulkDataURI=`${t.origin}${n}`}}const{DicomMetaDictionary:F,DicomDict:B}=f.Ay.data,{naturalizeDataset:$,denaturalizeDataset:H}=F,_=o.Ly.MetadataProvider,z={includeTransferSyntax:!1};function W(e,t){const{userAuthenticationService:a}=t.services;let n,s,r,u,d,f,y;e.bulkDataURI||={enabled:!0};const I={initialize:({params:t,query:c})=>{e.onConfiguration&&"function"==typeof e.onConfiguration&&(e=e.onConfiguration(e,{params:t,query:c})),n=JSON.parse(JSON.stringify(e)),f=()=>{const e={},t=a.getAuthorizationHeader();return t&&t.Authorization&&(e.Authorization=t.Authorization),e},y=t=>{const a=f();if(!1!==t?.includeTransferSyntax){const t=o.Wp.generateAcceptHeader(e.acceptHeader,e.requestTransferSyntaxUID,e.omitQuotationForMultipartRequest);return{...a,Accept:t}}return{...a}},s={url:e.qidoRoot,staticWado:e.staticWado,singlepart:e.singlepart,headers:a.getAuthorizationHeader(),errorInterceptor:o.r_.getHTTPErrorHandler(),supportsFuzzyMatching:e.supportsFuzzyMatching},r={url:e.wadoRoot,staticWado:e.staticWado,singlepart:e.singlepart,headers:a.getAuthorizationHeader(),errorInterceptor:o.r_.getHTTPErrorHandler(),supportsFuzzyMatching:e.supportsFuzzyMatching},u=e.staticWado?new T(s):new i.FH.DICOMwebClient(s),d=e.staticWado?new T(r):new i.FH.DICOMwebClient(r)},query:{studies:{mapParams:g.bind(),search:async function(t){u.headers=f();const{studyInstanceUid:a,seriesInstanceUid:n,...s}=g(t,{supportsFuzzyMatching:e.supportsFuzzyMatching,supportsWildcard:e.supportsWildcard})||{};return m(await p(u,0,0,s))},processResults:m.bind()},series:{search:async function(e){u.headers=f();return function(e){const t=[];return e&&e.length&&e.forEach(e=>t.push({studyInstanceUid:l(e["0020000D"]),seriesInstanceUid:l(e["0020000E"]),modality:l(e["00080060"]),seriesNumber:l(e["00200011"]),seriesDate:o.Wp.formatDate(l(e["00080021"])),numSeriesInstances:Number(l(e["00201209"])),description:l(e["0008103E"])})),(0,c.LM)(t),t}(await function(e,t){const a={includefield:["0008103E","00080021"].join(",")};return e.searchForSeries({studyInstanceUID:t,queryParams:a})}(u,e))}},instances:{search:(e,t)=>(u.headers=f(),p.call(void 0,u,e,null,t))}},retrieve:{getGetThumbnailSrc:function(t,a){return"wadors"===e.thumbnailRendering?function(e){return a&&e?.getImageSrc?e.getImageSrc(a):null}:"thumbnailDirect"===e.thumbnailRendering?function(){return this.directURL({instance:t,defaultPath:"/thumbnail",defaultType:"image/jpeg",singlepart:!0,tag:"Absent"})}.bind(this):"thumbnail"===e.thumbnailRendering?async function(){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=t,r=`${e.wadoRoot}/studies/${a}/series/${n}/instances/${s}/thumbnail?accept=image/jpeg`;return URL.createObjectURL(new Blob([await this.bulkDataURI({BulkDataURI:r.replace("wadors:",""),defaultType:"image/jpeg",mediaTypes:["image/jpeg"],thumbnail:!0})],{type:"image/jpeg"}))}.bind(this):"rendered"===e.thumbnailRendering?async function(){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=t,r=`${e.wadoRoot}/studies/${a}/series/${n}/instances/${s}/rendered?accept=image/jpeg`;return URL.createObjectURL(new Blob([await this.bulkDataURI({BulkDataURI:r.replace("wadors:",""),defaultType:"image/jpeg",mediaTypes:["image/jpeg"],thumbnail:!0})],{type:"image/jpeg"}))}.bind(this):void 0},directURL:t=>V({wadoRoot:e.wadoRoot,singlepart:e.singlepart},t),getWadoDicomWebClient:()=>d,bulkDataURI:async({StudyInstanceUID:e,BulkDataURI:t})=>{u.headers=f();const a={multipart:!1,BulkDataURI:t,StudyInstanceUID:e};return u.retrieveBulkData(a).then(e=>e&&e[0]||void 0)},series:{metadata:async({StudyInstanceUID:t,filters:a,sortCriteria:n,sortFunction:s,madeInClient:r=!1,returnPromises:i=!1}={})=>{if(!t)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");return e.enableStudyLazyLoad?I._retrieveSeriesMetadataAsync(t,a,n,s,r,i):I._retrieveSeriesMetadataSync(t,a,n,s,r)}}},store:{dicom:async(e,t,a)=>{if(d.headers=f(),e instanceof ArrayBuffer){const a={datasets:[e],request:t};await d.storeInstances(a)}else{let n=a;if(!a){const t={FileMetaInformationVersion:e._meta?.FileMetaInformationVersion?.Value,MediaStorageSOPClassUID:e.SOPClassUID,MediaStorageSOPInstanceUID:e.SOPInstanceUID,TransferSyntaxUID:"1.2.840.10008.1.2.1",ImplementationClassUID:"2.25.270695996825855179949881587723571202391.2.0.0",ImplementationVersionName:"OHIF-3.11.0"},a=H(t),s=new B(a);s.dict=H(e),n=s}const s={datasets:[n.write()],request:t};await d.storeInstances(s)}}},_retrieveSeriesMetadataSync:async(t,a,n,s,r)=>{d.headers=y(z);const i=(await M(d,t,!1,a,n,s,e)).map($),c={},l={};i.forEach(a=>{c[a.SeriesInstanceUID]||(c[a.SeriesInstanceUID]={StudyInstanceUID:a.StudyInstanceUID,StudyDescription:a.StudyDescription,SeriesInstanceUID:a.SeriesInstanceUID,SeriesDescription:a.SeriesDescription,SeriesNumber:a.SeriesNumber,SeriesTime:a.SeriesTime,SOPClassUID:a.SOPClassUID,ProtocolName:a.ProtocolName,Modality:a.Modality}),l[a.SeriesInstanceUID]||(l[a.SeriesInstanceUID]=[]);const n=I.getImageIdsForInstance({instance:a});a.imageId=n,a.wadoRoot=e.wadoRoot,a.wadoUri=e.wadoUri,_.addImageIdToUIDs(n,{StudyInstanceUID:t,SeriesInstanceUID:a.SeriesInstanceUID,SOPInstanceUID:a.SOPInstanceUID}),l[a.SeriesInstanceUID].push(a)});const u=Object.values(c);return o.H8.addSeriesMetadata(u,r),Object.keys(l).forEach(e=>o.H8.addInstances(l[e],r)),c},_retrieveSeriesMetadataAsync:async(t,a,n,s,r=!1,i=!1)=>{d.headers=y(z);const{preLoadData:c,promises:l}=await M(d,t,!0,a,n,s,e),m=(t,a=t)=>{if(!t)return t;for(const n of Object.keys(t)){const s=t[n];if(Array.isArray(s)&&"object"==typeof s[0]){s.filter(Boolean).forEach(e=>m(e,a));continue}s&&s.BulkDataURI&&!s.Value&&(L(s,a,e),s.retrieveBulkData=q.bind(u,s))}return t},p=t=>{const a=$(t);return e.bulkDataURI?.enabled?m(a):a};function g(){const e=o.H8.getStudy(t);e&&(e.isLoaded=!0)}c.forEach(e=>{e.StudyInstanceUID=t}),o.H8.addSeriesMetadata(c,r);const S=l.map(t=>(i||t?.start(),t.then(t=>{!function(t){const a=t.map(p);a.forEach(t=>{t.wadoRoot=e.wadoRoot,t.wadoUri=e.wadoUri;const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=t,r=t.NumberOfFrames||1;for(let e=0;e<r;e++){const i=e+1,o=I.getImageIdsForInstance({instance:t,frame:i});_.addImageIdToUIDs(o,{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s,frameNumber:r>1?i:void 0})}const i=I.getImageIdsForInstance({instance:t});t.imageId=i}),o.H8.addInstances(a,r)}(t)})));return i?(Promise.all(S).then(()=>g()),l):(await Promise.all(S),g(),c)},deleteStudyMetadataPromise:C,getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach(e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}}),a):a},getImageIdsForInstance:({instance:t,frame:a})=>S({instance:t,frame:a,config:e}),getConfig:()=>n,getStudyInstanceUIDs({params:e,query:t}){const a=e.StudyInstanceUIDs||e.studyInstanceUIDs,n=o.Wp.splitComma(t.getAll("StudyInstanceUIDs").concat(t.getAll("studyInstanceUIDs"))),s=n.length&&n||a;return s&&Array.isArray(s)?s:[s]}};var h,v;return e.supportsReject&&(I.reject=(h=e.wadoRoot,v=f,{series:(e,t)=>new Promise((a,n)=>{const s=`${h}/studies/${e}/series/${t}/reject/113001%5EDCM`,r=new XMLHttpRequest;r.open("POST",s,!0);const i=v();for(const e in i)r.setRequestHeader(e,i[e]);console.log(r),r.onreadystatechange=function(){if(4==r.readyState)switch(r.status){case 200:case 204:a(r.responseText);break;case 404:n("Your dataSource does not support reject functionality");default:n(`Unexpected status code: ${r.status}`)}},r.send()})})),o.pt.create(I)}function q(e,t={}){const{mediaType:a}=t,n={multipart:!1,BulkDataURI:e.BulkDataURI,mediaTypes:a?[{mediaType:a},{mediaType:"application/octet-stream"}]:void 0,...t};return this.retrieveBulkData(n).then(t=>{const a=t instanceof Array&&t.find(e=>e?.byteLength)||void 0;return e.Value=a,a})}var j=a(98985);const G=o.Ay.classes.MetadataProvider,Y={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let J={urls:[],studyInstanceUIDMap:new Map};function X(e){return Object.keys(e).reduce((t,a)=>("object"==typeof e[a]&&null!==e[a]?t[a]=X(e[a]):t[a]=e[a],a.endsWith("Sequence")&&(t[a]=o.Ay.utils.addAccessors(t[a])),t),Array.isArray(e)?[]:{})}const K=(e,t)=>{let a=[];return J.urls.map(n=>{n.studies.map(n=>{n[e]===t&&a.push(n)})}),a};function Q(e){const t={initialize:async({query:t,url:a})=>{a||(a=t.get("url"));let n=(e=>J.urls.find(t=>t.url===e))(a);if(n)return n.studies.map(e=>e.StudyInstanceUID);const s=await fetch(a),r=await s.json();let i,o;r.studies.forEach(t=>{i=t.StudyInstanceUID,t.series.forEach(t=>{o=t.SeriesInstanceUID,t.instances.forEach(t=>{const{metadata:a}=t,n=S({instance:t,config:e}),{query:s}=j.parseUrl(t.url);G.addImageIdToUIDs(n,{StudyInstanceUID:i,SeriesInstanceUID:o,SOPInstanceUID:a.SOPInstanceUID,frameNumber:s.frame?parseInt(s.frame):void 0})})})}),J.urls.push({url:a,studies:[...r.studies]}),J.studyInstanceUIDMap.set(a,r.studies.map(e=>e.StudyInstanceUID))},query:{studies:{mapParams:()=>{},search:async e=>{const[t,a]=Object.entries(e)[0];return K(Y[t],a).map(e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime}))},processResults:()=>{console.warn(" DICOMJson QUERY processResults not implemented")}},series:{search:()=>{console.warn(" DICOMJson QUERY SERIES SEARCH not implemented")}},instances:{search:()=>{console.warn(" DICOMJson QUERY instances SEARCH not implemented")}}},retrieve:{directURL:t=>V(e,t),series:{metadata:async({filters:t,StudyInstanceUID:a,madeInClient:n=!1,customSort:s}={})=>{if(!a)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const r=K("StudyInstanceUID",a)[0];let i;i=s?s(r.series):r.series;const c=["SeriesInstanceUID","SeriesInstanceUIDs","seriesInstanceUID","seriesInstanceUIDs"].find(e=>t[e]);if(c){const e=t[c];i=i.filter(t=>e.includes(t.SeriesInstanceUID))}const l=i.map(e=>{const t={StudyInstanceUID:r.StudyInstanceUID,...e};return delete t.instances,t});o.H8.addSeriesMetadata(l,n);const u=i.length;i.forEach((t,s)=>{const i=t.instances.map(a=>{const n={...X(a.metadata),url:a.url,imageId:S({instance:a,config:e}),...t,...r};return delete n.instances,delete n.series,n});var c;c=i,o.H8.addInstances(c,n),s===u-1&&(o.H8.getStudy(a,n).isLoaded=!0)})}}},store:{dicom:()=>{console.warn(" DICOMJson store dicom not implemented")}},getImageIdsForDisplaySet(t){const a=t.images,n=[];if(!a)return n;const{StudyInstanceUID:s,SeriesInstanceUID:r}=t,i=K("StudyInstanceUID",s)[0].series.find(e=>e.SeriesInstanceUID===r)||{},o=new Map;return i.instances&&i.instances.forEach(e=>{if(e?.metadata?.SOPInstanceUID){const{metadata:t,url:a}=e,n=o.get(t.SOPInstanceUID)||[];n.push({...t,url:a}),o.set(t.SOPInstanceUID,n)}}),t.images.forEach(t=>{const a=t.NumberOfFrames||1,s=o.get(t.SOPInstanceUID)||[t];for(let t=0;t<a;t++){const r=S({instance:s[Math.min(t,s.length-1)],frame:a>1?t:void 0,config:e});n.push(r)}}),n},getImageIdsForInstance:({instance:e,frame:t})=>S({instance:e,frame:t}),getStudyInstanceUIDs:({params:e,query:t})=>{const a=t.get("url");return J.studyInstanceUIDMap.get(a)}};return o.pt.create(t)}const Z=o.Ay.classes.MetadataProvider,{EVENTS:ee}=o.H8,te={SR:!0,SEG:!0,DOC:!0},ae=(e,t,a=0)=>e===t?a:e<t?-1:1,ne=(e,t)=>{const a=e.instances[0],n=t.instances[0],s=a.Modality,r=n.Modality,i=te[s],o=te[r];return i&&o?ae(a.SeriesNumber,n.SeriesNumber):i||o?i?-1:1:ae(n.SeriesNumber,a.SeriesNumber)};function se(e){const{name:t}=e,a={initialize:({params:e,query:t})=>{},query:{studies:{mapParams:()=>{},search:e=>o.H8.getStudyInstanceUIDs().map(e=>{let t=0;const a=new Set,n=o.H8.getStudy(e);n.series.forEach(e=>{t+=e.instances.length,a.add(e.instances[0].Modality)});const s=n?.series[0]?.instances[0];if(s)return{accession:s.AccessionNumber,date:s.StudyDate,description:s.StudyDescription,mrn:s.PatientID,patientName:o.Wp.formatPN(s.PatientName),studyInstanceUid:s.StudyInstanceUID,time:s.StudyTime,instances:t,modalities:Array.from(a).join("/"),NumInstances:t}}),processResults:()=>{console.warn(" DICOMLocal QUERY processResults not implemented")}},series:{search:e=>o.H8.getStudy(e).series.map(t=>{const a=t?.instances[0];return{studyInstanceUid:e,seriesInstanceUid:a.SeriesInstanceUID,modality:a.Modality,seriesNumber:a.SeriesNumber,seriesDate:a.SeriesDate,numSeriesInstances:t.instances.length,description:a.SeriesDescription}})},instances:{search:()=>{console.warn(" DICOMLocal QUERY instances SEARCH not implemented")}}},retrieve:{directURL:e=>{const{instance:t,tag:a,defaultType:n}=e,s=t[a];if(s instanceof Array&&s[0]instanceof ArrayBuffer)return URL.createObjectURL(new Blob([s[0]],{type:n}))},series:{metadata:async({StudyInstanceUID:e,madeInClient:t=!1}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const a=o.H8.getStudy(e,t);o.H8._broadcastEvent(ee.SERIES_ADDED,{StudyInstanceUID:e,madeInClient:t}),a.series.forEach(a=>{const{SeriesInstanceUID:n}=a,s=a.instances[0].NumberOfFrames>1;a.instances.forEach((e,t)=>{const{url:a,StudyInstanceUID:n,SeriesInstanceUID:r,SOPInstanceUID:i}=e;e.imageId=a,Z.addImageIdToUIDs(a,{StudyInstanceUID:n,SeriesInstanceUID:r,SOPInstanceUID:i,frameIndex:s?t:1})}),o.H8._broadcastEvent(ee.INSTANCES_ADDED,{StudyInstanceUID:e,SeriesInstanceUID:n,madeInClient:t})})}}},store:{dicom:e=>{const t=f.Ay.data.datasetToBlob(e);var a=URL.createObjectURL(t);window.location.assign(a)}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach(e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}}),a):a},getImageIdsForInstance({instance:e,frame:t}){const{StudyInstanceUID:a,SeriesInstanceUID:n}=e,s=e.SOPInstanceUID||e.SopInstanceUID;let r=o.H8.getInstance(a,n,s).url;return void 0!==t&&(r+=`&frame=${t}`),r},deleteStudyMetadataPromise(){console.log("deleteStudyMetadataPromise not implemented")},getStudyInstanceUIDs:({params:e,query:t})=>{const{StudyInstanceUIDs:a}=e,n=t.getAll("StudyInstanceUIDs")||a,s=n&&Array.isArray(n)?n:[n];let r=!1;return s.forEach(e=>{const t=o.H8.getStudy(e);t&&(t.series=t.series.sort(ne),r=!0)}),r?s:[]}};return o.pt.create(a)}function re(e,t){const{name:a}=e;let n;const s={initialize:async({params:e,query:s})=>{const r=s.get("url");if(!r)throw new Error(`No url for '${a}'`);{const a=await fetch(r),i=await a.json();if(!i.servers?.dicomWeb?.[0])throw new Error("Invalid configuration returned by url");n=W(i.servers.dicomWeb[0].configuration||i.servers.dicomWeb[0],t),n.initialize({params:e,query:s})}},query:{studies:{search:e=>n.query.studies.search(e)},series:{search:(...e)=>n.query.series.search(...e)},instances:{search:(e,t)=>n.query.instances.search(e,t)}},retrieve:{directURL:(...e)=>n.retrieve.directURL(...e),series:{metadata:async(...e)=>n.retrieve.series.metadata(...e)}},store:{dicom:(...e)=>n.store.dicom(...e)},deleteStudyMetadataPromise:(...e)=>n.deleteStudyMetadataPromise(...e),getImageIdsForDisplaySet:(...e)=>n.getImageIdsForDisplaySet(...e),getImageIdsForInstance:(...e)=>n.getImageIdsForInstance(...e),getStudyInstanceUIDs({params:e,query:t}){let n=[];const s=t.get("studyInstanceUIDs")||t.get("studyInstanceUids");if(!s)throw new Error(`No studyInstanceUids in request for '${a}'`);return n=s.split(";"),n}};return o.pt.create(s)}var ie=a(93008),oe=a.n(ie),ce=a(83424),le=a.n(ce);const ue={"query.studies.search":{mergeKey:"studyInstanceUid",tagFunc:e=>e},"query.series.search":{mergeKey:"seriesInstanceUid",tagFunc:(e,t)=>(e.forEach(e=>{e.RetrieveAETitle=t,o.H8.updateSeriesMetadata(e)}),e)}},de=async({mergeMap:e,path:t,args:a,extensionManager:n,dataSourceNames:s,defaultDataSourceName:r})=>{const{mergeKey:i,tagFunc:o}=e[t]||{tagFunc:e=>e},c=Object.values(n.dataSourceDefs),l=c.find(e=>e.sourceName===r),u=c.filter(e=>e.sourceName!==r);l&&u.unshift(l);const d=[],m=[];for(const e of u){const{configuration:r,sourceName:i}=e;if(r&&s.includes(i)){const[e]=n.getDataSources(i),s=oe()(e,t).apply(e,a);d.push(s),m.push(i)}}const p=(await Promise.allSettled(d)).map((e,t)=>o(e.value,m[t]));let g=[];return g=i?le()(p.flat(),e=>oe()(e,i)):p.flat(),g},me=({path:e,args:t,extensionManager:a,dataSourceNames:n,defaultDataSourceName:s})=>{const r=Object.values(a.dataSourceDefs),i=r.find(e=>e.sourceName===s),o=r.filter(e=>e.sourceName!==s);i&&o.unshift(i);const c=[];for(const s of o){const{configuration:r,sourceName:i}=s;if(r&&n.includes(i)){const[n]=a.getDataSources(i),s=oe()(n,e).apply(n,t);c.push(s)}}return c.flat()},pe=({path:e,args:t,defaultDataSourceName:a,extensionManager:n})=>{const[s]=n.getDataSources(a);return oe()(s,e).apply(s,t)},ge=({path:e,args:t,defaultDataSourceName:a,extensionManager:n})=>{const[s]=t,r=o.H8.getSeries(s.StudyInstanceUID,s.SeriesInstanceUID),[i]=n.getDataSources(r.RetrieveAETitle||a);return i[e](...t)};function Se(e,t,a){const{seriesMerge:n}=e,{dataSourceNames:s,defaultDataSourceName:r}=n,i={initialize:(...e)=>me({path:"initialize",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r}),query:{studies:{search:(...e)=>de({mergeMap:ue,path:"query.studies.search",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})},series:{search:(...e)=>de({mergeMap:ue,path:"query.series.search",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})},instances:{search:(...e)=>de({mergeMap:ue,path:"query.instances.search",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})}},retrieve:{bulkDataURI:(...e)=>de({mergeMap:ue,path:"retrieve.bulkDataURI",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r}),directURL:(...e)=>pe({path:"retrieve.directURL",args:e,defaultDataSourceName:r,extensionManager:a}),series:{metadata:(...e)=>de({mergeMap:ue,path:"retrieve.series.metadata",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})}},store:{dicom:(...e)=>pe({path:"store.dicom",args:e,defaultDataSourceName:r,extensionManager:a})},deleteStudyMetadataPromise:(...e)=>me({path:"deleteStudyMetadataPromise",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r}),getImageIdsForDisplaySet:(...e)=>ge({path:"getImageIdsForDisplaySet",args:e,defaultDataSourceName:r,extensionManager:a}),getImageIdsForInstance:(...e)=>ge({path:"getImageIdsForDisplaySet",args:e,defaultDataSourceName:r,extensionManager:a}),getStudyInstanceUIDs:(...e)=>me({path:"getStudyInstanceUIDs",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})};return o.pt.create(i)}const fe=function(){return[{name:"dicomweb",type:"webApi",createDataSource:W},{name:"dicomwebproxy",type:"webApi",createDataSource:re},{name:"dicomjson",type:"jsonApi",createDataSource:Q},{name:"dicomlocal",type:"localApi",createDataSource:se},{name:"merge",type:"mergeApi",createDataSource:Se}]};var ye=a(86326),Ie=a(97598),he=a.n(Ie),ve=a(96283),De=a(45981),we=a(4194),be=a(99993),Ee=a(20528);const{formatPN:xe,formatDate:Me}=o.Wp;const Ce=function(){const{servicesManager:e}=(0,o.Jg)(),{displaySetService:t}=e.services,[a,n]=(0,ye.useState)({PatientName:"",PatientID:"",PatientSex:"",PatientDOB:""}),[s,r]=(0,ye.useState)(!1),i=({displaySetsAdded:e})=>{if(!e.length)return;const a=e[0],s=a?.instances?.[0]||a?.instance;s&&(n({PatientID:s.PatientID||null,PatientName:s.PatientName?xe(s.PatientName):null,PatientSex:s.PatientSex||null,PatientDOB:Me(s.PatientBirthDate)||null}),(e=>{const a=t.getActiveDisplaySets();let n=!1;a.forEach(t=>{const a=t?.instances?.[0]||t?.instance;a&&a.PatientID!==e&&(n=!0)}),r(n)})(s.PatientID||null))};return(0,ye.useEffect)(()=>{const e=t.subscribe(t.EVENTS.DISPLAY_SETS_ADDED,e=>i(e));return()=>e.unsubscribe()},[]),{patientInfo:a,isMixedPatients:s}};let Pe=function(e){return e.VISIBLE="visible",e.VISIBLE_COLLAPSED="visibleCollapsed",e.DISABLED="disabled",e.VISIBLE_READONLY="visibleReadOnly",e}({});const Ue=(e,t)=>e?.length>t?e.substring(0,t)+"...":e;const Oe=function({servicesManager:e,appConfig:t}){const a=t.showPatientInfo===Pe.VISIBLE||t.showPatientInfo===Pe.VISIBLE_READONLY,[n,s]=(0,ye.useState)(a),{patientInfo:r,isMixedPatients:i}=Ce(e);(0,ye.useEffect)(()=>{i&&n&&s(!1)},[i,n]);const o=Ue(r.PatientName,27),c=Ue(r.PatientID,15);return ye.createElement("div",{className:"flex cursor-pointer items-center justify-center gap-1 rounded-lg hover:bg-[rgb(var(--primary-dark))]",onClick:()=>{i||t.showPatientInfo===Pe.VISIBLE_READONLY||s(!n)}},i?ye.createElement(ve.FI1.MultiplePatients,{className:"text-primary"}):ye.createElement(ve.FI1.Patient,{className:"text-primary"}),ye.createElement("div",{className:"flex flex-col justify-center"},n?ye.createElement(ye.Fragment,null,ye.createElement("div",{className:"self-start text-[13px] font-bold text-[rgb(var(--text))]"},o),ye.createElement("div",{className:"text-aqua-pale flex gap-2 text-[11px]"},ye.createElement("div",null,c),ye.createElement("div",null,r.PatientSex),ye.createElement("div",null,r.PatientDOB))):ye.createElement("div",{className:"text-primary self-center text-[13px]"},i?"Multiple Patients":"Patient")),ye.createElement(ve.FI1.ArrowLeft,{className:"text-primary "+(n?"rotate-180":"")}))};var Ne=a(7984);const Re=function({appConfig:e}){const{servicesManager:t,extensionManager:a,commandsManager:n}=(0,o.Jg)(),{customizationService:s}=t.services,r=(0,we.Zp)(),i=(0,we.zy)(),{t:c}=(0,be.Bd)(),{show:l}=(0,ve.hSE)(),u=s.getCustomization("ohif.aboutModal"),d=s.getCustomization("ohif.userPreferencesModal"),m=[{title:u?.menuTitle??c("Header:About"),icon:"info",onClick:()=>l({content:u,title:u?.title??c("AboutModal:About OHIF Viewer"),containerClassName:u?.containerClassName??"max-w-md"})},{title:d.menuTitle??c("Header:Preferences"),icon:"settings",onClick:()=>l({content:d,title:d.title??c("UserPreferencesModal:User preferences"),containerClassName:d?.containerClassName??"flex max-w-4xl p-6 flex-col"})}];return e.oidc&&m.push({title:c("Header:Logout"),icon:"power-off",onClick:async()=>{r(`/logout?redirect_uri=${encodeURIComponent(window.location.href)}`)}}),ye.createElement(ve.Y9Y,{menuOptions:m,isReturnEnabled:!!e.showStudyList,onClickReturnButton:()=>{const{pathname:e}=i,t=e.indexOf("/",1),n=e.substring(t+1),s=a.getDataSources(n),o=new URLSearchParams;-1!==t&&s&&o.append("datasources",e.substring(t+1)),(0,Ne.Nn)(o),r({pathname:"/",search:decodeURIComponent(o.toString())})},WhiteLabeling:e.whiteLabeling,Secondary:ye.createElement(Ee.M,{buttonSection:"secondary"}),PatientInfo:e.showPatientInfo!==Pe.DISABLED&&ye.createElement(Oe,{servicesManager:t,appConfig:e}),UndoRedo:ye.createElement("div",{className:"text-primary flex cursor-pointer items-center"},ye.createElement(ve.$nd,{variant:"ghost",className:"hover:bg-[rgb(var(--primary-dark))]",onClick:()=>{n.run("undo")}},ye.createElement(ve.FI1.Undo,{className:""})),ye.createElement(ve.$nd,{variant:"ghost",className:"hover:bg-[rgb(var(--primary-dark))]",onClick:()=>{n.run("redo")}},ye.createElement(ve.FI1.Redo,{className:""})))},ye.createElement("div",{className:"relative flex justify-center gap-[4px]"},ye.createElement(Ee.M,{buttonSection:"primary"})))};function Te(){return Te=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Te.apply(null,arguments)}const Ae=({servicesManager:e,side:t,activeTabIndex:a,isExpanded:n,tabs:s,onOpen:r,onClose:i,...o})=>{const{panelService:c,toolbarService:l,viewportGridService:u}=e.services,[d,m]=(0,ye.useState)(n),[p,g]=(0,ye.useState)(a??0),[S,f]=(0,ye.useState)(!1),[y,I]=(0,ye.useState)(s??c.getPanels(t)),h=(0,ye.useCallback)(({activeTabIndex:e})=>{const{activeViewportId:t}=u.getState();l.refreshToolbarState({viewportId:t}),g(e)},[l,u]),v=(0,ye.useCallback)(()=>{m(!0),r?.()},[r]),D=(0,ye.useCallback)(()=>{m(!1),f(!0),i?.()},[i]);return(0,ye.useEffect)(()=>{m(n)},[n]),(0,ye.useEffect)(()=>{g(a??0)},[a]),(0,ye.useEffect)(()=>{const{unsubscribe:e}=c.subscribe(c.EVENTS.PANELS_CHANGED,e=>{e.position===t&&I(c.getPanels(t))});return()=>{e()}},[c,t]),(0,ye.useEffect)(()=>{const e=c.subscribe(c.EVENTS.ACTIVATE_PANEL,e=>{if(d||e.forceActive){const t=y.findIndex(t=>t.id===e.panelId);-1!==t&&(S||m(!0),g(t))}});return()=>{e.unsubscribe()}},[y,d,c,S]),ye.createElement(ve.wv,Te({},o,{side:t,tabs:y,activeTabIndex:p,isExpanded:d,onOpen:v,onClose:D,onActiveTabIndexChange:h}))};var ke=a(17825);const Ve=(e,t)=>{e&&(e.style.minWidth=void 0===t?"":`${t}px`,e.style.maxWidth=e.style.minWidth)},Le=(e,t,a,n,s,r,i,o,c,l)=>{const[u]=(0,ye.useState)((({leftPanelInitialExpandedWidth:e=282,rightPanelInitialExpandedWidth:t=280,leftPanelMinimumExpandedWidth:a=145,rightPanelMinimumExpandedWidth:n=280})=>({groupId:"viewerLayoutResizablePanelGroup",shared:{expandedInsideBorderSize:0,collapsedInsideBorderSize:4,collapsedOutsideBorderSize:4,collapsedWidth:25},left:{panelId:"viewerLayoutResizableLeftPanel",initialExpandedWidth:e,minimumExpandedOffsetWidth:a+0,initialExpandedOffsetWidth:e+0,collapsedOffsetWidth:33},right:{panelId:"viewerLayoutResizableRightPanel",initialExpandedWidth:t,minimumExpandedOffsetWidth:n+0,initialExpandedOffsetWidth:t+0,collapsedOffsetWidth:33}}))({leftPanelInitialExpandedWidth:i,rightPanelInitialExpandedWidth:o,leftPanelMinimumExpandedWidth:c,rightPanelMinimumExpandedWidth:l})),[d,m]=(0,ye.useState)(u.left.initialExpandedWidth),[p,g]=(0,ye.useState)(u.right.initialExpandedWidth),[S,f]=(0,ye.useState)(0),[y,I]=(0,ye.useState)(0),[h,v]=(0,ye.useState)(0),[D,w]=(0,ye.useState)(0),b=(0,ye.useRef)(null),E=(0,ye.useRef)(null),x=(0,ye.useRef)(null),M=(0,ye.useRef)(null),C=(0,ye.useRef)(null),P=(0,ye.useRef)(!1),U=(0,ye.useRef)(null);(0,ye.useLayoutEffect)(()=>{const t=(0,ke.Gx)(u.groupId);b.current=t;const n=(0,ke.PV)(u.left.panelId);E.current=n;const s=(0,ke.PV)(u.right.panelId);x.current=s;const r=document.querySelectorAll("[data-panel-resize-handle-id]");if(U.current=0,r.forEach(e=>{U.current+=e.offsetWidth}),!e){const e=L(u.left.initialExpandedOffsetWidth);M?.current?.expand(e),Ve(n,u.left.initialExpandedOffsetWidth)}if(!a){const e=L(u.right.initialExpandedOffsetWidth);C?.current?.expand(e),Ve(s,u.right.initialExpandedOffsetWidth)}},[]),(0,ye.useLayoutEffect)(()=>{if(!M.current?.isCollapsed()){const e=L(d+u.shared.expandedInsideBorderSize);M.current?.resize(e)}if(!C?.current?.isCollapsed()){const e=L(p+u.shared.expandedInsideBorderSize);C?.current?.resize(e)}const e=new ResizeObserver(()=>{const e=L(u.left.minimumExpandedOffsetWidth),t=L(u.right.minimumExpandedOffsetWidth);f(e),I(t),v(L(u.left.collapsedOffsetWidth)),w(L(u.right.collapsedOffsetWidth))});return e.observe(b.current),()=>{e.disconnect()}},[d,p,S,y,s,r]);const O=(0,ye.useCallback)(e=>{e?(P.current=!0,Ve(E.current),Ve(x.current)):(P.current=!1,M?.current?.isExpanded()&&Ve(E.current,d+u.shared.expandedInsideBorderSize),C?.current?.isExpanded()&&Ve(x.current,p+u.shared.expandedInsideBorderSize))},[d,p]),N=(0,ye.useCallback)(()=>{t(!0),Ve(E.current),M?.current?.collapse()},[t]),R=(0,ye.useCallback)(()=>{M?.current?.expand(L(u.left.initialExpandedOffsetWidth)),t(!1)},[t]),T=(0,ye.useCallback)(e=>{if(!b?.current||M.current?.isCollapsed())return;const t=F(e);m(t),P.current||Ve(E.current,t)},[]),A=(0,ye.useCallback)(()=>{n(!0),Ve(x.current),C?.current?.collapse()},[n]),k=(0,ye.useCallback)(()=>{C?.current?.expand(L(u.right.initialExpandedOffsetWidth)),n(!1)},[n]),V=(0,ye.useCallback)(e=>{if(!b?.current||C?.current?.isCollapsed())return;const t=F(e);g(t),P.current||Ve(x.current,t)},[]),L=e=>{const{width:t}=b.current?.getBoundingClientRect();return e/(t-U.current)*100},F=e=>{const{width:t}=b.current?.getBoundingClientRect();return e/100*(t-U.current)-u.shared.expandedInsideBorderSize};return[{expandedWidth:d,collapsedWidth:u.shared.collapsedWidth,collapsedInsideBorderSize:u.shared.collapsedInsideBorderSize,collapsedOutsideBorderSize:u.shared.collapsedOutsideBorderSize,expandedInsideBorderSize:u.shared.expandedInsideBorderSize,onClose:N,onOpen:R},{expandedWidth:p,collapsedWidth:u.shared.collapsedWidth,collapsedInsideBorderSize:u.shared.collapsedInsideBorderSize,collapsedOutsideBorderSize:u.shared.collapsedOutsideBorderSize,expandedInsideBorderSize:u.shared.expandedInsideBorderSize,onClose:A,onOpen:k},{direction:"horizontal",id:u.groupId},{defaultSize:S,minSize:S,onResize:T,collapsible:!0,collapsedSize:h,onCollapse:()=>t(!0),onExpand:()=>t(!1),ref:M,order:0,id:u.left.panelId},{order:1,id:"viewerLayoutResizableViewportGridPanel"},{defaultSize:y,minSize:y,onResize:V,collapsible:!0,collapsedSize:D,onCollapse:()=>n(!0),onExpand:()=>n(!1),ref:C,order:2,id:u.right.panelId},O]};function Fe(){return Fe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Fe.apply(null,arguments)}const Be="mt-[1px] bg-[rgb(var(--background))]";function $e({extensionManager:e,servicesManager:t,hotkeysManager:a,commandsManager:n,viewports:s,ViewportGridComp:r,leftPanelClosed:i=!1,rightPanelClosed:c=!1,leftPanelResizable:l=!1,rightPanelResizable:u=!1,leftPanelInitialExpandedWidth:d,rightPanelInitialExpandedWidth:m,leftPanelMinimumExpandedWidth:p,rightPanelMinimumExpandedWidth:g}){const[S]=(0,De.r)(),{panelService:f,hangingProtocolService:y,customizationService:I}=t.services,[h,v]=(0,ye.useState)(S.showLoadingIndicator),D=(0,ye.useCallback)(e=>!!f.getPanels(e).length,[f]),[w,b]=(0,ye.useState)(D("right")),[E,x]=(0,ye.useState)(D("left")),[M,C]=(0,ye.useState)(i),[P,U]=(0,ye.useState)(c),[O,N,R,T,A,k,V]=Le(i,C,c,U,E,w,d,m,p,g),L=I.getCustomization("ui.loadingIndicatorProgress");(0,ye.useEffect)(()=>(document.body.classList.add("bg-[rgb(var(--background))]"),document.body.classList.add("overflow-hidden"),()=>{document.body.classList.remove("bg-[rgb(var(--background))]"),document.body.classList.remove("overflow-hidden")}),[]);(0,ye.useEffect)(()=>{const{unsubscribe:e}=y.subscribe(o.Qe.EVENTS.PROTOCOL_CHANGED,()=>{v(!1)});return()=>{e()}},[y]);(0,ye.useEffect)(()=>{const{unsubscribe:e}=f.subscribe(f.EVENTS.PANELS_CHANGED,({options:e})=>{x(D("left")),b(D("right")),void 0!==e?.leftPanelClosed&&C(e.leftPanelClosed),void 0!==e?.rightPanelClosed&&U(e.rightPanelClosed)});return()=>{e()}},[f,D]);const F=s.map(t=>{const{entry:a}=(t=>{const a=e.getModuleEntry(t);if(!a||!a.component)throw new Error(`${t} is not valid for an extension module or no component found from extension ${t}. Please verify your configuration or ensure that the extension is properly registered. It's also possible that your mode is utilizing a module from an extension that hasn't been included in its dependencies (add the extension to the "extensionDependencies" array in your mode's index.js file). Check the reference string to the extension in your Mode configuration`);return{entry:a}})(t.namespace);return{component:a.component,isReferenceViewable:a.isReferenceViewable,displaySetsToDisplay:t.displaySetsToDisplay}});return ye.createElement("div",null,ye.createElement(Re,{hotkeysManager:a,extensionManager:e,servicesManager:t,appConfig:S}),ye.createElement("div",{className:"relative flex w-full flex-row flex-nowrap items-stretch overflow-hidden bg-[rgb(var(--background))]",style:{height:"calc(100vh - 52px"}},ye.createElement(ye.Fragment,null,h&&ye.createElement(L,{className:"h-full w-full bg-[rgb(var(--background))]"}),ye.createElement(ve.HKS,R,E?ye.createElement(ye.Fragment,null,ye.createElement(ve.wVo,T,ye.createElement(Ae,Fe({side:"left",isExpanded:!M,servicesManager:t},O))),ye.createElement(ve.WM_,{onDragging:V,disabled:!l,className:Be})):null,ye.createElement(ve.wVo,A,ye.createElement("div",{className:"flex h-full flex-1 flex-col"},ye.createElement("div",{className:"relative flex h-full flex-1 items-center justify-center overflow-hidden bg-[rgb(var(--background))]",onMouseEnter:()=>{document.activeElement?.blur()}},ye.createElement(r,{servicesManager:t,viewportComponents:F,commandsManager:n})))),w?ye.createElement(ye.Fragment,null,ye.createElement(ve.WM_,{onDragging:V,disabled:!u,className:Be}),ye.createElement(ve.wVo,k,ye.createElement(Ae,Fe({side:"right",isExpanded:!P,servicesManager:t},N)))):null))),ye.createElement(ve.M7w,{tours:I.getCustomization("ohif.tours")}),ye.createElement(ve.jaF,{dialogConfiguration:S?.investigationalUseDialog}))}$e.propTypes={extensionManager:he().shape({getModuleEntry:he().func.isRequired}).isRequired,commandsManager:he().instanceOf(o.Sp),servicesManager:he().object.isRequired,leftPanels:he().array,rightPanels:he().array,leftPanelClosed:he().bool.isRequired,rightPanelClosed:he().bool.isRequired,children:he().oneOfType([he().node,he().func]).isRequired,viewports:he().array};const He=$e;var _e=a(40565);const ze=function(e,t){return new Promise((a,n)=>{const s=document.createElement("canvas");e.utilities.loadImageToCanvas({canvas:s,imageId:t,thumbnail:!0}).then(e=>{a(s.toDataURL())}).catch(n)})};const We=async function(e,t){if(!t?.length)return[];const a=t[0].mrn;return a?e.query.studies.search({patientId:a,disableWildcard:!0}):t};const qe=function(e,t,a,n){if(!t.activeDisplaySets.some(e=>e.StudyInstanceUID===a))return e.retrieve.series.metadata({StudyInstanceUID:a,madeInClient:n})};const je=function(){const{extensionManager:e}=(0,o.Jg)(),[t]=e.getActiveDataSource(),a=We.bind(null,t),n=(0,ye.useCallback)(function(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return ze.bind(null,e)}catch(e){throw new Error("Required command not found")}}(e),[]),s=qe.bind(null,t);return ye.createElement(_e.A,{dataSource:t,getImageSrc:n,getStudiesForPatientByMRN:a,requestDisplaySetCreationForStudy:s})};var Ge=a(96357);function Ye({title:e="Create Report",extensionManager:t,servicesManager:a}){const{uiDialogService:n,customizationService:s}=a.services,r=t.getDataSourcesForUI(),i=s.getCustomization("ohif.createReportDialog"),o=window.config.allowMultiSelectExport;return new Promise(function(t,a){n.show({id:"report-dialog",title:e,content:i,contentProps:{dataSources:o?r:void 0,onSave:async({reportName:e,dataSource:a,series:n})=>{t({value:e,dataSourceName:a,series:n,action:Ge.A.CREATE_REPORT})},onCancel:()=>{t({action:Ge.A.CANCEL,value:void 0,series:void 0,dataSourceName:void 0})},defaultValue:e}})})}var Je=a(40680);function Xe(){return Xe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Xe.apply(null,arguments)}const Ke=function({commandsManager:e,extensionManager:t,servicesManager:a}){return[{name:"seriesList",iconName:"tab-studies",iconLabel:"Studies",label:Je.A.t("SidePanel:Studies"),component:n=>ye.createElement(je,Xe({},n,{commandsManager:e,extensionManager:t,servicesManager:a}))}]};var Qe=a(68523);const Ze=JSON.parse('{"UU":"@ohif/extension-default"}').UU;var et=a(44563),tt=a(67803);const{toNumber:at}=o.Wp;var nt=a(37827);var st=a(3823);const{calculateScanAxisNormal:rt}=o.Wp;function it(e,t,a,n){const s=st.eR.scaleAndAdd(st.eR.create(),e,a,n);return st.eR.distance(t,s)>n}const{areAllImageOrientationsEqual:ot}=o.Wp;function ct(e,t){e.length>2&&(function(e){if(!e?.length)return!1;const t=e[0],a=at(t.Rows),n=at(t.Columns);for(let t=1;t<e.length;t++){const s=e[t],{Rows:r,Columns:i}=s;if(at(r)!==a||at(i)!==n)return!1}return!0}(e)||t.addMessage(o.Ob.CODES.INCONSISTENT_DIMENSIONS),function(e){if(!e?.length)return!1;const t=e[0],a=(0,nt.A)(t.SamplesPerPixel);for(let t=1;t<e.length;t++){const n=e[t],{SamplesPerPixel:s}=n;if(s!==a)return!1}return!0}(e)||t.addMessage(o.Ob.CODES.INCONSISTENT_COMPONENTS),ot(e)||t.addMessage(o.Ob.CODES.INCONSISTENT_ORIENTATIONS),function(e){if(!e?.length)return!1;const t=(0,nt.A)(e[0].ImageOrientationPatient);if(!t)return!1;const a=rt(t),n=(0,nt.A)(e[0].ImagePositionPatient),s=(0,nt.A)(e[e.length-1].ImagePositionPatient);if(!n||!s)return!1;const r=(0,tt.jj)(n,s)/(e.length-1);let i=n;for(let t=1;t<e.length;t++){const n=e[t],s=(0,nt.A)(n.ImagePositionPatient);if(it(i,s,a,r))return!1;i=s}return!0}(e)||t.addMessage(o.Ob.CODES.INCONSISTENT_POSITION_INFORMATION),function(e,t){if(!e?.length)return;const a=(0,nt.A)(e[0].ImagePositionPatient);if(!a)return;const n=(0,nt.A)(e[e.length-1].ImagePositionPatient),s=(0,tt.jj)(a,n)/(e.length-1);let r=a;const i=[];for(let a=1;a<e.length;a++){const n=e[a],c=(0,nt.A)(n.ImagePositionPatient),l=(0,tt.jj)(c,r),u=(0,tt.Op)(l,s);if(u){const e=u.issue;if(i.includes(e)||(i.push(e),e===tt.JG.MISSING_FRAMES?t.addMessage(o.Ob.CODES.MISSING_FRAMES):e===tt.JG.IRREGULAR_SPACING&&t.addMessage(o.Ob.CODES.IRREGULAR_SPACING)),i.length>1)break}r=c}}(e,t))}function lt(e,t,a){const n=new o.WZ;if(a)return n;if(!e.length)return void n.addMessage(o.Ob.CODES.NO_VALID_INSTANCES);const s=e[0],{Modality:r,ImageType:i,NumberOfFrames:c}=s;if(i?.includes("LOCALIZER"))return n;if(!tt.Hf.includes(r))return n;const l=c>1;l||e.every(e=>e.ImagePositionPatient)||n.addMessage(o.Ob.CODES.NO_POSITION_INFORMATION);const u=(0,et.A)(e);return l?function(e,t){(0,tt.Yt)(e)||t.addMessage(o.Ob.CODES.MULTIFRAME_NO_PIXEL_MEASUREMENTS),(0,tt.VX)(e)||t.addMessage(o.Ob.CODES.MULTIFRAME_NO_ORIENTATION),(0,tt.sL)(e)||t.addMessage(o.Ob.CODES.MULTIFRAME_NO_POSITION_INFORMATION)}(u[0],n):ct(u,n),t||n.addMessage(o.Ob.CODES.NOT_RECONSTRUCTABLE),n}var ut=a(14169);function dt(e){const t=new ut.A(e),a=new o.WZ,n=e[0];if(e.length){const e=n.SOPClassUID;e?a.addMessage(o.Ob.CODES.UNSUPPORTED_SOP_CLASS_UID,{sopClassUid:e}):a.addMessage(o.Ob.CODES.MISSING_SOP_CLASS_UID)}else a.addMessage(o.Ob.CODES.NO_VALID_INSTANCES);return t.setAttributes({displaySetInstanceUID:t.uid,SeriesDate:n.SeriesDate,SeriesTime:n.SeriesTime,SeriesInstanceUID:n.SeriesInstanceUID,StudyInstanceUID:n.StudyInstanceUID,SeriesNumber:n.SeriesNumber||0,FrameRate:n.FrameTime,SOPClassUID:n.SOPClassUID,SeriesDescription:n.SeriesDescription||"",Modality:n.Modality,numImageFrames:e.length,unsupported:!0,SOPClassHandlerId:"unsupported",isReconstructable:!1,messages:a}),[t]}const mt="chart",pt=(e,t)=>{const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s,SeriesDescription:r,SeriesNumber:i,SeriesDate:c,SOPClassUID:l}=e;return{Modality:"CHT",loading:!1,isReconstructable:!1,displaySetInstanceUID:o.Wp.guid(),SeriesDescription:r,SeriesNumber:i,SeriesDate:c,SOPInstanceUID:s,SeriesInstanceUID:n,StudyInstanceUID:a,SOPClassHandlerId:`${Ze}.sopClassHandlerModule.${mt}`,SOPClassUID:l,isDerivedDisplaySet:!0,isLoaded:!0,sopClassUids:t,instance:e,instances:[e],addInstances:function(e,t){return this.instances.push(...e),this.instance=this.instances[this.instances.length-1],this}}};function gt(e){if(!e||!e.length)throw new Error("No instances were provided");const t=function(e){const t=new Set;return e.forEach(e=>{t.add(e.SOPClassUID)}),Array.from(t)}(e);return e.map(e=>{if("CHT"===e.Modality)return pt(e,t);throw new Error("Unsupported modality")})}const St={name:mt,sopClassUids:["1.9.451.13215.7.3.2.7.6.1"],getDisplaySetsFromSeries:e=>gt(e)},{isImage:ft,sortStudyInstances:yt,instancesSortCriteria:It,sopClassDictionary:ht,isDisplaySetReconstructable:vt}=o.Wp,{ImageSet:Dt}=o.Ly,wt="stack";let bt={};const Et=e=>e.NumberOfFrames>1;function xt(e){const t=(e=>{const{extensionManager:t}=bt;if(!t)throw new Error("extensionManager is not available");const a=e.map(({imageId:e})=>e),n=t.getModuleEntry("@ohif/extension-cornerstone.utilityModule.volumeLoader"),{getDynamicVolumeInfo:s}=n.exports;return s(a)})(e),{isDynamicVolume:a,timePoints:n}=t;let s;const{appConfig:r}=bt;if(a){const t=n[0],a=new Map;e.forEach(e=>a.set(e.imageId,e));const i=t.map(e=>a.get(e));s=vt(i,r)}else s=vt(e,r);return{isDynamicVolume:a,...s,dynamicVolumeInfo:t}}const Mt=e=>{yt(e);const t=e[0],a=new Dt(e),{extensionManager:n}=bt,s=n.getActiveDataSource()[0],{isDynamicVolume:r,value:i,averageSpacingBetweenFrames:o,dynamicVolumeInfo:c}=xt(e),l=r?"cornerstoneStreamingDynamicImageVolume":"cornerstoneStreamingImageVolume",u=lt(e,i,r);a.setAttributes({volumeLoaderSchema:l,displaySetInstanceUID:a.uid,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,SeriesNumber:t.SeriesNumber||0,FrameRate:t.FrameTime,SOPClassUID:t.SOPClassUID,SeriesDescription:t.SeriesDescription||"",Modality:t.Modality,isMultiFrame:Et(t),countIcon:i?"icon-mpr":void 0,numImageFrames:e.length,SOPClassHandlerId:`${Ze}.sopClassHandlerModule.${wt}`,isReconstructable:i,messages:u,averageSpacingBetweenFrames:o||null,isDynamicVolume:r,dynamicVolumeInfo:c,supportsWindowLevel:!0,label:t.SeriesDescription||`${Qe.A.t("Series")} ${t.SeriesNumber} - ${Qe.A.t(t.Modality)}`,FrameOfReferenceUID:t.FrameOfReferenceUID});const d=s.getImageIdsForDisplaySet(a);let m=d[Math.floor(d.length/2)],p=e[Math.floor(e.length/2)];if(r){const e=c.timePoints,t=e[Math.floor(e.length/2)];m=t[Math.floor(t.length/2)]}a.setAttributes({getThumbnailSrc:s.retrieve.getGetThumbnailSrc?.(p,m)});const{servicesManager:g}=bt,{customizationService:S}=g.services;return a.sort(S),a};function Ct(e){if(!e||!e.length)throw new Error("No instances were provided");const t=[],a=function(e){const t=new Set;return e.forEach(e=>{t.add(e.SOPClassUID)}),Array.from(t)}(e),n=[];if(e.forEach(e=>{if(!ft(e.SOPClassUID)&&!e.Rows)return;let s;var r;Et(e)?(s=Mt([e]),s.setAttributes({sopClassUids:a,numImageFrames:e.NumberOfFrames,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(s)):"CR"===(r=e.Modality)||"MG"===r||"DX"===r?(s=Mt([e]),s.setAttributes({sopClassUids:a,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(s)):n.push(e)}),n.length){const s=Mt(n);s.setAttribute("studyInstanceUid",e[0].StudyInstanceUID),s.setAttributes({sopClassUids:a}),t.push(s)}return t}const Pt=[ht.ComputedRadiographyImageStorage,ht.DigitalXRayImageStorageForPresentation,ht.DigitalXRayImageStorageForProcessing,ht.DigitalMammographyXRayImageStorageForPresentation,ht.DigitalMammographyXRayImageStorageForProcessing,ht.DigitalIntraOralXRayImageStorageForPresentation,ht.DigitalIntraOralXRayImageStorageForProcessing,ht.CTImageStorage,ht.EnhancedCTImageStorage,ht.LegacyConvertedEnhancedCTImageStorage,ht.UltrasoundMultiframeImageStorage,ht.MRImageStorage,ht.EnhancedMRImageStorage,ht.EnhancedMRColorImageStorage,ht.LegacyConvertedEnhancedMRImageStorage,ht.UltrasoundImageStorage,ht.UltrasoundImageStorageRET,ht.SecondaryCaptureImageStorage,ht.MultiframeSingleBitSecondaryCaptureImageStorage,ht.MultiframeGrayscaleByteSecondaryCaptureImageStorage,ht.MultiframeGrayscaleWordSecondaryCaptureImageStorage,ht.MultiframeTrueColorSecondaryCaptureImageStorage,ht.XRayAngiographicImageStorage,ht.EnhancedXAImageStorage,ht.XRayRadiofluoroscopicImageStorage,ht.EnhancedXRFImageStorage,ht.XRay3DAngiographicImageStorage,ht.XRay3DCraniofacialImageStorage,ht.BreastTomosynthesisImageStorage,ht.BreastProjectionXRayImageStorageForPresentation,ht.BreastProjectionXRayImageStorageForProcessing,ht.IntravascularOpticalCoherenceTomographyImageStorageForPresentation,ht.IntravascularOpticalCoherenceTomographyImageStorageForProcessing,ht.NuclearMedicineImageStorage,ht.VLEndoscopicImageStorage,ht.VideoEndoscopicImageStorage,ht.VLMicroscopicImageStorage,ht.VideoMicroscopicImageStorage,ht.VLSlideCoordinatesMicroscopicImageStorage,ht.VLPhotographicImageStorage,ht.VideoPhotographicImageStorage,ht.OphthalmicPhotography8BitImageStorage,ht.OphthalmicPhotography16BitImageStorage,ht.OphthalmicTomographyImageStorage,ht.PositronEmissionTomographyImageStorage,ht.EnhancedPETImageStorage,ht.LegacyConvertedEnhancedPETImageStorage,ht.RTImageStorage,ht.EnhancedUSVolumeStorage,ht.RTDoseStorage];const Ut=function(e){return bt=e,[{name:wt,sopClassUids:Pt,getDisplaySetsFromSeries:Ct},{name:"not-supported-display-sets-handler",sopClassUids:[],getDisplaySetsFromSeries:dt},{name:St.name,sopClassUids:St.sopClassUids,getDisplaySetsFromSeries:St.getDisplaySetsFromSeries}]};function Ot(){return Ot=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Ot.apply(null,arguments)}function Nt({commandsManager:e,servicesManager:t,rows:a=3,columns:n=4,...s}){const{customizationService:r}=t.services,{t:i}=(0,be.Bd)("ToolbarLayoutSelector"),o=r?.getCustomization("layoutSelector.commonPresets")||[{icon:"layout-single",commandOptions:{numRows:1,numCols:1}},{icon:"layout-side-by-side",commandOptions:{numRows:1,numCols:2}},{icon:"layout-four-up",commandOptions:{numRows:2,numCols:2}},{icon:"layout-three-row",commandOptions:{numRows:3,numCols:1}}],c=r?.getCustomization("layoutSelector.advancedPresetGenerator"),l=c?c({servicesManager:t}):[{title:"MPR",icon:"layout-three-col",commandOptions:{protocolId:"mpr"}},{title:"3D four up",icon:"layout-four-up",commandOptions:{protocolId:"3d-four-up"}},{title:"3D main",icon:"layout-three-row",commandOptions:{protocolId:"3d-main"}},{title:"Axial Primary",icon:"layout-side-by-side",commandOptions:{protocolId:"axial-primary"}},{title:"3D only",icon:"layout-single",commandOptions:{protocolId:"3d-only"}},{title:"3D primary",icon:"layout-side-by-side",commandOptions:{protocolId:"3d-primary"}},{title:"Frame View",icon:"icon-stack",commandOptions:{protocolId:"frame-view"}}],u=(0,ye.useCallback)((t,a)=>{a?e.run({commandName:"setHangingProtocol",commandOptions:t}):e.run({commandName:"setViewportGridLayout",commandOptions:t})},[e]);return ye.createElement("div",{id:"Layout","data-cy":"Layout"},ye.createElement(ve.sG4,Ot({onSelectionChange:u},s),ye.createElement(ve.sG4.Trigger,{tooltip:i("Change layout")}),ye.createElement(ve.sG4.Content,null,(o.length>0||l.length>0)&&ye.createElement("div",{className:"bg-popover flex flex-col gap-2.5 rounded-lg p-2"},o.length>0&&ye.createElement(ye.Fragment,null,ye.createElement(ve.sG4.PresetSection,{title:i("Common")},o.map((e,t)=>ye.createElement(ve.sG4.Preset,{key:`common-preset-${t}`,icon:e.icon,commandOptions:e.commandOptions,isPreset:!1}))),ye.createElement(ve.sG4.Divider,null)),l.length>0&&ye.createElement(ve.sG4.PresetSection,{title:i("Advanced")},l.map((e,t)=>ye.createElement(ve.sG4.Preset,{key:`advanced-preset-${t}`,title:e.title,icon:e.icon,commandOptions:e.commandOptions,disabled:e.disabled,isPreset:!0})))),ye.createElement("div",{className:"bg-muted flex flex-col gap-2.5 border-l-2 border-solid border-black p-2"},ye.createElement("div",{className:"text-muted-foreground text-xs"},i("Custom")),ye.createElement(ve.sG4.GridSelector,{rows:a,columns:n}),ye.createElement(ve.sG4.HelpText,null,i("Hover to select")," ",ye.createElement("br",null),i("rows and columns")," ",ye.createElement("br",null),i("Click to apply"))))))}Nt.propTypes={commandsManager:he().instanceOf(o.Sp),servicesManager:he().object,rows:he().number,columns:he().number};const Rt=Nt,Tt=(e=[])=>e.map(e=>({label:e.name,value:e.id,info:e.info,activated:!1,completed:!1}));function At(){const{servicesManager:e}=(0,o.Jg)(),{workflowStepsService:t}=e.services,[a,n]=(0,ye.useState)(t.activeWorkflowStep?.id),[s,r]=(0,ye.useState)(Tt(t.workflowSteps)),i=(0,ye.useCallback)(e=>{e.completed||r(t=>{const a=[...t];for(let t=a.findIndex(t=>t.value===e.value);t>=0;t--){const e=a[t];if(e.completed)break;a[t]={...e,completed:!0}}return a})},[]),c=(0,ye.useCallback)(({selectedOption:e})=>{e&&(i(e),n(e.value))},[i]);return(0,ye.useEffect)(()=>(a&&t.setActiveWorkflowStep(a),()=>clearTimeout(undefined)),[a,t]),(0,ye.useEffect)(()=>{const{unsubscribe:e}=t.subscribe(t.EVENTS.STEPS_CHANGED,()=>r(Tt(t.workflowSteps))),{unsubscribe:a}=t.subscribe(t.EVENTS.ACTIVE_STEP_CHANGED,()=>n(t.activeWorkflowStep.id));return()=>{e(),a()}},[e,t]),ye.createElement(ve.LWY,{options:s,value:a,onChange:c})}function kt(){return kt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},kt.apply(null,arguments)}function Vt({buttonSection:e,id:t}){const{onInteraction:a,toolbarButtons:n}=(0,o.tR)({buttonSection:e});if(!n?.length)return null;const s=n.find(e=>e.componentProps.isActive)?.componentProps||n[0].componentProps,r=n.map(e=>e.componentProps);return ye.createElement(ve.XI3,null,ye.createElement(ve.mkO,null,ye.createElement("div",{"data-cy":`${t}-split-button-primary`,"data-tool":s.id,"data-active":s.isActive},ye.createElement(ve.T0e,kt({},s,{onInteraction:({itemId:e})=>a?.({id:t,itemId:e,commands:s.commands}),className:s.className})))),ye.createElement(ve.ItI,{className:s.isActive?"opacity-0":"opacity-100"}),ye.createElement("div",{"data-cy":`${t}-split-button-secondary`},ye.createElement(ve.oID,null,r.map(e=>ye.createElement(ve.U$I,kt({key:e.id},e,{"data-cy":e.id,"data-tool":e.id,"data-active":e.isActive,onSelect:()=>a?.({id:t,itemId:e.id,commands:e.commands})}),ye.createElement("span",{className:"pl-1"},e.label||e.tooltip||e.id))))))}function Lt(){return Lt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Lt.apply(null,arguments)}const Ft=function({buttonSection:e,className:t="",show:a=!0}){const{onInteraction:n,toolbarButtons:s}=(0,o.tR)({buttonSection:e});return s?.length?ye.createElement("div",{className:`space-x-1} flex flex-row items-center ${t}`},s.map((t,a)=>{const{id:s,Component:r,componentProps:i}=t;return ye.createElement("div",{key:s||a,className:"flex-shrink-0"},ye.createElement(r,Lt({},i,{onInteraction:n,location:i.location||e})))})):null};var Bt=a(55530),$t=a.n(Bt),Ht=a(8992);function _t(){return _t=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},_t.apply(null,arguments)}function zt({buttonSection:e,id:t}){const{onInteraction:a,toolbarButtons:n}=(0,Ht.t)({buttonSection:e});if(!e)return null;const s=n.map(e=>e.componentProps);return ye.createElement("div",{className:"bg-popover flex flex-row space-x-1 rounded-md px-0 py-0"},s.map(e=>ye.createElement(ve.T0e,_t({},e,{key:e.id,size:"small",className:e.disabled&&"text-foreground/70",onInteraction:n=>{a?.({event:n,id:t,commands:e.commands,itemId:e.id,item:e})}}))))}function Wt({onInteraction:e,className:t,options:a,...n}){return ye.createElement("div",{className:"bg-popover flex flex-row rounded-md px-0 py-0"},ye.createElement(ve.T0e,_t({},n,{id:n.id,size:"small",className:$t()(n.disabled&&"text-foreground/70",t),onInteraction:t=>{e?.({event:t,itemId:n.id,commands:n.commands,options:a})}})))}function qt(){return qt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},qt.apply(null,arguments)}function jt(e){const{IconContainer:t,containerProps:a}=(0,ve.n1D)(),n=ye.createElement(ve.FI1.ByName,{name:e.icon});return ye.createElement("div",null,t?ye.createElement(t,qt({disabled:e.disabled},e,a),n):ye.createElement(ve.$nd,{variant:"ghost",size:"icon",disabled:e.disabled},n))}function Gt(e,t,a,n){const s={selectorProps:e,event:t},r=function(e,t,a){const{subMenu:n}=t,s=function*(){yield function(e,t){if(t)return e.find(e=>e.id===t)}(e,a||n),yield function(e,t){return e?e.find(e=>!e.selector||e.selector(t.selectorProps)):null}(e,t)}();let r=s.next(),i=r.value;for(;!r.done;)i=r.value,i&&s.return(),r=s.next();return i}(a,s,n);if(!r)return;if(!r.items)return console.warn("Must define items in menu",r),[];let i=[];return r.items.forEach(n=>{const{delegating:r,selector:o,subMenu:c}=n;if(!o||o(e))if(r)i=[...i,...Gt(e,t,a,c)];else{const e=function(e,t){const a={...e,value:t.selectorProps?.value};"ShowSubMenu"!==e.actionType||a.iconRight||(a.iconRight="chevron-down");e.action||(a.action=(e,n)=>{const{event:s={}}=n,{detail:r={}}=s;a.element=r.element,n.onClose();const i=n[`on${e.actionType||"Default"}`];i?i.call(n,a,e,t):console.warn("No action defined for",e)});return a}(n,s);i.push(e)}}),i}var Yt,Jt=a(4667);class Xt{constructor(e,t){this.commandsManager=void 0,this.services=void 0,this.menuItems=void 0,this.services=e.services,this.commandsManager=t}closeContextMenu(){this.services.uiDialogService.hide("context-menu")}showContextMenu(e,t,a){if(!this.services.uiDialogService)return void console.warn("Unable to show dialog; no UI Dialog Service available.");const{event:n,subMenu:s,menuId:r,menus:i,selectorProps:o}=e;if(!i)return void console.warn("No menus found for",r);const{locking:c,visibility:l}=Jt.annotation,u=o?.nearbyToolData?.annotationUID;if(u){const e=c.isAnnotationLocked(u),t=l.isAnnotationVisible(u);if(e||!t)return void console.warn(`Annotation is ${e?"locked":"not visible"}.`)}const d=Gt(o||e,n,i,r);if(!d)return;const m=this.services.customizationService.getCustomization("ui.contextMenu");this.services.uiDialogService.hide("context-menu"),this.services.uiDialogService.show({id:"context-menu",showOverlay:!1,defaultPosition:Xt._getDefaultPosition(a,n?.detail||n,t),content:m,shouldCloseOnEsc:!0,shouldCloseOnOverlayClick:!0,unstyled:!0,contentProps:{items:d,selectorProps:o,menus:i,event:n,subMenu:s,eventData:n?.detail||n,onClose:()=>{this.services.uiDialogService.hide("context-menu")},onShowSubMenu:(n,s,r)=>{s.subMenu?this.showContextMenu({...e,menuId:s.subMenu},t,a):console.warn("No submenu defined for",n,s,r)},onDefault:(e,t,a)=>{this.commandsManager.run(e,{...o,...t,subProps:a})}}})}}Yt=Xt,Xt.getDefaultPosition=()=>({x:0,y:0}),Xt._getEventDefaultPosition=e=>({x:e?.currentPoints?.client[0]??e?.pageX,y:e?.currentPoints?.client[1]??e?.pageY}),Xt._getElementDefaultPosition=e=>{if(e){const t=e.getBoundingClientRect();return{x:t.x,y:t.y}}return{x:void 0,y:void 0}},Xt._getCanvasPointsPosition=(e=[],t)=>{const a=Yt._getElementDefaultPosition(t);for(let t=0;t<e.length;t++){const n={x:e[t][0]||e[t].x,y:e[t][1]||e[t].y};if(Yt._isValidPosition(n)&&Yt._isValidPosition(a))return{x:n.x+a.x,y:n.y+a.y}}},Xt._isValidPosition=e=>e&&"number"==typeof e.x&&"number"==typeof e.y,Xt._getDefaultPosition=(e,t,a)=>{const n=function*(){yield Yt._getCanvasPointsPosition(e,a),yield Yt._getEventDefaultPosition(t),yield Yt._getElementDefaultPosition(a),yield Yt.getDefaultPosition()}();let s=n.next(),r=s.value;for(;!s.done;)r=s.value,Yt._isValidPosition(r)&&n.return(),s=n.next();return r};var Kt=a(14867),Qt=a.n(Kt),Zt=a(28271),ea=a(62051),ta=a.n(ea);const aa={padding:"10px 0"},na={borderBottomWidth:"1px",...aa},sa=({row:e,style:t,keyPrefix:a,onToggle:n})=>{const s=(0,ye.useCallback)(()=>{n(!e.areChildrenVisible)},[e.areChildrenVisible,n]),r=e.children&&e.children.length>0||e.depth>0,i=8*(1+2*e.depth);return ye.createElement("div",{style:{...t,...na},className:$t()("hover:bg-secondary-main border-secondary-light text-foreground flex w-full flex-row items-center break-all bg-[rgb(var(--background))] text-base transition duration-300","leading-[20px]"),key:a},r&&ye.createElement("div",{style:{paddingLeft:`${i}px`,opacity:n?1:0}},e.areChildrenVisible?ye.createElement("div",{className:"cursor-pointer p-1",onClick:s},ye.createElement(ve.FI1.ChevronDown,null)):ye.createElement("div",{className:"cursor-pointer p-1",onClick:s},ye.createElement(ve.FI1.ChevronRight,null))),ye.createElement("div",{className:"w-4/24 px-3"},e.tag),ye.createElement("div",{className:"w-2/24 px-3"},e.valueRepresentation),ye.createElement("div",{className:"w-6/24 px-3"},e.keyword),ye.createElement("div",{className:"w-5/24 grow px-3"},e.value))};function ra({tagRef:e,vrRef:t,keywordRef:a,valueRef:n}){return ye.createElement("div",{className:$t()("ohif-scrollbar flex w-full flex-row overflow-y-scroll bg-[rgb(var(--secondary-dark))]"),style:aa},ye.createElement("div",{className:"w-4/24 px-3"},ye.createElement("label",{ref:e,className:"flex flex-1 select-none flex-col pl-1 text-lg text-[rgb(var(--text))]"},ye.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Tag"))),ye.createElement("div",{className:"w-2/24 px-3"},ye.createElement("label",{ref:t,className:"flex flex-1 select-none flex-col pl-1 text-lg text-[rgb(var(--text))]"},ye.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"VR"))),ye.createElement("div",{className:"w-6/24 px-3"},ye.createElement("label",{ref:a,className:"flex flex-1 select-none flex-col pl-1 text-lg text-[rgb(var(--text))]"},ye.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Keyword"))),ye.createElement("div",{className:"w-5/24 grow px-3"},ye.createElement("label",{ref:n,className:"flex flex-1 select-none flex-col pl-1 text-lg text-[rgb(var(--text))]"},ye.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Value"))))}function ia({rows:e}){const t=(0,ye.useRef)(),a=(0,ye.useRef)(),[n,s]=(0,ye.useState)(null),[r,i]=(0,ye.useState)(null),[o,c]=(0,ye.useState)(null),[l,u]=(0,ye.useState)(null),[d,m]=(0,ye.useState)(e);(0,ye.useEffect)(()=>{m(e)},[e]);const p=(0,ye.useMemo)(()=>d.filter(e=>e.isVisible),[d]);(0,ye.useEffect)(()=>{t?.current&&(t.current.scrollTo(0),t.current.resetAfterIndex(0))},[e]),(0,ye.useEffect)(()=>{const e=ta()(()=>t.current.resetAfterIndex(0),100);return window.addEventListener("resize",e),()=>{e.cancel(),window.removeEventListener("resize",e)}},[]);const g=(0,ye.useCallback)(e=>{const t=[n.offsetWidth,r.offsetWidth,o.offsetWidth,l.offsetWidth],s=a.current.getContext("2d");s.font=getComputedStyle(a.current).font;const i=["tag","valueRepresentation","keyword","value"];return Object.entries(e).filter(([e])=>i.includes(e)).map(([,e],a)=>{const n=s.measureText(e).width;return 20*Math.ceil(n/t[a])+20+1}).reduce((e,t)=>Math.max(e,t),0)},[o,n,l,r]),S=(0,ye.useCallback)(e=>t=>{const a=e[t];return g(a)},[g]),f=(0,ye.useCallback)(e=>{if(e.children)return a=>{const n=d.map(t=>e.uid===t.uid?{...t,areChildrenVisible:a}:e.children.includes(t.uid)?{...t,isVisible:a,areChildrenVisible:a}:t);m(n),t?.current?.resetAfterIndex(0)}},[d,t]),y=(0,ye.useCallback)(({rows:e})=>function({index:t,style:a}){const n=(0,ye.useMemo)(()=>e[t],[t]);return ye.createElement(sa,{style:a,row:n,keyPrefix:`DICOMTagRow-${t}`,onToggle:f(n)})},[f]),I=(0,ye.useCallback)(()=>null!==n,[n]);return ye.createElement("div",null,ye.createElement("canvas",{style:{visibility:"hidden",position:"absolute"},className:"text-base",ref:a}),ye.createElement(ra,{tagRef:e=>{e&&s(e)},vrRef:e=>{e&&i(e)},keywordRef:e=>{e&&c(e)},valueRef:e=>{e&&u(e)}}),ye.createElement("div",{className:"relative m-auto border-2 border-black bg-[rgb(var(--background))]",style:{height:"32rem"}},I()&&ye.createElement(Zt._m,{ref:t,height:500,itemCount:p.length,itemSize:S(p),width:"100%",className:"ohif-scrollbar text-foreground"},y({rows:p}))))}const oa=ye.memo(ia);let ca=0;const la=()=>"row_"+ ++ca,{ImageSet:ua}=o.Ly,{DicomMetaDictionary:da}=f.Ay.data,{nameMap:ma}=da;function pa(e,t=0){const a=Object.keys(e),n=[];for(let s=0;s<a.length;s++){let r=a[s];if("_vrMap"===r)continue;const i=ma[r];let o=e[r];if(i&&"SQ"===i.vr){const e=ga(o),a={tag:i.tag,vr:i.vr,keyword:r,values:[]};if(n.push(a),null===o)continue;e.forEach(e=>{const n=pa(e,t+1);n.length&&(Sa(n),a.values.push(n))});continue}if(Array.isArray(o)&&o.length>0&&"object"!=typeof o[0]&&(o=o.join("\\")),"number"==typeof o&&(o=o.toString()),"string"!=typeof o&&(null===o?o=" ":"object"==typeof o?o.InlineBinary?o="Inline Binary":o.BulkDataURI?o="Bulk Data URI":o.Alphabetic?o=o.Alphabetic:(console.warn(`Unrecognised Value: ${o} for ${r}:`),console.warn(o),o=" "):(console.warn(`Unrecognised Value: ${o} for ${r}:`),o=" ")),r=r.replace("RETIRED_",""),i)n.push({tag:i.tag,vr:i.vr,keyword:r,value:o});else{const e=/[0-9A-Fa-f]{6}/g;if(r.match(e)){const e=`(${r.substring(0,4)},${r.substring(4,8)})`;n.push({tag:e,vr:"",keyword:"Private Tag",value:o})}}}return n}function ga(e){return Array.isArray(e)?e:[e]}function Sa(e){e.sort((e,t)=>e.tag<t.tag?-1:1)}const fa=({displaySets:e,displaySetInstanceUID:t})=>{const[a,n]=(0,ye.useState)(t),[s,r]=(0,ye.useState)(1),[i,o]=(0,ye.useState)(!1),[c,l]=(0,ye.useState)(""),u=e.find(e=>e.displaySetInstanceUID===a),d=(0,ye.useMemo)(()=>(e.sort((e,t)=>e.SeriesNumber-t.SeriesNumber),e.map(e=>{const{displaySetInstanceUID:t,SeriesDate:a,SeriesTime:n,SeriesNumber:s,SeriesDescription:r,Modality:i}=e,o=`${a}:${n}`.split(".")[0];return{value:t,label:`${s} (${i}):  ${r}`,description:Qt()(o,"YYYYMMDD:HHmmss").format("ddd, MMM Do YYYY")}})),[e]),m=(0,ye.useCallback)(e=>e?u.images[s-1]:u.instance||u,[u,s]),p=(0,ye.useMemo)(()=>{const e=u instanceof ua,t=m(e);o(e&&u.images.length>1);const a=function(e){const t=pa(e);return Sa(t),t}(t),n=function({tags:e,metadata:t}){const a=[],n=[{tags:e,depth:0,parents:null,index:0,children:[]}],s=new Map;for(;n.length>0;){const e=n.pop(),{tags:r,depth:i,parents:o,index:c,children:l}=e;for(let e=c;e<r.length;e++){const c=r[e],u=c.uid??la();if(o?.length>0&&o.forEach(e=>{s.get(e).push(u)}),"SQ"===c.vr){const t={uid:u,tag:c.tag,valueRepresentation:c.vr,keyword:c.keyword,value:"",depth:i,isVisible:!0,areChildrenVisible:!0,children:[],parents:o};a.push(t),s.set(u,t.children);const d=o?[...o,u]:[u];if(c.values.length>0){n.push({tags:r,depth:i,parents:o,index:e+1,children:l});for(let e=c.values.length-1,t=c.values[e];e>=0;t=c.values[--e]){const a=la();n.push({tags:t,depth:i+2,parents:[...d,a],index:0,children:[]});const r={tags:[{tag:"(FFFE,E000)",vr:"",keyword:`Item #${e}`,value:"",uid:a}],depth:i+1,parents:d,index:0,children:[]};n.push(r),s.set(a,r.children)}break}}else{if("xs"===c.vr)try{const e=t[f.Ay.data.Tag.fromPString(c.tag).toCleanString()];c.vr=e.vr}catch(e){console.warn(`Failed to parse value representation for tag '${c.keyword}'`)}const e={uid:u,tag:c.tag,valueRepresentation:c.vr,keyword:c.keyword,value:c.value,depth:i,isVisible:!0,parents:o};a.push(e),"(FFFE,E000)"===e.tag&&(e.areChildrenVisible=!0,e.children=[])}}}return a}({tags:a,metadata:t});return n},[m,u]),g=(0,ye.useMemo)(()=>{if(!c)return p;const e=new Set,t=["tag","valueRepresentation","keyword","value"],a=c.toLowerCase();return p.forEach(n=>{t.some(e=>n[e]?.toLowerCase().includes(a))&&(e.add(n.uid),[...n.parents??[],...n.children??[]].forEach(t=>e.add(t)))}),p.filter(t=>e.has(t.uid))},[p,c]);return ye.createElement("div",{className:"dicom-tag-browser-content bg-muted"},ye.createElement("div",{className:"mb-6 flex flex-row items-start pl-1"},ye.createElement("div",{className:"flex w-full flex-row items-start gap-4"},ye.createElement("div",{className:"flex w-1/3 flex-col"},ye.createElement("span",{className:"text-muted-foreground flex h-6 items-center pb-2 text-base"},"Series"),ye.createElement(ve.l6P,{value:a,onValueChange:e=>(e=>{n(e.value),r(1)})({value:e})},ye.createElement(ve.bqE,null,d.find(e=>e.value===a)?.label||"Select Series"),ye.createElement(ve.gCo,null,d.map(e=>ye.createElement(ve.ebT,{key:e.value,value:e.value},e.label,ye.createElement("span",{className:"text-muted-foreground ml-1 text-xs"},e.description)))))),i&&ye.createElement("div",{className:"mx-auto mt-0.5 flex w-1/4 flex-col"},ye.createElement("span",{className:"text-muted-foreground flex h-6 items-center pb-2 text-base"},"Instance Number (",s," of ",u?.images?.length,")"),ye.createElement(ve.Apm,{value:[s],onValueChange:([e])=>{r(e)},min:1,max:u?.images?.length,step:1,className:"pt-4"})),ye.createElement("div",{className:"ml-auto mr-1 flex w-1/3 flex-col"},ye.createElement("span",{className:"text-muted-foreground flex h-6 items-center pb-2 text-base"},"Search metadata"),ye.createElement(ve.zbB,{className:"text-muted-foreground",onChange:l},ye.createElement(ve.zbB.SearchIcon,null),ye.createElement(ve.zbB.Input,{placeholder:"Search metadata",className:"pl-9 pr-9"}),ye.createElement(ve.zbB.ClearButton,{className:"text-primary mr-0.5 p-0.5"}))))),ye.createElement(oa,{rows:g}))};var ya=a(78713);a(21978);const Ia=e=>({type:"viewportGridId",viewportGridState:{},setViewportGridState:(t,a)=>e(e=>({viewportGridState:{...e.viewportGridState,[t]:a}}),!1,"setViewportGridState"),clearViewportGridState:()=>e({viewportGridState:{}},!1,"clearViewportGridState")}),ha=(0,ya.vt)()(Ia),va=e=>({type:"displaySetSelectorId",displaySetSelectorMap:{},setDisplaySetSelector:(t,a)=>e(e=>({displaySetSelectorMap:{...e.displaySetSelectorMap,[t]:a}}),!1,"setDisplaySetSelector"),clearDisplaySetSelectorMap:()=>e({displaySetSelectorMap:{}},!1,"clearDisplaySetSelectorMap")}),Da=(0,ya.vt)()(va),wa=e=>({hangingProtocolStageIndexMap:{},type:"hangingProtocolStageIndexId",setHangingProtocolStageIndex:(t,a)=>e(e=>({hangingProtocolStageIndexMap:{...e.hangingProtocolStageIndexMap,[t]:a}}),!1,"setHangingProtocolStageIndex"),clearHangingProtocolStageIndexMap:()=>e({hangingProtocolStageIndexMap:{}},!1,"clearHangingProtocolStageIndexMap")}),ba=(0,ya.vt)()(wa),Ea=(e,t)=>{const{activeViewportId:a}=e,{protocol:n}=t.getActiveProtocol();if(!n)return;const s=t.getState(),{protocolId:r,stageIndex:i,activeStudyUID:o}=s,{viewportGridState:c,setViewportGridState:l}=ha.getState(),{displaySetSelectorMap:u,setDisplaySetSelector:d}=Da.getState(),{hangingProtocolStageIndexMap:m,setHangingProtocolStageIndex:p}=ba.getState(),g=n.stages[i],S=`${o}:${r}:${i}`,f=`${o}:${r}`,{rows:y,columns:I}=g.viewportStructure.properties,h=g.viewports.length!==e.viewports.size||e.layout.numRows!==y||e.layout.numCols!==I;return m[f]=s,S&&h&&l(S,{...e}),e.viewports.forEach((e,t)=>{const{displaySetOptions:n,displaySetInstanceUIDs:s}=e;if(!n)return;const r=[];for(let e=0;e<n.length;e++){const i=s[e];i&&(t===a&&r.push(i),n[e]?.id&&"activeDisplaySet"!==n[e].id&&d(`${o}:${n[e].id}:${n[e].matchedDisplaySetsIndex||0}`,[i]))}t===a&&d(`${o}:activeDisplaySet:0`,r)}),p(f,s),{hangingProtocolStageIndexMap:m,viewportGridStore:c,displaySetSelectorMap:u}},xa=["SEG","RTSTRUCT"];const Ma=e=>({type:"viewportsByPositionId",viewportsByPosition:{},initialInDisplay:[],setViewportsByPosition:(t,a)=>e(e=>({viewportsByPosition:{...e.viewportsByPosition,[t]:a}}),!1,"setViewportsByPosition"),clearViewportsByPosition:()=>e({viewportsByPosition:{}},!1,"clearViewportsByPosition"),addInitialInDisplay:t=>e(e=>({initialInDisplay:[...e.initialInDisplay,t]}),!1,"addInitialInDisplay")}),Ca=(0,ya.vt)()(Ma),Pa=(e,t,a,n,s,r)=>{const i=a?.[s];if(i)return{...i};const{protocolId:o,stageIndex:c}=e.getState();r.inDisplay||(r.inDisplay=[...a.initialInDisplay]);const l=e.getMissingViewport(t?o:"default",c,r);if(l){const e=l.displaySetsInfo.map(e=>e.displaySetInstanceUID);return r.inDisplay.push(...e),{displaySetInstanceUIDs:e,displaySetOptions:l.displaySetsInfo.map(e=>e.displaySetOptions),viewportOptions:{...l.viewportOptions}}}return{}},Ua=(e,{numRows:t,numCols:a})=>{const{viewports:n}=e,{setViewportsByPosition:s,addInitialInDisplay:r}=Ca.getState(),i=[],o={};n.forEach(e=>{if(e.positionId){const t={...e,viewportOptions:{...e.viewportOptions}};o[e.positionId]=t,s(e.positionId,t)}});for(let e=0;e<t;e++)for(let t=0;t<a;t++){const a=o[`${t}-${e}`];a?.displaySetInstanceUIDs&&i.push(...a.displaySetInstanceUIDs)}i.forEach(e=>r(e))},Oa=e=>({toggleHangingProtocol:{},type:"toggleHangingProtocolId",setToggleHangingProtocol:(t,a)=>e(e=>({toggleHangingProtocol:{...e.toggleHangingProtocol,[t]:a}}),!1,"setToggleHangingProtocol"),clearToggleHangingProtocol:()=>e({toggleHangingProtocol:{}},!1,"clearToggleHangingProtocol")}),Na=(0,ya.vt)()(Oa),Ra=(0,ya.vt)(e=>({toggleOneUpViewportGridStore:null,type:"toggleOneUpViewportGridId",setToggleOneUpViewportGridStore:t=>e({toggleOneUpViewportGridStore:t}),clearToggleOneUpViewportGridStore:()=>e({toggleOneUpViewportGridStore:null})}));const Ta=async function({servicesManager:e,getReport:t,reportType:a="measurement"}){const{displaySetService:n,uiNotificationService:s,uiDialogService:r}=e.services;try{const e=await t();if(!e)return;o.H8.addInstances([e],!0);const r=n.getMostRecentDisplaySet().displaySetInstanceUID;return s.show({title:"Create Report",message:`${a} saved successfully`,type:"success"}),[r]}catch(e){throw s.show({title:"Create Report",message:e.message||`Failed to store ${a}`,type:"error"}),new Error(`Failed to store ${a}. Error: ${e.message||"Unknown error"}`)}finally{r.hide("loading-dialog")}};function Aa({displaySetService:e,modality:t,minSeriesNumber:a}){const n=e.getActiveDisplaySets(),s=n.filter(e=>e.Modality===t).map(e=>e.SeriesNumber),r=Math.max(...s,a),i=n.map(e=>e.SeriesNumber);let o=r+1;for(;i.includes(o);)o++;return{SeriesNumber:o,InstanceNumber:1}}const ka=(e=new Date)=>{const t=String(e.getUTCMonth()+1).padStart(2,"0"),a=String(e.getUTCDate()).padStart(2,"0");return{date:`${String(e.getUTCFullYear()).padStart(4,"0")}${t}${a}`,time:`${String(e.getUTCHours()).padStart(2,"0")}${String(e.getUTCMinutes()).padStart(2,"0")}${String(e.getUTCSeconds()).padStart(2,"0")}`}},{filterAnd:Va,filterMeasurementsByStudyUID:La,filterMeasurementsBySeriesUID:Fa}=o.Wp.MeasurementFilters;const Ba=async function({servicesManager:e,commandsManager:t,extensionManager:a},n,s){const{measurementService:r,displaySetService:i}=e.services,o=void 0===s.viewportId?s.data.viewportId:s.viewportId,c=void 0===s.isBackupSave?s.data.isBackupSave:s.isBackupSave,l=s?.data?.StudyInstanceUID||n.trackedStudy,u=s?.data?.SeriesInstanceUID,{displaySetInstanceUID:d}=s.data??s,{trackedSeries:m,measurementFilter:p=Va(La(l),Fa(m)),defaultSaveTitle:g="Create Report"}=n;let S;try{const n=await Ye({title:g,extensionManager:a,servicesManager:e});if(n.action===Ge.A.CREATE_REPORT){const s=a.getDataSources(n.dataSourceName)[0],o=r.getMeasurements(p),c=n.value||g,{SeriesNumber:l,InstanceNumber:u,referenceDisplaySet:d}=function({displaySetService:e,SeriesInstanceUid:t}){if(!t)return Aa({displaySetService:e,modality:"SR",minSeriesNumber:4700});const a=e.getDisplaySetCache(),n=Array.from(a.values()).find(e=>"SR"===e.Modality&&e.SeriesInstanceUID===t),s=n.instances?.length+1;return n?.SeriesNumber&&s?{SeriesNumber:n.SeriesNumber,InstanceNumber:s,referenceDisplaySet:n}:Aa({displaySetService:e,modality:"SR",minSeriesNumber:4700})}({displaySetService:i,SeriesInstanceUid:n.series}),{SeriesDate:m,SeriesTime:f}=d??((e=new Date)=>{const t=ka(e);return{SeriesDate:t.date,SeriesTime:t.time}})(),y=async()=>t.runCommand("storeMeasurements",{measurementData:o,dataSource:s,additionalFindingTypes:["ArrowAnnotate"],options:{SeriesDescription:c,SeriesNumber:l,InstanceNumber:u,SeriesInstanceUID:n.series,SeriesDate:m,SeriesTime:f}},"CORNERSTONE_STRUCTURED_REPORT");S=await Ta({servicesManager:e,getReport:y})}else n.action,RESPONSE.CANCEL;return{userResponse:n.action,createdDisplaySetInstanceUIDs:S,StudyInstanceUID:l,SeriesInstanceUID:u,viewportId:o,isBackupSave:c,displaySetInstanceUID:d}}catch(e){return console.warn("Unable to save report",e),null}},$a=({servicesManager:e,commandsManager:t,extensionManager:a})=>{const{customizationService:n,measurementService:s,hangingProtocolService:r,uiNotificationService:i,viewportGridService:c,displaySetService:l,multiMonitorService:u}=e.services,d=new Xt(e,t),m={addDisplaySetAsLayer:({viewportId:a,displaySetInstanceUID:n,removeFirst:s=!1})=>{if(!a){const{activeViewportId:t}=e.services.viewportGridService.getState();a=t}if(!a||!n)return void console.warn("Missing required parameters for addDisplaySetAsLayer command");const{displaySetService:r,viewportGridService:i,hangingProtocolService:o}=e.services;if(!r.getDisplaySetByUID(n))return;const c=i.getDisplaySetsUIDsForViewport(a),l=function(e){const{viewportId:t,displaySetInstanceUID:a,servicesManager:n}=e,{displaySetService:s,viewportGridService:r}=n.services;return!!s.getDisplaySetByUID(a)&&!r.getDisplaySetsUIDsForViewport(t).includes(a)}({viewportId:a,displaySetInstanceUID:n,servicesManager:e});if(!l)return;const u=o.getViewportsRequireUpdate(a,n);u.forEach(t=>{!function(e){const{viewport:t,displaySetInstanceUID:a,currentDisplaySetUIDs:n,servicesManager:s}=e,{cornerstoneViewportService:r,displaySetService:i,customizationService:o}=s.services,{viewportId:c}=t,l=[...n,a];t.displaySetInstanceUIDs=l,t.viewportOptions||(t.viewportOptions={});const u=i.getDisplaySetByUID(a);if(t.viewportOptions.orientation||(t.viewportOptions.orientation=r.getOrientation(c)),!t.viewportOptions.viewportType)if(u.isOverlayDisplaySet){const e=n.every(e=>{const t=i.getDisplaySetByUID(e);return t.isOverlayDisplaySet?t.referencedDisplaySetInstanceUID===u.referencedDisplaySetInstanceUID:e===u.referencedDisplaySetInstanceUID});t.viewportOptions.viewportType=e?"stack":"volume"}else t.viewportOptions.viewportType="volume";const d=l.map((e,a)=>t.displaySetOptions?.[a]?t.displaySetOptions[a]:0===a?{}:function(e,t,a){if("SEG"===e.Modality)return{};const n=function(e,t){return(e?.getCustomization("cornerstone.modalityOverlayDefaultColorMaps")||{defaultSettings:{}}).defaultSettings[t]||{colormap:"hsv",opacity:.9}}(a,e.Modality);return{colormap:{name:n.colormap||"hsv",opacity:t/100}}}(i.getDisplaySetByUID(e),90,o));t.displaySetOptions=d}({viewport:t,displaySetInstanceUID:n,currentDisplaySetUIDs:c,servicesManager:e})}),t.runCommand("updateStoredPositionPresentation",{viewportId:a,displaySetInstanceUIDs:u[0].displaySetInstanceUIDs}),t.run("setDisplaySetsForViewports",{viewportsToUpdate:u})},removeDisplaySetLayer:({viewportId:a,displaySetInstanceUID:n})=>{if(!a||!n)return void console.warn("Missing required parameters for removeDisplaySetLayer command");const{displaySetService:s,viewportGridService:r,hangingProtocolService:i,segmentationService:o}=e.services,c=s.getDisplaySetByUID(n);if(!c)return;const l=r.getDisplaySetsUIDsForViewport(a);if(!l.includes(n))return;xa.includes(c.Modality)&&o.removeSegmentationRepresentations(a,{segmentationId:n});const u=i.getViewportsRequireUpdate(a,n);u.forEach(t=>{!function(e){const{viewport:t,displaySetInstanceUID:a,currentDisplaySetUIDs:n,servicesManager:s}=e,{cornerstoneViewportService:r,displaySetService:i}=s.services,{viewportId:o}=t;t.displaySetInstanceUIDs=n.filter(e=>e!==a),t.viewportOptions||(t.viewportOptions={}),t.viewportOptions.viewportType="volume",t.viewportOptions.orientation||(t.viewportOptions.orientation=r.getOrientation(o)),t.displaySetOptions=t.displaySetInstanceUIDs.map(()=>({}))}({viewport:t,displaySetInstanceUID:n,currentDisplaySetUIDs:l,servicesManager:e})}),t.runCommand("updateStoredPositionPresentation",{viewportId:a,displaySetInstanceUIDs:u[0].displaySetInstanceUIDs}),t.run("setDisplaySetsForViewports",{viewportsToUpdate:u})},multimonitor:async e=>{const{screenDelta:t,StudyInstanceUID:a,commands:n,hashParams:s}=e;if(u.numberOfScreens<2)return e.fallback?.(e);await u.launchWindow(a,t,s)&&n&&setTimeout(()=>{u.run(t,n,e)},1e3)},promptSaveReport:n=>{const{StudyInstanceUID:s}=n;Ba({servicesManager:e,commandsManager:t,extensionManager:a},n,{data:{StudyInstanceUID:s}})},loadStudy:async e=>{const{StudyInstanceUID:t}=e;if(l.getActiveDisplaySets().find(e=>e.StudyInstanceUID===t))return;const[n]=a.getActiveDataSource();await qe(n,l,t);const s=o.H8.getStudy(t);r.addStudy(s)},showContextMenu:e=>{const{menuCustomizationId:t,element:a,event:s,selectorProps:i,defaultPointsPosition:o=[]}=e,c={...e};t&&Object.assign(c,n.getCustomization(t));const{protocol:l,stage:u}=r.getActiveProtocol();c.selectorProps={event:s,protocol:l,stage:u,...i},d.showContextMenu(c,a,o)},closeContextMenu:()=>{d.closeContextMenu()},displayNotification:({text:e,title:t,type:a})=>{i.show({title:t,message:e,type:a})},clearMeasurements:e=>{s.clearMeasurements(e.measurementFilter)},setHangingProtocol:({activeStudyUID:e="",StudyInstanceUID:t="",protocolId:a,stageId:n,stageIndex:s,reset:o=!1})=>{const u=e||t;try{const e=c.getState(),t=r.getState();Ea(e,r);const{hangingProtocolStageIndexMap:i}=ba.getState(),{displaySetSelectorMap:d}=Da.getState();if(a){if(void 0===s&&void 0===n){const e=`${u||t.activeStudyUID}:${a}`;s=i[e]?.stageIndex}}else a=t.protocolId,void 0===n&&void 0===s&&(s=t.stageIndex);const m=s??r.getStageIndex(a,{stageId:n,stageIndex:s}),p=r.setActiveStudyUID(u),g=`${u||r.getState().activeStudyUID}:${a}:${m||0}`,{viewportGridState:S}=ha.getState(),f=!o&&S[g];if(o||p&&!S[g]&&void 0===s&&void 0===n){const e={StudyInstanceUID:u,displaySets:l.getActiveDisplaySets()};r.run(e,a)}else a!==t.protocolId||m!==t.stageIndex||u?(r.setProtocol(a,{displaySetSelectorMap:d,stageId:n,stageIndex:m,restoreProtocol:f}),f&&c.set(S[g])):r.setProtocol(a,{stageId:n,stageIndex:m,displaySetSelectorMap:d});const{setDisplaySetSelector:y}=Da.getState();return y(`${u||t.activeStudyUID}:activeDisplaySet:0`,null),!0}catch(e){return console.error(e),i.show({title:"Apply Hanging Protocol",message:"The hanging protocol could not be applied.",type:"error",duration:3e3}),!1}},toggleHangingProtocol:({protocolId:e,stageIndex:t})=>{const{protocol:a,stageIndex:n,activeStudy:s}=r.getActiveProtocol(),{toggleHangingProtocol:i,setToggleHangingProtocol:o}=Na.getState(),c=`${s.StudyInstanceUID}:${e}:${0|t}`;if(a.id!==e||void 0!==t&&t!==n)return o(c,{protocolId:a.id,stageIndex:n}),m.setHangingProtocol({protocolId:e,stageIndex:t,reset:!0});{const e=i[c]||{protocolId:"default"};return m.setHangingProtocol(e)}},deltaStage:({direction:e})=>{const{protocolId:t,stageIndex:a}=r.getState(),{protocol:n}=r.getActiveProtocol();for(let s=a+e;s>=0&&s<n.stages.length;s+=e)if("disabled"!==n.stages[s].status)return m.setHangingProtocol({protocolId:t,stageIndex:s});i.show({title:"Change Stage",message:"The hanging protocol has no more applicable stages",type:"info",duration:3e3})},setViewportGridLayout:({numRows:e,numCols:a,isHangingProtocolLayout:n=!1})=>{const{protocol:s}=r.getActiveProtocol(),i=s.callbacks?.onLayoutChange;if(!1===t.run(i,{numRows:e,numCols:a}))return;window.setTimeout(()=>{const t=c.getState();Ua(t,{numRows:e,numCols:a});const{viewportsByPosition:s,initialInDisplay:i}=Ca.getState(),o=Pa.bind(null,r,n,{...s,initialInDisplay:i});c.setLayout({numRows:e,numCols:a,findOrCreateViewport:o,isHangingProtocolLayout:n})},0)},toggleOneUp(){const e=c.getState(),{activeViewportId:a,viewports:n,layout:s,isHangingProtocolLayout:i}=e,{displaySetInstanceUIDs:o,displaySetOptions:l,viewportOptions:u}=n.get(a);if(1===s.numCols&&1===s.numRows){const{toggleOneUpViewportGridStore:e}=Ra.getState();if(!e)return;const a=e.activeViewportId,n=o.length>1?[]:o.map(e=>r.getViewportsRequireUpdate(a,e,i)).flat(),s=(t,a)=>{const s=Array.from(e.viewports.values()).find(e=>e.positionId===a),r=n.find(e=>e.viewportId===s.viewportId);return r?{viewportOptions:u,displaySetOptions:l,...r}:s},d=c.getLayoutOptionsFromState(e);c.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportId:a,layoutOptions:d,findOrCreateViewport:s,isHangingProtocolLayout:!0}),setTimeout(()=>{t.runCommand("resetCrosshairs")},0)}else{const{setToggleOneUpViewportGridStore:t}=Ra.getState();t(e);const a=()=>({displaySetInstanceUIDs:o,displaySetOptions:l,viewportOptions:u});c.setLayout({numRows:1,numCols:1,findOrCreateViewport:a,isHangingProtocolLayout:!0})}},navigateHistory(e){Ne.b6.navigate(e.to,e.options)},openDICOMTagViewer({displaySetInstanceUID:t}){const{activeViewportId:a,viewports:n}=c.getState(),s=n.get(a),{displaySetInstanceUIDs:r}=s,i=l.activeDisplaySets,{UIModalService:o}=e.services,u=t||r[0];o.show({content:fa,contentProps:{displaySets:i,displaySetInstanceUID:u},title:"DICOM Tag Browser",containerClassName:"max-w-3xl"})},toggleOverlays:()=>{const e=document.getElementsByClassName("viewport-overlay");for(let t=0;t<e.length;t++)e.item(t).classList.toggle("hidden")},scrollActiveThumbnailIntoView:()=>{const{activeViewportId:e,viewports:t}=c.getState(),a=t.get(e),n=a?.displaySetInstanceUIDs?.[0];if(!n)return;if(!document.querySelector("#ohif-thumbnail-list"))return;const s=document.querySelector(`#thumbnail-${n}`);s&&s.scrollIntoView({behavior:"smooth"})},updateViewportDisplaySet:({direction:e,excludeNonImageModalities:a})=>{const n=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"],s=[...l.activeDisplaySets],{activeViewportId:o,viewports:u,isHangingProtocolLayout:d}=c.getState(),{displaySetInstanceUIDs:p}=u.get(o);let g;for(g=s.findIndex(e=>p.includes(e.displaySetInstanceUID))+e;g>-1&&g<s.length&&(a&&n.includes(s[g].Modality));g+=e);if(g<0||g>=s.length)return;const{displaySetInstanceUID:S}=s[g];let f=[];try{f=r.getViewportsRequireUpdate(o,S,d)}catch(e){console.warn(e),i.show({title:"Navigate Viewport Display Set",message:"The requested display sets could not be added to the viewport due to a mismatch in the Hanging Protocol rules.",type:"info",duration:3e3})}t.run("setDisplaySetsForViewports",{viewportsToUpdate:f}),setTimeout(()=>m.scrollActiveThumbnailIntoView(),0)}},p={multimonitor:m.multimonitor,promptSaveReport:m.promptSaveReport,loadStudy:m.loadStudy,showContextMenu:m.showContextMenu,closeContextMenu:m.closeContextMenu,clearMeasurements:m.clearMeasurements,displayNotification:m.displayNotification,setHangingProtocol:m.setHangingProtocol,toggleHangingProtocol:m.toggleHangingProtocol,navigateHistory:m.navigateHistory,nextStage:{commandFn:m.deltaStage,options:{direction:1}},previousStage:{commandFn:m.deltaStage,options:{direction:-1}},setViewportGridLayout:m.setViewportGridLayout,toggleOneUp:m.toggleOneUp,openDICOMTagViewer:m.openDICOMTagViewer,updateViewportDisplaySet:m.updateViewportDisplaySet,scrollActiveThumbnailIntoView:m.scrollActiveThumbnailIntoView,addDisplaySetAsLayer:m.addDisplaySetAsLayer,removeDisplaySetLayer:m.removeDisplaySetLayer};return{actions:m,definitions:p,defaultContext:"DEFAULT"}},Ha={toolGroupId:"default",allowUnmatchedView:!0,syncGroups:[{type:"hydrateseg",id:"sameFORId",source:!0,target:!0,options:{matchingRules:["sameFOR"]}}]},_a={id:"@ohif/mnGrid",description:"Has various hanging protocol grid layouts",name:"2x2",protocolMatchingRules:[{id:"OneOrMoreSeries",weight:25,attribute:"numberOfDisplaySetsWithImages",constraint:{greaterThan:0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{allowUnmatchedView:!0,seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}},weight:1,required:!0},{attribute:"isDisplaySetFromUrl",weight:20,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",syncGroups:[{type:"hydrateseg",id:"sameFORId",source:!0,target:!0,options:{matchingRules:["sameFOR"]}}]},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{id:"2x2",name:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:Ha,displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:2,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:3,id:"defaultDisplaySetId"}]}]},{name:"3x1",stageActivation:{enabled:{minViewportsMatched:3}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3}},viewports:[{viewportOptions:Ha,displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:1}]},{viewportOptions:Ha,displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:2}]}]},{name:"2x1",stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[{viewportOptions:Ha,displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]}]},{name:"1x1",stageActivation:{enabled:{minViewportsMatched:1}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:Ha,displaySets:[{id:"defaultDisplaySetId"}]}]}],numberOfPriorsReferenced:-1},za={..._a,id:"@ohif/mnGrid8",description:"Has various hanging protocol grid layouts up to 4x2",name:"4x2",stages:[{id:"4x2",name:"4x2",stageActivation:{enabled:{minViewportsMatched:7}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:4}},viewports:[{viewportOptions:Ha,displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:2,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:3,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:4,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:5,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:6,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:7,id:"defaultDisplaySetId"}]}]},{id:"3x2",name:"3x2",stageActivation:{enabled:{minViewportsMatched:5}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:3}},viewports:[{viewportOptions:Ha,displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:2,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:3,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:4,id:"defaultDisplaySetId"}]},{viewportOptions:Ha,displaySets:[{matchedDisplaySetsIndex:5,id:"defaultDisplaySetId"}]}]},..._a.stages]},Wa={id:"defaultDisplaySetId"},qa={id:"priorDisplaySetId"},ja={viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[Wa]},Ga={...ja,displaySets:[{...Wa,matchedDisplaySetsIndex:1}]},Ya={...ja,displaySets:[qa]},Ja={id:"@ohif/hpCompare",description:"Compare two studies in various layouts",name:"Compare Two Studies",numberOfPriorsReferenced:1,protocolMatchingRules:[{id:"Two Studies",weight:1e3,attribute:"StudyInstanceUID",from:"prior",required:!0,constraint:{notNull:!0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{studyMatchingRules:[{attribute:"studyInstanceUIDsIndex",from:"options",required:!0,constraint:{equals:{value:0}}}],seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:20,constraint:{equals:!0}}]},priorDisplaySetId:{studyMatchingRules:[{attribute:"studyInstanceUIDsIndex",from:"options",required:!0,constraint:{equals:{value:1}}}],seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:20,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{name:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[ja,Ya,Ga,{...Ya,displaySets:[{...qa,matchedDisplaySetsIndex:1}]}]},{name:"2x1",stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[ja,Ya]}]},Xa=[{attribute:"studyInstanceUIDsIndex",from:"options",required:!0,constraint:{equals:{value:1}}}],Ka=[{attribute:"studyInstanceUIDsIndex",from:"options",required:!0,constraint:{equals:{value:0}}}],Qa=[{weight:10,attribute:"ViewCode",constraint:{contains:"SCT:399162004"}},{weight:5,attribute:"PatientOrientation",constraint:{contains:"L"}},{weight:20,attribute:"SeriesDescription",constraint:{contains:"L CC"}}],Za=[{weight:10,attribute:"ViewCode",constraint:{contains:"SCT:399162004"}},{weight:5,attribute:"PatientOrientation",constraint:{equals:["P","L"]}},{attribute:"PatientOrientation",constraint:{doesNotEqual:["A","R"]},required:!0},{weight:20,attribute:"SeriesDescription",constraint:{contains:"CC"}}],en=[{weight:10,attribute:"ViewCode",constraint:{contains:"SCT:399368009"}},{weight:0,attribute:"ViewCode",constraint:{doesNotEqual:"SCT:399162004"},required:!0},{weight:5,attribute:"PatientOrientation",constraint:{equals:["A","R"]}},{weight:20,attribute:"SeriesDescription",constraint:{contains:"L MLO"}}],tn=[{weight:10,attribute:"ViewCode",constraint:{contains:"SCT:399368009"}},{attribute:"ViewCode",constraint:{doesNotEqual:"SCT:399162004"},required:!0},{attribute:"PatientOrientation",constraint:{doesNotContain:["P","FL"]},required:!0},{weight:5,attribute:"PatientOrientation",constraint:{equals:["P","L"]}},{weight:5,attribute:"PatientOrientation",constraint:{equals:["A","FR"]}},{weight:20,attribute:"SeriesDescription",constraint:{contains:"R MLO"}},{attribute:"SeriesDescription",required:!0,constraint:{doesNotContain:"CC"}},{attribute:"SeriesDescription",required:!0,constraint:{doesNotEqual:"L MLO"},required:!0}],an={storeAsInitialCamera:!0,imageArea:[.8,.8],imageCanvasPoint:{imagePoint:[0,.5],canvasPoint:[0,.5]}},nn={storeAsInitialCamera:!0,imageArea:[.8,.8],imageCanvasPoint:{imagePoint:[1,.5],canvasPoint:[1,.5]}},sn={id:"@ohif/hpMammo",hasUpdatedPriorsInformation:!1,name:"Mammography Breast Screening",protocolMatchingRules:[{id:"Mammography",weight:150,attribute:"ModalitiesInStudy",constraint:{contains:"MG"},required:!0},{id:"numberOfImages",attribute:"numberOfDisplaySetsWithImages",constraint:{greaterThan:2},required:!0}],toolGroupIds:["default"],displaySetSelectors:{RCC:{seriesMatchingRules:Za,studyMatchingRules:Ka},LCC:{seriesMatchingRules:Qa,studyMatchingRules:Ka},RMLO:{seriesMatchingRules:tn,studyMatchingRules:Ka},LMLO:{seriesMatchingRules:en,studyMatchingRules:Ka},RCCPrior:{seriesMatchingRules:Za,studyMatchingRules:Xa},LCCPrior:{seriesMatchingRules:Qa,studyMatchingRules:Xa},RMLOPrior:{seriesMatchingRules:tn,studyMatchingRules:Xa},LMLOPrior:{seriesMatchingRules:en,studyMatchingRules:Xa}},stages:[{name:"CC/MLO",viewportStructure:{type:"grid",layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",displayArea:nn,allowUnmatchedView:!0},displaySets:[{id:"RCC"}]},{viewportOptions:{toolGroupId:"default",displayArea:an,allowUnmatchedView:!0},displaySets:[{id:"LCC"}]},{viewportOptions:{toolGroupId:"default",displayArea:nn,allowUnmatchedView:!0},displaySets:[{id:"RMLO"}]},{viewportOptions:{toolGroupId:"default",displayArea:an,allowUnmatchedView:!0},displaySets:[{id:"LMLO"}]}]},{name:"CC compare",viewportStructure:{type:"grid",layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",displayArea:nn,flipHorizontal:!0,rotation:180},displaySets:[{id:"RCC"}]},{viewportOptions:{toolGroupId:"default",flipHorizontal:!0,displayArea:an},displaySets:[{id:"LCC"}]},{viewportOptions:{toolGroupId:"default",displayArea:nn,flipHorizontal:!0},displaySets:[{id:"RCCPrior"}]},{viewportOptions:{toolGroupId:"default",displayArea:an},displaySets:[{id:"LCCPrior"}]}]}],numberOfPriorsReferenced:0},rn={type:"SCALE",scale:1,storeAsInitialCamera:!0},on={id:"@ohif/hpScale",description:"Has various hanging protocol grid layouts",name:"Scale Images",protocolMatchingRules:[{id:"OneOrMoreSeries",weight:25,attribute:"numberOfDisplaySetsWithImages",constraint:{greaterThan:0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{weight:1,attribute:"numImageFrames",constraint:{greaterThan:{value:0}},required:!0},{attribute:"isDisplaySetFromUrl",weight:20,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",displayArea:rn,allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{name:"Scale 1:1",stageActivation:{enabled:{minViewportsMatched:1}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0,displayArea:rn},displaySets:[{id:"defaultDisplaySetId"}]}]},{name:"Scale 1:15",stageActivation:{enabled:{minViewportsMatched:1}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0,displayArea:{...rn,scale:15}},displaySets:[{id:"defaultDisplaySetId"}]}]}],numberOfPriorsReferenced:-1},cn={id:"default",locked:!0,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2023-04-01",availableTo:{},editableBy:{},protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0,syncGroups:[{type:"hydrateseg",id:"sameFORId",source:!0,target:!0,options:{matchingRules:["sameFOR"]}}]},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{weight:10,attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:20,constraint:{equals:!0}}]}},stages:[{name:"default",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{viewportType:"stack",viewportId:"default",toolGroupId:"default",initialImageOptions:{custom:"sopInstanceLocation"},syncGroups:[{type:"hydrateseg",id:"sameFORId",source:!0,target:!0}]},displaySets:[{id:"defaultDisplaySetId"}]}],createdDate:"2021-02-23T18:32:42.850Z"}]};const ln=function(){return[{name:cn.id,protocol:cn},{name:Ja.id,protocol:Ja},{name:sn.id,protocol:sn},{name:on.id,protocol:on},{name:_a.id,protocol:_a},{name:za.id,protocol:za}]},un={measurementsContextMenu:{inheritsFrom:"ohif.contextMenu",menus:[{id:"forExistingMeasurement",selector:({nearbyToolData:e})=>!!e,items:[{label:"Delete measurement",commands:"removeMeasurement"},{label:"Add Label",commands:"setMeasurementLabel"}]}]}},dn={"routes.customRoutes":{routes:{$push:[{path:"/custom",children:()=>ye.createElement("h1",{style:{color:"white"}},"Hello Custom Route")}]}}};var mn=a(39078);const pn={"routes.customRoutes":{routes:{$push:[{path:"/datasources",children:function(){const[e]=(0,De.r)(),t=(0,we.Zp)(),a=e.dataSources;return ye.createElement("div",{style:{width:"100%",height:"100%"}},ye.createElement("div",{className:"flex h-screen w-screen items-center justify-center"},ye.createElement("div",{className:"mx-auto space-y-2 rounded-lg bg-[rgb(var(--secondary-dark))] py-8 px-8 drop-shadow-md"},ye.createElement("img",{className:"mx-auto block h-14",src:"./ohif-logo.svg",alt:"OHIF"}),ye.createElement("div",{className:"space-y-2 pt-4 text-center"},a.filter(e=>"dicomjson"!==e.sourceName&&"dicomlocal"!==e.sourceName).map(e=>ye.createElement("div",{key:e.sourceName},ye.createElement("h1",{className:"text-[rgb(var(--text))]"},e.configuration?.friendlyName||e.friendlyName),ye.createElement(mn.$n,{type:mn.Ny.NW.primary,className:$t()("ml-2"),onClick:()=>{t({pathname:"/",search:`datasources=${e.sourceName}`})}},e.sourceName),ye.createElement("br",null)))))))}}]}}},gn={"studyBrowser.studyMenuItems":{$push:[{id:"applyHangingProtocol",label:"Apply Hanging Protocol",iconName:"ViewportViews",items:[{id:"applyDefaultProtocol",label:"Default",commands:["loadStudy",{commandName:"setHangingProtocol",commandOptions:{protocolId:"default"}}]},{id:"applyMPRProtocol",label:"2x2 Grid",commands:["loadStudy",{commandName:"setHangingProtocol",commandOptions:{protocolId:"@ohif/mnGrid"}}]}]},{id:"showInOtherMonitor",label:"Launch On Second Monitor",iconName:"DicomTagBrowser",selector:({servicesManager:e})=>{const{multiMonitorService:t}=e.services;return t.isMultimonitor},commands:{commandName:"multimonitor",commandOptions:{hashParams:"&hangingProtocolId=@ohif/mnGrid8",commands:["loadStudy",{commandName:"setHangingProtocol",commandOptions:{protocolId:"@ohif/mnGrid8"}}]}}}]}},Sn={"routes.customRoutes":{routes:[],notFoundRoute:null}},{formatDate:fn}=o.Wp,yn={"studyBrowser.studyMenuItems":[],"studyBrowser.thumbnailMenuItems":[{id:"tagBrowser",label:Qe.A.t("StudyBrowser:Tag Browser"),iconName:"DicomTagBrowser",commands:"openDICOMTagViewer"},{id:"addAsLayer",label:Qe.A.t("StudyBrowser:Add as Layer"),iconName:"ViewportViews",commands:"addDisplaySetAsLayer"}],"studyBrowser.sortFunctions":[{label:Qe.A.t("StudyBrowser:Series Number"),sortFunction:(e,t)=>e?.SeriesNumber-t?.SeriesNumber},{label:Qe.A.t("StudyBrowser:Series Date"),sortFunction:(e,t)=>{const a=new Date(fn(e?.SeriesDate));return new Date(fn(t?.SeriesDate)).getTime()-a.getTime()}}],"studyBrowser.viewPresets":[{id:"list",iconName:"ListView",selected:!1},{id:"thumbnails",iconName:"ThumbnailView",selected:!0}],"studyBrowser.studyMode":"all","studyBrowser.thumbnailDoubleClickCallback":{callbacks:[({activeViewportId:e,servicesManager:t,commandsManager:a,isHangingProtocolLayout:n})=>async s=>{const{hangingProtocolService:r,uiNotificationService:i}=t.services;let o=[];const c=e;try{o=r.getViewportsRequireUpdate(c,s,n)}catch(e){console.warn(e),i.show({title:Qe.A.t("StudyBrowser:Thumbnail Double Click"),message:Qe.A.t("StudyBrowser:The selected display sets could not be added to the viewport."),type:"error",duration:3e3})}a.run("setDisplaySetsForViewports",{viewportsToUpdate:o})}]}},In={"ohif.overlayItem":function(e){if(this.condition&&!this.condition(e))return null;const{instance:t}=e,a=t&&this.attribute?t[this.attribute]:this.contentF&&"function"==typeof this.contentF?this.contentF(e):null;return a?ye.createElement("span",{className:"overlay-item flex flex-row",style:{color:this.color||void 0},title:this.title||""},this.label&&ye.createElement("span",{className:"mr-1 shrink-0"},this.label),ye.createElement("span",{className:"font-light"},a)):null}},hn={"ohif.contextMenu":{$transform:function(e){const t={...this};t.menus=this.menus.map(e=>({...e}));for(const a of t.menus){const{items:t}=a;a.items=[];for(const n of t)a.items.push(e.transform(n))}return t}}},vn={"ui.contextMenu":mn.tz},Dn={"ohif.menuContent":function(e){const{item:t,commandsManager:a,servicesManager:n,...s}=e,r=function(e){const{item:t}=e,r=t.selector&&!t.selector({servicesManager:n});return ye.createElement(ve._26,{disabled:r,onSelect:()=>{a.runAsync(t.commands,{...t.commandOptions,...s})},className:"gap-[6px]"},t.iconName&&ye.createElement(ve.FI1.ByName,{name:t.iconName,className:"-ml-1"}),t.label)};return t.items?ye.createElement(ve.lvB,null,ye.createElement(ve.nVd,{className:"gap-[6px]"},t.iconName&&ye.createElement(ve.FI1.ByName,{name:t.iconName,className:"-ml-1"}),t.label),ye.createElement(ve.dce,null,ye.createElement(ve.M56,null,t.items.map(t=>r({...e,item:t}))))):r({...e,item:t})}};const wn=function({itemLabel:e,itemList:t,onItemClicked:a}){const{servicesManager:n}=(0,o.Jg)(),{t:s}=(0,be.Bd)("DataSourceConfiguration"),[r,i]=(0,ye.useState)("");(0,ye.useEffect)(()=>{i("")},[t]);const c=n.services.customizationService.getCustomization("ui.loadingIndicatorProgress");return ye.createElement("div",{className:"flex min-h-[1px] grow flex-col gap-4"},ye.createElement("div",{className:"flex items-center justify-between"},ye.createElement("div",{className:"text-primary-light text-[20px]"},s(`Select ${e}`)),ye.createElement(mn.Cv,{className:"max-w-[40%] grow",value:r,onDebounceChange:i,placeholder:s(`Search ${e} list`)})),ye.createElement("div",{className:"relative flex min-h-[1px] grow flex-col bg-[rgb(var(--background))] text-[14px]"},null==t?ye.createElement(c,{className:"h-full w-full"}):0===t.length?ye.createElement("div",{className:"text-primary-light flex h-full flex-col items-center justify-center px-6 py-4"},ye.createElement(ve.FI1.ToolMagnify,{className:"mb-4"}),ye.createElement("span",null,s(`No ${e} available`))):ye.createElement(ye.Fragment,null,ye.createElement("div",{className:"bg-[rgb(var(--secondary-dark))] px-3 py-1.5 text-[rgb(var(--text))]"},s(e)),ye.createElement("div",{className:"ohif-scrollbar overflow-auto"},t.filter(e=>!r||e.name.toLowerCase().includes(r.toLowerCase())).map(e=>ye.createElement("div",{className:$t()("hover:text-primary-light group mx-2 flex items-center justify-between px-6 py-2 hover:bg-[rgb(var(--primary-dark))]","rounded border-transparent border-b-secondary-light border-[1px] hover:border-primary-light"),key:e.id},ye.createElement("div",null,e.name),ye.createElement(mn.$n,{onClick:()=>a(e),className:"invisible group-hover:visible",endIcon:ye.createElement(ve.FI1.ByName,{name:"arrow-left"})},s("Select"))))))))},bn="text-ellipsis whitespace-nowrap overflow-hidden";const En=function({configurationAPI:e,configuredItems:t,onHide:a}){const{t:n}=(0,be.Bd)("DataSourceConfiguration"),[s,r]=(0,ye.useState)(),[i,o]=(0,ye.useState)(t),[c,l]=(0,ye.useState)(),[u]=(0,ye.useState)(e.getItemLabels()),[d,m]=(0,ye.useState)(u.length===t.length),p=d?i.length-2:i.length-1;(0,ye.useEffect)(()=>{let t=!0;return l(null),r(null),0===i.length?e.initialize().then(e=>{t&&r(e)}).catch(e=>l(e.message)):d||i.length!==u.length?e.setCurrentItem(i[p]).then(e=>{t&&r(e)}).catch(e=>l(e.message)):(e.setCurrentItem(i[i.length-1]),a()),()=>{t=!1}},[i,e,a,u,d,p]);const g=e=>e<i.length?$t()("bg-[rgb(var(--background))]/[.4]",e!==u.length-1?"hover:bg-transparent active:bg-[rgb(var(--secondary-dark))]":""):"bg-transparent",S=e=>e===p+1?$t()("border-2","border-solid","border-primary-light"):e<i.length?"border border-solid border-primary-active hover:border-primary-light active:border-white":"border border-dashed border-secondary-light",f=e=>e<=i.length?"text-primary-light":"text-primary";return ye.createElement("div",{className:"flex h-[calc(100vh-300px)] select-none flex-col gap-4 pt-0.5"},ye.createElement("div",{className:"flex gap-4"},u.map((e,t)=>{return ye.createElement("div",{key:e,className:$t()("flex min-w-[1px] shrink basis-[200px] flex-col gap-1 rounded-md p-3.5",(a=t,a!==u.length-1&&a<i.length?"cursor-pointer":"cursor-auto"),g(t),S(t),f(t)),onClick:d&&t<p||t<=p?()=>{m(!1),o(e=>e.slice(0,t))}:void 0},ye.createElement("div",{className:"text- flex items-center gap-2"},t<i.length?ye.createElement(ve.FI1.ByName,{name:"status-tracked"}):ye.createElement(ve.FI1.ByName,{name:"status-untracked"}),ye.createElement("div",{className:$t()(bn)},n(e))),t<i.length?ye.createElement("div",{className:$t()("text-[14px] text-[rgb(var(--text))]",bn)},i[t].name):ye.createElement("br",null));var a})),ye.createElement("div",{className:"h-0.5 w-full shrink-0 bg-[rgb(var(--background))]"}),c?ye.createElement("div",{className:"flex min-h-[1px] grow flex-col gap-4"},ye.createElement("div",{className:"text-primary-light text-[20px]"},n(`Error fetching ${u[i.length]} list`)),ye.createElement("div",{className:"grow bg-[rgb(var(--background))] p-4 text-[14px]"},c)):ye.createElement(wn,{itemLabel:u[p+1],itemList:s,onItemClicked:e=>{m(!1),o(t=>[...t.slice(0,p+1),e])}}))};const xn=function({servicesManager:e,extensionManager:t}){const{t:a}=(0,be.Bd)("DataSourceConfiguration"),{show:n,hide:s}=(0,ve.hSE)(),{customizationService:r}=e.services,[i,o]=(0,ye.useState)(),[c,l]=(0,ye.useState)();(0,ye.useEffect)(()=>{let e=!0;const a=async()=>{const a=t.getActiveDataSourceDefinition();if(!a?.configuration?.configurationAPI)return;const{factory:n}=r.getCustomization(a.configuration.configurationAPI)??{factory:()=>null};if(!n)return;const s=n(a.sourceName);o(s),l(null),s.getConfiguredItems().then(t=>{e&&l(t)})},n=t.subscribe(t.EVENTS.ACTIVE_DATA_SOURCE_CHANGED,a);return a(),()=>{e=!1,n.unsubscribe()}},[]);const u=(0,ye.useCallback)(()=>{n({content:En,title:a("Configure Data Source"),contentProps:{configurationAPI:i,configuredItems:c,onHide:s}})},[i,c]);return(0,ye.useEffect)(()=>{i&&c&&c.length!==i.getItemLabels().length&&u()},[i,c,u]),c?ye.createElement("div",{className:"text-aqua-pale flex items-center overflow-hidden"},ye.createElement(ve.FI1.Settings,{className:"mr-2.5 h-3.5 w-3.5 shrink-0 cursor-pointer",onClick:u}),c.map((e,t)=>ye.createElement("div",{key:t,className:"flex overflow-hidden"},ye.createElement("div",{key:t,className:"overflow-hidden text-ellipsis whitespace-nowrap"},e.name),t!==c.length-1&&ye.createElement("div",{className:"px-2.5"},"|")))):ye.createElement(ye.Fragment,null)};var Mn=function(e){return e[e.projects=0]="projects",e[e.locations=1]="locations",e[e.datasets=2]="datasets",e[e.dicomStores=3]="dicomStores",e}(Mn||{});const Cn="https://cloudresourcemanager.googleapis.com/v1",Pn="https://healthcare.googleapis.com/v1";class Un{constructor(e,t,a){this._extensionManager=void 0,this._fetchOptions=void 0,this._dataSourceName=void 0,this.getItemLabels=()=>["Project","Location","Data set","DICOM store"],this._dataSourceName=e,this._extensionManager=a;const n=t.services.userAuthenticationService;this._fetchOptions={method:"GET",headers:n.getAuthorizationHeader()}}async initialize(){const e=`${Cn}/projects`,t=await Un._doFetch(e,Mn.projects,this._fetchOptions);if(!t?.length)return[];return t.map(e=>({id:e.projectId,name:e.name,itemType:Mn.projects,url:`${Pn}/projects/${e.projectId}`}))}async setCurrentItem(e){const t=e;if(t.itemType===Mn.dicomStores){const e=`${t.url}/dicomWeb`,a=JSON.parse(JSON.stringify(this._extensionManager.getDataSourceDefinition(this._dataSourceName)));return a.configuration={...a.configuration,wadoUriRoot:e,qidoRoot:e,wadoRoot:e},this._extensionManager.updateDataSourceConfiguration(a.sourceName,a.configuration),[]}const a=t.itemType+1,n=`${Mn[a]}`,s=`${t.url}/${n}`,r=await Un._doFetch(s,a,this._fetchOptions);if(!r?.length)return[];return r.map(e=>{const t=e.name.split("/");return{id:e.name,name:t[t.length-1],itemType:a,url:`${Pn}/${e.name}`}})}async getConfiguredItems(){const e=this._extensionManager.getDataSourceDefinition(this._dataSourceName).configuration.wadoUriRoot,t=e.indexOf("projects"),a=e.substring(t).split("/"),n=[];for(let e=0;e<4&&2*(e+1)<a.length;e+=1)if(e===Mn.projects){const t=a[1],s=`${Cn}/projects/${t}`,r=(await Un._doFetch(s,Mn.projects,this._fetchOptions))[0];n.push({id:r.projectId,name:r.name,itemType:e,url:`${Pn}/projects/${r.projectId}`})}else{const t=a.slice(0,2*e+2).join("/");n.push({id:t,name:a[2*e+1],itemType:e,url:`${Pn}/${t}`})}return n}static async _doFetch(e,t,a={},n={}){try{const s=new URL(e);s.search=new URLSearchParams(n).toString();const r=await fetch(s,a),i=await r.json();if(r.status>=200&&r.status<300&&null!=i){if(null!=i.nextPageToken){n.pageToken=i.nextPageToken;const s=await this._doFetch(e,t,a,n);i[Mn[t]]=i[Mn[t]].concat(s)}return i[Mn[t]]?i[Mn[t]]:i.name?[i]:[]}{const e=i?.error?.message||`Error returned from Google Cloud Healthcare: ${r.status} - ${r.statusText}`;throw new Error(e)}}catch(e){throw new Error(e?.message||"Error occurred during fetch request.")}}}function On({servicesManager:e,extensionManager:t}){return{"ohif.dataSourceConfigurationComponent":xn.bind(null,{servicesManager:e,extensionManager:t}),"ohif.dataSourceConfigurationAPI.google":a=>new Un(a,e,t)}}const Nn={progressDropdownWithServiceComponent:At},{sortingCriteria:Rn}=o.Wp,Tn={sortingCriteria:Rn.seriesSortCriteria.seriesInfoSortingCriteria},An={customOnDropHandler:()=>Promise.resolve({handled:!1})},kn={"ui.loadingIndicatorProgress":ve.JxG},Vn={"ui.loadingIndicatorTotalPercent":ve.pTz},Ln={"ui.progressLoadingBar":ve.dDv},Fn={"ui.labellingComponent":ve.ndl},Bn=Qe.A.t("MeasurementTable:Track measurements for this series?"),$n=Qe.A.t("Do you want to add this measurement to the existing report?"),Hn=Qe.A.t("You have existing tracked measurements. What would you like to do with your existing tracked measurements?"),_n=Qe.A.t("MeasurementTable:Track measurements for this series?"),zn=Qe.A.t("Measurements cannot span across multiple studies. Do you want to save your tracked measurements?"),Wn=Qe.A.t("Do you want to continue tracking measurements for this study?"),qn=Qe.A.t("Do you want to open this Segmentation?"),jn=Qe.A.t("Do you want to open this Segmentation?"),Gn=Qe.A.t("There are unsaved measurements. Do you want to save it?"),Yn={"ui.notificationComponent":ve.Tqg,"viewportNotification.beginTrackingMessage":Bn,"viewportNotification.trackNewSeriesMessage":$n,"viewportNotification.discardSeriesMessage":Hn,"viewportNotification.trackNewStudyMessage":_n,"viewportNotification.discardStudyMessage":zn,"viewportNotification.hydrateSRMessage":Wn,"viewportNotification.hydrateRTMessage":qn,"viewportNotification.hydrateSEGMessage":jn,"viewportNotification.discardDirtyMessage":Gn};var Jn=a(88123);const Xn={"ohif.aboutModal":function(){const{os:e,version:t,name:a}=(0,Jn.A)(),n=`${a[0].toUpperCase()}${a.substr(1)} ${t}`,[s,r]="3.12.0-beta.78".split("-");return ye.createElement(ve.VTU,{className:"w-[400px]"},ye.createElement(ve.VTU.ProductName,null,"OHIF Viewer"),ye.createElement(ve.VTU.ProductVersion,null,s),r&&ye.createElement(ve.VTU.ProductBeta,null,r),ye.createElement(ve.VTU.Body,null,ye.createElement(ve.VTU.DetailItem,{label:"Commit Hash",value:"35bfc9b0ccfea25a61bebf8e252284db7c40e602"}),ye.createElement(ve.VTU.DetailItem,{label:"Current Browser & OS",value:`${n}, ${e}`}),ye.createElement(ve.VTU.SocialItem,{icon:"SocialGithub",url:"OHIF/Viewers",text:"github.com/OHIF/Viewers"})))}},{availableLanguages:Kn,defaultLanguage:Qn,currentLanguage:Zn}=Qe.A;const es={"ohif.userPreferencesModal":function({hide:e}){const{hotkeysManager:t}=(0,o.Jg)(),{t:a}=(0,be.Bd)("UserPreferencesModal"),{hotkeyDefinitions:n={},hotkeyDefaults:s={}}=t,r=Zn(),[i,c]=(0,ye.useState)({hotkeyDefinitions:n,languageValue:r.value});return ye.createElement(ve.xMy,null,ye.createElement(ve.xMy.Body,null,ye.createElement("div",{className:"mb-3 flex items-center space-x-14"},ye.createElement(ve.xMy.SubHeading,null,a("Language")),ye.createElement(ve.l6P,{defaultValue:i.languageValue,onValueChange:e=>{c(t=>({...t,languageValue:e}))}},ye.createElement(ve.bqE,{className:"w-60","aria-label":"Language"},ye.createElement(ve.yvm,{placeholder:a("Select language")})),ye.createElement(ve.gCo,null,Kn.map(e=>ye.createElement(ve.ebT,{key:e.value,value:e.value},e.label))))),ye.createElement(ve.xMy.SubHeading,null,a("Hotkeys")),ye.createElement(ve.xMy.HotkeysGrid,null,Object.entries(i.hotkeyDefinitions).map(([e,t])=>ye.createElement(ve.xMy.Hotkey,{key:e,label:a(t.label),value:t.keys,onChange:t=>((e,t)=>{c(a=>({...a,hotkeyDefinitions:{...a.hotkeyDefinitions,[e]:{...a.hotkeyDefinitions[e],keys:t}}}))})(e,t),placeholder:t.keys,hotkeys:o.ot})))),ye.createElement(ve.esu,null,ye.createElement(ve.esu.Left,null,ye.createElement(ve.esu.Auxiliary,{onClick:()=>{c(e=>({...e,languageValue:Qn.value,hotkeyDefinitions:s})),t.restoreDefaultBindings()}},a("Reset to defaults"))),ye.createElement(ve.esu.Right,null,ye.createElement(ve.esu.Secondary,{onClick:()=>{o.ot.stopRecord(),o.ot.unpause(),e()}},a("Cancel")),ye.createElement(ve.esu.Primary,{onClick:()=>{i.languageValue!==r.value&&Qe.A.changeLanguage(i.languageValue),t.setHotkeys(i.hotkeyDefinitions),o.ot.stopRecord(),o.ot.unpause(),e()}},a("Save")))))}};const ts={"ohif.createReportDialog":function({dataSources:e,hide:t,onSave:a,onCancel:n}){const{servicesManager:s}=(0,o.Jg)(),[r,i]=(0,ye.useState)(e?.[0]?.value??null),[c,l]=(0,ye.useState)(null),[u,d]=(0,ye.useState)(""),{displaySetService:m}=s.services,p=(0,ye.useMemo)(()=>{const e=m.getDisplaySetCache();return[{value:null,description:null,label:"Create new series"},...Array.from(e.values()).filter(e=>"SR"===e.Modality).map(e=>({value:e.SeriesInstanceUID,description:e.SeriesDescription,label:`${e.SeriesDescription} ${e.SeriesDate}/${e.SeriesTime} ${e.SeriesNumber}`}))]},[m]);(0,ye.useEffect)(()=>{const e=p.find(e=>e.value===c),t=c&&e?.description?e.description:"";d(t)},[c,p]);const g=(0,ye.useCallback)(()=>{a({reportName:u,dataSource:r,series:c}),t()},[r,c,u,t,a]),S=(0,ye.useCallback)(()=>{n(),t()},[n,t]),f=e?.length>1;return ye.createElement("div",{className:"text-foreground flex min-w-[400px] max-w-md flex-col"},ye.createElement("div",{className:"flex flex-col gap-4"},ye.createElement("div",{className:"flex gap-4"},f&&ye.createElement(ye.Fragment,null,ye.createElement("div",{className:"mt-1 w-1/2"},ye.createElement("div",{className:"mb-1 pl-1 text-base"},"Data source"),ye.createElement(ve.l6P,{value:r,onValueChange:i},ye.createElement(ve.bqE,null,ye.createElement(ve.yvm,{placeholder:"Select a data source"})),ye.createElement(ve.gCo,null,e.map(e=>ye.createElement(ve.ebT,{key:e.value,value:e.value},e.label))))),ye.createElement("div",{className:f?"mt-1 w-1/2":"mt-1 w-full"},ye.createElement("div",{className:"mb-1 pl-1 text-base"},"Series"),ye.createElement(ve.l6P,{value:c,onValueChange:l},ye.createElement(ve.bqE,null,ye.createElement(ve.yvm,{placeholder:"Select a series"})),ye.createElement(ve.gCo,null,p.map(e=>ye.createElement(ve.ebT,{key:e.value,value:e.value},e.label))))))),ye.createElement("div",{className:"flex items-end gap-4"},!f&&ye.createElement("div",{className:"w-1/3"},ye.createElement("div",{className:"mb-1 pl-1 text-base"},"Series"),ye.createElement(ve.l6P,{value:c,onValueChange:l},ye.createElement(ve.bqE,null,ye.createElement(ve.yvm,{placeholder:"Select a series"})),ye.createElement(ve.gCo,null,p.map(e=>ye.createElement(ve.ebT,{key:e.value,value:e.value},e.label))))),ye.createElement(ve.fa0,{value:u,onChange:d,submitOnEnter:!0,className:"flex-1"},ye.createElement(ve.fa0.Field,{className:"mb-0"},ye.createElement(ve.fa0.Input,{placeholder:"Report name",disabled:!!c})))),ye.createElement("div",{className:"flex justify-end gap-2"},ye.createElement(ve.fa0,null,ye.createElement(ve.fa0.Actions,null,ye.createElement(ve.fa0.ActionsSecondary,{onClick:S},"Cancel"),ye.createElement(ve.fa0.ActionsPrimary,{onClick:g},"Save"))))))}},as={"ohif.hotkeyBindings":o.NT.hotkeyBindings};function ns(e,t=20,a=25){return new Promise(n=>{let s=0;const r=setInterval(()=>{(document.querySelector(e)||s>=t)&&(clearInterval(r),n()),s++},a)})}const ss={"ohif.tours":[{id:"basicViewerTour",route:"/viewer",steps:[{id:"scroll",title:"Scrolling Through Images",text:"You can scroll through the images using the mouse wheel or scrollbar.",attachTo:{element:".viewport-element",on:"top"},advanceOn:{selector:".cornerstone-viewport-element",event:"CORNERSTONE_TOOLS_MOUSE_WHEEL"},beforeShowPromise:()=>ns(".viewport-element")},{id:"zoom",title:"Zooming In and Out",text:"You can zoom the images using the right click.",attachTo:{element:".viewport-element",on:"left"},advanceOn:{selector:".cornerstone-viewport-element",event:"CORNERSTONE_TOOLS_MOUSE_UP"},beforeShowPromise:()=>ns(".viewport-element")},{id:"pan",title:"Panning the Image",text:"You can pan the images using the middle click.",attachTo:{element:".viewport-element",on:"top"},advanceOn:{selector:".cornerstone-viewport-element",event:"CORNERSTONE_TOOLS_MOUSE_UP"},beforeShowPromise:()=>ns(".viewport-element")},{id:"windowing",title:"Adjusting Window Level",text:"You can modify the window level using the left click.",attachTo:{element:".viewport-element",on:"left"},advanceOn:{selector:".cornerstone-viewport-element",event:"CORNERSTONE_TOOLS_MOUSE_UP"},beforeShowPromise:()=>ns(".viewport-element")},{id:"length",title:"Using the Measurement Tools",text:"You can measure the length of a region using the Length tool.",attachTo:{element:'[data-cy="MeasurementTools-split-button-primary"]',on:"bottom"},advanceOn:{selector:'[data-cy="MeasurementTools-split-button-primary"]',event:"click"},beforeShowPromise:()=>ns('[data-cy="MeasurementTools-split-button-primary]')},{id:"drawAnnotation",title:"Drawing Length Annotations",text:"Use the length tool on the viewport to measure the length of a region.",attachTo:{element:".viewport-element",on:"right"},advanceOn:{selector:"body",event:"event::measurement_added"},beforeShowPromise:()=>ns(".viewport-element")},{id:"trackMeasurement",title:"Tracking Measurements in the Panel",text:"Click yes to track the measurements in the measurement panel.",attachTo:{element:'[data-cy="prompt-begin-tracking-yes-btn"]',on:"bottom"},advanceOn:{selector:'[data-cy="prompt-begin-tracking-yes-btn"]',event:"click"},beforeShowPromise:()=>ns('[data-cy="prompt-begin-tracking-yes-btn"]')},{id:"openMeasurementPanel",title:"Opening the Measurements Panel",text:"Click the measurements button to open the measurements panel.",attachTo:{element:"#trackedMeasurements-btn",on:"left-start"},advanceOn:{selector:"#trackedMeasurements-btn",event:"click"},beforeShowPromise:()=>ns("#trackedMeasurements-btn")},{id:"scrollAwayFromMeasurement",title:"Scrolling Away from a Measurement",text:"Scroll the images using the mouse wheel away from the measurement.",attachTo:{element:".viewport-element",on:"left"},advanceOn:{selector:".cornerstone-viewport-element",event:"CORNERSTONE_TOOLS_MOUSE_WHEEL"},beforeShowPromise:()=>ns(".viewport-element")},{id:"jumpToMeasurement",title:"Jumping to Measurements in the Panel",text:"Click the measurement in the measurement panel to jump to it.",attachTo:{element:'[data-cy="data-row"]',on:"left-start"},advanceOn:{selector:'[data-cy="data-row"]',event:"click"},beforeShowPromise:()=>ns('[data-cy="data-row"]')},{id:"changeLayout",title:"Changing Layout",text:"You can change the layout of the viewer using the layout button.",attachTo:{element:'[data-cy="Layout"]',on:"bottom"},advanceOn:{selector:'[data-cy="Layout"]',event:"click"},beforeShowPromise:()=>ns('[data-cy="Layout"]')},{id:"selectLayout",title:"Selecting the MPR Layout",text:"Select the MPR layout to view the images in MPR mode.",attachTo:{element:'[data-cy="MPR"]',on:"left-start"},advanceOn:{selector:'[data-cy="MPR"]',event:"click"},beforeShowPromise:()=>ns('[data-cy="MPR"]')}],tourOptions:{useModalOverlay:!0,defaultStepOptions:{buttons:[{text:"Skip all",action(){this.complete()},secondary:!0}]}}}]},rs={instanceSortingCriteria:{sortFunctions:{},defaultSortFunctionName:""}};const is=({displaySets:e})=>{const t=e[0],{axis:a,series:n}=t.instance.chartData;return ye.createElement(ve.bl6,{showLegend:!0,legendWidth:150,axis:{x:{label:a.x.label,indexRef:0,type:"x",range:{min:0}},y:{label:a.y.label,indexRef:1,type:"y"}},series:n})};var os=a(48405);const cs=o.Ay.classes.MetadataProvider;const ls=e=>{const t=e?.images[0]?.ViewCodeSequence[0];if(!t)return;const{CodingSchemeDesignator:a,CodeValue:n}=t;return a&&n?`${a}:${n}`:void 0},us=e=>{const t=e?.images?.[0]?.SharedFunctionalGroupsSequence?.[0]?.FrameAnatomySequence?.[0];if(!t)return;const a=t?.FrameLaterality;return a};const ds=o.Ly.MetadataProvider;const ms=({SeriesInstanceUID:e,StudyInstanceUID:t})=>{const{instances:a}=o.H8.getSeries(t,e);if(!a?.length)return;const n=a[0].Modality;if(!["PT","RTDOSE"].includes(n))return;const s=a.map(e=>e.imageId),r=[];if("RTDOSE"===n){const e=a[0].DoseGridScaling,t=a[0].DoseSummation,n=a[0].DoseType,r=a[0].DoseUnit,i=a[0].NumberOfFrames,o=s[0];for(let a=0;a<i;a++){const s=a+1,i=`${o.replace(/\/frames\/\d+$/,"")}/frames/${s}`;ds.addCustomMetadata(i,"scalingModule",{DoseGridScaling:e,DoseSummation:t,DoseType:n,DoseUnit:r})}return}try{if(s.forEach(e=>{const t=function(e){const t=cs.get("instance",e);if(!t)throw new Error("dicom metadata are required");if(void 0===t.SeriesDate||void 0===t.SeriesTime||void 0===t.CorrectedImage||void 0===t.Units||!t.RadiopharmaceuticalInformationSequence||void 0===t.RadiopharmaceuticalInformationSequence.RadionuclideHalfLife||void 0===t.RadiopharmaceuticalInformationSequence.RadionuclideTotalDose||void 0===t.DecayCorrection||void 0===t.AcquisitionDate||void 0===t.AcquisitionTime||void 0===t.RadiopharmaceuticalInformationSequence.RadiopharmaceuticalStartDateTime&&void 0===t.RadiopharmaceuticalInformationSequence.RadiopharmaceuticalStartTime)throw new Error("required metadata are missing");void 0===t.PatientWeight&&console.warn("PatientWeight missing from PT instance metadata");const a={CorrectedImage:t.CorrectedImage,Units:t.Units,RadionuclideHalfLife:t.RadiopharmaceuticalInformationSequence.RadionuclideHalfLife,RadionuclideTotalDose:t.RadiopharmaceuticalInformationSequence.RadionuclideTotalDose,RadiopharmaceuticalStartDateTime:t.RadiopharmaceuticalInformationSequence.RadiopharmaceuticalStartDateTime,RadiopharmaceuticalStartTime:t.RadiopharmaceuticalInformationSequence.RadiopharmaceuticalStartTime,DecayCorrection:t.DecayCorrection,PatientWeight:t.PatientWeight,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,AcquisitionDate:t.AcquisitionDate,AcquisitionTime:t.AcquisitionTime};if(t[70531e3]||void 0!==t[70531e3]||t[70531009]||void 0!==t[70531009]){const e={SUVScaleFactor:t[70531e3],ActivityConcentrationScaleFactor:t[70531009]};a.PhilipsPETPrivateGroup=e}return t["0009100d"]&&void 0!==t["0009100d"]&&(a.GEPrivatePostInjectionDateTime=t["0009100d"]),t.FrameReferenceTime&&void 0!==t.FrameReferenceTime&&(a.FrameReferenceTime=t.FrameReferenceTime),t.ActualFrameDuration&&void 0!==t.ActualFrameDuration&&(a.ActualFrameDuration=t.ActualFrameDuration),t.PatientSex&&void 0!==t.PatientSex&&(a.PatientSex=t.PatientSex),t.PatientSize&&void 0!==t.PatientSize&&(a.PatientSize=t.PatientSize),a}(e);t&&r.push(t)}),!r.length)return;const e=(0,os.C)(r);r.forEach((t,a)=>{ds.addCustomMetadata(s[a],"scalingModule",e[a])})}catch(e){console.log(e)}};function ps(e){return!("object"==typeof e||Array.isArray(e))}const gs=new Set(["DS","FL","FD","IS","OD","OF","OL","OV","SL","SS","SV","UL","US","UV"]);function Ss(e,t){if(Array.isArray(e)){return e.map(e=>ps(e)?e:Ss(e,t))}return ps(e)||Object.keys(e).forEach(a=>{null===e[a].Value&&e[a].vr?delete e[a].Value:Array.isArray(e[a].Value)&&e[a].vr&&(1===e[a].Value.length&&e[a].Value[0].BulkDataURI?(t?.dataSourceConfig&&L(e[a].Value[0],t,t.dataSourceConfig),e[a].BulkDataURI=e[a].Value[0].BulkDataURI,"https:"===window.location.protocol&&e[a].BulkDataURI.startsWith("http:")&&(e[a].BulkDataURI=e[a].BulkDataURI.replace("http:","https:")),delete e[a].Value):gs.has(e[a].vr)?e[a].Value=e[a].Value.map(e=>+e):e[a].Value=e[a].Value.map(e=>Ss(e,t)))}),e}function fs(e){const t=Ss(e);return JSON.parse(JSON.stringify(t))}function ys(e,t=["ImageType"]){for(const a of t)"string"==typeof e[a]&&(e[a]=e[a].split("\\"));return e}const Is=e=>({type:"uiStateId",uiState:{},setUIState:(t,a)=>e(e=>({uiState:{...e.uiState,[t]:a}}),!1,"setUIState"),clearUIState:()=>e({uiState:{}},!1,"clearUIState")}),hs=(0,ya.vt)()(Is);var vs=a(53860);function Ds({hide:e,onSave:t,placeholder:a="Enter value",defaultValue:n="",submitOnEnter:s}){return ye.createElement(ve.fa0,{submitOnEnter:s,defaultValue:n},ye.createElement(ve.fa0.Field,null,ye.createElement(ve.fa0.Input,{placeholder:a})),ye.createElement(ve.fa0.Actions,null,ye.createElement(ve.fa0.ActionsSecondary,{onClick:e},"Cancel"),ye.createElement(ve.fa0.ActionsPrimary,{onClick:a=>{t(a),e()}},"Save")))}async function ws({uiDialogService:e,defaultValue:t="",title:a="Annotation",placeholder:n="",submitOnEnter:s=!0}){return await new Promise(r=>{e.show({id:"dialog-enter-annotation",content:Ds,title:a,shouldCloseOnEsc:!0,contentProps:{onSave:e=>{r(e)},placeholder:n,defaultValue:t,submitOnEnter:s}})})}async function bs({measurement:e,uiDialogService:t,labelConfig:a,renderContent:n=ve.ndl,element:s}){const r=!!a&&a.exclusive,i=a?a.items:[];return await new Promise((a,o)=>{t.show({id:"select-annotation",title:"Annotation",content:n,contentProps:{labellingDoneCallback:n=>{if(t.hide("select-annotation"),e&&"string"==typeof n){const t=Jt.annotation.state.getAnnotation(e.uid);(0,vs.setAnnotationLabel)(t,s,n)}a(n)},measurementData:e,componentClassName:{},labelData:i,exclusive:r}})})}var Es=a(69175);const xs=function({value:e,hide:t,onSave:a}){const[n,s]=(0,ye.useState)(e);return ye.createElement("div",null,ye.createElement(Es.xk,{color:n,onChange:e=>{s(e.rgb)},presetColors:[],width:300}),ye.createElement(ve.esu,null,ye.createElement(ve.esu.Right,null,ye.createElement(ve.esu.Secondary,{onClick:t},"Cancel"),ye.createElement(ve.esu.Primary,{onClick:()=>{t(),a(n)}},"Save"))))};const Ms=function({servicesManager:e},t,a){const{measurementService:n,customizationService:s,toolGroupService:r,uiDialogService:i}=e.services,{viewportId:o,StudyInstanceUID:c,SeriesInstanceUID:l,measurementId:u,toolName:d}=a;return new Promise(e=>{(async()=>{if(r.getToolGroupForViewport(o).getToolConfiguration(d).getTextCallback)e({StudyInstanceUID:c,SeriesInstanceUID:l,viewportId:o});else{const t=s.getCustomization("measurementLabels"),a=n.getMeasurement(u),r=s.getCustomization("ui.labellingComponent"),d=await bs({measurement:a,uiDialogService:i,labelConfig:t,renderContent:r});n.update(u,{...d},!0),e({StudyInstanceUID:c,SeriesInstanceUID:l,viewportId:o})}})()})};var Cs=a(3329);function Ps(e,t){ve.FI1.addIcon(e,t)}function Us(){return Us=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Us.apply(null,arguments)}function Os({buttonSectionId:e,title:t}){const{servicesManager:a}=(0,o.Jg)(),{t:n}=(0,be.Bd)(),{toolbarService:s,customizationService:r}=a.services,[i,c]=(0,ye.useState)(!1),{toolbarButtons:l,onInteraction:u}=(0,o.tR)({buttonSection:e}),{activeToolOptions:d}=(0,o.KP)({buttonSectionId:e});if(!l.length)return null;if(!l.every(e=>e.componentProps.buttonSection))throw new Error("Toolbox accepts only button sections at the top level, not buttons. Create at least one button section.");const m=({itemId:e})=>{u?.({itemId:e})},p=r.getCustomization(`${e}.config`);return ye.createElement(ve.aUM,null,ye.createElement(ve.aUM.Header,{className:"flex items-center justify-between"},ye.createElement("span",null,n(t)),p&&ye.createElement("div",{className:"ml-auto mr-2"},ye.createElement(ve.FI1.Settings,{className:"text-primary h-4 w-4",onClick:e=>{e.stopPropagation(),c(!i)}}))),ye.createElement(ve.aUM.Content,{className:"bg-muted flex-shrink-0 border-none"},i&&ye.createElement(p,null),l.map(e=>{const t=e.componentProps.buttonSection,n=s.getButtonSection(t);return ye.createElement("div",{key:t,className:"bg-muted flex flex-wrap gap-2 py-2 px-1"},n.map(e=>{if(!e||!e.componentProps.visible)return null;const{id:t,Component:n,componentProps:s}=e;return ye.createElement("div",{key:t},ye.createElement(n,Us({},s,{id:t,onInteraction:m,size:"toolbox",servicesManager:a})))}))}),d&&ye.createElement("div",{className:"mt-1 h-auto bg-[rgb(var(--primary-dark))] px-2"},ye.createElement(ve.k_3,{options:d}))))}var Ns=a(52675);const Rs={id:Ze,preRegistration:function({servicesManager:e,commandsManager:t,hotkeysManager:a}){const{toolbarService:n,cineService:s,viewportGridService:r}=e.services;n.registerEventForToolbarUpdate(s,[s.EVENTS.CINE_STATE_CHANGED]),n.registerEventForToolbarUpdate(a,[o.Lu.EVENTS.HOTKEY_PRESSED]),o.H8.subscribe(o.H8.EVENTS.INSTANCES_ADDED,ms),o.H8.subscribe(o.H8.EVENTS.SERIES_UPDATED,ms),function({servicesManager:e}){const{hangingProtocolService:t}=e.services;t.addCustomAttribute("ViewCode","View Code Designator:Value",ls),t.addCustomAttribute("Laterality","Laterality of object",us)}({servicesManager:e});const i=[],c=e=>{Object.entries(e).forEach(([e,a])=>{if([r.EVENTS.ACTIVE_VIEWPORT_ID_CHANGED,r.EVENTS.VIEWPORTS_READY].includes(e)){const n=`${e}_${JSON.stringify(a)}`;if(i.includes(n))return;r.subscribe(e,e=>{const n=e?.viewportId??r.getActiveViewportId();t.run(a,{viewportId:n})}),i.push(n)}})};n.subscribe(n.EVENTS.TOOL_BAR_MODIFIED,e=>{const{buttons:t}=e;for(const[e,a]of Object.entries(t)){const{buttonSection:e,items:t,listeners:n}=a.props||{};e&&t&&t.forEach(e=>{e.listeners&&c(e.listeners)}),n&&c(n)}})},onModeExit(){ha.getState().clearViewportGridState(),hs.getState().clearUIState(),Da.getState().clearDisplaySetSelectorMap(),ba.getState().clearHangingProtocolStageIndexMap(),Na.getState().clearToggleHangingProtocol(),Ca.getState().clearViewportsByPosition()},getDataSourcesModule:fe,getViewportModule:()=>[{name:"chartViewport",component:is}],getLayoutTemplateModule:function({servicesManager:e,extensionManager:t,commandsManager:a,hotkeysManager:n}){return[{name:"viewerLayout",id:"viewerLayout",component:function(s){return He({servicesManager:e,extensionManager:t,commandsManager:a,hotkeysManager:n,...s})}}]},getPanelModule:Ke,getHangingProtocolModule:ln,getSopClassHandlerModule:Ut,getToolbarModule:function({commandsManager:e,servicesManager:t}){const{cineService:a}=t.services;return[{name:"ohif.toolButton",defaultComponent:jt},{name:"ohif.toolButtonList",defaultComponent:Vt},{name:"ohif.row",defaultComponent:Ft},{name:"ohif.toolBoxButtonGroup",defaultComponent:zt},{name:"ohif.toolBoxButton",defaultComponent:Wt},{name:"ohif.layoutSelector",defaultComponent:a=>Rt({...a,commandsManager:e,servicesManager:t})},{name:"ohif.progressDropdown",defaultComponent:At},{name:"ohif.Toolbar",defaultComponent:Ee.M},{name:"evaluate.cine",evaluate:()=>{const e=a.getState().isCineEnabled;return{className:ve.WpD.getToggledClassName(e)}}}]},getCommandsModule:$a,getUtilityModule:({servicesManager:e})=>[{name:"common",exports:{getStudiesForPatientByMRN:We}}],getCustomizationModule:function({servicesManager:e,extensionManager:t}){return[{name:"helloPage",value:dn},{name:"datasources",value:pn},{name:"multimonitor",value:gn},{name:"default",value:{...Sn,...yn,...In,...hn,...Dn,...On({servicesManager:e,extensionManager:t}),...Nn,...Tn,...un,...An,...kn,...Vn,...Ln,...Fn,...vn,...Yn,...Xn,...es,...ts,...as,...ss,...rs}}]}},Ts=Rs},96357:(e,t,a)=>{a.d(t,{A:()=>n});const n={NO_NEVER:-1,CANCEL:0,CREATE_REPORT:1,ADD_SERIES:2,SET_STUDY_AND_SERIES:3,NO_NOT_FOR_SERIES:4}}}]);
//# sourceMappingURL=9548.bundle.9e19ffa7877c429df3ba.js.map